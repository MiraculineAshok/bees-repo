<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Bees Interview Platform</title>
    <link rel="icon" type="image/png" href="/logo2.png">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #ffffff;
            color: #000000;
            line-height: 1.6;
        }

        .dashboard-container {
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar */
        .sidebar {
            width: 250px;
            background: #000000;
            color: white;
            padding: 1.5rem 0;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
            z-index: 1000;
        }

        .sidebar-header {
            padding: 0 1.5rem 2rem;
            border-bottom: 1px solid #333333;
            margin-bottom: 1rem;
        }

        .sidebar-header h2 {
            color: #ffffff;
            font-size: 1.5rem;
            font-weight: 700;
        }
        
        .logo-container {
            display: flex;
            align-items: center;
            color: #ffffff;
        }
        
        /* Logo styling - showing original colors */

        .sidebar-nav {
            list-style: none;
        }

        .nav-item {
            margin-bottom: 0.25rem;
        }

        .nav-link {
            display: block;
            padding: 0.75rem 1.5rem;
            color: #cccccc;
            text-decoration: none;
            transition: all 0.2s ease;
            border-left: 3px solid transparent;
        }

        .nav-link:hover,
        .nav-link.active {
            background: #333333;
            color: white;
            border-left-color: #ffffff;
        }

        .nav-link i {
            margin-right: 0.75rem;
            width: 20px;
            text-align: center;
        }

        /* Main Content */
        .main-content {
            margin-left: 250px;
            flex: 1;
            padding: 2rem;
        }

        .header {
            background: white;
            padding: 1.5rem 2rem;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
            margin-bottom: 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid #000000;
        }

        .header-left {
            display: flex;
            align-items: center;
        }

        .home-link {
            color: #000000;
            text-decoration: none;
            margin-right: 1rem;
            font-weight: 600;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            transition: background-color 0.2s ease;
        }

        .home-link:hover {
            background-color: #f0f0f0;
            text-decoration: none;
        }

        .header h1 {
            color: #000000;
            font-size: 2rem;
            font-weight: 700;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            background: #000000;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }

        /* Content Sections */
        .content-section {
            display: none;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
            padding: 2rem;
            border: 1px solid #000000;
        }

        .content-section.active {
            display: block;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid #cccccc;
        }

        .header-actions {
            display: flex;
            gap: 0.75rem;
            align-items: center;
        }

        .section-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: #000000;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            text-decoration: none;
            display: inline-block;
        }

        .btn-primary {
            background: #000000;
            color: white;
        }

        .btn-primary:hover {
            background: #333333;
        }

        .btn-success {
            background: #000000;
            color: white;
        }

        .btn-success:hover {
            background: #333333;
        }

        .btn-danger {
            background: #000000;
            color: white;
        }

        .btn-danger:hover {
            background: #333333;
        }

        /* Compact Filter Toggle Button */
        .btn-filter-toggle {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            background: #000000;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.875rem;
            transition: all 0.3s ease;
        }

        .btn-filter-toggle:hover {
            background: #333333;
            transform: translateY(-1px);
        }

        .filter-icon {
            font-size: 1rem;
        }

        .filter-text {
            font-weight: 500;
        }

        /* Filter Panel */
        .filter-panel {
            position: fixed;
            top: 0;
            right: -400px;
            width: 400px;
            height: 100vh;
            background: white;
            box-shadow: -2px 0 10px rgba(0, 0, 0, 0.1);
            z-index: 1001;
            transition: right 0.3s ease;
            overflow-y: auto;
        }

        .filter-panel.active {
            right: 0;
        }

        .filter-panel-header {
            background: #000000;
            color: white;
            padding: 1rem 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #333333;
        }

        .filter-panel-header h3 {
            margin: 0;
            font-size: 1.2rem;
            flex: 1;
        }

        .filter-panel-content {
            padding: 1.5rem;
        }

        /* Filter Panel Overlay - separate from detail panel overlay */
        .filter-panel-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 400px; /* Don't cover the filter panel */
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease;
        }

        .filter-panel-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        /* Filter Panel Sections */
        .filter-panel .filter-section,
        .filter-panel .sort-section,
        .filter-panel .group-by-section {
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 6px;
            margin-bottom: 1rem;
        }

        .filter-panel .filter-section-title {
            font-weight: 600;
            margin-bottom: 0.75rem;
            color: #333333;
            font-size: 0.9rem;
        }

        .filter-panel .filter-row {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .filter-panel .filter-group {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .filter-panel .filter-group label {
            font-size: 0.8rem;
            font-weight: 500;
            color: #555555;
        }

        .filter-panel .form-input,
        .filter-panel .form-select {
            padding: 0.5rem;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 0.8rem;
            width: 100%;
        }

        .filter-panel .sort-options,
        .filter-panel .group-by-options {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .filter-panel .sort-option {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .filter-panel .group-by-option {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .filter-panel .group-by-option label {
            font-size: 0.8rem;
            cursor: pointer;
            margin: 0;
        }

        .filter-panel .filter-actions {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid #dee2e6;
        }

        .filter-panel .btn-filter,
        .filter-panel .btn-clear,
        .filter-panel .btn-export,
        .filter-panel .btn {
            width: 100%;
            padding: 0.75rem;
            border-radius: 4px;
            border: none;
            cursor: pointer;
            font-size: 0.875rem;
            transition: background 0.2s;
        }

        /* Tables */
        .table-container {
            overflow-x: auto;
            margin-top: 1rem;
        }

        .table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }

        .table th,
        .table td {
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid #cccccc;
        }

        /* Compact table styling for edit functionality */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem;
        }

        .data-table th,
        .data-table td {
            padding: 0.5rem 0.75rem;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
            vertical-align: middle;
        }

        .data-table th {
            background: #f8fafc;
            font-weight: 600;
            color: #374151;
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .data-table tr:hover {
            background: #f9fafb;
        }

        .data-table tr.editing {
            background: #fef3c7;
        }

        /* Icon buttons */
        .icon-btn {
            background: none;
            border: none;
            padding: 0.25rem;
            margin: 0 0.125rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.875rem;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 28px;
            height: 28px;
        }

        .icon-btn:hover {
            background: #f3f4f6;
            transform: scale(1.1);
        }

        .edit-btn {
            color: #2563eb;
        }

        .edit-btn:hover {
            background: #dbeafe;
            color: #1d4ed8;
        }

        .delete-btn {
            color: #dc2626;
        }

        .delete-btn:hover {
            background: #fef2f2;
            color: #b91c1c;
        }

        .save-btn {
            color: #059669;
        }

        .save-btn:hover {
            background: #d1fae5;
            color: #047857;
        }

        .cancel-btn {
            color: #6b7280;
        }

        .cancel-btn:hover {
            background: #f3f4f6;
            color: #374151;
        }

        /* Edit form styling */
        .edit-form {
            display: none;
        }

        .edit-form.active {
            display: block;
        }

        .edit-input {
            width: 100%;
            padding: 0.25rem 0.5rem;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            font-size: 0.85rem;
            background: white;
        }

        .edit-input:focus {
            outline: none;
            border-color: #2563eb;
            box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.1);
        }

        .edit-select {
            width: 100%;
            padding: 0.25rem 0.5rem;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            font-size: 0.85rem;
            background: white;
        }

        /* Bulk edit controls */
        .bulk-edit-controls {
            display: none; /* Hidden until selection exists */
            padding: 1rem;
            background: #f8fafc;
            border-bottom: 1px solid #e5e7eb;
            align-items: center;
            gap: 1rem;
            position: sticky;
            top: 0;
            z-index: 5;
        }
        .bulk-edit-controls.active { display: flex; }

        .bulk-edit-info {
            color: #6b7280;
            font-size: 0.875rem;
        }

        .bulk-edit-actions {
            display: flex;
            gap: 0.5rem;
        }

        /* Checkbox styling */
        .row-checkbox {
            width: 16px;
            height: 16px;
            cursor: pointer;
        }

        /* Remove floating bulk actions approach */

        /* Modal styling for bulk edit */
        .bulk-edit-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .bulk-edit-modal.active {
            display: flex;
        }

        /* Bulk Import Styles */
        .form-help {
            font-size: 0.85rem;
            color: #6b7280;
            margin-top: 0.25rem;
        }

        .format-info {
            background: #f3f4f6;
            padding: 1rem;
            border-radius: 6px;
            margin-top: 0.5rem;
        }

        .format-info p {
            margin: 0.25rem 0;
            font-size: 0.9rem;
        }

        .import-preview {
            margin-top: 1rem;
            padding: 1rem;
            background: #f9fafb;
            border-radius: 6px;
            border: 1px solid #e5e7eb;
        }

        .import-preview h4 {
            margin: 0 0 0.5rem 0;
            color: #374151;
        }

        .preview-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem;
        }

        .preview-table th,
        .preview-table td {
            padding: 0.5rem;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
        }

        .preview-table th {
            background: #f3f4f6;
            font-weight: 600;
        }

        .import-progress {
            margin-top: 1rem;
            padding: 1rem;
            background: #f0f9ff;
            border-radius: 6px;
            border: 1px solid #0ea5e9;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e5e7eb;
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 0.5rem;
        }

        .progress-fill {
            height: 100%;
            background: #0ea5e9;
            width: 0%;
            transition: width 0.3s ease;
        }

        .progress-text {
            font-size: 0.9rem;
            color: #0c4a6e;
            text-align: center;
        }

        .import-results {
            margin-top: 1rem;
            padding: 1rem;
            border-radius: 6px;
            border: 1px solid #e5e7eb;
        }

        .import-results h4 {
            margin: 0 0 0.5rem 0;
            color: #374151;
        }

        .results-success {
            background: #f0fdf4;
            border-color: #22c55e;
        }

        .results-error {
            background: #fef2f2;
            border-color: #ef4444;
        }

        .results-warning {
            background: #fffbeb;
            border-color: #f59e0b;
        }

        .bulk-edit-content {
            background: white;
            border-radius: 8px;
            padding: 2rem;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .bulk-edit-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .bulk-edit-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: #111827;
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #6b7280;
        }

        .bulk-edit-form {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .form-label {
            font-weight: 500;
            color: #374151;
            font-size: 0.875rem;
        }

        .form-input,
        .form-select,
        .form-textarea {
            padding: 0.5rem;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            font-size: 0.875rem;
        }

        .form-input:focus,
        .form-select:focus,
        .form-textarea:focus {
            outline: none;
            border-color: #2563eb;
            box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.1);
        }

        .bulk-edit-footer {
            display: flex;
            justify-content: flex-end;
            gap: 0.75rem;
            margin-top: 1.5rem;
            padding-top: 1rem;
            border-top: 1px solid #e5e7eb;
        }

        .btn {
            padding: 0.5rem 1rem;
            border-radius: 4px;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .btn-primary {
            background: #2563eb;
            color: white;
            border: none;
        }

        .btn-primary:hover {
            background: #1d4ed8;
        }

        .btn-secondary {
            background: #6b7280;
            color: white;
            border: none;
        }

        .btn-secondary:hover {
            background: #4b5563;
        }

        .table th {
            background: #f5f5f5;
            font-weight: 600;
            color: #000000;
        }

        .table tbody tr:hover {
            background: #f5f5f5;
        }

        .status-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-completed {
            background: #c6f6d5;
            color: #22543d;
        }

        .status-in-progress {
            background: #bee3f8;
            color: #2a4365;
        }

        .status-cancelled {
            background: #fed7d7;
            color: #742a2a;
        }

        /* Forms */
        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: #000000;
        }

        .form-input,
        .form-textarea,
        .form-select {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #cccccc;
            border-radius: 6px;
            font-size: 1rem;
            transition: border-color 0.2s ease;
        }

        .form-input:focus,
        .form-textarea:focus,
        .form-select:focus {
            outline: none;
            border-color: #000000;
        }

        .form-textarea {
            resize: vertical;
            min-height: 100px;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            padding: 2rem;
            border-radius: 8px;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
        }

        /* Panelist Selection Styles */
        .panelist-container {
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 1rem;
            background: #f9f9f9;
        }

        .panelist-search-container {
            position: relative;
            margin-bottom: 1rem;
        }

        .search-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #ddd;
            border-top: none;
            border-radius: 0 0 6px 6px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
        }

        .search-result-item {
            padding: 0.75rem;
            cursor: pointer;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .search-result-item:hover {
            background: #f0f0f0;
        }

        .search-result-item:last-child {
            border-bottom: none;
        }

        .search-result-info {
            flex: 1;
        }

        .search-result-name {
            font-weight: 600;
            color: #333;
        }

        .search-result-email {
            font-size: 0.875rem;
            color: #666;
        }

        .add-new-interviewer {
            background: #007bff;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.875rem;
            margin-left: 0.5rem;
        }

        .add-new-interviewer:hover {
            background: #0056b3;
        }

        .selected-panelists h4 {
            margin: 0 0 0.5rem 0;
            color: #333;
            font-size: 1rem;
        }

        .selected-list {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .selected-panelist {
            background: #e3f2fd;
            border: 1px solid #2196f3;
            border-radius: 20px;
            padding: 0.5rem 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
        }

        .selected-panelist-name {
            color: #1976d2;
            font-weight: 500;
        }

        .remove-panelist {
            background: none;
            border: none;
            color: #1976d2;
            cursor: pointer;
            font-size: 1.2rem;
            line-height: 1;
            padding: 0;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .remove-panelist:hover {
            color: #d32f2f;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid #cccccc;
        }

        .modal-title {
            font-size: 1.25rem;
            font-weight: 600;
        }

        .close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #a0aec0;
        }

        .close:hover {
            color: #000000;
        }

        /* Detail Panel Styles */
        .detail-panel {
            position: fixed;
            top: 0;
            right: -500px;
            width: 500px;
            height: 100vh;
            background: white;
            border-left: 2px solid #000000;
            box-shadow: -5px 0 15px rgba(0,0,0,0.3);
            z-index: 2000;
            transition: right 0.3s ease-in-out;
            overflow-y: auto;
        }

        .detail-panel.active {
            right: 0;
        }

        .detail-panel-header {
            background: #000000;
            color: white;
            padding: 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .detail-panel-title {
            font-size: 1.25rem;
            font-weight: 600;
            margin: 0;
        }

        .detail-panel-close {
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .detail-panel-close:hover {
            background: rgba(255,255,255,0.1);
            border-radius: 4px;
        }

        .detail-panel-content {
            padding: 1.5rem;
        }

        .detail-section {
            margin-bottom: 2rem;
        }

        .detail-section-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #000000;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid #cccccc;
        }

        .detail-item {
            margin-bottom: 1rem;
        }

        .detail-label {
            font-weight: 600;
            color: #666666;
            font-size: 0.875rem;
            margin-bottom: 0.25rem;
        }

        .detail-value {
            color: #000000;
            font-size: 0.95rem;
        }

        /* Interview List Styles */
        .interview-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .interview-item {
            border: 1px solid #cccccc;
            border-radius: 6px;
            margin-bottom: 1rem;
            overflow: hidden;
        }

        .interview-header {
            background: #f8f8f8;
            padding: 1rem;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background 0.2s ease;
        }

        .interview-header:hover {
            background: #f0f0f0;
        }

        .interview-header.active {
            background: #e0e0e0;
        }

        .interview-title {
            font-weight: 600;
            color: #000000;
            margin: 0;
        }

        .interview-meta {
            font-size: 0.875rem;
            color: #666666;
            margin-top: 0.25rem;
        }

        .interview-expand {
            font-size: 1.2rem;
            color: #666666;
            transition: transform 0.2s ease;
        }

        .interview-expand.expanded {
            transform: rotate(180deg);
        }

        .interview-details {
            padding: 1rem;
            border-top: 1px solid #cccccc;
            background: white;
            display: none;
        }

        .interview-details.active {
            display: block;
        }

        .question-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .question-item {
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            margin-bottom: 0.75rem;
            overflow: hidden;
        }

        .question-header {
            background: #f5f5f5;
            padding: 0.75rem;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .question-text {
            font-weight: 500;
            color: #000000;
            margin: 0;
            font-size: 0.9rem;
        }

        .question-expand {
            font-size: 1rem;
            color: #666666;
            transition: transform 0.2s ease;
        }

        .question-expand.expanded {
            transform: rotate(180deg);
        }

        .question-details {
            padding: 0.75rem;
            background: white;
            display: none;
        }

        .question-details.active {
            display: block;
        }

        .answer-section {
            margin-top: 0.75rem;
        }

        .answer-label {
            font-weight: 600;
            color: #666666;
            font-size: 0.875rem;
            margin-bottom: 0.5rem;
        }

        .answer-text {
            color: #000000;
            font-size: 0.9rem;
            line-height: 1.4;
            background: #f8f8f8;
            padding: 0.75rem;
            border-radius: 4px;
            border-left: 3px solid #000000;
        }

        .answer-image {
            max-width: 100%;
            height: auto;
            border-radius: 4px;
            margin-top: 0.5rem;
            border: 1px solid #cccccc;
        }

        .photo-gallery {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }
        
        .photo-item {
            position: relative;
            display: inline-block;
        }
        
        .photo-item img {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border-radius: 4px;
            border: 1px solid #d1d5db;
            cursor: pointer;
        }

        /* Role and Status Badges */
        .role-badge, .status-badge {
            padding: 0.25rem 0.5rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.025em;
        }

        .role-superadmin {
            background-color: #fef3c7;
            color: #92400e;
        }

        .role-admin {
            background-color: #dbeafe;
            color: #1e40af;
        }

        .role-interviewer {
            background-color: #d1fae5;
            color: #065f46;
        }

        .status-active {
            background-color: #d1fae5;
            color: #065f46;
        }

        .status-inactive {
            background-color: #f3f4f6;
            color: #6b7280;
        }

        .status-suspended {
            background-color: #fee2e2;
            color: #dc2626;
        }
        
        /* Group headers for filtering */
        .group-header { background: #2d3748; color: white; font-weight: 600; }
        .group-title { padding: 12px 16px; color: white; border-bottom: 2px solid #4a5568; }
        .group-title:first-child { border-top: 2px solid #4a5568; }
        
        /* User Action Menu Styles */
        .action-menu-container { position: relative; display: inline-block; }
        .menu-btn { background: #f3f4f6; border: 1px solid #d1d5db; color: #374151; font-size: 16px; font-weight: bold; }
        .menu-btn:hover { background: #e5e7eb; }
        .user-action-menu { 
            position: absolute; 
            top: 100%; 
            right: 0; 
            background: #ffffff; 
            border: 1px solid #e5e7eb; 
            border-radius: 8px; 
            box-shadow: 0 10px 20px rgba(0,0,0,0.1); 
            z-index: 1000; 
            min-width: 160px; 
            padding: 4px 0;
        }
        .user-action-menu.hidden { display: none; }
        .menu-item { 
            width: 100%; 
            background: #ffffff; 
            border: none; 
            text-align: left; 
            padding: 8px 12px; 
            cursor: pointer; 
            font-size: 14px; 
            color: #374151;
            transition: background-color 0.2s;
        }
        .menu-item:hover { background: #f3f4f6; }
        .menu-item:first-child { border-top-left-radius: 8px; border-top-right-radius: 8px; }
        .menu-item:last-child { border-bottom-left-radius: 8px; border-bottom-right-radius: 8px; }
        
        .question-answer-item {
            margin-bottom: 1rem;
            padding: 1rem;
            background: #f7fafc;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
        }
        
        .question-header, .answer-section {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 0.5rem;
        }
        
        .question-header p, .answer-section p {
            flex: 1;
            margin: 0;
            margin-right: 0.5rem;
        }
        
        .question-text-display, .answer-text-display {
            word-wrap: break-word;
        }
        
        .question-edit-input, .answer-edit-input {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
        }
        
        .edit-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        .panel-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1500;
            display: none;
        }

        .panel-overlay.active {
            display: block;
        }

        /* Image Modal Styles */
        .image-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            z-index: 3000;
            display: none;
            align-items: center;
            justify-content: center;
        }

        .image-modal.active {
            display: flex;
        }

        .image-modal-content {
            max-width: 90%;
            max-height: 90%;
            position: relative;
        }

        .image-modal img {
            max-width: 100%;
            max-height: 100%;
            border-radius: 8px;
        }

        .image-modal-close {
            position: absolute;
            top: -40px;
            right: 0;
            background: none;
            border: none;
            color: white;
            font-size: 2rem;
            cursor: pointer;
            padding: 0;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .image-modal-close:hover {
            background: rgba(255,255,255,0.1);
            border-radius: 4px;
        }

        /* Stats Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: white;
            padding: 1.5rem;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            border-left: 4px solid #000000;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: #000000;
            margin-bottom: 0.5rem;
        }

        .stat-label {
            color: #666666;
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        /* Loading and Empty States */
        .loading {
            text-align: center;
            padding: 2rem;
            color: #666666;
        }

        .empty-state {
            text-align: center;
            padding: 3rem;
            color: #666666;
        }

        .empty-state i {
            font-size: 3rem;
            margin-bottom: 1rem;
            color: #cccccc;
        }

        /* Controls Panel */
        .controls-panel {
            background: #f8f8f8;
            border: 1px solid #cccccc;
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .controls-row {
            display: flex;
            gap: 1.5rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }

        .controls-row:last-child {
            margin-bottom: 0;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            min-width: 200px;
            flex: 1;
        }

        .control-group .form-label {
            font-size: 0.875rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: #000000;
        }

        .control-group .form-select,
        .control-group .form-input {
            padding: 0.5rem;
            font-size: 0.875rem;
        }

        /* Enhanced Filter Styles */
        .filter-section {
            margin-bottom: 1.5rem;
        }

        .filter-section-title {
            font-weight: 600;
            margin-bottom: 0.75rem;
            color: #495057;
            font-size: 1rem;
            border-bottom: 2px solid #007bff;
            padding-bottom: 0.25rem;
        }

        .filter-row {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
            align-items: end;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            min-width: 150px;
        }

        .filter-group label {
            font-weight: 600;
            margin-bottom: 0.25rem;
            color: #495057;
            font-size: 0.875rem;
        }

        .filter-group select,
        .filter-group input {
            padding: 0.5rem;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 0.875rem;
            background: white;
        }

        .filter-group input[type="text"] {
            min-width: 200px;
        }

        .filter-group input[type="number"] {
            min-width: 100px;
        }

        /* Sort Section */
        .sort-section {
            background: #fff3cd;
            padding: 1rem;
            border-radius: 6px;
            margin-bottom: 1rem;
        }

        .sort-options {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            align-items: center;
        }

        .sort-option {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .sort-option select {
            padding: 0.25rem 0.5rem;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 0.875rem;
            min-width: 150px;
        }

        /* Group By Section */
        .group-by-section {
            background: #e9ecef;
            padding: 1rem;
            border-radius: 6px;
            margin-bottom: 1rem;
        }

        .group-by-options {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            align-items: center;
        }

        .group-by-option {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .group-by-option input[type="radio"] {
            margin: 0;
        }

        .group-by-option label {
            margin: 0;
            font-size: 0.875rem;
            cursor: pointer;
        }

        /* Action Buttons */
        .filter-actions {
            display: flex;
            gap: 0.5rem;
            align-items: center;
            flex-wrap: wrap;
        }

        .btn-filter {
            background: #007bff;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.875rem;
            transition: background 0.2s;
        }

        .btn-filter:hover {
            background: #0056b3;
        }

        .btn-clear {
            background: #6c757d;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.875rem;
            transition: background 0.2s;
        }

        .btn-clear:hover {
            background: #545b62;
        }

        .btn-export {
            background: #28a745;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.875rem;
            transition: background 0.2s;
        }

        .btn-export:hover {
            background: #1e7e34;
        }

        /* Results Summary */
        .results-summary {
            background: #d1ecf1;
            padding: 0.75rem 1rem;
            border-radius: 4px;
            margin-top: 1rem;
            font-size: 0.875rem;
            color: #0c5460;
        }

        .results-summary strong {
            color: #000000;
        }

        /* Grouped Table Styles */
        .grouped-table {
            margin-bottom: 2rem;
        }

        .group-header {
            background: #2d3748;
            color: white;
            padding: 0.75rem 1rem;
            font-weight: 600;
            border-radius: 4px 4px 0 0;
            margin-bottom: 0;
        }

        .group-header .group-count {
            font-size: 0.875rem;
            opacity: 0.8;
            margin-left: 0.5rem;
        }

        .grouped-table .table {
            border-radius: 0 0 4px 4px;
            border-top: none;
        }

        .grouped-table .table th {
            background: #f0f0f0;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
                transition: transform 0.3s ease;
            }

            .sidebar.open {
                transform: translateX(0);
            }

            .main-content {
                margin-left: 0;
            }

            .header {
                padding: 1rem;
            }

            .main-content {
                padding: 1rem;
            }
        }
        
        /* Pagination Styles */
        .pagination-controls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 8px;
            margin: 20px 0;
            padding: 16px;
        }
        
        .pagination-btn {
            padding: 8px 12px;
            border: 1px solid #d1d5db;
            background: #ffffff;
            color: #374151;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s ease;
        }
        
        .pagination-btn:hover {
            background: #f3f4f6;
            border-color: #9ca3af;
        }
        
        .pagination-btn.active {
            background: #3b82f6;
            color: #ffffff;
            border-color: #3b82f6;
        }
        
        .pagination-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .pagination-ellipsis {
            padding: 8px 4px;
            color: #6b7280;
            font-size: 14px;
        }
        
        .pagination-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 16px 0;
            padding: 12px 16px;
            background: #f9fafb;
            border-radius: 8px;
            font-size: 14px;
            color: #374151;
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <!-- Sidebar -->
        <nav class="sidebar">
            <div class="sidebar-header">
                <div class="logo-container">
                    <img src="/logo1.png" alt="BEES Logo" style="height: 35px; width: auto;">
                    <span style="margin-left: 10px; font-size: 1.2rem;">Admin</span>
                </div>
            </div>
            <ul class="sidebar-nav">
                <li class="nav-item">
                    <a href="#" class="nav-link active" data-section="overview">
                        <i>üìä</i> Overview
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" data-section="sessions">
                        <i>üìÖ</i> Interview Sessions
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" data-section="interviews">
                        <i>üéØ</i> Interviews
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" data-section="questions">
                        <i>‚ùì</i> Questions Analytics
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" data-section="students">
                        <i>üë•</i> Students
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" data-section="my-interviews">
                        <i>üìã</i> My Interviews
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" data-section="users">
                        <i>üë§</i> Users
                    </a>
                </li>
            </ul>
        </nav>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Header -->
            <header class="header">
                <div class="header-left">
                    <a href="/" class="home-link" style="color: #000000; text-decoration: none; margin-right: 1rem; font-weight: 600;">
                        ‚Üê Home
                    </a>
                    <h1 id="page-title">Admin Dashboard</h1>
                </div>
                <div class="header-actions" style="position:relative">
                    <button class="btn btn-success" onclick="startInterview()" style="background: #dc3545; color: white; margin-right: 1rem;">
                        Start Interview
                    </button>
                    <div class="user-info">
                        <div class="user-avatar" id="admin-avatar" style="cursor:pointer">A</div>
                        <div id="admin-avatar-menu" style="position:absolute;right:0;top:56px;background:#fff;border:1px solid #e5e7eb;border-radius:8px;box-shadow:0 10px 20px rgba(0,0,0,0.1);display:none;min-width:140px;z-index:10">
                            <button id="admin-logout-btn" style="width:100%;background:#fff;border:none;text-align:left;padding:10px 12px;cursor:pointer">Logout</button>
                        </div>
                    </div>
                </div>
            </header>

            <!-- Overview Section -->
            <section id="overview" class="content-section active">
                <div class="section-header">
                    <h2 class="section-title">Dashboard Overview</h2>
                </div>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="total-interviews">-</div>
                        <div class="stat-label">Total Interviews</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="active-sessions">-</div>
                        <div class="stat-label">Active Sessions</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="total-questions">-</div>
                        <div class="stat-label">Total Questions</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="total-students">-</div>
                        <div class="stat-label">Total Students</div>
                    </div>
                </div>
            </section>

            <!-- Interviews Section -->
            <section id="interviews" class="content-section">
                <div class="section-header">
                    <h2 class="section-title">All Interviews</h2>
                    <div class="header-actions">
                        <button class="btn-filter-toggle" onclick="toggleFilterPanel()" title="Filter & Sort Options">
                            <span class="filter-icon">‚öôÔ∏è</span>
                            <span class="filter-text">Filters</span>
                        </button>
                        <button id="clear-filters-interviews" class="btn btn-secondary" style="display:none" onclick="clearFilters('interviews')">Clear filters</button>
                        <button class="btn btn-primary" onclick="refreshInterviews()">Refresh</button>
                    </div>
                </div>
                
                <!-- Results Summary -->
                <div id="results-summary" class="results-summary" style="display: none;">
                    <strong>0</strong> interviews found
                </div>
                
                <div class="table-container">
                    <!-- Bulk Edit Controls -->
                    <div class="bulk-edit-controls">
                        <div class="bulk-edit-info" id="bulk-edit-selected-count">0 records selected</div>
                        <div class="bulk-edit-actions">
                            <button class="btn btn-secondary" onclick="selectAllRows()">Select All</button>
                            <button class="btn btn-secondary" onclick="clearSelection()">Clear</button>
                            <button class="btn btn-danger" onclick="bulkDelete()">Bulk Delete</button>
                            <button class="btn btn-primary" onclick="openBulkEditModal()">Bulk Edit</button>
                        </div>
                    </div>
                    
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th><input type="checkbox" onchange="toggleAllRows(this.checked)" title="Select All"></th>
                                <th>ID</th>
                                <th>Student</th>
                                <th>Interviewer</th>
                                <th>Session</th>
                                <th>Date</th>
                                <th>Duration</th>
                                <th>Status</th>
                                <th>Verdict</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="interviews-table-body">
                            <tr>
                                <td colspan="10" class="loading">Loading interviews...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Questions Analytics Section -->
            <section id="questions" class="content-section">
                <div class="section-header">
                    <h2 class="section-title">Questions Analytics</h2>
                    <div class="header-actions">
                        <button class="btn-filter-toggle" onclick="toggleFilterPanel('questions')" title="Filter & Sort Options">
                            <span class="filter-icon">‚öôÔ∏è</span>
                            <span class="filter-text">Filters</span>
                        </button>
                        <button id="clear-filters-questions" class="btn btn-secondary" style="display:none" onclick="clearFilters('questions')">Clear filters</button>
                        <button class="btn btn-success" onclick="openAddQuestionModal()">Add Question</button>
                        <button class="btn btn-info" onclick="openBulkImportModal()">Bulk Import</button>
                        <button class="btn btn-primary" onclick="refreshQuestions()">Refresh</button>
                    </div>
                </div>
                
                <div class="table-container">
                    <!-- Bulk Edit Controls -->
                    <div class="bulk-edit-controls">
                        <div class="bulk-edit-info" id="bulk-edit-selected-count">0 records selected</div>
                        <div class="bulk-edit-actions">
                            <button class="btn btn-secondary" onclick="selectAllRows()">Select All</button>
                            <button class="btn btn-secondary" onclick="clearSelection()">Clear</button>
                            <button class="btn btn-danger" onclick="bulkDelete()">Bulk Delete</button>
                            <button class="btn btn-primary" onclick="openBulkEditModal()">Bulk Edit</button>
                        </div>
                    </div>
                    
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th><input type="checkbox" onchange="toggleAllRows(this.checked)" title="Select All"></th>
                                <th>Question</th>
                                <th>Category</th>
                                <th>Times Asked</th>
                                <th>Correct Answers</th>
                                <th>Incorrect Answers</th>
                                <th>Success Rate</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="questions-table-body">
                            <tr>
                                <td colspan="8" class="loading">Loading questions...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Interview Sessions Section -->
            <section id="sessions" class="content-section">
                <div class="section-header">
                    <h2 class="section-title">Interview Sessions</h2>
                    <div class="header-actions">
                        <button class="btn-filter-toggle" onclick="toggleFilterPanel('sessions')" title="Filter & Sort Options">
                            <span class="filter-icon">‚öôÔ∏è</span>
                            <span class="filter-text">Filters</span>
                        </button>
                        <button id="clear-filters-sessions" class="btn btn-secondary" style="display:none" onclick="clearFilters('sessions')">Clear filters</button>
                        <button class="btn btn-primary" onclick="openCreateSessionModal()">Create Session</button>
                    </div>
                </div>
                
                <div class="table-container">
                    <!-- Bulk Edit Controls -->
                    <div class="bulk-edit-controls">
                        <div class="bulk-edit-info" id="bulk-edit-selected-count">0 records selected</div>
                        <div class="bulk-edit-actions">
                            <button class="btn btn-secondary" onclick="selectAllRows()">Select All</button>
                            <button class="btn btn-secondary" onclick="clearSelection()">Clear</button>
                            <button class="btn btn-danger" onclick="bulkDelete()">Bulk Delete</button>
                            <button class="btn btn-primary" onclick="openBulkEditModal()">Bulk Edit</button>
                        </div>
                    </div>
                    
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th><input type="checkbox" onchange="toggleAllRows(this.checked)" title="Select All"></th>
                                <th>ID</th>
                                <th>Name</th>
                                <th>Description</th>
                                <th>Status</th>
                                <th>Panelists</th>
                                <th>Created By</th>
                                <th>Created At</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="sessions-table-body">
                            <tr>
                                <td colspan="8" class="loading">Loading sessions...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Students Section -->
            <section id="students" class="content-section">
                <div class="section-header">
                    <h2 class="section-title">Students</h2>
                    <div class="header-actions">
                        <button class="btn-filter-toggle" onclick="toggleFilterPanel('students')" title="Filter & Sort Options">
                            <span class="filter-icon">‚öôÔ∏è</span>
                            <span class="filter-text">Filters</span>
                        </button>
                        <button id="clear-filters-students" class="btn btn-secondary" style="display:none" onclick="clearFilters('students')">Clear filters</button>
                        <button class="btn btn-primary" onclick="refreshStudents()">Refresh</button>
                    </div>
                </div>
                
                <div class="table-container">
                    <!-- Bulk Edit Controls -->
                    <div class="bulk-edit-controls">
                        <div class="bulk-edit-info" id="bulk-edit-selected-count">0 records selected</div>
                        <div class="bulk-edit-actions">
                            <button class="btn btn-secondary" onclick="selectAllRows()">Select All</button>
                            <button class="btn btn-secondary" onclick="clearSelection()">Clear</button>
                            <button class="btn btn-danger" onclick="bulkDelete()">Bulk Delete</button>
                            <button class="btn btn-primary" onclick="openBulkEditModal()">Bulk Edit</button>
                        </div>
                    </div>
                    
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th><input type="checkbox" onchange="toggleAllRows(this.checked)" title="Select All"></th>
                                <th>ID</th>
                                <th>Name</th>
                                <th>Email</th>
                                <th>Zeta ID</th>
                                <th>Phone</th>
                                <th>Interviews</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="students-table-body">
                            <tr>
                                <td colspan="8" class="loading">Loading students...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- My Interviews Section (Admin's own interviews) -->
            <section id="my-interviews" class="content-section">
                <div class="section-header">
                    <h2 class="section-title">My Interviews</h2>
                    <div class="header-actions">
                        <button class="btn-filter-toggle" onclick="toggleFilterPanel('my-interviews')" title="Filter & Sort Options">
                            <span class="filter-icon">‚öôÔ∏è</span>
                            <span class="filter-text">Filters</span>
                        </button>
                        <button id="clear-filters-my-interviews" class="btn btn-secondary" style="display:none" onclick="clearFilters('my-interviews')">Clear filters</button>
                        <button class="btn btn-primary" onclick="loadMyInterviewsForAdmin()">Refresh</button>
                    </div>
                </div>
                <div class="table-container">
                    <!-- Bulk Edit Controls -->
                    <div class="bulk-edit-controls">
                        <div class="bulk-edit-info" id="bulk-edit-selected-count">0 records selected</div>
                        <div class="bulk-edit-actions">
                            <button class="btn btn-secondary" onclick="selectAllRows()">Select All</button>
                            <button class="btn btn-secondary" onclick="clearSelection()">Clear</button>
                            <button class="btn btn-danger" onclick="bulkDelete()">Bulk Delete</button>
                            <button class="btn btn-primary" onclick="openBulkEditModal()">Bulk Edit</button>
                        </div>
                    </div>
                    
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th><input type="checkbox" onchange="toggleAllRows(this.checked)" title="Select All"></th>
                                <th>Date</th>
                                <th>Student</th>
                                <th>Zeta ID</th>
                                <th>Session</th>
                                <th>Status</th>
                                <th>Verdict</th>
                                <th>Duration</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="my-interviews-table-body">
                            <tr><td colspan="9" class="loading">Loading interviews...</td></tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Users Section -->
            <section id="users" class="content-section">
                <div class="section-header">
                    <h2 class="section-title">Users</h2>
                    <div class="header-actions">
                        <button class="btn-filter-toggle" onclick="toggleFilterPanel('users')" title="Filter & Sort Options">
                            <span class="filter-icon">‚öôÔ∏è</span>
                            <span class="filter-text">Filters</span>
                        </button>
                        <button id="clear-filters-users" class="btn btn-secondary" style="display:none" onclick="clearFilters('users')">Clear filters</button>
                        <button class="btn btn-primary" onclick="refreshUsers()">Refresh</button>
                    </div>
                </div>
                
                <div class="table-container">
                    <!-- Bulk Edit Controls -->
                    <div class="bulk-edit-controls">
                        <div class="bulk-edit-info" id="bulk-edit-selected-count">0 records selected</div>
                        <div class="bulk-edit-actions">
                            <button class="btn btn-secondary" onclick="selectAllRows()">Select All</button>
                            <button class="btn btn-secondary" onclick="clearSelection()">Clear</button>
                            <button class="btn btn-warning" onclick="openBulkEditModal()">Bulk Edit</button>
                            <button class="btn btn-danger" onclick="bulkDelete()">Bulk Delete</button>
                        </div>
                    </div>
                    
                    <table class="data-table compact-table">
                        <thead>
                            <tr>
                                <th><input type="checkbox" id="select-all-users" onchange="toggleSelectAll()"></th>
                                <th>ID</th>
                                <th>Name</th>
                                <th>Email</th>
                                <th>Role</th>
                                <th>Status</th>
                                <th>Created At</th>
                                <th>Last Login</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="users-table-body">
                            <tr>
                                <td colspan="9" class="loading">Loading users...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </section>
        </main>
    </div>

    <!-- Create Session Modal -->
    <div id="create-session-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Create Interview Session</h3>
                <button class="close" onclick="closeCreateSessionModal()">&times;</button>
            </div>
            <form id="create-session-form">
                <div class="form-group">
                    <label class="form-label" for="session-name">Session Name</label>
                    <input type="text" id="session-name" class="form-input" placeholder="e.g., Face to Face for St Mary's School" required>
                </div>
                <div class="form-group">
                    <label class="form-label" for="session-description">Description</label>
                    <textarea id="session-description" class="form-textarea" placeholder="Brief description of the interview session"></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label" for="panelist-search">Panelists (Interviewers)</label>
                    <div class="panelist-container">
                        <div class="panelist-search-container">
                            <input type="text" id="panelist-search" class="form-input" placeholder="Search for interviewers..." onkeyup="searchInterviewers()">
                            <div id="panelist-search-results" class="search-results"></div>
                        </div>
                        <div class="selected-panelists">
                            <h4>Selected Panelists:</h4>
                            <div id="selected-panelists-list" class="selected-list"></div>
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <button type="submit" class="btn btn-primary">Create Session</button>
                    <button type="button" class="btn btn-secondary" onclick="closeCreateSessionModal()">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Question Details Modal -->
    <div id="question-details-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Question Performance Details</h3>
                <button class="close" onclick="closeQuestionDetailsModal()">&times;</button>
            </div>
            <div id="question-details-content">
                <!-- Content will be loaded dynamically -->
            </div>
        </div>
    </div>

    <!-- Add Question Modal -->
    <div id="add-question-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Add New Question</h3>
                <button class="close" onclick="closeAddQuestionModal()">&times;</button>
            </div>
            <form id="add-question-form">
                <div class="form-group">
                    <label class="form-label" for="question-text">Question Text</label>
                    <textarea id="question-text" class="form-textarea" placeholder="Enter the question text..." required rows="4"></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label" for="question-category">Category <span style="color:#6b7280;font-size:12px">(optional if creating new)</span></label>
                    <div style="display:flex;gap:8px;align-items:center">
                        <select id="question-category" class="form-select" style="flex:1">
                            <option value="">Loading categories...</option>
                        </select>
                        <button type="button" id="add-new-category-btn" style="background:#3b82f6;color:#fff;border:none;padding:12px 16px;border-radius:6px;cursor:pointer;font-size:14px;height:42px;display:flex;align-items:center;justify-content:center">+ New</button>
                    </div>
                    <div id="new-category-input" style="display:none;margin-top:8px">
                        <input type="text" id="new-category-name" placeholder="Enter new category name" required style="width:100%;padding:8px;border:1px solid #d1d5db;border-radius:4px;font-size:14px">
                    </div>
                </div>
                <div class="form-group">
                    <button type="submit" class="btn btn-primary">Add Question</button>
                    <button type="button" class="btn btn-secondary" onclick="closeAddQuestionModal()">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Detail Panel Overlay -->
    <div id="panel-overlay" class="panel-overlay" onclick="closeDetailPanel()"></div>

    <!-- Detail Panel -->
    <div id="detail-panel" class="detail-panel">
        <div class="detail-panel-header">
            <h3 id="detail-panel-title">Details</h3>
            <button class="close-btn" onclick="closeDetailPanel()">‚úï</button>
        </div>
        <div class="detail-panel-content" id="detail-panel-content">
            <!-- Content will be loaded here -->
        </div>
    </div>

    <!-- Filter Panel Overlay -->
    <div id="filter-panel-overlay" class="filter-panel-overlay" onclick="closeFilterPanel()"></div>

    <!-- Filter Panel -->
    <div id="filter-panel" class="filter-panel">
        <div class="filter-panel-header">
            <h3>Filter & Sort Options</h3>
            <button class="close-btn" onclick="closeFilterPanel()">‚úï</button>
        </div>
        <div class="filter-panel-content">
            <!-- Search Section -->
            <div class="filter-section">
                <div class="filter-section-title">üîç Search & Filter</div>
                <div class="filter-row">
                    <div class="filter-group">
                        <label>Search:</label>
                        <input type="text" id="search-interviews" class="form-input" placeholder="Search by student name, email, Zeta ID, or interviewer..." onkeyup="applyFilters('interviews')">
                    </div>
                    <div class="filter-group">
                        <label>Status:</label>
                        <select id="status-filter" class="form-select" onchange="applyFilters('interviews')">
                            <option value="">All Statuses</option>
                            <option value="completed">Completed</option>
                            <option value="in_progress">In Progress</option>
                            <option value="cancelled">Cancelled</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Session:</label>
                        <select id="session-filter" class="form-select" onchange="applyFilters('interviews')">
                            <option value="">All Sessions</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Verdict:</label>
                        <select id="verdict-filter" class="form-select" onchange="applyFilters('interviews')">
                            <option value="">All Verdicts</option>
                            <option value="Tiger">Tiger</option>
                            <option value="Cow">Cow</option>
                            <option value="Cow+">Cow+</option>
                            <option value="Sheep">Sheep</option>
                        </select>
                    </div>
                </div>
                <div class="filter-row">
                    <div class="filter-group">
                        <label>Interviewer:</label>
                        <select id="interviewer-filter" class="form-select" onchange="applyFilters('interviews')">
                            <option value="">All Interviewers</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Date From:</label>
                        <input type="date" id="date-from" class="form-input" onchange="applyFilters('interviews')">
                    </div>
                    <div class="filter-group">
                        <label>Date To:</label>
                        <input type="date" id="date-to" class="form-input" onchange="applyFilters('interviews')">
                    </div>
                    <div class="filter-group">
                        <label>Duration (min):</label>
                        <input type="number" id="duration-min" class="form-input" placeholder="Minutes" min="0" onchange="applyFilters('interviews')">
                    </div>
                </div>
            </div>

            <!-- Sort Section -->
            <div class="sort-section">
                <div class="filter-section-title">üìä Sort Options</div>
                <div class="sort-options">
                    <div class="sort-option">
                        <label>Primary Sort:</label>
                        <select id="sort-by" class="form-select" onchange="applyFilters('interviews')">
                            <option value="created_at_desc">Date (Newest First)</option>
                            <option value="created_at_asc">Date (Oldest First)</option>
                            <option value="student_name_asc">Student Name (A-Z)</option>
                            <option value="student_name_desc">Student Name (Z-A)</option>
                            <option value="duration_desc">Duration (Longest First)</option>
                            <option value="duration_asc">Duration (Shortest First)</option>
                            <option value="status_asc">Status (A-Z)</option>
                            <option value="verdict_asc">Verdict (A-Z)</option>
                            <option value="interviewer_asc">Interviewer (A-Z)</option>
                            <option value="session_asc">Session (A-Z)</option>
                        </select>
                    </div>
                    <div class="sort-option">
                        <label>Secondary Sort:</label>
                        <select id="sort-by-2" class="form-select" onchange="applyFilters('interviews')">
                            <option value="">None</option>
                            <option value="student_name_asc">Student Name (A-Z)</option>
                            <option value="student_name_desc">Student Name (Z-A)</option>
                            <option value="created_at_desc">Date (Newest First)</option>
                            <option value="created_at_asc">Date (Oldest First)</option>
                            <option value="duration_desc">Duration (Longest First)</option>
                            <option value="duration_asc">Duration (Shortest First)</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Group By Section -->
            <div class="group-by-section">
                <div class="filter-section-title">üìã Group By</div>
                <div class="group-by-options">
                    <div class="group-by-option">
                        <input type="radio" id="group-none" name="group-by" value="" onchange="applyFilters('interviews')" checked>
                        <label for="group-none">No Grouping</label>
                    </div>
                    <div class="group-by-option">
                        <input type="radio" id="group-session" name="group-by" value="session" onchange="applyFilters('interviews')">
                        <label for="group-session">Session</label>
                    </div>
                    <div class="group-by-option">
                        <input type="radio" id="group-status" name="group-by" value="status" onchange="applyFilters('interviews')">
                        <label for="group-status">Status</label>
                    </div>
                    <div class="group-by-option">
                        <input type="radio" id="group-verdict" name="group-by" value="verdict" onchange="applyFilters('interviews')">
                        <label for="group-verdict">Verdict</label>
                    </div>
                    <div class="group-by-option">
                        <input type="radio" id="group-interviewer" name="group-by" value="interviewer" onchange="applyFilters('interviews')">
                        <label for="group-interviewer">Interviewer</label>
                    </div>
                    <div class="group-by-option">
                        <input type="radio" id="group-date" name="group-by" value="date" onchange="applyFilters('interviews')">
                        <label for="group-date">Date</label>
                    </div>
                    <div class="group-by-option">
                        <input type="radio" id="group-duration" name="group-by" value="duration" onchange="applyFilters('interviews')">
                        <label for="group-duration">Duration Range</label>
                    </div>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="filter-actions">
                <button class="btn-filter" onclick="applyFilters('interviews', true)">Apply Filters</button>
                <button class="btn-clear" onclick="clearAllFilters()">Clear All</button>
                <button class="btn-export" onclick="exportInterviews()">Export CSV</button>
                <button class="btn btn-secondary" onclick="refreshInterviews()">Refresh Data</button>
            </div>
        </div>
    </div>

    <!-- Image Modal -->
    <div id="image-modal" class="image-modal" onclick="closeImageModal()">
        <div class="image-modal-content" onclick="event.stopPropagation()">
            <button class="image-modal-close" onclick="closeImageModal()">&times;</button>
            <img id="modal-image" src="" alt="Answer Image">
        </div>
    </div>

    <script>
        function setClearFiltersVisibility(section) {
            try {
                const map = {
                    'interviews': ['search-interviews','status-filter','verdict-filter','date-from','date-to'],
                    'questions': ['questions-search','questions-category','questions-sort-by'],
                    'sessions': ['sessions-search','sessions-status'],
                    'students': ['students-search'],
                    'my-interviews': ['my-search','my-status','my-verdict','my-date-from','my-date-to'],
                    'users': ['users-search','role-filter','status-filter-users']
                };
                const ids = map[section] || [];
                const isActive = ids.some(id => {
                    const el = document.getElementById(id);
                    if (!el) return false;
                    if (el.tagName === 'SELECT') return el.value && el.value !== '';
                    return el.value && el.value.trim() !== '';
                });
                const btn = document.getElementById(`clear-filters-${section}`);
                if (btn) btn.style.display = isActive ? '' : 'none';
            } catch {}
        }

        function clearFilters(section) {
            try {
                switch(section) {
                    case 'interviews':
                        ['search-interviews','status-filter','verdict-filter','date-from','date-to'].forEach(id=>{ const el=document.getElementById(id); if(el){ el.value=''; if(el.onchange) el.onchange(); }});
                        applyFilters('interviews');
                        break;
                    case 'questions':
                        ['questions-search','questions-category','questions-sort-by'].forEach(id=>{ const el=document.getElementById(id); if(el){ el.value=''; if(el.onchange) el.onchange(); }});
                        applyQuestionFilters && applyQuestionFilters();
                        break;
                    case 'sessions':
                        ['sessions-search','sessions-status'].forEach(id=>{ const el=document.getElementById(id); if(el){ el.value=''; if(el.onchange) el.onchange(); }});
                        refreshSessions && refreshSessions();
                        break;
                    case 'students':
                        ['students-search'].forEach(id=>{ const el=document.getElementById(id); if(el){ el.value=''; if(el.onchange) el.onchange(); }});
                        refreshStudents && refreshStudents();
                        break;
                    case 'my-interviews':
                        ['my-search','my-status','my-verdict','my-date-from','my-date-to'].forEach(id=>{ const el=document.getElementById(id); if(el){ el.value=''; if(el.onchange) el.onchange(); }});
                        applyMyInterviewFilters && applyMyInterviewFilters();
                        break;
                    case 'users':
                        ['users-search','role-filter','status-filter-users'].forEach(id=>{ const el=document.getElementById(id); if(el){ el.value=''; if(el.onchange) el.onchange(); }});
                        refreshUsers && refreshUsers();
                        break;
                }
                setClearFiltersVisibility(section);
            } catch {}
        }
        // Global variables
        let currentSection = 'overview';
        let interviews = [];
        let questions = [];
        let favoriteQuestionIds = new Set();
        let selectedPanelists = [];
        let allInterviewers = [];
        let sessions = [];
        let students = [];
        let myInterviews = []; // Add missing myInterviews variable
        let currentUserId = null;
        
        // Pagination variables
        const ITEMS_PER_PAGE = 10;
        let currentPage = {
            interviews: 1,
            questions: 1,
            sessions: 1,
            students: 1,
            users: 1,
            'my-interviews': 1
        };
        let totalPages = {
            interviews: 1,
            questions: 1,
            sessions: 1,
            students: 1,
            users: 1,
            'my-interviews': 1
        };

        // Pagination utility functions
        function getPaginatedData(data, section) {
            const startIndex = (currentPage[section] - 1) * ITEMS_PER_PAGE;
            const endIndex = startIndex + ITEMS_PER_PAGE;
            return data.slice(startIndex, endIndex);
        }
        
        function updateTotalPages(data, section) {
            totalPages[section] = Math.ceil(data.length / ITEMS_PER_PAGE);
            if (currentPage[section] > totalPages[section] && totalPages[section] > 0) {
                currentPage[section] = totalPages[section];
            }
        }
        
        function createPaginationControls(section) {
            const totalPagesCount = totalPages[section];
            if (totalPagesCount <= 1) return '';
            
            let controls = '<div class="pagination-controls">';
            
            // Previous button
            if (currentPage[section] > 1) {
                controls += `<button class="pagination-btn" onclick="changePage('${section}', ${currentPage[section] - 1})">Previous</button>`;
            }
            
            // Page numbers
            const startPage = Math.max(1, currentPage[section] - 2);
            const endPage = Math.min(totalPagesCount, currentPage[section] + 2);
            
            if (startPage > 1) {
                controls += `<button class="pagination-btn" onclick="changePage('${section}', 1)">1</button>`;
                if (startPage > 2) {
                    controls += '<span class="pagination-ellipsis">...</span>';
                }
            }
            
            for (let i = startPage; i <= endPage; i++) {
                const activeClass = i === currentPage[section] ? 'active' : '';
                controls += `<button class="pagination-btn ${activeClass}" onclick="changePage('${section}', ${i})">${i}</button>`;
            }
            
            if (endPage < totalPagesCount) {
                if (endPage < totalPagesCount - 1) {
                    controls += '<span class="pagination-ellipsis">...</span>';
                }
                controls += `<button class="pagination-btn" onclick="changePage('${section}', ${totalPagesCount})">${totalPagesCount}</button>`;
            }
            
            // Next button
            if (currentPage[section] < totalPagesCount) {
                controls += `<button class="pagination-btn" onclick="changePage('${section}', ${currentPage[section] + 1})">Next</button>`;
            }
            
            controls += '</div>';
            return controls;
        }
        
        function changePage(section, page) {
            currentPage[section] = page;
            refreshCurrentSection();
        }
        
        function refreshCurrentSection() {
            switch(currentSection) {
                case 'interviews':
                    displayInterviews();
                    break;
                case 'questions':
                    displayQuestions();
                    break;
                case 'sessions':
                    displaySessions();
                    break;
                case 'students':
                    displayStudents();
                    break;
                case 'users':
                    displayUsers();
                    break;
                case 'my-interviews':
                    displayMyInterviews();
                    break;
            }
        }

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            checkUserLoginStatus();
            initializeDashboard();
            setupEventListeners();
            // Activate tab from URL param, e.g., ?tab=my-interviews
            const params = new URLSearchParams(window.location.search);
            const tab = params.get('tab');
            if (tab) {
                switchSection(tab);
            }
        });

        function initializeDashboard() {
            loadOverviewStats();
            loadInterviews();
            loadQuestions();
            loadSessions();
            loadStudents();
            loadUsers();
            
            // Initialize bulk edit controls
            initializeBulkEditControls();
            
            // Populate filter dropdowns with actual data
            populateFilterDropdowns();
        }

        function initializeBulkEditControls() {
            // Ensure bulk edit controls are properly initialized
            const bulkEditControls = document.querySelectorAll('.bulk-edit-controls');
            bulkEditControls.forEach(control => {
                if (!control.querySelector('.bulk-edit-info')) {
                    const info = document.createElement('div');
                    info.className = 'bulk-edit-info';
                    info.id = 'bulk-edit-selected-count';
                    info.textContent = '0 records selected';
                    control.appendChild(info);
                }
                
                if (!control.querySelector('.bulk-edit-actions')) {
                    const actions = document.createElement('div');
                    actions.className = 'bulk-edit-actions';
                    actions.innerHTML = `
                        <button class="btn btn-secondary" onclick="selectAllRows()">Select All</button>
                        <button class="btn btn-secondary" onclick="clearSelection()">Clear</button>
                        <button class="btn btn-danger" onclick="bulkDelete()">Bulk Delete</button>
                        <button class="btn btn-primary" onclick="openBulkEditModal()">Bulk Edit</button>
                    `;
                    control.appendChild(actions);
                }
            });

            // Remove floating actions creation
        }

        // Reload only the currently active tab's data (avoids relying on click side-effects)
        function reloadCurrentTab() {
            const active = document.querySelector('.nav-link.active');
            if (!active) return;
            const section = active.dataset.section || '';
            if (section === 'students') {
                loadStudents();
            } else if (section === 'sessions') {
                loadSessions();
            } else if (section === 'interviews') {
                loadInterviews();
            } else if (section === 'questions') {
                loadQuestions();
            } else if (section === 'my-interviews') {
                loadMyInterviewsForAdmin();
            } else if (section === 'users') {
                loadUsers();
            } else if (section === 'overview') {
                loadOverviewStats();
            }
        }

        function setupEventListeners() {
            // Navigation
            document.querySelectorAll('.nav-link').forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    const section = this.dataset.section;
                    // Clear any cross-tab selection/edit state
                    selectedRows.clear();
                    currentEditRow = null;
                    currentEditData = null;
                    updateBulkEditControls();
                    switchSection(section);
                });
            });

            // Global delegated handler for all edit buttons
            document.addEventListener('click', (e) => {
                const btn = e.target.closest('.edit-btn');
                if (!btn) return;
                e.preventDefault();
                e.stopPropagation();
                const tr = btn.closest('tr');
                const id = tr && tr.getAttribute('data-row-id');
                if (id) startEdit(id);
            }, { capture: false });

            // Create session form
            document.getElementById('create-session-form').addEventListener('submit', function(e) {
                e.preventDefault();
                createSession();
            });

            // Add question form
            document.getElementById('add-question-form').addEventListener('submit', function(e) {
                e.preventDefault();
                addQuestion();
            });
        }

        // User authentication functions
        function checkUserLoginStatus() {
            // Check URL parameters for user data (from OAuth callback)
            const urlParams = new URLSearchParams(window.location.search);
            const userEmail = urlParams.get('email');
            const userName = urlParams.get('name');
            
            if (userEmail || userName) {
                // User just logged in, display their info
                const userData = {
                    email: userEmail,
                    name: userName || userEmail?.split('@')[0] || 'Admin'
                };
                displayUserInfo(userData);
                
                // Store user data in localStorage for future visits
                localStorage.setItem('bees_user_data', JSON.stringify(userData));
                
                // Clean up URL parameters
                window.history.replaceState({}, document.title, window.location.pathname);
            } else {
                // Check localStorage for existing user data
                const storedUserData = localStorage.getItem('bees_user_data');
                if (storedUserData) {
                    try {
                        const userData = JSON.parse(storedUserData);
                        displayUserInfo(userData);
                    } catch (e) {
                        console.error('Error parsing stored user data:', e);
                        localStorage.removeItem('bees_user_data');
                    }
                }
            }
        }

        async function displayUserInfo(userData) {
            const avatar = document.getElementById('admin-avatar');
            const menu = document.getElementById('admin-avatar-menu');
            if (avatar && userData) {
                // Get user ID from API to ensure consistent avatar
                try {
                    const userIdResponse = await fetch('/api/user/id');
                    const userIdData = await userIdResponse.json();
                    const userId = userIdData.success ? userIdData.userId : null;
                    currentUserId = userId;
                    const initial = userId ? userId.toString().charAt(0).toUpperCase() : (userData.email || userData.name || 'A').trim().charAt(0).toUpperCase();
                    avatar.textContent = initial || 'A';
                } catch (error) {
                    console.error('Error fetching user ID:', error);
                    const initial = (userData.email || userData.name || 'A').trim().charAt(0).toUpperCase();
                    avatar.textContent = initial || 'A';
                }
                avatar.onclick = ()=> { menu.style.display = (menu.style.display==='block' ? 'none' : 'block'); };
                document.addEventListener('click', (e)=>{ if (!avatar.contains(e.target) && !menu.contains(e.target)) menu.style.display='none'; });
                const logoutBtn = document.getElementById('admin-logout-btn');
                if (logoutBtn) {
                    logoutBtn.onclick = ()=> {
                        const overlay = document.createElement('div');
                        overlay.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.35);display:flex;align-items:center;justify-content:center;z-index:2000;';
                        overlay.innerHTML = `
                          <div style="background:#fff;border:1px solid #e5e7eb;border-radius:8px;min-width:280px;max-width:90%;padding:16px;box-shadow:0 10px 20px rgba(0,0,0,0.15)">
                            <div style=\"font-weight:600;margin-bottom:8px;color:#111827\">Logout?</div>
                            <div style=\"font-size:14px;color:#374151;margin-bottom:12px\">Are you sure you want to logout?</div>
                            <div style=\"display:flex;gap:8px;justify-content:flex-end\">
                              <button id=\"lg-cancel\" style=\"border:1px solid #e5e7eb;background:#fff;padding:6px 10px;border-radius:6px;cursor:pointer\">Cancel</button>
                              <button id=\"lg-confirm\" style=\"background:#111827;color:#fff;border:none;padding:6px 10px;border-radius:6px;cursor:pointer\">Logout</button>
                            </div>
                          </div>`;
                        document.body.appendChild(overlay);
                        overlay.querySelector('#lg-cancel').onclick = ()=> overlay.remove();
                        overlay.querySelector('#lg-confirm').onclick = ()=> { overlay.remove(); try { localStorage.removeItem('bees_user_data'); } catch {}; window.location.href = '/'; };
                    };
                }
            }
        }

        // Start Interview function
        function startInterview() {
            console.log('Starting interview from admin dashboard...');
            window.location.href = '/interview';
        }

        function switchSection(section) {
            // Update navigation
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
            });
            document.querySelector(`[data-section="${section}"]`).classList.add('active');

            // Update content
            document.querySelectorAll('.content-section').forEach(sec => {
                sec.classList.remove('active');
            });
            document.getElementById(section).classList.add('active');

            // Update page title
            const titles = {
                'overview': 'Dashboard Overview',
                'interviews': 'All Interviews',
                'questions': 'Questions Analytics',
                'sessions': 'Interview Sessions',
                'students': 'Students',
                'my-interviews': 'My Interviews',
                'users': 'Users'
            };
            document.getElementById('page-title').textContent = titles[section];

            // Update URL to persist tab state
            const url = new URL(window.location);
            url.searchParams.set('tab', section);
            window.history.replaceState({}, '', url);

            currentSection = section;
            if (section === 'my-interviews') {
                loadMyInterviewsForAdmin();
            }
        }

        async function loadMyInterviewsForAdmin() {
            try {
                const tbody = document.getElementById('my-interviews-table-body');
                if (!tbody) return;
                tbody.innerHTML = '<tr><td colspan="9" class="loading">Loading interviews...</td></tr>';

                const urlParams = new URLSearchParams(window.location.search);
                const urlEmail = urlParams.get('email');
                const stored = localStorage.getItem('bees_user_data');
                const data = stored ? JSON.parse(stored) : null;
                const email = urlEmail || data?.email || '';

                if (!email) {
                    tbody.innerHTML = '<tr><td colspan="9" class="error">User email not available</td></tr>';
                    return;
                }

                const res = await fetch(`/api/interviewer/interviews?email=${encodeURIComponent(email)}`, {
                    headers: { 'x-user-email': email }
                });
                const json = await res.json();
                if (!res.ok || !json.success) throw new Error(json.error || `HTTP ${res.status}`);

                const items = json.data || [];
                myInterviews = items; // Store in global variable for filtering
                if (!items.length) {
                    tbody.innerHTML = '<tr><td colspan="9" class="empty-state">No interviews found.</td></tr>';
                    return;
                }

                displayMyInterviews(items);
                populateMyInterviewsSessionFilter(); // Add this to populate session filter for my interviews
                
                // Attach reliable click handlers for all edit buttons (avoid inline parsing edge cases)
                tbody.addEventListener('click', (e) => {
                    const btn = e.target.closest('.edit-btn');
                    if (!btn) return;
                    e.preventDefault();
                    e.stopPropagation();
                    const tr = btn.closest('tr');
                    const id = tr && tr.getAttribute('data-row-id');
                    if (id) startEdit(id);
                });
                
                // Clear any editing state when data is refreshed
                currentEditRow = null;
                currentEditData = null;
                
                // Reinitialize bulk edit controls after data is loaded
                initializeBulkEditControls();
            } catch (err) {
                console.error('Error loading admin my interviews:', err);
                const tbody = document.getElementById('my-interviews-table-body');
                if (tbody) tbody.innerHTML = `<tr><td colspan="9" class="error">${err.message}</td></tr>`;
            }
        }

        // Display function for my interviews
        function displayMyInterviews(interviewsData = myInterviews, groupBy = '') {
            const tbody = document.getElementById('my-interviews-table-body');
            const container = document.querySelector('#my-interviews .table-container');
            if (!tbody) return;

            if (!interviewsData || interviewsData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" class="empty-state">No interviews found.</td></tr>';
                return;
            }

            // Apply grouping if specified
            if (groupBy) {
                const groupedData = groupMyInterviews(interviewsData, groupBy);
                displayGroupedMyInterviews(groupedData, tbody);
                return;
            }

            // Sort by created_at descending (recent first)
            interviewsData.sort((a, b) => {
                const dateA = new Date(a.created_at || a.interview_date);
                const dateB = new Date(b.created_at || b.interview_date);
                return dateB - dateA;
            });
            
            // Update pagination
            updateTotalPages(interviewsData, 'my-interviews');
            const paginatedData = getPaginatedData(interviewsData, 'my-interviews');

            tbody.innerHTML = paginatedData.map(interview => `
                <tr data-row-id="${interview.id}">
                    <td><input type="checkbox" class="row-checkbox" data-row-id="${interview.id}" onchange="toggleRowSelection('${interview.id}')"></td>
                    <td data-field="created_at">${formatDate(interview.created_at || interview.interview_date)}</td>
                    <td data-field="student_name">${interview.student_name || 'N/A'}</td>
                    <td data-field="zeta_id">${interview.zeta_id || 'N/A'}</td>
                    <td data-field="session_name">${interview.session_name || 'N/A'}</td>
                    <td data-field="status"><span class="status-badge status-${interview.status}">${interview.status}</span></td>
                    <td data-field="verdict">${interview.verdict || 'N/A'}</td>
                    <td data-field="duration_seconds">${formatDuration(interview.duration_seconds)}</td>
                    <td>
                        ${interview.status === 'in_progress' ? `<button class="icon-btn" onclick="resumeInterviewAdmin(${interview.id})" title="Resume">‚èµ</button>` : ''}
                        <button class="icon-btn edit-btn" onclick="startEdit('${interview.id}')" title="Edit">‚úèÔ∏è</button>
                        <button class="icon-btn delete-btn" onclick="deleteInterview('${interview.id}')" title="Delete">üóëÔ∏è</button>
                        <button class="icon-btn" onclick="viewInterview(${interview.id})" title="View">üëÅÔ∏è</button>
                    </td>
                </tr>
            `).join('');
            
            // Add pagination controls
            if (container) {
                const existingPagination = container.querySelector('.pagination-controls');
                if (existingPagination) {
                    existingPagination.remove();
                }
                
                const paginationHTML = createPaginationControls('my-interviews');
                if (paginationHTML) {
                    container.insertAdjacentHTML('beforeend', paginationHTML);
                }
                
                // Add pagination info
                const existingInfo = container.querySelector('.pagination-info');
                if (existingInfo) {
                    existingInfo.remove();
                }
                
                const startIndex = (currentPage['my-interviews'] - 1) * ITEMS_PER_PAGE + 1;
                const endIndex = Math.min(currentPage['my-interviews'] * ITEMS_PER_PAGE, interviewsData.length);
                const infoHTML = `
                    <div class="pagination-info">
                        <span>Showing ${startIndex}-${endIndex} of ${interviewsData.length} interviews</span>
                        <span>Page ${currentPage['my-interviews']} of ${totalPages['my-interviews']}</span>
                    </div>
                `;
                container.insertAdjacentHTML('beforeend', infoHTML);
            }
        }

        // Group my interviews function
        function groupMyInterviews(interviews, groupBy) {
            const groups = {};
            
            interviews.forEach(interview => {
                let groupKey = '';
                switch (groupBy) {
                    case 'status':
                        groupKey = interview.status || 'Unknown';
                        break;
                    case 'verdict':
                        groupKey = interview.verdict || 'No Verdict';
                        break;
                    case 'date':
                        groupKey = formatDate(interview.created_at || interview.interview_date);
                        break;
                    default:
                        groupKey = 'All Interviews';
                }
                
                if (!groups[groupKey]) {
                    groups[groupKey] = [];
                }
                groups[groupKey].push(interview);
            });
            
            return { groups, interviews };
        }

        // Display grouped my interviews
        function displayGroupedMyInterviews(groupedData, tbody) {
            const { groups } = groupedData;
            let html = '';
            
            Object.keys(groups).forEach(groupKey => {
                const groupInterviews = groups[groupKey];
                html += `
                    <tr class="group-header">
                        <td colspan="9" style="background: #2d3748; color: white; font-weight: 600; padding: 12px;">
                            ${groupKey} (${groupInterviews.length} interviews)
                        </td>
                    </tr>
                `;
                
                groupInterviews.forEach(interview => {
                    html += `
                        <tr data-row-id="${interview.id}">
                            <td><input type="checkbox" class="row-checkbox" data-row-id="${interview.id}" onchange="toggleRowSelection('${interview.id}')"></td>
                            <td data-field="created_at">${formatDate(interview.created_at || interview.interview_date)}</td>
                            <td data-field="student_name">${interview.student_name || 'N/A'}</td>
                            <td data-field="zeta_id">${interview.zeta_id || 'N/A'}</td>
                            <td data-field="session_name">${interview.session_name || 'N/A'}</td>
                            <td data-field="status"><span class="status-badge status-${interview.status}">${interview.status}</span></td>
                            <td data-field="verdict">${interview.verdict || 'N/A'}</td>
                            <td data-field="duration_seconds">${formatDuration(interview.duration_seconds)}</td>
                            <td>
                                <button class="icon-btn edit-btn" onclick="startEdit('${interview.id}')" title="Edit">‚úèÔ∏è</button>
                                <button class="icon-btn delete-btn" onclick="deleteInterview('${interview.id}')" title="Delete">üóëÔ∏è</button>
                                <button class="icon-btn" onclick="viewInterview(${interview.id})" title="View">üëÅÔ∏è</button>
                            </td>
                        </tr>
                    `;
                });
            });
            
            tbody.innerHTML = html;
        }

        // Overview functions
        async function loadOverviewStats() {
            try {
                const [interviewsRes, sessionsRes, questionsRes, studentsRes] = await Promise.all([
                    fetch('/api/admin/interviews/stats'),
                    fetch('/api/admin/sessions/stats'),
                    fetch('/api/admin/questions/stats'),
                    fetch('/api/admin/students/stats')
                ]);

                const interviewsData = await interviewsRes.json();
                const sessionsData = await sessionsRes.json();
                const questionsData = await questionsRes.json();
                const studentsData = await studentsRes.json();

                document.getElementById('total-interviews').textContent = interviewsData.data?.total || 0;
                document.getElementById('active-sessions').textContent = sessionsData.data?.active || 0;
                document.getElementById('total-questions').textContent = questionsData.data?.total_questions || 0;
                document.getElementById('total-students').textContent = studentsData.data?.total || 0;
            } catch (error) {
                console.error('Error loading overview stats:', error);
            }
        }

        // Interviews functions
        async function loadInterviews() {
            try {
                const response = await fetch('/api/admin/interviews');
                const data = await response.json();
                
                if (data.success) {
                    interviews = data.data;
                    displayInterviews();
                    populateInterviewerFilter();
                    populateSessionFilter(); // Add this to populate session filter
                }
            } catch (error) {
                console.error('Error loading interviews:', error);
            }
        }

        function displayInterviews() {
            const tbody = document.getElementById('interviews-table-body');
            const container = document.querySelector('#interviews .table-container');
            
            if (interviews.length === 0) {
                tbody.innerHTML = '<tr><td colspan="10" class="empty-state">No interviews found</td></tr>';
                return;
            }

            // Use the new unified filter system and sort by recent first
            let filteredInterviews = applyUnifiedFilters('interviews', interviews);
            
            // Sort by created_at descending (recent first)
            filteredInterviews.sort((a, b) => {
                const dateA = new Date(a.created_at || a.interview_date);
                const dateB = new Date(b.created_at || b.interview_date);
                return dateB - dateA;
            });
            
            // Update pagination
            updateTotalPages(filteredInterviews, 'interviews');
            const paginatedData = getPaginatedData(filteredInterviews, 'interviews');
            
            displayRegularInterviews(paginatedData, tbody);
            
            // Add pagination controls
            const existingPagination = container.querySelector('.pagination-controls');
            if (existingPagination) {
                existingPagination.remove();
            }
            
            const paginationHTML = createPaginationControls('interviews');
            if (paginationHTML) {
                container.insertAdjacentHTML('beforeend', paginationHTML);
            }
            
            // Add pagination info
            const existingInfo = container.querySelector('.pagination-info');
            if (existingInfo) {
                existingInfo.remove();
            }
            
            const startIndex = (currentPage['interviews'] - 1) * ITEMS_PER_PAGE + 1;
            const endIndex = Math.min(currentPage['interviews'] * ITEMS_PER_PAGE, filteredInterviews.length);
            const infoHTML = `
                <div class="pagination-info">
                    <span>Showing ${startIndex}-${endIndex} of ${filteredInterviews.length} interviews</span>
                    <span>Page ${currentPage['interviews']} of ${totalPages['interviews']}</span>
                </div>
            `;
            container.insertAdjacentHTML('beforeend', infoHTML);
        }

        // REMOVED: Old conflicting applyFiltersToInterviews function

        // REMOVED: Old conflicting applySortingToInterviews function
        
        function getSortFunction(sortKey) {
            switch (sortKey) {
                case 'created_at_desc':
                    return (a, b) => new Date(b.created_at) - new Date(a.created_at);
                case 'created_at_asc':
                    return (a, b) => new Date(a.created_at) - new Date(b.created_at);
                case 'student_name_asc':
                    return (a, b) => (a.student_name || '').localeCompare(b.student_name || '');
                case 'student_name_desc':
                    return (a, b) => (b.student_name || '').localeCompare(a.student_name || '');
                case 'duration_desc':
                    return (a, b) => (b.duration_seconds || 0) - (a.duration_seconds || 0);
                case 'duration_asc':
                    return (a, b) => (a.duration_seconds || 0) - (b.duration_seconds || 0);
                case 'status_asc':
                    return (a, b) => (a.status || '').localeCompare(b.status || '');
                case 'status_desc':
                    return (a, b) => (b.status || '').localeCompare(a.status || '');
                case 'verdict_asc':
                    return (a, b) => (a.verdict || '').localeCompare(b.verdict || '');
                case 'verdict_desc':
                    return (a, b) => (b.verdict || '').localeCompare(a.verdict || '');
                case 'interviewer_asc':
                    return (a, b) => (a.interviewer_name || '').localeCompare(b.interviewer_name || '');
                case 'interviewer_desc':
                    return (a, b) => (b.interviewer_name || '').localeCompare(a.interviewer_name || '');
                case 'session_asc':
                    return (a, b) => (a.session_name || '').localeCompare(b.session_name || '');
                case 'session_desc':
                    return (a, b) => (b.session_name || '').localeCompare(a.session_name || '');
                default:
                    return null;
            }
        }

        function applyGroupingToInterviews(interviewList) {
            const groupByRadio = document.querySelector('input[name="group-by"]:checked');
            const groupBy = groupByRadio ? groupByRadio.value : '';
            
            if (!groupBy) {
                return { groups: null, interviews: interviewList };
            }
            
            const groups = {};
            
            interviewList.forEach(interview => {
                let groupKey;
                switch (groupBy) {
                    case 'session':
                        groupKey = interview.session_name || 'No Session';
                        break;
                    case 'status':
                        groupKey = interview.status || 'Unknown';
                        break;
                    case 'verdict':
                        groupKey = interview.verdict || 'No Verdict';
                        break;
                    case 'interviewer':
                        groupKey = interview.interviewer_name || 'Unknown';
                        break;
                    case 'date':
                        groupKey = formatDate(interview.interview_date);
                        break;
                    case 'duration':
                        const duration = interview.duration_seconds || 0;
                        const minutes = Math.floor(duration / 60);
                        if (minutes < 5) groupKey = '0-5 minutes';
                        else if (minutes < 15) groupKey = '5-15 minutes';
                        else if (minutes < 30) groupKey = '15-30 minutes';
                        else if (minutes < 60) groupKey = '30-60 minutes';
                        else groupKey = '60+ minutes';
                        break;
                    default:
                        groupKey = 'Other';
                }
                
                if (!groups[groupKey]) {
                    groups[groupKey] = [];
                }
                groups[groupKey].push(interview);
            });
            
            return { groups, interviews: interviewList };
        }

        function displayRegularInterviews(interviewList, tbody, groupBy = '') {
            if (interviewList.length === 0) {
                tbody.innerHTML = '<tr><td colspan="10" class="empty-state">No interviews match the current filters</td></tr>';
                return;
            }

            // Handle grouping if specified
            if (groupBy) {
                const groupedData = groupInterviews(interviewList, groupBy);
                displayGroupedInterviews(groupedData, tbody);
                return;
            }

            tbody.innerHTML = interviewList.map(interview => `
                <tr data-row-id="${interview.id}">
                    <td><input type="checkbox" class="row-checkbox" data-row-id="${interview.id}" onchange="toggleRowSelection('${interview.id}')"></td>
                    <td data-field="id">${interview.id}</td>
                    <td data-field="student_name">${interview.student_name || 'N/A'}</td>
                    <td data-field="interviewer_name">${interview.interviewer_name || 'N/A'}</td>
                    <td data-field="session_name">${interview.session_name || 'N/A'}</td>
                    <td data-field="interview_date">${formatDate(interview.interview_date)}</td>
                    <td data-field="duration_seconds">${formatDuration(interview.duration_seconds)}</td>
                    <td data-field="status"><span class="status-badge status-${interview.status}">${interview.status}</span></td>
                    <td data-field="verdict">${interview.verdict || 'N/A'}</td>
                    <td>
                        <button class="icon-btn edit-btn" onclick="startEdit('${interview.id}')" title="Edit">‚úèÔ∏è</button>
                        <button class="icon-btn delete-btn" onclick="deleteInterview('${interview.id}')" title="Delete">üóëÔ∏è</button>
                        <button class="icon-btn" onclick="viewInterview(${interview.id})" title="View">üëÅÔ∏è</button>
                    </td>
                </tr>
            `).join('');
            
            // Attach reliable click handlers for all edit buttons (avoid inline parsing edge cases)
            tbody.addEventListener('click', (e) => {
                const btn = e.target.closest('.edit-btn');
                if (!btn) return;
                e.preventDefault();
                e.stopPropagation();
                const tr = btn.closest('tr');
                const id = tr && tr.getAttribute('data-row-id');
                if (id) startEdit(id);
            });
            
            // Clear any editing state when data is refreshed
            currentEditRow = null;
            currentEditData = null;
            
            // Reinitialize bulk edit controls after data is loaded
            initializeBulkEditControls();
        }

        function displayGroupedInterviews(groupedData, container) {
            const { groups } = groupedData;
            
            let html = '';
            Object.keys(groups).sort().forEach(groupKey => {
                const groupInterviews = groups[groupKey];
                html += `
                    <div class="grouped-table">
                        <div class="group-header">
                            ${groupKey} <span class="group-count">(${groupInterviews.length} interviews)</span>
                        </div>
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Student</th>
                                    <th>Interviewer</th>
                                    <th>Session</th>
                                    <th>Date</th>
                                    <th>Duration</th>
                                    <th>Status</th>
                                    <th>Verdict</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${groupInterviews.map(interview => `
                                    <tr>
                                        <td>${interview.id}</td>
                                        <td>${interview.student_name || 'N/A'}</td>
                                        <td>${interview.interviewer_name || 'N/A'}</td>
                                        <td>${interview.session_name || 'N/A'}</td>
                                        <td>${formatDate(interview.interview_date)}</td>
                                        <td>${formatDuration(interview.duration_seconds)}</td>
                                        <td><span class="status-badge status-${interview.status}">${interview.status}</span></td>
                                        <td>${interview.verdict || 'N/A'}</td>
                                        <td>
                                            <button class="btn btn-primary" onclick="viewInterview(${interview.id})">View</button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        // Filter, Sort, and Group Functions
        function applyFilters() {
            displayInterviews();
            updateResultsSummary();
        }

        function applySorting() {
            displayInterviews();
        }

        function applyGrouping() {
            displayInterviews();
        }

        function applySearch() {
            displayInterviews();
            updateResultsSummary();
        }
        
        function clearAllFilters() {
            // Clear all filter inputs
            document.getElementById('search-interviews').value = '';
            document.getElementById('status-filter').value = '';
            document.getElementById('session-filter').value = '';
            document.getElementById('verdict-filter').value = '';
            document.getElementById('interviewer-filter').value = '';
            document.getElementById('date-from').value = '';
            document.getElementById('date-to').value = '';
            document.getElementById('duration-min').value = '';
            
            // Reset sorting
            document.getElementById('sort-by').value = 'created_at_desc';
            document.getElementById('sort-by-2').value = '';
            
            // Reset grouping
            document.getElementById('group-none').checked = true;
            
            // Refresh display
            displayInterviews();
            updateResultsSummary();
        }
        
        function updateResultsSummary() {
            const filteredInterviews = applyFiltersToInterviews();
            const summaryElement = document.getElementById('results-summary');
            
            if (summaryElement) {
                summaryElement.innerHTML = `<strong>${filteredInterviews.length}</strong> interviews found`;
                summaryElement.style.display = filteredInterviews.length > 0 ? 'block' : 'none';
            }
        }
        
        function exportInterviews() {
            const filteredInterviews = applyFiltersToInterviews();
            const sortedInterviews = applySortingToInterviews(filteredInterviews);
            
            // Create CSV content
            const headers = ['ID', 'Student Name', 'Student Email', 'Zeta ID', 'Interviewer', 'Session', 'Status', 'Verdict', 'Duration (min)', 'Date'];
            const csvContent = [
                headers.join(','),
                ...sortedInterviews.map(interview => [
                    interview.id,
                    `"${interview.student_name || ''}"`,
                    `"${interview.student_email || ''}"`,
                    `"${interview.zeta_id || ''}"`,
                    `"${interview.interviewer_name || ''}"`,
                    `"${interview.session_name || ''}"`,
                    `"${interview.status || ''}"`,
                    `"${interview.verdict || ''}"`,
                    Math.floor((interview.duration_seconds || 0) / 60),
                    `"${formatDate(interview.interview_date || interview.created_at)}"`
                ].join(','))
            ].join('\n');
            
            // Download CSV
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `interviews_export_${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }
        
        function populateInterviewerFilter() {
            const interviewerFilter = document.getElementById('interviewer-filter');
            if (!interviewerFilter) return;
            
            // Clear existing options except "All Interviewers"
            interviewerFilter.innerHTML = '<option value="">All Interviewers</option>';
            
            // Get unique interviewers
            const uniqueInterviewers = [...new Set(interviews.map(interview => interview.interviewer_name).filter(name => name))];
            uniqueInterviewers.sort().forEach(interviewerName => {
                const option = document.createElement('option');
                option.value = interviewerName;
                option.textContent = interviewerName;
                interviewerFilter.appendChild(option);
            });
        }

        // Questions functions
        async function loadQuestions() {
            try {
                // Resolve current user email (from URL first, then localStorage)
                const urlParams = new URLSearchParams(window.location.search);
                const urlEmail = urlParams.get('email');
                let email = urlEmail;
                if (!email) {
                    try {
                        const stored = localStorage.getItem('bees_user_data');
                        const data = stored ? JSON.parse(stored) : null;
                        email = data?.email || '';
                    } catch {}
                }

                const [analyticsRes, favRes] = await Promise.all([
                    fetch('/api/admin/questions/analytics'),
                    email ? fetch(`/api/interviewer/favorites?email=${encodeURIComponent(email)}`) : Promise.resolve(null)
                ]);

                const analyticsJson = await analyticsRes.json();
                if (analyticsJson && analyticsJson.success) {
                    questions = analyticsJson.data || [];
                } else {
                    questions = [];
                }

                if (favRes) {
                    try {
                        const favJson = await favRes.json();
                        if (favJson && favJson.success) {
                            favoriteQuestionIds = new Set((favJson.data || []).map(f => f.question_id));
                        }
                    } catch {}
                }

                displayQuestions();
            } catch (error) {
                console.error('Error loading questions:', error);
                questions = [];
                displayQuestions();
            }
        }

        function displayQuestions(questionsData = questions, groupBy = '') {
            const tbody = document.getElementById('questions-table-body');
            const container = document.querySelector('#questions .table-container');
            
            if (!questionsData || questionsData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="empty-state">No questions found</td></tr>';
                return;
            }

            // Handle grouping if specified
            if (groupBy) {
                const groupedData = groupQuestions(questionsData, groupBy);
                displayGroupedQuestions(groupedData, tbody);
                return;
            }

            // Sort by created_at descending (recent first)
            questionsData.sort((a, b) => {
                const dateA = new Date(a.created_at || a.created_date);
                const dateB = new Date(b.created_at || b.created_date);
                return dateB - dateA;
            });
            
            // Update pagination
            updateTotalPages(questionsData, 'questions');
            const paginatedData = getPaginatedData(questionsData, 'questions');

            tbody.innerHTML = paginatedData.map(question => `
                <tr data-row-id="${question.id}">
                    <td><input type="checkbox" class="row-checkbox" data-row-id="${question.id}" onchange="toggleRowSelection('${question.id}')"></td>
                    <td data-field="question">
                        <span>${question.question || 'N/A'}</span>
                        <button 
                            class="favorite-btn ${favoriteQuestionIds.has(question.id) ? 'favorited' : ''}"
                            onclick="toggleFavorite(${question.id})"
                            title="${favoriteQuestionIds.has(question.id) ? 'Remove from favorites' : 'Add to favorites'}"
                            style="margin-left:8px"
                        >${favoriteQuestionIds.has(question.id) ? '‚òÖ' : '‚òÜ'}</button>
                    </td>
                    <td data-field="category">${question.category || 'N/A'}</td>
                    <td data-field="times_asked">${question.times_asked || question.count_of_times_asked || 0}</td>
                    <td data-field="correct_answers">${question.correct_answers || question.times_answered_correctly || 0}</td>
                    <td data-field="incorrect_answers">${question.incorrect_answers || question.times_answered_incorrectly || 0}</td>
                    <td data-field="success_rate">${question.success_rate || 0}%</td>
                    <td>
                        <button class="icon-btn edit-btn" onclick="startEdit('${question.id}')" title="Edit">‚úèÔ∏è</button>
                        <button class="icon-btn delete-btn" onclick="deleteQuestion('${question.id}')" title="Delete">üóëÔ∏è</button>
                        <button class="icon-btn" onclick="viewQuestion(${question.id})" title="View">üëÅÔ∏è</button>
                    </td>
                </tr>
            `).join('');
            
            // Add pagination controls
            if (container) {
                const existingPagination = container.querySelector('.pagination-controls');
                if (existingPagination) {
                    existingPagination.remove();
                }
                
                const paginationHTML = createPaginationControls('questions');
                if (paginationHTML) {
                    container.insertAdjacentHTML('beforeend', paginationHTML);
                }
                
                // Add pagination info
                const existingInfo = container.querySelector('.pagination-info');
                if (existingInfo) {
                    existingInfo.remove();
                }
                
                const startIndex = (currentPage['questions'] - 1) * ITEMS_PER_PAGE + 1;
                const endIndex = Math.min(currentPage['questions'] * ITEMS_PER_PAGE, questionsData.length);
                const infoHTML = `
                    <div class="pagination-info">
                        <span>Showing ${startIndex}-${endIndex} of ${questionsData.length} questions</span>
                        <span>Page ${currentPage['questions']} of ${totalPages['questions']}</span>
                    </div>
                `;
                container.insertAdjacentHTML('beforeend', infoHTML);
            }
            
            // Attach reliable click handlers for all edit buttons (avoid inline parsing edge cases)
            tbody.addEventListener('click', (e) => {
                const btn = e.target.closest('.edit-btn');
                if (!btn) return;
                e.preventDefault();
                e.stopPropagation();
                const tr = btn.closest('tr');
                const id = tr && tr.getAttribute('data-row-id');
                if (id) startEdit(id);
            });
            
            // Clear any editing state when data is refreshed
            currentEditRow = null;
            currentEditData = null;
            
            // Reinitialize bulk edit controls after data is loaded
            initializeBulkEditControls();
        }

        async function toggleFavorite(questionId) {
            try {
                // Resolve current user email
                const urlParams = new URLSearchParams(window.location.search);
                const urlEmail = urlParams.get('email');
                let email = urlEmail;
                if (!email) {
                    try {
                        const stored = localStorage.getItem('bees_user_data');
                        const data = stored ? JSON.parse(stored) : null;
                        email = data?.email || '';
                    } catch {}
                }

                if (!email) {
                    showError('User email not available. Please log in again.');
                    return;
                }

                const isFavorited = favoriteQuestionIds.has(questionId);
                const method = isFavorited ? 'DELETE' : 'POST';
                const res = await fetch(`/api/interviewer/favorites?email=${encodeURIComponent(email)}`, {
                    method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ question_id: questionId })
                });
                const json = await res.json();
                if (!res.ok || json.success === false) throw new Error(json.error || `HTTP ${res.status}`);

                if (isFavorited) favoriteQuestionIds.delete(questionId); else favoriteQuestionIds.add(questionId);

                // Re-render the questions table to update star states
                displayQuestions();
            } catch (e) {
                console.error('Error toggling favorite:', e);
                showError(`Failed to update favorite: ${e.message || 'Unknown error'}`);
            }
        }

        // Sessions functions
        async function loadSessions() {
            try {
                const response = await fetch('/api/admin/sessions');
                const data = await response.json();
                
                if (data.success) {
                    sessions = data.data;
                    displaySessions();
                    populateSessionFilter();
                }
            } catch (error) {
                console.error('Error loading sessions:', error);
            }
        }

        function populateSessionFilter() {
            const sessionFilter = document.getElementById('session-filter');
            if (!sessionFilter) return;
            
            // Clear existing options except "All Sessions"
            sessionFilter.innerHTML = '<option value="">All Sessions</option>';
            
            // Add unique session names from all sessions (not just interviews)
            const uniqueSessions = [...new Set(sessions.map(session => session.name))];
            uniqueSessions.forEach(sessionName => {
                const option = document.createElement('option');
                option.value = sessionName;
                option.textContent = sessionName;
                sessionFilter.appendChild(option);
            });
        }

        function populateMyInterviewsSessionFilter() {
            const sessionFilter = document.getElementById('my-session-filter');
            if (!sessionFilter) return;
            
            // Clear existing options except "All Sessions"
            sessionFilter.innerHTML = '<option value="">All Sessions</option>';
            
            // Add unique session names from all sessions (not just my interviews)
            const uniqueSessions = [...new Set(sessions.map(session => session.name))];
            uniqueSessions.forEach(sessionName => {
                const option = document.createElement('option');
                option.value = sessionName;
                option.textContent = sessionName;
                sessionFilter.appendChild(option);
            });
        }

        function displaySessions(sessionsData = sessions, groupBy = '') {
            const tbody = document.getElementById('sessions-table-body');
            
            if (!sessionsData || sessionsData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="empty-state">No sessions found</td></tr>';
                return;
            }

            // Handle grouping if specified
            if (groupBy) {
                const groupedData = groupSessions(sessionsData, groupBy);
                displayGroupedSessions(groupedData, tbody);
                return;
            }

            tbody.innerHTML = sessionsData.map(session => `
                <tr data-row-id="${session.id}">
                    <td><input type="checkbox" class="row-checkbox" data-row-id="${session.id}" onchange="toggleRowSelection('${session.id}')"></td>
                    <td data-field="id">${session.id}</td>
                    <td data-field="name">${session.name}</td>
                    <td data-field="description">${session.description || 'N/A'}</td>
                    <td data-field="status"><span class="status-badge status-${session.status}">${session.status}</span></td>
                    <td data-field="panelists">${session.panelist_names || '‚Äî'}</td>
                    <td data-field="created_by_name">${session.created_by_name || 'N/A'}</td>
                    <td data-field="created_at">${formatDate(session.created_at)}</td>
                    <td>
                        <button class="icon-btn edit-btn" onclick="startEdit('${session.id}')" title="Edit">‚úèÔ∏è</button>
                        <button class="icon-btn delete-btn" onclick="deleteSession('${session.id}')" title="Delete">üóëÔ∏è</button>
                        <button class="icon-btn" onclick="viewSession(${session.id})" title="View">üëÅÔ∏è</button>
                    </td>
                </tr>
            `).join('');

            // Attach reliable click handlers for all edit buttons (avoid inline parsing edge cases)
            tbody.addEventListener('click', (e) => {
                const btn = e.target.closest('.edit-btn');
                if (!btn) return;
                e.preventDefault();
                e.stopPropagation();
                const tr = btn.closest('tr');
                const id = tr && tr.getAttribute('data-row-id');
                if (id) startEdit(id);
            });
            
            // Clear any editing state when data is refreshed
            currentEditRow = null;
            currentEditData = null;
            
            // Reinitialize bulk edit controls after data is loaded
            initializeBulkEditControls();
        }

        // Students functions
        async function loadStudents() {
            try {
                const response = await fetch('/api/admin/students');
                const data = await response.json();
                
                if (data.success) {
                    students = data.data;
                    displayStudents();
                }
            } catch (error) {
                console.error('Error loading students:', error);
            }
        }

        function displayStudents(studentsData = students, groupBy = '') {
            const tbody = document.getElementById('students-table-body');
            
            if (!studentsData || studentsData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="empty-state">No students found</td></tr>';
                return;
            }

            // Handle grouping if specified
            if (groupBy) {
                const groupedData = groupStudents(studentsData, groupBy);
                displayGroupedStudents(groupedData, tbody);
                return;
            }

            tbody.innerHTML = studentsData.map(student => `
                <tr data-row-id="${student.id}">
                    <td><input type="checkbox" class="row-checkbox" data-row-id="${student.id}" onchange="toggleRowSelection('${student.id}')"></td>
                    <td data-field="id">${student.id}</td>
                    <td data-field="name">${student.name}</td>
                    <td data-field="email">${student.email}</td>
                    <td data-field="zeta_id">${student.zeta_id}</td>
                    <td data-field="phone">${student.phone || 'N/A'}</td>
                    <td data-field="interview_count">${student.interview_count || 0}</td>
                    <td>
                        <button class="icon-btn edit-btn" onclick="startEdit('${student.id}')" title="Edit">‚úèÔ∏è</button>
                        <button class="icon-btn delete-btn" onclick="deleteRecord('${student.id}', 'student')" title="Delete">üóëÔ∏è</button>
                        <button class="icon-btn" onclick="viewStudent(${student.id})" title="View">üëÅÔ∏è</button>
                    </td>
                </tr>
            `).join('');
            
            // Attach reliable click handlers for all edit buttons (avoid inline parsing edge cases)
            tbody.addEventListener('click', (e) => {
                const btn = e.target.closest('.edit-btn');
                if (!btn) return;
                e.preventDefault();
                e.stopPropagation();
                const tr = btn.closest('tr');
                const id = tr && tr.getAttribute('data-row-id');
                if (id) startEdit(id);
            });
            
            // Clear any editing state when data is refreshed
            currentEditRow = null;
            currentEditData = null;
            
            // Reinitialize bulk edit controls after data is loaded
            initializeBulkEditControls();
        }

        // Modal functions
        function openCreateSessionModal() {
            document.getElementById('create-session-modal').classList.add('active');
        }

        function closeCreateSessionModal() {
            document.getElementById('create-session-modal').classList.remove('active');
            document.getElementById('create-session-form').reset();
            selectedPanelists = [];
            updateSelectedPanelistsDisplay();
            document.getElementById('panelist-search-results').style.display = 'none';
        }

        async function createSession() {
            const name = document.getElementById('session-name').value;
            const description = document.getElementById('session-description').value;

            try {
                const response = await fetch('/api/admin/sessions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        name: name,
                        description: description,
                        created_by: currentUserId || undefined,
                        panelists: selectedPanelists
                    })
                });

                const data = await response.json();
                
                if (data.success) {
                    closeCreateSessionModal();
                    loadSessions();
                    showSuccess('Session created successfully!');
                } else {
                    showError('Error creating session: ' + data.error);
                }
            } catch (error) {
                console.error('Error creating session:', error);
                showError('Error creating session');
            }
        }

        // Panelist management functions
        async function searchInterviewers() {
            const searchTerm = document.getElementById('panelist-search').value.toLowerCase();
            const resultsContainer = document.getElementById('panelist-search-results');
            
            if (searchTerm.length < 2) {
                resultsContainer.style.display = 'none';
                return;
            }

            try {
                // Load all interviewers if not already loaded
                if (allInterviewers.length === 0) {
                    await loadAllInterviewers();
                }

                // Filter interviewers based on search term
                const filteredInterviewers = allInterviewers.filter(interviewer => 
                    interviewer.name.toLowerCase().includes(searchTerm) ||
                    interviewer.email.toLowerCase().includes(searchTerm)
                );

                // Remove already selected panelists
                const availableInterviewers = filteredInterviewers.filter(interviewer => 
                    !selectedPanelists.some(selected => selected.id === interviewer.id)
                );

                displaySearchResults(availableInterviewers, searchTerm);
            } catch (error) {
                console.error('Error searching interviewers:', error);
            }
        }

        async function loadAllInterviewers() {
            try {
                const response = await fetch('/api/admin/users/interviewers');
                const data = await response.json();
                if (data.success) {
                    allInterviewers = data.data;
                } else {
                    console.error('Error loading interviewers:', data.error);
                    allInterviewers = [];
                }
            } catch (error) {
                console.error('Error loading interviewers:', error);
                allInterviewers = [];
            }
        }

        function displaySearchResults(interviewers, searchTerm) {
            const resultsContainer = document.getElementById('panelist-search-results');
            
            if (interviewers.length === 0) {
                resultsContainer.innerHTML = `
                    <div class="search-result-item">
                        <div class="search-result-info">
                            <div class="search-result-name">No interviewers found</div>
                            <div class="search-result-email">Add "${searchTerm}" as new interviewer</div>
                        </div>
                        <button type="button" class="add-new-interviewer" onclick="event.stopPropagation(); addNewInterviewer('${searchTerm}')">
                            Add New
                        </button>
                    </div>
                `;
            } else {
                resultsContainer.innerHTML = interviewers.map(interviewer => `
                    <div class="search-result-item" onclick="addPanelist(${interviewer.id}, '${interviewer.name.replace(/'/g, "\\'")}', '${interviewer.email.replace(/'/g, "\\'")}')">
                        <div class="search-result-info">
                            <div class="search-result-name">${interviewer.name}</div>
                            <div class="search-result-email">${interviewer.email}</div>
                        </div>
                    </div>
                `).join('');
            }
            
            resultsContainer.style.display = 'block';
        }

        function addPanelist(id, name, email) {
            // Check if already selected
            if (selectedPanelists.some(panelist => panelist.id === id)) {
                return;
            }

            selectedPanelists.push({ id, name, email });
            updateSelectedPanelistsDisplay();
            
            // Clear search
            document.getElementById('panelist-search').value = '';
            document.getElementById('panelist-search-results').style.display = 'none';
        }

        function removePanelist(id) {
            selectedPanelists = selectedPanelists.filter(panelist => panelist.id !== id);
            updateSelectedPanelistsDisplay();
        }

        function updateSelectedPanelistsDisplay() {
            const container = document.getElementById('selected-panelists-list');
            
            if (selectedPanelists.length === 0) {
                container.innerHTML = '<div style="color: #666; font-style: italic;">No panelists selected</div>';
            } else {
                container.innerHTML = selectedPanelists.map(panelist => `
                    <div class="selected-panelist">
                        <span class="selected-panelist-name">${panelist.name}</span>
                        <button type="button" class="remove-panelist" onclick="removePanelist(${panelist.id})" title="Remove panelist">√ó</button>
                    </div>
                `).join('');
            }
        }

        async function addNewInterviewer(email) {
            const normalized = (email || '').trim();
            if (!normalized || !/^[^@\s]+@[^@\s]+\.[^@\s]+$/.test(normalized)) {
                showError('Please provide a valid email to add a new interviewer');
                return;
            }
            const name = normalized.split('@')[0].replace(/[._]/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
            
            try {
                const response = await fetch('/api/admin/users/interviewers', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        name: name,
                        email: normalized,
                        role: 'interviewer'
                    })
                });

                const data = await response.json();
                if (response.ok && data.success) {
                    // Add to master list and selected list but DO NOT submit session here
                    allInterviewers.push(data.data);
                    addPanelist(data.data.id, data.data.name, data.data.email);
                    
                    // Keep modal open, clear search box and results so user can add more
                    const searchInput = document.getElementById('panelist-search');
                    const results = document.getElementById('panelist-search-results');
                    if (searchInput) searchInput.value = '';
                    if (results) results.style.display = 'none';
                    showSuccess('New interviewer added. You can add more or click Create Session.');
                } else {
                    showError('Error adding interviewer: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error adding interviewer:', error);
                showError('Error adding interviewer');
            }
        }

        async function addNewInterviewerFromEdit(rowId) {
            const input = document.getElementById(`new-panelist-email-${rowId}`);
            if (!input) return;
            const email = (input.value || '').trim();
            if (!email) { showError('Please enter an email'); return; }
            await addNewInterviewer(email);
            // Refresh multi-select options by appending the new interviewer if present
            const latest = allInterviewers[allInterviewers.length - 1];
            const select = document.getElementById(`panelist-select-${rowId}`);
            if (latest && select && !Array.from(select.options).some(o => String(o.value) === String(latest.id))) {
                const opt = document.createElement('option');
                opt.value = latest.id;
                opt.textContent = `${latest.name} (${latest.email})`;
                opt.selected = true;
                select.appendChild(opt);
            }
            input.value = '';
        }

        // Add Question Modal Functions
        async function openAddQuestionModal() {
            document.getElementById('add-question-modal').classList.add('active');
            // Load categories from database
            await loadCategoriesForModal();
            
            // Handle new category button
            document.getElementById('add-new-category-btn').onclick = () => {
                const inputDiv = document.getElementById('new-category-input');
                const input = document.getElementById('new-category-name');
                if (inputDiv.style.display === 'none') {
                    inputDiv.style.display = 'block';
                    input.focus();
                } else {
                    inputDiv.style.display = 'none';
                    input.value = '';
                }
            };
            
            // Handle new category input
            document.getElementById('new-category-name').addEventListener('keypress', async (e) => {
                if (e.key === 'Enter') {
                    const newCategory = e.target.value.trim();
                    if (newCategory) {
                        await addNewCategory(newCategory);
                    }
                }
            });
        }

        function closeAddQuestionModal() {
            document.getElementById('add-question-modal').classList.remove('active');
            document.getElementById('add-question-form').reset();
            document.getElementById('new-category-input').style.display = 'none';
        }

        // Load categories for the modal
        async function loadCategoriesForModal() {
            try {
                const response = await fetch('/api/question-bank/categories');
                const result = await response.json();
                
                const categorySelect = document.getElementById('question-category');
                if (result.success && result.data) {
                    categorySelect.innerHTML = '<option value="">Select Category</option>';
                    result.data.forEach(categoryData => {
                        const categoryName = typeof categoryData === 'string' ? categoryData : categoryData.category;
                        const option = document.createElement('option');
                        option.value = categoryName;
                        option.textContent = categoryName;
                        categorySelect.appendChild(option);
                    });
                } else {
                    categorySelect.innerHTML = '<option value="">No categories found</option>';
                }
            } catch (error) {
                console.error('Error loading categories:', error);
                document.getElementById('question-category').innerHTML = '<option value="">Error loading categories</option>';
            }
        }

        // Add new category
        async function addNewCategory(categoryName) {
            try {
                const response = await fetch('/api/question-bank/categories', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ category: categoryName })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    // Add to dropdown
                    const categorySelect = document.getElementById('question-category');
                    const option = document.createElement('option');
                    option.value = categoryName;
                    option.textContent = categoryName;
                    option.selected = true;
                    categorySelect.appendChild(option);
                    
                    // Hide input
                    document.getElementById('new-category-input').style.display = 'none';
                    document.getElementById('new-category-name').value = '';
                    
                    showSuccess('Category added successfully!');
                } else {
                    showError('Error adding category: ' + (result.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error adding category:', error);
                showError('Error adding category');
            }
        }

        async function addQuestion() {
            const questionText = document.getElementById('question-text').value;
            const categorySelect = document.getElementById('question-category');
            const newCategoryInput = document.getElementById('new-category-name');
            
            console.log('Add Question Debug:', {
                questionText: questionText,
                categorySelectValue: categorySelect.value,
                newCategoryValue: newCategoryInput.value,
                newCategoryDisplay: newCategoryInput.style.display
            });
            
            let category = '';
            
            // Check if user is adding a new category
            if (newCategoryInput.value.trim()) {
                category = newCategoryInput.value.trim();
                console.log('Using new category:', category);
            } else {
                category = categorySelect.value;
                console.log('Using selected category:', category);
            }

            if (!questionText) {
                console.log('Validation failed: Question text is required');
                showError('Please enter the question text');
                return;
            }
            
            if (!category) {
                console.log('Validation failed: Category is required');
                showError('Please select a category or create a new one');
                return;
            }

            try {
                const response = await fetch('/api/question-bank', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        question: questionText,
                        category: category
                    })
                });

                const data = await response.json();
                
                if (data.success) {
                    closeAddQuestionModal();
                    loadQuestions();
                    showSuccess('Question added successfully!');
                } else {
                    showError('Error adding question: ' + data.error);
                }
            } catch (error) {
                console.error('Error adding question:', error);
                showError('Error adding question');
            }
        }

        function closeQuestionDetailsModal() {
            document.getElementById('question-details-modal').classList.remove('active');
        }

        async function viewQuestionDetails(questionId) {
            try {
                const response = await fetch(`/api/admin/questions/${questionId}/details`);
                const data = await response.json();
                
                if (data.success) {
                    displayQuestionDetails(data.data);
                    document.getElementById('question-details-modal').classList.add('active');
                } else {
                    showError('Error loading question details');
                }
            } catch (error) {
                console.error('Error loading question details:', error);
                showError('Error loading question details');
            }
        }

        function displayQuestionDetails(question) {
            const content = document.getElementById('question-details-content');
            content.innerHTML = `
                <div class="form-group">
                    <label class="form-label">Question</label>
                    <p>${question.question_text}</p>
                </div>
                <div class="form-group">
                    <label class="form-label">Category</label>
                    <p>${question.category || 'N/A'}</p>
                </div>
                <div class="form-group">
                    <label class="form-label">Performance Statistics</label>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-value">${question.times_asked || 0}</div>
                            <div class="stat-label">Times Asked</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${question.correct_answers || question.times_answered_correctly || 0}</div>
                            <div class="stat-label">Correct Answers</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${question.incorrect_answers || question.times_answered_incorrectly || 0}</div>
                            <div class="stat-label">Incorrect Answers</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${question.success_rate || 0}%</div>
                            <div class="stat-label">Success Rate</div>
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Student Performance Breakdown</label>
                    <div class="table-container">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Student</th>
                                    <th>Answer</th>
                                    <th>Correct</th>
                                    <th>Date</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${question.student_answers ? question.student_answers.map(answer => `
                                    <tr>
                                        <td>${answer.student_name}</td>
                                        <td>${answer.answer_text || 'N/A'}</td>
                                        <td>${answer.is_correct ? 'Yes' : 'No'}</td>
                                        <td>${formatDate(answer.answered_at)}</td>
                                    </tr>
                                `).join('') : '<tr><td colspan="4">No answers recorded</td></tr>'}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        // Utility functions
        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            const date = new Date(dateString);
            return date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
        }

        function formatDuration(seconds) {
            if (!seconds) return 'N/A';
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            const secs = seconds % 60;
            
            if (hours > 0) {
                return `${hours}h ${minutes}m ${secs}s`;
            } else if (minutes > 0) {
                return `${minutes}m ${secs}s`;
            } else {
                return `${secs}s`;
            }
        }

        function showSuccess(message) {
            const overlay = document.createElement('div');
            overlay.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.2);display:flex;align-items:center;justify-content:center;z-index:2000;';
            overlay.innerHTML = `
              <div style="background:#fff;border:1px solid #e5e7eb;border-radius:8px;min-width:300px;max-width:90%;padding:16px;box-shadow:0 10px 20px rgba(0,0,0,0.15)">
                <div style="font-weight:600;margin-bottom:8px;color:#111827">Success</div>
                <div style="font-size:14px;color:#374151;margin-bottom:12px">${message}</div>
                <div style="display:flex;gap:8px;justify-content:flex-end">
                  <button id="succ-ok" style="background:#111827;color:#fff;border:none;padding:6px 10px;border-radius:6px;cursor:pointer">OK</button>
                </div>
              </div>`;
            document.body.appendChild(overlay);
            overlay.querySelector('#succ-ok').onclick = ()=> overlay.remove();
        }

        function showError(message) {
            const overlay = document.createElement('div');
            overlay.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.35);display:flex;align-items:center;justify-content:center;z-index:2000;';
            overlay.innerHTML = `
              <div style="background:#fff;border:1px solid #e5e7eb;border-radius:8px;min-width:300px;max-width:90%;padding:16px;box-shadow:0 10px 20px rgba(0,0,0,0.15)">
                <div style="font-weight:600;margin-bottom:8px;color:#111827">Error</div>
                <div style="font-size:14px;color:#374151;margin-bottom:12px">${message}</div>
                <div style="display:flex;gap:8px;justify-content:flex-end">
                  <button id="err-ok" style="background:#111827;color:#fff;border:none;padding:6px 10px;border-radius:6px;cursor:pointer">OK</button>
                </div>
              </div>`;
            document.body.appendChild(overlay);
            overlay.querySelector('#err-ok').onclick = ()=> overlay.remove();
        }

        // Detail Panel Functions
        function openDetailPanel(title, content) {
            console.log('üöÄ openDetailPanel called with title:', title);
            document.getElementById('detail-panel-title').textContent = title;
            document.getElementById('detail-panel-content').innerHTML = content;
            document.getElementById('detail-panel').classList.add('active');
            document.getElementById('panel-overlay').classList.add('active');
            console.log('‚úÖ Detail panel opened successfully');
        }

        function closeDetailPanel() {
            document.getElementById('detail-panel').classList.remove('active');
            document.getElementById('panel-overlay').classList.remove('active');
        }

        // Filter Panel Functions
        let currentFilterTab = 'interviews'; // Default tab
        
        function toggleFilterPanel(tab = 'interviews') {
            const panel = document.getElementById('filter-panel');
            const overlay = document.getElementById('filter-panel-overlay');
            
            if (panel.classList.contains('active') && currentFilterTab === tab) {
                panel.classList.remove('active');
                overlay.classList.remove('active');
            } else {
                currentFilterTab = tab;
                generateFilterContent(tab);
                
                // Add event listeners to the newly generated filter inputs
                addFilterEventListeners(tab);
                
                panel.classList.add('active');
                overlay.classList.add('active');
            }
        }

        function generateFilterContent(tab) {
            const content = document.querySelector('.filter-panel-content');
            const titles = {
                'interviews': 'All Interviews',
                'questions': 'Questions Analytics',
                'sessions': 'Interview Sessions',
                'students': 'Students',
                'my-interviews': 'My Interviews'
            };
            
            content.innerHTML = `
                <div class="filter-section">
                    <div class="filter-section-title">üîç Search & Filter</div>
                    <div class="filter-row">
                        ${generateFilterFields(tab)}
                    </div>
                </div>
                
                <div class="sort-section">
                    <div class="filter-section-title">üìä Sort Options</div>
                    <div class="sort-options">
                        ${generateSortOptions(tab)}
                    </div>
                </div>
                
                <div class="group-by-section">
                    <div class="filter-section-title">üìã Group By</div>
                    <div class="group-by-options">
                        ${generateGroupByOptions(tab)}
                    </div>
                </div>
                
                <div class="filter-actions">
                    <button class="btn-filter" onclick="applyFilters('${tab}', true)">Apply Filters</button>
                    <button class="btn-clear" onclick="clearAllFilters('${tab}')">Clear All</button>
                    <button class="btn-export" onclick="exportData('${tab}')">Export Data</button>
                </div>
            `;
        }

        function generateFilterFields(tab) {
            const filterConfigs = {
                'interviews': `
                    <div class="filter-group">
                        <label>Search:</label>
                        <input type="text" id="search-interviews" class="form-input" placeholder="Search by student name, email, Zeta ID, or interviewer...">
                    </div>
                    <div class="filter-group">
                        <label>Status:</label>
                        <select id="status-filter" class="form-select">
                            <option value="">All Statuses</option>
                            ${getUniqueValues(interviews, 'status').map(status => `<option value="${status}">${status}</option>`).join('')}
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Verdict:</label>
                        <select id="verdict-filter" class="form-select">
                            <option value="">All Verdicts</option>
                            ${getUniqueValues(interviews, 'verdict').map(verdict => `<option value="${verdict}">${verdict}</option>`).join('')}
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Session:</label>
                        <select id="session-filter" class="form-select">
                            <option value="">All Sessions</option>
                            ${getUniqueValues(interviews, 'session_name').map(name => `<option value="${name}">${name}</option>`).join('')}
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Date From:</label>
                        <input type="date" id="date-from" class="form-input">
                    </div>
                    <div class="filter-group">
                        <label>Date To:</label>
                        <input type="date" id="date-to" class="form-input">
                    </div>
                `,
                'questions': `
                    <div class="filter-group">
                        <label>Search:</label>
                        <input type="text" id="search-questions" class="form-input" placeholder="Search by question text...">
                    </div>
                    <div class="filter-group">
                        <label>Category:</label>
                        <select id="category-filter" class="form-select">
                            <option value="">All Categories</option>
                            ${getUniqueValues(questions, 'category').map(category => `<option value="${category}">${category}</option>`).join('')}
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Times Asked:</label>
                        <input type="number" id="times-asked-min" class="form-input" placeholder="Min" min="0">
                    </div>
                    <div class="filter-group">
                        <label>Success Rate:</label>
                        <input type="number" id="success-rate-min" class="form-input" placeholder="Min %" min="0" max="100">
                    </div>
                `,
                'sessions': `
                    <div class="filter-group">
                        <label>Search:</label>
                        <input type="text" id="search-sessions" class="form-input" placeholder="Search by session name...">
                    </div>
                    <div class="filter-group">
                        <label>Status:</label>
                        <select id="session-status-filter" class="form-select">
                            <option value="">All Statuses</option>
                            ${getUniqueValues(sessions, 'status').map(status => `<option value="${status}">${status}</option>`).join('')}
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Date From:</label>
                        <input type="date" id="session-date-from" class="form-input">
                    </div>
                    <div class="filter-group">
                        <label>Date To:</label>
                        <input type="date" id="session-date-to" class="form-input">
                    </div>
                `,
                'students': `
                    <div class="filter-group">
                        <label>Search:</label>
                        <input type="text" id="search-students" class="form-input" placeholder="Search by name, email, or Zeta ID...">
                    </div>
                    <div class="filter-group">
                        <label>Zeta ID:</label>
                        <input type="text" id="zeta-id-filter" class="form-input" placeholder="Zeta ID">
                    </div>
                    <div class="filter-group">
                        <label>Email Domain:</label>
                        <input type="text" id="email-domain-filter" class="form-input" placeholder="e.g., gmail.com">
                    </div>
                    <div class="filter-group">
                        <label>Created From:</label>
                        <input type="date" id="student-date-from" class="form-input">
                    </div>
                    <div class="filter-group">
                        <label>Created To:</label>
                        <input type="date" id="student-date-to" class="form-input">
                    </div>
                `,
                'my-interviews': `
                    <div class="filter-group">
                        <label>Search:</label>
                        <input type="text" id="search-my-interviews" class="form-input" placeholder="Search by student name, email, or Zeta ID...">
                    </div>
                    <div class="filter-group">
                        <label>Status:</label>
                        <select id="my-status-filter" class="form-select">
                            <option value="">All Statuses</option>
                            ${getUniqueValues(myInterviews, 'status').map(status => `<option value="${status}">${status}</option>`).join('')}
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Verdict:</label>
                        <select id="my-verdict-filter" class="form-select">
                            <option value="">All Verdicts</option>
                            ${getUniqueValues(myInterviews, 'verdict').map(verdict => `<option value="${verdict}">${verdict}</option>`).join('')}
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Session:</label>
                        <select id="my-session-filter" class="form-select">
                            <option value="">All Sessions</option>
                            ${getUniqueValues(myInterviews, 'session_name').map(name => `<option value="${name}">${name}</option>`).join('')}
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Date From:</label>
                        <input type="date" id="my-date-from" class="form-input">
                    </div>
                    <div class="filter-group">
                        <label>Date To:</label>
                        <input type="date" id="my-date-to" class="form-input">
                    </div>
                `,
                'users': `
                    <div class="filter-group">
                        <label>Search:</label>
                        <input type="text" id="search-users" class="form-input" placeholder="Search by name or email...">
                    </div>
                    <div class="filter-group">
                        <label>Role:</label>
                        <select id="role-filter" class="form-select">
                            <option value="">All Roles</option>
                            ${getUniqueValues(users, 'role').map(role => `<option value="${role}">${role}</option>`).join('')}
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Status:</label>
                        <select id="user-status-filter" class="form-select">
                            <option value="">All Statuses</option>
                            <option value="active">Active</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Created From:</label>
                        <input type="date" id="user-date-from" class="form-input">
                    </div>
                    <div class="filter-group">
                        <label>Created To:</label>
                        <input type="date" id="user-date-to" class="form-input">
                    </div>
                `
            };
            
            return filterConfigs[tab] || '';
        }

        function generateSortOptions(tab) {
            const sortConfigs = {
                'interviews': `
                    <div class="sort-option">
                        <label>Sort by:</label>
                        <select id="sort-by" class="form-select" onchange="applyFilters('interviews')">
                            <option value="created_at_desc">Date (Newest First)</option>
                            <option value="created_at_asc">Date (Oldest First)</option>
                            <option value="student_name_asc">Student Name (A-Z)</option>
                            <option value="student_name_desc">Student Name (Z-A)</option>
                            <option value="student_email_asc">Student Email (A-Z)</option>
                            <option value="student_email_desc">Student Email (Z-A)</option>
                            <option value="zeta_id_asc">Zeta ID (A-Z)</option>
                            <option value="zeta_id_desc">Zeta ID (Z-A)</option>
                            <option value="status_asc">Status (A-Z)</option>
                            <option value="status_desc">Status (Z-A)</option>
                            <option value="verdict_asc">Verdict (A-Z)</option>
                            <option value="verdict_desc">Verdict (Z-A)</option>
                            <option value="interviewer_name_asc">Interviewer (A-Z)</option>
                            <option value="interviewer_name_desc">Interviewer (Z-A)</option>
                        </select>
                    </div>
                `,
                'questions': `
                    <div class="sort-option">
                        <label>Sort by:</label>
                        <select id="sort-by" class="form-select" onchange="applyFilters('questions')">
                            <option value="question_text_asc">Question (A-Z)</option>
                            <option value="question_text_desc">Question (Z-A)</option>
                            <option value="category_asc">Category (A-Z)</option>
                            <option value="category_desc">Category (Z-A)</option>
                            <option value="times_asked_desc">Times Asked (Most)</option>
                            <option value="times_asked_asc">Times Asked (Least)</option>
                            <option value="times_answered_correctly_desc">Correct Answers (Most)</option>
                            <option value="times_answered_correctly_asc">Correct Answers (Least)</option>
                            <option value="times_answered_incorrectly_desc">Incorrect Answers (Most)</option>
                            <option value="times_answered_incorrectly_asc">Incorrect Answers (Least)</option>
                            <option value="success_rate_desc">Success Rate (Highest)</option>
                            <option value="success_rate_asc">Success Rate (Lowest)</option>
                            <option value="created_at_desc">Date Added (Newest)</option>
                            <option value="created_at_asc">Date Added (Oldest)</option>
                        </select>
                    </div>
                `,
                'sessions': `
                    <div class="sort-option">
                        <label>Sort by:</label>
                        <select id="sort-by" class="form-select" onchange="applyFilters('sessions')">
                            <option value="created_at_desc">Date Created (Newest)</option>
                            <option value="created_at_asc">Date Created (Oldest)</option>
                            <option value="name_asc">Session Name (A-Z)</option>
                            <option value="name_desc">Session Name (Z-A)</option>
                            <option value="description_asc">Description (A-Z)</option>
                            <option value="description_desc">Description (Z-A)</option>
                            <option value="status_asc">Status (A-Z)</option>
                            <option value="status_desc">Status (Z-A)</option>
                        </select>
                    </div>
                `,
                'students': `
                    <div class="sort-option">
                        <label>Sort by:</label>
                        <select id="sort-by" class="form-select" onchange="applyFilters('students')">
                            <option value="created_at_desc">Date Created (Newest)</option>
                            <option value="created_at_asc">Date Created (Oldest)</option>
                            <option value="first_name_asc">First Name (A-Z)</option>
                            <option value="first_name_desc">First Name (Z-A)</option>
                            <option value="last_name_asc">Last Name (A-Z)</option>
                            <option value="last_name_desc">Last Name (Z-A)</option>
                            <option value="email_asc">Email (A-Z)</option>
                            <option value="email_desc">Email (Z-A)</option>
                            <option value="zeta_id_asc">Zeta ID (A-Z)</option>
                            <option value="zeta_id_desc">Zeta ID (Z-A)</option>
                            <option value="phone_asc">Phone (A-Z)</option>
                            <option value="phone_desc">Phone (Z-A)</option>
                        </select>
                    </div>
                `,
                'my-interviews': `
                    <div class="sort-option">
                        <label>Sort by:</label>
                        <select id="sort-by" class="form-select" onchange="applyFilters('my-interviews')">
                            <option value="created_at_desc">Date (Newest First)</option>
                            <option value="created_at_asc">Date (Oldest First)</option>
                            <option value="student_name_asc">Student Name (A-Z)</option>
                            <option value="student_name_desc">Student Name (Z-A)</option>
                            <option value="student_email_asc">Student Email (A-Z)</option>
                            <option value="student_email_desc">Student Email (Z-A)</option>
                            <option value="zeta_id_asc">Zeta ID (A-Z)</option>
                            <option value="zeta_id_desc">Zeta ID (Z-A)</option>
                            <option value="status_asc">Status (A-Z)</option>
                            <option value="status_desc">Status (Z-A)</option>
                            <option value="verdict_asc">Verdict (A-Z)</option>
                            <option value="verdict_desc">Verdict (Z-A)</option>
                        </select>
                    </div>
                `,
                'users': `
                    <div class="sort-option">
                        <label>Sort by:</label>
                        <select id="sort-by" class="form-select" onchange="applyFilters('users')">
                            <option value="created_at_desc">Date Created (Newest)</option>
                            <option value="created_at_asc">Date Created (Oldest)</option>
                            <option value="name_asc">Name (A-Z)</option>
                            <option value="name_desc">Name (Z-A)</option>
                            <option value="email_asc">Email (A-Z)</option>
                            <option value="email_desc">Email (Z-A)</option>
                            <option value="role_asc">Role (A-Z)</option>
                            <option value="role_desc">Role (Z-A)</option>
                            <option value="updated_at_desc">Last Updated (Newest)</option>
                            <option value="updated_at_asc">Last Updated (Oldest)</option>
                        </select>
                    </div>
                `
            };
            
            return sortConfigs[tab] || '';
        }

        function generateGroupByOptions(tab) {
            const groupConfigs = {
                'interviews': `
                    <div class="group-by-option">
                        <input type="radio" id="group-none" name="group-by" value="" checked onchange="applyFilters('interviews')">
                        <label for="group-none">No Grouping</label>
                    </div>
                    <div class="group-by-option">
                        <input type="radio" id="group-status" name="group-by" value="status" onchange="applyFilters('interviews')">
                        <label for="group-status">By Status</label>
                    </div>
                    <div class="group-by-option">
                        <input type="radio" id="group-verdict" name="group-by" value="verdict" onchange="applyFilters('interviews')">
                        <label for="group-verdict">By Verdict</label>
                    </div>
                    <div class="group-by-option">
                        <input type="radio" id="group-interviewer" name="group-by" value="interviewer" onchange="applyFilters('interviews')">
                        <label for="group-interviewer">By Interviewer</label>
                    </div>
                    <div class="group-by-option">
                        <input type="radio" id="group-date" name="group-by" value="date" onchange="applyFilters('interviews')">
                        <label for="group-date">By Date</label>
                    </div>
                `,
                'questions': `
                    <div class="group-by-option">
                        <input type="radio" id="group-none" name="group-by" value="" checked onchange="applyFilters('questions')">
                        <label for="group-none">No Grouping</label>
                    </div>
                    <div class="group-by-option">
                        <input type="radio" id="group-category" name="group-by" value="category" onchange="applyFilters('questions')">
                        <label for="group-category">By Category</label>
                    </div>
                    <div class="group-by-option">
                        <input type="radio" id="group-times-asked" name="group-by" value="times_asked" onchange="applyFilters('questions')">
                        <label for="group-times-asked">By Times Asked</label>
                    </div>
                `,
                'sessions': `
                    <div class="group-by-option">
                        <input type="radio" id="group-none" name="group-by" value="" checked onchange="applyFilters('sessions')">
                        <label for="group-none">No Grouping</label>
                    </div>
                `,
                'students': `
                    <div class="group-by-option">
                        <input type="radio" id="group-none" name="group-by" value="" checked onchange="applyFilters('students')">
                        <label for="group-none">No Grouping</label>
                    </div>
                `,
                'my-interviews': `
                    <div class="group-by-option">
                        <input type="radio" id="group-none" name="group-by" value="" checked onchange="applyFilters('my-interviews')">
                        <label for="group-none">No Grouping</label>
                    </div>
                    <div class="group-by-option">
                        <input type="radio" id="group-status" name="group-by" value="status" onchange="applyFilters('my-interviews')">
                        <label for="group-status">By Status</label>
                    </div>
                    <div class="group-by-option">
                        <input type="radio" id="group-verdict" name="group-by" value="verdict" onchange="applyFilters('my-interviews')">
                        <label for="group-verdict">By Verdict</label>
                    </div>
                    <div class="group-by-option">
                        <input type="radio" id="group-date" name="group-by" value="created_date" onchange="applyFilters('my-interviews')">
                        <label for="group-date">By Date</label>
                    </div>
                `,
                'users': `
                    <div class="group-by-option">
                        <input type="radio" id="group-none" name="group-by" value="" checked onchange="applyFilters('users')">
                        <label for="group-none">No Grouping</label>
                    </div>
                    <div class="group-by-option">
                        <input type="radio" id="group-role" name="group-by" value="role" onchange="applyFilters('users')">
                        <label for="group-role">By Role</label>
                    </div>
                    <div class="group-by-option">
                        <input type="radio" id="group-status" name="group-by" value="status" onchange="applyFilters('users')">
                        <label for="group-status">By Status</label>
                    </div>
                    <div class="group-by-option">
                        <input type="radio" id="group-date" name="group-by" value="created_date" onchange="applyFilters('users')">
                        <label for="group-date">By Creation Date</label>
                    </div>
                `
            };
            
            return groupConfigs[tab] || '';
        }

        function closeFilterPanel() {
            document.getElementById('filter-panel').classList.remove('active');
            document.getElementById('filter-panel-overlay').classList.remove('active');
        }

        // Helper function to get unique values from an array of objects
        function getUniqueValues(data, field) {
            if (!data || !Array.isArray(data)) return [];
            const values = data.map(item => item[field]).filter(value => value !== null && value !== undefined && value !== '');
            return [...new Set(values)].sort();
        }

        // Function to populate filter dropdowns with actual database values
        function populateFilterDropdowns() {
            // This function will be called after data is loaded to update filter dropdowns
            // The generateFilterFields function now uses dynamic data
        }

        // Function to add event listeners to filter inputs
        function addFilterEventListeners(tab) {
            // Add event listeners to search inputs
            const searchInputs = document.querySelectorAll('input[type="text"]');
            searchInputs.forEach(input => {
                input.addEventListener('keyup', () => applyFilters(tab));
            });

            // Add event listeners to select dropdowns
            const selectInputs = document.querySelectorAll('select');
            selectInputs.forEach(select => {
                select.addEventListener('change', () => applyFilters(tab));
            });

            // Add event listeners to date inputs
            const dateInputs = document.querySelectorAll('input[type="date"]');
            dateInputs.forEach(input => {
                input.addEventListener('change', () => applyFilters(tab));
            });

            // Add event listeners to number inputs
            const numberInputs = document.querySelectorAll('input[type="number"]');
            numberInputs.forEach(input => {
                input.addEventListener('change', () => applyFilters(tab));
            });

            // Add event listeners to radio buttons
            const radioInputs = document.querySelectorAll('input[type="radio"]');
            radioInputs.forEach(input => {
                input.addEventListener('change', () => applyFilters(tab));
            });
        }

        // NEW UNIFIED FILTER SYSTEM
        function applyUnifiedFilters(tab, data) {
            console.log(`Applying unified filters for tab: ${tab}`);
            
            if (!data || !Array.isArray(data)) {
                console.warn('No data provided for filtering');
                return [];
            }
            
            let filtered = [...data];
            
            // Get filter values safely
            const getFilterValue = (id) => {
                const element = document.getElementById(id);
                return element ? element.value : '';
            };
            
            const getRadioValue = (name) => {
                const element = document.querySelector(`input[name="${name}"]:checked`);
                return element ? element.value : '';
            };
            
            switch(tab) {
                case 'interviews':
                    // Search filter
                    const searchTerm = getFilterValue('search-interviews');
                    if (searchTerm) {
                        filtered = filtered.filter(i => 
                            (i.student_name && i.student_name.toLowerCase().includes(searchTerm.toLowerCase())) ||
                            (i.student_email && i.student_email.toLowerCase().includes(searchTerm.toLowerCase())) ||
                            (i.zeta_id && i.zeta_id.toLowerCase().includes(searchTerm.toLowerCase())) ||
                            (i.interviewer_name && i.interviewer_name.toLowerCase().includes(searchTerm.toLowerCase()))
                        );
                    }
                    
                    // Status filter
                    const status = getFilterValue('status-filter');
                    if (status) {
                        filtered = filtered.filter(i => i.status === status);
                    }
                    
                    // Verdict filter
                    const verdict = getFilterValue('verdict-filter');
                    if (verdict) {
                        filtered = filtered.filter(i => i.verdict === verdict);
                    }

                    // Session filter
                    const sessionName = getFilterValue('session-filter');
                    if (sessionName) {
                        filtered = filtered.filter(i => (i.session_name || '') === sessionName);
                    }
                    
                    // Date filters
                    const dateFrom = getFilterValue('date-from');
                    const dateTo = getFilterValue('date-to');
                    if (dateFrom) {
                        filtered = filtered.filter(i => new Date(i.created_at || i.interview_date) >= new Date(dateFrom));
                    }
                    if (dateTo) {
                        filtered = filtered.filter(i => new Date(i.created_at || i.interview_date) <= new Date(dateTo));
                    }
                    
                    // Sort
                    const sortBy = getFilterValue('sort-by') || 'created_at_desc';
                    filtered = sortInterviews(filtered, sortBy);
                    break;
                    
                case 'questions':
                    // Search filter
                    const questionSearch = getFilterValue('search-questions');
                    if (questionSearch) {
                        filtered = filtered.filter(q => 
                            q.question_text && q.question_text.toLowerCase().includes(questionSearch.toLowerCase())
                        );
                    }
                    
                    // Category filter
                    const category = getFilterValue('category-filter');
                    if (category) {
                        filtered = filtered.filter(q => q.category === category);
                    }
                    
                    // Times asked filter
                    const timesAskedMin = getFilterValue('times-asked-min');
                    if (timesAskedMin) {
                        filtered = filtered.filter(q => (q.times_asked || 0) >= parseInt(timesAskedMin));
                    }
                    
                    // Success rate filter
                    const successRateMin = getFilterValue('success-rate-min');
                    if (successRateMin) {
                        filtered = filtered.filter(q => (q.success_rate || 0) >= parseInt(successRateMin));
                    }
                    
                    // Sort
                    const questionSortBy = getFilterValue('sort-by') || 'question_text_asc';
                    filtered = sortQuestions(filtered, questionSortBy);
                    break;
                    
                case 'sessions':
                    // Search filter
                    const sessionSearch = getFilterValue('search-sessions');
                    if (sessionSearch) {
                        filtered = filtered.filter(s => 
                            s.session_name && s.session_name.toLowerCase().includes(sessionSearch.toLowerCase())
                        );
                    }
                    
                    // Status filter
                    const sessionStatus = getFilterValue('session-status-filter');
                    if (sessionStatus) {
                        filtered = filtered.filter(s => s.status === sessionStatus);
                    }
                    
                    // Date filters
                    const sessionDateFrom = getFilterValue('session-date-from');
                    const sessionDateTo = getFilterValue('session-date-to');
                    if (sessionDateFrom) {
                        filtered = filtered.filter(s => new Date(s.created_at) >= new Date(sessionDateFrom));
                    }
                    if (sessionDateTo) {
                        filtered = filtered.filter(s => new Date(s.created_at) <= new Date(sessionDateTo));
                    }
                    
                    // Sort
                    const sessionSortBy = getFilterValue('sort-by') || 'created_at_desc';
                    filtered = sortSessions(filtered, sessionSortBy);
                    break;
                    
                case 'students':
                    // Search filter
                    const studentSearch = getFilterValue('search-students');
                    if (studentSearch) {
                        filtered = filtered.filter(s => 
                            (s.first_name && s.first_name.toLowerCase().includes(studentSearch.toLowerCase())) ||
                            (s.last_name && s.last_name.toLowerCase().includes(studentSearch.toLowerCase())) ||
                            (s.email && s.email.toLowerCase().includes(studentSearch.toLowerCase())) ||
                            (s.zeta_id && s.zeta_id.toLowerCase().includes(studentSearch.toLowerCase()))
                        );
                    }
                    
                    // Zeta ID filter
                    const zetaIdFilter = getFilterValue('zeta-id-filter');
                    if (zetaIdFilter) {
                        filtered = filtered.filter(s => (s.zeta_id || '').toLowerCase().includes(zetaIdFilter.toLowerCase()));
                    }

                    // Email domain filter
                    const emailDomainFilter = getFilterValue('email-domain-filter');
                    if (emailDomainFilter) {
                        filtered = filtered.filter(s => (s.email || '').toLowerCase().endsWith(emailDomainFilter.toLowerCase()));
                    }

                    // Date filters
                    const studentDateFrom = getFilterValue('student-date-from');
                    const studentDateTo = getFilterValue('student-date-to');
                    if (studentDateFrom) {
                        filtered = filtered.filter(s => new Date(s.created_at) >= new Date(studentDateFrom));
                    }
                    if (studentDateTo) {
                        filtered = filtered.filter(s => new Date(s.created_at) <= new Date(studentDateTo));
                    }
                    
                    // Sort
                    const studentSortBy = getFilterValue('sort-by') || 'created_at_desc';
                    filtered = sortStudents(filtered, studentSortBy);
                    break;
                    
                case 'my-interviews':
                    // Search filter
                    const mySearchTerm = getFilterValue('search-my-interviews');
                    if (mySearchTerm) {
                        filtered = filtered.filter(i => 
                            (i.student_name && i.student_name.toLowerCase().includes(mySearchTerm.toLowerCase())) ||
                            (i.student_email && i.student_email.toLowerCase().includes(mySearchTerm.toLowerCase())) ||
                            (i.zeta_id && i.zeta_id.toLowerCase().includes(mySearchTerm.toLowerCase()))
                        );
                    }
                    
                    // Status filter
                    const myStatus = getFilterValue('my-status-filter');
                    if (myStatus) {
                        filtered = filtered.filter(i => i.status === myStatus);
                    }
                    
                    // Verdict filter
                    const myVerdict = getFilterValue('my-verdict-filter');
                    if (myVerdict) {
                        filtered = filtered.filter(i => i.verdict === myVerdict);
                    }
                    
                    // Date filters
                    const myDateFrom = getFilterValue('my-date-from');
                    const myDateTo = getFilterValue('my-date-to');
                    if (myDateFrom) {
                        filtered = filtered.filter(i => new Date(i.created_at) >= new Date(myDateFrom));
                    }
                    if (myDateTo) {
                        filtered = filtered.filter(i => new Date(i.created_at) <= new Date(myDateTo));
                    }
                    
                    // Sort
                    const mySortBy = getFilterValue('sort-by') || 'created_at_desc';
                    filtered = sortMyInterviews(filtered, mySortBy);
                    break;
                    
                case 'users':
                    // Search filter
                    const userSearch = getFilterValue('search-users');
                    if (userSearch) {
                        filtered = filtered.filter(u => 
                            (u.name && u.name.toLowerCase().includes(userSearch.toLowerCase())) ||
                            (u.email && u.email.toLowerCase().includes(userSearch.toLowerCase()))
                        );
                    }
                    
                    // Role filter
                    const role = getFilterValue('role-filter');
                    if (role) {
                        filtered = filtered.filter(u => u.role === role);
                    }
                    
                    // Status filter
                    const userStatus = getFilterValue('user-status-filter');
                    if (userStatus) {
                        filtered = filtered.filter(u => u.status === userStatus);
                    }
                    
                    // Date filters
                    const userDateFrom = getFilterValue('user-date-from');
                    const userDateTo = getFilterValue('user-date-to');
                    if (userDateFrom) {
                        filtered = filtered.filter(u => new Date(u.created_at) >= new Date(userDateFrom));
                    }
                    if (userDateTo) {
                        filtered = filtered.filter(u => new Date(u.created_at) <= new Date(userDateTo));
                    }
                    
                    // Sort
                    const userSortBy = getFilterValue('sort-by') || 'created_at_desc';
                    filtered = sortUsers(filtered, userSortBy);
                    break;
            }
            
            return filtered;
        }

        // Dynamic filter functions
        function applyFilters(tab, closePanel = false) {
            console.log(`Applying filters for tab: ${tab}`);
            
            // Get group by value
            const getRadioValue = (name) => {
                const element = document.querySelector(`input[name="${name}"]:checked`);
                return element ? element.value : '';
            };
            const groupBy = getRadioValue('group-by');
            
            // Use the new unified system
            let filteredData = [];
            let displayFunction = null;
            
            switch(tab) {
                case 'interviews':
                    filteredData = applyUnifiedFilters('interviews', interviews);
                    displayFunction = () => displayRegularInterviews(filteredData, document.getElementById('interviews-table-body'), groupBy);
                    break;
                case 'questions':
                    filteredData = applyUnifiedFilters('questions', questions);
                    displayFunction = () => displayQuestions(filteredData, groupBy);
                    break;
                case 'sessions':
                    filteredData = applyUnifiedFilters('sessions', sessions);
                    displayFunction = () => displaySessions(filteredData, groupBy);
                    break;
                case 'students':
                    filteredData = applyUnifiedFilters('students', students);
                    displayFunction = () => displayStudents(filteredData, groupBy);
                    break;
                case 'my-interviews':
                    filteredData = applyUnifiedFilters('my-interviews', myInterviews);
                    displayFunction = () => displayMyInterviews(filteredData, groupBy);
                    break;
                case 'users':
                    filteredData = applyUnifiedFilters('users', users);
                    displayFunction = () => displayUsers(filteredData, groupBy);
                    break;
                default:
                    console.log('Unknown tab:', tab);
                    return;
            }
            
            // Display the filtered results
            if (displayFunction) {
                displayFunction();
            }
            
            // Only close panel if explicitly requested (from Apply button)
            if (closePanel) {
                closeFilterPanel();
            }
        }

        function clearAllFilters(tab) {
            console.log(`Clearing filters for tab: ${tab}`);
            
            // Clear all filter inputs in the current filter panel
            const filterPanel = document.getElementById('filter-panel');
            const inputs = filterPanel.querySelectorAll('input, select');
            inputs.forEach(input => {
                if (input.type === 'radio') {
                    if (input.value === '') {
                        input.checked = true;
                    } else {
                        input.checked = false;
                    }
                } else {
                    input.value = '';
                }
            });
            
            // Apply the cleared filters
            applyFilters(tab);
        }

        function exportData(tab) {
            console.log(`Exporting data for tab: ${tab}`);
            
            switch(tab) {
                case 'interviews':
                    exportInterviews();
                    break;
                case 'questions':
                    exportQuestions();
                    break;
                case 'sessions':
                    exportSessions();
                    break;
                case 'students':
                    exportStudents();
                    break;
                case 'my-interviews':
                    exportMyInterviews();
                    break;
                case 'users':
                    exportUsers();
                    break;
                default:
                    console.log('Unknown tab:', tab);
            }
        }

        // REMOVED: Old conflicting filter functions - replaced with unified system

        // Grouping functions
        function groupQuestions(questions, groupBy) {
            if (!groupBy || groupBy === 'none') {
                return { questions };
            }
            
            const groups = {};
            questions.forEach(question => {
                let groupKey = '';
                switch (groupBy) {
                    case 'category':
                        groupKey = question.category || 'Uncategorized';
                        break;
                    case 'times_asked':
                        const timesAsked = question.times_asked || 0;
                        if (timesAsked === 0) groupKey = 'Never Asked';
                        else if (timesAsked <= 5) groupKey = '1-5 Times';
                        else if (timesAsked <= 10) groupKey = '6-10 Times';
                        else groupKey = '10+ Times';
                        break;
                    default:
                        groupKey = 'All Questions';
                }
                
                if (!groups[groupKey]) {
                    groups[groupKey] = [];
                }
                groups[groupKey].push(question);
            });
            
            return { groups, questions };
        }

        function groupSessions(sessions, groupBy) {
            if (!groupBy || groupBy === 'none') {
                return { sessions };
            }
            
            const groups = {};
            sessions.forEach(session => {
                let groupKey = '';
                switch (groupBy) {
                    case 'status':
                        groupKey = session.status || 'Unknown';
                        break;
                    case 'created_date':
                        groupKey = formatDate(session.created_at);
                        break;
                    default:
                        groupKey = 'All Sessions';
                }
                
                if (!groups[groupKey]) {
                    groups[groupKey] = [];
                }
                groups[groupKey].push(session);
            });
            
            return { groups, sessions };
        }

        function groupStudents(students, groupBy) {
            if (!groupBy || groupBy === 'none') {
                return { students };
            }
            
            const groups = {};
            students.forEach(student => {
                let groupKey = '';
                switch (groupBy) {
                    case 'created_date':
                        groupKey = formatDate(student.created_at);
                        break;
                    default:
                        groupKey = 'All Students';
                }
                
                if (!groups[groupKey]) {
                    groups[groupKey] = [];
                }
                groups[groupKey].push(student);
            });
            
            return { groups, students };
        }

        // Display grouped data functions
        function displayGroupedQuestions(groupedData, tbody) {
            if (groupedData.groups) {
                tbody.innerHTML = Object.entries(groupedData.groups).map(([groupName, groupQuestions]) => `
                    <tr class="group-header">
                        <td colspan="8" class="group-title">${groupName} (${groupQuestions.length})</td>
                    </tr>
                    ${groupQuestions.map(question => generateQuestionRow(question)).join('')}
                `).join('');
            } else {
                tbody.innerHTML = groupedData.questions.map(question => generateQuestionRow(question)).join('');
            }
        }

        function displayGroupedSessions(groupedData, tbody) {
            if (groupedData.groups) {
                tbody.innerHTML = Object.entries(groupedData.groups).map(([groupName, groupSessions]) => `
                    <tr class="group-header">
                        <td colspan="8" class="group-title">${groupName} (${groupSessions.length})</td>
                    </tr>
                    ${groupSessions.map(session => generateSessionRow(session)).join('')}
                `).join('');
            } else {
                tbody.innerHTML = groupedData.sessions.map(session => generateSessionRow(session)).join('');
            }
        }

        function displayGroupedStudents(groupedData, tbody) {
            if (groupedData.groups) {
                tbody.innerHTML = Object.entries(groupedData.groups).map(([groupName, groupStudents]) => `
                    <tr class="group-header">
                        <td colspan="8" class="group-title">${groupName} (${groupStudents.length})</td>
                    </tr>
                    ${groupStudents.map(student => generateStudentRow(student)).join('')}
                `).join('');
            } else {
                tbody.innerHTML = groupedData.students.map(student => generateStudentRow(student)).join('');
            }
        }

        // Helper functions to generate rows
        function generateQuestionRow(question) {
            return `
                <tr data-row-id="${question.id}">
                    <td><input type="checkbox" class="row-checkbox" data-row-id="${question.id}" onchange="toggleRowSelection('${question.id}')"></td>
                    <td data-field="question">
                        <span>${question.question || 'N/A'}</span>
                        <button class="icon-btn edit-btn" onclick="startEdit('${question.id}', 'questions')" title="Edit">‚úèÔ∏è</button>
                    </td>
                    <td data-field="category">${question.category || 'N/A'}</td>
                    <td data-field="times_asked">${question.times_asked || 0}</td>
                    <td data-field="times_answered_correctly">${question.times_answered_correctly || 0}</td>
                    <td data-field="times_answered_incorrectly">${question.times_answered_incorrectly || 0}</td>
                    <td data-field="success_rate">${question.success_rate || 0}%</td>
                    <td>
                        <button class="icon-btn favorite-btn ${favoriteQuestionIds.has(question.id) ? 'favorited' : ''}" 
                                onclick="toggleFavorite('${question.id}')" title="Toggle Favorite">
                            ${favoriteQuestionIds.has(question.id) ? '‚≠ê' : '‚òÜ'}
                        </button>
                        <button class="icon-btn view-btn" onclick="viewQuestion('${question.id}')" title="View">üëÅÔ∏è</button>
                        <button class="icon-btn delete-btn" onclick="deleteQuestion('${question.id}')" title="Delete">üóëÔ∏è</button>
                    </td>
                </tr>
            `;
        }

        function generateSessionRow(session) {
            return `
                <tr data-row-id="${session.id}">
                    <td><input type="checkbox" class="row-checkbox" data-row-id="${session.id}" onchange="toggleRowSelection('${session.id}')"></td>
                    <td data-field="id">${session.id}</td>
                    <td data-field="name">${session.name}</td>
                    <td data-field="description">${session.description || 'N/A'}</td>
                    <td data-field="status"><span class="status-badge status-${session.status}">${session.status}</span></td>
                    <td data-field="panelists">${session.panelist_names || '‚Äî'}</td>
                    <td data-field="created_at">${formatDate(session.created_at)}</td>
                    <td>
                        <button class="icon-btn edit-btn" onclick="startEdit('${session.id}', 'sessions')" title="Edit">‚úèÔ∏è</button>
                        <button class="icon-btn view-btn" onclick="viewSession('${session.id}')" title="View">üëÅÔ∏è</button>
                        <button class="icon-btn delete-btn" onclick="deleteSession('${session.id}')" title="Delete">üóëÔ∏è</button>
                    </td>
                </tr>
            `;
        }

        function generateStudentRow(student) {
            return `
                <tr data-row-id="${student.id}">
                    <td><input type="checkbox" class="row-checkbox" data-row-id="${student.id}" onchange="toggleRowSelection('${student.id}')"></td>
                    <td data-field="id">${student.id}</td>
                    <td data-field="name">${student.name}</td>
                    <td data-field="email">${student.email}</td>
                    <td data-field="zeta_id">${student.zeta_id}</td>
                    <td data-field="phone">${student.phone || 'N/A'}</td>
                    <td data-field="created_at">${formatDate(student.created_at)}</td>
                    <td>
                        <button class="icon-btn edit-btn" onclick="startEdit('${student.id}', 'students')" title="Edit">‚úèÔ∏è</button>
                        <button class="icon-btn view-btn" onclick="viewStudent('${student.id}')" title="View">üëÅÔ∏è</button>
                        <button class="icon-btn delete-btn" onclick="deleteStudent('${student.id}')" title="Delete">üóëÔ∏è</button>
                    </td>
                </tr>
            `;
        }

        function sortInterviews(interviews, sortBy) {
            return interviews.sort((a, b) => {
                const [field, direction] = sortBy.split('_');
                let aVal, bVal;
                
                if (field === 'student_name') {
                    aVal = a.student_name;
                    bVal = b.student_name;
                } else if (field === 'created_at') {
                    aVal = new Date(a.created_at);
                    bVal = new Date(b.created_at);
                } else if (field === 'status') {
                    aVal = a.status;
                    bVal = b.status;
                } else if (field === 'verdict') {
                    aVal = a.verdict;
                    bVal = b.verdict;
                } else {
                    aVal = a[field];
                    bVal = b[field];
                }
                
                if (direction === 'asc') {
                    return aVal > bVal ? 1 : -1;
                } else {
                    return aVal < bVal ? 1 : -1;
                }
            });
        }

        function groupInterviews(interviews, groupBy) {
            if (!groupBy) return interviews;
            
            const groups = {};
            interviews.forEach(interview => {
                let key;
                if (groupBy === 'status') {
                    key = interview.status || 'Unknown';
                } else if (groupBy === 'verdict') {
                    key = interview.verdict || 'Unknown';
                } else if (groupBy === 'date') {
                    key = new Date(interview.created_at).toLocaleDateString();
                } else {
                    key = 'All';
                }
                
                if (!groups[key]) {
                    groups[key] = [];
                }
                groups[key].push(interview);
            });
            
            return { groups };
        }

        function applyQuestionsFilters() {
            const searchTerm = document.getElementById('search-questions')?.value || '';
            const category = document.getElementById('category-filter')?.value || '';
            const timesAskedMin = document.getElementById('times-asked-min')?.value || '';
            const successRateMin = document.getElementById('success-rate-min')?.value || '';
            const sortBy = document.getElementById('sort-by')?.value || 'times_asked_desc';
            const groupBy = document.querySelector('input[name="group-by"]:checked')?.value || '';

            console.log('Questions filters:', { searchTerm, category, timesAskedMin, successRateMin, sortBy, groupBy });
            
            // Apply filters to questions data
            let filteredQuestions = [...questions];
            
            // Search filter
            if (searchTerm) {
                filteredQuestions = filteredQuestions.filter(q => 
                    q.question.toLowerCase().includes(searchTerm.toLowerCase())
                );
            }
            
            // Category filter
            if (category) {
                filteredQuestions = filteredQuestions.filter(q => q.category === category);
            }
            
            // Times asked filter
            if (timesAskedMin) {
                filteredQuestions = filteredQuestions.filter(q => q.times_asked >= parseInt(timesAskedMin));
            }
            
            // Success rate filter
            if (successRateMin) {
                filteredQuestions = filteredQuestions.filter(q => q.success_rate >= parseInt(successRateMin));
            }
            
            // Sort
            filteredQuestions = sortQuestions(filteredQuestions, sortBy);
            
            // Display filtered results
            displayQuestions(filteredQuestions, groupBy);
        }

        function applySessionsFilters() {
            const searchTerm = document.getElementById('search-sessions')?.value || '';
            const status = document.getElementById('session-status-filter')?.value || '';
            const dateFrom = document.getElementById('session-date-from')?.value || '';
            const dateTo = document.getElementById('session-date-to')?.value || '';
            const sortBy = document.getElementById('sort-by')?.value || 'created_at_desc';
            const groupBy = document.querySelector('input[name="group-by"]:checked')?.value || '';

            console.log('Sessions filters:', { searchTerm, status, dateFrom, dateTo, sortBy, groupBy });
            
            // Apply filters to sessions data
            let filteredSessions = [...sessions];
            
            // Search filter
            if (searchTerm) {
                filteredSessions = filteredSessions.filter(s => 
                    s.session_name.toLowerCase().includes(searchTerm.toLowerCase())
                );
            }
            
            // Status filter
            if (status) {
                filteredSessions = filteredSessions.filter(s => s.status === status);
            }
            
            // Date filters
            if (dateFrom) {
                filteredSessions = filteredSessions.filter(s => new Date(s.created_at) >= new Date(dateFrom));
            }
            if (dateTo) {
                filteredSessions = filteredSessions.filter(s => new Date(s.created_at) <= new Date(dateTo));
            }
            
            // Sort
            filteredSessions = sortSessions(filteredSessions, sortBy);
            
            // Display filtered results
            displaySessions(filteredSessions, groupBy);
        }

        function applyStudentsFilters() {
            const searchTerm = document.getElementById('search-students')?.value || '';
            const zetaId = document.getElementById('zeta-id-filter')?.value || '';
            const emailDomain = document.getElementById('email-domain-filter')?.value || '';
            const dateFrom = document.getElementById('student-date-from')?.value || '';
            const dateTo = document.getElementById('student-date-to')?.value || '';
            const sortBy = document.getElementById('sort-by')?.value || 'first_name_asc';
            const groupBy = document.querySelector('input[name="group-by"]:checked')?.value || '';

            console.log('Students filters:', { searchTerm, zetaId, emailDomain, dateFrom, dateTo, sortBy, groupBy });
            
            // Apply filters to students data
            let filteredStudents = [...students];
            
            // Search filter
            if (searchTerm) {
                filteredStudents = filteredStudents.filter(s => 
                    s.first_name.toLowerCase().includes(searchTerm.toLowerCase()) ||
                    s.last_name.toLowerCase().includes(searchTerm.toLowerCase()) ||
                    s.email.toLowerCase().includes(searchTerm.toLowerCase()) ||
                    s.zeta_id.toLowerCase().includes(searchTerm.toLowerCase())
                );
            }
            
            // Zeta ID filter
            if (zetaId) {
                filteredStudents = filteredStudents.filter(s => s.zeta_id.toLowerCase().includes(zetaId.toLowerCase()));
            }
            
            // Email domain filter
            if (emailDomain) {
                filteredStudents = filteredStudents.filter(s => s.email.includes(emailDomain));
            }
            
            // Date filters
            if (dateFrom) {
                filteredStudents = filteredStudents.filter(s => new Date(s.created_at) >= new Date(dateFrom));
            }
            if (dateTo) {
                filteredStudents = filteredStudents.filter(s => new Date(s.created_at) <= new Date(dateTo));
            }
            
            // Sort
            filteredStudents = sortStudents(filteredStudents, sortBy);
            
            // Display filtered results
            displayStudents(filteredStudents, groupBy);
        }

        function applyMyInterviewsFilters() {
            const searchTerm = document.getElementById('search-my-interviews')?.value || '';
            const status = document.getElementById('my-status-filter')?.value || '';
            const verdict = document.getElementById('my-verdict-filter')?.value || '';
            const sessionName = document.getElementById('my-session-filter')?.value || '';
            const dateFrom = document.getElementById('my-date-from')?.value || '';
            const dateTo = document.getElementById('my-date-to')?.value || '';
            const sortBy = document.getElementById('sort-by')?.value || 'created_at_desc';
            const groupBy = document.querySelector('input[name="group-by"]:checked')?.value || '';

            console.log('My interviews filters:', { searchTerm, status, verdict, dateFrom, dateTo, sortBy, groupBy });
            
            // Apply filters to my interviews data
            let filteredMyInterviews = [...myInterviews];
            
            // Search filter
            if (searchTerm) {
                filteredMyInterviews = filteredMyInterviews.filter(i => 
                    i.student_name.toLowerCase().includes(searchTerm.toLowerCase()) ||
                    i.student_email.toLowerCase().includes(searchTerm.toLowerCase()) ||
                    i.zeta_id.toLowerCase().includes(searchTerm.toLowerCase())
                );
            }
            
            // Status filter
            if (status) {
                filteredMyInterviews = filteredMyInterviews.filter(i => i.status === status);
            }
            
            // Verdict filter
            if (verdict) {
                filteredMyInterviews = filteredMyInterviews.filter(i => i.verdict === verdict);
            }

            // Session filter
            if (sessionName) {
                filteredMyInterviews = filteredMyInterviews.filter(i => (i.session_name || '') === sessionName);
            }
            
            // Date filters
            if (dateFrom) {
                filteredMyInterviews = filteredMyInterviews.filter(i => new Date(i.created_at) >= new Date(dateFrom));
            }
            if (dateTo) {
                filteredMyInterviews = filteredMyInterviews.filter(i => new Date(i.created_at) <= new Date(dateTo));
            }
            
            // Sort
            filteredMyInterviews = sortMyInterviews(filteredMyInterviews, sortBy);
            
            // Display filtered results
            displayMyInterviews(filteredMyInterviews, groupBy);
        }

        function applyUsersFilters() {
            const searchTerm = document.getElementById('search-users')?.value || '';
            const role = document.getElementById('role-filter')?.value || '';
            const status = document.getElementById('user-status-filter')?.value || '';
            const dateFrom = document.getElementById('user-date-from')?.value || '';
            const dateTo = document.getElementById('user-date-to')?.value || '';
            const sortBy = document.getElementById('sort-by')?.value || 'name_asc';
            const groupBy = document.querySelector('input[name="group-by"]:checked')?.value || '';

            console.log('Users filters:', { searchTerm, role, status, dateFrom, dateTo, sortBy, groupBy });
            
            // Apply filters to users data
            let filteredUsers = [...users];
            
            // Search filter
            if (searchTerm) {
                filteredUsers = filteredUsers.filter(u => 
                    u.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
                    u.email.toLowerCase().includes(searchTerm.toLowerCase())
                );
            }
            
            // Role filter
            if (role) {
                filteredUsers = filteredUsers.filter(u => u.role === role);
            }
            
            // Status filter
            if (status) {
                filteredUsers = filteredUsers.filter(u => u.status === status);
            }
            
            // Date filters
            if (dateFrom) {
                filteredUsers = filteredUsers.filter(u => new Date(u.created_at) >= new Date(dateFrom));
            }
            if (dateTo) {
                filteredUsers = filteredUsers.filter(u => new Date(u.created_at) <= new Date(dateTo));
            }
            
            // Sort
            filteredUsers = sortUsers(filteredUsers, sortBy);
            
            // Display filtered results
            displayUsers(filteredUsers, groupBy);
        }

        // Sorting functions
        function sortQuestions(questions, sortBy) {
            return questions.sort((a, b) => {
                const [field, direction] = sortBy.split('_');
                const aVal = a[field];
                const bVal = b[field];
                
                if (direction === 'asc') {
                    return aVal > bVal ? 1 : -1;
                } else {
                    return aVal < bVal ? 1 : -1;
                }
            });
        }

        function sortSessions(sessions, sortBy) {
            return sessions.sort((a, b) => {
                const [field, direction] = sortBy.split('_');
                let aVal, bVal;
                
                if (field === 'session_name') {
                    aVal = a.session_name;
                    bVal = b.session_name;
                } else {
                    aVal = a[field];
                    bVal = b[field];
                }
                
                if (direction === 'asc') {
                    return aVal > bVal ? 1 : -1;
                } else {
                    return aVal < bVal ? 1 : -1;
                }
            });
        }

        function sortStudents(students, sortBy) {
            return students.sort((a, b) => {
                const [field, direction] = sortBy.split('_');
                let aVal, bVal;
                
                if (field === 'first_name') {
                    aVal = a.first_name;
                    bVal = b.first_name;
                } else if (field === 'last_name') {
                    aVal = a.last_name;
                    bVal = b.last_name;
                } else if (field === 'zeta_id') {
                    aVal = a.zeta_id;
                    bVal = b.zeta_id;
                } else if (field === 'email') {
                    aVal = a.email;
                    bVal = b.email;
                } else {
                    aVal = a[field];
                    bVal = b[field];
                }
                
                if (direction === 'asc') {
                    return aVal > bVal ? 1 : -1;
                } else {
                    return aVal < bVal ? 1 : -1;
                }
            });
        }

        function sortMyInterviews(interviews, sortBy) {
            return interviews.sort((a, b) => {
                const [field, direction] = sortBy.split('_');
                let aVal, bVal;
                
                if (field === 'student_name') {
                    aVal = a.student_name;
                    bVal = b.student_name;
                } else if (field === 'duration') {
                    aVal = a.duration_seconds;
                    bVal = b.duration_seconds;
                } else {
                    aVal = a[field];
                    bVal = b[field];
                }
                
                if (direction === 'asc') {
                    return aVal > bVal ? 1 : -1;
                } else {
                    return aVal < bVal ? 1 : -1;
                }
            });
        }

        function sortUsers(users, sortBy) {
            return users.sort((a, b) => {
                const [field, direction] = sortBy.split('_');
                let aVal, bVal;
                
                if (field === 'name') {
                    aVal = a.name;
                    bVal = b.name;
                } else if (field === 'email') {
                    aVal = a.email;
                    bVal = b.email;
                } else if (field === 'role') {
                    aVal = a.role;
                    bVal = b.role;
                } else if (field === 'status') {
                    aVal = a.status;
                    bVal = b.status;
                } else if (field === 'last_login') {
                    aVal = a.last_login_at;
                    bVal = b.last_login_at;
                } else {
                    aVal = a[field];
                    bVal = b[field];
                }
                
                if (direction === 'asc') {
                    return aVal > bVal ? 1 : -1;
                } else {
                    return aVal < bVal ? 1 : -1;
                }
            });
        }

        // Export functions
        function exportQuestions() {
            const filteredQuestions = getCurrentFilteredQuestions();
            const csvContent = generateQuestionsCSV(filteredQuestions);
            downloadCSV(csvContent, 'questions.csv');
        }

        function exportSessions() {
            const filteredSessions = getCurrentFilteredSessions();
            const csvContent = generateSessionsCSV(filteredSessions);
            downloadCSV(csvContent, 'sessions.csv');
        }

        function exportStudents() {
            const filteredStudents = getCurrentFilteredStudents();
            const csvContent = generateStudentsCSV(filteredStudents);
            downloadCSV(csvContent, 'students.csv');
        }

        function exportMyInterviews() {
            const filteredMyInterviews = getCurrentFilteredMyInterviews();
            const csvContent = generateMyInterviewsCSV(filteredMyInterviews);
            downloadCSV(csvContent, 'my-interviews.csv');
        }

        function exportUsers() {
            const filteredUsers = getCurrentFilteredUsers();
            const csvContent = generateUsersCSV(filteredUsers);
            downloadCSV(csvContent, 'users.csv');
        }

        // Helper functions for getting current filtered data
        function getCurrentFilteredQuestions() {
            // This would return the currently filtered questions
            // For now, return all questions
            return questions || [];
        }

        function getCurrentFilteredSessions() {
            return sessions || [];
        }

        function getCurrentFilteredStudents() {
            return students || [];
        }

        function getCurrentFilteredMyInterviews() {
            return myInterviews || [];
        }

        function getCurrentFilteredUsers() {
            return users || [];
        }

        // CSV generation functions
        function generateQuestionsCSV(questions) {
            const headers = ['Question', 'Category', 'Times Asked', 'Correct Answers', 'Incorrect Answers', 'Success Rate', 'Created At'];
            const rows = questions.map(q => [
                `"${q.question.replace(/"/g, '""')}"`,
                q.category,
                q.times_asked,
                q.correct_answers,
                q.incorrect_answers,
                q.success_rate,
                new Date(q.created_at).toLocaleDateString()
            ]);
            return [headers.join(','), ...rows.map(row => row.join(','))].join('\n');
        }

        function generateSessionsCSV(sessions) {
            const headers = ['Session Name', 'Status', 'Created At', 'Panelists'];
            const rows = sessions.map(s => [
                `"${s.session_name.replace(/"/g, '""')}"`,
                s.status,
                new Date(s.created_at).toLocaleDateString(),
                s.panelists ? s.panelists.join('; ') : ''
            ]);
            return [headers.join(','), ...rows.map(row => row.join(','))].join('\n');
        }

        function generateStudentsCSV(students) {
            const headers = ['First Name', 'Last Name', 'Zeta ID', 'Email', 'Phone', 'Address', 'Created At'];
            const rows = students.map(s => [
                `"${s.first_name.replace(/"/g, '""')}"`,
                `"${s.last_name.replace(/"/g, '""')}"`,
                s.zeta_id,
                s.email,
                s.phone || '',
                `"${(s.address || '').replace(/"/g, '""')}"`,
                new Date(s.created_at).toLocaleDateString()
            ]);
            return [headers.join(','), ...rows.map(row => row.join(','))].join('\n');
        }

        function generateMyInterviewsCSV(interviews) {
            const headers = ['Date', 'Student Name', 'Zeta ID', 'Session', 'Status', 'Verdict', 'Duration (min)'];
            const rows = interviews.map(i => [
                new Date(i.created_at).toLocaleDateString(),
                `"${i.student_name.replace(/"/g, '""')}"`,
                i.zeta_id,
                i.session_name || 'N/A',
                i.status,
                i.verdict || 'N/A',
                Math.round(i.duration_seconds / 60)
            ]);
            return [headers.join(','), ...rows.map(row => row.join(','))].join('\n');
        }

        function generateUsersCSV(users) {
            const headers = ['Name', 'Email', 'Role', 'Status', 'Created At', 'Last Login'];
            const rows = users.map(u => [
                `"${u.name.replace(/"/g, '""')}"`,
                u.email,
                u.role,
                u.status,
                new Date(u.created_at).toLocaleDateString(),
                u.last_login_at ? new Date(u.last_login_at).toLocaleDateString() : 'Never'
            ]);
            return [headers.join(','), ...rows.map(row => row.join(','))].join('\n');
        }

        // User Action Menu Functions
        function toggleUserMenu(userId) {
            // Close all other menus first
            document.querySelectorAll('.user-action-menu').forEach(menu => {
                if (menu.id !== `user-menu-${userId}`) {
                    menu.classList.add('hidden');
                }
            });
            
            // Toggle current menu
            const menu = document.getElementById(`user-menu-${userId}`);
            if (menu) {
                menu.classList.toggle('hidden');
            }
        }

        // Close menus when clicking outside
        document.addEventListener('click', function(event) {
            if (!event.target.closest('.action-menu-container')) {
                document.querySelectorAll('.user-action-menu').forEach(menu => {
                    menu.classList.add('hidden');
                });
            }
        });

        async function promoteToAdmin(userId) {
            const proceed = await new Promise(resolve => {
                const overlay = document.createElement('div');
                overlay.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.35);display:flex;align-items:center;justify-content:center;z-index:2000;';
                overlay.innerHTML = `
                  <div style="background:#fff;border:1px solid #e5e7eb;border-radius:8px;min-width:300px;max-width:90%;padding:16px;box-shadow:0 10px 20px rgba(0,0,0,0.15)">
                    <div style="font-weight:600;margin-bottom:8px;color:#111827">Promote to Admin?</div>
                    <div style="font-size:14px;color:#374151;margin-bottom:12px">Are you sure you want to promote this user to Admin role?</div>
                    <div style="display:flex;gap:8px;justify-content:flex-end">
                      <button id="promote-cancel" style="border:1px solid #e5e7eb;background:#fff;padding:6px 10px;border-radius:6px;cursor:pointer">Cancel</button>
                      <button id="promote-confirm" style="background:#059669;color:#fff;border:none;padding:6px 10px;border-radius:6px;cursor:pointer">Promote</button>
                    </div>
                  </div>`;
                document.body.appendChild(overlay);
                overlay.querySelector('#promote-cancel').onclick = ()=> { overlay.remove(); resolve(false); };
                overlay.querySelector('#promote-confirm').onclick = ()=> { overlay.remove(); resolve(true); };
            });
            
            if (!proceed) return;

            try {
                const response = await fetch(`/api/authorized-users/${userId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ role: 'admin', is_superadmin: false })
                });
                
                const result = await response.json();
                if (result.success) {
                    showSuccess('User promoted to Admin successfully');
                    loadUsers(); // Refresh the users list
                } else {
                    showError(result.message || 'Failed to promote user');
                }
            } catch (error) {
                console.error('Error promoting user:', error);
                showError('Error promoting user');
            }
        }

        async function promoteToSuperAdmin(userId) {
            const proceed = await new Promise(resolve => {
                const overlay = document.createElement('div');
                overlay.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.35);display:flex;align-items:center;justify-content:center;z-index:2000;';
                overlay.innerHTML = `
                  <div style="background:#fff;border:1px solid #e5e7eb;border-radius:8px;min-width:300px;max-width:90%;padding:16px;box-shadow:0 10px 20px rgba(0,0,0,0.15)">
                    <div style="font-weight:600;margin-bottom:8px;color:#111827">Promote to Super Admin?</div>
                    <div style="font-size:14px;color:#374151;margin-bottom:12px">Are you sure you want to promote this user to Super Admin role? This gives them full system access.</div>
                    <div style="display:flex;gap:8px;justify-content:flex-end">
                      <button id="super-promote-cancel" style="border:1px solid #e5e7eb;background:#fff;padding:6px 10px;border-radius:6px;cursor:pointer">Cancel</button>
                      <button id="super-promote-confirm" style="background:#dc2626;color:#fff;border:none;padding:6px 10px;border-radius:6px;cursor:pointer">Promote</button>
                    </div>
                  </div>`;
                document.body.appendChild(overlay);
                overlay.querySelector('#super-promote-cancel').onclick = ()=> { overlay.remove(); resolve(false); };
                overlay.querySelector('#super-promote-confirm').onclick = ()=> { overlay.remove(); resolve(true); };
            });
            
            if (!proceed) return;

            try {
                const response = await fetch(`/api/authorized-users/${userId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ role: 'superadmin', is_superadmin: true })
                });
                
                const result = await response.json();
                if (result.success) {
                    showSuccess('User promoted to Super Admin successfully');
                    loadUsers(); // Refresh the users list
                } else {
                    showError(result.message || 'Failed to promote user');
                }
            } catch (error) {
                console.error('Error promoting user:', error);
                showError('Error promoting user');
            }
        }

        async function deactivateUser(userId) {
            const proceed = await new Promise(resolve => {
                const overlay = document.createElement('div');
                overlay.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.35);display:flex;align-items:center;justify-content:center;z-index:2000;';
                overlay.innerHTML = `
                  <div style="background:#fff;border:1px solid #e5e7eb;border-radius:8px;min-width:300px;max-width:90%;padding:16px;box-shadow:0 10px 20px rgba(0,0,0,0.15)">
                    <div style="font-weight:600;margin-bottom:8px;color:#111827">Deactivate User?</div>
                    <div style="font-size:14px;color:#374151;margin-bottom:12px">Are you sure you want to deactivate this user? They will not be able to access the system.</div>
                    <div style="display:flex;gap:8px;justify-content:flex-end">
                      <button id="deactivate-cancel" style="border:1px solid #e5e7eb;background:#fff;padding:6px 10px;border-radius:6px;cursor:pointer">Cancel</button>
                      <button id="deactivate-confirm" style="background:#dc2626;color:#fff;border:none;padding:6px 10px;border-radius:6px;cursor:pointer">Deactivate</button>
                    </div>
                  </div>`;
                document.body.appendChild(overlay);
                overlay.querySelector('#deactivate-cancel').onclick = ()=> { overlay.remove(); resolve(false); };
                overlay.querySelector('#deactivate-confirm').onclick = ()=> { overlay.remove(); resolve(true); };
            });
            
            if (!proceed) return;

            try {
                const response = await fetch(`/api/authorized-users/${userId}`, {
                    method: 'DELETE'
                });
                
                const result = await response.json();
                if (result.success) {
                    showSuccess('User removed from authorized users successfully');
                    loadUsers(); // Refresh the users list
                } else {
                    showError(result.message || 'Failed to remove user');
                }
            } catch (error) {
                console.error('Error removing user:', error);
                showError('Error removing user');
            }
        }

        function downloadCSV(content, filename) {
            const blob = new Blob([content], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Users Management Functions
        let users = []; // Global users array

        async function loadUsers() {
            try {
                const response = await fetch('/api/authorized-users');
                const result = await response.json();
                
                if (result.success) {
                    users = result.data;
                    displayUsers(users);
                } else {
                    console.error('Error loading authorized users:', result.error);
                    showError('Failed to load authorized users: ' + result.error);
                }
            } catch (error) {
                console.error('Error loading authorized users:', error);
                showError('Failed to load authorized users');
            }
        }

        function displayUsers(usersData = users, groupBy = '') {
            const tbody = document.getElementById('users-table-body');
            if (!tbody) return;

            if (!usersData || usersData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" class="no-data">No users found</td></tr>';
                return;
            }

            let html = '';
            
            if (groupBy) {
                // Group users by the specified field
                const grouped = groupUsers(usersData, groupBy);
                Object.keys(grouped).forEach(groupKey => {
                    html += `<tr class="group-header"><td colspan="9"><strong>${groupKey}</strong></td></tr>`;
                    grouped[groupKey].forEach(user => {
                        html += generateUserRow(user);
                    });
                });
            } else {
                // Display users without grouping
                usersData.forEach(user => {
                    html += generateUserRow(user);
                });
            }

            tbody.innerHTML = html;
        }

        function generateUserRow(user) {
            // Debug: Log user role to console
            console.log('User role for', user.name, ':', user.role, 'Type:', typeof user.role);
            
            // For authorized_users table, status is determined by is_superadmin and role
            const status = user.is_superadmin ? 'superadmin' : (user.role || 'interviewer');
            const statusClass = 'status-active'; // All authorized users are active
            const roleClass = status === 'superadmin' ? 'role-superadmin' :
                             status === 'admin' ? 'role-admin' : 'role-interviewer';
            
            // Debug: Check menu conditions
            const isInterviewer = user.role && (user.role.toLowerCase() === 'interviewer' || user.role === 'interviewer');
            const isAdmin = user.role && (user.role.toLowerCase() === 'admin' || user.role === 'admin');
            console.log('Menu conditions for', user.name, '- isInterviewer:', isInterviewer, 'isAdmin:', isAdmin);

            return `
                <tr data-row-id="${user.id}">
                    <td><input type="checkbox" class="row-checkbox" onchange="toggleRowSelection(${user.id})"></td>
                    <td>${user.id}</td>
                    <td class="editable" data-field="name">${user.name || 'N/A'}</td>
                    <td class="editable" data-field="email">${user.email}</td>
                    <td><span class="role-badge ${roleClass}">${status}</span></td>
                    <td><span class="status-badge ${statusClass}">Active</span></td>
                    <td>${new Date(user.created_at).toLocaleDateString()}</td>
                    <td>${user.updated_at ? new Date(user.updated_at).toLocaleDateString() : 'Never'}</td>
                    <td>
                        <div class="action-menu-container">
                            <button class="icon-btn menu-btn" onclick="toggleUserMenu(${user.id})" title="More Actions">‚ãÆ</button>
                            <div id="user-menu-${user.id}" class="user-action-menu hidden">
                                ${isInterviewer ? `<button onclick="promoteToAdmin(${user.id})" class="menu-item">Make as Admin</button>` : ''}
                                ${isAdmin ? `<button onclick="promoteToSuperAdmin(${user.id})" class="menu-item">Make as Super Admin</button>` : ''}
                                <button onclick="deactivateUser(${user.id})" class="menu-item">Deactivate User</button>
                            </div>
                        </div>
                        <button class="icon-btn edit-btn" onclick="startEdit(${user.id})" title="Edit">‚úèÔ∏è</button>
                        <button class="icon-btn view-btn" onclick="viewUser(${user.id})" title="View Details">üëÅÔ∏è</button>
                        <button class="icon-btn delete-btn" onclick="deleteUser(${user.id})" title="Delete">üóëÔ∏è</button>
                    </td>
                </tr>
            `;
        }

        function groupUsers(usersData, groupBy) {
            const grouped = {};
            
            usersData.forEach(user => {
                let groupKey;
                
                switch(groupBy) {
                    case 'role':
                        groupKey = user.role || 'Unknown';
                        break;
                    case 'status':
                        groupKey = user.status || 'Unknown';
                        break;
                    case 'date':
                        groupKey = new Date(user.created_at).toLocaleDateString();
                        break;
                    default:
                        groupKey = 'All Users';
                }
                
                if (!grouped[groupKey]) {
                    grouped[groupKey] = [];
                }
                grouped[groupKey].push(user);
            });
            
            return grouped;
        }

        async function refreshUsers() {
            await loadUsers();
        }

        async function viewUser(userId) {
            try {
                const response = await fetch(`/api/authorized-users/${userId}`);
                const result = await response.json();
                
                if (result.success) {
                    showUserDetailModal(result.data);
                } else {
                    showError('Failed to load authorized user details: ' + result.error);
                }
            } catch (error) {
                console.error('Error loading authorized user details:', error);
                showError('Failed to load authorized user details');
            }
        }

        function showUserDetailModal(user) {
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.display = 'flex';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 600px;">
                    <div class="modal-header">
                        <h3>User Details</h3>
                        <button class="close-btn" onclick="this.closest('.modal').remove()">‚úï</button>
                    </div>
                    <div class="modal-body">
                        <div class="detail-grid">
                            <div class="detail-item">
                                <label>ID:</label>
                                <span>${user.id}</span>
                            </div>
                            <div class="detail-item">
                                <label>Name:</label>
                                <span>${user.name || 'N/A'}</span>
                            </div>
                            <div class="detail-item">
                                <label>Email:</label>
                                <span>${user.email}</span>
                            </div>
                            <div class="detail-item">
                                <label>Role:</label>
                                <span class="role-badge ${user.role === 'superadmin' ? 'role-superadmin' : user.role === 'admin' ? 'role-admin' : 'role-interviewer'}">${user.role}</span>
                            </div>
                            <div class="detail-item">
                                <label>Status:</label>
                                <span class="status-badge ${user.status === 'active' ? 'status-active' : user.status === 'inactive' ? 'status-inactive' : 'status-suspended'}">${user.status}</span>
                            </div>
                            <div class="detail-item">
                                <label>Created At:</label>
                                <span>${new Date(user.created_at).toLocaleString()}</span>
                            </div>
                            <div class="detail-item">
                                <label>Last Login:</label>
                                <span>${user.last_login_at ? new Date(user.last_login_at).toLocaleString() : 'Never'}</span>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        async function deleteUser(userId) {
            if (!confirm('Are you sure you want to delete this authorized user?')) {
                return;
            }

            try {
                const response = await fetch(`/api/authorized-users/${userId}`, {
                    method: 'DELETE'
                });
                const result = await response.json();
                
                if (result.success) {
                    showSuccess('Authorized user deleted successfully');
                    await loadUsers();
                } else {
                    showError('Failed to delete authorized user: ' + result.error);
                }
            } catch (error) {
                console.error('Error deleting authorized user:', error);
                showError('Failed to delete authorized user');
            }
        }

        // Student Detail View
        async function viewStudent(studentId) {
            console.log('üîç viewStudent called with ID:', studentId);
            try {
                // Get student details
                const studentResponse = await fetch(`/api/students/${studentId}`);
                const studentData = await studentResponse.json();
                
                console.log('üìä Student data response:', studentData);
                
                if (!studentData.success) {
                    showError('Student not found');
                    return;
                }

                const student = studentData.data;

                // Get student's interviews
                const interviewsResponse = await fetch(`/api/interviews/student/${studentId}/history`);
                const interviewsData = await interviewsResponse.json();
                
                console.log('üìã Interviews data response:', interviewsData);
                
                const interviews = interviewsData.success ? interviewsData.data : [];
                
                console.log('Student interviews loaded:', interviews.length);

                const content = `
                    <div class="detail-section">
                        <h4 class="detail-section-title">Student Information</h4>
                        <div class="detail-item">
                            <div class="detail-label">Name</div>
                            <div class="detail-value">${student.first_name} ${student.last_name}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Email</div>
                            <div class="detail-value">${student.email}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Zeta ID</div>
                            <div class="detail-value">${student.zeta_id}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Phone</div>
                            <div class="detail-value">${student.phone || 'N/A'}</div>
                        </div>
                    </div>

                    <div class="detail-section">
                        <h4 class="detail-section-title">Interview History (${interviews.length})</h4>
                        ${interviews.length > 0 ? `
                            <ul class="interview-list">
                                ${interviews.map(interview => `
                                    <li class="interview-item">
                                        <div class="interview-header" onclick="toggleInterview(${interview.id})">
                                            <div>
                                                <div class="interview-title">Interview #${interview.id}</div>
                                                <div class="interview-meta">
                                                    ${formatDate(interview.interview_date)} ‚Ä¢ 
                                                    ${interview.duration_seconds ? formatDuration(interview.duration_seconds) : 'N/A'} ‚Ä¢ 
                                                    ${interview.verdict || 'No Verdict'}
                                                </div>
                                            </div>
                                            <span class="interview-expand" id="expand-${interview.id}">‚ñº</span>
                                        </div>
                                        <div class="interview-details" id="details-${interview.id}">
                                            <div class="detail-item">
                                                <div class="detail-label">Status</div>
                                                <div class="detail-value">${interview.status}</div>
                                            </div>
                                            <div class="detail-item">
                                                <div class="detail-label">Overall Notes</div>
                                                <div class="detail-value">${interview.overall_notes || 'No notes available'}</div>
                                            </div>
                                            <div class="detail-item">
                                                <div class="detail-label">Questions & Answers</div>
                                                <div class="detail-value">
                                                    <div id="questions-${interview.id}">Loading questions...</div>
                                                </div>
                                            </div>
                                        </div>
                                    </li>
                                `).join('')}
                            </ul>
                        ` : '<p>No interviews found for this student.</p>'}
                    </div>
                `;

                console.log('üéØ Opening detail panel for student:', student.first_name, student.last_name);
                openDetailPanel(`Student: ${student.first_name} ${student.last_name}`, content);

                // Load questions for each interview
                for (const interview of interviews) {
                    await loadInterviewQuestions(interview.id);
                }

            } catch (error) {
                console.error('Error loading student details:', error);
                showError('Error loading student details');
            }
        }

        // Load interview questions
        async function loadInterviewQuestions(interviewId) {
            try {
                const response = await fetch(`/api/interviews/${interviewId}/questions`);
                const data = await response.json();
                
                const questionsContainer = document.getElementById(`questions-${interviewId}`);
                if (!questionsContainer) return;

                if (data.success && data.data.length > 0) {
                    const questions = data.data;
                    questionsContainer.innerHTML = `
                        <ul class="question-list">
                            ${questions.map(question => `
                                <li class="question-item">
                                    <div class="question-header" onclick="toggleQuestion(${question.id})">
                                        <div class="question-text">${question.question_text}</div>
                                        <span class="question-expand" id="q-expand-${question.id}">‚ñº</span>
                                    </div>
                                    <div class="question-details" id="q-details-${question.id}">
                                        <div class="answer-section">
                                            <div class="answer-label">Student Answer:</div>
                                            <div class="answer-text">${question.student_answer || 'No answer provided'}</div>
                                            ${question.answer_photo_url ? `
                                                <div class="photo-gallery">
                                                    ${(() => {
                                                        try {
                                                            console.log('Raw answer_photo_url:', question.answer_photo_url);
                                                            let photoUrls;
                                                            
                                                            if (typeof question.answer_photo_url === 'string') {
                                                                try {
                                                                    photoUrls = JSON.parse(question.answer_photo_url);
                                                                } catch (parseError) {
                                                                    photoUrls = question.answer_photo_url;
                                                                }
                                                            } else {
                                                                photoUrls = question.answer_photo_url;
                                                            }
                                                            
                                                            if (Array.isArray(photoUrls)) {
                                                                return photoUrls.map((url, index) => {
                                                                    const cleanUrl = url.replace(/^\[|\]$/g, '').replace(/^"|"$/g, '');
                                                                    return `
                                                                        <div class="photo-item">
                                                                            <img src="${cleanUrl}" alt="Answer Image" class="answer-image" onclick="openImageModal('${cleanUrl.replace(/'/g, "\\'")}')" style="cursor: pointer;">
                                                                        </div>
                                                                    `;
                                                                }).join('');
                                                            } else if (typeof photoUrls === 'string' && photoUrls.trim()) {
                                                                const cleanUrl = photoUrls.replace(/^\[|\]$/g, '').replace(/^"|"$/g, '');
                                                                return `
                                                                    <div class="photo-item">
                                                                        <img src="${cleanUrl}" alt="Answer Image" class="answer-image" onclick="openImageModal('${cleanUrl.replace(/'/g, "\\'")}')" style="cursor: pointer;">
                                                                    </div>
                                                                `;
                                                            } else {
                                                                return '<p>No valid images found</p>';
                                                            }
                                                        } catch (e) {
                                                            console.error('Error processing photo URLs:', e);
                                                            return '<p>Error loading images</p>';
                                                        }
                                                    })()}
                                                </div>
                                            ` : ''}
                                        </div>
                                    </div>
                                </li>
                            `).join('')}
                        </ul>
                    `;
                } else {
                    questionsContainer.innerHTML = '<p>No questions found for this interview.</p>';
                }
            } catch (error) {
                console.error('Error loading interview questions:', error);
                const questionsContainer = document.getElementById(`questions-${interviewId}`);
                if (questionsContainer) {
                    questionsContainer.innerHTML = '<p>Error loading questions.</p>';
                }
            }
        }

        // Toggle interview expansion
        function toggleInterview(interviewId) {
            const details = document.getElementById(`details-${interviewId}`);
            const expand = document.getElementById(`expand-${interviewId}`);
            const header = expand.parentElement;

            if (details.classList.contains('active')) {
                details.classList.remove('active');
                expand.classList.remove('expanded');
                header.classList.remove('active');
            } else {
                details.classList.add('active');
                expand.classList.add('expanded');
                header.classList.add('active');
            }
        }

        // Toggle question expansion
        function toggleQuestion(questionId) {
            const details = document.getElementById(`q-details-${questionId}`);
            const expand = document.getElementById(`q-expand-${questionId}`);

            if (details.classList.contains('active')) {
                details.classList.remove('active');
                expand.classList.remove('expanded');
            } else {
                details.classList.add('active');
                expand.classList.add('expanded');
            }
        }

        // Interview Detail View
        async function viewInterview(interviewId) {
            try {
                console.log('üîç Loading interview details for ID:', interviewId);
                
                // Get interview details
                console.log('üåê Making fetch request to:', `/api/interviews/${interviewId}`);
                const interviewResponse = await fetch(`/api/interviews/${interviewId}`);
                console.log('üì° Fetch response status:', interviewResponse.status);
                console.log('üì° Fetch response ok:', interviewResponse.ok);
                
                if (!interviewResponse.ok) {
                    console.error('‚ùå HTTP Error:', interviewResponse.status, interviewResponse.statusText);
                    showError(`HTTP Error: ${interviewResponse.status} ${interviewResponse.statusText}`);
                    return;
                }

        
                
                const interviewData = await interviewResponse.json();
                console.log('üìä Interview API response:', interviewData);
                console.log('üìä Interview API response type:', typeof interviewData);
                console.log('üìä Interview API response keys:', Object.keys(interviewData || {}));
                
                if (!interviewData) {
                    console.error('‚ùå Interview response is null/undefined');
                    showError('No response from server');
                    return;
                }
                
                if (!interviewData.success) {
                    console.error('‚ùå Interview API failed:', interviewData.error);
                    showError(`Interview API failed: ${interviewData.error || 'Unknown error'}`);
                    return;
                }

                const interview = interviewData.data;
                console.log('üìã Interview data:', interview);
                console.log('üìã Interview data type:', typeof interview);
                console.log('üìã Interview data keys:', Object.keys(interview || {}));
                
                if (!interview) {
                    console.error('‚ùå Interview data is null/undefined');
                    console.error('‚ùå Full API response was:', JSON.stringify(interviewData, null, 2));
                    showError('Interview data not available in API response');
                    return;
                }

                // Get student details
                let studentInfo = 'Unknown Student';
                if (interview.student_id) {
                    try {
                        const studentResponse = await fetch(`/api/students/${interview.student_id}`);
                        const studentData = await studentResponse.json();
                        if (studentData.success) {
                            const student = studentData.data;
                            studentInfo = `${student.first_name} ${student.last_name} (${student.zeta_id})`;
                        }
                    } catch (error) {
                        console.error('Error loading student details:', error);
                    }
                }

                // Get interview questions
                let questionsHtml = '<p>No questions found</p>';
                try {
                    const questionsResponse = await fetch(`/api/interviews/${interviewId}/questions`);
                    const questionsData = await questionsResponse.json();
                    if (questionsData.success && questionsData.data.length > 0) {
                        questionsHtml = questionsData.data.map((q, index) => `
                            <div class="question-answer-item" id="question-${q.id}">
                                <div class="question-header">
                                    <p><strong>Q${index + 1}:</strong> <span class="question-text-display">${q.question_text}</span></p>
                                    <button class="icon-btn edit-btn" onclick="editQuestionText(${q.id}, '${q.question_text.replace(/'/g, "\\'")}')" title="Edit Question">‚úèÔ∏è</button>
                                </div>
                                <div class="answer-section">
                                    <p><strong>Answer:</strong> <span class="answer-text-display">${q.student_answer || 'No answer provided'}</span></p>
                                    <button class="icon-btn edit-btn" onclick="editQuestionAnswer(${q.id}, '${(q.student_answer || '').replace(/'/g, "\\'")}')" title="Edit Answer">‚úèÔ∏è</button>
                                </div>
                                ${q.answer_photo_url ? `
                                    <div class="photo-gallery">
                                        ${(() => {
                                            try {
                                                console.log('Raw answer_photo_url:', q.answer_photo_url);
                                                let photoUrls;
                                                
                                                if (typeof q.answer_photo_url === 'string') {
                                                    try {
                                                        photoUrls = JSON.parse(q.answer_photo_url);
                                                    } catch (parseError) {
                                                        photoUrls = q.answer_photo_url;
                                                    }
                                                } else {
                                                    photoUrls = q.answer_photo_url;
                                                }
                                                
                                                if (Array.isArray(photoUrls)) {
                                                    return photoUrls.map((url, index) => {
                                                        const cleanUrl = url.replace(/^\[|\]$/g, '').replace(/^"|"$/g, '');
                                                        return `
                                                            <div class="photo-item">
                                                                <img src="${cleanUrl}" alt="Answer photo" class="answer-image" onclick="openImageModal('${cleanUrl.replace(/'/g, "\\'")}')">
                                                            </div>
                                                        `;
                                                    }).join('');
                                                } else if (typeof photoUrls === 'string' && photoUrls.trim()) {
                                                    const cleanUrl = photoUrls.replace(/^\[|\]$/g, '').replace(/^"|"$/g, '');
                                                    return `
                                                        <div class="photo-item">
                                                            <img src="${cleanUrl}" alt="Answer photo" class="answer-image" onclick="openImageModal('${cleanUrl.replace(/'/g, "\\'")}')">
                                                        </div>
                                                    `;
                                                } else {
                                                    return '<p>No valid images found</p>';
                                                }
                                            } catch (e) {
                                                console.error('Error processing photo URLs:', e);
                                                return '<p>Error loading images</p>';
                                            }
                                        })()}
                                    </div>
                                ` : ''}
                            </div>
                        `).join('');
                    }
                } catch (error) {
                    console.error('Error loading interview questions:', error);
                }

                console.log('üìù Building content HTML...');
                
                const content = `
                    <div class="detail-section">
                        <h4 class="detail-section-title">Interview Information</h4>
                        <div class="detail-item">
                            <div class="detail-label">Interview ID</div>
                            <div class="detail-value">#${interview.id}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Student</div>
                            <div class="detail-value">${studentInfo}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Date</div>
                            <div class="detail-value">${formatDate(interview.interview_date)}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Status</div>
                            <div class="detail-value"><span class="status-badge status-${interview.status}">${interview.status}</span></div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Duration</div>
                            <div class="detail-value">${interview.duration_seconds ? formatDuration(interview.duration_seconds) : 'N/A'}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Verdict</div>
                            <div class="detail-value">${interview.verdict || 'No Verdict'}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Overall Notes</div>
                            <div class="detail-value">${interview.overall_notes || 'No notes available'}</div>
                        </div>
                    </div>
                    
                    <div class="detail-section">
                        <h4 class="detail-section-title">Questions & Answers</h4>
                        <div class="detail-section-content">
                            ${questionsHtml}
                        </div>
                    </div>
                `;

                console.log('üìù Content HTML built successfully');
                console.log('üöÄ Opening detail panel...');
                
                openDetailPanel(`Interview #${interview.id}`, content);
                
                console.log('‚úÖ viewInterview completed successfully');

            } catch (error) {
                console.error('‚ùå Error loading interview details:', error);
                console.error('‚ùå Error stack:', error.stack);
                console.error('‚ùå Error message:', error.message);
                showError(`Error loading interview details: ${error.message}`);
            }
        }

        // Global resume function (not nested) so onclick can access it
        function resumeInterviewAdmin(interviewId) {
            try {
                const item = (interviews || []).find(i => i.id === interviewId) || (myInterviews || []).find(i => i.id === interviewId);
                if (!item) {
                    showError('Interview not found');
                    return;
                }
                const zeta = item.zeta_id || '';
                const sessionId = item.session_id || item.session || '';
                if (!zeta || !sessionId) {
                    showError('Missing Zeta ID or Session');
                    return;
                }
                const url = `/interview-session.html?zeta_id=${encodeURIComponent(zeta)}&session_id=${encodeURIComponent(sessionId)}&resume=1`;
                window.location.href = url;
            } catch (e) {
                console.error('Error resuming interview', e);
                showError('Unable to resume interview');
            }
        }

        // Edit question text in interview details
        async function editQuestionText(questionId, currentText) {
            const questionElement = document.getElementById(`question-${questionId}`);
            const questionDisplay = questionElement.querySelector('.question-text-display');
            const editButton = questionElement.querySelector('.question-header .edit-btn');
            
            // Create input field
            const input = document.createElement('textarea');
            input.className = 'question-edit-input';
            input.value = currentText;
            input.rows = 3;
            
            // Create action buttons
            const actions = document.createElement('div');
            actions.className = 'edit-actions';
            actions.innerHTML = `
                <button class="btn btn-success" onclick="saveQuestionText(${questionId})">Save</button>
                <button class="btn btn-secondary" onclick="cancelQuestionTextEdit(${questionId}, '${currentText.replace(/'/g, "\\'")}')">Cancel</button>
            `;
            
            // Replace display with input
            questionDisplay.style.display = 'none';
            editButton.style.display = 'none';
            questionDisplay.parentNode.insertBefore(input, questionDisplay);
            questionDisplay.parentNode.insertBefore(actions, questionDisplay);
            
            // Focus and select text
            input.focus();
            input.select();
        }
        
        // Save question text
        async function saveQuestionText(questionId) {
            const questionElement = document.getElementById(`question-${questionId}`);
            const input = questionElement.querySelector('.question-edit-input');
            const newText = input.value.trim();
            
            if (!newText) {
                showError('Question text cannot be empty');
                return;
            }
            
            try {
                const response = await fetch(`/api/interview-questions/${questionId}/text`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        question_text: newText
                    })
                });
                
                const result = await response.json();
                
                if (response.ok && result.success) {
                    // Update display
                    const questionDisplay = questionElement.querySelector('.question-text-display');
                    questionDisplay.textContent = newText;
                    questionDisplay.style.display = 'inline';
                    
                    // Show edit button
                    const editButton = questionElement.querySelector('.question-header .edit-btn');
                    editButton.style.display = 'inline-block';
                    
                    // Remove input and actions
                    input.remove();
                    questionElement.querySelector('.edit-actions').remove();
                    
                    showSuccess('Question updated successfully');
                } else {
                    showError(result.error || 'Error updating question');
                }
            } catch (error) {
                console.error('Error updating question:', error);
                showError('Error updating question');
            }
        }
        
        // Cancel question text edit
        function cancelQuestionTextEdit(questionId, originalText) {
            const questionElement = document.getElementById(`question-${questionId}`);
            const questionDisplay = questionElement.querySelector('.question-text-display');
            const editButton = questionElement.querySelector('.question-header .edit-btn');
            
            // Restore display
            questionDisplay.style.display = 'inline';
            editButton.style.display = 'inline-block';
            
            // Remove input and actions
            questionElement.querySelector('.question-edit-input').remove();
            questionElement.querySelector('.edit-actions').remove();
        }
        
        // Edit question answer in interview details
        async function editQuestionAnswer(questionId, currentAnswer) {
            const questionElement = document.getElementById(`question-${questionId}`);
            const answerDisplay = questionElement.querySelector('.answer-text-display');
            const editButton = questionElement.querySelector('.answer-section .edit-btn');
            
            // Create input field
            const input = document.createElement('textarea');
            input.className = 'answer-edit-input';
            input.value = currentAnswer;
            input.rows = 3;
            
            // Create action buttons
            const actions = document.createElement('div');
            actions.className = 'edit-actions';
            actions.innerHTML = `
                <button class="btn btn-success" onclick="saveQuestionAnswer(${questionId})">Save</button>
                <button class="btn btn-secondary" onclick="cancelQuestionAnswerEdit(${questionId}, '${currentAnswer.replace(/'/g, "\\'")}')">Cancel</button>
            `;
            
            // Replace display with input
            answerDisplay.style.display = 'none';
            editButton.style.display = 'none';
            answerDisplay.parentNode.insertBefore(input, answerDisplay);
            answerDisplay.parentNode.insertBefore(actions, answerDisplay);
            
            // Focus and select text
            input.focus();
            input.select();
        }
        
        // Save question answer
        async function saveQuestionAnswer(questionId) {
            const questionElement = document.getElementById(`question-${questionId}`);
            const input = questionElement.querySelector('.answer-edit-input');
            const newAnswer = input.value.trim();
            
            try {
                const response = await fetch(`/api/interview-questions/${questionId}/answer`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        student_answer: newAnswer
                    })
                });
                
                const result = await response.json();
                
                if (response.ok && result.success) {
                    // Update display
                    const answerDisplay = questionElement.querySelector('.answer-text-display');
                    answerDisplay.textContent = newAnswer || 'No answer provided';
                    answerDisplay.style.display = 'inline';
                    
                    // Show edit button
                    const editButton = questionElement.querySelector('.answer-section .edit-btn');
                    editButton.style.display = 'inline-block';
                    
                    // Remove input and actions
                    input.remove();
                    questionElement.querySelector('.edit-actions').remove();
                    
                    showSuccess('Answer updated successfully');
                } else {
                    showError(result.error || 'Error updating answer');
                }
            } catch (error) {
                console.error('Error updating answer:', error);
                showError('Error updating answer');
            }
        }
        
        // Cancel question answer edit
        function cancelQuestionAnswerEdit(questionId, originalAnswer) {
            const questionElement = document.getElementById(`question-${questionId}`);
            const answerDisplay = questionElement.querySelector('.answer-text-display');
            const editButton = questionElement.querySelector('.answer-section .edit-btn');
            
            // Restore display
            answerDisplay.style.display = 'inline';
            editButton.style.display = 'inline-block';
            
            // Remove input and actions
            questionElement.querySelector('.answer-edit-input').remove();
            questionElement.querySelector('.edit-actions').remove();
        }

        // Question Detail View
        async function viewQuestion(questionId) {
            try {
                const response = await fetch(`/api/admin/questions/${questionId}/details`);
                const data = await response.json();
                
                if (!data.success) {
                    showError('Question not found');
                    return;
                }

                const question = data.data;

                const content = `
                    <div class="detail-section">
                        <h4 class="detail-section-title">Question Information</h4>
                        <div class="detail-item">
                            <div class="detail-label">Question</div>
                            <div class="detail-value">${question.question}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Category</div>
                            <div class="detail-value">${question.category}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Times Asked</div>
                            <div class="detail-value">${question.times_asked}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Total Answers</div>
                            <div class="detail-value">${question.total_answers}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Correct Answers</div>
                            <div class="detail-value">${question.correct_answers || question.times_answered_correctly || 0}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Incorrect Answers</div>
                            <div class="detail-value">${question.incorrect_answers || question.times_answered_incorrectly || 0}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Success Rate</div>
                            <div class="detail-value">${question.success_rate}%</div>
                        </div>
                    </div>
                `;

                openDetailPanel(`Question: ${question.question.substring(0, 50)}...`, content);

            } catch (error) {
                console.error('Error loading question details:', error);
                showError('Error loading question details');
            }
        }

        // Image Modal Functions
        function openImageModal(imageUrl) {
            document.getElementById('modal-image').src = imageUrl;
            document.getElementById('image-modal').classList.add('active');
        }

        function closeImageModal() {
            document.getElementById('image-modal').classList.remove('active');
        }

        // Refresh functions
        function refreshInterviews() {
            loadInterviews();
        }

        function refreshQuestions() {
            loadQuestions();
        }

        function refreshStudents() {
            loadStudents();
        }

        // Action functions - viewInterview is already implemented above

        async function viewSession(sessionId) {
            console.log('üîç viewSession called with ID:', sessionId);
            try {
                // Get session details
                const sessionResponse = await fetch(`/api/admin/sessions`);
                const sessionsData = await sessionResponse.json();
                
                console.log('üìä Sessions data response:', sessionsData);
                
                if (!sessionsData.success) {
                    showError('Failed to load sessions');
                    return;
                }

                const session = sessionsData.data.find(s => s.id === parseInt(sessionId));
                if (!session) {
                    showError('Session not found');
                    return;
                }

                // Get interviews for this session
                const interviewsResponse = await fetch(`/api/admin/interviews`);
                const interviewsData = await interviewsResponse.json();
                
                console.log('üìã Interviews data response:', interviewsData);
                
                const sessionInterviews = interviewsData.success ? 
                    interviewsData.data.filter(interview => interview.session_id === parseInt(sessionId)) : [];
                
                console.log('Session interviews loaded:', sessionInterviews.length);

                const content = `
                    <div class="detail-section">
                        <h4 class="detail-section-title">Session Information</h4>
                        <div class="detail-item">
                            <div class="detail-label">Session Name</div>
                            <div class="detail-value">${session.name}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Description</div>
                            <div class="detail-value">${session.description || 'No description available'}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Status</div>
                            <div class="detail-value"><span class="status-badge status-${session.status}">${session.status}</span></div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Created By</div>
                            <div class="detail-value">${session.created_by_name || 'Unknown'}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Created At</div>
                            <div class="detail-value">${formatDate(session.created_at)}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Total Interviews</div>
                            <div class="detail-value">${sessionInterviews.length}</div>
                        </div>
                    </div>

                    <div class="detail-section">
                        <h4 class="detail-section-title">Session Interviews (${sessionInterviews.length})</h4>
                        ${sessionInterviews.length > 0 ? `
                            <ul class="interview-list">
                                ${sessionInterviews.map(interview => `
                                    <li class="interview-item">
                                        <div class="interview-header" onclick="toggleInterview(${interview.id})">
                                            <div>
                                                <div class="interview-title">Interview #${interview.id}</div>
                                                <div class="interview-meta">
                                                    ${interview.student_name || 'Unknown Student'} ‚Ä¢ 
                                                    ${formatDate(interview.interview_date)} ‚Ä¢ 
                                                    ${interview.duration_seconds ? formatDuration(interview.duration_seconds) : 'N/A'} ‚Ä¢ 
                                                    ${interview.verdict || 'No Verdict'}
                                                </div>
                                            </div>
                                            <span class="interview-expand" id="expand-${interview.id}">‚ñº</span>
                                        </div>
                                        <div class="interview-details" id="details-${interview.id}">
                                            <div class="detail-item">
                                                <div class="detail-label">Student</div>
                                                <div class="detail-value">${interview.student_name || 'Unknown'} (${interview.zeta_id || 'N/A'})</div>
                                            </div>
                                            <div class="detail-item">
                                                <div class="detail-label">Interviewer</div>
                                                <div class="detail-value">${interview.interviewer_name || 'Unknown'}</div>
                                            </div>
                                            <div class="detail-item">
                                                <div class="detail-label">Status</div>
                                                <div class="detail-value"><span class="status-badge status-${interview.status}">${interview.status}</span></div>
                                            </div>
                                            <div class="detail-item">
                                                <div class="detail-label">Overall Notes</div>
                                                <div class="detail-value">${interview.overall_notes || 'No notes available'}</div>
                                            </div>
                                            <div class="detail-item">
                                                <div class="detail-label">Questions & Answers</div>
                                                <div class="detail-value">
                                                    <div id="questions-${interview.id}">Loading questions...</div>
                                                </div>
                                            </div>
                                        </div>
                                    </li>
                                `).join('')}
                            </ul>
                        ` : '<p>No interviews found for this session.</p>'}
                    </div>
                `;

                console.log('üéØ Opening detail panel for session:', session.name);
                openDetailPanel(`Session: ${session.name}`, content);

                // Load questions for each interview
                for (const interview of sessionInterviews) {
                    await loadInterviewQuestions(interview.id);
                }

            } catch (error) {
                console.error('Error loading session details:', error);
                showError('Error loading session details');
            }
        }

        // viewStudent is already implemented above

        async function deleteSession(sessionId) {
            const proceed = await new Promise(resolve => {
                const overlay = document.createElement('div');
                overlay.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.35);display:flex;align-items:center;justify-content:center;z-index:2000;';
                overlay.innerHTML = `
                  <div style="background:#fff;border:1px solid #e5e7eb;border-radius:8px;min-width:300px;max-width:90%;padding:16px;box-shadow:0 10px 20px rgba(0,0,0,0.15)">
                    <div style="font-weight:600;margin-bottom:8px;color:#111827">Delete Session?</div>
                    <div style="font-size:14px;color:#374151;margin-bottom:12px">Are you sure you want to delete this session?</div>
                    <div style="display:flex;gap:8px;justify-content:flex-end">
                      <button id="ds-cancel" style="border:1px solid #e5e7eb;background:#fff;padding:6px 10px;border-radius:6px;cursor:pointer">Cancel</button>
                      <button id="ds-ok" style="background:#dc2626;color:#fff;border:none;padding:6px 10px;border-radius:6px;cursor:pointer">Delete</button>
                    </div>
                  </div>`;
                document.body.appendChild(overlay);
                overlay.querySelector('#ds-cancel').onclick = ()=> { overlay.remove(); resolve(false); };
                overlay.querySelector('#ds-ok').onclick = ()=> { overlay.remove(); resolve(true); };
            });
            if (!proceed) return;

            try {
                const response = await fetch(`/api/admin/sessions/${sessionId}`, {
                    method: 'DELETE'
                });

                const data = await response.json();
                
                if (data.success) {
                    loadSessions();
                    showSuccess('Session deleted successfully!');
                } else {
                    showError('Error deleting session: ' + data.error);
                }
            } catch (error) {
                console.error('Error deleting session:', error);
                showError('Error deleting session');
            }
        }

        // Edit functionality
        let selectedRows = new Set();
        let currentEditRow = null;
        let currentEditData = null;

        function toggleRowSelection(rowId) {
            if (selectedRows.has(rowId)) {
                selectedRows.delete(rowId);
            } else {
                selectedRows.add(rowId);
            }
            updateBulkEditControls();
        }

        function selectAllRows() {
            const section = (typeof currentSection !== 'undefined' && currentSection) ? currentSection : (document.querySelector('.nav-link.active') ? document.querySelector('.nav-link.active').dataset.section : '');
            const scope = section ? document.getElementById(section) : document;
            const checkboxes = scope.querySelectorAll('.row-checkbox');
            checkboxes.forEach(checkbox => {
                checkbox.checked = true;
                selectedRows.add(checkbox.dataset.rowId);
            });
            updateBulkEditControls();
        }

        function toggleAllRows(checked) {
            const section = (typeof currentSection !== 'undefined' && currentSection) ? currentSection : (document.querySelector('.nav-link.active') ? document.querySelector('.nav-link.active').dataset.section : '');
            const scope = section ? document.getElementById(section) : document;
            const checkboxes = scope.querySelectorAll('.row-checkbox');
            if (checked) {
                checkboxes.forEach(cb => { cb.checked = true; selectedRows.add(cb.dataset.rowId); });
            } else {
                checkboxes.forEach(cb => { cb.checked = false; selectedRows.delete(cb.dataset.rowId); });
            }
            updateBulkEditControls();
        }

        function clearSelection() {
            selectedRows.clear();
            const section = (typeof currentSection !== 'undefined' && currentSection) ? currentSection : (document.querySelector('.nav-link.active') ? document.querySelector('.nav-link.active').dataset.section : '');
            const scope = section ? document.getElementById(section) : document;
            const checkboxes = scope.querySelectorAll('.row-checkbox');
            checkboxes.forEach(checkbox => {
                checkbox.checked = false;
            });
            updateBulkEditControls();
        }

        function updateBulkEditControls() {
            const controlsList = document.querySelectorAll('.bulk-edit-controls');
            const label = selectedRows.size > 0 ? `${selectedRows.size} records selected` : '0 records selected';
            controlsList.forEach(ctrl => {
                const count = ctrl.querySelector('#bulk-edit-selected-count');
                if (count) count.textContent = label;
            });

            // Toggle per-section bars
            const perBars = document.querySelectorAll('.bulk-edit-controls');
            perBars.forEach(bar => {
                if (selectedRows.size > 0) bar.classList.add('active'); else bar.classList.remove('active');
            });
        }

        function openBulkEditModal() {
            if (selectedRows.size === 0) {
                showError('Please select records to edit');
                return;
            }
            
            const modal = document.getElementById('bulk-edit-modal');
            const fieldSelect = document.getElementById('bulk-edit-field');
            
            // Populate field options based on current tab
            fieldSelect.innerHTML = '<option value="">Select field...</option>';
            
            const section = (typeof currentSection !== 'undefined' && currentSection) ? currentSection : (document.querySelector('.nav-link.active') ? document.querySelector('.nav-link.active').dataset.section : '');
            let fields = [];
            
            if (section === 'students') {
                fields = [
                    { value: 'first_name', text: 'First Name' },
                    { value: 'last_name', text: 'Last Name' },
                    { value: 'email', text: 'Email' },
                    { value: 'phone', text: 'Phone' },
                    { value: 'address', text: 'Address' },
                    { value: 'zeta_id', text: 'Zeta ID' }
                ];
            } else if (section === 'sessions') {
                fields = [
                    { value: 'name', text: 'Name' },
                    { value: 'description', text: 'Description' },
                    { value: 'status', text: 'Status' }
                ];
            } else if (section === 'interviews' || section === 'my-interviews') {
                fields = [
                    { value: 'verdict', text: 'Verdict' },
                    { value: 'status', text: 'Status' },
                    { value: 'overall_notes', text: 'Notes' }
                ];
            } else if (section === 'questions') {
                fields = [
                    { value: 'question', text: 'Question Text' },
                    { value: 'category', text: 'Category' }
                ];
            } else if (section === 'users') {
                fields = [
                    { value: 'name', text: 'Name' },
                    { value: 'email', text: 'Email' },
                    { value: 'role', text: 'Role' },
                    { value: 'status', text: 'Status' }
                ];
            }
            
            fields.forEach(field => {
                const option = document.createElement('option');
                option.value = field.value;
                option.textContent = field.text;
                fieldSelect.appendChild(option);
            });
            
            // Reflect selected count inside modal
            const modalCount = modal.querySelector('#bulk-edit-selected-count');
            if (modalCount) {
                modalCount.textContent = `${selectedRows.size} records selected`;
            }

            modal.classList.add('active');
        }

        async function bulkDelete() {
            if (selectedRows.size === 0) {
                showError('Please select records to delete');
                return;
            }
            const proceed = await new Promise(resolve => {
                const overlay = document.createElement('div');
                overlay.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.35);display:flex;align-items:center;justify-content:center;z-index:2000;';
                overlay.innerHTML = `
                  <div style="background:#fff;border:1px solid #e5e7eb;border-radius:8px;min-width:300px;max-width:90%;padding:16px;box-shadow:0 10px 20px rgba(0,0,0,0.15)">
                    <div style="font-weight:600;margin-bottom:8px;color:#111827">Delete ${selectedRows.size} records?</div>
                    <div style="font-size:14px;color:#374151;margin-bottom:12px">Are you sure you want to delete the selected records? This cannot be undone.</div>
                    <div style="display:flex;gap:8px;justify-content:flex-end">
                      <button id="bd-cancel" style="border:1px solid #e5e7eb;background:#fff;padding:6px 10px;border-radius:6px;cursor:pointer">Cancel</button>
                      <button id="bd-ok" style="background:#dc2626;color:#fff;border:none;padding:6px 10px;border-radius:6px;cursor:pointer">Delete</button>
                    </div>
                  </div>`;
                document.body.appendChild(overlay);
                overlay.querySelector('#bd-cancel').onclick = ()=> { overlay.remove(); resolve(false); };
                overlay.querySelector('#bd-ok').onclick = ()=> { overlay.remove(); resolve(true); };
            });
            if (!proceed) return;

            const section = (typeof currentSection !== 'undefined' && currentSection) ? currentSection : (document.querySelector('.nav-link.active') ? document.querySelector('.nav-link.active').dataset.section : '');
            const prefixBySection = {
                'students': '/api/students/',
                'sessions': '/api/sessions/',
                'interviews': '/api/interviews/',
                'my-interviews': '/api/interviews/',
                'questions': '/api/question-bank/',
                'users': '/api/authorized-users/'
            };
            const prefix = prefixBySection[section];
            if (!prefix) { showError('Cannot resolve delete endpoint'); return; }

            let successCount = 0;
            for (const id of Array.from(selectedRows)) {
                try {
                    const res = await fetch(`${prefix}${id}`, { method: 'DELETE' });
                    const json = await res.json().catch(()=>({success:res.ok}));
                    if (res.ok && json.success !== false) successCount++;
                } catch {}
            }
            showSuccess(`Deleted ${successCount} of ${selectedRows.size} records`);
            clearSelection();
            reloadCurrentTab();
        }

        function closeBulkEditModal() {
            const modal = document.getElementById('bulk-edit-modal');
            if (modal) {
                modal.classList.remove('active');
            }
            const valueInput = document.getElementById('bulk-edit-value');
            if (valueInput) {
                valueInput.value = '';
            }
            const valueGroup = document.getElementById('bulk-edit-value-group');
            if (valueGroup) {
                valueGroup.style.display = 'none';
            }
        }

        function updateBulkEditFields() {
            const fieldSelect = document.getElementById('bulk-edit-field');
            const valueGroup = document.getElementById('bulk-edit-value-group');
            
            if (fieldSelect.value) {
                valueGroup.style.display = 'block';
            } else {
                valueGroup.style.display = 'none';
            }
        }

        async function applyBulkEdit() {
            if (selectedRows.size === 0) {
                showError('No records selected');
                return;
            }
            const field = document.getElementById('bulk-edit-field').value;
            const value = document.getElementById('bulk-edit-value').value;
            
            if (!field || !value) {
                showError('Please select a field and enter a value');
                return;
            }
            
            try {
                // Map display field names to actual database field names
                const fieldMapping = {
                    'first_name': 'first_name',
                    'last_name': 'last_name',
                    'email': 'email',
                    'phone': 'phone',
                    'address': 'address',
                    'zeta_id': 'zeta_id',
                    'name': 'name',
                    'description': 'description',
                    'verdict': 'verdict',
                    'status': 'status',
                    'overall_notes': 'overall_notes',
                    'question': 'question',
                    'category': 'category'
                };
                
                // Validate that the field exists in the mapping
                if (!fieldMapping[field]) {
                    showError(`Field "${field}" is not editable`);
                    return;
                }
                
                const dbField = fieldMapping[field] || field;
                const updates = Array.from(selectedRows).map(rowId => ({
                    id: parseInt(rowId), // Ensure ID is an integer
                    data: { [dbField]: value }
                }));
                
                const section = (typeof currentSection !== 'undefined' && currentSection) ? currentSection : (document.querySelector('.nav-link.active') ? document.querySelector('.nav-link.active').dataset.section : '');
                let endpoint = '';
                if (section === 'students') {
                    endpoint = '/api/students/bulk';
                } else if (section === 'sessions') {
                    endpoint = '/api/sessions/bulk';
                } else if (section === 'interviews' || section === 'my-interviews') {
                    endpoint = '/api/interviews/bulk';
            } else if (section === 'questions') {
                endpoint = '/api/question-bank/bulk';
            } else if (section === 'users') {
                endpoint = '/api/authorized-users/bulk';
            }
                
                console.log('Bulk edit request:', { endpoint, updates });

                let usedBulk = false;
                if (endpoint) {
                    try {
                        const response = await fetch(endpoint, {
                            method: 'PUT',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({ updates })
                        });
                        const result = await response.json();
                        console.log('Bulk edit response:', result);
                        if (response.ok && result.success) {
                            usedBulk = true;
                            showSuccess(`Successfully updated ${updates.length} records`);
                        } else {
                            console.warn('Bulk edit failed, falling back to individual updates:', result.error);
                        }
                    } catch (e) {
                        console.warn('Bulk request error, falling back to individual updates:', e);
                    }
                }

                if (!usedBulk) {
                    // Fallback: perform individual updates using single-record endpoints
                    const ids = Array.from(selectedRows).map(id => parseInt(id));
                    const prefixBySection = {
                        'students': '/api/students/',
                        'sessions': '/api/sessions/',
                        'interviews': '/api/interviews/',
                        'my-interviews': '/api/interviews/',
                        'questions': '/api/question-bank/'
                    };
                    const prefix = prefixBySection[section] || '';
                    if (!prefix) {
                        showError('Error: Cannot resolve endpoint for section');
                        return;
                    }

                    let successCount = 0;
                    for (const id of ids) {
                        try {
                            const res = await fetch(`${prefix}${id}`, {
                                method: 'PUT',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ [dbField]: value })
                            });
                            const json = await res.json();
                            if (res.ok && json.success) successCount++;
                        } catch (e) {
                            console.warn('Individual update failed for id', id, e);
                        }
                    }

                    if (successCount > 0) {
                        showSuccess(`Successfully updated ${successCount} of ${ids.length} records`);
                    } else {
                        showError('Error updating records: No valid fields to update');
                    }
                }

                // Common post-update refresh
                closeBulkEditModal();
                clearSelection();
                reloadCurrentTab();
            } catch (error) {
                console.error('Error applying bulk edit:', error);
                showError('Error applying bulk edit');
            }
        }

        async function startEdit(rowId, data) {
            if (currentEditRow) {
                cancelEdit();
            }
            
            // Derive row data if not provided to avoid inline JSON issues
            let resolvedData = data;
            if (!resolvedData) {
                // Prefer currentSection for robustness across tabs
                const active = document.querySelector('.nav-link.active');
                const section = (typeof currentSection !== 'undefined' && currentSection) ? currentSection : (active ? active.dataset.section : '');
                if (section === 'sessions') {
                    resolvedData = (sessions || []).find(s => String(s.id) === String(rowId));
                } else if (section === 'students') {
                    resolvedData = (students || []).find(s => String(s.id) === String(rowId));
                } else if (section === 'interviews') {
                    resolvedData = (interviews || []).find(i => String(i.id) === String(rowId));
                } else if (section === 'questions') {
                    resolvedData = (questions || []).find(q => String(q.id) === String(rowId));
                } else if (section === 'my-interviews') {
                    // my interviews reuse interviews data loaded for admin
                    resolvedData = (interviews || []).find(i => String(i.id) === String(rowId));
                } else if (section === 'users') {
                    resolvedData = (users || []).find(u => String(u.id) === String(rowId));
                }
            }

            if (!resolvedData) {
                console.warn('startEdit: could not resolve row data for id', rowId);
            }

            currentEditRow = rowId;
            currentEditData = resolvedData ? { ...resolvedData } : null;
            
            const activeSection = (typeof currentSection !== 'undefined' && currentSection) ? currentSection : (document.querySelector('.nav-link.active') ? document.querySelector('.nav-link.active').dataset.section : '');
            const sectionEl = activeSection ? document.getElementById(activeSection) : null;
            const row = sectionEl ? sectionEl.querySelector(`[data-row-id="${rowId}"]`) : document.querySelector(`#${activeSection} [data-row-id="${rowId}"]`);
            if (!row) {
                console.warn('startEdit: no table row found for id', rowId);
                return;
            }
            row.classList.add('editing');
            
            // Replace content with edit form
            const cells = row.querySelectorAll('td:not(:last-child)');
            for (const cell of cells) {
                const field = cell.dataset.field;
                if (!field) continue;

                // Skip non-editable/computed fields
                const nonEditable = ['id', 'interview_count', 'created_by_name', 'created_at', 'student_name', 'zeta_id', 'session_name', 'duration_seconds', 'interviewer_name', 'interview_date'];
                if (nonEditable.includes(field)) continue;

                // Special handling for Students: split name into first_name and last_name
                if ((typeof currentSection !== 'undefined' && currentSection === 'students') && field === 'name') {
                    // Handle both cases: if name field exists or if first_name/last_name exist separately
                    let first = '';
                    let last = '';
                    
                    if (currentEditData) {
                        if (currentEditData.name) {
                            // If name field exists, split it
                            const nameParts = currentEditData.name.split(' ');
                            first = nameParts[0] || '';
                            last = nameParts.slice(1).join(' ') || '';
                        } else {
                            // If separate first_name/last_name fields exist
                            first = currentEditData.first_name || '';
                            last = currentEditData.last_name || '';
                        }
                    }
                    
                    cell.innerHTML = `
                        <input type="text" id="edit-${rowId}-first_name" name="first_name" class="edit-input" value="${first}" data-field="first_name" placeholder="First name" style="margin-right:6px;">
                        <input type="text" id="edit-${rowId}-last_name" name="last_name" class="edit-input" value="${last}" data-field="last_name" placeholder="Last name">
                    `;
                    continue;
                }

                // Special handling for Sessions: panelists multi-select
                if ((typeof currentSection !== 'undefined' && currentSection === 'sessions') && field === 'panelists') {
                    if (!allInterviewers || allInterviewers.length === 0) {
                        try { await loadAllInterviewers(); } catch {}
                    }
                    const selectedIds = Array.isArray(currentEditData?.panelist_ids) ? currentEditData.panelist_ids.map(String) : [];
                    const selectId = `panelist-select-${rowId}`;
                    const options = (allInterviewers || []).map(interv => `<option value="${interv.id}" ${selectedIds.includes(String(interv.id)) ? 'selected' : ''}>${interv.name} (${interv.email})</option>`).join('');
                    cell.innerHTML = `
                        <div>
                            <select id="${selectId}" class="edit-select" multiple size="4" data-field="panelists" style="min-width:260px">
                                ${options}
                            </select>
                            <div style="margin-top:6px;display:flex;gap:6px;align-items:center">
                                <input type="email" id="new-panelist-email-${rowId}" class="edit-input" placeholder="new.panelist@example.com" style="flex:1">
                                <button class="btn btn-secondary" type="button" onclick="addNewInterviewerFromEdit('${rowId}')">Add New</button>
                            </div>
                        </div>
                    `;
                    continue;
                }

                // Special handling for Users: role and status dropdowns
                if ((typeof currentSection !== 'undefined' && currentSection === 'users')) {
                    if (field === 'role') {
                        const currentRole = currentEditData ? currentEditData.role : '';
                        cell.innerHTML = `
                            <select class="edit-input" data-field="role">
                                <option value="superadmin" ${currentRole === 'superadmin' ? 'selected' : ''}>Super Admin</option>
                                <option value="admin" ${currentRole === 'admin' ? 'selected' : ''}>Admin</option>
                                <option value="interviewer" ${currentRole === 'interviewer' ? 'selected' : ''}>Interviewer</option>
                            </select>
                        `;
                        continue;
                    } else if (field === 'is_superadmin') {
                        const currentSuperAdmin = currentEditData ? currentEditData.is_superadmin : false;
                        cell.innerHTML = `
                            <select class="edit-input" data-field="is_superadmin">
                                <option value="false" ${!currentSuperAdmin ? 'selected' : ''}>Regular User</option>
                                <option value="true" ${currentSuperAdmin ? 'selected' : ''}>Super Admin</option>
                            </select>
                        `;
                        continue;
                    }
                }

                // Default text input for other editable fields
                const currentValue = cell.textContent.trim();
                const inputId = `edit-${rowId}-${field}`;
                cell.innerHTML = `<input type="text" id="${inputId}" name="${field}" class="edit-input" value="${currentValue}" data-field="${field}">`;
            }
            
            // Replace action buttons
            const actionCell = row.querySelector('td:last-child');
            actionCell.innerHTML = `
                <button class="icon-btn save-btn" onclick="saveEdit('${rowId}')" title="Save">‚úì</button>
                <button class="icon-btn cancel-btn" onclick="cancelEdit('${rowId}')" title="Cancel">‚úó</button>
            `;
        }

        function cancelEdit(rowId) {
            if (!rowId && !currentEditRow) return;
            
            const targetRowId = rowId || currentEditRow;
            const activeSection = (typeof currentSection !== 'undefined' && currentSection) ? currentSection : (document.querySelector('.nav-link.active') ? document.querySelector('.nav-link.active').dataset.section : '');
            const sectionEl = activeSection ? document.getElementById(activeSection) : null;
            const row = sectionEl ? sectionEl.querySelector(`[data-row-id="${targetRowId}"]`) : document.querySelector(`#${activeSection} [data-row-id="${targetRowId}"]`);
            
            if (row) {
                row.classList.remove('editing');
                
                // Restore original content for this specific row
                if (currentEditData) {
                    restoreRowContent(row, currentEditData);
                } else {
                    // If no original data, refresh the entire tab
                    const activeTab = document.querySelector('.nav-link.active');
                    if (activeTab) {
                        activeTab.click();
                    }
                }
            }
            
            // Clear edit state
            currentEditRow = null;
            currentEditData = null;
        }

        function restoreRowContent(row, originalData) {
            const section = (typeof currentSection !== 'undefined' && currentSection) ? currentSection : (document.querySelector('.nav-link.active') ? document.querySelector('.nav-link.active').dataset.section : '');
            
            // Restore cells based on current tab
            const cells = row.querySelectorAll('td:not(:last-child)');
            cells.forEach((cell, index) => {
                const field = cell.dataset.field;
                if (field && originalData[field] !== undefined) {
                    let displayValue = originalData[field] || 'N/A';
                    
                    // Handle special field formatting
                    if (field === 'status') {
                        const statusClass = displayValue === 'active' ? 'status-active' : 
                                           displayValue === 'inactive' ? 'status-inactive' : 'status-suspended';
                        cell.innerHTML = `<span class="status-badge ${statusClass}">${displayValue}</span>`;
                    } else if (field === 'is_superadmin') {
                        // For authorized_users, show "Active" status since all authorized users are active
                        cell.innerHTML = `<span class="status-badge status-active">Active</span>`;
                    } else if (field === 'role') {
                        const roleClass = displayValue === 'superadmin' ? 'role-superadmin' :
                                         displayValue === 'admin' ? 'role-admin' : 'role-interviewer';
                        cell.innerHTML = `<span class="role-badge ${roleClass}">${displayValue}</span>`;
                    } else if (field === 'created_at' || field === 'interview_date') {
                        displayValue = formatDate(originalData[field]);
                        cell.textContent = displayValue;
                    } else if (field === 'duration_seconds') {
                        displayValue = formatDuration(originalData[field]);
                        cell.textContent = displayValue;
                    } else if (field === 'name' && section === 'students') {
                        // For students, name is computed from first_name + last_name
                        displayValue = `${originalData.first_name || ''} ${originalData.last_name || ''}`.trim();
                        cell.textContent = displayValue;
                    } else if (field === 'question' && section === 'questions') {
                        // For questions, handle favorite button
                        const favoriteBtn = favoriteQuestionIds && favoriteQuestionIds.has(originalData.id) ? '‚òÖ' : '‚òÜ';
                        const favoriteClass = favoriteQuestionIds && favoriteQuestionIds.has(originalData.id) ? 'favorited' : '';
                        cell.innerHTML = `
                            <span>${displayValue}</span>
                            <button 
                                class="favorite-btn ${favoriteClass}"
                                onclick="toggleFavorite(${originalData.id})"
                                title="${favoriteQuestionIds && favoriteQuestionIds.has(originalData.id) ? 'Remove from favorites' : 'Add to favorites'}"
                                style="margin-left:8px"
                            >${favoriteBtn}</button>
                        `;
                    } else {
                        cell.textContent = displayValue;
                    }
                }
            });
            
            // Restore action buttons based on current tab
            const actionCell = row.querySelector('td:last-child');
            if (section === 'students') {
                actionCell.innerHTML = `
                    <button class="icon-btn edit-btn" onclick="startEdit('${originalData.id}')" title="Edit">‚úèÔ∏è</button>
                    <button class="icon-btn delete-btn" onclick="deleteRecord('${originalData.id}', 'student')" title="Delete">üóëÔ∏è</button>
                    <button class="icon-btn" onclick="viewStudent(${originalData.id})" title="View">üëÅÔ∏è</button>
                `;
            } else if (section === 'sessions') {
                actionCell.innerHTML = `
                    <button class="icon-btn edit-btn" onclick="startEdit('${originalData.id}')" title="Edit">‚úèÔ∏è</button>
                    <button class="icon-btn delete-btn" onclick="deleteSession('${originalData.id}')" title="Delete">üóëÔ∏è</button>
                    <button class="icon-btn" onclick="viewSession(${originalData.id})" title="View">üëÅÔ∏è</button>
                `;
            } else if (section === 'interviews' || section === 'my-interviews') {
                actionCell.innerHTML = `
                    <button class="icon-btn edit-btn" onclick="startEdit('${originalData.id}')" title="Edit">‚úèÔ∏è</button>
                    <button class="icon-btn delete-btn" onclick="deleteInterview('${originalData.id}')" title="Delete">üóëÔ∏è</button>
                    <button class="icon-btn" onclick="viewInterview(${originalData.id})" title="View">üëÅÔ∏è</button>
                `;
            } else if (section === 'questions') {
                actionCell.innerHTML = `
                    <button class="icon-btn edit-btn" onclick="startEdit('${originalData.id}')" title="Edit">‚úèÔ∏è</button>
                    <button class="icon-btn delete-btn" onclick="deleteQuestion('${originalData.id}')" title="Delete">üóëÔ∏è</button>
                    <button class="icon-btn" onclick="viewQuestion(${originalData.id})" title="View">üëÅÔ∏è</button>
                `;
            }
        }

        async function saveEdit(rowId) {
            try {
                const activeSection = (typeof currentSection !== 'undefined' && currentSection) ? currentSection : (document.querySelector('.nav-link.active') ? document.querySelector('.nav-link.active').dataset.section : '');
                const sectionEl = activeSection ? document.getElementById(activeSection) : null;
                const row = sectionEl ? sectionEl.querySelector(`[data-row-id="${rowId}"]`) : document.querySelector(`#${activeSection} [data-row-id="${rowId}"]`);
                const inputs = row.querySelectorAll('.edit-input');
                const updateData = {};

                // Define valid database fields for each tab
                const validFieldsBySection = {
                    'students': ['first_name', 'last_name', 'email', 'phone', 'address', 'zeta_id'],
                    'sessions': ['name', 'description', 'status'],
                    'interviews': ['verdict', 'status', 'overall_notes'],
                    'my-interviews': ['verdict', 'status', 'overall_notes'],
                    'questions': ['question', 'category'],
                    'users': ['name', 'email', 'role', 'is_superadmin']
                };

                const section = (typeof currentSection !== 'undefined' && currentSection) ? currentSection : (document.querySelector('.nav-link.active') ? document.querySelector('.nav-link.active').dataset.section : '');
                const allowedFields = validFieldsBySection[section] || [];

                inputs.forEach(input => {
                    const field = input.dataset.field;
                    if (allowedFields.includes(field)) {
                        updateData[field] = input.value;
                    } else {
                        // panelists is handled separately for sessions
                        if (!(section === 'sessions' && field === 'panelists')) {
                            console.warn(`Field "${field}" is not editable in section: ${section}`);
                        }
                    }
                });

                // Always capture panelists selection for sessions, even if not in allowedFields
                if (section === 'sessions') {
                    const select = document.querySelector(`#panelist-select-${rowId}`);
                    const ids = Array.from(select ? select.selectedOptions : []).map(o => parseInt(o.value)).filter(n => !Number.isNaN(n));
                    updateData['panelist_ids'] = ids;
                }

                if (Object.keys(updateData).length === 0) {
                    showError('No valid fields to update');
                    return;
                }
                
                let endpoint = '';
                
                if (section === 'students') {
                    endpoint = `/api/students/${rowId}`;
                } else if (section === 'sessions') {
                    endpoint = `/api/sessions/${rowId}`;
                } else if (section === 'interviews' || section === 'my-interviews') {
                    endpoint = `/api/interviews/${rowId}`;
                } else if (section === 'questions') {
                    endpoint = `/api/question-bank/${rowId}`;
                } else if (section === 'users') {
                    endpoint = `/api/authorized-users/${rowId}`;
                }
                
                const response = await fetch(endpoint, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(updateData)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    // Update panelists if provided
                    if (section === 'sessions') {
                        try {
                            await fetch(`/api/sessions/${rowId}/panelists`, {
                                method: 'PUT',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ panelist_ids: Array.isArray(updateData.panelist_ids) ? updateData.panelist_ids : [] })
                            });
                        } catch (e) { console.warn('Panelists update failed:', e); }
                    }
                    showSuccess('Record updated successfully');
                    // Exit edit mode (remove editing class for the row, clear state)
                    const activeSection = (typeof currentSection !== 'undefined' && currentSection) ? currentSection : (document.querySelector('.nav-link.active') ? document.querySelector('.nav-link.active').dataset.section : '');
                    const sectionEl = activeSection ? document.getElementById(activeSection) : null;
                    const editedRow = sectionEl ? sectionEl.querySelector(`[data-row-id="${rowId}"]`) : document.querySelector(`#${activeSection} [data-row-id="${rowId}"]`);
                    if (editedRow) editedRow.classList.remove('editing');
                    currentEditRow = null;
                    currentEditData = null;
                    // Reload the active tab's data to reflect latest DB values
                    reloadCurrentTab();
                } else {
                    showError('Error updating record: ' + result.error);
                }
            } catch (error) {
                console.error('Error saving edit:', error);
                showError('Error saving edit');
            }
        }

        async function deleteRecord(rowId, type) {
            // Confirm delete popup
            const proceed = await new Promise(resolve => {
                const overlay = document.createElement('div');
                overlay.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.35);display:flex;align-items:center;justify-content:center;z-index:2000;';
                overlay.innerHTML = `
                  <div style="background:#fff;border:1px solid #e5e7eb;border-radius:8px;min-width:300px;max-width:90%;padding:16px;box-shadow:0 10px 20px rgba(0,0,0,0.15)">
                    <div style="font-weight:600;margin-bottom:8px;color:#111827">Delete ${type}?</div>
                    <div style="font-size:14px;color:#374151;margin-bottom:12px">Are you sure you want to delete this ${type}?</div>
                    <div style="display:flex;gap:8px;justify-content:flex-end">
                      <button id="del-cancel" style="border:1px solid #e5e7eb;background:#fff;padding:6px 10px;border-radius:6px;cursor:pointer">Cancel</button>
                      <button id="del-ok" style="background:#dc2626;color:#fff;border:none;padding:6px 10px;border-radius:6px;cursor:pointer">Delete</button>
                    </div>
                  </div>`;
                document.body.appendChild(overlay);
                overlay.querySelector('#del-cancel').onclick = ()=> { overlay.remove(); resolve(false); };
                overlay.querySelector('#del-ok').onclick = ()=> { overlay.remove(); resolve(true); };
            });
            if (!proceed) return;

            try {
                const section = (typeof currentSection !== 'undefined' && currentSection) ? currentSection : (document.querySelector('.nav-link.active') ? document.querySelector('.nav-link.active').dataset.section : '');
                let endpoint = '';

                if (section === 'students') {
                    endpoint = `/api/students/${rowId}`;
                } else if (section === 'sessions') {
                    endpoint = `/api/sessions/${rowId}`;
                } else if (section === 'interviews' || section === 'my-interviews') {
                    endpoint = `/api/interviews/${rowId}`;
                } else if (section === 'questions') {
                    endpoint = `/api/question-bank/${rowId}`;
                } else if (section === 'users') {
                    endpoint = `/api/authorized-users/${rowId}`;
                }

                const response = await fetch(endpoint, {
                    method: 'DELETE'
                });

                const result = await response.json();

                if (result.success) {
                    showSuccess(`${type} deleted successfully`);
                    reloadCurrentTab();
                } else {
                    showError(`Error deleting ${type}: ${result.error}`);
                }
            } catch (error) {
                console.error(`Error deleting ${type}:`, error);
                showError(`Error deleting ${type}`);
            }
        }

        // Specific delete functions for better UX
        async function deleteSession(sessionId) {
            await deleteRecord(sessionId, 'session');
        }

        async function deleteInterview(interviewId) {
            await deleteRecord(interviewId, 'interview');
        }

        async function deleteQuestion(questionId) {
            await deleteRecord(questionId, 'question');
        }

        // Bulk Import Functions
        let selectedFile = null;
        let parsedData = [];

        function openBulkImportModal() {
            const modal = document.getElementById('bulk-import-modal');
            modal.classList.add('active');
            resetImportModal();
            
            // Tab switching
            document.getElementById('text-import-tab').onclick = () => {
                document.getElementById('text-import-section').style.display = 'block';
                document.getElementById('file-import-section').style.display = 'none';
                document.getElementById('text-import-tab').style.background = '#3b82f6';
                document.getElementById('text-import-tab').style.color = '#fff';
                document.getElementById('file-import-tab').style.background = '#f9fafb';
                document.getElementById('file-import-tab').style.color = '#000';
            };
            
            document.getElementById('file-import-tab').onclick = () => {
                document.getElementById('text-import-section').style.display = 'none';
                document.getElementById('file-import-section').style.display = 'block';
                document.getElementById('file-import-tab').style.background = '#3b82f6';
                document.getElementById('file-import-tab').style.color = '#fff';
                document.getElementById('text-import-tab').style.background = '#f9fafb';
                document.getElementById('text-import-tab').style.color = '#000';
            };
            
            // File selection
            document.getElementById('file-select-btn').onclick = () => {
                document.getElementById('bulk-import-file').click();
            };
            
            document.getElementById('bulk-import-file').onchange = async (e) => {
                const file = e.target.files[0];
                if (file) {
                    document.getElementById('selected-file-name').textContent = file.name;
                    document.getElementById('selected-file-info').style.display = 'block';
                    
                    // Parse the file
                    try {
                        selectedFile = file;
                        parsedData = await parseFile(file);
                        console.log('Parsed data:', parsedData);
                        
                        // Show preview
                        if (parsedData.length > 0) {
                            showImportPreview(parsedData);
                        }
                    } catch (error) {
                        console.error('Error parsing file:', error);
                        showError('Error parsing file: ' + error.message);
                        selectedFile = null;
                        parsedData = [];
                    }
                }
                updateImportButtonState();
            };
            
            document.getElementById('remove-file-btn').onclick = () => {
                document.getElementById('bulk-import-file').value = '';
                document.getElementById('selected-file-info').style.display = 'none';
                updateImportButtonState();
            };
            
            // Add event listeners to enable/disable import button
            document.getElementById('bulk-questions-text').addEventListener('input', updateImportButtonState);
            document.getElementById('bulk-import-file').addEventListener('change', updateImportButtonState);
        }
        
        function updateImportButtonState() {
            const textInput = document.getElementById('bulk-questions-text').value.trim();
            const fileInput = document.getElementById('bulk-import-file').files.length > 0;
            const importBtn = document.getElementById('import-btn');
            
            importBtn.disabled = !(textInput || fileInput);
        }

        function closeBulkImportModal() {
            const modal = document.getElementById('bulk-import-modal');
            modal.classList.remove('active');
            resetImportModal();
        }

        function resetImportModal() {
            selectedFile = null;
            parsedData = [];
            document.getElementById('bulk-import-file').value = '';
            document.getElementById('bulk-questions-text').value = '';
            document.getElementById('selected-file-info').style.display = 'none';
            document.getElementById('import-preview').style.display = 'none';
            document.getElementById('import-progress').style.display = 'none';
            document.getElementById('import-results').style.display = 'none';
            updateImportButtonState();
        }

        // Parse uploaded file
        async function parseFile(file) {
            const questions = [];
            const fileExtension = file.name.split('.').pop().toLowerCase();
            
            if (fileExtension === 'csv') {
                const text = await file.text();
                const lines = text.split('\n').filter(line => line.trim());
                
                // Skip header row if it exists
                for (let i = 0; i < lines.length; i++) {
                    const line = lines[i].trim();
                    if (!line) continue;
                    
                    // Skip header row if it contains 'question' or 'category'
                    if (i === 0 && (line.toLowerCase().includes('question') || line.toLowerCase().includes('category'))) {
                        continue;
                    }
                    
                    // Use proper CSV parsing that handles quoted fields
                    const parsed = parseCSVLine(line);
                    if (parsed.length >= 2) {
                        questions.push({
                            question: parsed[0].trim(),
                            category: parsed[1].trim() || 'General'
                        });
                    } else if (parsed.length === 1) {
                        // If only one column, treat it as question with default category
                        questions.push({
                            question: parsed[0].trim(),
                            category: 'General'
                        });
                    }
                }
            } else if (fileExtension === 'xlsx' || fileExtension === 'xls') {
                // For Excel files, we'll need to use a library like SheetJS
                // For now, show an error message
                throw new Error('Excel file support requires additional setup. Please use CSV format for now.');
            } else {
                throw new Error('Unsupported file format. Please use CSV, XLSX, or XLS files.');
            }
            
            return questions;
        }

        async function handleFileSelect() {
            const fileInput = document.getElementById('bulk-import-file');
            const file = fileInput.files[0];
            
            if (!file) {
                resetImportModal();
                return;
            }

            selectedFile = file;
            document.getElementById('import-btn').disabled = false;

            try {
                // Parse the file using the new parseFile function
                parsedData = await parseFile(file);

                // Show preview
                showImportPreview(parsedData);
            } catch (error) {
                console.error('Error parsing file:', error);
                showError('Error parsing file: ' + error.message);
            }
        }

        async function parseCSV(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const text = e.target.result;
                        const lines = text.split('\n').filter(line => line.trim());
                        const data = [];
                        
                        for (let i = 0; i < lines.length; i++) {
                            const line = lines[i].trim();
                            if (!line) continue;
                            
                            // Skip header row if it exists
                            if (i === 0 && (line.toLowerCase().includes('question') || line.toLowerCase().includes('category'))) {
                                continue;
                            }
                            
                            // Proper CSV parsing that handles quoted fields
                            const parsed = parseCSVLine(line);
                            if (parsed.length >= 2) {
                                data.push({
                                    question: parsed[0].trim(),
                                    category: parsed[1].trim() || 'General'
                                });
                            } else if (parsed.length === 1) {
                                // If only one column, treat it as question with default category
                                data.push({
                                    question: parsed[0].trim(),
                                    category: 'General'
                                });
                            }
                        }
                        
                        console.log(`üìä Parsed ${data.length} questions from CSV`);
                        resolve(data);
                    } catch (error) {
                        reject(error);
                    }
                };
                reader.onerror = () => reject(new Error('Failed to read file'));
                reader.readAsText(file);
            });
        }

        // Proper CSV line parser that handles quoted fields
        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            let i = 0;
            
            while (i < line.length) {
                const char = line[i];
                const nextChar = line[i + 1];
                
                if (char === '"') {
                    if (inQuotes && nextChar === '"') {
                        // Escaped quote
                        current += '"';
                        i += 2;
                    } else {
                        // Toggle quote state
                        inQuotes = !inQuotes;
                        i++;
                    }
                } else if (char === ',' && !inQuotes) {
                    // Field separator
                    result.push(current);
                    current = '';
                    i++;
                } else {
                    current += char;
                    i++;
                }
            }
            
            // Add the last field
            result.push(current);
            
            return result;
        }

        async function parseExcel(file) {
            // For Excel files, we'll use a simple approach
            // In a real implementation, you'd use a library like SheetJS
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        // This is a simplified Excel parser
                        // For production, use a proper Excel parsing library
                        const data = e.target.result;
                        
                        // For now, we'll show an error and suggest CSV
                        reject(new Error('Excel parsing not fully implemented. Please use CSV format for now.'));
                    } catch (error) {
                        reject(error);
                    }
                };
                reader.onerror = () => reject(new Error('Failed to read file'));
                reader.readAsArrayBuffer(file);
            });
        }

        function showImportPreview(data) {
            const previewDiv = document.getElementById('import-preview');
            const contentDiv = document.getElementById('preview-content');
            
            if (data.length === 0) {
                contentDiv.innerHTML = '<p>No data found in file.</p>';
                previewDiv.style.display = 'block';
                return;
            }

            const previewData = data.slice(0, 5); // Show first 5 rows
            const tableHTML = `
                <table class="preview-table">
                    <thead>
                        <tr>
                            <th>Question</th>
                            <th>Category</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${previewData.map(row => `
                            <tr>
                                <td>${row.question}</td>
                                <td>${row.category}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
                ${data.length > 5 ? `<p><em>... and ${data.length - 5} more rows</em></p>` : ''}
            `;
            
            contentDiv.innerHTML = tableHTML;
            previewDiv.style.display = 'block';
        }

        async function startBulkImport() {
            const importBtn = document.getElementById('import-btn');
            
            // Prevent multiple simultaneous imports
            if (importBtn.disabled) {
                console.log('‚ö†Ô∏è Import already in progress, ignoring duplicate request');
                return;
            }
            
            const textSection = document.getElementById('text-import-section');
            const fileSection = document.getElementById('file-import-section');
            let questions = [];
            
            if (textSection.style.display !== 'none') {
                // Text import
                const questionsText = document.getElementById('bulk-questions-text').value.trim();
                
                if (!questionsText) {
                    showError('Please enter questions to import');
                    return;
                }
                
                // Parse questions (format: "Question text | Category")
                const lines = questionsText.split('\n').filter(line => line.trim());
                questions = lines.map((line, index) => {
                    const parts = line.split('|').map(part => part.trim());
                    if (parts.length === 0 || !parts[0]) {
                        throw new Error(`Line ${index + 1}: Empty question text`);
                    }
                    return {
                        question: parts[0],
                        category: parts[1] || 'General'
                    };
                });
            } else {
                // File import
                if (!selectedFile || parsedData.length === 0) {
                    showError('No file selected or no data to import');
                    return;
                }
                questions = parsedData;
            }
            
            if (questions.length === 0) {
                showError('No valid questions found');
                return;
            }

            const progressDiv = document.getElementById('import-progress');
            const resultsDiv = document.getElementById('import-results');
            
            // Show progress and disable button
            importBtn.disabled = true;
            importBtn.textContent = 'Importing...';
            progressDiv.style.display = 'block';
            resultsDiv.style.display = 'none';
            
            console.log(`üöÄ Starting bulk import of ${questions.length} questions at ${new Date().toISOString()}`);

            try {
                // Validate data first
                const validationResult = validateImportData(questions);
                if (!validationResult.isValid) {
                    showImportResults({
                        success: false,
                        message: 'Validation failed',
                        errors: validationResult.errors,
                        warnings: validationResult.warnings
                    });
                    return;
                }
                
                // Show warnings if any
                if (validationResult.warnings && validationResult.warnings.length > 0) {
                    console.log('‚ö†Ô∏è Validation warnings:', validationResult.warnings);
                }

                // Use the new bulk import API
                const response = await fetch('/api/question-bank/bulk', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ questions })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showImportResults({
                        success: true,
                        message: `Successfully imported ${result.imported || questions.length} questions!`,
                        imported: result.imported || questions.length,
                        total: questions.length
                    });
                    // Refresh the questions list
                    loadQuestions();
                } else {
                    showImportResults({
                        success: false,
                        message: 'Import failed',
                        errors: [result.error || 'Unknown error']
                    });
                }

            } catch (error) {
                console.error('Import error:', error);
                showImportResults({
                    success: false,
                    message: 'Import failed: ' + error.message
                });
            } finally {
                importBtn.disabled = false;
                importBtn.textContent = 'Import Questions';
                console.log(`‚úÖ Bulk import completed at ${new Date().toISOString()}`);
            }
        }

        function validateImportData(data) {
            const errors = [];
            const warnings = [];
            
            console.log(`üîç Validating ${data.length} questions`);
            
            for (let i = 0; i < data.length; i++) {
                const row = data[i];
                const rowNum = i + 1;
                
                // Check if row exists and has required properties
                if (!row) {
                    errors.push(`Row ${rowNum}: Empty row`);
                    continue;
                }
                
                // Validate question
                if (!row.question || row.question.trim() === '') {
                    errors.push(`Row ${rowNum}: Question is required`);
                } else if (row.question.trim().length < 5) {
                    warnings.push(`Row ${rowNum}: Question is very short (${row.question.trim().length} characters)`);
                } else if (row.question.length > 1000) {
                    errors.push(`Row ${rowNum}: Question is too long (${row.question.length} characters, max 1000)`);
                }
                
                // Validate category
                if (!row.category || row.category.trim() === '') {
                    errors.push(`Row ${rowNum}: Category is required`);
                } else if (row.category.trim().length > 100) {
                    errors.push(`Row ${rowNum}: Category is too long (${row.category.length} characters, max 100)`);
                }
                
                // Check for potential issues
                if (row.question && row.question.includes('  ')) {
                    warnings.push(`Row ${rowNum}: Question contains multiple spaces`);
                }
            }
            
            console.log(`‚úÖ Validation complete: ${errors.length} errors, ${warnings.length} warnings`);
            
            return {
                isValid: errors.length === 0,
                errors,
                warnings
            };
        }

        function updateProgress(percentage, text) {
            const progressFill = document.getElementById('progress-fill');
            const progressText = document.getElementById('progress-text');
            
            progressFill.style.width = percentage + '%';
            progressText.textContent = text;
        }

        function showImportResults(result) {
            const resultsDiv = document.getElementById('import-results');
            const contentDiv = document.getElementById('results-content');
            const progressDiv = document.getElementById('import-progress');
            
            // Hide progress
            progressDiv.style.display = 'none';
            
            // Set result styling
            resultsDiv.className = 'import-results';
            if (result.success) {
                resultsDiv.classList.add('results-success');
            } else if (result.errorCount > 0 && result.successCount > 0) {
                resultsDiv.classList.add('results-warning');
            } else {
                resultsDiv.classList.add('results-error');
            }
            
            // Build results content
            let content = `<p><strong>${result.message}</strong></p>`;
            
            if (result.successCount !== undefined) {
                content += `<p>‚úÖ Successfully imported: ${result.successCount} questions</p>`;
            }
            
            if (result.errorCount > 0) {
                content += `<p>‚ùå Failed to import: ${result.errorCount} questions</p>`;
            }
            
            if (result.errors && result.errors.length > 0) {
                content += '<h5>Errors:</h5><ul>';
                result.errors.forEach(error => {
                    content += `<li>${error}</li>`;
                });
                content += '</ul>';
            }
            
            if (result.warnings && result.warnings.length > 0) {
                content += '<h5>Warnings:</h5><ul>';
                result.warnings.forEach(warning => {
                    content += `<li>${warning}</li>`;
                });
                content += '</ul>';
            }
            
            contentDiv.innerHTML = content;
            resultsDiv.style.display = 'block';
        }
    </script>

    <!-- Bulk Edit Modal -->
    <div id="bulk-edit-modal" class="bulk-edit-modal" onclick="closeBulkEditModal()">
        <div class="bulk-edit-content" onclick="event.stopPropagation()">
            <div class="bulk-edit-header">
                <h3 class="bulk-edit-title">Bulk Edit Records</h3>
                <button class="close-modal" onclick="closeBulkEditModal()">&times;</button>
            </div>
            <form id="bulk-edit-form" class="bulk-edit-form">
                <div class="form-group">
                    <label class="form-label">Field to Update:</label>
                    <select id="bulk-edit-field" class="form-select" onchange="updateBulkEditFields()">
                        <option value="">Select field...</option>
                    </select>
                </div>
                <div id="bulk-edit-value-group" class="form-group" style="display: none;">
                    <label class="form-label">New Value:</label>
                    <input type="text" id="bulk-edit-value" class="form-input" placeholder="Enter new value...">
                </div>
                <div class="form-group">
                    <label class="form-label">Selected Records:</label>
                    <div id="bulk-edit-selected-count" class="bulk-edit-info">0 records selected</div>
                </div>
            </form>
            <div class="bulk-edit-footer">
                <button class="btn btn-secondary" onclick="closeBulkEditModal()">Cancel</button>
                <button class="btn btn-primary" onclick="applyBulkEdit()">Apply Changes</button>
            </div>
        </div>
    </div>

    <!-- Bulk Import Modal -->
    <div id="bulk-import-modal" class="bulk-edit-modal" onclick="closeBulkImportModal()">
        <div class="bulk-edit-content" onclick="event.stopPropagation()">
            <div class="bulk-edit-header">
                <h3 class="bulk-edit-title">Bulk Import Questions</h3>
                <button class="close-modal" onclick="closeBulkImportModal()">&times;</button>
            </div>
            <!-- Import Method Tabs -->
            <div style="margin-bottom:16px">
                <div style="display:flex;gap:8px;margin-bottom:16px">
                    <button id="text-import-tab" class="import-tab active" style="padding:8px 16px;border:1px solid #d1d5db;background:#3b82f6;color:#fff;border-radius:6px;cursor:pointer">Text Input</button>
                    <button id="file-import-tab" class="import-tab" style="padding:8px 16px;border:1px solid #d1d5db;background:#f9fafb;border-radius:6px;cursor:pointer">File Upload</button>
                </div>
            </div>
            
            <!-- Text Input Section -->
            <div id="text-import-section">
                <div style="margin-bottom:16px;padding:12px;background:#f3f4f6;border-radius:6px;font-size:14px;color:#374151">
                    <strong>Instructions:</strong><br>
                    ‚Ä¢ Enter one question per line<br>
                    ‚Ä¢ Use format: "Question text | Category" (category is optional)<br>
                    ‚Ä¢ Example: "What is JavaScript? | Technical"<br>
                    ‚Ä¢ If no category is specified, "General" will be used
                </div>
                <div style="margin-bottom:16px">
                    <label style="display:block;margin-bottom:8px;font-weight:500;color:#374151">Questions *</label>
                    <textarea id="bulk-questions-text" style="width:100%;padding:12px;border:1px solid #d1d5db;border-radius:6px;font-size:14px;min-height:200px;resize:vertical;font-family:monospace" placeholder="Enter questions here, one per line..."></textarea>
                </div>
            </div>
            
            <!-- File Upload Section -->
            <div id="file-import-section" style="display:none">
                <div style="margin-bottom:16px;padding:12px;background:#f3f4f6;border-radius:6px;font-size:14px;color:#374151">
                    <strong>CSV Format Instructions:</strong><br>
                    ‚Ä¢ First row can be a header (will be skipped)<br>
                    ‚Ä¢ Format: "Question,Category" or just "Question"<br>
                    ‚Ä¢ <strong>Important:</strong> Use quotes around questions that contain commas<br>
                    ‚Ä¢ Example: "What is JavaScript, and how does it work?",Technical<br>
                    ‚Ä¢ Example: "Tell me about yourself,Behavioral"<br>
                    ‚Ä¢ <strong>For questions with commas:</strong> "Explain the difference between let, const, and var in JavaScript",Technical
                </div>
                <div style="margin-bottom:16px">
                    <label style="display:block;margin-bottom:8px;font-weight:500;color:#374151">Upload File *</label>
                    <div style="border:2px dashed #d1d5db;border-radius:8px;padding:24px;text-align:center;background:#f9fafb">
                        <input type="file" id="bulk-import-file" accept=".csv,.xlsx,.xls" style="display:none">
                        <div style="margin-bottom:8px">
                            <span style="font-size:24px">üìÅ</span>
                        </div>
                        <div style="margin-bottom:8px;font-weight:500">Click to select file or drag and drop</div>
                        <div style="font-size:12px;color:#6b7280">CSV, XLSX, XLS files only</div>
                        <button id="file-select-btn" style="margin-top:12px;background:#3b82f6;color:#fff;border:none;padding:8px 16px;border-radius:6px;cursor:pointer">Select File</button>
                    </div>
                    <div id="selected-file-info" style="margin-top:8px;padding:8px;background:#e0f2fe;border-radius:4px;display:none">
                        <span id="selected-file-name"></span>
                        <button id="remove-file-btn" style="margin-left:8px;background:#ef4444;color:#fff;border:none;padding:4px 8px;border-radius:4px;cursor:pointer;font-size:12px">Remove</button>
                    </div>
                </div>
            </div>
            
            <div id="import-preview" class="import-preview" style="display: none;">
                <h4>Preview (First 5 rows):</h4>
                <div id="preview-content"></div>
            </div>
            <div id="import-progress" class="import-progress" style="display: none;">
                <div class="progress-bar">
                    <div class="progress-fill" id="progress-fill"></div>
                </div>
                <div class="progress-text" id="progress-text">Importing...</div>
            </div>
            <div id="import-results" class="import-results" style="display: none;">
                <h4>Import Results:</h4>
                <div id="results-content"></div>
            </div>
            <div class="bulk-edit-footer">
                <button class="btn btn-secondary" onclick="closeBulkImportModal()">Cancel</button>
                <button class="btn btn-primary" id="import-btn" onclick="startBulkImport()" disabled>Import Questions</button>
            </div>
        </div>
    </div>
</body>
</html>
