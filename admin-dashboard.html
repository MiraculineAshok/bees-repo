<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Bees Interview Platform</title>
    <link rel="icon" type="image/png" href="/logo3.png">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #ffffff;
            color: #000000;
            line-height: 1.6;
        }

        .dashboard-container {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        /* Unified Header with Navigation */
        .sidebar {
            width: 100%;
            background: #000000;
            color: white;
            padding: 0.75rem 2rem;
            position: sticky;
            top: 0;
            z-index: 1000;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            display: flex;
            align-items: center;
            gap: 2rem;
        }

        .sidebar-header {
            display: flex;
            align-items: center;
        }

        .sidebar-header .logo {
            display: flex;
            align-items: center;
        }
        
        .logo-container {
            display: flex;
            align-items: center;
            color: #ffffff;
        }
        
        /* Logo styling - showing original colors */

        .sidebar-nav {
            list-style: none;
            display: flex;
            align-items: center;
            margin: 0;
            padding: 0;
            gap: 0.25rem;
            flex: 1;
            justify-content: flex-end;
        }

        .nav-item {
            margin: 0;
        }

        .nav-link {
            display: block;
            padding: 0.75rem 1.25rem;
            color: #cccccc;
            text-decoration: none;
            transition: all 0.2s ease;
            border-radius: 6px;
            white-space: nowrap;
            font-size: 0.9rem;
        }

        .nav-link:hover,
        .nav-link.active {
            background: #333333;
            color: white;
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .header-actions .btn {
            background: #1E4ED8;
            color: white;
            padding: 0.9rem 1.2rem;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            white-space: nowrap;
        }

        .header-actions .btn:hover {
            background: #1d4ed8;
        }

        #start-interview-btn {
            background: #dc2626;
        }

        #start-interview-btn:hover {
            background: #b91c1c;
        }

        /* Main Content */
        .main-content {
            margin-left: 0;
            flex: 1;
            padding: 2rem;
            max-width: 100%;
        }

        .header {
            display: none;
        }

        .header-left {
            display: flex;
            align-items: center;
        }

        .home-link {
            color: #000000;
            text-decoration: none;
            margin-right: 1rem;
            font-weight: 600;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            transition: background-color 0.2s ease;
        }

        .home-link:hover {
            background-color: #f0f0f0;
            text-decoration: none;
        }

        .header h1 {
            color: #000000;
            font-size: 1.5rem;
            font-weight: 600;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            background: #000000;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }

        /* Content Sections */
        .content-section {
            display: none;
            width: 100%;
        }

        .content-section.active {
            display: block;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
            padding-bottom: 0.25rem;
            border-bottom: 1px solid #cccccc;
        }

        .header-actions {
            display: flex;
            gap: 0.75rem;
            align-items: center;
        }

        .section-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #000000;
        }

        .btn {
            padding: 0.9rem 1rem;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            text-decoration: none;
            display: inline-block;
        }

        .btn-primary {
            background: #2563eb;
            color: white;
        }

        .btn-primary:hover {
            background: #1d4ed8;
        }

        .btn-success {
            background: #2563eb;
            color: white;
        }

        .btn-success:hover {
            background: #1d4ed8;
        }

        .btn-danger {
            background: #2563eb;
            color: white;
        }

        .btn-danger:hover {
            background: #1d4ed8;
        }

        /* Compact Filter Toggle Button */
        .btn-filter-toggle {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            background: #000000;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.875rem;
            transition: all 0.3s ease;
        }

        .btn-filter-toggle:hover {
            background: #333333;
            transform: translateY(-1px);
        }

        .filter-icon {
            font-size: 1rem;
        }

        .filter-text {
            font-weight: 500;
        }

        /* Filter Panel */
        .filter-panel {
            position: fixed;
            top: 0;
            right: -400px;
            width: 400px;
            height: 100vh;
            background: white;
            box-shadow: -2px 0 10px rgba(0, 0, 0, 0.1);
            z-index: 1001;
            transition: right 0.3s ease;
            overflow-y: auto;
        }

        .filter-panel.active {
            right: 0;
        }

        .filter-panel-header {
            background: #000000;
            color: white;
            padding: 1rem 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #333333;
        }

        .filter-panel-header h3 {
            margin: 0;
            font-size: 1.2rem;
            flex: 1;
        }

        .filter-panel-content {
            padding: 1.5rem;
        }

        /* Filter Panel Overlay - separate from detail panel overlay */
        .filter-panel-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 400px; /* Don't cover the filter panel */
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease;
        }

        .filter-panel-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        /* Filter Panel Sections */
        .filter-panel .filter-section,
        .filter-panel .sort-section,
        .filter-panel .group-by-section {
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 6px;
            margin-bottom: 1rem;
        }

        .filter-panel .filter-section-title {
            font-weight: 600;
            margin-bottom: 0.75rem;
            color: #333333;
            font-size: 0.9rem;
        }

        .filter-panel .filter-row {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .filter-panel .filter-group {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .filter-panel .filter-group label {
            font-size: 0.8rem;
            font-weight: 500;
            color: #555555;
        }

        .filter-panel .form-input,
        .filter-panel .form-select {
            padding: 0.5rem;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 0.8rem;
            width: 100%;
        }

        .filter-panel .sort-options,
        .filter-panel .group-by-options {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .filter-panel .sort-option {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .filter-panel .group-by-option {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .filter-panel .group-by-option label {
            font-size: 0.8rem;
            cursor: pointer;
            margin: 0;
        }

        .filter-panel .filter-actions {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid #dee2e6;
        }

        .filter-panel .btn-filter,
        .filter-panel .btn-clear,
        .filter-panel .btn-export,
        .filter-panel .btn {
            width: 100%;
            padding: 0.75rem;
            border-radius: 4px;
            border: none;
            cursor: pointer;
            font-size: 0.875rem;
            transition: background 0.2s;
        }

        /* Tables */
        .table-container {
            overflow-x: auto;
            margin-top: 1rem;
        }

        .table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }

        .table th,
        .table td {
            padding: 0.4rem 0.6rem;
            text-align: left;
            border-bottom: 1px solid #cccccc;
            font-size: 0.8rem;
        }

        .table th {
            background: #f8fafc;
            font-weight: 600;
            color: #374151;
            font-size: 0.75rem;
        }

        /* Compact table styling for edit functionality */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.8rem;
        }

        .data-table th,
        .data-table td {
            padding: 0.35rem 0.5rem;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
            vertical-align: middle;
        }

        .data-table th {
            background: #f8fafc;
            font-weight: 600;
            color: #374151;
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .data-table tr:hover {
            background: #f9fafb;
        }

        .data-table tr.editing {
            background: #fef3c7;
        }
        
        /* Reduce width of question column in questions table */
        #questions .data-table th[data-field="question"],
        #questions .data-table td[data-field="question"] {
            max-width: 600px;
            width: 600px;
            white-space: wrap;
        }

        /* Loading Spinner Overlay */
        .loading-overlay {
            position: relative;
            min-height: 200px;
        }
        
        .loading-spinner {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 40px;
            height: 40px;
            border: 4px solid #f3f4f6;
            border-top: 4px solid #2563eb;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            z-index: 10;
        }
        
        @keyframes spin {
            0% { transform: translate(-50%, -50%) rotate(0deg); }
            100% { transform: translate(-50%, -50%) rotate(360deg); }
        }
        
        .loading-overlay .table-container {
            opacity: 0.3;
            pointer-events: none;
        }

        /* Icon buttons */
        .icon-btn {
            background: none;
            border: none;
            padding: 0.25rem;
            margin: 0 0.125rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.875rem;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 28px;
            height: 28px;
        }

        .icon-btn:hover {
            background: #f3f4f6;
            transform: scale(1.1);
        }

        .edit-btn {
            color: #2563eb;
        }

        .edit-btn:hover {
            background: #dbeafe;
            color: #1d4ed8;
        }

        .delete-btn {
            color: #dc2626;
        }

        .delete-btn:hover {
            background: #fef2f2;
            color: #b91c1c;
        }

        .save-btn {
            color: #059669;
        }

        .save-btn:hover {
            background: #d1fae5;
            color: #047857;
        }

        .cancel-btn {
            color: #6b7280;
        }

        .cancel-btn:hover {
            background: #f3f4f6;
            color: #374151;
        }

        /* Ensure edit icons in question/answer sections are exactly 16x16 */
        .edit-question-btn img,
        .edit-answer-btn img {
            width: 16px !important;
            height: 16px !important;
            max-width: 16px !important;
            max-height: 16px !important;
        }

        /* Edit form styling */
        .edit-form {
            display: none;
        }

        .edit-form.active {
            display: block;
        }

        .edit-input {
            width: 100%;
            padding: 0.25rem 0.5rem;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            font-size: 0.85rem;
            background: white;
        }

        .edit-input:focus {
            outline: none;
            border-color: #2563eb;
            box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.1);
        }

        .edit-select {
            width: 100%;
            padding: 0.25rem 0.5rem;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            font-size: 0.85rem;
            background: white;
        }

        /* Bulk edit controls */
        .bulk-edit-controls {
            display: none; /* Hidden until selection exists */
            padding: 1rem;
            background: #f8fafc;
            border-bottom: 1px solid #e5e7eb;
            align-items: center;
            gap: 1rem;
            position: sticky;
            top: 0;
            z-index: 5;
        }
        .bulk-edit-controls.active { display: flex; }

        .bulk-edit-info {
            color: #6b7280;
            font-size: 0.875rem;
        }

        .bulk-edit-actions {
            display: flex;
            gap: 0.5rem;
        }

        /* Checkbox styling */
        .row-checkbox {
            width: 16px;
            height: 16px;
            cursor: pointer;
        }

        /* Remove floating bulk actions approach */

        /* Modal styling for bulk edit */
        .bulk-edit-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .bulk-edit-modal.active {
            display: flex;
        }

        /* Bulk Import Styles */
        .form-help {
            font-size: 0.85rem;
            color: #6b7280;
            margin-top: 0.25rem;
        }

        .format-info {
            background: #f3f4f6;
            padding: 1rem;
            border-radius: 6px;
            margin-top: 0.5rem;
        }

        .format-info p {
            margin: 0.25rem 0;
            font-size: 0.9rem;
        }

        .import-preview {
            margin-top: 1rem;
            padding: 1rem;
            background: #f9fafb;
            border-radius: 6px;
            border: 1px solid #e5e7eb;
        }

        .import-preview h4 {
            margin: 0 0 0.5rem 0;
            color: #374151;
        }

        .preview-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem;
        }

        .preview-table th,
        .preview-table td {
            padding: 0.5rem;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
        }

        .preview-table th {
            background: #f3f4f6;
            font-weight: 600;
        }

        .import-progress {
            margin-top: 1rem;
            padding: 1rem;
            background: #f0f9ff;
            border-radius: 6px;
            border: 1px solid #0ea5e9;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e5e7eb;
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 0.5rem;
        }

        .progress-fill {
            height: 100%;
            background: #0ea5e9;
            width: 0%;
            transition: width 0.3s ease;
        }

        .progress-text {
            font-size: 0.9rem;
            color: #0c4a6e;
            text-align: center;
        }

        .import-results {
            margin-top: 1rem;
            padding: 1rem;
            border-radius: 6px;
            border: 1px solid #e5e7eb;
        }

        .import-results h4 {
            margin: 0 0 0.5rem 0;
            color: #374151;
        }

        .results-success {
            background: #f0fdf4;
            border-color: #22c55e;
        }

        .results-error {
            background: #fef2f2;
            border-color: #ef4444;
        }

        .results-warning {
            background: #fffbeb;
            border-color: #f59e0b;
        }

        .bulk-edit-content {
            background: white;
            border-radius: 8px;
            padding: 2rem;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .bulk-edit-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .bulk-edit-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: #111827;
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #6b7280;
        }

        .bulk-edit-form {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .form-label {
            font-weight: 500;
            color: #374151;
            font-size: 0.875rem;
        }

        .form-input,
        .form-select,
        .form-textarea {
            padding: 0.5rem;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            font-size: 0.875rem;
        }

        .form-input:focus,
        .form-select:focus,
        .form-textarea:focus {
            outline: none;
            border-color: #2563eb;
            box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.1);
        }

        .bulk-edit-footer {
            display: flex;
            justify-content: flex-end;
            gap: 0.75rem;
            margin-top: 1.5rem;
            padding-top: 1rem;
            border-top: 1px solid #e5e7eb;
        }

        .btn {
            padding: 0.5rem 1rem;
            border-radius: 4px;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .btn-primary {
            background: #2563eb;
            color: white;
            border: none;
        }

        .btn-primary:hover {
            background: #1d4ed8;
        }
        .btn-secondary {
            background: #2563eb;
            color: white;
            border: none;
        }

        .btn-secondary:hover {
            background: #1d4ed8;
        }

        .table th {
            background: #f5f5f5;
            font-weight: 600;
            color: #000000;
        }

        .table tbody tr:hover {
            background: #f5f5f5;
        }

        .status-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-completed {
            background: #c6f6d5;
            color: #22543d;
        }

        .status-in-progress {
            background: #bee3f8;
            color: #2a4365;
        }

        .status-cancelled {
            background: #fed7d7;
            color: #742a2a;
        }

        /* Forms */
        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: #000000;
        }

        .form-input,
        .form-textarea,
        .form-select {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #cccccc;
            border-radius: 6px;
            font-size: 1rem;
            transition: border-color 0.2s ease;
        }

        .form-input:focus,
        .form-textarea:focus,
        .form-select:focus {
            outline: none;
            border-color: #000000;
        }

        .form-textarea {
            resize: vertical;
            min-height: 100px;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            padding: 2rem;
            border-radius: 8px;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
        }

        /* Panelist Selection Styles */
        .panelist-container {
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 1rem;
            background: #f9f9f9;
        }

        .panelist-search-container {
            position: relative;
            margin-bottom: 1rem;
        }

        .search-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #ddd;
            border-top: none;
            border-radius: 0 0 6px 6px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
        }

        .search-result-item {
            padding: 0.75rem;
            cursor: pointer;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .search-result-item:hover {
            background: #f0f0f0;
        }

        .search-result-item:last-child {
            border-bottom: none;
        }

        .search-result-info {
            flex: 1;
        }

        .search-result-name {
            font-weight: 600;
            color: #333;
        }

        .search-result-email {
            font-size: 0.875rem;
            color: #666;
        }

        .add-new-interviewer {
            background: #007bff;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.875rem;
            margin-left: 0.5rem;
        }

        .add-new-interviewer:hover {
            background: #0056b3;
        }

        .selected-panelists h4 {
            margin: 0 0 0.5rem 0;
            color: #333;
            font-size: 1rem;
        }

        .selected-list {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .selected-panelist {
            background: #e3f2fd;
            border: 1px solid #2196f3;
            border-radius: 20px;
            padding: 0.5rem 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
        }

        .selected-panelist-name {
            color: #1976d2;
            font-weight: 500;
        }

        .remove-panelist {
            background: none;
            border: none;
            color: #1976d2;
            cursor: pointer;
            font-size: 1.2rem;
            line-height: 1;
            padding: 0;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .remove-panelist:hover {
            color: #d32f2f;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid #cccccc;
        }

        .modal-title {
            font-size: 1.25rem;
            font-weight: 600;
        }

        .close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #a0aec0;
        }

        .close:hover {
            color: #000000;
        }

        /* Detail Panel Styles - Larger width up to half page */
        .detail-panel {
            position: fixed;
            top: 0;
            right: -50%;
            width: 50%;
            min-width: 600px;
            max-width: 800px;
            height: 100vh;
            background: white;
            border-left: 2px solid #000000;
            box-shadow: -5px 0 15px rgba(0,0,0,0.3);
            z-index: 2000;
            transition: right 0.3s ease-in-out;
            overflow-y: auto;
        }

        .detail-panel.active {
            right: 0;
        }

        .detail-panel-header {
            background: #000000;
            color: white;
            padding: 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .detail-panel-title {
            font-size: 1.25rem;
            font-weight: 600;
            margin: 0;
        }

        .detail-panel-close {
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .detail-panel-close:hover {
            background: rgba(255,255,255,0.1);
            border-radius: 4px;
        }

        .detail-panel-content {
            padding: 1.5rem;
        }

        .detail-section {
            margin-bottom: 2rem;
        }

        .detail-section-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #000000;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid #cccccc;
        }

        .detail-item {
            margin-bottom: 1rem;
        }

        .detail-label {
            font-weight: 600;
            color: #666666;
            font-size: 0.875rem;
            margin-bottom: 0.25rem;
        }

        .detail-value {
            color: #000000;
            font-size: 0.95rem;
        }

        /* Interview List Styles */
        .interview-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .interview-item {
            border: 1px solid #cccccc;
            border-radius: 6px;
            margin-bottom: 1rem;
            overflow: hidden;
        }

        .interview-header {
            background: #f8f8f8;
            padding: 1rem;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background 0.2s ease;
        }

        .interview-header:hover {
            background: #f0f0f0;
        }

        .interview-header.active {
            background: #e0e0e0;
        }

        .interview-title {
            font-weight: 600;
            color: #000000;
            margin: 0;
        }

        .interview-meta {
            font-size: 0.875rem;
            color: #666666;
            margin-top: 0.25rem;
        }

        .interview-expand {
            font-size: 1.2rem;
            color: #666666;
            transition: transform 0.2s ease;
        }

        .interview-expand.expanded {
            transform: rotate(180deg);
        }

        /* Consolidation detail panel - details/summary arrow rotation */
        #cons-detail-panel details summary {
            list-style: none;
        }
        
        #cons-detail-panel details summary::-webkit-details-marker {
            display: none;
        }
        
        #cons-detail-panel details summary::marker {
            display: none;
        }
        
        #cons-detail-panel details summary .arrow {
            display: inline-block;
            transition: transform 0.2s ease;
            transform: rotate(0deg);
        }
        
        #cons-detail-panel details[open] summary .arrow {
            transform: rotate(90deg);
        }

        .interview-details {
            padding: 1rem;
            border-top: 1px solid #cccccc;
            background: white;
            display: none;
        }

        .interview-details.active {
            display: block;
        }

        .question-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .question-item {
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            margin-bottom: 0.75rem;
            overflow: hidden;
        }

        .question-header {
            background: #f5f5f5;
            padding: 0.75rem;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .question-text {
            font-weight: 500;
            color: #000000;
            margin: 0;
            font-size: 0.9rem;
        }

        .question-expand {
            font-size: 1rem;
            color: #666666;
            transition: transform 0.2s ease;
        }

        .question-expand.expanded {
            transform: rotate(180deg);
        }

        .question-details {
            padding: 0.75rem;
            background: white;
            display: none;
        }

        .question-details.active {
            display: block;
        }

        .answer-section {
            margin-top: 0.75rem;
        }

        .answer-label {
            font-weight: 600;
            color: #666666;
            font-size: 0.875rem;
            margin-bottom: 0.5rem;
        }

        .answer-text {
            color: #000000;
            font-size: 0.9rem;
            line-height: 1.4;
            background: #f8f8f8;
            padding: 0.75rem;
            border-radius: 4px;
            border-left: 3px solid #000000;
        }

        .answer-image {
            width: 200px;
            height: 200px;
            object-fit: contain;
            object-position: center;
            background-color: #f8f9fa;
            border: 1px solid #cccccc;
            border-radius: 4px;
            margin-top: 0.5rem;
            cursor: pointer;
        }

        .photo-gallery {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }
        
        .photo-item {
            position: relative;
            display: inline-block;
        }
        
        .photo-item img {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border-radius: 4px;
            border: 1px solid #d1d5db;
            cursor: pointer;
        }

        /* Role and Status Badges */
        .role-badge, .status-badge {
            padding: 0.25rem 0.5rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.025em;
        }

        .role-superadmin {
            background-color: #fef3c7;
            color: #92400e;
        }

        .role-admin {
            background-color: #dbeafe;
            color: #1e40af;
        }

        .role-interviewer {
            background-color: #d1fae5;
            color: #065f46;
        }

        .status-active {
            background-color: #d1fae5;
            color: #065f46;
        }

        .status-inactive {
            background-color: #f3f4f6;
            color: #6b7280;
        }

        .status-suspended {
            background-color: #fee2e2;
            color: #dc2626;
        }
        
        /* Group headers for filtering */
        .group-header { background: #2d3748; color: white; font-weight: 600; }
        .group-title { padding: 12px 16px; color: white; border-bottom: 2px solid #4a5568; }
        .group-title:first-child { border-top: 2px solid #4a5568; }
        
        /* User Action Menu Styles */
        .action-menu-container { position: relative; display: inline-block; }
        .menu-btn { background: #f3f4f6; border: 1px solid #d1d5db; color: #374151; font-size: 16px; font-weight: bold; }
        .menu-btn:hover { background: #e5e7eb; }
        .user-action-menu { 
            position: absolute; 
            top: 100%; 
            right: 0; 
            background: #ffffff; 
            border: 1px solid #e5e7eb; 
            border-radius: 8px; 
            box-shadow: 0 10px 20px rgba(0,0,0,0.1); 
            z-index: 1000; 
            min-width: 160px; 
            padding: 4px 0;
        }
        .user-action-menu.hidden { display: none; }
        .menu-item { 
            width: 100%; 
            background: #ffffff; 
            border: none; 
            text-align: left; 
            padding: 8px 12px; 
            cursor: pointer; 
            font-size: 14px; 
            color: #374151;
            transition: background-color 0.2s;
        }
        .menu-item:hover { background: #f3f4f6; }
        .menu-item:first-child { border-top-left-radius: 8px; border-top-right-radius: 8px; }
        .menu-item:last-child { border-bottom-left-radius: 8px; border-bottom-right-radius: 8px; }
        
        .question-answer-item {
            margin-bottom: 1rem;
            padding: 1rem;
            background: #f7fafc;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
        }
        
        .question-header, .answer-section {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 0.5rem;
        }
        
        /* Images specifically in question headers */
        .question-header img {
            width: 200px !important;
            height: 200px !important;
            object-fit: contain !important;
            object-position: center !important;
            background-color: #f8f9fa !important;
            border: 1px solid #ddd !important;
            border-radius: 4px !important;
            display: block !important;
            margin: 10px 0 !important;
        }
        
        .question-header p, .answer-section p {
            flex: 1;
            margin: 0;
            margin-right: 0.5rem;
        }
        
        .question-text-display, .answer-text-display {
            word-wrap: break-word;
        }
        
        /* Rich content wrapper for AI-generated questions with multiple elements */
        .rich-content-wrapper {
            display: block;
            margin-top: 0.5rem;
        }
        
        .rich-content-wrapper p {
            margin: 0.25rem 0;
        }
        
        .rich-content-wrapper p:first-child {
            margin-top: 0;
        }
        
        .rich-content-wrapper p:last-child {
            margin-bottom: 0;
        }
        
        /* Fixed images in detail panel - 200x200 with aspect ratio preserved */
        .question-text-display img, .answer-text-display img {
            width: 200px !important;
            height: 200px !important;
            display: block;
            margin: 10px 0;
            object-fit: contain;
            object-position: center;
            background-color: #f8f9fa;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        /* Ensure rich content images are also properly sized */
        .question-text-display p img, .answer-text-display p img,
        .question-text-display div img, .answer-text-display div img {
            width: 200px !important;
            height: 200px !important;
            max-width: 200px !important;
            max-height: 200px !important;
            object-fit: contain !important;
            object-position: center !important;
            background-color: #f8f9fa !important;
            border: 1px solid #ddd !important;
            border-radius: 4px !important;
            display: block !important;
            margin: 10px 0 !important;
        }
        
        .question-edit-input, .answer-edit-input {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
        }
        
        /* Rich text editor styles for edit mode */
        .rich-text-editor-container {
            width: 100%;
            margin: 0.5rem 0;
        }
        
        .rich-text-editor-container .ql-editor {
            min-height: 120px;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .rich-text-editor-container .ql-editor img {
            width: 200px;
            height: 200px;
            object-fit: contain;
            object-position: center;
            background-color: #f8f9fa;
            border: 1px solid #ddd;
            border-radius: 4px;
            display: block;
            margin: 10px 0;
        }
        
        .edit-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        .panel-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1500;
            display: none;
        }

        .panel-overlay.active {
            display: block;
        }

        /* Image Modal Styles */
        .image-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            z-index: 3000;
            display: none;
            align-items: center;
            justify-content: center;
        }

        .image-modal.active {
            display: flex;
        }

        .image-modal-content {
            max-width: 90%;
            max-height: 90%;
            position: relative;
        }

        .image-modal img {
            max-width: 100%;
            max-height: 100%;
            border-radius: 8px;
        }

        .image-modal-close {
            position: absolute;
            top: -40px;
            right: 0;
            background: none;
            border: none;
            color: white;
            font-size: 2rem;
            cursor: pointer;
            padding: 0;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .image-modal-close:hover {
            background: rgba(255,255,255,0.1);
            border-radius: 4px;
        }

        /* Stats Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: white;
            padding: 1.5rem;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            border-left: 4px solid #000000;
        }
        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: #000000;
            margin-bottom: 0.5rem;
        }
        .stat-label {
            color: #666666;
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        /* Loading and Empty States */
        .loading {
            text-align: center;
            padding: 2rem;
            color: #666666;
        }

        .empty-state {
            text-align: center;
            padding: 3rem;
            color: #666666;
        }

        .empty-state i {
            font-size: 3rem;
            margin-bottom: 1rem;
            color: #cccccc;
        }

        /* Controls Panel */
        .controls-panel {
            background: #f8f8f8;
            border: 1px solid #cccccc;
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .controls-row {
            display: flex;
            gap: 1.5rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }

        .controls-row:last-child {
            margin-bottom: 0;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            min-width: 200px;
            flex: 1;
        }

        .control-group .form-label {
            font-size: 0.875rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: #000000;
        }

        .control-group .form-select,
        .control-group .form-input {
            padding: 0.5rem;
            font-size: 0.875rem;
        }

        /* Enhanced Filter Styles */
        .filter-section {
            margin-bottom: 1.5rem;
        }

        .filter-section-title {
            font-weight: 600;
            margin-bottom: 0.75rem;
            color: #495057;
            font-size: 1rem;
            border-bottom: 2px solid #007bff;
            padding-bottom: 0.25rem;
        }

        .filter-row {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
            align-items: end;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            min-width: 150px;
        }

        .filter-group label {
            font-weight: 600;
            margin-bottom: 0.25rem;
            color: #495057;
            font-size: 0.875rem;
        }

        .filter-group select,
        .filter-group input {
            padding: 0.5rem;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 0.875rem;
            background: white;
        }

        .filter-group input[type="text"] {
            min-width: 200px;
        }

        .filter-group input[type="number"] {
            min-width: 100px;
        }

        /* Sort Section */
        .sort-section {
            background: #fff3cd;
            padding: 1rem;
            border-radius: 6px;
            margin-bottom: 1rem;
        }

        .sort-options {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            align-items: center;
        }

        .sort-option {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .sort-option select {
            padding: 0.25rem 0.5rem;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 0.875rem;
            min-width: 150px;
        }

        /* Group By Section */
        .group-by-section {
            background: #e9ecef;
            padding: 1rem;
            border-radius: 6px;
            margin-bottom: 1rem;
        }

        .group-by-options {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            align-items: center;
        }

        .group-by-option {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .group-by-option input[type="radio"] {
            margin: 0;
        }

        .group-by-option label {
            margin: 0;
            font-size: 0.875rem;
            cursor: pointer;
        }

        /* Action Buttons */
        .filter-actions {
            display: flex;
            gap: 0.5rem;
            align-items: center;
            flex-wrap: wrap;
        }

        .btn-filter {
            background: #007bff;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.875rem;
            transition: background 0.2s;
        }

        .btn-filter:hover {
            background: #0056b3;
        }

        .btn-clear {
            background: #6c757d;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.875rem;
            transition: background 0.2s;
        }

        .btn-clear:hover {
            background: #545b62;
        }

        .btn-export {
            background: #28a745;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.875rem;
            transition: background 0.2s;
        }

        .btn-export:hover {
            background: #1e7e34;
        }

        /* Results Summary */
        .results-summary {
            background: #d1ecf1;
            padding: 0.75rem 1rem;
            border-radius: 4px;
            margin-top: 1rem;
            font-size: 0.875rem;
            color: #0c5460;
        }

        .results-summary strong {
            color: #000000;
        }

        /* Grouped Table Styles */
        .grouped-table {
            margin-bottom: 2rem;
        }

        .group-header {
            background: #2d3748;
            color: white;
            padding: 0.75rem 1rem;
            font-weight: 600;
            border-radius: 4px 4px 0 0;
            margin-bottom: 0;
        }

        .group-header .group-count {
            font-size: 0.875rem;
            opacity: 0.8;
            margin-left: 0.5rem;
        }

        .grouped-table .table {
            border-radius: 0 0 4px 4px;
            border-top: none;
        }

        .grouped-table .table th {
            background: #f0f0f0;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
                transition: transform 0.3s ease;
            }

            .sidebar.open {
                transform: translateX(0);
            }

            .main-content {
                margin-left: 0;
            }

            .header {
                padding: 1rem;
            }

            .main-content {
                padding: 1rem;
            }
        }
        
        /* Pagination Styles */
        .pagination-controls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 8px;
            margin: 20px 0;
            padding: 16px;
        }
        
        .pagination-btn {
            padding: 8px 12px;
            border: 1px solid #d1d5db;
            background: #ffffff;
            color: #374151;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s ease;
        }
        
        .pagination-btn:hover {
            background: #f3f4f6;
            border-color: #9ca3af;
        }
        
        .pagination-btn.active {
            background: #3b82f6;
            color: #ffffff;
            border-color: #3b82f6;
        }
        
        .pagination-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .pagination-ellipsis {
            padding: 8px 4px;
            color: #6b7280;
            font-size: 14px;
        }
        
        .pagination-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 16px 0;
            padding: 12px 16px;
            background: #f9fafb;
            border-radius: 8px;
            font-size: 14px;
            color: #374151;
        }
    </style>
    
    <!-- Quill.js for rich text editing -->
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>
</head>
<body>
    <div class="dashboard-container">
        <!-- Unified Header with Navigation -->
        <nav class="sidebar">
            <div class="sidebar-header">
                <a href="/" class="logo">
                    <img src="/logo3.png" alt="BEES Logo" style="height: 40px; width: auto;">
                </a>
            </div>
            <ul class="sidebar-nav">
                <li class="nav-item">
                    <a href="#" class="nav-link active" data-section="overview">
                        Overview
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" data-section="sessions">
                        Interview Sessions
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" data-section="consolidation">
                        Consolidation
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" data-section="student-sessions">
                        Student Sessions
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" data-section="interviews">
                        Interviews
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" data-section="my-interviews">
                        My Interviews
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" data-section="students">
                        Students
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" data-section="users">
                        Users
                    </a>
                </li>
                <li class="nav-item" style="display:flex;align-items:center;gap:8px">
                    <a href="#" class="nav-link" data-section="questions">
                        Questions Analytics
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" data-section="settings" style="display:flex;align-items:center;justify-content:center;padding:0.75rem 1.25rem" title="Settings">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 640 640" fill="currentColor">
                            <path d="M259.1 73.5C262.1 58.7 275.2 48 290.4 48L350.2 48C365.4 48 378.5 58.7 381.5 73.5L396 143.5C410.1 149.5 423.3 157.2 435.3 166.3L503.1 143.8C517.5 139 533.3 145 540.9 158.2L570.8 210C578.4 223.2 575.7 239.8 564.3 249.9L511 297.3C511.9 304.7 512.3 312.3 512.3 320C512.3 327.7 511.8 335.3 511 342.7L564.4 390.2C575.8 400.3 578.4 417 570.9 430.1L541 481.9C533.4 495 517.6 501.1 503.2 496.3L435.4 473.8C423.3 482.9 410.1 490.5 396.1 496.6L381.7 566.5C378.6 581.4 365.5 592 350.4 592L290.6 592C275.4 592 262.3 581.3 259.3 566.5L244.9 496.6C230.8 490.6 217.7 482.9 205.6 473.8L137.5 496.3C123.1 501.1 107.3 495.1 99.7 481.9L69.8 430.1C62.2 416.9 64.9 400.3 76.3 390.2L129.7 342.7C128.8 335.3 128.4 327.7 128.4 320C128.4 312.3 128.9 304.7 129.7 297.3L76.3 249.8C64.9 239.7 62.3 223 69.8 209.9L99.7 158.1C107.3 144.9 123.1 138.9 137.5 143.7L205.3 166.2C217.4 157.1 230.6 149.5 244.6 143.4L259.1 73.5zM320.3 400C364.5 399.8 400.2 363.9 400 319.7C399.8 275.5 363.9 239.8 319.7 240C275.5 240.2 239.8 276.1 240 320.3C240.2 364.5 276.1 400.2 320.3 400z"/>
                        </svg>
                    </a>
                </li>
            </ul>
            <div class="header-actions">
                <button id="start-interview-btn" class="btn" onclick="startInterview()">
                    Start Interview
                </button>
                <div class="user-info" style="position:relative">
                    <div class="user-avatar" id="admin-avatar" style="cursor:pointer;background:#fff;color:#000">A</div>
                    <div id="admin-avatar-menu" style="position:absolute;right:0;top:56px;background:#fff;border:1px solid #e5e7eb;border-radius:8px;box-shadow:0 10px 20px rgba(0,0,0,0.1);display:none;min-width:140px;z-index:10">
                        <button id="admin-logout-btn" style="width:100%;background:#fff;border:none;text-align:left;padding:10px 12px;cursor:pointer">Logout</button>
                    </div>
                </div>
            </div>
        </nav>

        <!-- Main Content -->
        <main class="main-content">

            <!-- Overview Section -->
            <section id="overview" class="content-section active">
                <div class="section-header">
                    <h2 class="section-title">Dashboard Overview</h2>
                    <button class="btn btn-primary" onclick="refreshDashboardCharts()">Refresh Charts</button>
                </div>
                
                <!-- Chart Filters -->
                <div style="background:#f9fafb;padding:1.5rem;border-radius:8px;margin-bottom:2rem;border:1px solid #e5e7eb">
                    <div style="display:flex;gap:1.5rem;flex-wrap:wrap;align-items:center">
                        <div style="display:flex;gap:0.5rem;align-items:center">
                            <label style="font-size:0.875rem;font-weight:500;color:#374151">Date Range:</label>
                            <select id="chart-date-range" class="form-input" style="width:150px" onchange="applyChartFilters()">
                                <option value="all">All Time</option>
                                <option value="today">Today</option>
                                <option value="week">Last 7 Days</option>
                                <option value="month" selected>Last 30 Days</option>
                                <option value="quarter">Last 3 Months</option>
                                <option value="year">Last Year</option>
                                <option value="custom">Custom Range</option>
                            </select>
                        </div>
                        
                        <div id="custom-date-range" style="display:none;gap:0.5rem;align-items:center">
                            <label style="font-size:0.875rem;color:#374151">From:</label>
                            <input type="date" id="chart-date-from" class="form-input" style="width:150px" onchange="applyChartFilters()">
                            <label style="font-size:0.875rem;color:#374151">To:</label>
                            <input type="date" id="chart-date-to" class="form-input" style="width:150px" onchange="applyChartFilters()">
                        </div>
                        
                        <div style="display:flex;gap:0.5rem;align-items:center">
                            <label style="font-size:0.875rem;font-weight:500;color:#374151">Status:</label>
                            <select id="chart-status-filter" class="form-input" style="width:150px" onchange="applyChartFilters()">
                                <option value="all">All Statuses</option>
                                <option value="completed">Completed</option>
                                <option value="in_progress">In Progress</option>
                                <option value="cancelled">Cancelled</option>
                            </select>
                        </div>
                        
                        <div style="display:flex;gap:0.5rem;align-items:center">
                            <label style="font-size:0.875rem;font-weight:500;color:#374151">Verdict:</label>
                            <select id="chart-verdict-filter" class="form-input" style="width:150px" onchange="applyChartFilters()">
                                <option value="all">All Verdicts</option>
                                <option value="Tiger">Tiger</option>
                                <option value="Cow">Cow</option>
                                <option value="Sheep">Sheep</option>
                                <option value="none">Not Yet Assigned</option>
                            </select>
                        </div>
                        
                        <div style="display:flex;gap:0.5rem;align-items:center">
                            <label style="font-size:0.875rem;font-weight:500;color:#374151">Interviewer:</label>
                            <select id="chart-interviewer-filter" class="form-input" style="width:180px" onchange="applyChartFilters()">
                                <option value="all">All Interviewers</option>
                            </select>
                        </div>
                        
                        <button class="btn btn-secondary" onclick="clearChartFilters()" style="margin-left:auto">Clear Filters</button>
                    </div>
                </div>
                
                <!-- Quick Stats Cards -->
                <div class="stats-grid" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:1.5rem;margin-bottom:2rem">
                    <div class="stat-card" style="background:#fff;padding:1.5rem;border-radius:8px;box-shadow:0 2px 4px rgba(0,0,0,0.1)">
                        <div class="stat-value" id="total-interviews" style="font-size:2rem;font-weight:700;color:#1E4ED8">-</div>
                        <div class="stat-label" style="color:#6b7280;font-size:0.875rem;margin-top:0.5rem">Total Interviews</div>
                    </div>
                    <div class="stat-card" style="background:#fff;padding:1.5rem;border-radius:8px;box-shadow:0 2px 4px rgba(0,0,0,0.1)">
                        <div class="stat-value" id="active-sessions" style="font-size:2rem;font-weight:700;color:#10b981">-</div>
                        <div class="stat-label" style="color:#6b7280;font-size:0.875rem;margin-top:0.5rem">Active Sessions</div>
                    </div>
                    <div class="stat-card" style="background:#fff;padding:1.5rem;border-radius:8px;box-shadow:0 2px 4px rgba(0,0,0,0.1)">
                        <div class="stat-value" id="total-questions" style="font-size:2rem;font-weight:700;color:#f59e0b">-</div>
                        <div class="stat-label" style="color:#6b7280;font-size:0.875rem;margin-top:0.5rem">Total Questions</div>
                    </div>
                    <div class="stat-card" style="background:#fff;padding:1.5rem;border-radius:8px;box-shadow:0 2px 4px rgba(0,0,0,0.1)">
                        <div class="stat-value" id="total-students" style="font-size:2rem;font-weight:700;color:#8b5cf6">-</div>
                        <div class="stat-label" style="color:#6b7280;font-size:0.875rem;margin-top:0.5rem">Total Students</div>
                    </div>
                </div>

                <!-- Charts Grid -->
                <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(450px,1fr));gap:2rem;margin-top:2rem">
                    <!-- Interview Status Distribution -->
                    <div style="background:#fff;padding:1.5rem;border-radius:8px;box-shadow:0 2px 4px rgba(0,0,0,0.1)">
                        <h3 style="font-size:1.1rem;font-weight:600;margin-bottom:0.75rem;color:#111827">Interview Status Distribution</h3>
                        <div style="display:flex;gap:0.5rem;margin-bottom:1rem;flex-wrap:wrap">
                            <select id="status-date-filter" class="form-input" style="font-size:0.85rem;padding:0.4rem 0.6rem;width:auto" onchange="updateStatusChart()">
                                <option value="all">All Time</option>
                                <option value="week">Last 7 Days</option>
                                <option value="month" selected>Last 30 Days</option>
                                <option value="quarter">Last 3 Months</option>
                            </select>
                            <select id="status-interviewer-filter" class="form-input" style="font-size:0.85rem;padding:0.4rem 0.6rem;width:auto" onchange="updateStatusChart()">
                                <option value="all">All Interviewers</option>
                            </select>
                        </div>
                        <canvas id="statusChart" style="max-height:300px"></canvas>
                    </div>

                    <!-- Interview Outcome Distribution -->
                    <div style="background:#fff;padding:1.5rem;border-radius:8px;box-shadow:0 2px 4px rgba(0,0,0,0.1)">
                        <h3 style="font-size:1.1rem;font-weight:600;margin-bottom:0.75rem;color:#111827">Interview Outcome Distribution</h3>
                        <div style="display:flex;gap:0.5rem;margin-bottom:1rem;flex-wrap:wrap">
                            <select id="verdict-session-filter" class="form-input" style="font-size:0.85rem;padding:0.4rem 0.6rem;width:auto" onchange="updateVerdictChart()">
                                <option value="all">All Sessions</option>
                            </select>
                            <select id="verdict-status-filter" class="form-input" style="font-size:0.85rem;padding:0.4rem 0.6rem;width:auto" onchange="updateVerdictChart()">
                                <option value="all">All Statuses</option>
                                <option value="completed">Completed</option>
                                <option value="in_progress">In Progress</option>
                            </select>
                        </div>
                        <canvas id="verdictChart" style="max-height:300px"></canvas>
                    </div>
                </div>

                <!-- Interview Trends -->
                <div style="background:#fff;padding:1.5rem;border-radius:8px;box-shadow:0 2px 4px rgba(0,0,0,0.1);margin-top:2rem">
                    <h3 style="font-size:1.1rem;font-weight:600;margin-bottom:0.75rem;color:#111827">Interviews Conducted Over Time</h3>
                    <div style="display:flex;gap:0.5rem;margin-bottom:1rem;flex-wrap:wrap">
                        <select id="trends-range-filter" class="form-input" style="font-size:0.85rem;padding:0.4rem 0.6rem;width:auto" onchange="updateTrendsChart()">
                            <option value="week">Last 7 Days</option>
                            <option value="month" selected>Last 30 Days</option>
                            <option value="quarter">Last 3 Months</option>
                            <option value="year">Last Year</option>
                        </select>
                        <select id="trends-verdict-filter" class="form-input" style="font-size:0.85rem;padding:0.4rem 0.6rem;width:auto" onchange="updateTrendsChart()">
                            <option value="all">All Verdicts</option>
                            <option value="Tiger">Tiger</option>
                            <option value="Cow">Cow</option>
                            <option value="Sheep">Sheep</option>
                        </select>
                    </div>
                    <canvas id="trendsChart" style="max-height:250px"></canvas>
                </div>

                <!-- Student Sessions Status Chart -->
                <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(450px,1fr));gap:2rem;margin-top:2rem">
                    <!-- Student Sessions Status by Session -->
                    <div style="background:#fff;padding:1.5rem;border-radius:8px;box-shadow:0 2px 4px rgba(0,0,0,0.1)">
                        <h3 style="font-size:1.1rem;font-weight:600;margin-bottom:0.75rem;color:#111827">Student Sessions Status by Session</h3>
                        <div style="display:flex;gap:0.5rem;margin-bottom:1rem;flex-wrap:wrap">
                            <select id="student-sessions-session-filter" class="form-input" style="font-size:0.85rem;padding:0.4rem 0.6rem;width:auto" onchange="updateStudentSessionsChart()">
                                <option value="all">All Sessions</option>
                            </select>
                            <select id="student-sessions-year-filter" class="form-input" style="font-size:0.85rem;padding:0.4rem 0.6rem;width:auto" onchange="updateStudentSessionsChart()">
                                <option value="all">All Years</option>
                            </select>
                        </div>
                        <canvas id="studentSessionsChart" style="max-height:400px"></canvas>
                    </div>
                </div>

                <!-- Verdict Distribution by Round -->
                <div style="background:#fff;padding:1.5rem;border-radius:8px;box-shadow:0 2px 4px rgba(0,0,0,0.1);margin-top:2rem">
                    <h3 style="font-size:1.1rem;font-weight:600;margin-bottom:0.75rem;color:#111827">Verdict Distribution by Round</h3>
                    <div style="display:flex;gap:0.5rem;margin-bottom:1rem;flex-wrap:wrap">
                        <select id="round-verdict-session-filter" class="form-input" style="font-size:0.85rem;padding:0.4rem 0.6rem;width:auto" onchange="updateRoundVerdictChart()">
                            <option value="all">All Sessions</option>
                        </select>
                        <select id="round-verdict-student-filter" class="form-input" style="font-size:0.85rem;padding:0.4rem 0.6rem;width:auto" onchange="updateRoundVerdictChart()">
                            <option value="all">All Students</option>
                        </select>
                    </div>
                    <canvas id="roundVerdictChart" style="max-height:400px"></canvas>
                </div>

                <!-- Question Categories -->
                <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(450px,1fr));gap:2rem;margin-top:2rem">
                    <!-- Category Distribution -->
                    <div style="background:#fff;padding:1.5rem;border-radius:8px;box-shadow:0 2px 4px rgba(0,0,0,0.1)">
                        <h3 style="font-size:1.1rem;font-weight:600;margin-bottom:0.75rem;color:#111827">Question Categories Distribution</h3>
                        <div style="display:flex;gap:0.5rem;margin-bottom:1rem;flex-wrap:wrap">
                            <select id="categories-usage-filter" class="form-input" style="font-size:0.85rem;padding:0.4rem 0.6rem;width:auto" onchange="updateCategoriesChart()">
                                <option value="all">All Questions</option>
                                <option value="used">Used in Interviews</option>
                                <option value="unused">Not Yet Used</option>
                            </select>
                        </div>
                        <canvas id="categoriesChart" style="max-height:300px"></canvas>
                    </div>

                    <!-- Average Scores by Category -->
                    <div style="background:#fff;padding:1.5rem;border-radius:8px;box-shadow:0 2px 4px rgba(0,0,0,0.1)">
                        <h3 style="font-size:1.1rem;font-weight:600;margin-bottom:0.75rem;color:#111827">Average Scores by Category</h3>
                        <div style="display:flex;gap:0.5rem;margin-bottom:1rem;flex-wrap:wrap">
                            <select id="scores-metric-filter" class="form-input" style="font-size:0.85rem;padding:0.4rem 0.6rem;width:auto" onchange="updateScoresChart()">
                                <option value="avg">Average Score</option>
                                <option value="success">Success Rate %</option>
                            </select>
                        </div>
                        <canvas id="scoresChart" style="max-height:300px"></canvas>
                    </div>
                </div>
            </section>

            <!-- Interviews Section -->
            <section id="interviews" class="content-section">
                <div class="section-header">
                    <h2 class="section-title">All Interviews</h2>
                    <div class="header-actions">
                        <input type="text" id="interviews-inline-search" class="form-input" placeholder="Search..." oninput="displayInterviews()" style="max-width:220px">
                        <button class="btn btn-primary" onclick="refreshInterviews()">Refresh</button>
                    </div>
                </div>
                
                <!-- Results Summary -->
                <div id="results-summary" class="results-summary" style="display: none;">
                    <strong>0</strong> interviews found
                </div>
                <!-- Advanced Filters (compact) -->
                <div id="advanced-filters" class="adv-filters">
                    <span class="adv-label">where</span>
                    <div id="filters-container" class="filters-container"></div>
                    <div class="filters-actions">
                        <button class="btn btn-secondary btn-compact" onclick="addFilterRow()">+ Add filter</button>
                        <button class="link-btn" onclick="clearAdvancedFilters()">Clear filters</button>
                    </div>
                </div>
                
                <div class="table-container">
                    <!-- Bulk Edit Controls -->
                    <div class="bulk-edit-controls">
                        <div class="bulk-edit-info" id="bulk-edit-selected-count">0 records selected</div>
                        <div class="bulk-edit-actions">
                            <button class="btn btn-secondary" onclick="selectAllRows()">Select All</button>
                            <button class="btn btn-secondary" onclick="clearSelection()">Clear</button>
                            <button class="btn btn-danger" onclick="bulkDelete()">Bulk Delete</button>
                        </div>
                    </div>
                    
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th><input type="checkbox" onchange="toggleAllRows(this.checked)" title="Select All"></th>
                                <th data-field="student_name" onclick="sortBy('interviews','student_name')">Student <span class="sort-indicator"><span class="asc"></span><span class="desc"></span></span></th>
                                <th data-field="interviewer_name" onclick="sortBy('interviews','interviewer_name')">Interviewer <span class="sort-indicator"><span class="asc"></span><span class="desc"></span></span></th>
                                <th data-field="session_name" onclick="sortBy('interviews','session_name')">Session <span class="sort-indicator"><span class="asc"></span><span class="desc"></span></span></th>
                                <th data-field="created_at" onclick="sortBy('interviews','created_at')">Date <span class="sort-indicator"><span class="asc"></span><span class="desc"></span></span></th>
                                <th data-field="duration_seconds" onclick="sortBy('interviews','duration_seconds')">Duration <span class="sort-indicator"><span class="asc"></span><span class="desc"></span></span></th>
                                <th data-field="status" onclick="sortBy('interviews','status')">Status <span class="sort-indicator"><span class="asc"></span><span class="desc"></span></span></th>
                                <th data-field="verdict" onclick="sortBy('interviews','verdict')">Verdict <span class="sort-indicator"><span class="asc"></span><span class="desc"></span></span></th>
                                <th data-field="meeting_url">URL</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="interviews-table-body">
                            <tr>
                                <td colspan="10" class="loading">Loading interviews...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Questions Analytics Section -->
            <section id="questions" class="content-section">
                <div class="section-header">
                    <h2 class="section-title">Questions Analytics</h2>
                    <div class="header-actions">
                        <input type="text" id="questions-inline-search" class="form-input" placeholder="Search questions..." oninput="displayQuestions()" style="max-width:260px">
                        <button class="btn btn-success" onclick="openAddQuestionModal()">Add Question</button>
                        <button class="btn btn-info" onclick="openBulkImportModal()">Bulk Import</button>
                        <button class="btn btn-primary" onclick="refreshQuestions()">Refresh</button>
                    </div>
                </div>
                
                <!-- Advanced Filters for Questions -->
                <div id="advanced-filters-questions" class="adv-filters">
                    <span class="adv-label">where</span>
                    <div id="filters-container-questions" class="filters-container"></div>
                    <div class="filters-actions">
                        <button class="btn btn-secondary btn-compact" onclick="addQuestionsFilterRow()">+ Add filter</button>
                        <button class="link-btn" onclick="clearAdvancedFiltersQuestions()">Clear filters</button>
                    </div>
                </div>
                
                <div class="table-container">
                    <!-- Bulk Edit Controls -->
                    <div class="bulk-edit-controls">
                        <div class="bulk-edit-info" id="bulk-edit-selected-count">0 records selected</div>
                        <div class="bulk-edit-actions">
                            <button class="btn btn-secondary" onclick="selectAllRows()">Select All</button>
                            <button class="btn btn-secondary" onclick="clearSelection()">Clear</button>
                            <button class="btn btn-danger" onclick="bulkDelete()">Bulk Delete</button>
                        </div>
                    </div>
                    
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th><input type="checkbox" onchange="toggleAllRows(this.checked)" title="Select All"></th>
                                <th data-field="question" onclick="sortBy('questions','question')">Question <span class="sort-indicator"><span class="asc"></span><span class="desc"></span></span></th>
                                <th>Tags</th>
                                <th data-field="times_asked" onclick="sortBy('questions','times_asked')">Times Asked <span class="sort-indicator"><span class="asc"></span><span class="desc"></span></span></th>
                                <th data-field="average_score" onclick="sortBy('questions','average_score')">Avg Score <span class="sort-indicator"><span class="asc"></span><span class="desc"></span></span></th>
                                <th data-field="success_rate" onclick="sortBy('questions','success_rate')">Success Rate <span class="sort-indicator"><span class="asc"></span><span class="desc"></span></span></th>
                                <th>Favorite</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="questions-table-body">
                            <tr>
                                <td colspan="9" class="loading">Loading questions...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Interview Sessions Section -->
            <section id="sessions" class="content-section">
                <div class="section-header">
                    <h2 class="section-title">Interview Sessions</h2>
                    <div class="header-actions">
                        <input type="text" id="sessions-inline-search" class="form-input" placeholder="Search sessions..." oninput="displaySessions()" style="max-width:240px">
                        <button class="btn btn-primary" onclick="openCreateSessionModal()">Create Session</button>
                    </div>
                </div>
                
                <!-- Advanced Filters for Sessions -->
                <div id="advanced-filters-sessions" class="adv-filters">
                    <span class="adv-label">where</span>
                    <div id="filters-container-sessions" class="filters-container"></div>
                    <div class="filters-actions">
                        <button class="btn btn-secondary btn-compact" onclick="addSessionsFilterRow()">+ Add filter</button>
                        <button class="link-btn" onclick="clearAdvancedFiltersSessions()">Clear filters</button>
                    </div>
                </div>
                
                <div class="table-container">
                    <!-- Bulk Edit Controls -->
                    <div class="bulk-edit-controls">
                        <div class="bulk-edit-info" id="bulk-edit-selected-count">0 records selected</div>
                        <div class="bulk-edit-actions">
                            <button class="btn btn-secondary" onclick="selectAllRows()">Select All</button>
                            <button class="btn btn-secondary" onclick="clearSelection()">Clear</button>
                            <button class="btn btn-danger" onclick="bulkDelete()">Bulk Delete</button>
                        </div>
                    </div>
                    
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th><input type="checkbox" onchange="toggleAllRows(this.checked)" title="Select All"></th>
                                <th data-field="name" onclick="sortBy('sessions','name')">Name <span class="sort-indicator"><span class="asc"></span><span class="desc"></span></span></th>
                                <th>Description</th>
                                <th data-field="is_panel" onclick="sortBy('sessions','is_panel')">Type <span class="sort-indicator"><span class="asc"></span><span class="desc"></span></span></th>
                                <th data-field="status" onclick="sortBy('sessions','status')">Status <span class="sort-indicator"><span class="asc"></span><span class="desc"></span></span></th>
                                <th style="width: 200px;">Panelists</th>
                                <th data-field="created_by_name" onclick="sortBy('sessions','created_by_name')">Created By <span class="sort-indicator"><span class="asc"></span><span class="desc"></span></span></th>
                                <th data-field="created_at" onclick="sortBy('sessions','created_at')">Created At <span class="sort-indicator"><span class="asc"></span><span class="desc"></span></span></th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="sessions-table-body">
                            <tr>
                                <td colspan="10" class="loading">Loading sessions...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Students Section -->
            <section id="students" class="content-section">
                <div class="section-header">
                    <h2 class="section-title">Students</h2>
                    <div class="header-actions">
                        <input type="text" id="students-inline-search" class="form-input" placeholder="Search students..." oninput="displayStudents()" style="max-width:240px">
                        <button class="btn btn-info" onclick="openBulkImportStudents()">Bulk Import</button>
                        <button class="btn btn-primary" onclick="refreshStudents()">Refresh</button>
                    </div>
                </div>
                
                <!-- Advanced Filters for Students -->
                <div id="advanced-filters-students" class="adv-filters">
                    <span class="adv-label">where</span>
                    <div id="filters-container-students" class="filters-container"></div>
                    <div class="filters-actions">
                        <button class="btn btn-secondary btn-compact" onclick="addStudentsFilterRow()">+ Add filter</button>
                        <button class="link-btn" onclick="clearAdvancedFiltersStudents()">Clear filters</button>
                    </div>
                </div>
                
                <div class="table-container">
                    <!-- Bulk Delete Controls -->
                    <div class="bulk-edit-controls">
                        <div class="bulk-edit-info" id="bulk-edit-selected-count">0 records selected</div>
                        <div class="bulk-edit-actions">
                            <button class="btn btn-secondary" onclick="selectAllRows()">Select All</button>
                            <button class="btn btn-secondary" onclick="clearSelection()">Clear</button>
                            <button class="btn btn-danger" onclick="bulkDelete()">Bulk Delete</button>
                        </div>
                    </div>
                    
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th><input type="checkbox" onchange="toggleAllRows(this.checked)" title="Select All"></th>
                                <th data-field="name" onclick="sortBy('students','name')">Name <span class="sort-indicator"><span class="asc"></span><span class="desc"></span></span></th>
                                <th data-field="email" onclick="sortBy('students','email')">Email <span class="sort-indicator"><span class="asc"></span><span class="desc"></span></span></th>
                                <th data-field="zeta_id" onclick="sortBy('students','zeta_id')">Zeta ID <span class="sort-indicator"><span class="asc"></span><span class="desc"></span></span></th>
                                <th data-field="phone" onclick="sortBy('students','phone')">Phone <span class="sort-indicator"><span class="asc"></span><span class="desc"></span></span></th>
                                <th>School</th>
                                <th>Location</th>
                                
                                <th>Verdicts</th>
                                <th data-field="created_at" onclick="sortBy('students','created_at')">Created At <span class="sort-indicator"><span class="asc"></span><span class="desc"></span></span></th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="students-table-body">
                            <tr>
                                <td colspan="9" class="loading">Loading students...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- My Interviews Section (Admin's own interviews) -->
            <section id="my-interviews" class="content-section">
                <div class="section-header">
                    <h2 class="section-title">My Interviews</h2>
                    <div class="header-actions">
                        <input type="text" id="my-interviews-inline-search" class="form-input" placeholder="Search..." oninput="loadMyInterviewsForAdmin()" style="max-width:220px">
                        <button class="btn btn-primary" onclick="loadMyInterviewsForAdmin()">Refresh</button>
                    </div>
                </div>
                
                <!-- Advanced Filters for My Interviews -->
                <div id="advanced-filters-myinterviews" class="adv-filters">
                    <span class="adv-label">where</span>
                    <div id="filters-container-myinterviews" class="filters-container"></div>
                    <div class="filters-actions">
                        <button class="btn btn-secondary btn-compact" onclick="addMyInterviewsFilterRow()">+ Add filter</button>
                        <button class="link-btn" onclick="clearAdvancedFiltersMyInterviews()">Clear filters</button>
                    </div>
                </div>
                
                <div class="table-container">
                    <!-- Bulk Edit Controls -->
                    <div class="bulk-edit-controls">
                        <div class="bulk-edit-info" id="bulk-edit-selected-count">0 records selected</div>
                        <div class="bulk-edit-actions">
                            <button class="btn btn-secondary" onclick="selectAllRows()">Select All</button>
                            <button class="btn btn-secondary" onclick="clearSelection()">Clear</button>
                            <button class="btn btn-danger" onclick="bulkDelete()">Bulk Delete</button>
                            <button class="btn btn-primary" onclick="openBulkEditModal()">Bulk Edit</button>
                        </div>
                    </div>
                    
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th><input type="checkbox" onchange="toggleAllRows(this.checked)" title="Select All"></th>
                                <th data-field="created_at" onclick="sortBy('my-interviews','created_at')">Date <span class="sort-indicator"><span class="asc"></span><span class="desc"></span></span></th>
                                <th data-field="student_name" onclick="sortBy('my-interviews','student_name')">Student <span class="sort-indicator"><span class="asc"></span><span class="desc"></span></span></th>
                                <th data-field="zeta_id" onclick="sortBy('my-interviews','zeta_id')">Zeta ID <span class="sort-indicator"><span class="asc"></span><span class="desc"></span></span></th>
                                <th data-field="session_name" onclick="sortBy('my-interviews','session_name')">Session <span class="sort-indicator"><span class="asc"></span><span class="desc"></span></span></th>
                                <th data-field="status" onclick="sortBy('my-interviews','status')">Status <span class="sort-indicator"><span class="asc"></span><span class="desc"></span></span></th>
                                <th data-field="verdict" onclick="sortBy('my-interviews','verdict')">Verdict <span class="sort-indicator"><span class="asc"></span><span class="desc"></span></span></th>
                                <th data-field="duration_seconds" onclick="sortBy('my-interviews','duration_seconds')">Duration <span class="sort-indicator"><span class="asc"></span><span class="desc"></span></span></th>
                                <th data-field="meeting_url">URL</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="my-interviews-table-body">
                            <tr><td colspan="10" class="loading">Loading interviews...</td></tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Student Sessions Section -->
            <section id="student-sessions" class="content-section">
                <div class="section-header">
                    <h2 class="section-title">Student Sessions</h2>
                    <div class="header-actions">
                        <input type="text" id="student-sessions-inline-search" class="form-input" placeholder="Search..." oninput="displayStudentSessions()" style="max-width:220px">
                        <button class="btn-export" onclick="exportData('student-sessions')">Export Data</button>
                        <button class="btn btn-primary" onclick="refreshStudentSessions()">Refresh</button>
                    </div>
                </div>
                
                <!-- Advanced Filters for Student Sessions -->
                <div id="advanced-filters-student-sessions" class="adv-filters">
                    <span class="adv-label">where</span>
                    <div id="filters-container-student-sessions" class="filters-container"></div>
                    <div class="filters-actions">
                        <button class="btn btn-secondary btn-compact" onclick="addStudentSessionsFilterRow()">+ Add filter</button>
                        <button class="link-btn" onclick="clearAdvancedFiltersStudentSessions()">Clear filters</button>
                    </div>
                </div>

                <div class="table-container">
                    <!-- Bulk Edit Controls -->
                    <div class="bulk-edit-controls">
                        <div class="bulk-edit-info" id="bulk-edit-selected-count">0 records selected</div>
                        <div class="bulk-edit-actions">
                            <button class="btn btn-secondary" onclick="selectAllRows()">Select All</button>
                            <button class="btn btn-secondary" onclick="clearSelection()">Clear</button>
                            <button class="btn btn-primary" onclick="openBulkEditModal()">Bulk Edit</button>
                        </div>
                    </div>

                    <table class="data-table">
                        <thead>
                            <tr>
                                <th><input type="checkbox" onchange="toggleAllRows(this.checked)" title="Select All"></th>
                                <th data-field="student_name" onclick="sortBy('student-sessions','student_name')">Student Name <span class="sort-indicator"><span class="asc"></span><span class="desc"></span></span></th>
                                <th data-field="phone" onclick="sortBy('student-sessions','phone')">Phone <span class="sort-indicator"><span class="asc"></span><span class="desc"></span></span></th>
                                <th data-field="email" onclick="sortBy('student-sessions','email')">Email <span class="sort-indicator"><span class="asc"></span><span class="desc"></span></span></th>
                                <th data-field="zeta_id" onclick="sortBy('student-sessions','zeta_id')">Zeta ID <span class="sort-indicator"><span class="asc"></span><span class="desc"></span></span></th>
                                <th data-field="session_name" onclick="sortBy('student-sessions','session_name')">Interview Session <span class="sort-indicator"><span class="asc"></span><span class="desc"></span></span></th>
                                <th data-field="session_status" onclick="sortBy('student-sessions','session_status')">Interview Status <span class="sort-indicator"><span class="asc"></span><span class="desc"></span></span></th>
                                <th data-field="total_score" onclick="sortBy('student-sessions','total_score')">Score <span class="sort-indicator"><span class="asc"></span><span class="desc"></span></span></th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="student-sessions-table-body">
                            <tr>
                                <td colspan="9" class="loading">Loading student sessions...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Users Section -->
            <section id="users" class="content-section">
                <div class="section-header">
                    <h2 class="section-title">Users</h2>
                    <div class="header-actions">
                        <input type="text" id="users-inline-search" class="form-input" placeholder="Search users..." oninput="displayUsers()" style="max-width:220px">
                        <button class="btn btn-primary" onclick="refreshUsers()">Refresh</button>
                    </div>
                </div>
                
                <!-- Advanced Filters for Users -->
                <div id="advanced-filters-users" class="adv-filters">
                    <span class="adv-label">where</span>
                    <div id="filters-container-users" class="filters-container"></div>
                    <div class="filters-actions">
                        <button class="btn btn-secondary btn-compact" onclick="addUsersFilterRow()">+ Add filter</button>
                        <button class="link-btn" onclick="clearAdvancedFiltersUsers()">Clear filters</button>
                    </div>
                </div>
                
                <div class="table-container">
                    <!-- Bulk Edit Controls -->
                    <div class="bulk-edit-controls">
                        <div class="bulk-edit-info" id="bulk-edit-selected-count">0 records selected</div>
                        <div class="bulk-edit-actions">
                            <button class="btn btn-secondary" onclick="selectAllRows()">Select All</button>
                            <button class="btn btn-secondary" onclick="clearSelection()">Clear</button>
                            <button class="btn btn-warning" onclick="openBulkEditModal()">Bulk Edit</button>
                            <button class="btn btn-danger" onclick="bulkDelete()">Bulk Delete</button>
                        </div>
                    </div>
                    
                    <table class="data-table compact-table">
                        <thead>
                            <tr>
                                <th><input type="checkbox" onchange="toggleAllRows(this.checked)" title="Select All"></th>
                                <th data-field="name" onclick="sortBy('users','name')">Name <span class="sort-indicator"><span class="asc"></span><span class="desc"></span></span></th>
                                <th data-field="email" onclick="sortBy('users','email')">Email <span class="sort-indicator"><span class="asc"></span><span class="desc"></span></span></th>
                                <th data-field="role" onclick="sortBy('users','role')">Role <span class="sort-indicator"><span class="asc"></span><span class="desc"></span></span></th>
                                <th data-field="status" onclick="sortBy('users','status')">Status <span class="sort-indicator"><span class="asc"></span><span class="desc"></span></span></th>
                                <th data-field="created_at" onclick="sortBy('users','created_at')">Created At <span class="sort-indicator"><span class="asc"></span><span class="desc"></span></span></th>
                                
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="users-table-body">
                            <tr>
                                <td colspan="9" class="loading">Loading users...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Consolidation Section -->
            <section id="consolidation" class="content-section">
                <div class="section-header">
                    <h2 class="section-title">Consolidation</h2>
                    <div class="header-actions" style="display:flex;gap:8px;align-items:center">
                        <input id="consolidation-search" type="text" class="form-input" placeholder="Search..." oninput="onConsolidationSearch(this.value)" style="max-width:220px">
                        <button class="btn btn-secondary" id="bulk-email-btn" onclick="openBulkEmailPopup()" style="display:none">
                            Send Bulk Email (<span id="bulk-email-count">0</span>)
                        </button>
                        <button class="btn-export" onclick="exportData('consolidation')">Export Data</button>
                        <button class="btn btn-primary" onclick="refreshConsolidation()">Refresh</button>
                    </div>
                </div>

                <!-- Advanced Filters (compact) for Consolidation -->
                <div id="advanced-filters-cons" class="adv-filters">
                    <span class="adv-label">where</span>
                    <div id="filters-container-cons" class="filters-container"></div>
                    <div class="filters-actions">
                        <button class="btn btn-secondary btn-compact" onclick="addConsFilterRow()">+ Add filter</button>
                        <button class="link-btn" onclick="clearAdvancedFiltersCons()">Clear filters</button>
                    </div>
                </div>

                <div class="table-container">
                    <table class="data-table fixed-columns">
                        <thead>
                            <tr>
                                <th style="width:40px"><input type="checkbox" id="consolidation-select-all" onchange="toggleConsolidationSelectAll(this.checked)" title="Select All"></th>
                                <th class="sortable" onclick="setConsolidationSort('student_name')">Student <span class="sort-indicator"><span class="asc"></span><span class="desc"></span></span></th>
                                <th class="sortable" onclick="setConsolidationSort('zeta_id')">Zeta ID <span class="sort-indicator"><span class="asc"></span><span class="desc"></span></span></th>
                                <th class="sortable" onclick="setConsolidationSort('session_name')">Session <span class="sort-indicator"><span class="asc"></span><span class="desc"></span></span></th>
                                <th>Interviewers</th>
                                <th>Verdicts</th>
                                <th>Score</th>
                                <th>Interview Status</th>
                                <th class="sortable" onclick="setConsolidationSort('status')">Status <span class="sort-indicator"><span class="asc"></span><span class="desc"></span></span></th>
                                <th>Notes</th>
                                <th class="sortable" onclick="setConsolidationSort('last_interview_at')">Last Interview <span class="sort-indicator"><span class="asc"></span><span class="desc"></span></span></th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="consolidation-table-body">
                            <tr><td colspan="10" class="loading">Loading consolidation...</td></tr>
                        </tbody>
                    </table>
                </div>
                <!-- Slide-in detail panel -->
                <div id="cons-detail-overlay" style="position:fixed;inset:0;background:rgba(0,0,0,0.35);display:none;z-index:1600"></div>
                <div id="cons-detail-panel" style="position:fixed;top:0;right:-520px;width:520px;height:100%;background:#fff;border-left:1px solid #e5e7eb;box-shadow:-8px 0 24px rgba(0,0,0,0.1);z-index:1700;transition:right 0.25s ease;overflow:auto">                </div>
                
            </section>

            <!-- Settings Section -->
            <section id="settings" class="content-section">
                <div class="section-header">
                    <h2 class="section-title">Settings</h2>
                </div>
                <div style="display:flex;gap:20px;height:calc(100vh - 200px);min-height:600px">
                    <!-- Side Nav -->
                    <div style="width:250px;background:#f9fafb;border:1px solid #e5e7eb;border-radius:8px;padding:20px;overflow-y:auto;flex-shrink:0">
                        <nav style="display:flex;flex-direction:column;gap:8px">
                            <button onclick="showSettingsTab('templates')" id="settings-tab-templates" class="settings-nav-btn" style="width:100%;text-align:left;padding:12px 16px;background:#f3f4f6;color:#6b7280;border:none;border-radius:8px;cursor:pointer;font-size:14px;font-weight:500">
                                Templates
                            </button>
                            <button onclick="showSettingsTab('email-logs')" id="settings-tab-email-logs" class="settings-nav-btn" style="width:100%;text-align:left;padding:12px 16px;background:#f3f4f6;color:#6b7280;border:none;border-radius:8px;cursor:pointer;font-size:14px;font-weight:500">
                                Email Logs
                            </button>
                            <button onclick="showSettingsTab('sms-logs')" id="settings-tab-sms-logs" class="settings-nav-btn" style="width:100%;text-align:left;padding:12px 16px;background:#f3f4f6;color:#6b7280;border:none;border-radius:8px;cursor:pointer;font-size:14px;font-weight:500">
                                SMS Logs
                            </button>
                        </nav>
                    </div>
                    <!-- Main Content -->
                    <div style="flex:1;background:#fff;border:1px solid #e5e7eb;border-radius:8px;padding:30px;overflow-y:auto">
                        <!-- Templates Content -->
                        <div id="settings-content-templates" class="settings-content" style="display:block">
                            <!-- Tab Navigation -->
                            <div style="display:flex;gap:8px;border-bottom:2px solid #e5e7eb;margin-bottom:24px">
                                <button onclick="showTemplateType('email')" id="template-type-email" class="template-type-btn" style="padding:12px 24px;background:#3b82f6;color:#fff;border:none;border-radius:8px 8px 0 0;cursor:pointer;font-size:14px;font-weight:500">
                                    Email Template
                                </button>
                                <button onclick="showTemplateType('sms')" id="template-type-sms" class="template-type-btn" style="padding:12px 24px;background:transparent;color:#6b7280;border:none;border-radius:8px 8px 0 0;cursor:pointer;font-size:14px;font-weight:500">
                                    SMS Template
                                </button>
                            </div>
                            
                            <!-- Email Template Tab -->
                            <div id="template-content-email" class="template-type-content" style="display:block">
                                <!-- Email Template List View -->
                                <div id="email-template-list-view">
                                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:24px">
                                        <h3 style="margin:0;font-size:24px;color:#111827">Email Templates</h3>
                                        <button onclick="showEmailTemplateForm()" class="btn btn-primary" style="display:flex;align-items:center;gap:8px">
                                            <span>+</span> Create new template
                                        </button>
                                    </div>
                                    <div id="email-templates-list" style="display:flex;flex-direction:column;gap:12px">
                                        <!-- Templates will be loaded here -->
                                    </div>
                                </div>
                                
                                <!-- Email Template Form View -->
                                <div id="email-template-form-view" style="display:none">
                                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:24px">
                                        <h3 id="email-template-form-title" style="margin:0;font-size:24px;color:#111827">Create Email Template</h3>
                                        <button onclick="showEmailTemplateList()" class="btn btn-secondary"> Back to list</button>
                                    </div>
                                    <form id="email-template-form" style="display:flex;flex-direction:column;gap:20px">
                                        <input type="hidden" id="email-template-id" value="">
                                        <div>
                                            <label style="display:block;margin-bottom:8px;font-weight:500;color:#374151">Template Name</label>
                                            <input type="text" id="template-name" class="form-input" placeholder="e.g., Interview Result Notification" required style="width:100%">
                                        </div>
                                        <div>
                                            <label style="display:block;margin-bottom:8px;font-weight:500;color:#374151">Subject</label>
                                            <input type="text" id="template-subject" class="form-input" placeholder="Email subject line" style="width:100%">
                                        </div>
                                        <div>
                                            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
                                                <label style="display:block;margin:0;font-weight:500;color:#374151">Body</label>
                                                <button type="button" onclick="showReferenceFieldsForEmailTemplate()" style="background:#fff;border:1px solid #d1d5db;color:#111827;padding:6px 10px;border-radius:6px;cursor:pointer;font-size:14px;display:flex;align-items:center;gap:4px" title="Insert Reference Fields">
                                                     <span style="font-size:12px">Fields</span>
                                                </button>
                                            </div>
                                            <div id="email-template-body-editor" style="min-height:400px"></div>
                                        </div>
                                        <div style="display:flex;gap:12px">
                                            <button type="submit" class="btn btn-primary">Save Template</button>
                                            <button type="button" class="btn btn-secondary" onclick="resetEmailTemplateForm()">Reset</button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                            
                            <!-- SMS Template Tab -->
                            <div id="template-content-sms" class="template-type-content" style="display:none">
                                <!-- SMS Template List View -->
                                <div id="sms-template-list-view">
                                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:24px">
                                        <h3 style="margin:0;font-size:24px;color:#111827">SMS Templates</h3>
                                        <button onclick="showSMSTemplateForm()" class="btn btn-primary" style="display:flex;align-items:center;gap:8px">
                                            <span>+</span> Create new template
                                        </button>
                                    </div>
                                    <div id="sms-templates-list" style="display:flex;flex-direction:column;gap:12px">
                                        <!-- Templates will be loaded here -->
                                    </div>
                                </div>
                                
                                <!-- SMS Template Form View -->
                                <div id="sms-template-form-view" style="display:none">
                                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:24px">
                                        <h3 id="sms-template-form-title" style="margin:0;font-size:24px;color:#111827">Create SMS Template</h3>
                                        <button onclick="showSMSTemplateList()" class="btn btn-secondary"> Back to list</button>
                                    </div>
                                    <form id="sms-template-form" style="display:flex;flex-direction:column;gap:20px">
                                        <input type="hidden" id="sms-template-id" value="">
                                        <div>
                                            <label style="display:block;margin-bottom:8px;font-weight:500;color:#374151">Template Name</label>
                                            <input type="text" id="sms-template-name" class="form-input" placeholder="e.g., Interview Reminder" required style="width:100%">
                                        </div>
                                        <div>
                                            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
                                                <label style="display:block;margin:0;font-weight:500;color:#374151">Message</label>
                                                <button type="button" onclick="showReferenceFieldsForSMSTemplate()" style="background:#fff;border:1px solid #d1d5db;color:#111827;padding:6px 10px;border-radius:6px;cursor:pointer;font-size:14px;display:flex;align-items:center;gap:4px" title="Insert Reference Fields">
                                                     <span style="font-size:12px">Fields</span>
                                                </button>
                                            </div>
                                            <textarea id="sms-template-message" class="form-input" rows="10" placeholder="SMS message content. Use reference fields like ${student_name}, ${session_name}, etc." required style="width:100%;resize:vertical"></textarea>
                                        </div>
                                        <div style="display:flex;gap:12px">
                                            <button type="submit" class="btn btn-primary">Save Template</button>
                                            <button type="button" class="btn btn-secondary" onclick="resetSMSTemplateForm()">Reset</button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Email Logs Content -->
                        <div id="settings-content-email-logs" class="settings-content" style="display:none">
                            <h3 style="margin:0 0 24px;font-size:24px;color:#111827">Email Logs</h3>
                            
                            <!-- Sub-tabs for Sent, Failed, Drafted -->
                            <div style="display:flex;gap:8px;border-bottom:2px solid #e5e7eb;margin-bottom:24px">
                                <button onclick="showEmailLogTab('sent')" id="email-log-tab-sent" class="email-log-tab-btn" style="padding:12px 24px;background:#3b82f6;color:#fff;border:none;border-radius:8px 8px 0 0;cursor:pointer;font-size:14px;font-weight:500">
                                    Sent
                                </button>
                                <button onclick="showEmailLogTab('failed')" id="email-log-tab-failed" class="email-log-tab-btn" style="padding:12px 24px;background:transparent;color:#6b7280;border:none;border-radius:8px 8px 0 0;cursor:pointer;font-size:14px;font-weight:500">
                                    Failed
                                </button>
                                <button onclick="showEmailLogTab('drafted')" id="email-log-tab-drafted" class="email-log-tab-btn" style="padding:12px 24px;background:transparent;color:#6b7280;border:none;border-radius:8px 8px 0 0;cursor:pointer;font-size:14px;font-weight:500">
                                    Drafted
                                </button>
                            </div>
                            
                            <!-- Email Logs List -->
                            <div id="email-logs-list" style="display:flex;flex-direction:column;gap:12px">
                                <!-- Email logs will be loaded here -->
                                <div style="text-align:center;padding:40px;color:#6b7280">
                                    <p>Loading email logs...</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- SMS Logs Content -->
                        <div id="settings-content-sms-logs" class="settings-content" style="display:none">
                            <h3 style="margin:0 0 24px;font-size:24px;color:#111827">SMS Logs</h3>
                            
                            <!-- Sub-tabs for Sent, Failed, Drafted -->
                            <div style="display:flex;gap:8px;border-bottom:2px solid #e5e7eb;margin-bottom:24px">
                                <button onclick="showSMSLogTab('sent')" id="sms-log-tab-sent" class="sms-log-tab-btn" style="padding:12px 24px;background:#3b82f6;color:#fff;border:none;border-radius:8px 8px 0 0;cursor:pointer;font-size:14px;font-weight:500">
                                    Sent
                                </button>
                                <button onclick="showSMSLogTab('failed')" id="sms-log-tab-failed" class="sms-log-tab-btn" style="padding:12px 24px;background:transparent;color:#6b7280;border:none;border-radius:8px 8px 0 0;cursor:pointer;font-size:14px;font-weight:500">
                                    Failed
                                </button>
                                <button onclick="showSMSLogTab('drafted')" id="sms-log-tab-drafted" class="sms-log-tab-btn" style="padding:12px 24px;background:transparent;color:#6b7280;border:none;border-radius:8px 8px 0 0;cursor:pointer;font-size:14px;font-weight:500">
                                    Drafted
                                </button>
                            </div>
                            
                            <!-- SMS Logs List -->
                            <div id="sms-logs-list" style="display:flex;flex-direction:column;gap:12px">
                                <!-- SMS logs will be loaded here -->
                                <div style="text-align:center;padding:40px;color:#6b7280">
                                    <p>Loading SMS logs...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
                
                <!-- Send Mail Popup -->
                <!-- Bulk Email Loading Overlay -->
                <div id="bulk-email-loading-overlay" style="position:fixed;inset:0;background:rgba(0,0,0,0.8);display:none;z-index:2000;align-items:center;justify-content:center;flex-direction:column;gap:20px">
                    <div style="background:#fff;border-radius:12px;padding:40px;text-align:center;max-width:400px">
                        <div style="width:50px;height:50px;border:4px solid #e5e7eb;border-top-color:#3b82f6;border-radius:50%;margin:0 auto 20px;animation:spin 1s linear infinite"></div>
                        <h3 style="margin:0 0 10px;font-size:18px;color:#111827">Sending Emails...</h3>
                        <p id="bulk-email-progress" style="margin:0;color:#6b7280;font-size:14px">Preparing to send emails</p>
                        <div style="margin-top:20px;padding-top:20px;border-top:1px solid #e5e7eb">
                            <div style="display:flex;justify-content:space-between;font-size:14px;color:#6b7280">
                                <span>Sent: <strong id="bulk-email-sent-count" style="color:#10b981">0</strong></span>
                                <span>Failed: <strong id="bulk-email-failed-count" style="color:#ef4444">0</strong></span>
                                <span>Total: <strong id="bulk-email-total-count">0</strong></span>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Single Email Loading Overlay -->
                <div id="single-email-loading-overlay" style="position:fixed;inset:0;background:rgba(0,0,0,0.8);display:none;z-index:2001;align-items:center;justify-content:center;flex-direction:column;gap:20px">
                    <div style="background:#fff;border-radius:12px;padding:40px;text-align:center;max-width:400px">
                        <div style="width:50px;height:50px;border:4px solid #e5e7eb;border-top-color:#3b82f6;border-radius:50%;margin:0 auto 20px;animation:spin 1s linear infinite"></div>
                        <h3 id="single-email-loading-title" style="margin:0 0 10px;font-size:18px;color:#111827">Sending Email...</h3>
                        <p id="single-email-loading-message" style="margin:0;color:#6b7280;font-size:14px">Please wait while we send your email</p>
                    </div>
                </div>
                <style>
                    @keyframes spin {
                        to { transform: rotate(360deg); }
                    }
                </style>
                <div id="send-mail-overlay" style="position:fixed;inset:0;background:rgba(0,0,0,0.7);display:none;z-index:1900">
                    <div style="position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:#fff;border-radius:8px;width:90%;max-width:900px;height:85vh;max-height:800px;display:flex;flex-direction:column;box-shadow:0 20px 60px rgba(0,0,0,0.5);overflow:hidden">
                        <!-- Top Bar -->
                        <div style="display:flex;justify-content:space-between;align-items:center;padding:12px 16px;background:#f9fafb;border-bottom:1px solid #e5e7eb">
                            <div style="display:flex;gap:8px;align-items:center">
                                <button type="submit" form="send-mail-form" style="background:#3b82f6;color:#fff;border:none;padding:8px 20px;border-radius:6px;cursor:pointer;font-weight:500;font-size:14px">
                                    Send
                                </button>
                                <button type="button" id="save-draft-btn" onclick="saveEmailAsDraft()" style="background:transparent;color:#6b7280;border:1px solid #d1d5db;padding:8px 16px;border-radius:6px;cursor:pointer;font-size:14px">
                                    Save as Draft
                                </button>
                                <select id="send-mail-template" onchange="loadEmailTemplate()" style="background:#fff;border:1px solid #d1d5db;color:#111827;padding:6px 12px;border-radius:6px;font-size:13px;outline:none;cursor:pointer;min-width:200px">
                                    <option value="">Select a template...</option>
                                </select>
                                <button type="button" onclick="showReferenceFields()" style="background:#fff;border:1px solid #d1d5db;color:#111827;padding:6px 10px;border-radius:6px;cursor:pointer;font-size:14px;display:flex;align-items:center;gap:4px" title="Insert Reference Fields">
                                     <span style="font-size:12px">Fields</span>
                                </button>
                            </div>
                            <div style="display:flex;gap:8px;align-items:center">
                                <button type="button" style="background:transparent;color:#6b7280;border:none;padding:6px;cursor:pointer;font-size:16px" title="Save draft"></button>
                                <button type="button" style="background:transparent;color:#6b7280;border:none;padding:6px;cursor:pointer;font-size:16px" title="Share"></button>
                                <button onclick="closeSendMailPopup()" style="background:transparent;color:#6b7280;border:none;padding:6px;cursor:pointer;font-size:20px">&times;</button>
                            </div>
                        </div>
                        
                        <!-- Email Composer Content -->
                        <div style="flex:1;overflow-y:auto;background:#fff;padding:16px">
                            <form id="send-mail-form" novalidate style="display:flex;flex-direction:column;gap:0;height:100%">
                                <!-- From Field -->
                                <div style="padding:8px 0;border-bottom:1px solid #e5e7eb">
                                    <div style="display:flex;align-items:center;gap:8px">
                                        <span style="color:#6b7280;font-size:14px;min-width:60px">From:</span>
                                        <input type="email" id="send-mail-from" required readonly style="background:#f3f4f6;border:none;color:#6b7280;flex:1;padding:4px;font-size:14px;outline:none;cursor:not-allowed" value="admissions@zohoschools.in">
                                    </div>
                                </div>
                                
                                <!-- To Field -->
                                <div style="padding:8px 0;border-bottom:1px solid #e5e7eb">
                                    <div style="display:flex;align-items:flex-start;gap:8px">
                                        <span style="color:#6b7280;font-size:14px;min-width:60px;padding-top:4px">To:</span>
                                        <div style="flex:1;display:flex;flex-wrap:wrap;gap:4px;min-height:32px;padding:4px;border:1px solid #e5e7eb;border-radius:4px;background:#fff;align-items:center">
                                            <div id="send-mail-to-tags" style="display:flex;flex-wrap:wrap;gap:4px"></div>
                                            <input type="text" id="send-mail-to" autocomplete="off" data-lpignore="true" data-form-type="other" style="background:transparent;border:none;color:#111827;flex:1;min-width:200px;padding:0;font-size:14px;outline:none;text-align:left" placeholder="Enter email addresses (comma-separated or press Enter)" onkeydown="handleEmailInput(event, 'to')" onblur="addEmailFromInput('to')" oninput="updateEmailFieldPlaceholder('to')">
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Cc and Bcc Fields -->
                                <div style="padding:8px 0;border-bottom:1px solid #e5e7eb;display:flex;gap:16px">
                                    <div style="display:flex;align-items:flex-start;gap:8px;flex:1">
                                        <span style="color:#6b7280;font-size:14px;min-width:60px;padding-top:4px">Cc:</span>
                                        <div style="flex:1;display:flex;flex-wrap:wrap;gap:4px;min-height:32px;padding:4px;border:1px solid #e5e7eb;border-radius:4px;background:#fff;align-items:center">
                                            <div id="send-mail-cc-tags" style="display:flex;flex-wrap:wrap;gap:4px"></div>
                                            <input type="text" id="send-mail-cc" autocomplete="off" data-lpignore="true" data-form-type="other" style="background:transparent;border:none;color:#111827;flex:1;min-width:150px;padding:0;font-size:14px;outline:none;text-align:left" placeholder="Enter email addresses" onkeydown="handleEmailInput(event, 'cc')" onblur="addEmailFromInput('cc')" oninput="updateEmailFieldPlaceholder('cc')">
                                        </div>
                                    </div>
                                    <div style="display:flex;align-items:flex-start;gap:8px;flex:1">
                                        <span style="color:#6b7280;font-size:14px;min-width:60px;padding-top:4px">Bcc:</span>
                                        <div style="flex:1;display:flex;flex-wrap:wrap;gap:4px;min-height:32px;padding:4px;border:1px solid #e5e7eb;border-radius:4px;background:#fff;align-items:center">
                                            <div id="send-mail-bcc-tags" style="display:flex;flex-wrap:wrap;gap:4px"></div>
                                            <input type="text" id="send-mail-bcc" autocomplete="off" data-lpignore="true" data-form-type="other" style="background:transparent;border:none;color:#111827;flex:1;min-width:150px;padding:0;font-size:14px;outline:none;text-align:left" placeholder="Enter email addresses" onkeydown="handleEmailInput(event, 'bcc')" onblur="addEmailFromInput('bcc')" oninput="updateEmailFieldPlaceholder('bcc')">
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Subject Field -->
                                <div style="padding:8px 0;border-bottom:1px solid #e5e7eb">
                                    <input type="text" id="send-mail-subject" required style="background:transparent;border:none;color:#111827;width:100%;padding:4px;font-size:14px;outline:none" placeholder="Subject">
                                </div>
                                
                                <!-- Message Body with Quill Editor -->
                                <div style="flex:1;min-height:300px;padding:16px 0">
                                    <div id="send-mail-message-editor" style="min-height:300px"></div>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
                
                <!-- Send SMS Popup -->
                <div id="send-sms-overlay" style="position:fixed;inset:0;background:rgba(0,0,0,0.7);display:none;z-index:1900">
                    <div style="position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:#fff;border-radius:8px;width:90%;max-width:700px;height:75vh;max-height:700px;display:flex;flex-direction:column;box-shadow:0 20px 60px rgba(0,0,0,0.5);overflow:hidden">
                        <!-- Top Bar -->
                        <div style="display:flex;justify-content:space-between;align-items:center;padding:12px 16px;background:#f9fafb;border-bottom:1px solid #e5e7eb">
                            <div style="display:flex;gap:8px;align-items:center">
                                <button type="submit" form="send-sms-form" style="background:#3b82f6;color:#fff;border:none;padding:8px 20px;border-radius:6px;cursor:pointer;font-weight:500;font-size:14px">
                                    Send
                                </button>
                                <button type="button" id="save-sms-draft-btn" onclick="saveSMSAsDraft()" style="background:transparent;color:#6b7280;border:1px solid #d1d5db;padding:8px 16px;border-radius:6px;cursor:pointer;font-size:14px">
                                    Save as Draft
                                </button>
                                <select id="send-sms-template" onchange="loadSMSTemplate()" style="background:#fff;border:1px solid #d1d5db;color:#111827;padding:6px 12px;border-radius:6px;font-size:13px;outline:none;cursor:pointer;min-width:200px">
                                    <option value="">Select a template...</option>
                                </select>
                                <select id="send-sms-type" style="background:#fff;border:1px solid #d1d5db;color:#111827;padding:6px 12px;border-radius:6px;font-size:13px;outline:none;cursor:pointer">
                                    <option value="sms">SMS</option>
                                    <option value="whatsapp">WhatsApp</option>
                                </select>
                                <button type="button" onclick="showReferenceFieldsForSMS()" style="background:#fff;border:1px solid #d1d5db;color:#111827;padding:6px 10px;border-radius:6px;cursor:pointer;font-size:14px;display:flex;align-items:center;gap:4px" title="Insert Reference Fields">
                                     <span style="font-size:12px">Fields</span>
                                </button>
                            </div>
                            <button onclick="closeSendSMSPopup()" style="background:transparent;color:#6b7280;border:none;padding:6px;cursor:pointer;font-size:20px">&times;</button>
                        </div>
                        
                        <!-- SMS Composer Content -->
                        <div style="flex:1;overflow-y:auto;background:#fff;padding:16px">
                            <form id="send-sms-form" novalidate style="display:flex;flex-direction:column;gap:0;height:100%">
                                <!-- From Field -->
                                <div style="padding:8px 0;border-bottom:1px solid #e5e7eb">
                                    <div style="display:flex;align-items:center;gap:8px">
                                        <span style="color:#6b7280;font-size:14px;min-width:60px">From:</span>
                                        <input type="text" id="send-sms-from" required readonly style="background:#f3f4f6;border:none;color:#6b7280;flex:1;padding:4px;font-size:14px;outline:none;cursor:not-allowed" placeholder="Loading...">
                                    </div>
                                </div>
                                
                                <!-- To Field -->
                                <div style="padding:8px 0;border-bottom:1px solid #e5e7eb">
                                    <div style="display:flex;align-items:flex-start;gap:8px">
                                        <span style="color:#6b7280;font-size:14px;min-width:60px;padding-top:4px">To:</span>
                                        <div style="flex:1;display:flex;flex-wrap:wrap;gap:4px;min-height:32px;padding:4px;border:1px solid #e5e7eb;border-radius:4px;background:#fff;align-items:center">
                                            <div id="send-sms-to-tags" style="display:flex;flex-wrap:wrap;gap:4px"></div>
                                            <input type="text" id="send-sms-to" autocomplete="off" data-lpignore="true" data-form-type="other" style="background:transparent;border:none;color:#111827;flex:1;min-width:200px;padding:0;font-size:14px;outline:none;text-align:left" placeholder="Enter phone numbers (comma-separated or press Enter)" onkeydown="handlePhoneInput(event, 'to')" onblur="addPhoneFromInput('to')" oninput="updatePhoneFieldPlaceholder('to')">
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Message Field -->
                                <div style="flex:1;min-height:300px;padding:16px 0;border-bottom:1px solid #e5e7eb">
                                    <textarea id="send-sms-message" required style="width:100%;min-height:300px;padding:12px;border:1px solid #e5e7eb;border-radius:6px;font-size:14px;font-family:inherit;resize:vertical;outline:none" placeholder="Type your message here... (160 characters = 1 SMS, longer messages will be split)"></textarea>
                                    <div style="display:flex;justify-content:space-between;align-items:center;margin-top:8px">
                                        <span id="sms-char-count" style="color:#6b7280;font-size:12px">0 characters</span>
                                        <span id="sms-count" style="color:#6b7280;font-size:12px">0 SMS</span>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </section>
        </main>
        
        <!-- Communication Type Selection Modal -->
        <div id="comm-type-overlay" style="position:fixed;inset:0;background:rgba(0,0,0,0.5);display:none;z-index:10001;align-items:center;justify-content:center">
            <div style="background:#fff;border-radius:8px;width:90%;max-width:400px;padding:24px;box-shadow:0 20px 60px rgba(0,0,0,0.3)">
                <h3 style="margin:0 0 20px;font-size:18px;font-weight:600;color:#111827">Select Communication Type</h3>
                <div style="display:flex;flex-direction:column;gap:16px;margin-bottom:24px">
                    <label style="display:flex;align-items:center;gap:12px;cursor:pointer;padding:12px;border:2px solid #e5e7eb;border-radius:8px;transition:all 0.2s" onmouseover="this.style.borderColor='#3b82f6';this.style.background='#f0f9ff'" onmouseout="this.style.borderColor='#e5e7eb';this.style.background='#fff'">
                        <input type="radio" name="comm-type" value="email" checked style="width:18px;height:18px;cursor:pointer">
                        <div>
                            <div style="font-weight:600;color:#111827;font-size:16px">Email</div>
                            <div style="color:#6b7280;font-size:14px">Send email to selected recipients</div>
                        </div>
                    </label>
                    <label style="display:flex;align-items:center;gap:12px;cursor:pointer;padding:12px;border:2px solid #e5e7eb;border-radius:8px;transition:all 0.2s" onmouseover="this.style.borderColor='#3b82f6';this.style.background='#f0f9ff'" onmouseout="this.style.borderColor='#e5e7eb';this.style.background='#fff'">
                        <input type="radio" name="comm-type" value="sms" style="width:18px;height:18px;cursor:pointer">
                        <div>
                            <div style="font-weight:600;color:#111827;font-size:16px">SMS</div>
                            <div style="color:#6b7280;font-size:14px">Send SMS to selected recipients</div>
                        </div>
                    </label>
                </div>
                <div style="display:flex;gap:12px;justify-content:flex-end">
                    <button onclick="closeCommTypeModal()" style="background:transparent;color:#6b7280;border:1px solid #d1d5db;padding:8px 16px;border-radius:6px;cursor:pointer;font-size:14px">Cancel</button>
                    <button onclick="proceedWithCommType()" style="background:#3b82f6;color:#fff;border:none;padding:8px 16px;border-radius:6px;cursor:pointer;font-size:14px;font-weight:500">Continue</button>
                </div>
            </div>
        </div>
        
        <!-- Reference Fields Modal - Placed outside sections for global access -->
        <div id="reference-fields-overlay" style="position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);display:none;z-index:10000;align-items:center;justify-content:center">
            <div style="background:#fff;border-radius:8px;width:90%;max-width:600px;max-height:80vh;overflow-y:auto;box-shadow:0 20px 60px rgba(0,0,0,0.3)">
                <div style="display:flex;justify-content:space-between;align-items:center;padding:16px;border-bottom:1px solid #e5e7eb">
                    <h3 style="margin:0;font-size:18px;font-weight:600;color:#111827">Reference Fields</h3>
                    <button onclick="closeReferenceFields()" style="background:transparent;border:none;color:#6b7280;cursor:pointer;font-size:24px;padding:0;width:32px;height:32px;display:flex;align-items:center;justify-content:center">&times;</button>
                </div>
                <div style="padding:16px">
                    <p style="margin:0 0 16px 0;color:#6b7280;font-size:14px">Click on any field to insert it into your message. The field will be replaced with the actual value when sending.</p>
                    <div id="reference-fields-list" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(250px,1fr));gap:12px">
                        <!-- Fields will be populated here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <style>
        /* Quill editor styles */
        #send-mail-message-editor .ql-editor {
            min-height: 300px;
            font-size: 14px;
        }
        
        #email-template-body-editor .ql-editor {
            min-height: 400px;
            font-size: 14px;
            color: #111827;
        }
        
        .email-template-form-container {
            display: flex !important;
            flex-direction: column;
        }
        
        /* Always show pointer where there is a click event */
        .data-table th[data-field],
        .table th[data-field] { cursor: pointer; }
        .sort-indicator .asc,
        .sort-indicator .desc { cursor: pointer; }
        
        /* Reduce Description column width in sessions table */
        #sessions .data-table th:nth-child(3),
        #sessions .data-table td:nth-child(3) {
            max-width: 200px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
            /* Consistent column widths for consolidation table */
            .data-table.fixed-columns { table-layout: fixed; width: 100%; }
            #consolidation.data-table th,
            #consolidation .data-table td { white-space: normal; overflow-wrap: anywhere; word-break: break-word; }
            /* Specific width allocations (sum <= 100%) */
            #consolidation .data-table th:nth-child(1),
            #consolidation .data-table td:nth-child(1) { width: 10%; }
            #consolidation .data-table th:nth-child(2),
            #consolidation .data-table td:nth-child(2) { width: 10%; }
            #consolidation .data-table th:nth-child(3),
            #consolidation .data-table td:nth-child(3) { width: 10%; }
            #consolidation .data-table th:nth-child(4),
            #consolidation .data-table td:nth-child(4) { width: 9%; }
            #consolidation .data-table th:nth-child(5),
            #consolidation .data-table td:nth-child(5) { width: 7%; }
            #consolidation .data-table th:nth-child(6),
            #consolidation .data-table td:nth-child(6) { width: 6%; }
            #consolidation .data-table th:nth-child(7),
            #consolidation .data-table td:nth-child(7) { width: 10%; }
            #consolidation .data-table th:nth-child(8),
            #consolidation .data-table td:nth-child(8) { width: 8%; }
            #consolidation .data-table th:nth-child(9),
            #consolidation .data-table td:nth-child(9) { width: 12%; }
            #consolidation .data-table th:nth-child(10),
            #consolidation .data-table td:nth-child(10) { width: 8%; }
            /* Allow multiline where needed inside constrained cells */
            #consolidation .data-table td div[style*="max-height:64px"] { white-space: normal; }
            /* Ensure action menus render above rows and not clipped */
            #consolidation .table-container { position: relative; overflow: visible; }
            #consolidation .action-menu-container { position: relative; overflow: visible; }
            #consolidation .user-action-menu { position: absolute; z-index: 3000; right: 0; top: 100%; }
            /* Compact Advanced Filters */
            .adv-filters{display:flex;align-items:flex-start;gap:8px;padding:8px 12px;border:1px solid #e5e7eb;border-radius:8px;background:#f9fafb;margin:8px 0}
            .adv-label{color:#6b7280;font-size:12px;padding:6px 8px;border:1px solid #e5e7eb;border-radius:6px;background:#fff;flex-shrink:0}
            .filters-container{display:flex;flex-direction:column;gap:6px;flex:1}
            .filter-row-adv{display:flex;align-items:center;gap:6px;flex-wrap:nowrap}
            .filter-row-adv .form-select,.filter-row-adv .form-input{height:32px;padding:4px 8px;font-size:13px}
            .filter-row-adv .form-input[type="date"]{padding:4px 6px}
            .filter-row-adv .filter-connector{min-width:70px;max-width:70px}
            .filter-row-adv .filter-field{min-width:140px;max-width:140px}
            .filter-row-adv .filter-op{min-width:120px;max-width:120px}
            .filter-row-adv .filter-value{min-width:160px;flex:1}
            .filter-row-adv .filter-value2{min-width:120px}
            .filter-row-adv .btn{white-space:nowrap}
            .filters-actions{display:flex;gap:8px;margin-left:auto}
            .btn-compact{height:32px;padding:4px 12px;font-size:13px}
            .link-btn{background:none;border:none;color:#111827;cursor:pointer;height:32px;text-decoration:underline}
            .filter-value{width:160px}
            .filter-value2{width:140px}
            
            /* Import Tab Styles */
            .import-tab {
                transition: all 0.2s;
            }
            .import-tab:hover {
                background: #e5e7eb !important;
            }
            .import-tab.active {
                background: #fff !important;
                border-bottom: 2px solid #3b82f6 !important;
                color: #3b82f6;
            }
    </style>

    <!-- Create Session Modal -->
        <!-- Bulk Import Students Modal -->
        <div id="bulk-import-students-modal" class="modal">
            <div class="modal-content" style="max-width:850px;padding:0;overflow:hidden;display:flex;flex-direction:column;max-height:90vh">
                <div style="display:flex;align-items:center;justify-content:space-between;padding:14px 16px;border-bottom:1px solid #e5e7eb;background:#111827;color:#fff;flex-shrink:0">
                    <h3 class="modal-title" style="margin:0;font-size:16px">Bulk Import Students</h3>
                    <button class="close" onclick="closeBulkImportStudents()" style="background:#374151;color:#fff;border:none;border-radius:6px;padding:4px 8px;cursor:pointer"></button>
                </div>
                
                <!-- Tab Navigation -->
                <div style="display:flex;background:#f3f4f6;border-bottom:1px solid #e5e7eb;flex-shrink:0">
                    <button id="tab-paste-students" class="import-tab active" onclick="switchImportTab('students', 'paste')" style="flex:1;padding:12px 16px;border:none;background:transparent;cursor:pointer;font-weight:500;border-bottom:2px solid transparent;transition:all 0.2s">
                         Paste CSV Data
                    </button>
                    <button id="tab-file-students" class="import-tab" onclick="switchImportTab('students', 'file')" style="flex:1;padding:12px 16px;border:none;background:transparent;cursor:pointer;font-weight:500;border-bottom:2px solid transparent;transition:all 0.2s">
                         Upload File
                    </button>
                </div>
                
                <!-- Interview Session Selection (Common for both tabs) -->
                <div style="background:#fff;border-bottom:1px solid #e5e7eb;padding:16px 20px;flex-shrink:0">
                    <label style="font-weight:600;margin-bottom:8px;display:block;color:#111827">
                        Interview Session <span style="color:#dc2626">*</span>
                    </label>
                    <select id="bulk-students-session" class="form-input" required style="width:100%;padding:8px;border:1px solid #d1d5db;border-radius:4px;font-size:14px">
                        <option value="">Select Interview Session...</option>
                    </select>
                    <div style="margin-top:8px;font-size:12px;color:#6b7280">
                        All imported students will be mapped to the selected interview session
                    </div>
                </div>
                
                <div class="modal-body" style="padding:20px;background:#f9fafb;overflow-y:auto;flex:1;min-height:0">
                    <!-- Paste CSV Tab -->
                    <div id="paste-content-students" class="tab-content" style="display:block">
                        <div style="background:#fff;border:1px solid #e5e7eb;border-radius:8px;padding:16px;margin-bottom:16px">
                            <div style="font-weight:600;margin-bottom:12px;color:#111827;font-size:15px"> Instructions</div>
                            <div style="background:#eff6ff;border-left:3px solid #3b82f6;padding:12px;border-radius:4px;margin-bottom:12px">
                                <div style="font-size:13px;color:#1e40af;margin-bottom:8px">
                                    <strong>Required Format (First 6 columns only):</strong>
                                </div>
                                <div style="font-family:monospace;font-size:12px;color:#1e3a8a;background:#fff;padding:8px;border-radius:4px;overflow-x:auto">
                                    name,phone,school,location,email,zeta_id
                                </div>
                            </div>
                            <ul style="font-size:13px;color:#4b5563;margin:0;padding-left:20px;line-height:1.8">
                                <li><strong>Name</strong> (Required): Full name of the student</li>
                                <li><strong>Phone</strong> (Required): 10-digit phone number, duplicates will be skipped</li>
                                <li><strong>School</strong> (Optional): School or institution name</li>
                                <li><strong>Location</strong> (Optional): Location or city</li>
                                <li><strong>Email</strong> (Optional): Email address</li>
                                <li><strong>Zeta ID</strong> (Optional): Student ID</li>
                            </ul>
                            <div style="margin-top:12px;padding:8px;background:#fef3c7;border-radius:4px;font-size:12px;color:#92400e">
                                 <strong>Duplication Check:</strong> Students with existing phone numbers will be automatically skipped.
                            </div>
                        </div>
                        
                        <div style="background:#fff;border:1px solid #e5e7eb;border-radius:8px;padding:16px">
                            <label style="font-weight:600;margin-bottom:8px;display:block;color:#111827">Paste CSV Data:</label>
                            <textarea id="bulk-students-text" class="form-textarea" rows="10" placeholder="John Doe,1234567890,St. Mary's School,New York,john@example.com,Z123
Jane Smith,0987654321,Lincoln High,Los Angeles,jane@example.com,Z124
Bob Johnson,5551234567,Central Academy,Chicago,bob@example.com,Z125" style="font-family:monospace;font-size:13px"></textarea>
                            <div style="margin-top:8px;font-size:12px;color:#6b7280">
                                 Tip: You can copy data directly from Excel or Google Sheets
                            </div>
                        </div>
                    </div>
                    
                    <!-- Upload File Tab -->
                    <div id="file-content-students" class="tab-content" style="display:none">
                        <div style="background:#fff;border:1px solid #e5e7eb;border-radius:8px;padding:16px;margin-bottom:16px">
                            <div style="font-weight:600;margin-bottom:12px;color:#111827;font-size:15px"> File Upload Instructions</div>
                            <div style="background:#eff6ff;border-left:3px solid #3b82f6;padding:12px;border-radius:4px;margin-bottom:12px">
                                <div style="font-size:13px;color:#1e40af;margin-bottom:8px">
                                    <strong>File Requirements:</strong>
                                </div>
                                <ul style="font-size:13px;color:#1e3a8a;margin:0;padding-left:20px;line-height:1.8">
                                    <li>Accepted formats: <code>.csv</code>, <code>.xls</code>, <code>.xlsx</code></li>
                                    <li>Maximum file size: <strong>5MB</strong></li>
                                    <li>First row should contain headers (will be skipped)</li>
                                    <li>Column order: name, phone, school, location, email, zeta_id</li>
                                </ul>
                            </div>
                            <div style="margin-top:12px;padding:8px;background:#fef3c7;border-radius:4px;font-size:12px;color:#92400e">
                                 <strong>Duplication Check:</strong> Students with existing phone numbers will be automatically skipped.
                            </div>
                        </div>
                        
                        <div style="background:#fff;border:1px solid #e5e7eb;border-radius:8px;padding:16px">
                            <label style="font-weight:600;margin-bottom:12px;display:block;color:#111827">Select File:</label>
                            <div style="border:2px dashed #cbd5e1;border-radius:8px;padding:32px;text-align:center;background:#f9fafb;cursor:pointer;transition:all 0.2s" 
                                 onmouseover="this.style.borderColor='#3b82f6';this.style.background='#eff6ff'" 
                                 onmouseout="this.style.borderColor='#cbd5e1';this.style.background='#f9fafb'"
                                 onclick="document.getElementById('bulk-students-file').click()">
                                <div style="font-size:48px;margin-bottom:8px"></div>
                                <div style="font-size:14px;color:#374151;margin-bottom:4px">Click to browse or drag & drop your file here</div>
                                <div style="font-size:12px;color:#6b7280">CSV, XLS, XLSX up to 5MB</div>
                            </div>
                            <input id="bulk-students-file" type="file" accept=".csv,.xls,.xlsx" style="display:none" onchange="handleFileSelected('students', this)" />
                            <div id="file-name-display-students" style="margin-top:12px;padding:8px;background:#f0fdf4;border:1px solid #86efac;border-radius:4px;display:none;align-items:center;justify-content:space-between">
                                <div>
                                    <span style="color:#166534;font-size:13px"> Selected: </span>
                                    <span id="file-name-students" style="color:#166534;font-weight:500;font-size:13px"></span>
                                </div>
                                <button onclick="removeSelectedFile('students')" style="background:#dc2626;color:#fff;border:none;border-radius:4px;padding:4px 8px;cursor:pointer;font-size:12px" title="Remove file"> Remove</button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="modal-footer" style="display:flex;gap:8px;justify-content:flex-end;padding:12px 16px;border-top:1px solid #e5e7eb;background:#fff;flex-shrink:0">
                    <button class="btn btn-secondary" id="bulk-import-cancel-btn" onclick="closeBulkImportStudents()">Cancel</button>
                    <button class="btn btn-primary" id="bulk-import-submit-btn" onclick="submitBulkImportStudents()">
                        <span id="bulk-import-btn-text">Import Students</span>
                        <span id="bulk-import-btn-spinner" style="display:none;margin-left:8px;">
                            <span style="display:inline-block;width:14px;height:14px;border:2px solid #ffffff;border-top-color:transparent;border-radius:50%;animation:spin 0.8s linear infinite;"></span>
                        </span>
                    </button>
                </div>
                <style>
                    @keyframes spin {
                        to { transform: rotate(360deg); }
                    }
                </style>
            </div>
        </div>
    <div id="create-session-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Create Interview Session</h3>
                <button class="close" onclick="closeCreateSessionModal()">&times;</button>
            </div>
            <form id="create-session-form">
                <div class="form-group">
                    <label class="form-label" for="session-name">Session Name</label>
                    <input type="text" id="session-name" class="form-input" placeholder="e.g., Face to Face for St Mary's School" required>
                </div>
                <div class="form-group">
                    <label class="form-label" for="session-description">Description</label>
                    <textarea id="session-description" class="form-textarea" placeholder="Brief description of the interview session"></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label" for="session-location">Location</label>
                    <select id="session-location" class="form-input">
                        <option value="">Select Location...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label" for="session-school">For which school</label>
                    <select id="session-school" class="form-input">
                        <option value="">Select School...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label" for="session-examination-mode">Examination Mode</label>
                    <select id="session-examination-mode" class="form-input">
                        <option value="">Select Examination Mode...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label" for="session-type">Interview Type</label>
                    <select id="session-type" class="form-input" onchange="handleSessionTypeChange()" required>
                        <option value="regular">Regular (Sequential Interviews)</option>
                        <option value="panel">Panel Interview (Simultaneous)</option>
                    </select>
                    <small style="color: #6b7280; font-size: 0.875rem; display: block; margin-top: 0.25rem;">
                        <strong>Regular:</strong> Interviewers interview students one-at-a-time (no parallel interviews of same student).<br>
                        <strong>Panel:</strong> Multiple interviewers can interview the same student at the same time.
                    </small>
                </div>
                <div class="form-group">
                    <label class="form-label" for="panelist-search">
                        <span id="panelist-label">Interviewers</span>
                        <span id="panel-requirement" style="color: #3b82f6; font-size: 0.875rem; display: none;"> - Multiple interviewers will interview students together</span>
                    </label>
                    <div class="panelist-container">
                        <div class="panelist-search-container">
                            <input type="text" id="panelist-search" class="form-input" placeholder="Search for interviewers..." onkeyup="searchInterviewers()">
                            <div id="panelist-search-results" class="search-results"></div>
                        </div>
                        <div class="selected-panelists">
                            <h4>Selected Panelists:</h4>
                            <div id="selected-panelists-list" class="selected-list"></div>
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <button type="submit" class="btn btn-primary">Create Session</button>
                    <button type="button" class="btn btn-secondary" onclick="closeCreateSessionModal()">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Question Details Modal -->
    <div id="question-details-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Question Performance Details</h3>
                <button class="close" onclick="closeQuestionDetailsModal()">&times;</button>
            </div>
            <div id="question-details-content">
                <!-- Content will be loaded dynamically -->
            </div>
        </div>
    </div>

    <!-- Add Question Modal -->
    <div id="add-question-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Add New Question</h3>
                <button class="close" onclick="closeAddQuestionModal()">&times;</button>
            </div>
            <form id="add-question-form">
                <div class="form-group">
                    <label class="form-label" for="question-text">Question Text</label>
                    <textarea id="question-text" class="form-textarea" placeholder="Enter the question text..." required rows="4"></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label" for="question-tags">Tags (Hashtags)</label>
                    <div id="tags-container" style="display:flex;flex-wrap:wrap;gap:8px;padding:8px;border:1px solid #d1d5db;border-radius:6px;min-height:42px;background:#fff;cursor:text">
                        <input type="text" id="question-tags-input" placeholder="Type custom tag and press Enter, or click suggestions below..." style="border:none;outline:none;flex:1;min-width:150px;font-size:14px">
                    </div>
                    <div style="margin-top:4px;font-size:12px;color:#6b7280">
                         <strong>Type your own tags</strong> (press <kbd style="background:#f3f4f6;padding:2px 6px;border-radius:3px;border:1px solid #d1d5db">Enter</kbd> or <kbd style="background:#f3f4f6;padding:2px 6px;border-radius:3px;border:1px solid #d1d5db">,</kbd>) or click suggested tags: <span id="suggested-tags" style="color:#3b82f6;cursor:pointer"></span>
                    </div>
                </div>
                <div class="form-group">
                    <button type="submit" class="btn btn-primary">Add Question</button>
                    <button type="button" class="btn btn-secondary" onclick="closeAddQuestionModal()">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Detail Panel Overlay -->
    <div id="panel-overlay" class="panel-overlay" onclick="closeDetailPanel()"></div>

    <!-- Detail Panel -->
    <div id="detail-panel" class="detail-panel">
        <div class="detail-panel-header">
            <h3 id="detail-panel-title">Details</h3>
            <button class="close-btn" onclick="closeDetailPanel()"></button>
        </div>
        <div class="detail-panel-content" id="detail-panel-content">
            <!-- Content will be loaded here -->
        </div>
    </div>

    <!-- legacy filter panel removed -->

    <!-- Image Modal -->
    <div id="image-modal" class="image-modal" onclick="closeImageModal()">
        <div class="image-modal-content" onclick="event.stopPropagation()">
            <button class="image-modal-close" onclick="closeImageModal()">&times;</button>
            <img id="modal-image" src="" alt="Answer Image">
        </div>
    </div>
    <script>
        async function openBulkImportStudents(){
            const m = document.getElementById('bulk-import-students-modal'); 
            if (m){ m.classList.add('active'); m.style.display='flex'; }
            // Reset to paste tab by default
            switchImportTab('students', 'paste');
            
            // Load interview sessions for dropdown
            await loadInterviewSessionsForBulkImport();
        }
        
        async function loadInterviewSessionsForBulkImport() {
            try {
                const response = await fetch('/api/admin/sessions');
                const data = await response.json();
                
                const sessionSelect = document.getElementById('bulk-students-session');
                if (!sessionSelect) return;
                
                // Clear existing options except the first one
                sessionSelect.innerHTML = '<option value="">Select Interview Session...</option>';
                
                if (data.success && data.data && data.data.length > 0) {
                    // Filter out inactive sessions
                    const activeSessions = data.data.filter(session => session.status === 'active');
                    activeSessions.forEach(session => {
                        const option = document.createElement('option');
                        option.value = session.id;
                        option.textContent = session.name;
                        sessionSelect.appendChild(option);
                    });
                } else {
                    const option = document.createElement('option');
                    option.value = '';
                    option.textContent = 'No sessions available';
                    option.disabled = true;
                    sessionSelect.appendChild(option);
                }
            } catch (error) {
                console.error('Error loading interview sessions:', error);
                const sessionSelect = document.getElementById('bulk-students-session');
                if (sessionSelect) {
                    sessionSelect.innerHTML = '<option value="">Error loading sessions</option>';
                }
            }
        }
        function closeBulkImportStudents(){
            const m = document.getElementById('bulk-import-students-modal'); 
            if (m){ m.classList.remove('active'); m.style.display='none'; }
            const t = document.getElementById('bulk-students-text'); if (t) t.value='';
            const f = document.getElementById('bulk-students-file'); if (f) f.value='';
            const sessionSelect = document.getElementById('bulk-students-session'); if (sessionSelect) sessionSelect.value='';
            const fileDisplay = document.getElementById('file-name-display-students');
            if (fileDisplay) fileDisplay.style.display = 'none';
        }
        
        function switchImportTab(type, tab) {
            // Remove active class from all tabs
            const pasteTab = document.getElementById(`tab-paste-${type}`);
            const fileTab = document.getElementById(`tab-file-${type}`);
            const pasteContent = document.getElementById(`paste-content-${type}`);
            const fileContent = document.getElementById(`file-content-${type}`);
            
            if (pasteTab) pasteTab.classList.remove('active');
            if (fileTab) fileTab.classList.remove('active');
            
            // Show selected tab
            if (tab === 'paste') {
                if (pasteTab) pasteTab.classList.add('active');
                if (pasteContent) pasteContent.style.display = 'block';
                if (fileContent) fileContent.style.display = 'none';
            } else {
                if (fileTab) fileTab.classList.add('active');
                if (pasteContent) pasteContent.style.display = 'none';
                if (fileContent) fileContent.style.display = 'block';
            }
        }
        
        function handleFileSelected(type, input) {
            const fileDisplay = document.getElementById(`file-name-display-${type}`);
            const fileName = document.getElementById(`file-name-${type}`);
            
            if (input.files && input.files[0]) {
                const file = input.files[0];
                if (fileName) fileName.textContent = file.name;
                if (fileDisplay) fileDisplay.style.display = 'flex';
            } else {
                if (fileDisplay) fileDisplay.style.display = 'none';
            }
        }
        
        function removeSelectedFile(type) {
            const fileInput = document.getElementById(`bulk-${type}-file`);
            const fileDisplay = document.getElementById(`file-name-display-${type}`);
            const fileName = document.getElementById(`file-name-${type}`);
            
            if (fileInput) fileInput.value = '';
            if (fileName) fileName.textContent = '';
            if (fileDisplay) fileDisplay.style.display = 'none';
        }
        function setBulkImportLoadingState(isLoading) {
            const submitBtn = document.getElementById('bulk-import-submit-btn');
            const cancelBtn = document.getElementById('bulk-import-cancel-btn');
            const btnText = document.getElementById('bulk-import-btn-text');
            const btnSpinner = document.getElementById('bulk-import-btn-spinner');
            
            if (isLoading) {
                // Set loading state
                if (submitBtn) {
                    submitBtn.disabled = true;
                    submitBtn.style.opacity = '0.7';
                    submitBtn.style.cursor = 'not-allowed';
                }
                if (cancelBtn) {
                    cancelBtn.disabled = true;
                    cancelBtn.style.opacity = '0.7';
                    cancelBtn.style.cursor = 'not-allowed';
                }
                if (btnText) btnText.textContent = 'Importing...';
                if (btnSpinner) btnSpinner.style.display = 'inline-block';
            } else {
                // Reset loading state
                if (submitBtn) {
                    submitBtn.disabled = false;
                    submitBtn.style.opacity = '1';
                    submitBtn.style.cursor = 'pointer';
                }
                if (cancelBtn) {
                    cancelBtn.disabled = false;
                    cancelBtn.style.opacity = '1';
                    cancelBtn.style.cursor = 'pointer';
                }
                if (btnText) btnText.textContent = 'Import Students';
                if (btnSpinner) btnSpinner.style.display = 'none';
            }
        }
        
        async function submitBulkImportStudents(){
            // Set loading state
            setBulkImportLoadingState(true);
            
            try{
                const text = document.getElementById('bulk-students-text')?.value?.trim();
                const file = document.getElementById('bulk-students-file')?.files?.[0] || null;
                const sessionId = document.getElementById('bulk-students-session')?.value;
                
                // Validate session is selected (required)
                if (!sessionId) {
                    showError('Please select an Interview Session');
                    setBulkImportLoadingState(false);
                    return;
                }
                
                // Determine which mode we're in
                const pasteTab = document.getElementById('tab-paste-students');
                const isPasteMode = pasteTab && pasteTab.classList.contains('active');
                
                if (isPasteMode) {
                    // Paste CSV mode
                    if (!text){ 
                        showError('Please paste CSV data first'); 
                        setBulkImportLoadingState(false);
                        return; 
                    }
                    
                    // Parse CSV lines: name,phone,school,location,email,zeta_id
                    const lines = text.split(/\r?\n/).map(l=>l.trim()).filter(Boolean);
                    const students = [];
                    const errors = [];
                    
                    lines.forEach((line, index) => {
                        const [name, phone, school, location, email, zeta_id] = line.split(',').map(v => (v || '').trim());
                        
                        // Validate required fields (only name and phone)
                        if (!name || !phone) {
                            errors.push(`Line ${index + 1}: Missing required fields (name and phone are required)`);
                            return;
                        }
                        
                        // Validate phone number (10 digits)
                        const phoneRegex = /^\d{10}$/;
                        if (!phoneRegex.test(phone)) {
                            errors.push(`Line ${index + 1}: Invalid phone number "${phone}" (must be 10 digits)`);
                            return;
                        }
                        
                        students.push({ name, phone, school: school || '', location: location || '', email: email || '', zeta_id: zeta_id || '' });
                    });
                    
                    if (errors.length > 0) {
                        showError(`Validation errors:\n${errors.slice(0, 5).join('\n')}${errors.length > 5 ? `\n... and ${errors.length - 5} more` : ''}`);
                        setBulkImportLoadingState(false);
                        return;
                    }
                    
                    if (students.length === 0) {
                        showError('No valid student data found');
                        setBulkImportLoadingState(false);
                        return;
                    }
                    
                    const payload = { students, session_id: parseInt(sessionId) };
                    const res = await fetch('/api/admin/students/bulk-import/text', { 
                        method: 'POST', 
                        headers: {'Content-Type': 'application/json'}, 
                        body: JSON.stringify(payload) 
                    });
                    const json = await res.json();
                    
                    if (!res.ok || !json.success) {
                        throw new Error(json.error || 'Import failed');
                    }
                    
                    // Show detailed results
                    let message = `Successfully imported ${json.count || 0} new student(s)`;
                    if (json.updated > 0) {
                        message += `\nUpdated ${json.updated} existing student(s) with session mapping`;
                    }
                    if (json.skipped > 0) {
                        message += `\n${json.skipped} duplicate(s) skipped`;
                    }
                    if (json.errors > 0) {
                        message += `\n\n${json.errors} error(s):`;
                        if (json.errorMessages && json.errorMessages.length > 0) {
                            message += `\n${json.errorMessages.slice(0, 10).join('\n')}`;
                            if (json.errorMessages.length > 10) {
                                message += `\n... and ${json.errorMessages.length - 10} more error(s)`;
                            }
                        }
                    }
                    if (json.errors > 0) {
                        showError(message);
                    } else {
                    showSuccess(message);
                    }
                    
                } else {
                    // File upload mode
                    if (!file) { 
                        showError('Please select a file first'); 
                        setBulkImportLoadingState(false);
                        return; 
                    }
                    
                    // Validate file size (5MB)
                    if (file.size > 5 * 1024 * 1024) {
                        showError('File size exceeds 5MB limit');
                        setBulkImportLoadingState(false);
                        return;
                    }
                    
                    console.log('Uploading file:', file.name, 'Size:', file.size);
                    
                    const fd = new FormData();
                    fd.append('file', file);
                    fd.append('session_id', sessionId);
                    
                    const res = await fetch('/api/admin/students/bulk-import/file', { 
                        method: 'POST', 
                        body: fd 
                    });
                    
                    console.log('Upload response status:', res.status);
                    
                    let json;
                    try {
                        json = await res.json();
                    } catch (parseError) {
                        console.error('Failed to parse response as JSON:', parseError);
                        const text = await res.text();
                        console.error('Response text:', text);
                        throw new Error(`Server returned invalid response: ${res.status} ${res.statusText}`);
                    }
                    
                    console.log('Upload response:', json);
                    
                    if (!res.ok || !json.success) {
                        const errorMsg = json.error || json.message || `Import failed with status ${res.status}`;
                        console.error('Import failed:', errorMsg, json);
                        throw new Error(errorMsg);
                    }
                    
                    if (json.count === 0 && json.errors === 0 && json.skipped === 0) {
                        showError('No valid data found in file. Please check the file format and content.');
                        setBulkImportLoadingState(false);
                        return;
                    }
                    
                    // Show detailed results
                    let message = `Successfully imported ${json.count || 0} new student(s)`;
                    if (json.updated > 0) {
                        message += `\nUpdated ${json.updated} existing student(s) with session mapping`;
                    }
                    if (json.skipped > 0) {
                        message += `\n${json.skipped} duplicate(s) skipped`;
                    }
                    if (json.errors > 0) {
                        message += `\n\n${json.errors} error(s):`;
                        if (json.errorMessages && json.errorMessages.length > 0) {
                            message += `\n${json.errorMessages.slice(0, 10).join('\n')}`;
                            if (json.errorMessages.length > 10) {
                                message += `\n... and ${json.errorMessages.length - 10} more error(s)`;
                            }
                        }
                    }
                    if (json.errors > 0) {
                        showError(message);
                    } else {
                    showSuccess(message);
                    }
                }
                
                closeBulkImportStudents();
                await refreshStudents();
                
            } catch(e) { 
                console.error('Bulk import error:', e); 
                console.error('Error stack:', e.stack);
                const errorMessage = e.message || e.toString() || 'Failed to import students';
                console.error('Showing error:', errorMessage);
                showError(errorMessage);
            } finally {
                // Reset loading state
                setBulkImportLoadingState(false);
            }
        }
        function setClearFiltersVisibility(section) {
            try {
                const map = {
                    'interviews': ['search-interviews','status-filter','verdict-filter','date-from','date-to'],
                    'questions': ['questions-search','questions-category','questions-sort-by','times-asked-min','success-rate-min'],
                    'sessions': ['sessions-search','sessions-status'],
                    'students': ['students-search'],
                    'my-interviews': ['my-search','my-status','my-verdict','my-date-from','my-date-to'],
                    'users': ['users-search','role-filter','status-filter-users']
                };
                const ids = map[section] || [];
                const isActive = ids.some(id => {
                    const el = document.getElementById(id);
                    if (!el) return false;
                    if (el.tagName === 'SELECT') return el.value && el.value !== '';
                    if (el.type === 'number') return el.value !== '' && Number(el.value) > 0;
                    return el.value && el.value.trim() !== '';
                });
                const btn = document.getElementById(`clear-filters-${section}`);
                if (btn) btn.style.display = isActive ? '' : 'none';
            } catch {}
        }

        function clearFilters(section) {
            try {
                switch(section) {
                    case 'interviews':
                        ['search-interviews','status-filter','verdict-filter','date-from','date-to'].forEach(id=>{ const el=document.getElementById(id); if(el){ el.value=''; if(el.onchange) el.onchange(); }});
                        applyFilters('interviews');
                        break;
                    case 'questions':
                        ['questions-search','questions-category','questions-sort-by'].forEach(id=>{ const el=document.getElementById(id); if(el){ el.value=''; if(el.onchange) el.onchange(); }});
                        applyQuestionFilters && applyQuestionFilters();
                        break;
                    case 'sessions':
                        ['sessions-search','sessions-status'].forEach(id=>{ const el=document.getElementById(id); if(el){ el.value=''; if(el.onchange) el.onchange(); }});
                        refreshSessions && refreshSessions();
                        break;
                    case 'students':
                        ['students-search'].forEach(id=>{ const el=document.getElementById(id); if(el){ el.value=''; if(el.onchange) el.onchange(); }});
                        refreshStudents && refreshStudents();
                        break;
                    case 'student-sessions':
                        ['student-sessions-inline-search'].forEach(id=>{ const el=document.getElementById(id); if(el){ el.value=''; if(el.onchange) el.onchange(); }});
                        clearAdvancedFiltersStudentSessions && clearAdvancedFiltersStudentSessions();
                        refreshStudentSessions && refreshStudentSessions();
                        break;
                    case 'my-interviews':
                        ['my-search','my-status','my-verdict','my-date-from','my-date-to'].forEach(id=>{ const el=document.getElementById(id); if(el){ el.value=''; if(el.onchange) el.onchange(); }});
                        applyMyInterviewFilters && applyMyInterviewFilters();
                        break;
                    case 'users':
                        ['users-search','role-filter','status-filter-users'].forEach(id=>{ const el=document.getElementById(id); if(el){ el.value=''; if(el.onchange) el.onchange(); }});
                        refreshUsers && refreshUsers();
                        break;
                }
                setClearFiltersVisibility(section);
            } catch {}
        }
        // Global variables
        let currentSection = 'overview';
        let interviews = [];
        let questions = [];
        let favoriteQuestionIds = new Set();
        let selectedPanelists = [];
        let allInterviewers = [];
        let sessions = [];
        let students = [];
        let studentSessions = [];
        let myInterviews = []; // Add missing myInterviews variable
        let currentUserId = null;
        
        // Pagination variables
        const ITEMS_PER_PAGE = 10;
        let currentPage = {
            interviews: 1,
            questions: 1,
            sessions: 1,
            students: 1,
            'student-sessions': 1,
            users: 1,
            'my-interviews': 1,
            consolidation: 1
        };
        let totalPages = {
            interviews: 1,
            questions: 1,
            sessions: 1,
            students: 1,
            'student-sessions': 1,
            users: 1,
            'my-interviews': 1,
            consolidation: 1
        };

        // Inline sorting state per tab
        const inlineSortState = {
            'interviews': { field: 'created_at', dir: 'desc' },
            'questions': { field: 'created_at', dir: 'desc' },
            'sessions': { field: 'created_at', dir: 'desc' },
            'students': { field: 'name', dir: 'asc' },
            'student-sessions': { field: 'created_at', dir: 'desc' },
            'users': { field: 'name', dir: 'asc' },
            'my-interviews': { field: 'created_at', dir: 'desc' }
        };

        function sortBy(tab, field) {
            const s = inlineSortState[tab] || (inlineSortState[tab] = { field, dir: 'asc' });
            if (s.field === field) {
                s.dir = s.dir === 'asc' ? 'desc' : 'asc';
            } else {
                s.field = field; s.dir = 'asc';
            }
            updateSortIndicators(tab);
            // re-render
            switch (tab) {
                case 'interviews': displayInterviews(); break;
                case 'questions': displayQuestions(); break;
                case 'sessions': displaySessions(); break;
                case 'students': displayStudents(); break;
                case 'student-sessions': displayStudentSessions(); break;
                case 'users': displayUsers(); break;
                case 'my-interviews': displayMyInterviews(); break;
            }
        }

        function updateSortIndicators(tab) {
            let sectionSel = '#interviews';
            if (tab === 'questions') sectionSel = '#questions';
            else if (tab === 'sessions') sectionSel = '#sessions';
            else if (tab === 'students') sectionSel = '#students';
            else if (tab === 'student-sessions') sectionSel = '#student-sessions';
            else if (tab === 'users') sectionSel = '#users';
            else if (tab === 'my-interviews') sectionSel = '#my-interviews';

            const state = inlineSortState[tab];
            const thead = document.querySelector(`${sectionSel} thead`);
            if (!thead) return;
            thead.querySelectorAll('th[data-field]').forEach(th => {
                const wrap = th.querySelector('.sort-indicator');
                if (!wrap) return;
                const asc = wrap.querySelector('.asc');
                const desc = wrap.querySelector('.desc');
                const isActive = th.getAttribute('data-field') === state.field;
                if (asc) asc.style.opacity = isActive && state.dir === 'asc' ? '1' : '0.3';
                if (desc) desc.style.opacity = isActive && state.dir === 'desc' ? '1' : '0.3';
            });
        }

        function applyInlineSearch(list, term, fields) {
            if (!term) return list;
            const t = term.toLowerCase();
            return list.filter(item => fields.some(f => {
                const v = (item[f] ?? '').toString().toLowerCase();
                return v.includes(t);
            }));
        }

        function applyInlineSort(list, tab) {
            const { field, dir } = inlineSortState[tab] || { field: 'created_at', dir: 'desc' };
            const asc = dir === 'asc';
            const getVal = (item) => {
                if (tab === 'questions') {
                    switch (field) {
                        case 'times_asked':
                            return Number(item.times_asked ?? item.count_of_times_asked ?? 0);
                        case 'average_score':
                            return Number(item.average_score ?? 0);
                        case 'success_rate':
                            return Number(item.success_rate ?? 0);
                        case 'question':
                            return (item.question ?? item.question_text ?? '').toString().toLowerCase();
                        case 'created_at':
                            return new Date(item.created_at || 0).getTime();
                        default:
                            return (item[field] ?? '').toString().toLowerCase();
                    }
                }
                switch (field) {
                    case 'created_at':
                        return new Date(item.created_at || item.interview_date || 0).getTime();
                    case 'duration_seconds':
                        return Number(item.duration_seconds || 0);
                    case 'interview_count':
                        return Number(item.interview_count || 0);
                    default:
                        return (item[field] ?? '').toString().toLowerCase();
                }
            };
            return [...list].sort((a, b) => {
                const av = getVal(a), bv = getVal(b);
                if (av < bv) return asc ? -1 : 1;
                if (av > bv) return asc ? 1 : -1;
                return 0;
            });
        }

        // Pagination utility functions
        function getPaginatedData(data, section) {
            const startIndex = (currentPage[section] - 1) * ITEMS_PER_PAGE;
            const endIndex = startIndex + ITEMS_PER_PAGE;
            return data.slice(startIndex, endIndex);
        }
        
        function updateTotalPages(data, section) {
            totalPages[section] = Math.ceil(data.length / ITEMS_PER_PAGE);
            if (currentPage[section] > totalPages[section] && totalPages[section] > 0) {
                currentPage[section] = totalPages[section];
            }
        }
        
        function createPaginationControls(section) {
            const totalPagesCount = totalPages[section];
            if (totalPagesCount <= 1) return '';
            
            let controls = '<div class="pagination-controls">';
            
            // Previous button
            if (currentPage[section] > 1) {
                controls += `<button class="pagination-btn" onclick="changePage('${section}', ${currentPage[section] - 1})">Previous</button>`;
            }
            
            // Page numbers
            const startPage = Math.max(1, currentPage[section] - 2);
            const endPage = Math.min(totalPagesCount, currentPage[section] + 2);
            
            if (startPage > 1) {
                controls += `<button class="pagination-btn" onclick="changePage('${section}', 1)">1</button>`;
                if (startPage > 2) {
                    controls += '<span class="pagination-ellipsis">...</span>';
                }
            }
            
            for (let i = startPage; i <= endPage; i++) {
                const activeClass = i === currentPage[section] ? 'active' : '';
                controls += `<button class="pagination-btn ${activeClass}" onclick="changePage('${section}', ${i})">${i}</button>`;
            }
            
            if (endPage < totalPagesCount) {
                if (endPage < totalPagesCount - 1) {
                    controls += '<span class="pagination-ellipsis">...</span>';
                }
                controls += `<button class="pagination-btn" onclick="changePage('${section}', ${totalPagesCount})">${totalPagesCount}</button>`;
            }
            
            // Next button
            if (currentPage[section] < totalPagesCount) {
                controls += `<button class="pagination-btn" onclick="changePage('${section}', ${currentPage[section] + 1})">Next</button>`;
            }
            
            controls += '</div>';
            return controls;
        }
        
        async function changePage(section, page) {
            currentPage[section] = page;
            await refreshCurrentSection();
        }
        
        async function refreshCurrentSection() {
            switch(currentSection) {
                case 'interviews':
                    displayInterviews();
                    break;
                case 'questions':
                    displayQuestions();
                    break;
                case 'sessions':
                    displaySessions();
                    break;
                case 'students':
                    displayStudents();
                    break;
                case 'student-sessions':
                    displayStudentSessions();
                    break;
                case 'users':
                    displayUsers();
                    break;
                case 'my-interviews':
                    displayMyInterviews();
                    break;
                case 'consolidation':
                    await loadConsolidation();
                    break;
            }
        }

        // Initialize dashboard
        let dashboardInitialized = false;
        
        document.addEventListener('DOMContentLoaded', function() {
            checkUserLoginStatus();
            setupEventListeners();
            
            // Check if Chart.js is already loaded (unlikely but possible)
            if (window.chartJsLoaded || typeof Chart !== 'undefined') {
                console.log(' Chart.js already loaded at DOMContentLoaded');
                initializeDashboard();
                dashboardInitialized = true;
            } else {
                console.log(' Waiting for Chart.js to load...');
            }
            
            // Activate tab from URL param, e.g., ?tab=my-interviews
            const params = new URLSearchParams(window.location.search);
            const tab = params.get('tab');
            if (tab) {
                switchSection(tab);
            }
        });
        
        // Listen for Chart.js ready event
        window.addEventListener('chartJsReady', function() {
            console.log(' Chart.js ready event received!');
            if (!dashboardInitialized) {
                initializeDashboard();
                dashboardInitialized = true;
            }
        });

        function initializeDashboard() {
            loadOverviewStats();
            loadInterviews();
            loadQuestions();
            loadSessions();
            loadStudents();
            loadUsers();
            
            // Initialize bulk edit controls
            initializeBulkEditControls();
            
            // Populate filter dropdowns with actual data
            populateFilterDropdowns();
        }

        function initializeBulkEditControls() {
            // Ensure bulk edit controls are properly initialized
            const bulkEditControls = document.querySelectorAll('.bulk-edit-controls');
            bulkEditControls.forEach(control => {
                if (!control.querySelector('.bulk-edit-info')) {
                    const info = document.createElement('div');
                    info.className = 'bulk-edit-info';
                    info.id = 'bulk-edit-selected-count';
                    info.textContent = '0 records selected';
                    control.appendChild(info);
                }
                
                if (!control.querySelector('.bulk-edit-actions')) {
                    const actions = document.createElement('div');
                    actions.className = 'bulk-edit-actions';
                    actions.innerHTML = `
                        <button class="btn btn-secondary" onclick="selectAllRows()">Select All</button>
                        <button class="btn btn-secondary" onclick="clearSelection()">Clear</button>
                        <button class="btn btn-danger" onclick="bulkDelete()">Bulk Delete</button>
                        <button class="btn btn-primary" onclick="openBulkEditModal()">Bulk Edit</button>
                    `;
                    control.appendChild(actions);
                }
            });

            // Remove floating actions creation
        }

        // Reload only the currently active tab's data (avoids relying on click side-effects)
        function reloadCurrentTab() {
            const active = document.querySelector('.nav-link.active');
            if (!active) return;
            const section = active.dataset.section || '';
            if (section === 'students') {
                loadStudents();
            } else if (section === 'sessions') {
                loadSessions();
            } else if (section === 'interviews') {
                loadInterviews();
            } else if (section === 'questions') {
                loadQuestions();
            } else if (section === 'my-interviews') {
                loadMyInterviewsForAdmin();
            } else if (section === 'users') {
                loadUsers();
            } else if (section === 'student-sessions') {
                loadStudentSessions();
            } else if (section === 'overview') {
                loadOverviewStats();
            }
        }

        function setupEventListeners() {
            // Navigation
            document.querySelectorAll('.nav-link').forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    const section = this.dataset.section;
                    // Clear any cross-tab selection/edit state
                    selectedRows.clear();
                    currentEditRow = null;
                    currentEditData = null;
                    updateBulkEditControls();
                    switchSection(section);
                });
            });

            // Global delegated handler for all edit buttons
            document.addEventListener('click', (e) => {
                const btn = e.target.closest('.edit-btn');
                if (!btn) return;
                e.preventDefault();
                e.stopPropagation();
                const tr = btn.closest('tr');
                const id = tr && tr.getAttribute('data-row-id');
                if (id) startEdit(id);
            }, { capture: false });

            // Create session form
            document.getElementById('create-session-form').addEventListener('submit', function(e) {
                e.preventDefault();
                createSession();
            });

            // Add question form - ensure only one listener
            const addQuestionForm = document.getElementById('add-question-form');
            if (addQuestionForm) {
                // Remove any existing listeners by cloning the element
                const newForm = addQuestionForm.cloneNode(true);
                addQuestionForm.parentNode.replaceChild(newForm, addQuestionForm);
                
                // Add single event listener
                newForm.addEventListener('submit', function(e) {
                    console.log(' Form submit event triggered');
                    e.preventDefault();
                    addQuestion();
                });
            }
        }

        // Cache consolidation data to avoid unnecessary reloads
        let consolidationDataCache = null;
        let consolidationCacheTime = null;
        const CONSOLIDATION_CACHE_TTL = 30000; // 30 seconds cache
        
        async function loadConsolidation(forceRefresh = false) {
            try {
                // Restore session filter from sessionStorage if not already set
                if (consolidationSessionFilter === null) {
                    try {
                        const stored = sessionStorage.getItem('consolidationSessionFilter');
                        if (stored) {
                            consolidationSessionFilter = parseInt(stored);
                        }
                    } catch (e) {
                        console.warn('Failed to restore session filter:', e);
                    }
                }

                const tbody = document.getElementById('consolidation-table-body');
                if (tbody) tbody.innerHTML = '<tr><td colspan="9" class="loading">Loading consolidation data...</td></tr>';
                
                // Check cache first unless force refresh
                const now = Date.now();
                if (!forceRefresh && consolidationDataCache && consolidationCacheTime && (now - consolidationCacheTime) < CONSOLIDATION_CACHE_TTL) {
                    // Use cached data
                    window.__consolidationRows = consolidationDataCache;
                } else {
                    // Only refresh backend if cache expired or force refresh
                    if (forceRefresh) {
                await fetch('/api/admin/consolidation/refresh', { method: 'POST' });
                    }
                
                    // Load the data
                const res = await fetch('/api/admin/consolidation');
                const json = await res.json();
                if (!res.ok || !json.success) throw new Error(json.error || 'Failed to load');
                    
                    // Update cache
                    consolidationDataCache = json.data || [];
                    consolidationCacheTime = now;
                    window.__consolidationRows = consolidationDataCache;
                }
                
                // Apply filters and sort to cached data (no API call needed)
                let rows = applyConsolidationFiltersAndSort(window.__consolidationRows);
                // Apply advanced filters for consolidation
                rows = applyAdvancedFiltersCons(rows);
                if (!tbody) return;
                if (rows.length === 0) {
                    // Check if no data at all or just no matches after filtering
                    const hasFilters = window.__consolidationSearch || document.getElementById('filters-container-cons')?.querySelectorAll('.filter-row-adv').length > 0;
                    tbody.innerHTML = `<tr><td colspan="11" class="empty-state">${hasFilters ? 'No matches found for your search or filter criteria' : 'No consolidation data'}</td></tr>`;
                    // Remove pagination controls and info
                    const container = document.querySelector('#consolidation .table-container');
                    if (container) {
                        const existingPagination = container.querySelector('.pagination-controls');
                        if (existingPagination) existingPagination.remove();
                        const existingInfo = container.querySelector('.pagination-info');
                        if (existingInfo) existingInfo.remove();
                    }
                    return;
                }
                
                // Update pagination
                updateTotalPages(rows, 'consolidation');
                const paginatedData = getPaginatedData(rows, 'consolidation');
                
                const badge = (v)=>{
                    const t=String(v||'').toLowerCase();
                    const tiger=t.includes('tiger'), cow=t.includes('cow'), sheep=t.includes('sheep');
                    const color = tiger? '#048C18' : cow? '#f59e0b' : sheep? '#6b7280' : (t.includes('select')? '#10b981' : t.includes('reject')? '#ef4444' : (t.includes('wait')||t.includes('hold')||t.includes('maybe'))? '#f59e0b' : '#6b7280');
                    return `<span style="display:inline-block;background:${color};color:#fff;padding:3px 8px;border-radius:12px;font-size:11px;margin:2px;white-space:nowrap">${v||'-'}</span>`;
                };
                const statusBadge = (v)=>{
                    const t=String(v||'').toLowerCase();
                    const color = t.includes('completed')? '#10b981' : t.includes('progress')? '#f59e0b' : '#6b7280';
                    return `<span style="display:inline-block;background:${color};color:#fff;padding:3px 8px;border-radius:12px;font-size:11px;margin:2px;white-space:nowrap">${v||'-'}</span>`;
                };
                const html = paginatedData.map(r => {
                    const interviewerNames = Array.isArray(r.interviewer_names) ? r.interviewer_names : [];
                    const interviewerNamesDisplay = interviewerNames.length > 0 ? interviewerNames.join('<br>') : '-';
                    const verdictsArray = Array.isArray(r.verdicts) ? r.verdicts : [];
                    const verdicts = verdictsArray.length > 0 ? verdictsArray.map(badge).join('<br>') : '-';
                    // Format scores per interviewer (matching interviewer_names order)
                    const interviewScores = Array.isArray(r.interview_scores) ? r.interview_scores : [];
                    const interviewQuestionCounts = Array.isArray(r.interview_question_counts) ? r.interview_question_counts : [];
                    const scoresDisplay = interviewerNames.map((name, idx) => {
                        const score = interviewScores[idx] !== undefined && interviewScores[idx] !== null ? interviewScores[idx] : 0;
                        const questionCount = interviewQuestionCounts[idx] !== undefined && interviewQuestionCounts[idx] !== null ? interviewQuestionCounts[idx] : 0;
                        if (questionCount > 0) {
                            return `${score}/${questionCount}`;
                        }
                        return '-';
                    }).join('<br>');
                    const interviewStatuses = Array.isArray(r.interview_statuses) ? r.interview_statuses.map(statusBadge).join('<br>') : '-';
                    const lastAt = r.last_interview_at ? formatDate(r.last_interview_at) : '-';
                    const status = r.status || '';
                    const notes = r.notes ? r.notes.replace(/\n/g,'<br>') : '-';
                    return `
                        <tr>
                            <td><input type="checkbox" class="consolidation-checkbox" value="${r.id}" onchange="updateBulkEmailButton()"></td>
                            <td>${r.student_name || '-'}</td>
                            <td>${r.zeta_id || '-'}</td>
                            <td>${r.session_name || '-'}</td>
                            <td style="line-height:1.8">${interviewerNamesDisplay}</td>
                            <td style="line-height:1.8">${verdicts}</td>
                            <td style="line-height:1.8">${scoresDisplay || '-'}</td>
                            <td style="line-height:1.8">${interviewStatuses}</td>
                            <td>${status ? `<span class="status-badge ${status}" style="display:inline-block;padding:3px 8px;border-radius:12px;color:#fff;background:${String(status).toLowerCase().includes('select')?'#10b981':String(status).toLowerCase().includes('reject')?'#ef4444':String(status).toLowerCase().includes('wait')?'#f59e0b':'#6b7280'}">${status}</span>` : ''}</td>
                            <td>
                                <div style="max-height:64px;overflow:hidden;position:relative">
                                    <div>${notes}</div>
                                    ${notes && notes.length>120 ? '<div style="position:absolute;bottom:0;left:0;right:0;height:24px;background:linear-gradient(180deg, rgba(255,0,255,255,0), #fff)"></div>' : ''}
                                </div>
                            </td>
                            <td>${lastAt}</td>
                            <td>
                                <div class="action-menu-container">
                                  <button class="icon-btn menu-btn" onclick="toggleConsMenu(${r.id})" title="Actions"></button>
                                  <div id="cons-menu-${r.id}" class="user-action-menu hidden">
                                      <button onclick="updateConsolidationStatus(${r.id},'selected')" class="menu-item">Select</button>
                                      <button onclick="updateConsolidationStatus(${r.id},'rejected')" class="menu-item">Reject</button>
                                      <button onclick="updateConsolidationStatus(${r.id},'waitlisted')" class="menu-item">Waitlist</button>
                                  </div>
                                </div>
                                <button class="icon-btn" title="View" onclick="openConsDetail(${r.id})" aria-label="View details" style="border:1px solid #e5e7eb;background:#fff;border-radius:6px;padding:6px 8px;cursor:pointer;margin-right:4px"><img src="/view.png" alt="View" style="width:16px;height:16px;vertical-align:middle"></button>
                                <button class="icon-btn" onclick="openSendMailPopup(${r.id})" title="Send Mail" aria-label="Send Mail" style="border:1px solid #e5e7eb;background:#fff;border-radius:6px;padding:6px 8px;cursor:pointer;margin-left:4px"><img src="/send-mail.png" alt="Send Mail" style="width:16px;height:16px;vertical-align:middle"></button>
                            </td>
                        </tr>
                    `;
                }).join('');
                tbody.innerHTML = html;
                
                // Add pagination controls
                const container = document.querySelector('#consolidation .table-container');
                if (container) {
                    const existingPagination = container.querySelector('.pagination-controls');
                    if (existingPagination) {
                        existingPagination.remove();
                    }
                    
                    const paginationHTML = createPaginationControls('consolidation');
                    if (paginationHTML) {
                        container.insertAdjacentHTML('beforeend', paginationHTML);
                    }
                    
                    // Add pagination info
                    const existingInfo = container.querySelector('.pagination-info');
                    if (existingInfo) {
                        existingInfo.remove();
                    }
                    
                    const startIndex = (currentPage['consolidation'] - 1) * ITEMS_PER_PAGE + 1;
                    const endIndex = Math.min(currentPage['consolidation'] * ITEMS_PER_PAGE, rows.length);
                    const infoHTML = `
                        <div class="pagination-info">
                            <span>Showing ${startIndex}-${endIndex} of ${rows.length} records</span>
                            <span>Page ${currentPage['consolidation']} of ${totalPages['consolidation']}</span>
                        </div>
                    `;
                    container.insertAdjacentHTML('beforeend', infoHTML);
                }
            } catch (e) {
                console.error('Error loading consolidation:', e);
                const tbody = document.getElementById('consolidation-table-body');
                if (tbody) tbody.innerHTML = '<tr><td colspan="11" class="error">Error loading consolidation</td></tr>';
            }
        }

        function toggleConsMenu(id){
            const el = document.getElementById(`cons-menu-${id}`);
            if (!el) return; el.classList.toggle('hidden');
        }

        // Inline search + sort for Consolidation
        let consolidationSortField = '';
        let consolidationSortDir = 'asc';
        function onConsolidationSearch(val){
            window.__consolidationSearch = (val||'').trim().toLowerCase();
            loadConsolidation(false); // Use cache, just re-filter
        }
        function setConsolidationSort(field){
            if (consolidationSortField === field){
                consolidationSortDir = consolidationSortDir === 'asc' ? 'desc' : 'asc';
            } else {
                consolidationSortField = field; consolidationSortDir = 'asc';
            }
            loadConsolidation(false); // Use cache, just re-sort
        }
        // Global variable to store session filter for consolidation
        // Initialize from sessionStorage if available
        let consolidationSessionFilter = (() => {
            try {
                const stored = sessionStorage.getItem('consolidationSessionFilter');
                return stored ? parseInt(stored) : null;
            } catch (e) {
                return null;
            }
        })();

        // Function to view consolidation filtered by session
        function viewConsolidationForSession(sessionId) {
            // Set the session filter
            const sessionIdInt = parseInt(sessionId);
            consolidationSessionFilter = sessionIdInt;
            
            // Store in sessionStorage for persistence
            try {
                sessionStorage.setItem('consolidationSessionFilter', sessionIdInt.toString());
            } catch (e) {
                console.warn('Failed to store session filter:', e);
            }
            
            // Clear consolidation search
            const searchInput = document.getElementById('consolidation-search');
            if (searchInput) {
                searchInput.value = '';
                window.__consolidationSearch = '';
            }
            
            // Clear advanced filters
            const filtersContainer = document.getElementById('filters-container-cons');
            if (filtersContainer) {
                filtersContainer.innerHTML = '';
            }
            
            // Switch to consolidation tab
            const consolidationLink = document.querySelector('[data-section="consolidation"]');
            if (consolidationLink) {
                consolidationLink.click();
            } else {
                // Fallback: manually switch tabs
                document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
                document.querySelectorAll('.content-section').forEach(s => s.style.display = 'none');
                const consolidationSection = document.getElementById('consolidation');
                if (consolidationSection) {
                    consolidationSection.style.display = 'block';
                }
                if (consolidationLink) {
                    consolidationLink.classList.add('active');
            }
            loadConsolidation();
        }
        }

        function applyConsolidationFiltersAndSort(items){
            let out = Array.isArray(items)? [...items] : [];
            const q = window.__consolidationSearch || '';
            if (q){
                out = out.filter(r=>{
                    const hay = `${r.student_name||''} ${r.student_email||''} ${r.zeta_id||''} ${r.session_name||''} ${r.status||''} ${(r.verdicts||[]).join(' ')}`.toLowerCase();
                    return hay.includes(q);
                });
            }
            // Apply session filter if set
            if (consolidationSessionFilter !== null) {
                out = out.filter(r => r.session_id === consolidationSessionFilter);
            }
            if (consolidationSortField){
                out.sort((a,b)=>{
                    const av = a[consolidationSortField];
                    const bv = b[consolidationSortField];
                    if (av == null && bv == null) return 0;
                    if (av == null) return consolidationSortDir==='asc' ? -1 : 1;
                    if (bv == null) return consolidationSortDir==='asc' ? 1 : -1;
                    if (consolidationSortField === 'last_interview_at'){
                        const ad = av ? new Date(av).getTime() : 0;
                        const bd = bv ? new Date(bv).getTime() : 0;
                        return consolidationSortDir==='asc' ? ad-bd : bd-ad;
                    }
                    const as = String(av).toLowerCase();
                    const bs = String(bv).toLowerCase();
                    if (as < bs) return consolidationSortDir==='asc' ? -1 : 1;
                    if (as > bs) return consolidationSortDir==='asc' ? 1 : -1;
                    return 0;
                });
            }
            return out;
        }

        // Advanced Filters for Consolidation
        const consFilterFields = [
            { value:'student_name', label:'Student' },
            { value:'student_email', label:'Email' },
            { value:'zeta_id', label:'Zeta ID' },
            { value:'session_name', label:'Session' },
            { value:'status', label:'Status' },
            { value:'verdicts', label:'Verdicts' },
            { value:'total_score', label:'Total Score' },
            { value:'question_count', label:'Question Count' },
            { value:'last_interview_at', label:'Last Interview' }
        ];
        function addConsFilterRow(){
            const c = document.getElementById('filters-container-cons'); if (!c) return;
            const isFirst = c.querySelectorAll('.filter-row-adv').length === 0;
            const row = document.createElement('div');
            row.className = 'filter-row-adv';
            row.style.cssText = 'display:flex;gap:8px;align-items:center;flex-wrap:wrap';
            const connectorHtml = isFirst ? '' : `<select class=\"filter-connector form-select\" style=\"min-width:90px\">\n<option value=\"AND\">AND<\/option>\n<option value=\"OR\">OR<\/option>\n<option value=\"NOT\">NOT<\/option>\n<\/select>`;
            row.innerHTML = `
                ${connectorHtml}
                <select class=\"filter-field form-select\" style=\"min-width:140px\">
                    ${consFilterFields.map(f=>`<option value=\"${f.value}\">${f.label}</option>`).join('')}
                </select>
                <select class=\"filter-op form-select\" style=\"min-width:140px\"></select>
                <input type=\"text\" class=\"filter-value form-input\" placeholder=\"Value\" style=\"min-width:180px\">
                <input type=\"date\" class=\"filter-value2 form-input\" style=\"display:none\">
                <button class=\"btn btn-secondary\" onclick=\"removeFilterRow(this,'filters-container-cons');\">Remove</button>
            `;
            c.appendChild(row);
            bindConsFilterRow(row);
            updateConsFilterFieldOptions();
            loadConsolidation();
        }
        function bindConsFilterRow(row){
            const fieldSel = row.querySelector('.filter-field');
            const opSel = row.querySelector('.filter-op');
            const v1 = row.querySelector('.filter-value');
            const v2 = row.querySelector('.filter-value2');
            function refreshOps(){
                const f = fieldSel.value;
                const isDate = (f === 'last_interview_at');
                const isArray = (f === 'verdicts');
                const ops = isDate ? dateOps : textOps;
                opSel.innerHTML = ops.map(o=>`<option value=\"${o}\">${o}</option>`).join('');
                v1.type = isDate ? 'date' : 'text';
                v2.style.display = 'none'; v2.value = '';
                opSel.onchange = ()=>{
                    const op = opSel.value;
                    if (isDate && (op==='between' || op==='not_between')) { v2.style.display='block'; } else { v2.style.display='none'; v2.value=''; }
                    loadConsolidation();
                };
            }
            fieldSel.onchange = ()=>{ refreshOps(); updateConsFilterFieldOptions(); loadConsolidation(false); };
            v1.oninput = ()=> loadConsolidation(false);
            v2.oninput = ()=> loadConsolidation(false);
            const connEl = row.querySelector('.filter-connector');
            if (connEl) connEl.onchange = ()=> loadConsolidation(false);
            refreshOps();
        }
        function clearAdvancedFiltersCons(){ const c=document.getElementById('filters-container-cons'); if(c){ c.innerHTML=''; } loadConsolidation(false); }
        function updateConsFilterFieldOptions(){ updateAdvFieldOptions('filters-container-cons', consFilterFields); }
        function applyAdvancedFiltersCons(items){
            const c = document.getElementById('filters-container-cons'); if (!c) return items;
            const rows = Array.from(c.querySelectorAll('.filter-row-adv'));
            if (rows.length===0) return items;
            function matchRow(r, row){
                const field = row.querySelector('.filter-field').value;
                const op = row.querySelector('.filter-op').value;
                const v1 = row.querySelector('.filter-value').value;
                const v2 = row.querySelector('.filter-value2').value;
                const valRaw = r[field];
                if (field==='last_interview_at'){
                    const ts = valRaw ? new Date(valRaw).getTime() : 0;
                    const t1 = v1 ? new Date(v1).getTime() : NaN;
                    const t2 = v2 ? new Date(v2).getTime() : NaN;
                    switch(op){
                        case '=': return ts===t1;
                        case '': return ts!==t1;
                        case '>': return ts>t1;
                        case '': return ts>=t1;
                        case '<': return ts<t1;
                        case '': return ts<=t1;
                        case 'between': return !isNaN(t1)&&!isNaN(t2) && ts>=Math.min(t1,t2) && ts<=Math.max(t1,t2);
                        case 'not_between': return !isNaN(t1)&&!isNaN(t2) && (ts<Math.min(t1,t2) || ts>Math.max(t1,t2));
                        default: return true;
                    }
                } else if (field==='verdicts'){
                    const list = Array.isArray(valRaw) ? valRaw.map(v=> String(v).toLowerCase()) : [];
                    const q = (v1||'').toLowerCase();
                    const joined = list.join(' ');
                    switch(op){
                        case 'contains': return joined.includes(q);
                        case 'equals': return joined===q;
                        case 'starts_with': return joined.startsWith(q);
                        case 'ends_with': return joined.endsWith(q);
                        case 'not_contains': return !joined.includes(q);
                        case 'not_equals': return joined!==q;
                        default: return true;
                    }
                } else {
                    const val = (valRaw ?? '').toString().toLowerCase();
                    const q = (v1||'').toLowerCase();
                    switch(op){
                        case 'contains': return val.includes(q);
                        case 'equals': return val===q;
                        case 'starts_with': return val.startsWith(q);
                        case 'ends_with': return val.endsWith(q);
                        case 'not_contains': return !val.includes(q);
                        case 'not_equals': return val!==q;
                        default: return true;
                    }
                }
            }
            return items.filter(r=>{
                let result = true; let first = true;
                for (const row of rows){
                    const connEl = row.querySelector('.filter-connector');
                    const conn = connEl ? connEl.value : 'AND';
                    const m = matchRow(r, row);
                    if (first){ result = m; first=false; continue; }
                    if (conn==='AND') result = result && m;
                    else if (conn==='OR') result = result || m;
                    else if (conn==='NOT') result = result && !m;
                }
                return result;
            });
        }

        // ============ Questions Filter Functions ============
        const questionsFilterFields = [
            { value:'question', label:'Question Text' },
            { value:'tags', label:'Tags' },
            { value:'times_asked', label:'Times Asked' },
            { value:'average_score', label:'Average Score' }
        ];
        function addQuestionsFilterRow(){
            const c = document.getElementById('filters-container-questions'); if (!c) return;
            const isFirst = c.querySelectorAll('.filter-row-adv').length === 0;
            const row = document.createElement('div');
            row.className = 'filter-row-adv';
            row.style.cssText = 'display:flex;gap:8px;align-items:center;flex-wrap:wrap';
            const connectorHtml = isFirst ? '' : `<select class="filter-connector form-select" style="min-width:90px">
<option value="AND">AND</option>
<option value="OR">OR</option>
<option value="NOT">NOT</option>
</select>`;
            row.innerHTML = `
                ${connectorHtml}
                <select class="filter-field form-select" style="min-width:140px">
                    ${questionsFilterFields.map(f=>`<option value="${f.value}">${f.label}</option>`).join('')}
                </select>
                <select class="filter-op form-select" style="min-width:140px"></select>
                <input type="text" class="filter-value form-input" placeholder="Value" style="min-width:180px">
                <input type="text" class="filter-value2 form-input" placeholder="Value 2" style="display:none;min-width:120px">
                <button class="btn btn-secondary" onclick="removeQuestionsFilterRow(this);">Remove</button>
            `;
            c.appendChild(row);
            bindQuestionsFilterRow(row);
            updateQuestionsFilterFieldOptions();
            displayQuestions();
        }
        function bindQuestionsFilterRow(row){
            const fieldSel = row.querySelector('.filter-field');
            const opSel = row.querySelector('.filter-op');
            const v1 = row.querySelector('.filter-value');
            const v2 = row.querySelector('.filter-value2');
            function refreshOps(){
                const f = fieldSel.value;
                const isNumeric = (f === 'times_asked' || f === 'average_score');
                const ops = isNumeric ? ['=','','>','','<','','between','not_between'] : textOps;
                opSel.innerHTML = ops.map(o=>`<option value="${o}">${o}</option>`).join('');
                v1.type = isNumeric ? 'number' : 'text';
                v2.type = isNumeric ? 'number' : 'text';
                v2.style.display = 'none'; v2.value = '';
                opSel.onchange = ()=>{
                    const op = opSel.value;
                    if (op==='between' || op==='not_between') { v2.style.display='inline-block'; } else { v2.style.display='none'; v2.value=''; }
                    displayQuestions();
                };
            }
            fieldSel.onchange = ()=>{ refreshOps(); updateQuestionsFilterFieldOptions(); displayQuestions(); };
            v1.oninput = ()=> displayQuestions();
            v2.oninput = ()=> displayQuestions();
            const connEl = row.querySelector('.filter-connector');
            if (connEl) connEl.onchange = ()=> displayQuestions();
            refreshOps();
        }
        function clearAdvancedFiltersQuestions(){ const c=document.getElementById('filters-container-questions'); if(c){ c.innerHTML=''; } displayQuestions(); }
        function removeQuestionsFilterRow(btn){ const row = btn.parentElement; row && row.remove(); updateQuestionsFilterFieldOptions(); displayQuestions(); }
        function updateQuestionsFilterFieldOptions(){ updateAdvFieldOptions('filters-container-questions', questionsFilterFields); }
        function applyAdvancedFiltersQuestions(items){
            const c = document.getElementById('filters-container-questions'); if (!c) return items;
            const rows = Array.from(c.querySelectorAll('.filter-row-adv'));
            if (rows.length===0) return items;
            function matchRow(item, row){
                const field = row.querySelector('.filter-field').value;
                const op = row.querySelector('.filter-op').value;
                const v1 = row.querySelector('.filter-value').value;
                const v2 = row.querySelector('.filter-value2').value;
                if (!v1 && op !== 'not_between') return true;
                const valRaw = item[field];
                if (field==='times_asked' || field==='average_score'){
                    const num = Number(valRaw) || 0;
                    const n1 = Number(v1) || 0;
                    const n2 = Number(v2) || 0;
                    switch(op){
                        case '=': return num === n1;
                        case '': return num !== n1;
                        case '>': return num > n1;
                        case '': return num >= n1;
                        case '<': return num < n1;
                        case '': return num <= n1;
                        case 'between': return num >= Math.min(n1,n2) && num <= Math.max(n1,n2);
                        case 'not_between': return num < Math.min(n1,n2) || num > Math.max(n1,n2);
                        default: return true;
                    }
                } else {
                    const val = (valRaw ?? '').toString().trim().toLowerCase();
                    const q = (v1||'').trim().toLowerCase();
                    switch(op){
                        case 'contains': return val.includes(q);
                        case 'equals': return val===q;
                        case 'starts_with': return val.startsWith(q);
                        case 'ends_with': return val.endsWith(q);
                        case 'not_contains': return !val.includes(q);
                        case 'not_equals': return val!==q;
                        default: return true;
                    }
                }
            }
            return items.filter(r=>{
                let result = true; let first = true;
                for (const row of rows){
                    const connEl = row.querySelector('.filter-connector');
                    const conn = connEl ? connEl.value : 'AND';
                    const m = matchRow(r, row);
                    if (first){ result = m; first=false; continue; }
                    if (conn==='AND') result = result && m;
                    else if (conn==='OR') result = result || m;
                    else if (conn==='NOT') result = result && !m;
                }
                return result;
            });
        }

        // ============ Sessions Filter Functions ============
        const sessionsFilterFields = [
            { value:'name', label:'Name' },
            { value:'description', label:'Description' },
            { value:'status', label:'Status' },
            { value:'created_by_name', label:'Created By' },
            { value:'created_at', label:'Created At' }
        ];
        function addSessionsFilterRow(){
            const c = document.getElementById('filters-container-sessions'); if (!c) return;
            const isFirst = c.querySelectorAll('.filter-row-adv').length === 0;
            const row = document.createElement('div');
            row.className = 'filter-row-adv';
            row.style.cssText = 'display:flex;gap:8px;align-items:center;flex-wrap:wrap';
            const connectorHtml = isFirst ? '' : `<select class="filter-connector form-select" style="min-width:90px">
<option value="AND">AND</option>
<option value="OR">OR</option>
<option value="NOT">NOT</option>
</select>`;
            row.innerHTML = `
                ${connectorHtml}
                <select class="filter-field form-select" style="min-width:140px">
                    ${sessionsFilterFields.map(f=>`<option value="${f.value}">${f.label}</option>`).join('')}
                </select>
                <select class="filter-op form-select" style="min-width:140px"></select>
                <input type="text" class="filter-value form-input" placeholder="Value" style="min-width:180px">
                <input type="date" class="filter-value2 form-input" style="display:none">
                <button class="btn btn-secondary" onclick="removeSessionsFilterRow(this);">Remove</button>
            `;
            c.appendChild(row);
            bindSessionsFilterRow(row);
            updateSessionsFilterFieldOptions();
            displaySessions();
        }
        function bindSessionsFilterRow(row){
            const fieldSel = row.querySelector('.filter-field');
            const opSel = row.querySelector('.filter-op');
            const v1 = row.querySelector('.filter-value');
            const v2 = row.querySelector('.filter-value2');
            function refreshOps(){
                const f = fieldSel.value;
                const isDate = (f === 'created_at');
                const ops = isDate ? dateOps : textOps;
                opSel.innerHTML = ops.map(o=>`<option value="${o}">${o}</option>`).join('');
                v1.type = isDate ? 'date' : 'text';
                v2.style.display = 'none'; v2.value = '';
                opSel.onchange = ()=>{
                    const op = opSel.value;
                    if (isDate && (op==='between' || op==='not_between')) { v2.style.display='block'; } else { v2.style.display='none'; v2.value=''; }
                    displaySessions();
                };
            }
            fieldSel.onchange = ()=>{ refreshOps(); updateSessionsFilterFieldOptions(); displaySessions(); };
            v1.oninput = ()=> displaySessions();
            v2.oninput = ()=> displaySessions();
            const connEl = row.querySelector('.filter-connector');
            if (connEl) connEl.onchange = ()=> displaySessions();
            refreshOps();
        }
        function clearAdvancedFiltersSessions(){ const c=document.getElementById('filters-container-sessions'); if(c){ c.innerHTML=''; } displaySessions(); }
        function removeSessionsFilterRow(btn){ const row = btn.parentElement; row && row.remove(); updateSessionsFilterFieldOptions(); displaySessions(); }
        function updateSessionsFilterFieldOptions(){ updateAdvFieldOptions('filters-container-sessions', sessionsFilterFields); }
        function applyAdvancedFiltersSessions(items){
            const c = document.getElementById('filters-container-sessions'); if (!c) return items;
            const rows = Array.from(c.querySelectorAll('.filter-row-adv'));
            if (rows.length===0) return items;
            function matchRow(item, row){
                const field = row.querySelector('.filter-field').value;
                const op = row.querySelector('.filter-op').value;
                const v1 = row.querySelector('.filter-value').value;
                const v2 = row.querySelector('.filter-value2').value;
                if (!v1 && op !== 'not_between') return true;
                const valRaw = item[field];
                if (field==='created_at'){
                    const ts = valRaw ? new Date(valRaw).getTime() : 0;
                    if (!v1) return true;
                    const d1 = v1 ? new Date(v1) : null;
                    const t1 = d1 ? (d1.setHours(0,0,0,0), d1.getTime()) : NaN;
                    const d2 = v2 ? new Date(v2) : null;
                    const t2 = d2 ? (d2.setHours(23,59,59,999), d2.getTime()) : NaN;
                    const dayStart = d1 ? t1 : NaN;
                    const dayEnd = d1 ? (new Date(v1)).setHours(23,59,59,999) : NaN;
                    switch(op){
                        case '=': return !isNaN(dayStart) && ts>=dayStart && ts<=dayEnd;
                        case '': return !isNaN(dayStart) && (ts<dayStart || ts>dayEnd);
                        case '>': return ts>t1;
                        case '': return ts>=t1;
                        case '<': return ts<t1;
                        case '': return ts<=t1;
                        case 'between': return !isNaN(t1)&&!isNaN(t2) && ts>=Math.min(t1,t2) && ts<=Math.max(t1,t2);
                        case 'not_between': return (isNaN(t1)||isNaN(t2)) ? true : (ts<Math.min(t1,t2) || ts>Math.max(t1,t2));
                        default: return true;
                    }
                } else {
                    if (!v1) return true;
                    const val = (valRaw ?? '').toString().trim().toLowerCase();
                    const q = (v1||'').trim().toLowerCase();
                    switch(op){
                        case 'contains': return val.includes(q);
                        case 'equals': return val===q;
                        case 'starts_with': return val.startsWith(q);
                        case 'ends_with': return val.endsWith(q);
                        case 'not_contains': return !val.includes(q);
                        case 'not_equals': return val!==q;
                        default: return true;
                    }
                }
            }
            return items.filter(r=>{
                let result = true; let first = true;
                for (const row of rows){
                    const connEl = row.querySelector('.filter-connector');
                    const conn = connEl ? connEl.value : 'AND';
                    const m = matchRow(r, row);
                    if (first){ result = m; first=false; continue; }
                    if (conn==='AND') result = result && m;
                    else if (conn==='OR') result = result || m;
                    else if (conn==='NOT') result = result && !m;
                }
                return result;
            });
        }

        // ============ Students Filter Functions ============
        const studentsFilterFields = [
            { value:'name', label:'Name' },
            { value:'email', label:'Email' },
            { value:'zeta_id', label:'Zeta ID' },
            { value:'phone', label:'Phone' },
            { value:'school', label:'School' },
            { value:'location', label:'Location' },
            { value:'created_at', label:'Created At' }
        ];
        function addStudentsFilterRow(){
            const c = document.getElementById('filters-container-students'); if (!c) return;
            const isFirst = c.querySelectorAll('.filter-row-adv').length === 0;
            const row = document.createElement('div');
            row.className = 'filter-row-adv';
            row.style.cssText = 'display:flex;gap:8px;align-items:center;flex-wrap:wrap';
            const connectorHtml = isFirst ? '' : `<select class="filter-connector form-select" style="min-width:90px">
<option value="AND">AND</option>
<option value="OR">OR</option>
<option value="NOT">NOT</option>
</select>`;
            row.innerHTML = `
                ${connectorHtml}
                <select class="filter-field form-select" style="min-width:140px">
                    ${studentsFilterFields.map(f=>`<option value="${f.value}">${f.label}</option>`).join('')}
                </select>
                <select class="filter-op form-select" style="min-width:140px"></select>
                <input type="text" class="filter-value form-input" placeholder="Value" style="min-width:180px">
                <input type="date" class="filter-value2 form-input" style="display:none">
                <button class="btn btn-secondary" onclick="removeStudentsFilterRow(this);">Remove</button>
            `;
            c.appendChild(row);
            bindStudentsFilterRow(row);
            updateStudentsFilterFieldOptions();
            displayStudents();
        }
        function bindStudentsFilterRow(row){
            const fieldSel = row.querySelector('.filter-field');
            const opSel = row.querySelector('.filter-op');
            const v1 = row.querySelector('.filter-value');
            const v2 = row.querySelector('.filter-value2');
            function refreshOps(){
                const f = fieldSel.value;
                const isDate = (f === 'created_at');
                const ops = isDate ? dateOps : textOps;
                opSel.innerHTML = ops.map(o=>`<option value="${o}">${o}</option>`).join('');
                v1.type = isDate ? 'date' : 'text';
                v2.style.display = 'none'; v2.value = '';
                opSel.onchange = ()=>{
                    const op = opSel.value;
                    if (isDate && (op==='between' || op==='not_between')) { v2.style.display='block'; } else { v2.style.display='none'; v2.value=''; }
                    displayStudents();
                };
            }
            fieldSel.onchange = ()=>{ refreshOps(); updateStudentsFilterFieldOptions(); displayStudents(); };
            v1.oninput = ()=> displayStudents();
            v2.oninput = ()=> displayStudents();
            const connEl = row.querySelector('.filter-connector');
            if (connEl) connEl.onchange = ()=> displayStudents();
            refreshOps();
        }
        function clearAdvancedFiltersStudents(){ const c=document.getElementById('filters-container-students'); if(c){ c.innerHTML=''; } displayStudents(); }
        function removeStudentsFilterRow(btn){ const row = btn.parentElement; row && row.remove(); updateStudentsFilterFieldOptions(); displayStudents(); }
        function updateStudentsFilterFieldOptions(){ updateAdvFieldOptions('filters-container-students', studentsFilterFields); }
        
        // Student Sessions Advanced Filters
        const studentSessionsFilterFields = [
            { value: 'student_name', label: 'Student Name' },
            { value: 'phone', label: 'Phone' },
            { value: 'email', label: 'Email' },
            { value: 'zeta_id', label: 'Zeta ID' },
            { value: 'session_name', label: 'Session Name' },
            { value: 'session_status', label: 'Interview Status' },
            { value: 'total_score', label: 'Total Score' },
            { value: 'question_count', label: 'Question Count' },
            { value: 'created_at', label: 'Created At' }
        ];
        function addStudentSessionsFilterRow(){
            const c = document.getElementById('filters-container-student-sessions'); if (!c) return;
            const isFirst = c.querySelectorAll('.filter-row-adv').length === 0;
            const row = document.createElement('div');
            row.className = 'filter-row-adv';
            row.style.cssText = 'display:flex;gap:8px;align-items:center;flex-wrap:wrap';
            const connectorHtml = isFirst ? '' : `<select class="filter-connector form-select" style="min-width:90px">
<option value="AND">AND</option>
<option value="OR">OR</option>
<option value="NOT">NOT</option>
</select>`;
            row.innerHTML = `
                ${connectorHtml}
                <select class="filter-field form-select" style="min-width:140px">
                    ${studentSessionsFilterFields.map(f=>`<option value="${f.value}">${f.label}</option>`).join('')}
                </select>
                <select class="filter-op form-select" style="min-width:140px"></select>
                <input type="text" class="filter-value form-input" placeholder="Value" style="min-width:180px">
                <input type="date" class="filter-value2 form-input" style="display:none">
                <button class="btn btn-secondary" onclick="removeStudentSessionsFilterRow(this);">Remove</button>
            `;
            c.appendChild(row);
            bindStudentSessionsFilterRow(row);
            updateStudentSessionsFilterFieldOptions();
            displayStudentSessions();
        }
        function bindStudentSessionsFilterRow(row){
            const fieldSel = row.querySelector('.filter-field');
            const opSel = row.querySelector('.filter-op');
            const v1 = row.querySelector('.filter-value');
            const v2 = row.querySelector('.filter-value2');
            function refreshOps(){
                const f = fieldSel.value;
                const isDate = (f === 'created_at');
                const ops = isDate ? dateOps : textOps;
                opSel.innerHTML = ops.map(o=>`<option value="${o}">${o}</option>`).join('');
                v1.type = isDate ? 'date' : 'text';
                v2.style.display = 'none'; v2.value = '';
                opSel.onchange = ()=>{
                    const op = opSel.value;
                    if (isDate && (op==='between' || op==='not_between')) { v2.style.display='block'; } else { v2.style.display='none'; v2.value=''; }
                    displayStudentSessions();
                };
            }
            fieldSel.onchange = ()=>{ refreshOps(); updateStudentSessionsFilterFieldOptions(); displayStudentSessions(); };
            v1.oninput = ()=> displayStudentSessions();
            v2.oninput = ()=> displayStudentSessions();
            const connEl = row.querySelector('.filter-connector');
            if (connEl) connEl.onchange = ()=> displayStudentSessions();
            refreshOps();
        }
        function clearAdvancedFiltersStudentSessions(){ const c=document.getElementById('filters-container-student-sessions'); if(c){ c.innerHTML=''; } displayStudentSessions(); }
        function removeStudentSessionsFilterRow(btn){ const row = btn.parentElement; row && row.remove(); updateStudentSessionsFilterFieldOptions(); displayStudentSessions(); }
        function updateStudentSessionsFilterFieldOptions(){ updateAdvFieldOptions('filters-container-student-sessions', studentSessionsFilterFields); }
        function applyAdvancedFiltersStudentSessions(items){
            const c = document.getElementById('filters-container-student-sessions'); if (!c) return items;
            const rows = Array.from(c.querySelectorAll('.filter-row-adv'));
            if (rows.length===0) return items;
            function matchRow(item, row){
                const field = row.querySelector('.filter-field').value;
                const op = row.querySelector('.filter-op').value;
                const v1 = row.querySelector('.filter-value').value;
                const v2 = row.querySelector('.filter-value2').value;
                if (!v1 && op !== 'not_between') return true;
                const valRaw = item[field];
                if (field==='created_at'){
                    const ts = valRaw ? new Date(valRaw).getTime() : 0;
                    if (!v1) return true;
                    const d1 = v1 ? new Date(v1) : null;
                    const t1 = d1 ? (d1.setHours(0,0,0,0), d1.getTime()) : NaN;
                    const d2 = v2 ? new Date(v2) : null;
                    const t2 = d2 ? (d2.setHours(23,59,59,999), d2.getTime()) : NaN;
                    const dayStart = d1 ? t1 : NaN;
                    const dayEnd = d1 ? (new Date(v1)).setHours(23,59,59,999) : NaN;
                    switch(op){
                        case '=': return !isNaN(dayStart) && ts>=dayStart && ts<=dayEnd;
                        case '': return !isNaN(dayStart) && (ts<dayStart || ts>dayEnd);
                        case '>': return ts>t1;
                        case '': return ts>=t1;
                        case '<': return ts<t1;
                        case '': return ts<=t1;
                        case 'between': return !isNaN(t1)&&!isNaN(t2) && ts>=Math.min(t1,t2) && ts<=Math.max(t1,t2);
                        case 'not_between': return (isNaN(t1)||isNaN(t2)) ? true : (ts<Math.min(t1,t2) || ts>Math.max(t1,t2));
                        default: return true;
                    }
                } else {
                    if (!v1) return true;
                    const val = (valRaw ?? '').toString().trim().toLowerCase();
                    const q = (v1||'').trim().toLowerCase();
                    switch(op){
                        case 'contains': return val.includes(q);
                        case 'equals': return val===q;
                        case 'starts_with': return val.startsWith(q);
                        case 'ends_with': return val.endsWith(q);
                        case 'not_contains': return !val.includes(q);
                        case 'not_equals': return val!==q;
                        default: return true;
                    }
                }
            }
            return items.filter(r=>{
                let result = true; let first = true;
                for (const row of rows){
                    const connEl = row.querySelector('.filter-connector');
                    const conn = connEl ? connEl.value : 'AND';
                    const match = matchRow(r, row);
                    if (first) { result = match; first = false; }
                    else {
                        if (conn === 'AND') result = result && match;
                        else if (conn === 'OR') result = result || match;
                        else if (conn === 'NOT') result = result && !match;
                    }
                }
                return result;
            });
        }
        function applyAdvancedFiltersStudents(items){
            const c = document.getElementById('filters-container-students'); if (!c) return items;
            const rows = Array.from(c.querySelectorAll('.filter-row-adv'));
            if (rows.length===0) return items;
            function matchRow(item, row){
                const field = row.querySelector('.filter-field').value;
                const op = row.querySelector('.filter-op').value;
                const v1 = row.querySelector('.filter-value').value;
                const v2 = row.querySelector('.filter-value2').value;
                if (!v1 && op !== 'not_between') return true;
                const valRaw = item[field];
                if (field==='created_at'){
                    const ts = valRaw ? new Date(valRaw).getTime() : 0;
                    if (!v1) return true;
                    const d1 = v1 ? new Date(v1) : null;
                    const t1 = d1 ? (d1.setHours(0,0,0,0), d1.getTime()) : NaN;
                    const d2 = v2 ? new Date(v2) : null;
                    const t2 = d2 ? (d2.setHours(23,59,59,999), d2.getTime()) : NaN;
                    const dayStart = d1 ? t1 : NaN;
                    const dayEnd = d1 ? (new Date(v1)).setHours(23,59,59,999) : NaN;
                    switch(op){
                        case '=': return !isNaN(dayStart) && ts>=dayStart && ts<=dayEnd;
                        case '': return !isNaN(dayStart) && (ts<dayStart || ts>dayEnd);
                        case '>': return ts>t1;
                        case '': return ts>=t1;
                        case '<': return ts<t1;
                        case '': return ts<=t1;
                        case 'between': return !isNaN(t1)&&!isNaN(t2) && ts>=Math.min(t1,t2) && ts<=Math.max(t1,t2);
                        case 'not_between': return (isNaN(t1)||isNaN(t2)) ? true : (ts<Math.min(t1,t2) || ts>Math.max(t1,t2));
                        default: return true;
                    }
                } else {
                    if (!v1) return true;
                    const val = (valRaw ?? '').toString().trim().toLowerCase();
                    const q = (v1||'').trim().toLowerCase();
                    switch(op){
                        case 'contains': return val.includes(q);
                        case 'equals': return val===q;
                        case 'starts_with': return val.startsWith(q);
                        case 'ends_with': return val.endsWith(q);
                        case 'not_contains': return !val.includes(q);
                        case 'not_equals': return val!==q;
                        default: return true;
                    }
                }
            }
            return items.filter(r=>{
                let result = true; let first = true;
                for (const row of rows){
                    const connEl = row.querySelector('.filter-connector');
                    const conn = connEl ? connEl.value : 'AND';
                    const m = matchRow(r, row);
                    if (first){ result = m; first=false; continue; }
                    if (conn==='AND') result = result && m;
                    else if (conn==='OR') result = result || m;
                    else if (conn==='NOT') result = result && !m;
                }
                return result;
            });
        }

        // ============ My Interviews Filter Functions ============
        const myInterviewsFilterFields = [
            { value:'student_name', label:'Student' },
            { value:'zeta_id', label:'Zeta ID' },
            { value:'session_name', label:'Session' },
            { value:'status', label:'Status' },
            { value:'verdict', label:'Verdict' },
            { value:'interview_date', label:'Date' }
        ];
        function addMyInterviewsFilterRow(){
            const c = document.getElementById('filters-container-myinterviews'); if (!c) return;
            const isFirst = c.querySelectorAll('.filter-row-adv').length === 0;
            const row = document.createElement('div');
            row.className = 'filter-row-adv';
            row.style.cssText = 'display:flex;gap:8px;align-items:center;flex-wrap:wrap';
            const connectorHtml = isFirst ? '' : `<select class="filter-connector form-select" style="min-width:90px">
<option value="AND">AND</option>
<option value="OR">OR</option>
<option value="NOT">NOT</option>
</select>`;
            row.innerHTML = `
                ${connectorHtml}
                <select class="filter-field form-select" style="min-width:140px">
                    ${myInterviewsFilterFields.map(f=>`<option value="${f.value}">${f.label}</option>`).join('')}
                </select>
                <select class="filter-op form-select" style="min-width:140px"></select>
                <input type="text" class="filter-value form-input" placeholder="Value" style="min-width:180px">
                <input type="date" class="filter-value2 form-input" style="display:none">
                <button class="btn btn-secondary" onclick="removeMyInterviewsFilterRow(this);">Remove</button>
            `;
            c.appendChild(row);
            bindMyInterviewsFilterRow(row);
            updateMyInterviewsFilterFieldOptions();
            loadMyInterviewsForAdmin();
        }
        function bindMyInterviewsFilterRow(row){
            const fieldSel = row.querySelector('.filter-field');
            const opSel = row.querySelector('.filter-op');
            const v1 = row.querySelector('.filter-value');
            const v2 = row.querySelector('.filter-value2');
            function refreshOps(){
                const f = fieldSel.value;
                const isDate = (f === 'interview_date');
                const ops = isDate ? dateOps : textOps;
                opSel.innerHTML = ops.map(o=>`<option value="${o}">${o}</option>`).join('');
                v1.type = isDate ? 'date' : 'text';
                v2.style.display = 'none'; v2.value = '';
                opSel.onchange = ()=>{
                    const op = opSel.value;
                    if (isDate && (op==='between' || op==='not_between')) { v2.style.display='block'; } else { v2.style.display='none'; v2.value=''; }
                    loadMyInterviewsForAdmin();
                };
            }
            fieldSel.onchange = ()=>{ refreshOps(); updateMyInterviewsFilterFieldOptions(); loadMyInterviewsForAdmin(); };
            v1.oninput = ()=> loadMyInterviewsForAdmin();
            v2.oninput = ()=> loadMyInterviewsForAdmin();
            const connEl = row.querySelector('.filter-connector');
            if (connEl) connEl.onchange = ()=> loadMyInterviewsForAdmin();
            refreshOps();
        }
        function clearAdvancedFiltersMyInterviews(){ const c=document.getElementById('filters-container-myinterviews'); if(c){ c.innerHTML=''; } loadMyInterviewsForAdmin(); }
        function removeMyInterviewsFilterRow(btn){ const row = btn.parentElement; row && row.remove(); updateMyInterviewsFilterFieldOptions(); loadMyInterviewsForAdmin(); }
        function updateMyInterviewsFilterFieldOptions(){ updateAdvFieldOptions('filters-container-myinterviews', myInterviewsFilterFields); }
        function applyAdvancedFiltersMyInterviews(items){
            const c = document.getElementById('filters-container-myinterviews'); if (!c) return items;
            const rows = Array.from(c.querySelectorAll('.filter-row-adv'));
            if (rows.length===0) return items;
            function matchRow(item, row){
                const field = row.querySelector('.filter-field').value;
                const op = row.querySelector('.filter-op').value;
                const v1 = row.querySelector('.filter-value').value;
                const v2 = row.querySelector('.filter-value2').value;
                if (!v1 && op !== 'not_between') return true;
                const valRaw = (field==='interview_date' && !item.interview_date && item.created_at) ? item.created_at : item[field];
                if (field==='interview_date'){
                    const ts = valRaw ? new Date(valRaw).getTime() : 0;
                    if (!v1) return true;
                    const d1 = v1 ? new Date(v1) : null;
                    const t1 = d1 ? (d1.setHours(0,0,0,0), d1.getTime()) : NaN;
                    const d2 = v2 ? new Date(v2) : null;
                    const t2 = d2 ? (d2.setHours(23,59,59,999), d2.getTime()) : NaN;
                    const dayStart = d1 ? t1 : NaN;
                    const dayEnd = d1 ? (new Date(v1)).setHours(23,59,59,999) : NaN;
                    switch(op){
                        case '=': return !isNaN(dayStart) && ts>=dayStart && ts<=dayEnd;
                        case '': return !isNaN(dayStart) && (ts<dayStart || ts>dayEnd);
                        case '>': return ts>t1;
                        case '': return ts>=t1;
                        case '<': return ts<t1;
                        case '': return ts<=t1;
                        case 'between': return !isNaN(t1)&&!isNaN(t2) && ts>=Math.min(t1,t2) && ts<=Math.max(t1,t2);
                        case 'not_between': return (isNaN(t1)||isNaN(t2)) ? true : (ts<Math.min(t1,t2) || ts>Math.max(t1,t2));
                        default: return true;
                    }
                } else {
                    if (!v1) return true;
                    const val = (valRaw ?? '').toString().trim().toLowerCase();
                    const q = (v1||'').trim().toLowerCase();
                    switch(op){
                        case 'contains': return val.includes(q);
                        case 'equals': return val===q;
                        case 'starts_with': return val.startsWith(q);
                        case 'ends_with': return val.endsWith(q);
                        case 'not_contains': return !val.includes(q);
                        case 'not_equals': return val!==q;
                        default: return true;
                    }
                }
            }
            return items.filter(r=>{
                let result = true; let first = true;
                for (const row of rows){
                    const connEl = row.querySelector('.filter-connector');
                    const conn = connEl ? connEl.value : 'AND';
                    const m = matchRow(r, row);
                    if (first){ result = m; first=false; continue; }
                    if (conn==='AND') result = result && m;
                    else if (conn==='OR') result = result || m;
                    else if (conn==='NOT') result = result && !m;
                }
                return result;
            });
        }

        // ============ Users Filter Functions ============
        const usersFilterFields = [
            { value:'name', label:'Name' },
            { value:'email', label:'Email' },
            { value:'role', label:'Role' },
            { value:'status', label:'Status' },
            { value:'created_at', label:'Created At' }
        ];
        function addUsersFilterRow(){
            const c = document.getElementById('filters-container-users'); if (!c) return;
            const isFirst = c.querySelectorAll('.filter-row-adv').length === 0;
            const row = document.createElement('div');
            row.className = 'filter-row-adv';
            row.style.cssText = 'display:flex;gap:8px;align-items:center;flex-wrap:wrap';
            const connectorHtml = isFirst ? '' : `<select class="filter-connector form-select" style="min-width:90px">
<option value="AND">AND</option>
<option value="OR">OR</option>
<option value="NOT">NOT</option>
</select>`;
            row.innerHTML = `
                ${connectorHtml}
                <select class="filter-field form-select" style="min-width:140px">
                    ${usersFilterFields.map(f=>`<option value="${f.value}">${f.label}</option>`).join('')}
                </select>
                <select class="filter-op form-select" style="min-width:140px"></select>
                <input type="text" class="filter-value form-input" placeholder="Value" style="min-width:180px">
                <input type="date" class="filter-value2 form-input" style="display:none">
                <button class="btn btn-secondary" onclick="removeUsersFilterRow(this);">Remove</button>
            `;
            c.appendChild(row);
            bindUsersFilterRow(row);
            updateUsersFilterFieldOptions();
            displayUsers();
        }
        function bindUsersFilterRow(row){
            const fieldSel = row.querySelector('.filter-field');
            const opSel = row.querySelector('.filter-op');
            const v1 = row.querySelector('.filter-value');
            const v2 = row.querySelector('.filter-value2');
            function refreshOps(){
                const f = fieldSel.value;
                const isDate = (f === 'created_at');
                const ops = isDate ? dateOps : textOps;
                opSel.innerHTML = ops.map(o=>`<option value="${o}">${o}</option>`).join('');
                v1.type = isDate ? 'date' : 'text';
                v2.style.display = 'none'; v2.value = '';
                opSel.onchange = ()=>{
                    const op = opSel.value;
                    if (isDate && (op==='between' || op==='not_between')) { v2.style.display='block'; } else { v2.style.display='none'; v2.value=''; }
                    displayUsers();
                };
            }
            fieldSel.onchange = ()=>{ refreshOps(); updateUsersFilterFieldOptions(); displayUsers(); };
            v1.oninput = ()=> displayUsers();
            v2.oninput = ()=> displayUsers();
            const connEl = row.querySelector('.filter-connector');
            if (connEl) connEl.onchange = ()=> displayUsers();
            refreshOps();
        }
        function clearAdvancedFiltersUsers(){ const c=document.getElementById('filters-container-users'); if(c){ c.innerHTML=''; } displayUsers(); }
        function removeUsersFilterRow(btn){ const row = btn.parentElement; row && row.remove(); updateUsersFilterFieldOptions(); displayUsers(); }
        function updateUsersFilterFieldOptions(){ updateAdvFieldOptions('filters-container-users', usersFilterFields); }
        function applyAdvancedFiltersUsers(items){
            const c = document.getElementById('filters-container-users'); if (!c) return items;
            const rows = Array.from(c.querySelectorAll('.filter-row-adv'));
            if (rows.length===0) return items;
            function matchRow(item, row){
                const field = row.querySelector('.filter-field').value;
                const op = row.querySelector('.filter-op').value;
                const v1 = row.querySelector('.filter-value').value;
                const v2 = row.querySelector('.filter-value2').value;
                if (!v1 && op !== 'not_between') return true;
                const valRaw = item[field];
                if (field==='created_at'){
                    const ts = valRaw ? new Date(valRaw).getTime() : 0;
                    if (!v1) return true;
                    const d1 = v1 ? new Date(v1) : null;
                    const t1 = d1 ? (d1.setHours(0,0,0,0), d1.getTime()) : NaN;
                    const d2 = v2 ? new Date(v2) : null;
                    const t2 = d2 ? (d2.setHours(23,59,59,999), d2.getTime()) : NaN;
                    const dayStart = d1 ? t1 : NaN;
                    const dayEnd = d1 ? (new Date(v1)).setHours(23,59,59,999) : NaN;
                    switch(op){
                        case '=': return !isNaN(dayStart) && ts>=dayStart && ts<=dayEnd;
                        case '': return !isNaN(dayStart) && (ts<dayStart || ts>dayEnd);
                        case '>': return ts>t1;
                        case '': return ts>=t1;
                        case '<': return ts<t1;
                        case '': return ts<=t1;
                        case 'between': return !isNaN(t1)&&!isNaN(t2) && ts>=Math.min(t1,t2) && ts<=Math.max(t1,t2);
                        case 'not_between': return (isNaN(t1)||isNaN(t2)) ? true : (ts<Math.min(t1,t2) || ts>Math.max(t1,t2));
                        default: return true;
                    }
                } else {
                    if (!v1) return true;
                    const val = (valRaw ?? '').toString().trim().toLowerCase();
                    const q = (v1||'').trim().toLowerCase();
                    switch(op){
                        case 'contains': return val.includes(q);
                        case 'equals': return val===q;
                        case 'starts_with': return val.startsWith(q);
                        case 'ends_with': return val.endsWith(q);
                        case 'not_contains': return !val.includes(q);
                        case 'not_equals': return val!==q;
                        default: return true;
                    }
                }
            }
            return items.filter(r=>{
                let result = true; let first = true;
                for (const row of rows){
                    const connEl = row.querySelector('.filter-connector');
                    const conn = connEl ? connEl.value : 'AND';
                    const m = matchRow(r, row);
                    if (first){ result = m; first=false; continue; }
                    if (conn==='AND') result = result && m;
                    else if (conn==='OR') result = result || m;
                    else if (conn==='NOT') result = result && !m;
                }
                return result;
            });
        }

        async function updateConsolidationStatus(id, status){
            try{
                const res = await fetch(`/api/admin/consolidation/${id}/status`,{ method:'PUT', headers:{'Content-Type':'application/json'}, body: JSON.stringify({status}) });
                const json = await res.json();
                if (!res.ok || !json.success) throw new Error(json.error||'Failed');
                showSuccess('Status updated');
                loadConsolidation(true); // Force refresh after status update
            }catch(e){ showError('Failed to update status'); }
        }

        async function openConsDetail(id){
            try{
                const res = await fetch('/api/admin/consolidation');
                const json = await res.json();
                const item = (json.data||[]).find(x=>String(x.id)===String(id));
                if (!item){ showError('Record not found'); return; }
                
                // Fetch email logs for this consolidation
                const emailLogsRes = await fetch(`/api/admin/email-logs?consolidation_id=${id}`);
                const emailLogsJson = await emailLogsRes.json();
                const allEmailLogs = emailLogsJson.success ? (emailLogsJson.data||[]) : [];
                
                // Sort by created_at descending (latest first)
                allEmailLogs.sort((a, b) => {
                    const dateA = new Date(a.created_at || 0);
                    const dateB = new Date(b.created_at || 0);
                    return dateB - dateA;
                });
                
                // Get latest 2 emails for initial display
                const latestEmails = allEmailLogs.slice(0, 2);
                
                // Separate emails by status (excluding the latest 2)
                const remainingEmails = allEmailLogs.slice(2);
                const sentEmails = remainingEmails.filter(e => e.status === 'sent');
                const failedEmails = remainingEmails.filter(e => e.status === 'failed');
                const draftedEmails = remainingEmails.filter(e => e.status === 'drafted');
                
                const interviewsRes = await fetch(`/api/admin/consolidation/${id}/interviews`);
                const interviewsJson = await interviewsRes.json();
                const interviews = interviewsJson.success ? (interviewsJson.data||[]) : [];
                const verdictBadge = (v)=>{
                    const t=String(v||'').toLowerCase();
                    const tiger=t.includes('tiger'), cow=t.includes('cow'), sheep=t.includes('sheep');
                    const color = tiger? '#048C18' : cow? '#f59e0b' : sheep? '#6b7280' : '#6b7280';
                    return `<span style="display:inline-block;background:${color};color:#fff;padding:3px 8px;border-radius:12px;font-size:11px;margin:2px;white-space:nowrap">${v||'-'}</span>`;
                };
                const overlay = document.getElementById('cons-detail-overlay');
                const panel = document.getElementById('cons-detail-panel');
                overlay.style.display='block';
                panel.innerHTML = `
                    <div style="padding:16px">
                      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
                        <h3 style="margin:0;color:#111827">Consolidated Record</h3>
                        <button onclick="document.getElementById('cons-detail-overlay').style.display='none';document.getElementById('cons-detail-panel').style.right='-520px';" style="background:#f3f4f6;border:1px solid #e5e7eb;border-radius:6px;padding:4px 8px;cursor:pointer"></button>
                      </div>
                      <div style="font-size:14px;color:#374151;line-height:1.6">
                        <div><strong>Student:</strong> ${item.student_name||'-'} (${item.zeta_id||'-'})</div>
                        <div><strong>Email:</strong> ${item.student_email||'-'}</div>
                        <div><strong>Session:</strong> ${item.session_name||'-'}</div>
                        <div><strong>Status:</strong> ${item.status || ''}</div>
                        <div style="margin:8px 0"><strong>Verdicts:</strong> ${(item.verdicts||[]).map(verdictBadge).join(' ')}</div>
                        <div style="margin:8px 0"><strong>Scores:</strong><br>${(() => {
                            const interviewerNames = Array.isArray(item.interviewer_names) ? item.interviewer_names : [];
                            const interviewScores = Array.isArray(item.interview_scores) ? item.interview_scores : [];
                            const interviewQuestionCounts = Array.isArray(item.interview_question_counts) ? item.interview_question_counts : [];
                            if (interviewerNames.length === 0) return '-';
                            return interviewerNames.map((name, idx) => {
                                const score = interviewScores[idx] !== undefined && interviewScores[idx] !== null ? interviewScores[idx] : 0;
                                const questionCount = interviewQuestionCounts[idx] !== undefined && interviewQuestionCounts[idx] !== null ? interviewQuestionCounts[idx] : 0;
                                const scoreDisplay = questionCount > 0 ? `${score}/${questionCount}` : '-';
                                return `${name}: ${scoreDisplay}`;
                            }).join('<br>');
                        })()}</div>
                        <div><strong>Last Interview:</strong> ${item.last_interview_at? formatDate(item.last_interview_at) : '-'} </div>
                        <div style="margin-top:8px"><strong>Notes:</strong><br>${(item.notes||'').replace(/\n/g,'<br>') || '-'}</div>
                
                <!-- Email Logs Section -->
                <div style="margin-top:16px"><strong>Emails</strong></div>
                <div style="margin-top:6px;border:1px solid #e5e7eb;border-radius:8px">
                    ${allEmailLogs.length === 0 ? '<div style="padding:12px;color:#6b7280;text-align:center">No emails</div>' : ''}
                    
                    <!-- Latest 2 Emails -->
                    ${latestEmails.map(email => {
                        const sentAt = email.sent_at ? formatDate(email.sent_at) : (email.created_at ? formatDate(email.created_at) : 'N/A');
                        const statusColor = email.status === 'sent' ? '#10b981' : email.status === 'failed' ? '#ef4444' : '#f59e0b';
                        return `
                            <details style="border-bottom:1px solid #e5e7eb;padding:8px">
                                <summary style="cursor:pointer;color:#111827;display:flex;justify-content:space-between;align-items:center;background:#f9fafb;border:1px solid #e5e7eb;border-radius:6px;padding:8px">
                                    <div style="flex:1">
                                        <div style="font-weight:600">${email.subject || 'No Subject'}</div>
                                        <div style="font-size:12px;color:#6b7280;margin-top:4px">
                                            <div>To: ${email.to_emails || '-'}</div>
                                            ${email.cc_emails ? `<div>CC: ${email.cc_emails}</div>` : ''}
                                            ${email.bcc_emails ? `<div>BCC: ${email.bcc_emails}</div>` : ''}
                                        </div>
                                        <div style="margin-top:6px">
                                            <span style="display:inline-block;padding:2px 6px;border-radius:10px;color:#fff;background:${statusColor}">${email.status || 'drafted'}</span>
                                            <span style="display:inline-block;margin-left:6px;font-size:12px;color:#6b7280">${sentAt}</span>
                                        </div>
                                    </div>
                                    <span class="arrow" style="opacity:0.7;margin-left:8px"></span>
                                </summary>
                                <div style="margin-top:8px;padding:8px;background:#fff;border-radius:4px">
                                    <div style="margin-bottom:8px"><strong>From:</strong> ${email.from_email || '-'}</div>
                                    ${email.error_message ? `<div style="margin-bottom:8px;color:#ef4444"><strong>Error:</strong> ${email.error_message}</div>` : ''}
                                    <div style="margin-bottom:8px"><strong>Message:</strong></div>
                                    <div style="padding:8px;background:#f9fafb;border-radius:4px;max-height:300px;overflow-y:auto;border:1px solid #e5e7eb">
                                        ${email.message || '-'}
                                    </div>
                            ${email.status === 'failed' ? `<div style="margin-top:8px"><button onclick="openSendMailFromFailed(${email.id})" style="background:#3b82f6;color:#fff;border:none;padding:6px 12px;border-radius:6px;cursor:pointer;font-size:13px">Edit & Resend</button></div>` : ''}
                            ${email.status === 'drafted' ? `<div style="margin-top:8px"><button onclick="openSendMailFromDraft(${email.id})" style="background:#3b82f6;color:#fff;border:none;padding:6px 12px;border-radius:6px;cursor:pointer;font-size:13px">Resend</button></div>` : ''}
                                </div>
                            </details>
                        `;
                    }).join('')}
                    
                    <!-- Other Emails Major Collapse -->
                    ${(sentEmails.length > 0 || failedEmails.length > 0 || draftedEmails.length > 0) ? `
                        <details style="border-bottom:1px solid #e5e7eb;padding:8px;margin-top:8px">
                            <summary style="cursor:pointer;color:#111827;display:flex;justify-content:space-between;align-items:center;background:#f3f4f6;border:1px solid #e5e7eb;border-radius:6px;padding:10px">
                                <div style="font-weight:600;font-size:15px">Other Emails</div>
                                <span class="arrow" style="opacity:0.7;margin-left:8px"></span>
                            </summary>
                            <div style="margin-top:8px;padding-left:8px">
                                <!-- Sent Emails Collapsible -->
                                ${sentEmails.length > 0 ? `
                                    <details style="border-bottom:1px solid #e5e7eb;padding:8px;margin-bottom:4px">
                                        <summary style="cursor:pointer;color:#111827;display:flex;justify-content:space-between;align-items:center;background:#f9fafb;border:1px solid #e5e7eb;border-radius:6px;padding:8px">
                                            <div style="font-weight:600">Sent Emails (${sentEmails.length})</div>
                                            <span class="arrow" style="opacity:0.7;margin-left:8px"></span>
                                        </summary>
                                        <div id="sent-emails-list-${id}" style="margin-top:8px">
                                            ${renderEmailList(sentEmails.slice(0, 5), id, 'sent', 0)}
                                        </div>
                                    </details>
                                ` : ''}
                                
                                <!-- Failed Emails Collapsible -->
                                ${failedEmails.length > 0 ? `
                                    <details style="border-bottom:1px solid #e5e7eb;padding:8px;margin-bottom:4px">
                                        <summary style="cursor:pointer;color:#111827;display:flex;justify-content:space-between;align-items:center;background:#f9fafb;border:1px solid #e5e7eb;border-radius:6px;padding:8px">
                                            <div style="font-weight:600">Failed Emails (${failedEmails.length})</div>
                                            <span class="arrow" style="opacity:0.7;margin-left:8px"></span>
                                        </summary>
                                        <div id="failed-emails-list-${id}" style="margin-top:8px">
                                            ${renderEmailList(failedEmails.slice(0, 5), id, 'failed', 0)}
                                        </div>
                                    </details>
                                ` : ''}
                                
                                <!-- Drafted Emails Collapsible -->
                                ${draftedEmails.length > 0 ? `
                                    <details style="border-bottom:1px solid #e5e7eb;padding:8px;margin-bottom:4px">
                                        <summary style="cursor:pointer;color:#111827;display:flex;justify-content:space-between;align-items:center;background:#f9fafb;border:1px solid #e5e7eb;border-radius:6px;padding:8px">
                                            <div style="font-weight:600">Drafted Emails (${draftedEmails.length})</div>
                                            <span class="arrow" style="opacity:0.7;margin-left:8px"></span>
                                        </summary>
                                        <div id="drafted-emails-list-${id}" style="margin-top:8px">
                                            ${renderEmailList(draftedEmails.slice(0, 5), id, 'drafted', 0)}
                                        </div>
                                    </details>
                                ` : ''}
                            </div>
                        </details>
                    ` : ''}
                </div>
                
                <!-- Interviews Section -->
                <div style="margin-top:16px"><strong>Interviews</strong></div>
                <div style="margin-top:6px;border:1px solid #e5e7eb;border-radius:8px">
                           ${interviews.map(i=>`
                     <details style=\"border-bottom:1px solid #e5e7eb;padding:8px\">
                       <summary style=\"cursor:pointer;color:#111827;display:flex;justify-content:space-between;align-items:center;background:#f9fafb;border:1px solid #e5e7eb;border-radius:6px;padding:8px\">
                         <div>
                           <div style=\"font-weight:600\">Interview #${i.id}</div>
                           <div style=\"opacity:.85\">${i.interviewer_name||'-'}</div>
                           <div style=\"margin-top:4px\">
                             <span style=\"display:inline-block;padding:2px 6px;border-radius:10px;color:#fff;background:${(i.status||'').toLowerCase().includes('select')?'#10b981':(i.status||'').toLowerCase().includes('reject')?'#ef4444':(i.status||'').toLowerCase().includes('wait')?'#f59e0b':'#6b7280'}\">${i.status||'-'}</span>
                             <span style=\"display:inline-block;margin-left:6px;padding:2px 6px;border-radius:10px;color:#fff;background:${(i.verdict||'').toLowerCase().includes('tiger')?'#048C18':(i.verdict||'').toLowerCase().includes('cow')?'#f59e0b':(i.verdict||'').toLowerCase().includes('sheep')?'#6b7280':'#6b7280'}\">${i.verdict||'-'}</span>
                           </div>
                           <div style=\"font-size:12px;color:#6b7280;margin-top:4px\">${i.created_at? formatDate(i.created_at) : '-'} </div>
                         </div>
                         <span class=\"arrow\" style=\"opacity:0.7\"></span>
                       </summary>
                       <div style=\"margin-top:6px;color:#374151\"><strong>Notes:</strong><br>${(i.overall_notes||'').replace(/\\n/g,'<br>') || '-'}</div>
                       <div style=\"margin-top:10px\"><strong>Questions & Answers</strong></div>
                       <div id=\"iq-${i.id}\" style=\"margin-top:6px\">Loading questions...</div>
                     </details>
                           `).join('')}
                        </div>
                      </div>
                    </div>`;
                setTimeout(()=>{ panel.style.right='0px'; }, 10);
                overlay.onclick = ()=>{ overlay.style.display='none'; panel.style.right='-520px'; };
                
                // Store email lists for scroll loading
                window[`consEmailData_${id}`] = {
                    sent: sentEmails,
                    failed: failedEmails,
                    drafted: draftedEmails,
                    offsets: { sent: 5, failed: 5, drafted: 5 }
                };
                
                // Setup scroll listeners for each email list
                setTimeout(() => {
                    ['sent', 'failed', 'drafted'].forEach(status => {
                        const listEl = document.getElementById(`${status}-emails-list-${id}`);
                        if (listEl) {
                            listEl.style.maxHeight = '400px';
                            listEl.style.overflowY = 'auto';
                            listEl.addEventListener('scroll', function() {
                                if (this.scrollTop + this.clientHeight >= this.scrollHeight - 10) {
                                    loadMoreEmails(id, status);
                                }
                            });
                        }
                    });
                }, 100);
                
                // Fetch questions per interview and render
                for (const interview of interviews){
                    try{
                        const qRes = await fetch(`/api/interviews/${interview.id}/questions`);
                        const qJson = await qRes.json();
                        const container = document.getElementById(`iq-${interview.id}`);
                        if (!container) continue;
                        if (!qRes.ok || !qJson.success){ container.textContent = 'Failed to load questions'; continue; }
                        const qas = (qJson.data||[]);
                        if (!qas.length){ container.textContent = 'No questions recorded'; continue; }
                        container.innerHTML = qas.map(q=>{
                            // Handle answer_photo_url - could be a string, JSON array string, or array
                            let answerImagesHtml = '';
                            if (q.answer_photo_url) {
                                try {
                                    let imageUrls = [];
                                    const rawValue = q.answer_photo_url;
                                    
                                    // Handle different data formats
                                    if (Array.isArray(rawValue)) {
                                        // Already an array
                                        imageUrls = rawValue;
                                    } else if (typeof rawValue === 'string') {
                                        const trimmed = rawValue.trim();
                                        // Check if it's a JSON array string
                                        if (trimmed.startsWith('[') && trimmed.endsWith(']')) {
                                            try {
                                                imageUrls = JSON.parse(trimmed);
                                                // Ensure it's an array after parsing
                                                if (!Array.isArray(imageUrls)) {
                                                    imageUrls = [imageUrls];
                                                }
                                            } catch (parseError) {
                                                // If JSON parse fails, try to extract URLs from the string
                                                // Handle cases like: ["url1", "url2"] or ['url1', 'url2']
                                                const urlMatches = trimmed.match(/https?:\/\/[^\s"']+/g);
                                                if (urlMatches && urlMatches.length > 0) {
                                                    imageUrls = urlMatches;
                                                } else {
                                                    // Fallback: treat as single URL
                                                    imageUrls = [trimmed];
                                                }
                                            }
                                        } else if (trimmed.startsWith('"') && trimmed.endsWith('"')) {
                                            // Remove surrounding quotes
                                            const unquoted = trimmed.slice(1, -1);
                                            if (unquoted.startsWith('[') && unquoted.endsWith(']')) {
                                                try {
                                                    imageUrls = JSON.parse(unquoted);
                                                    if (!Array.isArray(imageUrls)) {
                                                        imageUrls = [imageUrls];
                                                    }
                                                } catch (e) {
                                                    imageUrls = [trimmed];
                                                }
                                            } else {
                                                imageUrls = [unquoted];
                                            }
                                        } else {
                                            // Single URL string
                                            imageUrls = [trimmed];
                                        }
                                    } else {
                                        // Convert to string and treat as single URL
                                        imageUrls = [String(rawValue)];
                                    }
                                    
                                    // Filter out empty strings and create image HTML
                                    const validUrls = imageUrls.filter(url => {
                                        if (!url) return false;
                                        const urlStr = String(url).trim();
                                        return urlStr.length > 0 && (urlStr.startsWith('http://') || urlStr.startsWith('https://'));
                                    }).map(url => String(url).trim());
                                    
                                    if (validUrls.length > 0) {
                                        const images = validUrls.map(url => {
                                            // Escape for HTML attributes
                                            const escapedUrl = url.replace(/&/g, '&amp;').replace(/"/g, '&quot;').replace(/'/g, '&#39;');
                                            // Escape for JavaScript string
                                            const jsEscapedUrl = url.replace(/\\/g, '\\\\').replace(/'/g, "\\'").replace(/"/g, '\\"');
                                            return `<img src="${escapedUrl}" alt="answer photo" style="width:300px;height:300px;object-fit:contain;border:1px solid #e5e7eb;border-radius:4px;cursor:pointer" onclick="openImageModal('${jsEscapedUrl}')">`;
                                        }).join('');
                                        answerImagesHtml = `<div style="margin-top:6px;display:flex;flex-wrap:wrap;gap:8px">${images}</div>`;
                                    }
                                } catch (e) {
                                    console.error('Error parsing answer_photo_url:', e, q.answer_photo_url);
                                    // If all parsing fails, try to extract URL from the raw value
                                    const rawStr = String(q.answer_photo_url);
                                    const urlMatch = rawStr.match(/https?:\/\/[^\s"']+/);
                                    if (urlMatch) {
                                        const url = urlMatch[0];
                                        const escapedUrl = url.replace(/&/g, '&amp;').replace(/"/g, '&quot;').replace(/'/g, '&#39;');
                                        const jsEscapedUrl = url.replace(/\\/g, '\\\\').replace(/'/g, "\\'").replace(/"/g, '\\"');
                                        answerImagesHtml = `<div style="margin-top:6px"><img src="${escapedUrl}" alt="answer photo" style="width:300px;height:300px;object-fit:contain;border:1px solid #e5e7eb;border-radius:4px;cursor:pointer" onclick="openImageModal('${jsEscapedUrl}')"></div>`;
                                    }
                                }
                            }
                            
                            // Handle question images in rich content - ensure fixed size
                            let questionContentHtml = '';
                            if (q.question_rich_content) {
                                // Replace all img tags with fixed size styling
                                questionContentHtml = q.question_rich_content.replace(/<img([^>]*)>/gi, (match, attrs) => {
                                    // Remove existing width/height/style attributes
                                    let cleanAttrs = attrs.replace(/\s*(width|height|style)=["'][^"']*["']/gi, '');
                                    // Add fixed size styling
                                    return `<img${cleanAttrs} style="max-width:300px;max-height:300px;width:auto;height:auto;object-fit:contain;border:1px solid #e5e7eb;border-radius:4px;display:block;margin:4px 0;">`;
                                });
                            }
                            
                            return `
                          <div style=\"border:1px solid #e5e7eb;border-radius:6px;padding:8px;margin-bottom:8px\">
                            <div style=\"font-weight:600;color:#111827;margin-bottom:4px\">Q: ${q.question_text||'-'}</div>
                            ${questionContentHtml ? `<div style=\"color:#374151;margin-bottom:6px\">${questionContentHtml}</div>` : ''}
                            <div style=\"color:#374151\"><strong>Answer:</strong> ${(q.student_answer||'-').toString().replace(/\\n/g,'<br>')}</div>
                            ${answerImagesHtml}
                          </div>
                        `;
                        }).join('');
                    }catch(err){
                        const container = document.getElementById(`iq-${interview.id}`);
                        if (container) container.textContent = 'Failed to load questions';
                    }
                }
            }catch(e){ console.error(e); showError('Failed to open details'); }
        }
        
        // Helper function to render email list
        function renderEmailList(emails, consolidationId, status, offset) {
            if (emails.length === 0) return '<div style="padding:12px;color:#6b7280;text-align:center">No emails</div>';
            
            return emails.map(email => {
                const sentAt = email.sent_at ? formatDate(email.sent_at) : (email.created_at ? formatDate(email.created_at) : 'N/A');
                const statusColor = email.status === 'sent' ? '#10b981' : email.status === 'failed' ? '#ef4444' : '#f59e0b';
                return `
                    <details style="border-bottom:1px solid #e5e7eb;padding:8px;margin-bottom:4px">
                        <summary style="cursor:pointer;color:#111827;display:flex;justify-content:space-between;align-items:center;background:#fff;border:1px solid #e5e7eb;border-radius:6px;padding:8px">
                            <div style="flex:1">
                                <div style="font-weight:600">${email.subject || 'No Subject'}</div>
                                <div style="font-size:12px;color:#6b7280;margin-top:4px">
                                    <div>To: ${email.to_emails || '-'}</div>
                                    ${email.cc_emails ? `<div>CC: ${email.cc_emails}</div>` : ''}
                                    ${email.bcc_emails ? `<div>BCC: ${email.bcc_emails}</div>` : ''}
                                </div>
                                <div style="margin-top:6px">
                                    <span style="display:inline-block;padding:2px 6px;border-radius:10px;color:#fff;background:${statusColor}">${email.status || 'drafted'}</span>
                                    <span style="display:inline-block;margin-left:6px;font-size:12px;color:#6b7280">${sentAt}</span>
                                </div>
                            </div>
                            <span class="arrow" style="opacity:0.7;margin-left:8px"></span>
                        </summary>
                        <div style="margin-top:8px;padding:8px;background:#fff;border-radius:4px">
                            <div style="margin-bottom:8px"><strong>From:</strong> ${email.from_email || '-'}</div>
                            ${email.error_message ? `<div style="margin-bottom:8px;color:#ef4444"><strong>Error:</strong> ${email.error_message}</div>` : ''}
                            <div style="margin-bottom:8px"><strong>Message:</strong></div>
                            <div style="padding:8px;background:#f9fafb;border-radius:4px;max-height:300px;overflow-y:auto;border:1px solid #e5e7eb">
                                ${email.message || '-'}
                            </div>
                            ${email.status === 'failed' ? `<div style="margin-top:8px"><button onclick="openSendMailFromFailed(${email.id})" style="background:#3b82f6;color:#fff;border:none;padding:6px 12px;border-radius:6px;cursor:pointer;font-size:13px">Edit & Resend</button></div>` : ''}
                            ${email.status === 'drafted' ? `<div style="margin-top:8px"><button onclick="openSendMailFromDraft(${email.id})" style="background:#3b82f6;color:#fff;border:none;padding:6px 12px;border-radius:6px;cursor:pointer;font-size:13px">Resend</button></div>` : ''}
                        </div>
                    </details>
                `;
            }).join('');
        }
        
        // Load more emails on scroll
        function loadMoreEmails(consolidationId, status) {
            const dataKey = `consEmailData_${consolidationId}`;
            const emailData = window[dataKey];
            if (!emailData) return;
            
            const emails = emailData[status];
            const currentOffset = emailData.offsets[status];
            
            if (currentOffset >= emails.length) return; // No more emails
            
            const nextBatch = emails.slice(currentOffset, currentOffset + 5);
            if (nextBatch.length === 0) return;
            
            const listEl = document.getElementById(`${status}-emails-list-${consolidationId}`);
            if (!listEl) return;
            
            listEl.innerHTML += renderEmailList(nextBatch, consolidationId, status, currentOffset);
            emailData.offsets[status] = currentOffset + 5;
        }

        // User authentication functions
        async function checkUserLoginStatus() {
            // Check URL parameters for user data (from OAuth callback)
            const urlParams = new URLSearchParams(window.location.search);
            const userEmail = urlParams.get('email');
            const userName = urlParams.get('name');
            
            if (userEmail || userName) {
                // User just logged in, verify they are authorized
                try {
                    const response = await fetch(`/api/user/role?email=${encodeURIComponent(userEmail)}`);
                    const data = await response.json();
                    
                    if (!response.ok || !data.success) {
                        console.log(' User not authorized');
                        redirectToHome();
                        return;
                    }
                    
                    // User is authorized, display their info
                    const userData = {
                        email: userEmail,
                        name: userName || userEmail?.split('@')[0] || 'Admin',
                        role: data.role
                    };
                    displayUserInfo(userData);
                    
                    // Store user data in localStorage for future visits
                    localStorage.setItem('bees_user_data', JSON.stringify(userData));
                    
                    // Clean up URL parameters
                    window.history.replaceState({}, document.title, window.location.pathname);
                } catch (error) {
                    console.error('Error verifying user authorization:', error);
                    redirectToHome();
                }
            } else {
                // Check localStorage for existing user data
                const storedUserData = localStorage.getItem('bees_user_data');
                if (storedUserData) {
                    try {
                        const userData = JSON.parse(storedUserData);
                        
                        // Verify the stored user is still authorized
                        const response = await fetch(`/api/user/role?email=${encodeURIComponent(userData.email)}`);
                        const data = await response.json();
                        
                        if (!response.ok || !data.success) {
                            console.log(' Stored user not authorized');
                            localStorage.removeItem('bees_user_data');
                            redirectToHome();
                            return;
                        }
                        
                        displayUserInfo(userData);
                    } catch (e) {
                        console.error('Error parsing stored user data:', e);
                        localStorage.removeItem('bees_user_data');
                        redirectToHome();
                    }
                } else {
                    // No user data found, redirect to home
                    console.log(' No user data found, redirecting to home');
                    redirectToHome();
                }
            }
        }
        
        function redirectToHome() {
            window.location.href = '/';
        }

        async function displayUserInfo(userData) {
            const avatar = document.getElementById('admin-avatar');
            const menu = document.getElementById('admin-avatar-menu');
            if (avatar && userData) {
                // Get user ID from API to ensure consistent avatar
                try {
                    // Get email from userData or URL/localStorage
                    const urlParams = new URLSearchParams(window.location.search);
                    const urlEmail = urlParams.get('email');
                    const stored = localStorage.getItem('bees_user_data');
                    const storedData = stored ? JSON.parse(stored) : null;
                    const email = userData.email || urlEmail || storedData?.email || '';
                    
                    if (email) {
                        const userIdResponse = await fetch(`/api/user/id?email=${encodeURIComponent(email)}`);
                    const userIdData = await userIdResponse.json();
                    const userId = userIdData.success ? userIdData.userId : null;
                    currentUserId = userId;
                        // Use first character of name or email, not user ID
                        const initial = (userData.name || userData.email || 'A').trim().charAt(0).toUpperCase();
                    avatar.textContent = initial || 'A';
                    } else {
                        // Fallback if no email available
                        const initial = (userData.email || userData.name || 'A').trim().charAt(0).toUpperCase();
                        avatar.textContent = initial || 'A';
                    }
                } catch (error) {
                    console.error('Error fetching user ID:', error);
                    const initial = (userData.email || userData.name || 'A').trim().charAt(0).toUpperCase();
                    avatar.textContent = initial || 'A';
                }
                avatar.onclick = ()=> { menu.style.display = (menu.style.display==='block' ? 'none' : 'block'); };
                document.addEventListener('click', (e)=>{ if (!avatar.contains(e.target) && !menu.contains(e.target)) menu.style.display='none'; });
                const logoutBtn = document.getElementById('admin-logout-btn');
                if (logoutBtn) {
                    logoutBtn.onclick = ()=> {
                        const overlay = document.createElement('div');
                        overlay.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.35);display:flex;align-items:center;justify-content:center;z-index:2000;';
                        overlay.innerHTML = `
                          <div style="background:#fff;border:1px solid #e5e7eb;border-radius:8px;min-width:280px;max-width:90%;padding:16px;box-shadow:0 10px 20px rgba(0,0,0,0.15)">
                            <div style=\"font-weight:600;margin-bottom:8px;color:#111827\">Logout?</div>
                            <div style=\"font-size:14px;color:#374151;margin-bottom:12px\">Are you sure you want to logout?</div>
                            <div style=\"display:flex;gap:8px;justify-content:flex-end\">
                              <button id=\"lg-cancel\" style=\"border:1px solid #e5e7eb;background:#fff;padding:6px 10px;border-radius:6px;cursor:pointer\">Cancel</button>
                              <button id=\"lg-confirm\" style=\"background:#111827;color:#fff;border:none;padding:6px 10px;border-radius:6px;cursor:pointer\">Logout</button>
                            </div>
                          </div>`;
                        document.body.appendChild(overlay);
                        overlay.querySelector('#lg-cancel').onclick = ()=> overlay.remove();
                        overlay.querySelector('#lg-confirm').onclick = ()=> { overlay.remove(); try { localStorage.removeItem('bees_user_data'); } catch {}; window.location.href = '/'; };
                    };
                }
            }
        }

        // Start Interview function
        function startInterview() {
            console.log('Starting interview from admin dashboard...');
            window.location.href = '/interview';
        }

        function switchSection(section) {
            // Clear consolidation session filter when switching away from consolidation
            if (section !== 'consolidation') {
                consolidationSessionFilter = null;
                // Clear from sessionStorage
                try {
                    sessionStorage.removeItem('consolidationSessionFilter');
                } catch (e) {
                    console.warn('Failed to clear session filter:', e);
                }
            } else {
                // When switching to consolidation, restore filter from sessionStorage
                try {
                    const stored = sessionStorage.getItem('consolidationSessionFilter');
                    if (stored) {
                        consolidationSessionFilter = parseInt(stored);
                    }
                } catch (e) {
                    console.warn('Failed to restore session filter:', e);
                }
            }

            // Update navigation
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
            });
            document.querySelector(`[data-section="${section}"]`).classList.add('active');

            // Update content
            document.querySelectorAll('.content-section').forEach(sec => {
                sec.classList.remove('active');
            });
            document.getElementById(section).classList.add('active');

            // Update URL to persist tab state
            const url = new URL(window.location);
            url.searchParams.set('tab', section);
            window.history.replaceState({}, '', url);

            currentSection = section;
            if (section === 'my-interviews') {
                loadMyInterviewsForAdmin();
            } else if (section === 'consolidation') {
                // Restore session filter from sessionStorage when loading consolidation
                try {
                    const stored = sessionStorage.getItem('consolidationSessionFilter');
                    if (stored) {
                        consolidationSessionFilter = parseInt(stored);
                    }
                } catch (e) {
                    console.warn('Failed to restore session filter:', e);
                }
                loadConsolidation();
            } else if (section === 'student-sessions') {
                loadStudentSessions();
            } else if (section === 'settings') {
                showSettingsTab('templates');
                showTemplateType('email');
                loadEmailTemplates();
            } else if (section === 'overview') {
                // Reload charts when switching to overview
                if (Object.keys(charts).length === 0) {
                    initializeDashboardCharts();
                }
            }
        }

        async function loadMyInterviewsForAdmin() {
            try {
                const tbody = document.getElementById('my-interviews-table-body');
                if (!tbody) return;
                tbody.innerHTML = '<tr><td colspan="9" class="loading">Loading interviews...</td></tr>';

                const urlParams = new URLSearchParams(window.location.search);
                const urlEmail = urlParams.get('email');
                const stored = localStorage.getItem('bees_user_data');
                const data = stored ? JSON.parse(stored) : null;
                const email = urlEmail || data?.email || '';

                if (!email) {
                    tbody.innerHTML = '<tr><td colspan="9" class="error">User email not available</td></tr>';
                    return;
                }

                const res = await fetch(`/api/interviewer/interviews?email=${encodeURIComponent(email)}`, {
                    headers: { 'x-user-email': email }
                });
                const json = await res.json();
                if (!res.ok || !json.success) throw new Error(json.error || `HTTP ${res.status}`);

                const items = json.data || [];
                myInterviews = items; // Store in global variable for filtering
                if (!items.length) {
                    tbody.innerHTML = '<tr><td colspan="10" class="empty-state">No interviews found.</td></tr>';
                    return;
                }

                displayMyInterviews(items);
                populateMyInterviewsSessionFilter(); // Add this to populate session filter for my interviews
                
                // Attach reliable click handlers for all edit buttons (avoid inline parsing edge cases)
                tbody.addEventListener('click', (e) => {
                    const btn = e.target.closest('.edit-btn');
                    if (!btn) return;
                    e.preventDefault();
                    e.stopPropagation();
                    const tr = btn.closest('tr');
                    const id = tr && tr.getAttribute('data-row-id');
                    if (id) startEdit(id);
                });
                
                // Clear any editing state when data is refreshed
                currentEditRow = null;
                currentEditData = null;
                
                // Reinitialize bulk edit controls after data is loaded
                initializeBulkEditControls();
            } catch (err) {
                console.error('Error loading admin my interviews:', err);
                const tbody = document.getElementById('my-interviews-table-body');
                if (tbody) tbody.innerHTML = `<tr><td colspan="9" class="error">${err.message}</td></tr>`;
            }
        }

        // Display function for my interviews
        function displayMyInterviews(interviewsData = myInterviews, groupBy = '') {
            const tbody = document.getElementById('my-interviews-table-body');
            const container = document.querySelector('#my-interviews .table-container');
            if (!tbody) return;

            if (!interviewsData || interviewsData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" class="empty-state">No interviews found.</td></tr>';
                return;
            }

            // Apply grouping if specified
            if (groupBy) {
                const groupedData = groupMyInterviews(interviewsData, groupBy);
                displayGroupedMyInterviews(groupedData, tbody);
                return;
            }

            // Inline search + advanced filters + sort
            const term = document.getElementById('my-interviews-inline-search')?.value || '';
            let list = applyInlineSearch(interviewsData, term, ['student_name','student_email','zeta_id','session_name','status','verdict']);
            list = applyAdvancedFiltersMyInterviews(list);
            list = applyInlineSort(list, 'my-interviews');
            
            // Check if no results after filtering
            if (list.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" class="empty-state">No matches found for your search or filter criteria</td></tr>';
                // Remove pagination controls and info
                if (container) {
                    const existingPagination = container.querySelector('.pagination-controls');
                    if (existingPagination) existingPagination.remove();
                    const existingInfo = container.querySelector('.pagination-info');
                    if (existingInfo) existingInfo.remove();
                }
                return;
            }
            
            // Update pagination
            updateTotalPages(list, 'my-interviews');
            const paginatedData = getPaginatedData(list, 'my-interviews');

            tbody.innerHTML = paginatedData.map(interview => `
                <tr data-row-id="${interview.id}">
                    <td><input type="checkbox" class="row-checkbox" data-row-id="${interview.id}" ${selectedRows.has(String(interview.id)) ? 'checked' : ''} onchange="toggleRowSelection('${interview.id}')"></td>
                    <td data-field="created_at">${formatDate(interview.created_at || interview.interview_date)}</td>
                    <td data-field="student_name">${interview.student_name || 'N/A'}</td>
                    <td data-field="zeta_id">${interview.zeta_id || 'N/A'}</td>
                    <td data-field="session_name">${interview.session_name || 'N/A'}</td>
                    <td data-field="status"><span class="status-badge status-${interview.status}">${interview.status}</span></td>
                    <td data-field="verdict">${interview.verdict || ''}</td>
                    <td data-field="duration_seconds">${formatDuration(interview.duration_seconds)}</td>
                    <td data-field="meeting_url">${interview.meeting_url ? `<a href="${interview.meeting_url}" target="_blank" rel="noopener noreferrer" style="color: #007bff; text-decoration: none;">${interview.meeting_url.length > 40 ? interview.meeting_url.substring(0, 40) + '...' : interview.meeting_url}</a>` : ''}</td>
                    <td>
                        ${interview.status === 'in_progress' ? `<button class="icon-btn" onclick="resumeInterviewAdmin(${interview.id})" title="Resume"></button>` : ''}
                        <button class="icon-btn" onclick="viewInterview(${interview.id})" title="View"><img src="/view.png" alt="View" style="width:16px;height:16px;vertical-align:middle"></button>
                        <button class="icon-btn edit-btn" onclick="startEdit('${interview.id}')" title="Edit"><img src="/edit.png" alt="Edit" style="width:16px;height:16px;vertical-align:middle"></button>
                        <button class="icon-btn delete-btn" onclick="deleteInterview('${interview.id}')" title="Delete"><img src="/delete.png" alt="Delete" style="width:16px;height:16px;vertical-align:middle"></button>
                    </td>
                </tr>
            `).join('');
            
            // Add pagination controls
            if (container) {
                const existingPagination = container.querySelector('.pagination-controls');
                if (existingPagination) {
                    existingPagination.remove();
                }
                
                const paginationHTML = createPaginationControls('my-interviews');
                if (paginationHTML) {
                    container.insertAdjacentHTML('beforeend', paginationHTML);
                }
                
                // Add pagination info
                const existingInfo = container.querySelector('.pagination-info');
                if (existingInfo) {
                    existingInfo.remove();
                }
                
                const startIndex = (currentPage['my-interviews'] - 1) * ITEMS_PER_PAGE + 1;
                const endIndex = Math.min(currentPage['my-interviews'] * ITEMS_PER_PAGE, list.length);
                const infoHTML = `
                    <div class="pagination-info">
                        <span>Showing ${startIndex}-${endIndex} of ${list.length} interviews</span>
                        <span>Page ${currentPage['my-interviews']} of ${totalPages['my-interviews']}</span>
                    </div>
                `;
                container.insertAdjacentHTML('beforeend', infoHTML);

                // Update sort indicators
                updateSortIndicators('my-interviews');
                
                // Update the Select All checkbox state after pagination
                updateSelectAllCheckbox();
            }
        }

        // Group my interviews function
        function groupMyInterviews(interviews, groupBy) {
            const groups = {};
            
            interviews.forEach(interview => {
                let groupKey = '';
                switch (groupBy) {
                    case 'status':
                        groupKey = interview.status || 'Unknown';
                        break;
                    case 'verdict':
                        groupKey = interview.verdict || 'No Verdict';
                        break;
                    case 'date':
                        groupKey = formatDate(interview.created_at || interview.interview_date);
                        break;
                    default:
                        groupKey = 'All Interviews';
                }
                
                if (!groups[groupKey]) {
                    groups[groupKey] = [];
                }
                groups[groupKey].push(interview);
            });
            
            return { groups, interviews };
        }

        // Display grouped my interviews
        function displayGroupedMyInterviews(groupedData, tbody) {
            const { groups } = groupedData;
            let html = '';
            
            Object.keys(groups).forEach(groupKey => {
                const groupInterviews = groups[groupKey];
                html += `
                    <tr class="group-header">
                        <td colspan="10" style="background: #2d3748; color: white; font-weight: 600; padding: 12px;">
                            ${groupKey} (${groupInterviews.length} interviews)
                        </td>
                    </tr>
                `;
                
                groupInterviews.forEach(interview => {
                    html += `
                        <tr data-row-id="${interview.id}">
                            <td><input type="checkbox" class="row-checkbox" data-row-id="${interview.id}" onchange="toggleRowSelection('${interview.id}')"></td>
                            <td data-field="created_at">${formatDate(interview.created_at || interview.interview_date)}</td>
                            <td data-field="student_name">${interview.student_name || 'N/A'}</td>
                            <td data-field="zeta_id">${interview.zeta_id || 'N/A'}</td>
                            <td data-field="session_name">${interview.session_name || 'N/A'}</td>
                            <td data-field="status"><span class="status-badge status-${interview.status}">${interview.status}</span></td>
                            <td data-field="verdict">${interview.verdict || ''}</td>
                            <td data-field="duration_seconds">${formatDuration(interview.duration_seconds)}</td>
                            <td data-field="meeting_url">${interview.meeting_url ? `<a href="${interview.meeting_url}" target="_blank" rel="noopener noreferrer" style="color: #007bff; text-decoration: none;">${interview.meeting_url.length > 40 ? interview.meeting_url.substring(0, 40) + '...' : interview.meeting_url}</a>` : ''}</td>
                            <td>
                                <button class="icon-btn edit-btn" onclick="startEdit('${interview.id}')" title="Edit"><img src="/edit.png" alt="Edit" style="width:16px;height:16px;vertical-align:middle"></button>
                                <button class="icon-btn delete-btn" onclick="deleteInterview('${interview.id}')" title="Delete"><img src="/delete.png" alt="Delete" style="width:16px;height:16px;vertical-align:middle"></button>
                                <button class="icon-btn" onclick="viewInterview(${interview.id})" title="View"><img src="/view.png" alt="View" style="width:16px;height:16px;vertical-align:middle"></button>
                            </td>
                        </tr>
                    `;
                });
            });
            
            tbody.innerHTML = html;
        }

        // Chart instances
        let charts = {};

        // Overview functions
        async function loadOverviewStats() {
            try {
                const [interviewsRes, sessionsRes, questionsRes, studentsRes] = await Promise.all([
                    fetch('/api/admin/interviews/stats'),
                    fetch('/api/admin/sessions/stats'),
                    fetch('/api/admin/questions/stats'),
                    fetch('/api/admin/students/stats')
                ]);

                const interviewsData = await interviewsRes.json();
                const sessionsData = await sessionsRes.json();
                const questionsData = await questionsRes.json();
                const studentsData = await studentsRes.json();

                document.getElementById('total-interviews').textContent = interviewsData.data?.total || 0;
                document.getElementById('active-sessions').textContent = sessionsData.data?.active || 0;
                document.getElementById('total-questions').textContent = questionsData.data?.total_questions || 0;
                document.getElementById('total-students').textContent = studentsData.data?.total || 0;
                
                // Initialize charts
                await initializeDashboardCharts();
            } catch (error) {
                console.error('Error loading overview stats:', error);
            }
        }

        // Initialize all dashboard charts
        // Store raw data for filtering
        let rawChartData = {
            interviews: [],
            users: [],
            questions: [],
            sessions: []
        };

        // Apply chart filters
        function applyChartFilters() {
            const dateRange = document.getElementById('chart-date-range').value;
            const status = document.getElementById('chart-status-filter').value;
            const verdict = document.getElementById('chart-verdict-filter').value;
            const interviewer = document.getElementById('chart-interviewer-filter').value;
            
            // Show/hide custom date range
            const customDateDiv = document.getElementById('custom-date-range');
            if (dateRange === 'custom') {
                customDateDiv.style.display = 'flex';
            } else {
                customDateDiv.style.display = 'none';
            }
            
            // Filter interviews based on selected criteria
            let filteredInterviews = [...rawChartData.interviews];
            
            // Date range filter
            if (dateRange !== 'all') {
                const now = new Date();
                let startDate = new Date();
                
                switch(dateRange) {
                    case 'today':
                        startDate.setHours(0, 0, 0, 0);
                        break;
                    case 'week':
                        startDate.setDate(now.getDate() - 7);
                        break;
                    case 'month':
                        startDate.setDate(now.getDate() - 30);
                        break;
                    case 'quarter':
                        startDate.setMonth(now.getMonth() - 3);
                        break;
                    case 'year':
                        startDate.setFullYear(now.getFullYear() - 1);
                        break;
                    case 'custom':
                        const dateFrom = document.getElementById('chart-date-from').value;
                        const dateTo = document.getElementById('chart-date-to').value;
                        if (dateFrom) startDate = new Date(dateFrom);
                        if (dateTo) {
                            const endDate = new Date(dateTo);
                            endDate.setHours(23, 59, 59, 999);
                            filteredInterviews = filteredInterviews.filter(i => {
                                const iDate = new Date(i.created_at);
                                return iDate >= startDate && iDate <= endDate;
                            });
                        } else {
                            filteredInterviews = filteredInterviews.filter(i => new Date(i.created_at) >= startDate);
                        }
                        break;
                }
                
                if (dateRange !== 'custom') {
                    filteredInterviews = filteredInterviews.filter(i => new Date(i.created_at) >= startDate);
                }
            }
            
            // Status filter
            if (status !== 'all') {
                filteredInterviews = filteredInterviews.filter(i => i.status === status);
            }
            
            // Verdict filter
            if (verdict !== 'all') {
                if (verdict === 'none') {
                    filteredInterviews = filteredInterviews.filter(i => !i.verdict || i.verdict === '-');
                } else {
                    filteredInterviews = filteredInterviews.filter(i => i.verdict === verdict);
                }
            }
            
            // Interviewer filter
            if (interviewer !== 'all') {
                filteredInterviews = filteredInterviews.filter(i => i.interviewer_email === interviewer);
            }
            
            // Update stats cards
            document.getElementById('total-interviews').textContent = filteredInterviews.length;
            const completedCount = filteredInterviews.filter(i => i.status === 'completed').length;
            document.getElementById('active-sessions').textContent = filteredInterviews.filter(i => i.status === 'in_progress').length;
            
            // Recreate all charts with filtered data
            createStatusChart(filteredInterviews);
            createVerdictChart(filteredInterviews);
            createTrendsChart(filteredInterviews);
            
            console.log(` Charts updated with ${filteredInterviews.length} filtered interviews`);
        }
        
        // Clear all chart filters
        function clearChartFilters() {
            document.getElementById('chart-date-range').value = 'month';
            document.getElementById('chart-status-filter').value = 'all';
            document.getElementById('chart-verdict-filter').value = 'all';
            document.getElementById('chart-interviewer-filter').value = 'all';
            document.getElementById('custom-date-range').style.display = 'none';
            document.getElementById('chart-date-from').value = '';
            document.getElementById('chart-date-to').value = '';
            applyChartFilters();
        }
        
        // Populate interviewer dropdown
        function populateInterviewerFilter(users) {
            const select = document.getElementById('chart-interviewer-filter');
            // Clear existing options except "All"
            select.innerHTML = '<option value="all">All Interviewers</option>';
            
            // Get unique interviewers from users
            const interviewers = users.filter(u => u.role === 'interviewer' || u.role === 'admin' || u.role === 'superadmin');
            interviewers.forEach(user => {
                const option = document.createElement('option');
                option.value = user.email;
                option.textContent = user.name || user.email;
                select.appendChild(option);
            });
        }

        // Populate all chart-specific filter dropdowns
        function populateChartFilters() {
            // Populate interviewer filters
            const statusInterviewerSelect = document.getElementById('status-interviewer-filter');
            statusInterviewerSelect.innerHTML = '<option value="all">All Interviewers</option>';
            const interviewers = rawChartData.users.filter(u => u.role === 'interviewer' || u.role === 'admin' || u.role === 'superadmin');
            interviewers.forEach(user => {
                const option = document.createElement('option');
                option.value = user.email;
                option.textContent = user.name || user.email;
                statusInterviewerSelect.appendChild(option);
            });

            // Populate session filters (only active sessions) - for verdict chart
            const verdictSessionSelect = document.getElementById('verdict-session-filter');
            if (verdictSessionSelect) {
            verdictSessionSelect.innerHTML = '<option value="all">All Sessions</option>';
                
                // Filter out inactive sessions
                const activeSessions = rawChartData.sessions.filter(session => session.status === 'active');
                activeSessions.forEach(session => {
                    const opt = document.createElement('option');
                    opt.value = session.id;
                    opt.textContent = session.name || `Session ${session.id}`;
                    verdictSessionSelect.appendChild(opt);
                });
            }

            // Populate session filter for round verdict chart
            const roundVerdictSessionSelect = document.getElementById('round-verdict-session-filter');
            if (roundVerdictSessionSelect) {
                roundVerdictSessionSelect.innerHTML = '<option value="all">All Sessions</option>';
                const activeSessions = rawChartData.sessions.filter(session => session.status === 'active');
                activeSessions.forEach(session => {
                    const opt = document.createElement('option');
                    opt.value = session.id;
                    opt.textContent = session.name || `Session ${session.id}`;
                    roundVerdictSessionSelect.appendChild(opt);
                });
            }

            // Populate student filter for round verdict chart
            const roundVerdictStudentSelect = document.getElementById('round-verdict-student-filter');
            if (roundVerdictStudentSelect) {
                roundVerdictStudentSelect.innerHTML = '<option value="all">All Students</option>';
                // Get unique students from interviews
                const studentMap = new Map();
                rawChartData.interviews.forEach(interview => {
                    if (interview.student_id && interview.student_name) {
                        if (!studentMap.has(interview.student_id)) {
                            studentMap.set(interview.student_id, {
                                id: interview.student_id,
                                name: interview.student_name,
                                zeta_id: interview.zeta_id || ''
                            });
                        }
                    }
                });
                const students = Array.from(studentMap.values()).sort((a, b) => {
                    const nameA = (a.name || '').toLowerCase();
                    const nameB = (b.name || '').toLowerCase();
                    return nameA.localeCompare(nameB);
                });
                students.forEach(student => {
                    const opt = document.createElement('option');
                    opt.value = student.id;
                    opt.textContent = `${student.name}${student.zeta_id ? ' (' + student.zeta_id + ')' : ''}`;
                    roundVerdictStudentSelect.appendChild(opt);
                });
            }
        }

        // Helper function to filter by date range
        function filterByDateRange(data, range) {
            if (range === 'all') return data;
            
            const now = new Date();
            let startDate = new Date();
            
            switch(range) {
                case 'week':
                    startDate.setDate(now.getDate() - 7);
                    break;
                case 'month':
                    startDate.setDate(now.getDate() - 30);
                    break;
                case 'quarter':
                    startDate.setMonth(now.getMonth() - 3);
                    break;
                case 'year':
                    startDate.setFullYear(now.getFullYear() - 1);
                    break;
            }
            
            return data.filter(item => new Date(item.created_at) >= startDate);
        }

        // Update individual charts
        function updateStatusChart() {
            const dateRange = document.getElementById('status-date-filter').value;
            const interviewer = document.getElementById('status-interviewer-filter').value;
            
            let filtered = filterByDateRange(rawChartData.interviews, dateRange);
            if (interviewer !== 'all') {
                filtered = filtered.filter(i => i.interviewer_email === interviewer);
            }
            
            createStatusChart(filtered);
        }

        function updateVerdictChart() {
            const session = document.getElementById('verdict-session-filter').value;
            const status = document.getElementById('verdict-status-filter').value;
            
            let filtered = [...rawChartData.interviews];
            if (session !== 'all') {
                filtered = filtered.filter(i => i.session_id == session);
            }
            if (status !== 'all') {
                filtered = filtered.filter(i => i.status === status);
            }
            
            createVerdictChart(filtered);
        }

        function updateTrendsChart() {
            const range = document.getElementById('trends-range-filter').value;
            const verdict = document.getElementById('trends-verdict-filter').value;
            
            let filtered = filterByDateRange(rawChartData.interviews, range);
            if (verdict !== 'all') {
                filtered = filtered.filter(i => i.verdict === verdict);
            }
            
            createTrendsChart(filtered);
        }

        async function updateStudentSessionsChart() {
            try {
                const year = document.getElementById('student-sessions-year-filter')?.value || 'all';
                const sessionId = document.getElementById('student-sessions-session-filter')?.value || 'all';
                const response = await fetch(`/api/admin/student-sessions/stats?year=${encodeURIComponent(year)}&session_id=${encodeURIComponent(sessionId)}`);
                const result = await response.json();
                
                if (!response.ok || !result.success) {
                    console.error('Failed to load student sessions stats:', result.error);
                    return;
                }
                
                const data = result.data || [];
                const years = result.years || [];
                const sessions = result.sessions || [];
                
                // Populate year dropdown if not already populated
                const yearSelect = document.getElementById('student-sessions-year-filter');
                if (yearSelect && yearSelect.options.length === 1) {
                    years.forEach(year => {
                        const option = document.createElement('option');
                        option.value = year;
                        option.textContent = year;
                        yearSelect.appendChild(option);
                    });
                }
                
                // Populate session dropdown if not already populated
                const sessionSelect = document.getElementById('student-sessions-session-filter');
                if (sessionSelect && sessionSelect.options.length === 1) {
                    sessions.forEach(session => {
                        const option = document.createElement('option');
                        option.value = session.id;
                        option.textContent = session.name;
                        sessionSelect.appendChild(option);
                    });
                }
                
                createStudentSessionsChart(data, sessionId);
            } catch (error) {
                console.error('Error updating student sessions chart:', error);
            }
        }

        function updateCategoriesChart() {
            const usage = document.getElementById('categories-usage-filter').value;
            
            let filtered = [...rawChartData.questions];
            if (usage === 'used') {
                filtered = filtered.filter(q => (q.times_asked || 0) > 0);
            } else if (usage === 'unused') {
                filtered = filtered.filter(q => (q.times_asked || 0) === 0);
            }
            
            createCategoriesChart(filtered);
        }

        function updateScoresChart() {
            const metric = document.getElementById('scores-metric-filter').value;
            createScoresChart(rawChartData.questions, metric);
        }

        async function updateRoundVerdictChart() {
            const sessionId = document.getElementById('round-verdict-session-filter')?.value || 'all';
            const studentId = document.getElementById('round-verdict-student-filter')?.value || 'all';
            
            try {
                const params = new URLSearchParams();
                if (sessionId !== 'all') params.append('session_id', sessionId);
                if (studentId !== 'all') params.append('student_id', studentId);
                
                const response = await fetch(`/api/admin/verdicts-by-round?${params.toString()}`);
                const result = await response.json();
                
                if (result.success && result.data) {
                    createRoundVerdictChart(result.data);
                } else {
                    console.error('Error fetching round verdict data:', result.error);
                    // Show empty chart if no data
                    createRoundVerdictChart([]);
                }
            } catch (error) {
                console.error('Error updating round verdict chart:', error);
                // Show empty chart on error
                createRoundVerdictChart([]);
            }
        }

        function createRoundVerdictChart(data) {
            const ctx = document.getElementById('roundVerdictChart');
            if (!ctx) {
                console.error('roundVerdictChart canvas not found');
                return;
            }

            // Group data by round
            const rounds = {};
            if (data && data.length > 0) {
                data.forEach(row => {
                    const round = `Round ${row.round_number}`;
                    if (!rounds[round]) {
                        rounds[round] = {
                            tiger: 0,
                            cow: 0,
                            sheep: 0,
                            pending: 0
                        };
                    }
                    rounds[round].tiger += parseInt(row.tiger_count || 0);
                    rounds[round].cow += parseInt(row.cow_count || 0);
                    rounds[round].sheep += parseInt(row.sheep_count || 0);
                    rounds[round].pending += parseInt(row.pending_count || 0);
                });
            }
            
            const roundLabels = Object.keys(rounds).sort((a, b) => {
                const numA = parseInt(a.replace('Round ', ''));
                const numB = parseInt(b.replace('Round ', ''));
                return numA - numB;
            });
            
            // If no data, show empty chart with message
            if (roundLabels.length === 0) {
                if (charts.roundVerdict) charts.roundVerdict.destroy();
                charts.roundVerdict = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: ['No Data'],
                        datasets: [{
                            label: 'No interviews found',
                            data: [0],
                            backgroundColor: '#e5e7eb'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        scales: {
                            y: { beginAtZero: true }
                        },
                        plugins: {
                            legend: { display: false },
                            tooltip: { enabled: false }
                        }
                    }
                });
                return;
            }
            
            if (charts.roundVerdict) charts.roundVerdict.destroy();
            
            charts.roundVerdict = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: roundLabels,
                    datasets: [
                        {
                            label: 'Tiger',
                            data: roundLabels.map(round => rounds[round].tiger),
                            backgroundColor: '#10b981',
                            borderColor: '#10b981',
                            borderWidth: 1
                        },
                        {
                            label: 'Cow',
                            data: roundLabels.map(round => rounds[round].cow),
                            backgroundColor: '#f59e0b',
                            borderColor: '#f59e0b',
                            borderWidth: 1
                        },
                        {
                            label: 'Sheep',
                            data: roundLabels.map(round => rounds[round].sheep),
                            backgroundColor: '#6b7280',
                            borderColor: '#6b7280',
                            borderWidth: 1
                        },
                        {
                            label: 'Pending',
                            data: roundLabels.map(round => rounds[round].pending),
                            backgroundColor: '#e5e7eb',
                            borderColor: '#e5e7eb',
                            borderWidth: 1
                        }
                    ]
                },
                plugins: [{
                    id: 'datalabels-round-verdict',
                    afterDraw: function(chart) {
                        const ctx = chart.ctx;
                        chart.data.datasets.forEach((dataset, datasetIndex) => {
                            const meta = chart.getDatasetMeta(datasetIndex);
                            meta.data.forEach((bar, index) => {
                                const value = dataset.data[index];
                                if (value > 0) {
                                    ctx.save();
                                    ctx.fillStyle = '#111827';
                                    ctx.font = 'bold 12px Arial';
                                    ctx.textAlign = 'center';
                                    ctx.textBaseline = 'middle';
                                    const x = bar.x;
                                    const y = bar.y - 10;
                                    ctx.fillText(value, x, y);
                                    ctx.restore();
                                }
                            });
                        });
                    }
                }],
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    scales: {
                        x: {
                            stacked: true,
                            ticks: {
                                font: { size: 11 }
                            }
                        },
                        y: {
                            stacked: true,
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1,
                                font: { size: 11 }
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: { padding: 15, font: { size: 12 } }
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false
                        }
                    }
                }
            });
        }

        async function initializeDashboardCharts() {
            try {
                console.log(' Initializing dashboard charts...');
                
                // Check if Chart.js is loaded
                if (typeof Chart === 'undefined') {
                    console.error(' Chart.js is not loaded! Skipping chart initialization.');
                    // Show a message to the user
                    const chartContainers = document.querySelectorAll('.chart-container');
                    chartContainers.forEach(container => {
                        const canvas = container.querySelector('canvas');
                        if (canvas) {
                            const ctx = canvas.getContext('2d');
                            ctx.font = '14px Arial';
                            ctx.fillStyle = '#666';
                            ctx.textAlign = 'center';
                            ctx.fillText('Chart library failed to load. Please refresh the page.', canvas.width / 2, canvas.height / 2);
                        }
                    });
                    return;
                }
                
                console.log(' Chart.js loaded successfully');
                
                // Fetch all data
                console.log(' Fetching data for charts...');
                const [interviewsRes, usersRes, questionsRes, sessionsRes] = await Promise.all([
                    fetch('/api/admin/interviews'),
                    fetch('/api/users'),
                    fetch('/api/question-bank'),
                    fetch('/api/admin/sessions')
                ]);

                const interviewsData = await interviewsRes.json();
                const usersData = await usersRes.json();
                const questionsData = await questionsRes.json();
                const sessionsData = await sessionsRes.json();

                const interviews = interviewsData.data || [];
                const users = usersData.data || [];
                const questions = questionsData.data || [];
                const sessions = sessionsData.data || [];

                // Store raw data for filtering
                rawChartData.interviews = interviews;
                rawChartData.users = users;
                rawChartData.questions = questions;
                rawChartData.sessions = sessions;

                console.log(' Data fetched:', {
                    interviews: interviews.length,
                    users: users.length,
                    questions: questions.length,
                    sessions: sessions.length
                });

                // Populate all filter dropdowns
                populateInterviewerFilter(users);
                populateChartFilters();

                // Create charts with initial filter values
                console.log(' Creating charts...');
                updateStatusChart();
                updateVerdictChart();
                updateTrendsChart();
                updateStudentSessionsChart();
                updateCategoriesChart();
                updateScoresChart();
                updateRoundVerdictChart();
                
                console.log(' All charts created successfully!');
            } catch (error) {
                console.error(' Error initializing charts:', error);
            }
        }

        // Refresh all charts
        async function refreshDashboardCharts() {
            // Destroy existing charts
            Object.values(charts).forEach(chart => {
                if (chart) chart.destroy();
            });
            charts = {};
            
            // Reload charts
            await initializeDashboardCharts();
        }

        // Interview Status Distribution (Donut Chart)
        function createStatusChart(interviews) {
            const statusCounts = {};
            interviews.forEach(i => {
                const status = i.status || 'pending';
                statusCounts[status] = (statusCounts[status] || 0) + 1;
            });

            const ctx = document.getElementById('statusChart');
            if (charts.status) charts.status.destroy();
            
            charts.status = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(statusCounts),
                    datasets: [{
                        data: Object.values(statusCounts),
                        backgroundColor: ['#10b981', '#f59e0b', '#ef4444', '#6b7280'],
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                plugins: [{
                    id: 'datalabels-status',
                    afterDraw: function(chart) {
                        const ctx = chart.ctx;
                        const data = chart.data.datasets[0].data;
                        chart.data.datasets.forEach((dataset, i) => {
                            const meta = chart.getDatasetMeta(i);
                            meta.data.forEach((segment, index) => {
                                const value = data[index];
                                if (value > 0) {
                                    const angle = (segment.startAngle + segment.endAngle) / 2;
                                    const x = segment.x + Math.cos(angle) * (segment.outerRadius * 0.7);
                                    const y = segment.y + Math.sin(angle) * (segment.outerRadius * 0.7);
                                    ctx.save();
                                    ctx.fillStyle = '#111827';
                                    ctx.font = 'bold 12px Arial';
                                    ctx.textAlign = 'center';
                                    ctx.textBaseline = 'middle';
                                    ctx.fillText(value, x, y);
                                    ctx.restore();
                                }
                            });
                        });
                    }
                }],
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: { padding: 15, font: { size: 12 } }
                        }
                    }
                }
            });
        }

        // Interview Outcome Distribution (Pie Chart)
        function createVerdictChart(interviews) {
            const verdictCounts = { 'Tiger': 0, 'Cow': 0, 'Sheep': 0, 'Pending': 0 };
            interviews.forEach(i => {
                const verdict = i.verdict || 'Pending';
                if (verdict.toLowerCase().includes('tiger')) verdictCounts['Tiger']++;
                else if (verdict.toLowerCase().includes('cow')) verdictCounts['Cow']++;
                else if (verdict.toLowerCase().includes('sheep')) verdictCounts['Sheep']++;
                else verdictCounts['Pending']++;
            });

            const ctx = document.getElementById('verdictChart');
            if (charts.verdict) charts.verdict.destroy();
            
            charts.verdict = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: Object.keys(verdictCounts),
                    datasets: [{
                        data: Object.values(verdictCounts),
                        backgroundColor: ['#10b981', '#f59e0b', '#6b7280', '#e5e7eb'],
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                plugins: [{
                    id: 'datalabels-verdict',
                    afterDraw: function(chart) {
                        const ctx = chart.ctx;
                        const data = chart.data.datasets[0].data;
                        chart.data.datasets.forEach((dataset, i) => {
                            const meta = chart.getDatasetMeta(i);
                            meta.data.forEach((segment, index) => {
                                const value = data[index];
                                if (value > 0) {
                                    const angle = (segment.startAngle + segment.endAngle) / 2;
                                    const x = segment.x + Math.cos(angle) * (segment.outerRadius * 0.7);
                                    const y = segment.y + Math.sin(angle) * (segment.outerRadius * 0.7);
                                    ctx.save();
                                    ctx.fillStyle = '#111827';
                                    ctx.font = 'bold 12px Arial';
                                    ctx.textAlign = 'center';
                                    ctx.textBaseline = 'middle';
                                    ctx.fillText(value, x, y);
                                    ctx.restore();
                                }
                            });
                        });
                    }
                }],
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: { padding: 15, font: { size: 12 } }
                        }
                    }
                }
            });
        }

        // Interviews Over Time (Line Chart)
        function createTrendsChart(interviews) {
            const last30Days = {};
            const today = new Date();
            
            // Initialize last 30 days
            for (let i = 29; i >= 0; i--) {
                const date = new Date(today);
                date.setDate(date.getDate() - i);
                const dateStr = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                last30Days[dateStr] = 0;
            }

            // Count interviews per day
            interviews.forEach(i => {
                if (i.created_at) {
                    const date = new Date(i.created_at);
                    const dateStr = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                    if (last30Days.hasOwnProperty(dateStr)) {
                        last30Days[dateStr]++;
                    }
                }
            });

            const ctx = document.getElementById('trendsChart');
            if (charts.trends) charts.trends.destroy();
            
            charts.trends = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: Object.keys(last30Days),
                    datasets: [{
                        label: 'Interviews',
                        data: Object.values(last30Days),
                        borderColor: '#1E4ED8',
                        backgroundColor: 'rgba(30, 78, 216, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                plugins: [{
                    id: 'datalabels-trends',
                    afterDatasetsDraw: function(chart) {
                        const ctx = chart.ctx;
                        chart.data.datasets.forEach((dataset, i) => {
                            const meta = chart.getDatasetMeta(i);
                            meta.data.forEach((point, index) => {
                                const value = dataset.data[index];
                                if (value > 0) {
                                    ctx.save();
                                    ctx.fillStyle = '#111827';
                                    ctx.font = 'bold 11px Arial';
                                    ctx.textAlign = 'center';
                                    ctx.textBaseline = 'bottom';
                                    const x = point.x;
                                    const y = point.y - 8;
                                    ctx.fillText(value, x, y);
                                    ctx.restore();
                                }
                            });
                        });
                    }
                }],
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { stepSize: 1 }
                        }
                    }
                }
            });
        }

        // Student Sessions Status by Session (Bar Chart - Status on X-axis)
        function createStudentSessionsChart(data, selectedSessionId) {
            // Count statuses
            const statusCounts = {};
            
            data.forEach(row => {
                const status = row.status || 'No Status';
                statusCounts[status] = (statusCounts[status] || 0) + parseInt(row.count) || 0;
            });
            
            // Sort statuses in a logical order
            const statusOrder = [
                'round 1 started', 'round 1 ended',
                'round 2 started', 'round 2 ended',
                'round 3 started', 'round 3 ended',
                'selected', 'rejected', 'waitlisted',
                'No show', 'Disqualified', 'Age Mismatch', 'Degree holder', 'Interviewer unavailable',
                'No Status'
            ];
            
            const statuses = statusOrder.filter(s => statusCounts.hasOwnProperty(s));
            const otherStatuses = Object.keys(statusCounts).filter(s => !statusOrder.includes(s)).sort();
            const allStatuses = [...statuses, ...otherStatuses];
            
            const labels = allStatuses;
            const counts = allStatuses.map(status => statusCounts[status] || 0);
            
            // Define colors for different statuses
            const statusColors = {
                'round 1 started': '#3b82f6',
                'round 1 ended': '#10b981',
                'round 2 started': '#3b82f6',
                'round 2 ended': '#10b981',
                'round 3 started': '#3b82f6',
                'round 3 ended': '#10b981',
                'selected': '#10b981',
                'rejected': '#ef4444',
                'waitlisted': '#f59e0b',
                'No show': '#6b7280',
                'Disqualified': '#dc2626',
                'Age Mismatch': '#f97316',
                'Degree holder': '#8b5cf6',
                'Interviewer unavailable': '#ec4899',
                'No Status': '#9ca3af'
            };
            
            const backgroundColor = labels.map(status => statusColors[status] || '#6b7280');
            
            const ctx = document.getElementById('studentSessionsChart');
            if (!ctx) return;
            
            if (charts.studentSessions) charts.studentSessions.destroy();
            
            charts.studentSessions = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Count',
                        data: counts,
                        backgroundColor: backgroundColor,
                        borderRadius: 4
                    }]
                },
                plugins: [{
                    id: 'datalabels',
                    afterDatasetsDraw: function(chart) {
                        const ctx = chart.ctx;
                        chart.data.datasets.forEach((dataset, i) => {
                            const meta = chart.getDatasetMeta(i);
                            meta.data.forEach((bar, index) => {
                                const value = dataset.data[index];
                                if (value > 0) {
                                    ctx.save();
                                    ctx.fillStyle = '#111827';
                                    ctx.font = 'bold 12px Arial';
                                    ctx.textAlign = 'center';
                                    ctx.textBaseline = 'bottom';
                                    const x = bar.x;
                                    const y = bar.y - 5;
                                    ctx.fillText(value, x, y);
                                    ctx.restore();
                                }
                            });
                        });
                    }
                }],
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.parsed.y} student(s)`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            ticks: {
                                maxRotation: 45,
                                minRotation: 45,
                                font: { size: 11 }
                            }
                        },
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            },
                            title: {
                                display: true,
                                text: 'Number of Students'
                            }
                        }
                    }
                }
            });
        }

        // Question Categories Distribution (Donut Chart)
        function createCategoriesChart(questions) {
            const categoryCounts = {};
            questions.forEach(q => {
                const category = q.category || 'Uncategorized';
                categoryCounts[category] = (categoryCounts[category] || 0) + 1;
            });

            const colors = ['#1E4ED8', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#ec4899', '#06b6d4'];

            const ctx = document.getElementById('categoriesChart');
            if (charts.categories) charts.categories.destroy();
            
            charts.categories = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(categoryCounts),
                    datasets: [{
                        data: Object.values(categoryCounts),
                        backgroundColor: colors,
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                plugins: [{
                    id: 'datalabels-categories',
                    afterDraw: function(chart) {
                        const ctx = chart.ctx;
                        const data = chart.data.datasets[0].data;
                        chart.data.datasets.forEach((dataset, i) => {
                            const meta = chart.getDatasetMeta(i);
                            meta.data.forEach((segment, index) => {
                                const value = data[index];
                                if (value > 0) {
                                    const angle = (segment.startAngle + segment.endAngle) / 2;
                                    const x = segment.x + Math.cos(angle) * (segment.outerRadius * 0.7);
                                    const y = segment.y + Math.sin(angle) * (segment.outerRadius * 0.7);
                                    ctx.save();
                                    ctx.fillStyle = '#111827';
                                    ctx.font = 'bold 12px Arial';
                                    ctx.textAlign = 'center';
                                    ctx.textBaseline = 'middle';
                                    ctx.fillText(value, x, y);
                                    ctx.restore();
                                }
                            });
                        });
                    }
                }],
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: { padding: 15, font: { size: 11 } }
                        }
                    }
                }
            });
        }

        // Average Scores by Category (Bar Chart)
        function createScoresChart(questions, metric = 'avg') {
            const categoryScores = {};
            const categoryCounts = {};
            const categorySuccessRates = {};

            questions.forEach(q => {
                const category = q.category || 'Uncategorized';
                const score = parseFloat(q.average_score) || 0;
                const successRate = parseFloat(q.success_rate) || 0;
                
                if (!categoryScores[category]) {
                    categoryScores[category] = 0;
                    categoryCounts[category] = 0;
                    categorySuccessRates[category] = 0;
                }
                categoryScores[category] += score;
                categorySuccessRates[category] += successRate;
                categoryCounts[category]++;
            });

            let chartData, chartLabel;
            if (metric === 'success') {
                chartData = {};
                Object.keys(categorySuccessRates).forEach(cat => {
                    chartData[cat] = categoryCounts[cat] > 0 ? (categorySuccessRates[cat] / categoryCounts[cat]).toFixed(2) : 0;
                });
                chartLabel = 'Success Rate (%)';
            } else {
                chartData = {};
                Object.keys(categoryScores).forEach(cat => {
                    chartData[cat] = categoryCounts[cat] > 0 ? (categoryScores[cat] / categoryCounts[cat]).toFixed(2) : 0;
                });
                chartLabel = 'Average Score (out of 10)';
            }

            const ctx = document.getElementById('scoresChart');
            if (charts.scores) charts.scores.destroy();
            
            charts.scores = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: Object.keys(chartData),
                    datasets: [{
                        label: chartLabel,
                        data: Object.values(chartData),
                        backgroundColor: '#10b981',
                        borderRadius: 4
                    }]
                },
                plugins: [{
                    id: 'datalabels-scores',
                    afterDatasetsDraw: function(chart) {
                        const ctx = chart.ctx;
                        chart.data.datasets.forEach((dataset, i) => {
                            const meta = chart.getDatasetMeta(i);
                            meta.data.forEach((bar, index) => {
                                const value = dataset.data[index];
                                if (value > 0) {
                                    ctx.save();
                                    ctx.fillStyle = '#111827';
                                    ctx.font = 'bold 12px Arial';
                                    ctx.textAlign = 'center';
                                    ctx.textBaseline = 'bottom';
                                    const x = bar.x;
                                    const y = bar.y - 5;
                                    ctx.fillText(value, x, y);
                                    ctx.restore();
                                }
                            });
                        });
                    }
                }],
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 10,
                            ticks: { stepSize: 2 }
                        }
                    }
                }
            });
        }

        // Interviews functions
        async function loadInterviews() {
            const tbody = document.getElementById('interviews-table-body');
            if (tbody) {
                tbody.innerHTML = '<tr><td colspan="10" class="loading">Loading interviews...</td></tr>';
            }
            
            try {
                const response = await fetch('/api/admin/interviews');
                const data = await response.json();
                
                if (data.success) {
                    interviews = data.data;
                    displayInterviews();
                    populateInterviewerFilter();
                    populateSessionFilter(); // Add this to populate session filter
                } else {
                    if (tbody) {
                        tbody.innerHTML = '<tr><td colspan="10" class="error">Failed to load interviews</td></tr>';
                    }
                }
            } catch (error) {
                console.error('Error loading interviews:', error);
                if (tbody) {
                    tbody.innerHTML = '<tr><td colspan="10" class="error">Error loading interviews</td></tr>';
                }
            }
        }
        function displayInterviews() {
            const tbody = document.getElementById('interviews-table-body');
            const container = document.querySelector('#interviews .table-container');
            
            if (interviews.length === 0) {
                tbody.innerHTML = '<tr><td colspan="11" class="empty-state">No interviews found</td></tr>';
                return;
            }

            // Inline search + advanced filters + sort
            const term = document.getElementById('interviews-inline-search')?.value || '';
            let filteredInterviews = applyInlineSearch(interviews, term, ['student_name','student_email','zeta_id','interviewer_name','session_name','status','verdict']);
            filteredInterviews = applyAdvancedFilters(filteredInterviews);
            filteredInterviews = applyInlineSort(filteredInterviews, 'interviews');
            
            // Check if no results after filtering
            if (filteredInterviews.length === 0) {
                tbody.innerHTML = '<tr><td colspan="11" class="empty-state">No matches found for your search or filter criteria</td></tr>';
                // Remove pagination controls and info
                const existingPagination = container.querySelector('.pagination-controls');
                if (existingPagination) existingPagination.remove();
                const existingInfo = container.querySelector('.pagination-info');
                if (existingInfo) existingInfo.remove();
                return;
            }
            
            // Update pagination
            updateTotalPages(filteredInterviews, 'interviews');
            const paginatedData = getPaginatedData(filteredInterviews, 'interviews');
            
            displayRegularInterviews(paginatedData, tbody);
            
            // Add pagination controls
            const existingPagination = container.querySelector('.pagination-controls');
            if (existingPagination) {
                existingPagination.remove();
            }
            
            const paginationHTML = createPaginationControls('interviews');
            if (paginationHTML) {
                container.insertAdjacentHTML('beforeend', paginationHTML);
            }
            
            // Add pagination info
            const existingInfo = container.querySelector('.pagination-info');
            if (existingInfo) {
                existingInfo.remove();
            }
            
            const startIndex = (currentPage['interviews'] - 1) * ITEMS_PER_PAGE + 1;
            const endIndex = Math.min(currentPage['interviews'] * ITEMS_PER_PAGE, filteredInterviews.length);
            const infoHTML = `
                <div class="pagination-info">
                    <span>Showing ${startIndex}-${endIndex} of ${filteredInterviews.length} interviews</span>
                    <span>Page ${currentPage['interviews']} of ${totalPages['interviews']}</span>
                </div>
            `;
            container.insertAdjacentHTML('beforeend', infoHTML);

            // Update sort indicators
            updateSortIndicators('interviews');
            
            // Update the Select All checkbox state after pagination
            updateSelectAllCheckbox();
        }

        // Advanced Filters logic
        const filterFields = [
            { value:'student_name', label:'Student' },
            { value:'zeta_id', label:'Zeta ID' },
            { value:'interviewer_name', label:'Interviewer' },
            { value:'session_name', label:'Session' },
            { value:'status', label:'Status' },
            { value:'verdict', label:'Verdict' },
            { value:'created_at', label:'Date' }
        ];
        const textOps = ['contains','equals','starts_with','ends_with','not_contains','not_equals'];
        const dateOps = ['=','','>','','<','','between','not_between'];
        function addFilterRow(){
            const c = document.getElementById('filters-container'); if (!c) return;
            const isFirst = c.querySelectorAll('.filter-row-adv').length === 0;
            const row = document.createElement('div');
            row.className = 'filter-row-adv';
            row.style.cssText = 'display:flex;gap:8px;align-items:center;flex-wrap:wrap';
            const connectorHtml = isFirst ? '' : `
                <select class=\"filter-connector form-select\" style=\"min-width:90px\">\n                    <option value=\"AND\">AND<\/option>\n                    <option value=\"OR\">OR<\/option>\n                    <option value=\"NOT\">NOT<\/option>\n                <\/select>`;
            row.innerHTML = `
                ${connectorHtml}
                <select class=\"filter-field form-select\" style=\"min-width:140px\">
                    ${filterFields.map(f=>`<option value=\"${f.value}\">${f.label}</option>`).join('')}
                </select>
                <select class=\"filter-op form-select\" style=\"min-width:140px\"></select>
                <input type=\"text\" class=\"filter-value form-input\" placeholder=\"Value\" style=\"min-width:180px\">
                <input type=\"date\" class=\"filter-value2 form-input\" style=\"display:none\">
                <button class=\"btn btn-secondary\" onclick=\"removeFilterRow(this,'filters-container');\">Remove</button>
            `;
            c.appendChild(row);
            bindFilterRow(row);
            updateInterviewsFilterFieldOptions();
            displayInterviews();
        }
        function bindFilterRow(row){
            const fieldSel = row.querySelector('.filter-field');
            const opSel = row.querySelector('.filter-op');
            const v1 = row.querySelector('.filter-value');
            const v2 = row.querySelector('.filter-value2');
            function refreshOps(){
                const f = fieldSel.value;
                const isDate = (f === 'created_at');
                const ops = isDate ? dateOps : textOps;
                opSel.innerHTML = ops.map(o=>`<option value=\"${o}\">${o}</option>`).join('');
                v1.type = isDate ? 'date' : 'text';
                v2.style.display = 'none'; v2.value = '';
                opSel.onchange = ()=>{
                    const op = opSel.value;
                    if (isDate && (op==='between' || op==='not_between')) { v2.style.display='block'; } else { v2.style.display='none'; v2.value=''; }
                    displayInterviews();
                };
            }
            fieldSel.onchange = ()=>{ refreshOps(); updateInterviewsFilterFieldOptions(); displayInterviews(); };
            v1.oninput = ()=> displayInterviews();
            v2.oninput = ()=> displayInterviews();
            const connEl = row.querySelector('.filter-connector');
            if (connEl) connEl.onchange = ()=> displayInterviews();
            refreshOps();
        }
        function clearAdvancedFilters(){ const c=document.getElementById('filters-container'); if(c){ c.innerHTML=''; } displayInterviews(); }
        function removeFilterRow(btn, containerId){ const row = btn.parentElement; row && row.remove(); if (containerId==='filters-container'){ updateInterviewsFilterFieldOptions(); displayInterviews(); } if (containerId==='filters-container-cons'){ updateConsFilterFieldOptions(); loadConsolidation(false); } }
        function normalizeFilterConnectors(containerId){ const c=document.getElementById(containerId); if(!c) return; const rows=Array.from(c.querySelectorAll('.filter-row-adv')); rows.forEach((r,i)=>{ const conn=r.querySelector('.filter-connector'); if(conn){ conn.style.display = i===0 ? 'none' : 'inline-block'; }}); }
        function updateAdvFieldOptions(containerId, fields){ const c=document.getElementById(containerId); if(!c) return; const rows=Array.from(c.querySelectorAll('.filter-row-adv')); const selected = new Set(rows.map(r=> (r.querySelector('.filter-field')?.value)||'')); rows.forEach(r=>{ const sel=r.querySelector('.filter-field'); if(!sel) return; const cur=sel.value; const opts = fields.filter(f=> f.value===cur || !selected.has(f.value)); sel.innerHTML = opts.map(f=>`<option value="${f.value}">${f.label}</option>`).join(''); sel.value = cur; }); normalizeFilterConnectors(containerId); }
        function updateInterviewsFilterFieldOptions(){ updateAdvFieldOptions('filters-container', filterFields); }
        function applyAdvancedFilters(items){
            const c = document.getElementById('filters-container'); if (!c) return items;
            const rows = Array.from(c.querySelectorAll('.filter-row-adv'));
            if (rows.length===0) return items;
            function matchRow(item, row){
                const field = row.querySelector('.filter-field').value;
                const op = row.querySelector('.filter-op').value;
                const v1 = row.querySelector('.filter-value').value;
                const v2 = row.querySelector('.filter-value2').value;
                const valRaw = item[field];
                if (field==='created_at'){
                    const ts = valRaw ? new Date(valRaw).getTime() : 0;
                    const d1 = v1 ? new Date(v1) : null;
                    const t1 = d1 ? (d1.setHours(0,0,0,0), d1.getTime()) : NaN;
                    const d2 = v2 ? new Date(v2) : null;
                    const t2 = d2 ? (d2.setHours(23,59,59,999), d2.getTime()) : NaN;
                    const dayStart = d1 ? t1 : NaN;
                    const dayEnd = d1 ? (new Date(v1)).setHours(23,59,59,999) : NaN;
                    switch(op){
                        case '=': return !isNaN(dayStart) && ts>=dayStart && ts<=dayEnd;
                        case '': return !isNaN(dayStart) && (ts<dayStart || ts>dayEnd);
                        case '>': return ts>t1;
                        case '': return ts>=t1;
                        case '<': return ts<t1;
                        case '': return ts<=t1;
                        case 'between': return !isNaN(t1)&&!isNaN(t2) && ts>=Math.min(t1,t2) && ts<=Math.max(t1,t2);
                        case 'not_between': return !isNaN(t1)&&!isNaN(t2) && (ts<Math.min(t1,t2) || ts>Math.max(t1,t2));
                        default: return true;
                    }
                } else {
                    const val = (valRaw ?? '').toString().trim().toLowerCase();
                    const q = (v1||'').trim().toLowerCase();
                    switch(op){
                        case 'contains': return val.includes(q);
                        case 'equals': return val===q;
                        case 'starts_with': return val.startsWith(q);
                        case 'ends_with': return val.endsWith(q);
                        case 'not_contains': return !val.includes(q);
                        case 'not_equals': return val!==q;
                        default: return true;
                    }
                }
            }
            return items.filter(item=>{
                const rowsEls = Array.from(c.querySelectorAll('.filter-row-adv'));
                let result = true; let first = true;
                for (const row of rowsEls){
                    const connEl = row.querySelector('.filter-connector');
                    const conn = connEl ? connEl.value : 'AND';
                    const m = matchRow(item, row);
                    if (first){ result = m; first=false; continue; }
                    if (conn==='AND') result = result && m;
                    else if (conn==='OR') result = result || m;
                    else if (conn==='NOT') result = result && !m;
                }
                return result;
            });
        }

        // REMOVED: Old conflicting applyFiltersToInterviews function
        // REMOVED: Old conflicting applySortingToInterviews function
        
        function getSortFunction(sortKey) {
            switch (sortKey) {
                case 'created_at_desc':
                    return (a, b) => new Date(b.created_at) - new Date(a.created_at);
                case 'created_at_asc':
                    return (a, b) => new Date(a.created_at) - new Date(b.created_at);
                case 'student_name_asc':
                    return (a, b) => (a.student_name || '').localeCompare(b.student_name || '');
                case 'student_name_desc':
                    return (a, b) => (b.student_name || '').localeCompare(a.student_name || '');
                case 'duration_desc':
                    return (a, b) => (b.duration_seconds || 0) - (a.duration_seconds || 0);
                case 'duration_asc':
                    return (a, b) => (a.duration_seconds || 0) - (b.duration_seconds || 0);
                case 'status_asc':
                    return (a, b) => (a.status || '').localeCompare(b.status || '');
                case 'status_desc':
                    return (a, b) => (b.status || '').localeCompare(a.status || '');
                case 'verdict_asc':
                    return (a, b) => (a.verdict || '').localeCompare(b.verdict || '');
                case 'verdict_desc':
                    return (a, b) => (b.verdict || '').localeCompare(a.verdict || '');
                case 'interviewer_asc':
                    return (a, b) => (a.interviewer_name || '').localeCompare(b.interviewer_name || '');
                case 'interviewer_desc':
                    return (a, b) => (b.interviewer_name || '').localeCompare(a.interviewer_name || '');
                case 'session_asc':
                    return (a, b) => (a.session_name || '').localeCompare(b.session_name || '');
                case 'session_desc':
                    return (a, b) => (b.session_name || '').localeCompare(a.session_name || '');
                default:
                    return null;
            }
        }

        function applyGroupingToInterviews(interviewList) {
            const groupByRadio = document.querySelector('input[name="group-by"]:checked');
            const groupBy = groupByRadio ? groupByRadio.value : '';
            
            if (!groupBy) {
                return { groups: null, interviews: interviewList };
            }
            
            const groups = {};
            
            interviewList.forEach(interview => {
                let groupKey;
                switch (groupBy) {
                    case 'session':
                        groupKey = interview.session_name || 'No Session';
                        break;
                    case 'status':
                        groupKey = interview.status || 'Unknown';
                        break;
                    case 'verdict':
                        groupKey = interview.verdict || 'No Verdict';
                        break;
                    case 'interviewer':
                        groupKey = interview.interviewer_name || 'Unknown';
                        break;
                    case 'date':
                        groupKey = formatDate(interview.interview_date);
                        break;
                    case 'duration':
                        const duration = interview.duration_seconds || 0;
                        const minutes = Math.floor(duration / 60);
                        if (minutes < 5) groupKey = '0-5 minutes';
                        else if (minutes < 15) groupKey = '5-15 minutes';
                        else if (minutes < 30) groupKey = '15-30 minutes';
                        else if (minutes < 60) groupKey = '30-60 minutes';
                        else groupKey = '60+ minutes';
                        break;
                    default:
                        groupKey = 'Other';
                }
                
                if (!groups[groupKey]) {
                    groups[groupKey] = [];
                }
                groups[groupKey].push(interview);
            });
            
            return { groups, interviews: interviewList };
        }

        function displayRegularInterviews(interviewList, tbody, groupBy = '') {
            if (interviewList.length === 0) {
                tbody.innerHTML = '<tr><td colspan="11" class="empty-state">No interviews match the current filters</td></tr>';
                return;
            }

            // Handle grouping if specified
            if (groupBy) {
                const groupedData = groupInterviews(interviewList, groupBy);
                displayGroupedInterviews(groupedData, tbody);
                return;
            }

            tbody.innerHTML = interviewList.map(interview => `
                <tr data-row-id="${interview.id}">
                    <td><input type="checkbox" class="row-checkbox" data-row-id="${interview.id}" ${selectedRows.has(String(interview.id)) ? 'checked' : ''} onchange="toggleRowSelection('${interview.id}')"></td>
                    <td data-field="student_name">${interview.student_name || 'N/A'}</td>
                    <td data-field="interviewer_name">${interview.interviewer_name || 'N/A'}</td>
                    <td data-field="session_name">${interview.session_name || 'N/A'}</td>
                    <td data-field="interview_date">${formatDate(interview.interview_date)}</td>
                    <td data-field="duration_seconds">${formatDuration(interview.duration_seconds)}</td>
                    <td data-field="status"><span class="status-badge status-${interview.status}">${interview.status}</span></td>
                    <td data-field="verdict">${interview.verdict || ''}</td>
                    <td data-field="meeting_url">${interview.meeting_url ? `<a href="${interview.meeting_url}" target="_blank" rel="noopener noreferrer" style="color: #007bff; text-decoration: none;">${interview.meeting_url.length > 40 ? interview.meeting_url.substring(0, 40) + '...' : interview.meeting_url}</a>` : ''}</td>
                    <td>
                        <button class="icon-btn edit-btn" onclick="startEdit('${interview.id}')" title="Edit"><img src="/edit.png" alt="Edit" style="width:16px;height:16px;vertical-align:middle"></button>
                        <button class="icon-btn delete-btn" onclick="deleteInterview('${interview.id}')" title="Delete"><img src="/delete.png" alt="Delete" style="width:16px;height:16px;vertical-align:middle"></button>
                        <button class="icon-btn" onclick="viewInterview(${interview.id})" title="View"><img src="/view.png" alt="View" style="width:16px;height:16px;vertical-align:middle"></button>
                    </td>
                </tr>
            `).join('');
            
            // Attach reliable click handlers for all edit buttons (avoid inline parsing edge cases)
            tbody.addEventListener('click', (e) => {
                const btn = e.target.closest('.edit-btn');
                if (!btn) return;
                e.preventDefault();
                e.stopPropagation();
                const tr = btn.closest('tr');
                const id = tr && tr.getAttribute('data-row-id');
                if (id) startEdit(id);
            });
            
            // Clear any editing state when data is refreshed
            currentEditRow = null;
            currentEditData = null;
            
            // Reinitialize bulk edit controls after data is loaded
            initializeBulkEditControls();
        }

        function displayGroupedInterviews(groupedData, container) {
            const { groups } = groupedData;
            
            let html = '';
            Object.keys(groups).sort().forEach(groupKey => {
                const groupInterviews = groups[groupKey];
                html += `
                    <div class="grouped-table">
                        <div class="group-header">
                            ${groupKey} <span class="group-count">(${groupInterviews.length} interviews)</span>
                        </div>
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Student</th>
                                    <th>Interviewer</th>
                                    <th>Session</th>
                                    <th>Date</th>
                                    <th>Duration</th>
                                    <th>Status</th>
                                    <th>Verdict</th>
                                    <th>URL</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${groupInterviews.map(interview => `
                                    <tr>
                                        <td>${interview.student_name || 'N/A'}</td>
                                        <td>${interview.interviewer_name || 'N/A'}</td>
                                        <td>${interview.session_name || 'N/A'}</td>
                                        <td>${formatDate(interview.interview_date)}</td>
                                        <td>${formatDuration(interview.duration_seconds)}</td>
                                        <td><span class="status-badge status-${interview.status}">${interview.status}</span></td>
                                        <td>${interview.verdict || ''}</td>
                                        <td>${interview.meeting_url ? `<a href="${interview.meeting_url}" target="_blank" rel="noopener noreferrer" style="color: #007bff; text-decoration: none;">${interview.meeting_url.length > 40 ? interview.meeting_url.substring(0, 40) + '...' : interview.meeting_url}</a>` : ''}</td>
                                        <td>
                                            <button class="btn btn-primary" onclick="viewInterview(${interview.id})">View</button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        // Filter, Sort, and Group Functions
        function applyFilters() {
            displayInterviews();
            updateResultsSummary();
        }

        function applySorting() {
            displayInterviews();
        }

        function applyGrouping() {
            displayInterviews();
        }

        function applySearch() {
            displayInterviews();
            updateResultsSummary();
        }
        
        function clearAllFilters() {
            // Clear all filter inputs
            document.getElementById('search-interviews').value = '';
            document.getElementById('status-filter').value = '';
            document.getElementById('session-filter').value = '';
            document.getElementById('verdict-filter').value = '';
            document.getElementById('interviewer-filter').value = '';
            document.getElementById('date-from').value = '';
            document.getElementById('date-to').value = '';
            document.getElementById('duration-min').value = '';
            
            // Reset sorting
            document.getElementById('sort-by').value = 'created_at_desc';
            document.getElementById('sort-by-2').value = '';
            
            // Reset grouping
            document.getElementById('group-none').checked = true;
            
            // Refresh display
            displayInterviews();
            updateResultsSummary();
        }
        
        function updateResultsSummary() {
            const filteredInterviews = applyFiltersToInterviews();
            const summaryElement = document.getElementById('results-summary');
            
            if (summaryElement) {
                summaryElement.innerHTML = `<strong>${filteredInterviews.length}</strong> interviews found`;
                summaryElement.style.display = filteredInterviews.length > 0 ? 'block' : 'none';
            }
        }
        
        function exportInterviews() {
            const filteredInterviews = applyFiltersToInterviews();
            const sortedInterviews = applySortingToInterviews(filteredInterviews);
            
            // Create Excel data (array of arrays)
            const headers = [['ID', 'Student Name', 'Student Email', 'Zeta ID', 'Interviewer', 'Session', 'Status', 'Verdict', 'Duration (min)', 'Date']];
            const rows = sortedInterviews.map(interview => [
                    interview.id,
                interview.student_name || '',
                interview.student_email || '',
                interview.zeta_id || '',
                interview.interviewer_name || '',
                interview.session_name || '',
                interview.status || '',
                interview.verdict || '',
                    Math.floor((interview.duration_seconds || 0) / 60),
                formatDate(interview.interview_date || interview.created_at)
            ]);
            const excelData = [...headers, ...rows];
            
            // Download Excel
            const filename = `interviews_export_${new Date().toISOString().split('T')[0]}.xlsx`;
            downloadExcel(excelData, filename);
        }
        
        function populateInterviewerFilter() {
            const interviewerFilter = document.getElementById('interviewer-filter');
            if (!interviewerFilter) return;
            
            // Clear existing options except "All Interviewers"
            interviewerFilter.innerHTML = '<option value="">All Interviewers</option>';
            
            // Get unique interviewers
            const uniqueInterviewers = [...new Set(interviews.map(interview => interview.interviewer_name).filter(name => name))];
            uniqueInterviewers.sort().forEach(interviewerName => {
                const option = document.createElement('option');
                option.value = interviewerName;
                option.textContent = interviewerName;
                interviewerFilter.appendChild(option);
            });
        }

        // Questions functions
        async function loadQuestions() {
            const tbody = document.getElementById('questions-table-body');
            if (tbody) {
                tbody.innerHTML = '<tr><td colspan="8" class="loading">Loading questions...</td></tr>';
            }
            
            try {
                // Resolve current user email (from URL first, then localStorage)
                const urlParams = new URLSearchParams(window.location.search);
                const urlEmail = urlParams.get('email');
                let email = urlEmail;
                if (!email) {
                    try {
                        const stored = localStorage.getItem('bees_user_data');
                        const data = stored ? JSON.parse(stored) : null;
                        email = data?.email || '';
                    } catch {}
                }

                const [analyticsRes, favRes] = await Promise.all([
                    fetch('/api/admin/questions/analytics'),
                    email ? fetch(`/api/interviewer/favorites?email=${encodeURIComponent(email)}`) : Promise.resolve(null)
                ]);

                const analyticsJson = await analyticsRes.json();
                if (analyticsJson && analyticsJson.success) {
                    questions = analyticsJson.data || [];
                } else {
                    questions = [];
                }

                if (favRes) {
                    try {
                        const favJson = await favRes.json();
                        if (favJson && favJson.success) {
                            favoriteQuestionIds = new Set((favJson.data || []).map(f => f.question_id));
                        }
                    } catch {}
                }

                displayQuestions();
            } catch (error) {
                console.error('Error loading questions:', error);
                questions = [];
                if (tbody) {
                    tbody.innerHTML = '<tr><td colspan="8" class="error">Error loading questions</td></tr>';
                }
            }
        }

        function displayQuestions(questionsData = questions, groupBy = '') {
            const tbody = document.getElementById('questions-table-body');
            const container = document.querySelector('#questions .table-container');
            
            if (!questionsData || questionsData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" class="empty-state">No questions found</td></tr>';
                return;
            }

            // Handle grouping if specified
            if (groupBy) {
                const groupedData = groupQuestions(questionsData, groupBy);
                displayGroupedQuestions(groupedData, tbody);
                return;
            }

            // Inline search + advanced filters + sort
            const term = document.getElementById('questions-inline-search')?.value || '';
            let list = applyInlineSearch(questionsData, term, ['question','question_text','category']);
            list = applyAdvancedFiltersQuestions(list);
            list = applyInlineSort(list, 'questions');
            
            // Check if no results after filtering
            if (list.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" class="empty-state">No matches found for your search or filter criteria</td></tr>';
                // Remove pagination controls and info
                if (container) {
                    const existingPagination = container.querySelector('.pagination-controls');
                    if (existingPagination) existingPagination.remove();
                    const existingInfo = container.querySelector('.pagination-info');
                    if (existingInfo) existingInfo.remove();
                }
                return;
            }
            
            // Update pagination
            updateTotalPages(list, 'questions');
            const paginatedData = getPaginatedData(list, 'questions');

            tbody.innerHTML = paginatedData.map(question => {
                // Debug: Log first question's tags
                if (question === paginatedData[0]) {
                    console.log(' First question tags debug:', {
                        id: question.id,
                        tags: question.tags,
                        tagsType: typeof question.tags,
                        isArray: Array.isArray(question.tags),
                        tagsLength: question.tags?.length,
                        category: question.category
                    });
                }
                
                // Format tags display
                let tagsDisplay = 'N/A';
                if (question.tags && Array.isArray(question.tags) && question.tags.length > 0) {
                    tagsDisplay = question.tags.map(tag => `<span style="display:inline-block;background:#3b82f6;color:#fff;padding:2px 8px;border-radius:12px;font-size:11px;margin:2px">#${tag}</span>`).join(' ');
                } else if (question.category) {
                    tagsDisplay = `<span style="display:inline-block;background:#6b7280;color:#fff;padding:2px 8px;border-radius:12px;font-size:11px;margin:2px">#${question.category}</span>`;
                }
                
                return `
                <tr data-row-id="${question.id}">
                    <td><input type="checkbox" class="row-checkbox" data-row-id="${question.id}" ${selectedRows.has(String(question.id)) ? 'checked' : ''} onchange="toggleRowSelection('${question.id}')"></td>
                    <td data-field="question">${question.question || 'N/A'}</td>
                    <td data-field="tags">${tagsDisplay}</td>
                    <td data-field="times_asked">${question.times_asked || question.count_of_times_asked || 0}</td>
                    <td data-field="average_score">
                        ${Number(question.average_score || 0) > 0 ? `
                            <div style="display:flex;align-items:center;gap:0.5rem">
                                <span style="font-weight:600">${(Number(question.average_score || 0)).toFixed(2)}</span>
                                <span style="display:inline-block;background:${Number(question.average_score || 0) > 8 ? '#10b981' : Number(question.average_score || 0) >= 6 ? '#f59e0b' : '#ef4444'};color:#fff;padding:2px 6px;border-radius:8px;font-size:9px;font-weight:600">${Number(question.average_score || 0) > 8 ? '#easy' : Number(question.average_score || 0) >= 6 ? '#medium' : '#hard'}</span>
                            </div>
                        ` : '-'}
                    </td>
                    <td data-field="success_rate">${Number(question.success_rate || 0)}%</td>
                    <td>
                        <button 
                            class="favorite-btn ${favoriteQuestionIds.has(question.id) ? 'favorited' : ''}"
                            onclick="toggleFavorite(${question.id})"
                            title="${favoriteQuestionIds.has(question.id) ? 'Remove from favorites' : 'Add to favorites'}"
                        >${favoriteQuestionIds.has(question.id) ? '' : ''}</button>
                    </td>
                    <td>
                        <button class="icon-btn edit-btn" onclick="startEdit('${question.id}')" title="Edit"><img src="/edit.png" alt="Edit" style="width:16px;height:16px;vertical-align:middle"></button>
                        <button class="icon-btn delete-btn" onclick="deleteQuestion('${question.id}')" title="Delete"><img src="/delete.png" alt="Delete" style="width:16px;height:16px;vertical-align:middle"></button>
                        <button class="icon-btn" onclick="viewQuestion(${question.id})" title="View"><img src="/view.png" alt="View" style="width:16px;height:16px;vertical-align:middle"></button>
                    </td>
                </tr>
            `;
            }).join('');
            
            // Add pagination controls
            if (container) {
                const existingPagination = container.querySelector('.pagination-controls');
                if (existingPagination) {
                    existingPagination.remove();
                }
                
                const paginationHTML = createPaginationControls('questions');
                if (paginationHTML) {
                    container.insertAdjacentHTML('beforeend', paginationHTML);
                }
                
                // Add pagination info
                const existingInfo = container.querySelector('.pagination-info');
                if (existingInfo) {
                    existingInfo.remove();
                }
                
                const startIndex = (currentPage['questions'] - 1) * ITEMS_PER_PAGE + 1;
            const endIndex = Math.min(currentPage['questions'] * ITEMS_PER_PAGE, list.length);
                const infoHTML = `
                    <div class="pagination-info">
                    <span>Showing ${startIndex}-${endIndex} of ${list.length} questions</span>
                        <span>Page ${currentPage['questions']} of ${totalPages['questions']}</span>
                    </div>
                `;
                container.insertAdjacentHTML('beforeend', infoHTML);

            // Update sort indicators
            updateSortIndicators('questions');
            
            // Update the Select All checkbox state after pagination
            updateSelectAllCheckbox();
            }
            
            // Attach reliable click handlers for all edit buttons (avoid inline parsing edge cases)
            tbody.addEventListener('click', (e) => {
                const btn = e.target.closest('.edit-btn');
                if (!btn) return;
                e.preventDefault();
                e.stopPropagation();
                const tr = btn.closest('tr');
                const id = tr && tr.getAttribute('data-row-id');
                if (id) startEdit(id);
            });
            
            // Clear any editing state when data is refreshed
            currentEditRow = null;
            currentEditData = null;
            
            // Reinitialize bulk edit controls after data is loaded
            initializeBulkEditControls();
        }

        async function toggleFavorite(questionId) {
            try {
                // Resolve current user email
                const urlParams = new URLSearchParams(window.location.search);
                const urlEmail = urlParams.get('email');
                let email = urlEmail;
                if (!email) {
                    try {
                        const stored = localStorage.getItem('bees_user_data');
                        const data = stored ? JSON.parse(stored) : null;
                        email = data?.email || '';
                    } catch {}
                }

                if (!email) {
                    showError('User email not available. Please log in again.');
                    return;
                }

                const isFavorited = favoriteQuestionIds.has(questionId);
                const method = isFavorited ? 'DELETE' : 'POST';
                const res = await fetch(`/api/interviewer/favorites?email=${encodeURIComponent(email)}`, {
                    method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ question_id: questionId })
                });
                const json = await res.json();
                if (!res.ok || json.success === false) throw new Error(json.error || `HTTP ${res.status}`);

                if (isFavorited) favoriteQuestionIds.delete(questionId); else favoriteQuestionIds.add(questionId);

                // Re-render the questions table to update star states
                displayQuestions();
            } catch (e) {
                console.error('Error toggling favorite:', e);
                showError(`Failed to update favorite: ${e.message || 'Unknown error'}`);
            }
        }

        // Sessions functions
        async function loadSessions() {
            const tbody = document.getElementById('sessions-table-body');
            if (tbody) {
                tbody.innerHTML = '<tr><td colspan="10" class="loading">Loading sessions...</td></tr>';
            }
            
            try {
                const response = await fetch('/api/admin/sessions');
                const data = await response.json();
                
                if (data.success) {
                    sessions = data.data;
                    displaySessions();
                    populateSessionFilter();
                } else {
                    if (tbody) {
                        tbody.innerHTML = '<tr><td colspan="10" class="error">Failed to load sessions</td></tr>';
                    }
                }
            } catch (error) {
                console.error('Error loading sessions:', error);
                if (tbody) {
                    tbody.innerHTML = '<tr><td colspan="10" class="error">Error loading sessions</td></tr>';
                }
            }
        }

        function populateSessionFilter() {
            const sessionFilter = document.getElementById('session-filter');
            if (!sessionFilter) return;
            
            // Clear existing options except "All Sessions"
            sessionFilter.innerHTML = '<option value="">All Sessions</option>';
            
            // Filter out inactive sessions and add unique session names
            const activeSessions = sessions.filter(session => session.status === 'active');
            const uniqueSessions = [...new Set(activeSessions.map(session => session.name))];
            uniqueSessions.forEach(sessionName => {
                const option = document.createElement('option');
                option.value = sessionName;
                option.textContent = sessionName;
                sessionFilter.appendChild(option);
            });
        }

        function populateMyInterviewsSessionFilter() {
            const sessionFilter = document.getElementById('my-session-filter');
            if (!sessionFilter) return;
            
            // Clear existing options except "All Sessions"
            sessionFilter.innerHTML = '<option value="">All Sessions</option>';
            
            // Filter out inactive sessions and add unique session names
            const activeSessions = sessions.filter(session => session.status === 'active');
            const uniqueSessions = [...new Set(activeSessions.map(session => session.name))];
            uniqueSessions.forEach(sessionName => {
                const option = document.createElement('option');
                option.value = sessionName;
                option.textContent = sessionName;
                sessionFilter.appendChild(option);
            });
        }

        function displaySessions(sessionsData = sessions, groupBy = '') {
            const tbody = document.getElementById('sessions-table-body');
            
            if (!sessionsData || sessionsData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="10" class="empty-state">No sessions found</td></tr>';
                return;
            }

            // Handle grouping if specified
            if (groupBy) {
                const groupedData = groupSessions(sessionsData, groupBy);
                displayGroupedSessions(groupedData, tbody);
                return;
            }

            // Inline search + advanced filters + sort
            const term = document.getElementById('sessions-inline-search')?.value || '';
            let list = applyInlineSearch(sessionsData, term, ['name','description','status','created_by_name']);
            list = applyAdvancedFiltersSessions(list);
            list = applyInlineSort(list, 'sessions');

            // Check if no results after filtering
            if (list.length === 0) {
                tbody.innerHTML = '<tr><td colspan="10" class="empty-state">No matches found for your search or filter criteria</td></tr>';
                // Remove pagination controls and info
                const container = document.querySelector('#sessions .table-container');
                if (container) {
                    const existingPagination = container.querySelector('.pagination-controls');
                    if (existingPagination) existingPagination.remove();
                    const existingInfo = container.querySelector('.pagination-info');
                    if (existingInfo) existingInfo.remove();
                }
                return;
            }

            // Update pagination
            updateTotalPages(list, 'sessions');
            const paginatedData = getPaginatedData(list, 'sessions');

            tbody.innerHTML = paginatedData.map(session => {
                // Determine the type display based on is_panel value
                const typeDisplay = session.is_panel ? 'Panel' : 'Regular';
                
                // Format panelists: show first 2 emails, then "+X" for the rest
                let panelistsDisplay = '';
                if (session.panelist_names) {
                    const panelistArray = Array.isArray(session.panelist_names) ? session.panelist_names : (session.panelist_names.split ? session.panelist_names.split(',').map(p => p.trim()) : [session.panelist_names]);
                    if (panelistArray.length > 0) {
                        const firstTwo = panelistArray.slice(0, 2);
                        const remaining = panelistArray.length - 2;
                        if (remaining > 0) {
                            panelistsDisplay = firstTwo.join(', ') + ` +${remaining}`;
                        } else {
                            panelistsDisplay = firstTwo.join(', ');
                        }
                    }
                }
                
                return `
                <tr data-row-id="${session.id}">
                    <td><input type="checkbox" class="row-checkbox" data-row-id="${session.id}" ${selectedRows.has(String(session.id)) ? 'checked' : ''} onchange="toggleRowSelection('${session.id}')"></td>
                    <td data-field="name">${session.name}</td>
                    <td data-field="description">${session.description || 'N/A'}</td>
                    <td data-field="is_panel">${typeDisplay}</td>
                    <td data-field="status"><span class="status-badge status-${session.status}">${session.status}</span></td>
                    <td data-field="panelists" style="max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${panelistsDisplay}</td>
                    <td data-field="created_by_name">${session.created_by_name || 'N/A'}</td>
                    <td data-field="created_at">${formatDate(session.created_at)}</td>
                    <td>
                        <button class="icon-btn edit-btn" onclick="startEdit('${session.id}')" title="Edit"><img src="/edit.png" alt="Edit" style="width:16px;height:16px;vertical-align:middle"></button>
                        <button class="icon-btn delete-btn" onclick="deleteSession('${session.id}')" title="Delete"><img src="/delete.png" alt="Delete" style="width:16px;height:16px;vertical-align:middle"></button>
                        <button class="icon-btn" onclick="viewSession(${session.id})" title="View"><img src="/view.png" alt="View" style="width:16px;height:16px;vertical-align:middle"></button>
                        <button class="btn btn-secondary" onclick="viewConsolidationForSession(${session.id})" style="padding: 4px 8px; font-size: 12px; margin-left: 4px;">View Consolidation</button>
                    </td>
                </tr>
                `;
            }).join('');

            // Attach reliable click handlers for all edit buttons (avoid inline parsing edge cases)
            tbody.addEventListener('click', (e) => {
                const btn = e.target.closest('.edit-btn');
                if (!btn) return;
                e.preventDefault();
                e.stopPropagation();
                const tr = btn.closest('tr');
                const id = tr && tr.getAttribute('data-row-id');
                if (id) startEdit(id);
            });
            
            // Clear any editing state when data is refreshed
            currentEditRow = null;
            currentEditData = null;
            
            // Reinitialize bulk edit controls after data is loaded
            initializeBulkEditControls();

            // Update sort indicators
            updateSortIndicators('sessions');
            
            // Update the Select All checkbox state
            updateSelectAllCheckbox();
            
            // Add pagination controls
            const container = document.querySelector('#sessions .table-container');
            if (container) {
                const existingPagination = container.querySelector('.pagination-controls');
                if (existingPagination) {
                    existingPagination.remove();
                }
                
                const paginationHTML = createPaginationControls('sessions');
                if (paginationHTML) {
                    container.insertAdjacentHTML('beforeend', paginationHTML);
                }
                
                // Add pagination info
                const existingInfo = container.querySelector('.pagination-info');
                if (existingInfo) {
                    existingInfo.remove();
                }
                
                const startIndex = (currentPage['sessions'] - 1) * ITEMS_PER_PAGE + 1;
                const endIndex = Math.min(currentPage['sessions'] * ITEMS_PER_PAGE, list.length);
                const infoHTML = `
                    <div class="pagination-info">
                        <span>Showing ${startIndex}-${endIndex} of ${list.length} sessions</span>
                        <span>Page ${currentPage['sessions']} of ${totalPages['sessions']}</span>
                    </div>
                `;
                container.insertAdjacentHTML('beforeend', infoHTML);
            }
        }

        // Students functions
        async function loadStudents() {
            const tbody = document.getElementById('students-table-body');
            if (tbody) {
                tbody.innerHTML = '<tr><td colspan="10" class="loading">Loading students...</td></tr>';
            }
            
            try {
                const response = await fetch('/api/admin/students');
                const data = await response.json();
                
                if (data.success) {
                    students = data.data;
                    displayStudents();
                } else {
                    if (tbody) {
                        tbody.innerHTML = '<tr><td colspan="10" class="error">Failed to load students</td></tr>';
                    }
                }
            } catch (error) {
                console.error('Error loading students:', error);
                if (tbody) {
                    tbody.innerHTML = '<tr><td colspan="10" class="error">Error loading students</td></tr>';
                }
            }
        }

        function displayStudents(studentsData = students, groupBy = '') {
            const tbody = document.getElementById('students-table-body');
            
            if (!studentsData || studentsData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" class="empty-state">No students found</td></tr>';
                return;
            }

            // Handle grouping if specified
            if (groupBy) {
                const groupedData = groupStudents(studentsData, groupBy);
                displayGroupedStudents(groupedData, tbody);
                return;
            }

            // Inline search + advanced filters + sort
            const term = document.getElementById('students-inline-search')?.value || '';
            let list = applyInlineSearch(studentsData, term, ['name','email','zeta_id','phone']);
            list = applyAdvancedFiltersStudents(list);
            list = applyInlineSort(list, 'students');

            // Check if no results after filtering
            if (list.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" class="empty-state">No matches found for your search or filter criteria</td></tr>';
                // Remove pagination controls and info
                const container = document.querySelector('#students .table-container');
                if (container) {
                    const existingPagination = container.querySelector('.pagination-controls');
                    if (existingPagination) existingPagination.remove();
                    const existingInfo = container.querySelector('.pagination-info');
                    if (existingInfo) existingInfo.remove();
                }
                return;
            }

            // Update pagination
            updateTotalPages(list, 'students');
            const paginatedData = getPaginatedData(list, 'students');

            tbody.innerHTML = paginatedData.map(student => {
                // Format verdicts
                let verdictsDisplay = '-';
                if (student.recent_verdicts && student.recent_verdicts.length > 0) {
                    const verdictColors = {
                        'Selected': '#10b981',
                        'Selected+': '#059669',
                        'Hold': '#f59e0b',
                        'Rejected': '#ef4444',
                        'Maybe': '#8b5cf6',
                        'Tiger': '#059669',
                        'Cow': '#ef4444',
                        'Elephant': '#10b981'
                    };
                    // recent_verdicts is an array of verdict strings, not objects
                    verdictsDisplay = student.recent_verdicts.map(verdict => {
                        const color = verdictColors[verdict] || '#6b7280';
                        return `<span style="display:inline-block;background:${color};color:#fff;padding:3px 8px;border-radius:12px;font-size:10px;margin:2px;white-space:nowrap">${verdict}</span>`;
                    }).join(' ');
                }
                
                return `
                    <tr data-row-id="${student.id}">
                        <td><input type="checkbox" class="row-checkbox" data-row-id="${student.id}" ${selectedRows.has(String(student.id)) ? 'checked' : ''} onchange="toggleRowSelection('${student.id}')"></td>
                        <td data-field="name">${student.name}</td>
                        <td data-field="email">${student.email}</td>
                        <td data-field="zeta_id">${student.zeta_id}</td>
                        <td data-field="phone">${student.phone || 'N/A'}</td>
                        <td>${student.school || '-'}</td>
                        <td>${student.location || '-'}</td>
                        <td data-field="verdicts">${verdictsDisplay}</td>
                        <td data-field="created_at">${student.created_at ? formatDate(student.created_at) : '-'}</td>
                        <td>
                            <button class="icon-btn edit-btn" onclick="startEdit('${student.id}')" title="Edit"><img src="/edit.png" alt="Edit" style="width:16px;height:16px;vertical-align:middle"></button>
                            <button class="icon-btn delete-btn" onclick="deleteRecord('${student.id}', 'student')" title="Delete"><img src="/delete.png" alt="Delete" style="width:16px;height:16px;vertical-align:middle"></button>
                            <button class="icon-btn" onclick="viewStudent(${student.id})" title="View"><img src="/view.png" alt="View" style="width:16px;height:16px;vertical-align:middle"></button>
                        </td>
                    </tr>
                `;
            }).join('');
            
            // Attach reliable click handlers for all edit buttons (avoid inline parsing edge cases)
            tbody.addEventListener('click', (e) => {
                const btn = e.target.closest('.edit-btn');
                if (!btn) return;
                e.preventDefault();
                e.stopPropagation();
                const tr = btn.closest('tr');
                const id = tr && tr.getAttribute('data-row-id');
                if (id) startEdit(id);
            });
            
            // Clear any editing state when data is refreshed
            currentEditRow = null;
            currentEditData = null;
            
            // Reinitialize bulk edit controls after data is loaded
            initializeBulkEditControls();

            // Update sort indicators
            updateSortIndicators('students');
            
            // Update the Select All checkbox state
            updateSelectAllCheckbox();
            
            // Add pagination controls
            const container = document.querySelector('#students .table-container');
            if (container) {
                const existingPagination = container.querySelector('.pagination-controls');
                if (existingPagination) {
                    existingPagination.remove();
                }
                
                const paginationHTML = createPaginationControls('students');
                if (paginationHTML) {
                    container.insertAdjacentHTML('beforeend', paginationHTML);
                }
                
                // Add pagination info
                const existingInfo = container.querySelector('.pagination-info');
                if (existingInfo) {
                    existingInfo.remove();
                }
                
                const startIndex = (currentPage['students'] - 1) * ITEMS_PER_PAGE + 1;
                const endIndex = Math.min(currentPage['students'] * ITEMS_PER_PAGE, list.length);
                const infoHTML = `
                    <div class="pagination-info">
                        <span>Showing ${startIndex}-${endIndex} of ${list.length} students</span>
                        <span>Page ${currentPage['students']} of ${totalPages['students']}</span>
                    </div>
                `;
                container.insertAdjacentHTML('beforeend', infoHTML);
            }
        }

        // Modal functions
        async function openCreateSessionModal() {
            document.getElementById('create-session-modal').classList.add('active');
            // Load dropdowns
            await loadLocations();
            await loadSchools();
            await loadExaminationModes();
        }
        
        async function loadLocations() {
            try {
                const response = await fetch('/api/admin/locations');
                const data = await response.json();
                const locationSelect = document.getElementById('session-location');
                if (!locationSelect) return;
                
                locationSelect.innerHTML = '<option value="">Select Location...</option>';
                if (data.success && data.data && data.data.length > 0) {
                    data.data.forEach(location => {
                        const option = document.createElement('option');
                        option.value = location.id;
                        option.textContent = location.location_name;
                        locationSelect.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Error loading locations:', error);
            }
        }
        
        async function loadSchools() {
            try {
                const response = await fetch('/api/admin/schools');
                const data = await response.json();
                const schoolSelect = document.getElementById('session-school');
                if (!schoolSelect) return;
                
                schoolSelect.innerHTML = '<option value="">Select School...</option>';
                if (data.success && data.data && data.data.length > 0) {
                    data.data.forEach(school => {
                        const option = document.createElement('option');
                        option.value = school.id;
                        option.textContent = school.school_name;
                        schoolSelect.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Error loading schools:', error);
            }
        }
        
        async function loadExaminationModes() {
            try {
                const response = await fetch('/api/admin/examination-modes');
                const data = await response.json();
                const modeSelect = document.getElementById('session-examination-mode');
                if (!modeSelect) return;
                
                modeSelect.innerHTML = '<option value="">Select Examination Mode...</option>';
                if (data.success && data.data && data.data.length > 0) {
                    data.data.forEach(mode => {
                        const option = document.createElement('option');
                        option.value = mode.id;
                        option.textContent = mode.mode;
                        modeSelect.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Error loading examination modes:', error);
            }
        }

        function closeCreateSessionModal() {
            document.getElementById('create-session-modal').classList.remove('active');
            document.getElementById('create-session-form').reset();
            selectedPanelists = [];
            updateSelectedPanelistsDisplay();
            document.getElementById('panelist-search-results').style.display = 'none';
        }
        async function createSession() {
            const name = document.getElementById('session-name').value;
            const description = document.getElementById('session-description').value;
            const sessionType = document.getElementById('session-type').value;
            const isPanel = sessionType === 'panel';
            const locationId = document.getElementById('session-location').value || null;
            const schoolId = document.getElementById('session-school').value || null;
            const examinationModeId = document.getElementById('session-examination-mode').value || null;

            // Validate at least one interviewer
            if (selectedPanelists.length === 0) {
                showError('Please select at least one interviewer');
                return;
            }

            try {
                const response = await fetch('/api/admin/sessions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        name: name,
                        description: description,
                        location_id: locationId ? parseInt(locationId) : null,
                        school_id: schoolId ? parseInt(schoolId) : null,
                        examination_mode_id: examinationModeId ? parseInt(examinationModeId) : null,
                        created_by: currentUserId || undefined,
                        is_panel: isPanel,
                        panelists: selectedPanelists
                    })
                });

                const data = await response.json();
                
                if (data.success) {
                    closeCreateSessionModal();
                    loadSessions();
                    showSuccess(`${isPanel ? 'Panel' : 'Regular'} interview session created successfully!`);
                } else {
                    showError('Error creating session: ' + data.error);
                }
            } catch (error) {
                console.error('Error creating session:', error);
                showError('Error creating session');
            }
        }
        
        // Handle session type change
        function handleSessionTypeChange() {
            const sessionType = document.getElementById('session-type').value;
            const panelRequirement = document.getElementById('panel-requirement');
            
            if (sessionType === 'panel') {
                panelRequirement.style.display = 'inline';
            } else {
                panelRequirement.style.display = 'none';
            }
        }

        // Panelist management functions
        async function searchInterviewers() {
            const searchTerm = document.getElementById('panelist-search').value.toLowerCase();
            const resultsContainer = document.getElementById('panelist-search-results');
            
            if (searchTerm.length < 2) {
                resultsContainer.style.display = 'none';
                return;
            }

            try {
                // Load all interviewers if not already loaded
                if (allInterviewers.length === 0) {
                    await loadAllInterviewers();
                }

                // Filter interviewers based on search term
                const filteredInterviewers = allInterviewers.filter(interviewer => 
                    interviewer.name.toLowerCase().includes(searchTerm) ||
                    interviewer.email.toLowerCase().includes(searchTerm)
                );

                // Remove already selected panelists
                const availableInterviewers = filteredInterviewers.filter(interviewer => 
                    !selectedPanelists.some(selected => selected.id === interviewer.id)
                );

                displaySearchResults(availableInterviewers, searchTerm);
            } catch (error) {
                console.error('Error searching interviewers:', error);
            }
        }

        async function loadAllInterviewers() {
            try {
                const response = await fetch('/api/admin/users/interviewers');
                const data = await response.json();
                if (data.success) {
                    allInterviewers = data.data;
                } else {
                    console.error('Error loading interviewers:', data.error);
                    allInterviewers = [];
                }
            } catch (error) {
                console.error('Error loading interviewers:', error);
                allInterviewers = [];
            }
        }
        function displaySearchResults(interviewers, searchTerm) {
            const resultsContainer = document.getElementById('panelist-search-results');
            
            if (interviewers.length === 0) {
                resultsContainer.innerHTML = `
                    <div class="search-result-item">
                        <div class="search-result-info">
                            <div class="search-result-name">No interviewers found</div>
                            <div class="search-result-email">Add "${searchTerm}" as new interviewer</div>
                        </div>
                        <button type="button" class="add-new-interviewer" onclick="event.stopPropagation(); addNewInterviewer('${searchTerm}')">
                            Add New
                        </button>
                    </div>
                `;
            } else {
                resultsContainer.innerHTML = interviewers.map(interviewer => `
                    <div class="search-result-item" onclick="addPanelist(${interviewer.id}, '${interviewer.name.replace(/'/g, "\\'")}', '${interviewer.email.replace(/'/g, "\\'")}')">
                        <div class="search-result-info">
                            <div class="search-result-name">${interviewer.name}</div>
                            <div class="search-result-email">${interviewer.email}</div>
                        </div>
                    </div>
                `).join('');
            }
            
            resultsContainer.style.display = 'block';
        }

        function addPanelist(id, name, email) {
            // Check if already selected
            if (selectedPanelists.some(panelist => panelist.id === id)) {
                return;
            }

            selectedPanelists.push({ id, name, email });
            updateSelectedPanelistsDisplay();
            
            // Clear search
            document.getElementById('panelist-search').value = '';
            document.getElementById('panelist-search-results').style.display = 'none';
        }

        function removePanelist(id) {
            selectedPanelists = selectedPanelists.filter(panelist => panelist.id !== id);
            updateSelectedPanelistsDisplay();
        }

        function updateSelectedPanelistsDisplay() {
            const container = document.getElementById('selected-panelists-list');
            
            if (selectedPanelists.length === 0) {
                container.innerHTML = '<div style="color: #666; font-style: italic;">No panelists selected</div>';
            } else {
                container.innerHTML = selectedPanelists.map(panelist => `
                    <div class="selected-panelist">
                        <span class="selected-panelist-name">${panelist.name}</span>
                        <button type="button" class="remove-panelist" onclick="removePanelist(${panelist.id})" title="Remove panelist"></button>
                    </div>
                `).join('');
            }
        }

        async function addNewInterviewer(email) {
            const normalized = (email || '').trim();
            if (!normalized || !/^[^@\s]+@[^@\s]+\.[^@\s]+$/.test(normalized)) {
                showError('Please provide a valid email to add a new interviewer');
                return;
            }
            const name = normalized.split('@')[0].replace(/[._]/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
            
            try {
                const response = await fetch('/api/admin/users/interviewers', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        name: name,
                        email: normalized,
                        role: 'interviewer'
                    })
                });

                const data = await response.json();
                if (response.ok && data.success) {
                    // Add to master list and selected list but DO NOT submit session here
                    allInterviewers.push(data.data);
                    addPanelist(data.data.id, data.data.name, data.data.email);
                    
                    // Keep modal open, clear search box and results so user can add more
                    const searchInput = document.getElementById('panelist-search');
                    const results = document.getElementById('panelist-search-results');
                    if (searchInput) searchInput.value = '';
                    if (results) results.style.display = 'none';
                    showSuccess('New interviewer added. You can add more or click Create Session.');
                } else {
                    showError('Error adding interviewer: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error adding interviewer:', error);
                showError('Error adding interviewer');
            }
        }

        async function addNewInterviewerFromEdit(rowId) {
            const input = document.getElementById(`new-panelist-email-${rowId}`);
            if (!input) return;
            const email = (input.value || '').trim();
            if (!email) { showError('Please enter an email'); return; }
            await addNewInterviewer(email);
            // Refresh multi-select options by appending the new interviewer if present
            const latest = allInterviewers[allInterviewers.length - 1];
            const select = document.getElementById(`panelist-select-${rowId}`);
            if (latest && select && !Array.from(select.options).some(o => String(o.value) === String(latest.id))) {
                const opt = document.createElement('option');
                opt.value = latest.id;
                opt.textContent = `${latest.name} (${latest.email})`;
                opt.selected = true;
                select.appendChild(opt);
            }
            input.value = '';
        }

        // Store tags for the current question
        let currentQuestionTags = [];

        // Add Question Modal Functions
        async function openAddQuestionModal() {
            document.getElementById('add-question-modal').classList.add('active');
            currentQuestionTags = [];
            
            // Load suggested tags from database
            await loadSuggestedTags();
            
            // Setup tag input functionality
            setupTagInput();
        }

        function closeAddQuestionModal() {
            document.getElementById('add-question-modal').classList.remove('active');
            document.getElementById('add-question-form').reset();
            currentQuestionTags = [];
            // Clear tags display
            const container = document.getElementById('tags-container');
            const input = document.getElementById('question-tags-input');
            container.querySelectorAll('.tag-chip').forEach(chip => chip.remove());
        }

        // Setup tag input with Enter key and click handlers
        function setupTagInput() {
            const input = document.getElementById('question-tags-input');
            const container = document.getElementById('tags-container');
            
            // Remove old listeners
            const newInput = input.cloneNode(true);
            input.replaceWith(newInput);
            
            // Function to add tag from input
            const addTagFromInput = () => {
                const tag = newInput.value.trim();
                if (tag && !currentQuestionTags.includes(tag)) {
                    currentQuestionTags.push(tag);
                    addTagChip(tag);
                    newInput.value = '';
                }
            };
            
            // Add Enter, comma, or space key listener
            newInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' || e.key === ',') {
                    e.preventDefault();
                    addTagFromInput();
                }
            });
            
            // Add tag on blur (when user clicks away)
            newInput.addEventListener('blur', () => {
                addTagFromInput();
            });
            
            // Focus input when clicking container
            container.addEventListener('click', () => {
                newInput.focus();
            });
        }

        // Add a visual tag chip
        function addTagChip(tag) {
            const container = document.getElementById('tags-container');
            const input = document.getElementById('question-tags-input');
            
            const chip = document.createElement('span');
            chip.className = 'tag-chip';
            chip.innerHTML = `
                #${tag}
                <span onclick="removeTag('${tag.replace(/'/g, "\\'")}', this.parentElement)" style="margin-left:6px;cursor:pointer;font-weight:bold">&times;</span>
            `;
            chip.style.cssText = 'display:inline-flex;align-items:center;background:#3b82f6;color:#fff;padding:4px 10px;border-radius:16px;font-size:13px';
            
            container.insertBefore(chip, input);
        }

        // Remove a tag
        window.removeTag = function(tag, chipElement) {
            currentQuestionTags = currentQuestionTags.filter(t => t !== tag);
            chipElement.remove();
        }

        // Load suggested tags from existing questions
        async function loadSuggestedTags() {
            try {
                const response = await fetch('/api/question-bank/tags');
                const result = await response.json();
                
                const suggestedTagsSpan = document.getElementById('suggested-tags');
                if (result.success && result.data && result.data.length > 0) {
                    // Take top 8 most used tags
                    const topTags = result.data.slice(0, 8);
                    suggestedTagsSpan.innerHTML = topTags.map(tagData => {
                        const tagName = typeof tagData === 'string' ? tagData : tagData.tag;
                        return `<span onclick="addSuggestedTag('${tagName.replace(/'/g, "\\'")}' )" style="margin-right:12px;text-decoration:underline;cursor:pointer">#${tagName}</span>`;
                    }).join('');
                } else {
                    suggestedTagsSpan.innerHTML = '<span style="color:#9ca3af">No tags yet</span>';
                }
            } catch (error) {
                console.error('Error loading suggested tags:', error);
                document.getElementById('suggested-tags').innerHTML = '<span style="color:#9ca3af">Unable to load</span>';
            }
        }

        // Add a suggested tag
        window.addSuggestedTag = function(tag) {
            if (!currentQuestionTags.includes(tag)) {
                currentQuestionTags.push(tag);
                addTagChip(tag);
            }
        }

        // Load categories for the modal
        async function loadCategoriesForModal() {
            try {
                const response = await fetch('/api/question-bank/categories');
                const result = await response.json();
                
                const categorySelect = document.getElementById('question-category');
                if (result.success && result.data) {
                    categorySelect.innerHTML = '<option value="">Select Category</option>';
                    result.data.forEach(categoryData => {
                        const categoryName = typeof categoryData === 'string' ? categoryData : categoryData.category;
                        const option = document.createElement('option');
                        option.value = categoryName;
                        option.textContent = categoryName;
                        categorySelect.appendChild(option);
                    });
                } else {
                    categorySelect.innerHTML = '<option value="">No categories found</option>';
                }
            } catch (error) {
                console.error('Error loading categories:', error);
                document.getElementById('question-category').innerHTML = '<option value="">Error loading categories</option>';
            }
        }

        // Add new category
        async function addNewCategory(categoryName) {
            try {
                const response = await fetch('/api/question-bank/categories', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ category: categoryName })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    // Add to dropdown
                    const categorySelect = document.getElementById('question-category');
                    const option = document.createElement('option');
                    option.value = categoryName;
                    option.textContent = categoryName;
                    option.selected = true;
                    categorySelect.appendChild(option);
                    
                    // Hide input
                    document.getElementById('new-category-input').style.display = 'none';
                    document.getElementById('new-category-name').value = '';
                    
                    showSuccess('Category added successfully!');
                } else {
                    showError('Error adding category: ' + (result.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error adding category:', error);
                showError('Error adding category');
            }
        }

        // Prevent multiple submissions
        let isSubmittingQuestion = false;

        async function addQuestion() {
            console.log(' addQuestion called');
            
            if (isSubmittingQuestion) {
                console.log(' Already submitting, ignoring duplicate call');
                return;
            }
            
            isSubmittingQuestion = true;
            
            const questionText = document.getElementById('question-text').value;
            console.log(' Question text:', questionText);
            console.log(' Current tags:', currentQuestionTags);
            
            if (!questionText) {
                console.log(' No question text');
                showError('Please enter the question text');
                isSubmittingQuestion = false;
                return;
            }
            
            if (currentQuestionTags.length === 0) {
                console.log(' No tags');
                showError('Please add at least one tag');
                isSubmittingQuestion = false;
                return;
            }

            try {
                console.log(' Sending request to /api/question-bank');
                const response = await fetch('/api/question-bank', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        question: questionText,
                        tags: currentQuestionTags
                    })
                });

                console.log(' Response status:', response.status);
                
                if (!response.ok) {
                    console.log(' HTTP Error - Status:', response.status);
                    const errorText = await response.text();
                    console.log(' Error response text:', errorText);
                    showError(`Server error (${response.status}): ${errorText}`);
                    return;
                }
                
                const data = await response.json();
                console.log(' Response data:', data);
                console.log(' Response data.success:', data.success);
                console.log(' Response data type:', typeof data.success);
                
                if (data.success === true) {
                    console.log(' Success response - closing modal and refreshing');
                    closeAddQuestionModal();
                    loadQuestions();
                    showSuccess('Question added successfully with tags: ' + currentQuestionTags.map(t => '#' + t).join(' '));
                } else {
                    console.log(' Error response - data.success is:', data.success);
                    console.log(' Error message:', data.error);
                    showError('Error adding question: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                console.error(' Exception in addQuestion:', error);
                showError('Error adding question: ' + error.message);
            } finally {
                isSubmittingQuestion = false;
            }
        }

        function closeQuestionDetailsModal() {
            document.getElementById('question-details-modal').classList.remove('active');
        }

        async function viewQuestionDetails(questionId) {
            try {
                const response = await fetch(`/api/admin/questions/${questionId}/details`);
                const data = await response.json();
                
                if (data.success) {
                    displayQuestionDetails(data.data);
                    document.getElementById('question-details-modal').classList.add('active');
                } else {
                    showError('Error loading question details');
                }
            } catch (error) {
                console.error('Error loading question details:', error);
                showError('Error loading question details');
            }
        }

        function displayQuestionDetails(question) {
            const content = document.getElementById('question-details-content');
            content.innerHTML = `
                <div class="form-group">
                    <label class="form-label">Question</label>
                    <p>${question.question_text}</p>
                </div>
                <div class="form-group">
                    <label class="form-label">Category</label>
                    <p>${question.category || 'N/A'}</p>
                </div>
                <div class="form-group">
                    <label class="form-label">Performance Statistics</label>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-value">${question.times_asked || 0}</div>
                            <div class="stat-label">Times Asked</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">
                                ${Number(question.average_score || 0) > 0 ? `
                                    <div style="display:flex;align-items:center;gap:0.5rem;justify-content:center">
                                        <span>${(Number(question.average_score || 0)).toFixed(2)}</span>
                                        <span style="display:inline-block;background:${Number(question.average_score || 0) > 8 ? '#10b981' : Number(question.average_score || 0) >= 6 ? '#f59e0b' : '#ef4444'};color:#fff;padding:3px 8px;border-radius:8px;font-size:11px;font-weight:600">${Number(question.average_score || 0) > 8 ? '#easy' : Number(question.average_score || 0) >= 6 ? '#medium' : '#hard'}</span>
                                    </div>
                                ` : '-'}
                            </div>
                            <div class="stat-label">Average Score</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${question.total_score || 0}</div>
                            <div class="stat-label">Total Score</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${Number(question.success_rate || 0)}%</div>
                            <div class="stat-label">Success Rate</div>
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Student Performance Breakdown</label>
                    <div class="table-container">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Student</th>
                                    <th>Answer</th>
                                    <th>Correct</th>
                                    <th>Date</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${question.student_answers ? question.student_answers.map(answer => `
                                    <tr>
                                        <td>${answer.student_name}</td>
                                        <td>${answer.answer_text || 'N/A'}</td>
                                        <td>${answer.is_correct ? 'Yes' : 'No'}</td>
                                        <td>${formatDate(answer.answered_at)}</td>
                                    </tr>
                                `).join('') : '<tr><td colspan="4">No answers recorded</td></tr>'}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        // Utility functions
        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            const d = new Date(dateString);
            if (isNaN(d.getTime())) return 'N/A';
            const dd = String(d.getDate()).padStart(2, '0');
            const months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
            const mmm = months[d.getMonth()];
            const yyyy = d.getFullYear();
            return `${dd}/${mmm}/${yyyy}`;
        }

        function formatDuration(seconds) {
            if (!seconds) return 'N/A';
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            const secs = seconds % 60;
            
            if (hours > 0) {
                return `${hours}h ${minutes}m ${secs}s`;
            } else if (minutes > 0) {
                return `${minutes}m ${secs}s`;
            } else {
                return `${secs}s`;
            }
        }

        function showSuccess(message) {
            const overlay = document.createElement('div');
            overlay.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.2);display:flex;align-items:center;justify-content:center;z-index:2000;';
            overlay.innerHTML = `
              <div style="background:#fff;border:1px solid #e5e7eb;border-radius:8px;min-width:300px;max-width:90%;padding:16px;box-shadow:0 10px 20px rgba(0,0,0,0.15)">
                <div style="font-weight:600;margin-bottom:8px;color:#111827">Success</div>
                <div style="font-size:14px;color:#374151;margin-bottom:12px">${message}</div>
                <div style="display:flex;gap:8px;justify-content:flex-end">
                  <button id="succ-ok" style="background:#111827;color:#fff;border:none;padding:6px 10px;border-radius:6px;cursor:pointer">OK</button>
                </div>
              </div>`;
            document.body.appendChild(overlay);
            overlay.querySelector('#succ-ok').onclick = ()=> overlay.remove();
        }

        function showError(message) {
            const overlay = document.createElement('div');
            overlay.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.35);display:flex;align-items:center;justify-content:center;z-index:2000;';
            overlay.innerHTML = `
              <div style="background:#fff;border:1px solid #e5e7eb;border-radius:8px;min-width:300px;max-width:90%;padding:16px;box-shadow:0 10px 20px rgba(0,0,0,0.15)">
                <div style="font-weight:600;margin-bottom:8px;color:#111827">Error</div>
                <div style="font-size:14px;color:#374151;margin-bottom:12px">${message}</div>
                <div style="display:flex;gap:8px;justify-content:flex-end">
                  <button id="err-ok" style="background:#111827;color:#fff;border:none;padding:6px 10px;border-radius:6px;cursor:pointer">OK</button>
                </div>
              </div>`;
            document.body.appendChild(overlay);
            overlay.querySelector('#err-ok').onclick = ()=> overlay.remove();
        }

        // Detail Panel Functions
        function openDetailPanel(title, content) {
            console.log(' openDetailPanel called with title:', title);
            document.getElementById('detail-panel-title').textContent = title;
            document.getElementById('detail-panel-content').innerHTML = content;
            document.getElementById('detail-panel').classList.add('active');
            document.getElementById('panel-overlay').classList.add('active');
            
            // Add event listeners for edit buttons after content is loaded
            setupEditButtonListeners();
            
            console.log(' Detail panel opened successfully');
        }
        
        // Setup event listeners for edit buttons using data attributes
        function setupEditButtonListeners() {
            // Question edit buttons
            document.querySelectorAll('.edit-question-btn').forEach(button => {
                button.removeEventListener('click', handleEditQuestionClick); // Remove existing listeners
                button.addEventListener('click', handleEditQuestionClick);
            });
            
            // Answer edit buttons  
            document.querySelectorAll('.edit-answer-btn').forEach(button => {
                button.removeEventListener('click', handleEditAnswerClick); // Remove existing listeners
                button.addEventListener('click', handleEditAnswerClick);
            });
        }
        
        // Handle question edit button clicks
        function handleEditQuestionClick(event) {
            // Use currentTarget to get the button element, not the clicked child (e.g., img)
            const button = event.currentTarget;
            const questionId = button.getAttribute('data-question-id');
            const questionText = button.getAttribute('data-question-text');
            editQuestionText(questionId, questionText);
        }
        
        // Handle answer edit button clicks
        function handleEditAnswerClick(event) {
            // Use currentTarget to get the button element, not the clicked child (e.g., img)
            const button = event.currentTarget;
            const questionId = button.getAttribute('data-question-id');
            const answerText = button.getAttribute('data-answer-text');
            const answerPhotoUrl = decodeURIComponent(button.getAttribute('data-answer-photo-url') || ''); // Decode URL-encoded value
            console.log(' Edit button clicked, photo URL:', answerPhotoUrl);
            editQuestionAnswer(questionId, answerText, answerPhotoUrl);
        }

        function closeDetailPanel() {
            document.getElementById('detail-panel').classList.remove('active');
            document.getElementById('panel-overlay').classList.remove('active');
        }

        // Filter Panel Functions
        let currentFilterTab = 'interviews'; // Default tab
        
        function toggleFilterPanel(tab = 'interviews') {
            const panel = document.getElementById('filter-panel');
            const overlay = document.getElementById('filter-panel-overlay');
            
            if (panel.classList.contains('active') && currentFilterTab === tab) {
                panel.classList.remove('active');
                overlay.classList.remove('active');
            } else {
                currentFilterTab = tab;
                generateFilterContent(tab);
                
                // Add event listeners to the newly generated filter inputs
                addFilterEventListeners(tab);
                
                panel.classList.add('active');
                overlay.classList.add('active');
            }
        }

        function generateFilterContent(tab) {
            const content = document.querySelector('.filter-panel-content');
            const titles = {
                'interviews': 'All Interviews',
                'questions': 'Questions Analytics',
                'sessions': 'Interview Sessions',
                'students': 'Students',
                'my-interviews': 'My Interviews'
            };
            
            content.innerHTML = `
                <div class="filter-section">
                    <div class="filter-section-title"> Search & Filter</div>
                    <div class="filter-row">
                        ${generateFilterFields(tab)}
                    </div>
                </div>
                
                <div class="sort-section">
                    <div class="filter-section-title"> Sort Options</div>
                    <div class="sort-options">
                        ${generateSortOptions(tab)}
                    </div>
                </div>
                
                <div class="group-by-section">
                    <div class="filter-section-title"> Group By</div>
                    <div class="group-by-options">
                        ${generateGroupByOptions(tab)}
                    </div>
                </div>
                
                <div class="filter-actions">
                    <button class="btn-filter" onclick="applyFilters('${tab}', true)">Apply Filters</button>
                    <button class="btn-clear" onclick="clearAllFilters('${tab}')">Clear All</button>
                    <button class="btn-export" onclick="exportData('${tab}')">Export Data</button>
                </div>
            `;
        }
        function generateFilterFields(tab) {
            const filterConfigs = {
                'interviews': `
                    <div class="filter-group">
                        <label>Search:</label>
                        <input type="text" id="search-interviews" class="form-input" placeholder="Search by student name, email, Zeta ID, or interviewer...">
                    </div>
                    <div class="filter-group">
                        <label>Status:</label>
                        <select id="status-filter" class="form-select">
                            <option value="">All Statuses</option>
                            ${getUniqueValues(interviews, 'status').map(status => `<option value="${status}">${status}</option>`).join('')}
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Verdict:</label>
                        <select id="verdict-filter" class="form-select">
                            <option value="">All Verdicts</option>
                            ${getUniqueValues(interviews, 'verdict').map(verdict => `<option value="${verdict}">${verdict}</option>`).join('')}
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Session:</label>
                        <select id="session-filter" class="form-select">
                            <option value="">All Sessions</option>
                            ${getUniqueValues(interviews, 'session_name').map(name => `<option value="${name}">${name}</option>`).join('')}
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Date From:</label>
                        <input type="date" id="date-from" class="form-input">
                    </div>
                    <div class="filter-group">
                        <label>Date To:</label>
                        <input type="date" id="date-to" class="form-input">
                    </div>
                `,
                'questions': `
                    <div class="filter-group">
                        <label>Search:</label>
                        <input type="text" id="search-questions" class="form-input" placeholder="Search by question text...">
                    </div>
                    <div class="filter-group">
                        <label>Tags:</label>
                        <select id="category-filter" class="form-select">
                            <option value="">All Tags</option>
                            ${getUniqueTags(questions).map(tag => `<option value="${tag}">#${tag}</option>`).join('')}
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Times Asked:</label>
                        <input type="number" id="times-asked-min" class="form-input" placeholder="Min" min="0">
                    </div>
                    <div class="filter-group">
                        <label>Success Rate:</label>
                        <input type="number" id="success-rate-min" class="form-input" placeholder="Min %" min="0" max="100">
                    </div>
                `,
                'sessions': `
                    <div class="filter-group">
                        <label>Search:</label>
                        <input type="text" id="search-sessions" class="form-input" placeholder="Search by session name...">
                    </div>
                    <div class="filter-group">
                        <label>Status:</label>
                        <select id="session-status-filter" class="form-select">
                            <option value="">All Statuses</option>
                            ${getUniqueValues(sessions, 'status').map(status => `<option value="${status}">${status}</option>`).join('')}
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Date From:</label>
                        <input type="date" id="session-date-from" class="form-input">
                    </div>
                    <div class="filter-group">
                        <label>Date To:</label>
                        <input type="date" id="session-date-to" class="form-input">
                    </div>
                `,
                'students': `
                    <div class="filter-group">
                        <label>Search:</label>
                        <input type="text" id="search-students" class="form-input" placeholder="Search by name, email, or Zeta ID...">
                    </div>
                    <div class="filter-group">
                        <label>Zeta ID:</label>
                        <input type="text" id="zeta-id-filter" class="form-input" placeholder="Zeta ID">
                    </div>
                    <div class="filter-group">
                        <label>Email Domain:</label>
                        <input type="text" id="email-domain-filter" class="form-input" placeholder="e.g., gmail.com">
                    </div>
                    <div class="filter-group">
                        <label>Created From:</label>
                        <input type="date" id="student-date-from" class="form-input">
                    </div>
                    <div class="filter-group">
                        <label>Created To:</label>
                        <input type="date" id="student-date-to" class="form-input">
                    </div>
                `,
                'my-interviews': `
                    <div class="filter-group">
                        <label>Search:</label>
                        <input type="text" id="search-my-interviews" class="form-input" placeholder="Search by student name, email, or Zeta ID...">
                    </div>
                    <div class="filter-group">
                        <label>Status:</label>
                        <select id="my-status-filter" class="form-select">
                            <option value="">All Statuses</option>
                            ${getUniqueValues(myInterviews, 'status').map(status => `<option value="${status}">${status}</option>`).join('')}
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Verdict:</label>
                        <select id="my-verdict-filter" class="form-select">
                            <option value="">All Verdicts</option>
                            ${getUniqueValues(myInterviews, 'verdict').map(verdict => `<option value="${verdict}">${verdict}</option>`).join('')}
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Session:</label>
                        <select id="my-session-filter" class="form-select">
                            <option value="">All Sessions</option>
                            ${getUniqueValues(myInterviews, 'session_name').map(name => `<option value="${name}">${name}</option>`).join('')}
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Date From:</label>
                        <input type="date" id="my-date-from" class="form-input">
                    </div>
                    <div class="filter-group">
                        <label>Date To:</label>
                        <input type="date" id="my-date-to" class="form-input">
                    </div>
                `,
                'users': `
                    <div class="filter-group">
                        <label>Search:</label>
                        <input type="text" id="search-users" class="form-input" placeholder="Search by name or email...">
                    </div>
                    <div class="filter-group">
                        <label>Role:</label>
                        <select id="role-filter" class="form-select">
                            <option value="">All Roles</option>
                            ${getUniqueValues(users, 'role').map(role => `<option value="${role}">${role}</option>`).join('')}
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Status:</label>
                        <select id="user-status-filter" class="form-select">
                            <option value="">All Statuses</option>
                            <option value="active">Active</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Created From:</label>
                        <input type="date" id="user-date-from" class="form-input">
                    </div>
                    <div class="filter-group">
                        <label>Created To:</label>
                        <input type="date" id="user-date-to" class="form-input">
                    </div>
                `
            };
            
            return filterConfigs[tab] || '';
        }
        function generateSortOptions(tab) {
            const sortConfigs = {
                'interviews': `
                    <div class="sort-option">
                        <label>Sort by:</label>
                        <select id="sort-by" class="form-select" onchange="applyFilters('interviews')">
                            <option value="created_at_desc">Date (Newest First)</option>
                            <option value="created_at_asc">Date (Oldest First)</option>
                            <option value="student_name_asc">Student Name (A-Z)</option>
                            <option value="student_name_desc">Student Name (Z-A)</option>
                            <option value="student_email_asc">Student Email (A-Z)</option>
                            <option value="student_email_desc">Student Email (Z-A)</option>
                            <option value="zeta_id_asc">Zeta ID (A-Z)</option>
                            <option value="zeta_id_desc">Zeta ID (Z-A)</option>
                            <option value="status_asc">Status (A-Z)</option>
                            <option value="status_desc">Status (Z-A)</option>
                            <option value="verdict_asc">Verdict (A-Z)</option>
                            <option value="verdict_desc">Verdict (Z-A)</option>
                            <option value="interviewer_name_asc">Interviewer (A-Z)</option>
                            <option value="interviewer_name_desc">Interviewer (Z-A)</option>
                        </select>
                    </div>
                `,
                'questions': `
                    <div class="sort-option">
                        <label>Sort by:</label>
                        <select id="sort-by" class="form-select" onchange="applyFilters('questions')">
                            <option value="question_text_asc">Question (A-Z)</option>
                            <option value="question_text_desc">Question (Z-A)</option>
                            <option value="category_asc">Category (A-Z)</option>
                            <option value="category_desc">Category (Z-A)</option>
                            <option value="times_asked_desc">Times Asked (Most)</option>
                            <option value="times_asked_asc">Times Asked (Least)</option>
                            <option value="times_answered_correctly_desc">Correct Answers (Most)</option>
                            <option value="times_answered_correctly_asc">Correct Answers (Least)</option>
                            <option value="times_answered_incorrectly_desc">Incorrect Answers (Most)</option>
                            <option value="times_answered_incorrectly_asc">Incorrect Answers (Least)</option>
                            <option value="success_rate_desc">Success Rate (Highest)</option>
                            <option value="success_rate_asc">Success Rate (Lowest)</option>
                            <option value="created_at_desc">Date Added (Newest)</option>
                            <option value="created_at_asc">Date Added (Oldest)</option>
                        </select>
                    </div>
                `,
                'sessions': `
                    <div class="sort-option">
                        <label>Sort by:</label>
                        <select id="sort-by" class="form-select" onchange="applyFilters('sessions')">
                            <option value="created_at_desc">Date Created (Newest)</option>
                            <option value="created_at_asc">Date Created (Oldest)</option>
                            <option value="name_asc">Session Name (A-Z)</option>
                            <option value="name_desc">Session Name (Z-A)</option>
                            <option value="description_asc">Description (A-Z)</option>
                            <option value="description_desc">Description (Z-A)</option>
                            <option value="status_asc">Status (A-Z)</option>
                            <option value="status_desc">Status (Z-A)</option>
                        </select>
                    </div>
                `,
                'students': `
                    <div class="sort-option">
                        <label>Sort by:</label>
                        <select id="sort-by" class="form-select" onchange="applyFilters('students')">
                            <option value="created_at_desc">Date Created (Newest)</option>
                            <option value="created_at_asc">Date Created (Oldest)</option>
                            <option value="first_name_asc">First Name (A-Z)</option>
                            <option value="first_name_desc">First Name (Z-A)</option>
                            <option value="last_name_asc">Last Name (A-Z)</option>
                            <option value="last_name_desc">Last Name (Z-A)</option>
                            <option value="email_asc">Email (A-Z)</option>
                            <option value="email_desc">Email (Z-A)</option>
                            <option value="zeta_id_asc">Zeta ID (A-Z)</option>
                            <option value="zeta_id_desc">Zeta ID (Z-A)</option>
                            <option value="phone_asc">Phone (A-Z)</option>
                            <option value="phone_desc">Phone (Z-A)</option>
                        </select>
                    </div>
                `,
                'my-interviews': `
                    <div class="sort-option">
                        <label>Sort by:</label>
                        <select id="sort-by" class="form-select" onchange="applyFilters('my-interviews')">
                            <option value="created_at_desc">Date (Newest First)</option>
                            <option value="created_at_asc">Date (Oldest First)</option>
                            <option value="student_name_asc">Student Name (A-Z)</option>
                            <option value="student_name_desc">Student Name (Z-A)</option>
                            <option value="student_email_asc">Student Email (A-Z)</option>
                            <option value="student_email_desc">Student Email (Z-A)</option>
                            <option value="zeta_id_asc">Zeta ID (A-Z)</option>
                            <option value="zeta_id_desc">Zeta ID (Z-A)</option>
                            <option value="status_asc">Status (A-Z)</option>
                            <option value="status_desc">Status (Z-A)</option>
                            <option value="verdict_asc">Verdict (A-Z)</option>
                            <option value="verdict_desc">Verdict (Z-A)</option>
                        </select>
                    </div>
                `,
                'users': `
                    <div class="sort-option">
                        <label>Sort by:</label>
                        <select id="sort-by" class="form-select" onchange="applyFilters('users')">
                            <option value="created_at_desc">Date Created (Newest)</option>
                            <option value="created_at_asc">Date Created (Oldest)</option>
                            <option value="name_asc">Name (A-Z)</option>
                            <option value="name_desc">Name (Z-A)</option>
                            <option value="email_asc">Email (A-Z)</option>
                            <option value="email_desc">Email (Z-A)</option>
                            <option value="role_asc">Role (A-Z)</option>
                            <option value="role_desc">Role (Z-A)</option>
                            <option value="updated_at_desc">Last Updated (Newest)</option>
                            <option value="updated_at_asc">Last Updated (Oldest)</option>
                        </select>
                    </div>
                `
            };
            
            return sortConfigs[tab] || '';
        }

        function generateGroupByOptions(tab) {
            const groupConfigs = {
                'interviews': `
                    <div class="group-by-option">
                        <input type="radio" id="group-none" name="group-by" value="" checked onchange="applyFilters('interviews')">
                        <label for="group-none">No Grouping</label>
                    </div>
                    <div class="group-by-option">
                        <input type="radio" id="group-status" name="group-by" value="status" onchange="applyFilters('interviews')">
                        <label for="group-status">By Status</label>
                    </div>
                    <div class="group-by-option">
                        <input type="radio" id="group-verdict" name="group-by" value="verdict" onchange="applyFilters('interviews')">
                        <label for="group-verdict">By Verdict</label>
                    </div>
                    <div class="group-by-option">
                        <input type="radio" id="group-interviewer" name="group-by" value="interviewer" onchange="applyFilters('interviews')">
                        <label for="group-interviewer">By Interviewer</label>
                    </div>
                    <div class="group-by-option">
                        <input type="radio" id="group-date" name="group-by" value="date" onchange="applyFilters('interviews')">
                        <label for="group-date">By Date</label>
                    </div>
                `,
                'questions': `
                    <div class="group-by-option">
                        <input type="radio" id="group-none" name="group-by" value="" checked onchange="applyFilters('questions')">
                        <label for="group-none">No Grouping</label>
                    </div>
                    <div class="group-by-option">
                        <input type="radio" id="group-category" name="group-by" value="category" onchange="applyFilters('questions')">
                        <label for="group-category">By Category</label>
                    </div>
                    <div class="group-by-option">
                        <input type="radio" id="group-times-asked" name="group-by" value="times_asked" onchange="applyFilters('questions')">
                        <label for="group-times-asked">By Times Asked</label>
                    </div>
                `,
                'sessions': `
                    <div class="group-by-option">
                        <input type="radio" id="group-none" name="group-by" value="" checked onchange="applyFilters('sessions')">
                        <label for="group-none">No Grouping</label>
                    </div>
                `,
                'students': `
                    <div class="group-by-option">
                        <input type="radio" id="group-none" name="group-by" value="" checked onchange="applyFilters('students')">
                        <label for="group-none">No Grouping</label>
                    </div>
                `,
                'my-interviews': `
                    <div class="group-by-option">
                        <input type="radio" id="group-none" name="group-by" value="" checked onchange="applyFilters('my-interviews')">
                        <label for="group-none">No Grouping</label>
                    </div>
                    <div class="group-by-option">
                        <input type="radio" id="group-status" name="group-by" value="status" onchange="applyFilters('my-interviews')">
                        <label for="group-status">By Status</label>
                    </div>
                    <div class="group-by-option">
                        <input type="radio" id="group-verdict" name="group-by" value="verdict" onchange="applyFilters('my-interviews')">
                        <label for="group-verdict">By Verdict</label>
                    </div>
                    <div class="group-by-option">
                        <input type="radio" id="group-date" name="group-by" value="created_date" onchange="applyFilters('my-interviews')">
                        <label for="group-date">By Date</label>
                    </div>
                `,
                'users': `
                    <div class="group-by-option">
                        <input type="radio" id="group-none" name="group-by" value="" checked onchange="applyFilters('users')">
                        <label for="group-none">No Grouping</label>
                    </div>
                    <div class="group-by-option">
                        <input type="radio" id="group-role" name="group-by" value="role" onchange="applyFilters('users')">
                        <label for="group-role">By Role</label>
                    </div>
                    <div class="group-by-option">
                        <input type="radio" id="group-status" name="group-by" value="status" onchange="applyFilters('users')">
                        <label for="group-status">By Status</label>
                    </div>
                    <div class="group-by-option">
                        <input type="radio" id="group-date" name="group-by" value="created_date" onchange="applyFilters('users')">
                        <label for="group-date">By Creation Date</label>
                    </div>
                `
            };
            
            return groupConfigs[tab] || '';
        }

        function closeFilterPanel() {
            document.getElementById('filter-panel').classList.remove('active');
            document.getElementById('filter-panel-overlay').classList.remove('active');
        }

        // Helper function to get unique values from an array of objects
        function getUniqueValues(data, field) {
            if (!data || !Array.isArray(data)) return [];
            const values = data.map(item => item[field]).filter(value => value !== null && value !== undefined && value !== '');
            return [...new Set(values)].sort();
        }

        // Helper function to get unique tags from questions (supports both tags array and category)
        function getUniqueTags(data) {
            if (!data || !Array.isArray(data)) return [];
            const tagsSet = new Set();
            data.forEach(item => {
                if (item.tags && Array.isArray(item.tags)) {
                    item.tags.forEach(tag => tagsSet.add(tag));
                } else if (item.category) {
                    tagsSet.add(item.category);
                }
            });
            return [...tagsSet].sort();
        }

        // Function to populate filter dropdowns with actual database values
        function populateFilterDropdowns() {
            // This function will be called after data is loaded to update filter dropdowns
            // The generateFilterFields function now uses dynamic data
        }

        // Function to add event listeners to filter inputs
        function addFilterEventListeners(tab) {
            // Add event listeners to search inputs
            const searchInputs = document.querySelectorAll('input[type="text"]');
            searchInputs.forEach(input => {
                input.addEventListener('keyup', () => applyFilters(tab));
            });

            // Add event listeners to select dropdowns
            const selectInputs = document.querySelectorAll('select');
            selectInputs.forEach(select => {
                select.addEventListener('change', () => applyFilters(tab));
            });

            // Add event listeners to date inputs
            const dateInputs = document.querySelectorAll('input[type="date"]');
            dateInputs.forEach(input => {
                input.addEventListener('change', () => applyFilters(tab));
            });

            // Add event listeners to number inputs
            const numberInputs = document.querySelectorAll('input[type="number"]');
            numberInputs.forEach(input => {
                input.addEventListener('change', () => applyFilters(tab));
            });

            // Add event listeners to radio buttons
            const radioInputs = document.querySelectorAll('input[type="radio"]');
            radioInputs.forEach(input => {
                input.addEventListener('change', () => applyFilters(tab));
            });
        }

        // NEW UNIFIED FILTER SYSTEM
        function applyUnifiedFilters(tab, data) {
            console.log(`Applying unified filters for tab: ${tab}`);
            
            if (!data || !Array.isArray(data)) {
                console.warn('No data provided for filtering');
                return [];
            }
            
            let filtered = [...data];
            
            // Get filter values safely
            const getFilterValue = (id) => {
                const element = document.getElementById(id);
                return element ? element.value : '';
            };
            
            const getRadioValue = (name) => {
                const element = document.querySelector(`input[name="${name}"]:checked`);
                return element ? element.value : '';
            };
            
            switch(tab) {
                case 'interviews':
                    // Search filter
                    const searchTerm = getFilterValue('search-interviews');
                    if (searchTerm) {
                        filtered = filtered.filter(i => 
                            (i.student_name && i.student_name.toLowerCase().includes(searchTerm.toLowerCase())) ||
                            (i.student_email && i.student_email.toLowerCase().includes(searchTerm.toLowerCase())) ||
                            (i.zeta_id && i.zeta_id.toLowerCase().includes(searchTerm.toLowerCase())) ||
                            (i.interviewer_name && i.interviewer_name.toLowerCase().includes(searchTerm.toLowerCase()))
                        );
                    }
                    
                    // Status filter
                    const status = getFilterValue('status-filter');
                    if (status) {
                        filtered = filtered.filter(i => i.status === status);
                    }
                    
                    // Verdict filter
                    const verdict = getFilterValue('verdict-filter');
                    if (verdict) {
                        filtered = filtered.filter(i => i.verdict === verdict);
                    }

                    // Session filter
                    const sessionName = getFilterValue('session-filter');
                    if (sessionName) {
                        filtered = filtered.filter(i => (i.session_name || '') === sessionName);
                    }
                    
                    // Date filters
                    const dateFrom = getFilterValue('date-from');
                    const dateTo = getFilterValue('date-to');
                    if (dateFrom) {
                        filtered = filtered.filter(i => new Date(i.created_at || i.interview_date) >= new Date(dateFrom));
                    }
                    if (dateTo) {
                        filtered = filtered.filter(i => new Date(i.created_at || i.interview_date) <= new Date(dateTo));
                    }
                    
                    // Sort
                    const sortBy = getFilterValue('sort-by') || 'created_at_desc';
                    filtered = sortInterviews(filtered, sortBy);
                    break;
                    
                case 'questions':
                    // Search filter
                    const questionSearch = getFilterValue('search-questions');
                    if (questionSearch) {
                        filtered = filtered.filter(q => 
                            q.question_text && q.question_text.toLowerCase().includes(questionSearch.toLowerCase())
                        );
                    }
                    
                    // Tag/Category filter (supports both new tags array and legacy category)
                    const category = getFilterValue('category-filter');
                    if (category) {
                        filtered = filtered.filter(q => {
                            // Check tags array first (new system)
                            if (q.tags && Array.isArray(q.tags)) {
                                return q.tags.some(tag => tag.toLowerCase() === category.toLowerCase());
                            }
                            // Fallback to category (legacy)
                            return q.category === category;
                        });
                    }
                    
                    // Times asked filter
                    const timesAskedMin = getFilterValue('times-asked-min');
                    if (timesAskedMin) {
                        filtered = filtered.filter(q => (q.times_asked || 0) >= parseInt(timesAskedMin));
                    }
                    
                    // Success rate filter
                    const successRateMin = getFilterValue('success-rate-min');
                    if (successRateMin) {
                        filtered = filtered.filter(q => (q.success_rate || 0) >= parseInt(successRateMin));
                    }
                    
                    // Sort
                    const questionSortBy = getFilterValue('sort-by') || 'question_text_asc';
                    filtered = sortQuestions(filtered, questionSortBy);
                    break;
                    
                case 'sessions':
                    // Search filter
                    const sessionSearch = getFilterValue('search-sessions');
                    if (sessionSearch) {
                        filtered = filtered.filter(s => 
                            s.session_name && s.session_name.toLowerCase().includes(sessionSearch.toLowerCase())
                        );
                    }
                    
                    // Status filter
                    const sessionStatus = getFilterValue('session-status-filter');
                    if (sessionStatus) {
                        filtered = filtered.filter(s => s.status === sessionStatus);
                    }
                    
                    // Date filters
                    const sessionDateFrom = getFilterValue('session-date-from');
                    const sessionDateTo = getFilterValue('session-date-to');
                    if (sessionDateFrom) {
                        filtered = filtered.filter(s => new Date(s.created_at) >= new Date(sessionDateFrom));
                    }
                    if (sessionDateTo) {
                        filtered = filtered.filter(s => new Date(s.created_at) <= new Date(sessionDateTo));
                    }
                    
                    // Sort
                    const sessionSortBy = getFilterValue('sort-by') || 'created_at_desc';
                    filtered = sortSessions(filtered, sessionSortBy);
                    break;
                    
                case 'students':
                    // Search filter
                    const studentSearch = getFilterValue('search-students');
                    if (studentSearch) {
                        filtered = filtered.filter(s => 
                            (s.first_name && s.first_name.toLowerCase().includes(studentSearch.toLowerCase())) ||
                            (s.last_name && s.last_name.toLowerCase().includes(studentSearch.toLowerCase())) ||
                            (s.email && s.email.toLowerCase().includes(studentSearch.toLowerCase())) ||
                            (s.zeta_id && s.zeta_id.toLowerCase().includes(studentSearch.toLowerCase()))
                        );
                    }
                    
                    // Zeta ID filter
                    const zetaIdFilter = getFilterValue('zeta-id-filter');
                    if (zetaIdFilter) {
                        filtered = filtered.filter(s => (s.zeta_id || '').toLowerCase().includes(zetaIdFilter.toLowerCase()));
                    }

                    // Email domain filter
                    const emailDomainFilter = getFilterValue('email-domain-filter');
                    if (emailDomainFilter) {
                        filtered = filtered.filter(s => (s.email || '').toLowerCase().endsWith(emailDomainFilter.toLowerCase()));
                    }

                    // Date filters
                    const studentDateFrom = getFilterValue('student-date-from');
                    const studentDateTo = getFilterValue('student-date-to');
                    if (studentDateFrom) {
                        filtered = filtered.filter(s => new Date(s.created_at) >= new Date(studentDateFrom));
                    }
                    if (studentDateTo) {
                        filtered = filtered.filter(s => new Date(s.created_at) <= new Date(studentDateTo));
                    }
                    
                    // Sort
                    const studentSortBy = getFilterValue('sort-by') || 'created_at_desc';
                    filtered = sortStudents(filtered, studentSortBy);
                    break;
                    
                case 'my-interviews':
                    // Search filter
                    const mySearchTerm = getFilterValue('search-my-interviews');
                    if (mySearchTerm) {
                        filtered = filtered.filter(i => 
                            (i.student_name && i.student_name.toLowerCase().includes(mySearchTerm.toLowerCase())) ||
                            (i.student_email && i.student_email.toLowerCase().includes(mySearchTerm.toLowerCase())) ||
                            (i.zeta_id && i.zeta_id.toLowerCase().includes(mySearchTerm.toLowerCase()))
                        );
                    }
                    
                    // Status filter
                    const myStatus = getFilterValue('my-status-filter');
                    if (myStatus) {
                        filtered = filtered.filter(i => i.status === myStatus);
                    }
                    
                    // Verdict filter
                    const myVerdict = getFilterValue('my-verdict-filter');
                    if (myVerdict) {
                        filtered = filtered.filter(i => i.verdict === myVerdict);
                    }
                    
                    // Date filters
                    const myDateFrom = getFilterValue('my-date-from');
                    const myDateTo = getFilterValue('my-date-to');
                    if (myDateFrom) {
                        filtered = filtered.filter(i => new Date(i.created_at) >= new Date(myDateFrom));
                    }
                    if (myDateTo) {
                        filtered = filtered.filter(i => new Date(i.created_at) <= new Date(myDateTo));
                    }
                    
                    // Sort
                    const mySortBy = getFilterValue('sort-by') || 'created_at_desc';
                    filtered = sortMyInterviews(filtered, mySortBy);
                    break;
                    
                case 'users':
                    // Search filter
                    const userSearch = getFilterValue('search-users');
                    if (userSearch) {
                        filtered = filtered.filter(u => 
                            (u.name && u.name.toLowerCase().includes(userSearch.toLowerCase())) ||
                            (u.email && u.email.toLowerCase().includes(userSearch.toLowerCase()))
                        );
                    }
                    
                    // Role filter
                    const role = getFilterValue('role-filter');
                    if (role) {
                        filtered = filtered.filter(u => u.role === role);
                    }
                    
                    // Status filter
                    const userStatus = getFilterValue('user-status-filter');
                    if (userStatus) {
                        filtered = filtered.filter(u => u.status === userStatus);
                    }
                    
                    // Date filters
                    const userDateFrom = getFilterValue('user-date-from');
                    const userDateTo = getFilterValue('user-date-to');
                    if (userDateFrom) {
                        filtered = filtered.filter(u => new Date(u.created_at) >= new Date(userDateFrom));
                    }
                    if (userDateTo) {
                        filtered = filtered.filter(u => new Date(u.created_at) <= new Date(userDateTo));
                    }
                    
                    // Sort
                    const userSortBy = getFilterValue('sort-by') || 'created_at_desc';
                    filtered = sortUsers(filtered, userSortBy);
                    break;
            }
            
            return filtered;
        }

        // Dynamic filter functions
        function applyFilters(tab, closePanel = false) {
            console.log(`Applying filters for tab: ${tab}`);
            
            // Get group by value
            const getRadioValue = (name) => {
                const element = document.querySelector(`input[name="${name}"]:checked`);
                return element ? element.value : '';
            };
            const groupBy = getRadioValue('group-by');
            
            // Use the new unified system
            let filteredData = [];
            let displayFunction = null;
            
            switch(tab) {
                case 'interviews':
                    filteredData = applyUnifiedFilters('interviews', interviews);
                    displayFunction = () => displayRegularInterviews(filteredData, document.getElementById('interviews-table-body'), groupBy);
                    break;
                case 'questions':
                    filteredData = applyUnifiedFilters('questions', questions);
                    displayFunction = () => displayQuestions(filteredData, groupBy);
                    break;
                case 'sessions':
                    filteredData = applyUnifiedFilters('sessions', sessions);
                    displayFunction = () => displaySessions(filteredData, groupBy);
                    break;
                case 'students':
                    filteredData = applyUnifiedFilters('students', students);
                    displayFunction = () => displayStudents(filteredData, groupBy);
                    break;
                case 'my-interviews':
                    filteredData = applyUnifiedFilters('my-interviews', myInterviews);
                    displayFunction = () => displayMyInterviews(filteredData, groupBy);
                    break;
                case 'users':
                    filteredData = applyUnifiedFilters('users', users);
                    displayFunction = () => displayUsers(filteredData, groupBy);
                    break;
                default:
                    console.log('Unknown tab:', tab);
                    return;
            }
            
            // Display the filtered results
            if (displayFunction) {
                displayFunction();
            }
            
            // Only close panel if explicitly requested (from Apply button)
            if (closePanel) {
                closeFilterPanel();
            }
        }

        function clearAllFilters(tab) {
            console.log(`Clearing filters for tab: ${tab}`);
            
            // Clear all filter inputs in the current filter panel
            const filterPanel = document.getElementById('filter-panel');
            const inputs = filterPanel.querySelectorAll('input, select');
            inputs.forEach(input => {
                if (input.type === 'radio') {
                    if (input.value === '') {
                        input.checked = true;
                    } else {
                        input.checked = false;
                    }
                } else {
                    input.value = '';
                }
            });
            
            // Apply the cleared filters
            applyFilters(tab);
        }
        function exportData(tab) {
            console.log(`Exporting data for tab: ${tab}`);
            
            switch(tab) {
                case 'interviews':
                    exportInterviews();
                    break;
                case 'questions':
                    exportQuestions();
                    break;
                case 'sessions':
                    exportSessions();
                    break;
                case 'students':
                    exportStudents();
                    break;
                case 'my-interviews':
                    exportMyInterviews();
                    break;
                case 'users':
                    exportUsers();
                    break;
                case 'consolidation':
                    exportConsolidation();
                    break;
                case 'student-sessions':
                    exportStudentSessions();
                    break;
                default:
                    console.log('Unknown tab:', tab);
            }
        }

        // REMOVED: Old conflicting filter functions - replaced with unified system

        // Grouping functions
        function groupQuestions(questions, groupBy) {
            if (!groupBy || groupBy === 'none') {
                return { questions };
            }
            
            const groups = {};
            questions.forEach(question => {
                let groupKey = '';
                switch (groupBy) {
                    case 'category':
                        groupKey = question.category || 'Uncategorized';
                        break;
                    case 'times_asked':
                        const timesAsked = question.times_asked || 0;
                        if (timesAsked === 0) groupKey = 'Never Asked';
                        else if (timesAsked <= 5) groupKey = '1-5 Times';
                        else if (timesAsked <= 10) groupKey = '6-10 Times';
                        else groupKey = '10+ Times';
                        break;
                    default:
                        groupKey = 'All Questions';
                }
                
                if (!groups[groupKey]) {
                    groups[groupKey] = [];
                }
                groups[groupKey].push(question);
            });
            
            return { groups, questions };
        }

        function groupSessions(sessions, groupBy) {
            if (!groupBy || groupBy === 'none') {
                return { sessions };
            }
            
            const groups = {};
            sessions.forEach(session => {
                let groupKey = '';
                switch (groupBy) {
                    case 'status':
                        groupKey = session.status || 'Unknown';
                        break;
                    case 'created_date':
                        groupKey = formatDate(session.created_at);
                        break;
                    default:
                        groupKey = 'All Sessions';
                }
                
                if (!groups[groupKey]) {
                    groups[groupKey] = [];
                }
                groups[groupKey].push(session);
            });
            
            return { groups, sessions };
        }

        function groupStudents(students, groupBy) {
            if (!groupBy || groupBy === 'none') {
                return { students };
            }
            
            const groups = {};
            students.forEach(student => {
                let groupKey = '';
                switch (groupBy) {
                    case 'created_date':
                        groupKey = formatDate(student.created_at);
                        break;
                    default:
                        groupKey = 'All Students';
                }
                
                if (!groups[groupKey]) {
                    groups[groupKey] = [];
                }
                groups[groupKey].push(student);
            });
            
            return { groups, students };
        }

        // Display grouped data functions
        function displayGroupedQuestions(groupedData, tbody) {
            if (groupedData.groups) {
                tbody.innerHTML = Object.entries(groupedData.groups).map(([groupName, groupQuestions]) => `
                    <tr class="group-header">
                        <td colspan="8" class="group-title">${groupName} (${groupQuestions.length})</td>
                    </tr>
                    ${groupQuestions.map(question => generateQuestionRow(question)).join('')}
                `).join('');
            } else {
                tbody.innerHTML = groupedData.questions.map(question => generateQuestionRow(question)).join('');
            }
        }

        function displayGroupedSessions(groupedData, tbody) {
            if (groupedData.groups) {
                tbody.innerHTML = Object.entries(groupedData.groups).map(([groupName, groupSessions]) => `
                    <tr class="group-header">
                        <td colspan="10" class="group-title">${groupName} (${groupSessions.length})</td>
                    </tr>
                    ${groupSessions.map(session => generateSessionRow(session)).join('')}
                `).join('');
            } else {
                tbody.innerHTML = groupedData.sessions.map(session => generateSessionRow(session)).join('');
            }
        }

        function displayGroupedStudents(groupedData, tbody) {
            if (groupedData.groups) {
                tbody.innerHTML = Object.entries(groupedData.groups).map(([groupName, groupStudents]) => `
                    <tr class="group-header">
                        <td colspan="8" class="group-title">${groupName} (${groupStudents.length})</td>
                    </tr>
                    ${groupStudents.map(student => generateStudentRow(student)).join('')}
                `).join('');
            } else {
                tbody.innerHTML = groupedData.students.map(student => generateStudentRow(student)).join('');
            }
        }

        // Helper functions to generate rows
        function generateQuestionRow(question) {
            return `
                <tr data-row-id="${question.id}">
                    <td><input type="checkbox" class="row-checkbox" data-row-id="${question.id}" onchange="toggleRowSelection('${question.id}')"></td>
                    <td data-field="question">
                        <span>${question.question || 'N/A'}</span>
                        <button class="icon-btn edit-btn" onclick="startEdit('${question.id}', 'questions')" title="Edit"></button>
                    </td>
                    <td data-field="category">${question.category || 'N/A'}</td>
                    <td data-field="times_asked">${question.times_asked || 0}</td>
                    <td data-field="times_answered_correctly">${question.times_answered_correctly || 0}</td>
                    <td data-field="times_answered_incorrectly">${question.times_answered_incorrectly || 0}</td>
                    <td data-field="success_rate">${Number(question.success_rate || 0)}%</td>
                    <td>
                        <button class="icon-btn favorite-btn ${favoriteQuestionIds.has(question.id) ? 'favorited' : ''}" 
                                onclick="toggleFavorite('${question.id}')" title="Toggle Favorite">
                            ${favoriteQuestionIds.has(question.id) ? '' : ''}
                        </button>
                        <button class="icon-btn view-btn" onclick="viewQuestion('${question.id}')" title="View"><img src="/view.png" alt="View" style="width:16px;height:16px;vertical-align:middle"></button>
                        <button class="icon-btn delete-btn" onclick="deleteQuestion('${question.id}')" title="Delete"><img src="/delete.png" alt="Delete" style="width:16px;height:16px;vertical-align:middle"></button>
                    </td>
                </tr>
            `;
        }
        function generateSessionRow(session) {
            const typeDisplay = session.is_panel ? 'Panel' : 'Regular';
            
            // Format panelists: show first 2 emails, then "+X" for the rest
            let panelistsDisplay = '';
            if (session.panelist_names) {
                // panelist_names is a comma-separated string of emails
                const panelistArray = session.panelist_names.split(',').map(p => p.trim()).filter(p => p);
                if (panelistArray.length > 0) {
                    const firstTwo = panelistArray.slice(0, 2);
                    const remaining = panelistArray.length - 2;
                    if (remaining > 0) {
                        panelistsDisplay = firstTwo.join(', ') + ` +${remaining}`;
                    } else {
                        panelistsDisplay = firstTwo.join(', ');
                    }
                }
            }
            
            return `
                <tr data-row-id="${session.id}">
                    <td><input type="checkbox" class="row-checkbox" data-row-id="${session.id}" onchange="toggleRowSelection('${session.id}')"></td>
                    <td data-field="name">${session.name}</td>
                    <td data-field="description">${session.description || 'N/A'}</td>
                    <td data-field="is_panel">${typeDisplay}</td>
                    <td data-field="status"><span class="status-badge status-${session.status}">${session.status}</span></td>
                    <td data-field="panelists" style="max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${panelistsDisplay}</td>
                    <td data-field="created_by_name">${session.created_by_name || 'N/A'}</td>
                    <td data-field="created_at">${formatDate(session.created_at)}</td>
                    <td>
                        <button class="icon-btn edit-btn" onclick="startEdit('${session.id}', 'sessions')" title="Edit"><img src="/edit.png" alt="Edit" style="width:16px;height:16px;vertical-align:middle"></button>
                        <button class="icon-btn view-btn" onclick="viewSession('${session.id}')" title="View"><img src="/view.png" alt="View" style="width:16px;height:16px;vertical-align:middle"></button>
                        <button class="icon-btn delete-btn" onclick="deleteSession('${session.id}')" title="Delete"><img src="/delete.png" alt="Delete" style="width:16px;height:16px;vertical-align:middle"></button>
                        <button class="btn btn-secondary" onclick="viewConsolidationForSession(${session.id})" style="padding: 4px 8px; font-size: 12px; margin-left: 4px;">View Consolidation</button>
                    </td>
                </tr>
            `;
        }

        function generateStudentRow(student) {
            return `
                <tr data-row-id="${student.id}">
                    <td><input type="checkbox" class="row-checkbox" data-row-id="${student.id}" onchange="toggleRowSelection(${student.id})"></td>
                    <td data-field="id">${student.id}</td>
                    <td data-field="name">${student.name}</td>
                    <td data-field="email">${student.email}</td>
                    <td data-field="zeta_id">${student.zeta_id}</td>
                    <td data-field="phone">${student.phone || 'N/A'}</td>
                    <td data-field="created_at">${formatDate(student.created_at)}</td>
                    <td>
                        <button class="icon-btn edit-btn" onclick="startEdit('${student.id}', 'students')" title="Edit"><img src="/edit.png" alt="Edit" style="width:16px;height:16px;vertical-align:middle"></button>
                        <button class="icon-btn view-btn" onclick="viewStudent('${student.id}')" title="View"><img src="/view.png" alt="View" style="width:16px;height:16px;vertical-align:middle"></button>
                        <button class="icon-btn delete-btn" onclick="deleteStudent('${student.id}')" title="Delete"><img src="/delete.png" alt="Delete" style="width:16px;height:16px;vertical-align:middle"></button>
                    </td>
                </tr>
            `;
        }

        function sortInterviews(interviews, sortBy) {
            return interviews.sort((a, b) => {
                const [field, direction] = sortBy.split('_');
                let aVal, bVal;
                
                if (field === 'student_name') {
                    aVal = a.student_name;
                    bVal = b.student_name;
                } else if (field === 'created_at') {
                    aVal = new Date(a.created_at);
                    bVal = new Date(b.created_at);
                } else if (field === 'status') {
                    aVal = a.status;
                    bVal = b.status;
                } else if (field === 'verdict') {
                    aVal = a.verdict;
                    bVal = b.verdict;
                } else {
                    aVal = a[field];
                    bVal = b[field];
                }
                
                if (direction === 'asc') {
                    return aVal > bVal ? 1 : -1;
                } else {
                    return aVal < bVal ? 1 : -1;
                }
            });
        }

        function groupInterviews(interviews, groupBy) {
            if (!groupBy) return interviews;
            
            const groups = {};
            interviews.forEach(interview => {
                let key;
                if (groupBy === 'status') {
                    key = interview.status || 'Unknown';
                } else if (groupBy === 'verdict') {
                    key = interview.verdict || 'Unknown';
                } else if (groupBy === 'date') {
                    key = new Date(interview.created_at).toLocaleDateString();
                } else {
                    key = 'All';
                }
                
                if (!groups[key]) {
                    groups[key] = [];
                }
                groups[key].push(interview);
            });
            
            return { groups };
        }

        function applyQuestionsFilters() {
            const searchTerm = document.getElementById('search-questions')?.value || '';
            const category = document.getElementById('category-filter')?.value || '';
            const timesAskedMin = document.getElementById('times-asked-min')?.value || '';
            const successRateMin = document.getElementById('success-rate-min')?.value || '';
            const sortBy = document.getElementById('sort-by')?.value || 'times_asked_desc';
            const groupBy = document.querySelector('input[name="group-by"]:checked')?.value || '';

            console.log('Questions filters:', { searchTerm, category, timesAskedMin, successRateMin, sortBy, groupBy });
            
            // Apply filters to questions data
            let filteredQuestions = [...questions];
            
            // Search filter
            if (searchTerm) {
                filteredQuestions = filteredQuestions.filter(q => 
                    q.question.toLowerCase().includes(searchTerm.toLowerCase())
                );
            }
            
            // Category filter
            if (category) {
                filteredQuestions = filteredQuestions.filter(q => q.category === category);
            }
            
            // Times asked filter
            if (timesAskedMin) {
                filteredQuestions = filteredQuestions.filter(q => q.times_asked >= parseInt(timesAskedMin));
            }
            
            // Success rate filter
            if (successRateMin) {
                filteredQuestions = filteredQuestions.filter(q => q.success_rate >= parseInt(successRateMin));
            }
            
            // Sort
            filteredQuestions = sortQuestions(filteredQuestions, sortBy);
            
            // Display filtered results
            displayQuestions(filteredQuestions, groupBy);
        }

        function applySessionsFilters() {
            const searchTerm = document.getElementById('search-sessions')?.value || '';
            const status = document.getElementById('session-status-filter')?.value || '';
            const dateFrom = document.getElementById('session-date-from')?.value || '';
            const dateTo = document.getElementById('session-date-to')?.value || '';
            const sortBy = document.getElementById('sort-by')?.value || 'created_at_desc';
            const groupBy = document.querySelector('input[name="group-by"]:checked')?.value || '';

            console.log('Sessions filters:', { searchTerm, status, dateFrom, dateTo, sortBy, groupBy });
            
            // Apply filters to sessions data
            let filteredSessions = [...sessions];
            
            // Search filter
            if (searchTerm) {
                filteredSessions = filteredSessions.filter(s => 
                    s.session_name.toLowerCase().includes(searchTerm.toLowerCase())
                );
            }
            
            // Status filter
            if (status) {
                filteredSessions = filteredSessions.filter(s => s.status === status);
            }
            
            // Date filters
            if (dateFrom) {
                filteredSessions = filteredSessions.filter(s => new Date(s.created_at) >= new Date(dateFrom));
            }
            if (dateTo) {
                filteredSessions = filteredSessions.filter(s => new Date(s.created_at) <= new Date(dateTo));
            }
            
            // Sort
            filteredSessions = sortSessions(filteredSessions, sortBy);
            
            // Display filtered results
            displaySessions(filteredSessions, groupBy);
        }

        function applyStudentsFilters() {
            const searchTerm = document.getElementById('search-students')?.value || '';
            const zetaId = document.getElementById('zeta-id-filter')?.value || '';
            const emailDomain = document.getElementById('email-domain-filter')?.value || '';
            const dateFrom = document.getElementById('student-date-from')?.value || '';
            const dateTo = document.getElementById('student-date-to')?.value || '';
            const sortBy = document.getElementById('sort-by')?.value || 'first_name_asc';
            const groupBy = document.querySelector('input[name="group-by"]:checked')?.value || '';

            console.log('Students filters:', { searchTerm, zetaId, emailDomain, dateFrom, dateTo, sortBy, groupBy });
            
            // Apply filters to students data
            let filteredStudents = [...students];
            
            // Search filter
            if (searchTerm) {
                filteredStudents = filteredStudents.filter(s => 
                    s.first_name.toLowerCase().includes(searchTerm.toLowerCase()) ||
                    s.last_name.toLowerCase().includes(searchTerm.toLowerCase()) ||
                    s.email.toLowerCase().includes(searchTerm.toLowerCase()) ||
                    s.zeta_id.toLowerCase().includes(searchTerm.toLowerCase())
                );
            }
            
            // Zeta ID filter
            if (zetaId) {
                filteredStudents = filteredStudents.filter(s => s.zeta_id.toLowerCase().includes(zetaId.toLowerCase()));
            }
            
            // Email domain filter
            if (emailDomain) {
                filteredStudents = filteredStudents.filter(s => s.email.includes(emailDomain));
            }
            
            // Date filters
            if (dateFrom) {
                filteredStudents = filteredStudents.filter(s => new Date(s.created_at) >= new Date(dateFrom));
            }
            if (dateTo) {
                filteredStudents = filteredStudents.filter(s => new Date(s.created_at) <= new Date(dateTo));
            }
            
            // Sort
            filteredStudents = sortStudents(filteredStudents, sortBy);
            
            // Display filtered results
            displayStudents(filteredStudents, groupBy);
        }

        function applyMyInterviewsFilters() {
            const searchTerm = document.getElementById('search-my-interviews')?.value || '';
            const status = document.getElementById('my-status-filter')?.value || '';
            const verdict = document.getElementById('my-verdict-filter')?.value || '';
            const sessionName = document.getElementById('my-session-filter')?.value || '';
            const dateFrom = document.getElementById('my-date-from')?.value || '';
            const dateTo = document.getElementById('my-date-to')?.value || '';
            const sortBy = document.getElementById('sort-by')?.value || 'created_at_desc';
            const groupBy = document.querySelector('input[name="group-by"]:checked')?.value || '';

            console.log('My interviews filters:', { searchTerm, status, verdict, dateFrom, dateTo, sortBy, groupBy });
            
            // Apply filters to my interviews data
            let filteredMyInterviews = [...myInterviews];
            
            // Search filter
            if (searchTerm) {
                filteredMyInterviews = filteredMyInterviews.filter(i => 
                    i.student_name.toLowerCase().includes(searchTerm.toLowerCase()) ||
                    i.student_email.toLowerCase().includes(searchTerm.toLowerCase()) ||
                    i.zeta_id.toLowerCase().includes(searchTerm.toLowerCase())
                );
            }
            
            // Status filter
            if (status) {
                filteredMyInterviews = filteredMyInterviews.filter(i => i.status === status);
            }
            
            // Verdict filter
            if (verdict) {
                filteredMyInterviews = filteredMyInterviews.filter(i => i.verdict === verdict);
            }

            // Session filter
            if (sessionName) {
                filteredMyInterviews = filteredMyInterviews.filter(i => (i.session_name || '') === sessionName);
            }
            
            // Date filters
            if (dateFrom) {
                filteredMyInterviews = filteredMyInterviews.filter(i => new Date(i.created_at) >= new Date(dateFrom));
            }
            if (dateTo) {
                filteredMyInterviews = filteredMyInterviews.filter(i => new Date(i.created_at) <= new Date(dateTo));
            }
            
            // Sort
            filteredMyInterviews = sortMyInterviews(filteredMyInterviews, sortBy);
            
            // Display filtered results
            displayMyInterviews(filteredMyInterviews, groupBy);
        }

        function applyUsersFilters() {
            const searchTerm = document.getElementById('search-users')?.value || '';
            const role = document.getElementById('role-filter')?.value || '';
            const status = document.getElementById('user-status-filter')?.value || '';
            const dateFrom = document.getElementById('user-date-from')?.value || '';
            const dateTo = document.getElementById('user-date-to')?.value || '';
            const sortBy = document.getElementById('sort-by')?.value || 'name_asc';
            const groupBy = document.querySelector('input[name="group-by"]:checked')?.value || '';

            console.log('Users filters:', { searchTerm, role, status, dateFrom, dateTo, sortBy, groupBy });
            
            // Apply filters to users data
            let filteredUsers = [...users];
            
            // Search filter
            if (searchTerm) {
                filteredUsers = filteredUsers.filter(u => 
                    u.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
                    u.email.toLowerCase().includes(searchTerm.toLowerCase())
                );
            }
            
            // Role filter
            if (role) {
                filteredUsers = filteredUsers.filter(u => u.role === role);
            }
            
            // Status filter
            if (status) {
                filteredUsers = filteredUsers.filter(u => u.status === status);
            }
            
            // Date filters
            if (dateFrom) {
                filteredUsers = filteredUsers.filter(u => new Date(u.created_at) >= new Date(dateFrom));
            }
            if (dateTo) {
                filteredUsers = filteredUsers.filter(u => new Date(u.created_at) <= new Date(dateTo));
            }
            
            // Sort
            filteredUsers = sortUsers(filteredUsers, sortBy);
            
            // Display filtered results
            displayUsers(filteredUsers, groupBy);
        }

        // Sorting functions
        function sortQuestions(questions, sortBy) {
            return questions.sort((a, b) => {
                const [field, direction] = sortBy.split('_');
                const aVal = a[field];
                const bVal = b[field];
                
                if (direction === 'asc') {
                    return aVal > bVal ? 1 : -1;
                } else {
                    return aVal < bVal ? 1 : -1;
                }
            });
        }

        function sortSessions(sessions, sortBy) {
            return sessions.sort((a, b) => {
                const [field, direction] = sortBy.split('_');
                let aVal, bVal;
                
                if (field === 'session_name') {
                    aVal = a.session_name;
                    bVal = b.session_name;
                } else {
                    aVal = a[field];
                    bVal = b[field];
                }
                
                if (direction === 'asc') {
                    return aVal > bVal ? 1 : -1;
                } else {
                    return aVal < bVal ? 1 : -1;
                }
            });
        }

        function sortStudents(students, sortBy) {
            return students.sort((a, b) => {
                const [field, direction] = sortBy.split('_');
                let aVal, bVal;
                
                if (field === 'first_name') {
                    aVal = a.first_name;
                    bVal = b.first_name;
                } else if (field === 'last_name') {
                    aVal = a.last_name;
                    bVal = b.last_name;
                } else if (field === 'zeta_id') {
                    aVal = a.zeta_id;
                    bVal = b.zeta_id;
                } else if (field === 'email') {
                    aVal = a.email;
                    bVal = b.email;
                } else {
                    aVal = a[field];
                    bVal = b[field];
                }
                
                if (direction === 'asc') {
                    return aVal > bVal ? 1 : -1;
                } else {
                    return aVal < bVal ? 1 : -1;
                }
            });
        }

        function sortMyInterviews(interviews, sortBy) {
            return interviews.sort((a, b) => {
                const [field, direction] = sortBy.split('_');
                let aVal, bVal;
                
                if (field === 'student_name') {
                    aVal = a.student_name;
                    bVal = b.student_name;
                } else if (field === 'duration') {
                    aVal = a.duration_seconds;
                    bVal = b.duration_seconds;
                } else {
                    aVal = a[field];
                    bVal = b[field];
                }
                
                if (direction === 'asc') {
                    return aVal > bVal ? 1 : -1;
                } else {
                    return aVal < bVal ? 1 : -1;
                }
            });
        }

        function sortUsers(users, sortBy) {
            return users.sort((a, b) => {
                const [field, direction] = sortBy.split('_');
                let aVal, bVal;
                
                if (field === 'name') {
                    aVal = a.name;
                    bVal = b.name;
                } else if (field === 'email') {
                    aVal = a.email;
                    bVal = b.email;
                } else if (field === 'role') {
                    aVal = a.role;
                    bVal = b.role;
                } else if (field === 'status') {
                    aVal = a.status;
                    bVal = b.status;
                } else if (field === 'last_login') {
                    aVal = a.last_login_at;
                    bVal = b.last_login_at;
                } else {
                    aVal = a[field];
                    bVal = b[field];
                }
                
                if (direction === 'asc') {
                    return aVal > bVal ? 1 : -1;
                } else {
                    return aVal < bVal ? 1 : -1;
                }
            });
        }

        // Export functions
        function exportQuestions() {
            const filteredQuestions = getCurrentFilteredQuestions();
            const excelData = generateQuestionsExcel(filteredQuestions);
            downloadExcel(excelData, 'questions.xlsx');
        }

        function exportSessions() {
            const filteredSessions = getCurrentFilteredSessions();
            const excelData = generateSessionsExcel(filteredSessions);
            downloadExcel(excelData, 'sessions.xlsx');
        }

        function exportStudents() {
            const filteredStudents = getCurrentFilteredStudents();
            const excelData = generateStudentsExcel(filteredStudents);
            downloadExcel(excelData, 'students.xlsx');
        }

        function exportMyInterviews() {
            const filteredMyInterviews = getCurrentFilteredMyInterviews();
            const excelData = generateMyInterviewsExcel(filteredMyInterviews);
            downloadExcel(excelData, 'my-interviews.xlsx');
        }

        function exportUsers() {
            const filteredUsers = getCurrentFilteredUsers();
            const excelData = generateUsersExcel(filteredUsers);
            downloadExcel(excelData, 'users.xlsx');
        }

        function exportConsolidation() {
            // Get filtered consolidation data
            let rows = window.__consolidationRows || [];
            rows = applyConsolidationFiltersAndSort(rows);
            rows = applyAdvancedFiltersCons(rows);
            
            const excelData = generateConsolidationExcel(rows);
            const filename = `consolidation_export_${new Date().toISOString().split('T')[0]}.xlsx`;
            downloadExcel(excelData, filename);
        }

        function exportStudentSessions() {
            // Get filtered student sessions data
            const term = document.getElementById('student-sessions-inline-search')?.value || '';
            let list = applyInlineSearch(studentSessions || [], term, ['student_name', 'session_name', 'session_status', 'phone', 'email', 'zeta_id']);
            list = applyAdvancedFiltersStudentSessions(list);
            list = applyInlineSort(list, 'student-sessions');
            
            const excelData = generateStudentSessionsExcel(list);
            const filename = `student_sessions_export_${new Date().toISOString().split('T')[0]}.xlsx`;
            downloadExcel(excelData, filename);
        }

        // Helper functions for getting current filtered data
        function getCurrentFilteredQuestions() {
            // Apply the same filters as displayQuestions
            const questionsData = questions || [];
            const term = document.getElementById('questions-inline-search')?.value || '';
            let list = applyInlineSearch(questionsData, term, ['question','question_text','category']);
            list = applyAdvancedFiltersQuestions(list);
            list = applyInlineSort(list, 'questions');
            return list;
        }

        function getCurrentFilteredSessions() {
            // Apply the same filters as displaySessions
            const sessionsData = sessions || [];
            const term = document.getElementById('sessions-inline-search')?.value || '';
            let list = applyInlineSearch(sessionsData, term, ['name','description','status','created_by_name']);
            list = applyAdvancedFiltersSessions(list);
            list = applyInlineSort(list, 'sessions');
            return list;
        }

        function getCurrentFilteredStudents() {
            // Apply the same filters as displayStudents
            const studentsData = students || [];
            const term = document.getElementById('students-inline-search')?.value || '';
            let list = applyInlineSearch(studentsData, term, ['name','email','zeta_id','phone']);
            list = applyAdvancedFiltersStudents(list);
            list = applyInlineSort(list, 'students');
            return list;
        }

        function getCurrentFilteredMyInterviews() {
            // Apply the same filters as displayMyInterviews
            const interviewsData = myInterviews || [];
            const term = document.getElementById('my-interviews-inline-search')?.value || '';
            let list = applyInlineSearch(interviewsData, term, ['student_name','student_email','zeta_id','session_name','status','verdict']);
            list = applyAdvancedFiltersMyInterviews(list);
            list = applyInlineSort(list, 'my-interviews');
            return list;
        }

        function getCurrentFilteredUsers() {
            // Apply the same filters as displayUsers
            const usersData = users || [];
            const term = document.getElementById('users-inline-search')?.value || '';
            let list = applyInlineSearch(usersData, term, ['name','email','role','status']);
            list = applyAdvancedFiltersUsers(list);
            list = applyInlineSort(list, 'users');
            return list;
        }

        // CSV generation functions
        function generateQuestionsCSV(questions) {
            const headers = ['Question', 'Category', 'Times Asked', 'Correct Answers', 'Incorrect Answers', 'Success Rate', 'Created At'];
            const rows = questions.map(q => [
                `"${q.question.replace(/"/g, '""')}"`,
                q.category,
                q.times_asked,
                q.correct_answers,
                q.incorrect_answers,
                q.success_rate,
                new Date(q.created_at).toLocaleDateString()
            ]);
            return [headers.join(','), ...rows.map(row => row.join(','))].join('\n');
        }

        function generateSessionsCSV(sessions) {
            const headers = ['Session Name', 'Status', 'Created At', 'Panelists'];
            const rows = sessions.map(s => [
                `"${s.session_name.replace(/"/g, '""')}"`,
                s.status,
                new Date(s.created_at).toLocaleDateString(),
                s.panelists ? s.panelists.join('; ') : ''
            ]);
            return [headers.join(','), ...rows.map(row => row.join(','))].join('\n');
        }

        function generateStudentsCSV(students) {
            const headers = ['First Name', 'Last Name', 'Zeta ID', 'Email', 'Phone', 'Address', 'Created At'];
            const rows = students.map(s => [
                `"${s.first_name.replace(/"/g, '""')}"`,
                `"${s.last_name.replace(/"/g, '""')}"`,
                s.zeta_id,
                s.email,
                s.phone || '',
                `"${(s.address || '').replace(/"/g, '""')}"`,
                new Date(s.created_at).toLocaleDateString()
            ]);
            return [headers.join(','), ...rows.map(row => row.join(','))].join('\n');
        }

        function generateMyInterviewsCSV(interviews) {
            const headers = ['Date', 'Student Name', 'Zeta ID', 'Session', 'Status', 'Verdict', 'Duration (min)'];
            const rows = interviews.map(i => [
                new Date(i.created_at).toLocaleDateString(),
                `"${i.student_name.replace(/"/g, '""')}"`,
                i.zeta_id,
                i.session_name || 'N/A',
                i.status,
                i.verdict || '',
                Math.round(i.duration_seconds / 60)
            ]);
            return [headers.join(','), ...rows.map(row => row.join(','))].join('\n');
        }

        function generateUsersCSV(users) {
            const headers = ['Name', 'Email', 'Role', 'Status', 'Created At', 'Last Login'];
            const rows = users.map(u => [
                `"${u.name.replace(/"/g, '""')}"`,
                u.email,
                u.role,
                u.status,
                new Date(u.created_at).toLocaleDateString(),
                u.last_login_at ? new Date(u.last_login_at).toLocaleDateString() : 'Never'
            ]);
            return [headers.join(','), ...rows.map(row => row.join(','))].join('\n');
        }

        function generateConsolidationCSV(rows) {
            const headers = ['Student Name', 'Zeta ID', 'Session', 'Interviewers', 'Verdicts', 'Score', 'Interview Status', 'Status', 'Notes', 'Last Interview'];
            const csvRows = rows.map(row => [
                `"${(row.student_name || '').replace(/"/g, '""')}"`,
                `"${(row.zeta_id || '').replace(/"/g, '""')}"`,
                `"${(row.session_name || '').replace(/"/g, '""')}"`,
                `"${((row.interviewer_names || []).join(', ') || '').replace(/"/g, '""')}"`,
                `"${((row.verdicts || []).join(', ') || '').replace(/"/g, '""')}"`,
                row.total_score || '',
                `"${((row.interview_statuses || []).join(', ') || '').replace(/"/g, '""')}"`,
                `"${(row.status || '').replace(/"/g, '""')}"`,
                `"${(row.notes || '').replace(/"/g, '""')}"`,
                row.last_interview_at ? new Date(row.last_interview_at).toLocaleDateString() : ''
            ]);
            return [headers.join(','), ...csvRows.map(row => row.join(','))].join('\n');
        }

        function generateStudentSessionsCSV(sessions) {
            const headers = ['Student Name', 'Phone', 'Email', 'Zeta ID', 'Interview Session', 'Interview Status', 'Score'];
            const csvRows = sessions.map(s => [
                `"${(s.student_name || '').replace(/"/g, '""')}"`,
                `"${(s.phone || '').replace(/"/g, '""')}"`,
                `"${(s.email || '').replace(/"/g, '""')}"`,
                `"${(s.zeta_id || '').replace(/"/g, '""')}"`,
                `"${(s.session_name || '').replace(/"/g, '""')}"`,
                `"${(s.session_status || '').replace(/"/g, '""')}"`,
                s.total_score || ''
            ]);
            return [headers.join(','), ...csvRows.map(row => row.join(','))].join('\n');
        }

        // Excel generation functions (returns array of arrays for SheetJS)
        function generateQuestionsExcel(questions) {
            const headers = [['Question', 'Category', 'Times Asked', 'Correct Answers', 'Incorrect Answers', 'Success Rate', 'Created At']];
            const rows = questions.map(q => [
                q.question || '',
                q.category || '',
                q.times_asked || 0,
                q.correct_answers || 0,
                q.incorrect_answers || 0,
                q.success_rate || 0,
                q.created_at ? new Date(q.created_at).toLocaleDateString() : ''
            ]);
            return [...headers, ...rows];
        }

        function generateSessionsExcel(sessions) {
            const headers = [['Session Name', 'Status', 'Created At', 'Panelists']];
            const rows = sessions.map(s => [
                s.session_name || '',
                s.status || '',
                s.created_at ? new Date(s.created_at).toLocaleDateString() : '',
                s.panelists ? s.panelists.join('; ') : ''
            ]);
            return [...headers, ...rows];
        }

        function generateStudentsExcel(students) {
            const headers = [['First Name', 'Last Name', 'Zeta ID', 'Email', 'Phone', 'Address', 'Created At']];
            const rows = students.map(s => [
                s.first_name || '',
                s.last_name || '',
                s.zeta_id || '',
                s.email || '',
                s.phone || '',
                s.address || '',
                s.created_at ? new Date(s.created_at).toLocaleDateString() : ''
            ]);
            return [...headers, ...rows];
        }

        function generateMyInterviewsExcel(interviews) {
            const headers = [['Date', 'Student Name', 'Zeta ID', 'Session', 'Status', 'Verdict', 'Duration (min)']];
            const rows = interviews.map(i => [
                i.created_at ? new Date(i.created_at).toLocaleDateString() : '',
                i.student_name || '',
                i.zeta_id || '',
                i.session_name || 'N/A',
                i.status || '',
                i.verdict || '',
                i.duration_seconds ? Math.round(i.duration_seconds / 60) : 0
            ]);
            return [...headers, ...rows];
        }

        function generateUsersExcel(users) {
            const headers = [['Name', 'Email', 'Role', 'Status', 'Created At', 'Last Login']];
            const rows = users.map(u => [
                u.name || '',
                u.email || '',
                u.role || '',
                u.status || '',
                u.created_at ? new Date(u.created_at).toLocaleDateString() : '',
                u.last_login_at ? new Date(u.last_login_at).toLocaleDateString() : 'Never'
            ]);
            return [...headers, ...rows];
        }

        function generateConsolidationExcel(rows) {
            // Find the maximum number of interviewers across all rows
            let maxInterviewers = 0;
            rows.forEach(row => {
                const interviewerCount = (row.interviewer_names || []).length;
                const verdictCount = (row.verdicts || []).length;
                const maxCount = Math.max(interviewerCount, verdictCount);
                if (maxCount > maxInterviewers) {
                    maxInterviewers = maxCount;
                }
            });
            
            // Build dynamic headers: Student Name, Zeta ID, Session, Interviewer 1, Verdict 1, Score, Notes 1, Interviewer 2, Verdict 2, Score, Notes 2, etc.
            const baseHeaders = ['Student Name', 'Zeta ID', 'Session'];
            const interviewerHeaders = [];
            for (let i = 1; i <= maxInterviewers; i++) {
                interviewerHeaders.push(`Interviewer ${i}`, `Verdict ${i}`, `Score ${i}`, `Notes ${i} (comments)`);
            }
            const remainingHeaders = ['Status', 'Last Interview'];
            const headers = [[...baseHeaders, ...interviewerHeaders, ...remainingHeaders]];
            
            // Build rows with interviewer-verdict-score-notes groups in separate columns
            const excelRows = rows.map(row => {
                const baseData = [
                    row.student_name || '',
                    row.zeta_id || '',
                    row.session_name || ''
                ];
                
                const interviewerNames = row.interviewer_names || [];
                const verdicts = row.verdicts || [];
                const interviewScores = row.interview_scores || [];
                const interviewNotes = row.interview_notes || [];
                
                // Add interviewer-verdict-score-notes groups
                const groupData = [];
                for (let i = 0; i < maxInterviewers; i++) {
                    groupData.push(
                        interviewerNames[i] || '',
                        verdicts[i] || '',
                        interviewScores[i] !== undefined ? interviewScores[i] : '',
                        interviewNotes[i] || ''
                    );
                }
                
                const remainingData = [
                    row.status || '',
                    row.last_interview_at ? new Date(row.last_interview_at).toLocaleDateString() : ''
                ];
                
                return [...baseData, ...groupData, ...remainingData];
            });
            
            return [...headers, ...excelRows];
        }

        function generateStudentSessionsExcel(sessions) {
            const headers = [['Student Name', 'Phone', 'Email', 'Zeta ID', 'Interview Session', 'Interview Status', 'Score']];
            const excelRows = sessions.map(s => [
                s.student_name || '',
                s.phone || '',
                s.email || '',
                s.zeta_id || '',
                s.session_name || '',
                s.session_status || '',
                s.total_score || ''
            ]);
            return [...headers, ...excelRows];
        }

        // User Action Menu Functions
        function toggleUserMenu(userId) {
            // Close all other menus first
            document.querySelectorAll('.user-action-menu').forEach(menu => {
                if (menu.id !== `user-menu-${userId}`) {
                    menu.classList.add('hidden');
                }
            });
            
            // Toggle current menu
            const menu = document.getElementById(`user-menu-${userId}`);
            if (menu) {
                menu.classList.toggle('hidden');
            }
        }

        // Close menus when clicking outside
        document.addEventListener('click', function(event) {
            if (!event.target.closest('.action-menu-container')) {
                document.querySelectorAll('.user-action-menu').forEach(menu => {
                    menu.classList.add('hidden');
                });
            }
        });
        async function promoteToAdmin(userId) {
            // CRITICAL DEBUG: Log everything about the user ID
            console.log(' promoteToAdmin called');
            console.log('   userId parameter:', userId);
            console.log('   userId type:', typeof userId);
            console.log('   userId value:', JSON.stringify(userId));
            
            // Find the user in our loaded users array
            const user = users.find(u => u.id === userId || u.id === parseInt(userId));
            console.log('   User found in array:', user);
            
            const proceed = await new Promise(resolve => {
                const overlay = document.createElement('div');
                overlay.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.35);display:flex;align-items:center;justify-content:center;z-index:2000;';
                overlay.innerHTML = `
                  <div style="background:#fff;border:1px solid #e5e7eb;border-radius:8px;min-width:300px;max-width:90%;padding:16px;box-shadow:0 10px 20px rgba(0,0,0,0.15)">
                    <div style="font-weight:600;margin-bottom:8px;color:#111827">Promote to Admin?</div>
                    <div style="font-size:14px;color:#374151;margin-bottom:12px">Are you sure you want to promote ${user ? user.name : 'this user'} (ID: ${userId}) to Admin role?</div>
                    <div style="display:flex;gap:8px;justify-content:flex-end">
                      <button id="promote-cancel" style="border:1px solid #e5e7eb;background:#fff;padding:6px 10px;border-radius:6px;cursor:pointer">Cancel</button>
                      <button id="promote-confirm" style="background:#059669;color:#fff;border:none;padding:6px 10px;border-radius:6px;cursor:pointer">Promote</button>
                    </div>
                  </div>`;
                document.body.appendChild(overlay);
                overlay.querySelector('#promote-cancel').onclick = ()=> { overlay.remove(); resolve(false); };
                overlay.querySelector('#promote-confirm').onclick = ()=> { overlay.remove(); resolve(true); };
            });
            
            if (!proceed) return;

            try {
                console.log(' Promoting user to Admin:', userId);
                console.log('   Making request to:', `/api/authorized-users/${userId}`);
                
                const response = await fetch(`/api/authorized-users/${userId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ role: 'admin', is_superadmin: false })
                });
                
                console.log(' Response status:', response.status);
                const result = await response.json();
                console.log(' Response data:', result);
                
                if (response.ok && result.success) {
                    showSuccess('User promoted to Admin successfully');
                    loadUsers(); // Refresh the users list
                } else {
                    const errorMsg = result.message || result.error || 'Failed to promote user';
                    console.error(' Promotion failed:', errorMsg);
                    showError(errorMsg);
                }
            } catch (error) {
                console.error(' Error promoting user:', error);
                showError('Error promoting user: ' + error.message);
            }
        }

        async function promoteToSuperAdmin(userId) {
            const proceed = await new Promise(resolve => {
                const overlay = document.createElement('div');
                overlay.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.35);display:flex;align-items:center;justify-content:center;z-index:2000;';
                overlay.innerHTML = `
                  <div style="background:#fff;border:1px solid #e5e7eb;border-radius:8px;min-width:300px;max-width:90%;padding:16px;box-shadow:0 10px 20px rgba(0,0,0,0.15)">
                    <div style="font-weight:600;margin-bottom:8px;color:#111827">Promote to Super Admin?</div>
                    <div style="font-size:14px;color:#374151;margin-bottom:12px">Are you sure you want to promote this user to Super Admin role? This gives them full system access.</div>
                    <div style="display:flex;gap:8px;justify-content:flex-end">
                      <button id="super-promote-cancel" style="border:1px solid #e5e7eb;background:#fff;padding:6px 10px;border-radius:6px;cursor:pointer">Cancel</button>
                      <button id="super-promote-confirm" style="background:#dc2626;color:#fff;border:none;padding:6px 10px;border-radius:6px;cursor:pointer">Promote</button>
                    </div>
                  </div>`;
                document.body.appendChild(overlay);
                overlay.querySelector('#super-promote-cancel').onclick = ()=> { overlay.remove(); resolve(false); };
                overlay.querySelector('#super-promote-confirm').onclick = ()=> { overlay.remove(); resolve(true); };
            });
            
            if (!proceed) return;

            try {
                console.log(' Promoting user to Super Admin:', userId);
                
                const response = await fetch(`/api/authorized-users/${userId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ role: 'superadmin', is_superadmin: true })
                });
                
                console.log(' Response status:', response.status);
                const result = await response.json();
                console.log(' Response data:', result);
                
                if (response.ok && result.success) {
                    showSuccess('User promoted to Super Admin successfully');
                    loadUsers(); // Refresh the users list
                } else {
                    const errorMsg = result.message || result.error || 'Failed to promote user';
                    console.error(' Promotion failed:', errorMsg);
                    showError(errorMsg);
                }
            } catch (error) {
                console.error(' Error promoting user:', error);
                showError('Error promoting user: ' + error.message);
            }
        }

        async function deactivateUser(userId) {
            const proceed = await new Promise(resolve => {
                const overlay = document.createElement('div');
                overlay.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.35);display:flex;align-items:center;justify-content:center;z-index:2000;';
                overlay.innerHTML = `
                  <div style="background:#fff;border:1px solid #e5e7eb;border-radius:8px;min-width:300px;max-width:90%;padding:16px;box-shadow:0 10px 20px rgba(0,0,0,0.15)">
                    <div style="font-weight:600;margin-bottom:8px;color:#111827">Deactivate User?</div>
                    <div style="font-size:14px;color:#374151;margin-bottom:12px">Are you sure you want to deactivate this user? They will not be able to access the system.</div>
                    <div style="display:flex;gap:8px;justify-content:flex-end">
                      <button id="deactivate-cancel" style="border:1px solid #e5e7eb;background:#fff;padding:6px 10px;border-radius:6px;cursor:pointer">Cancel</button>
                      <button id="deactivate-confirm" style="background:#dc2626;color:#fff;border:none;padding:6px 10px;border-radius:6px;cursor:pointer">Deactivate</button>
                    </div>
                  </div>`;
                document.body.appendChild(overlay);
                overlay.querySelector('#deactivate-cancel').onclick = ()=> { overlay.remove(); resolve(false); };
                overlay.querySelector('#deactivate-confirm').onclick = ()=> { overlay.remove(); resolve(true); };
            });
            
            if (!proceed) return;

            try {
                const response = await fetch(`/api/authorized-users/${userId}`, {
                    method: 'DELETE'
                });
                
                const result = await response.json();
                if (result.success) {
                    showSuccess('User removed from authorized users successfully');
                    loadUsers(); // Refresh the users list
                } else {
                    showError(result.message || 'Failed to remove user');
                }
            } catch (error) {
                console.error('Error removing user:', error);
                showError('Error removing user');
            }
        }

        function downloadCSV(content, filename) {
            const blob = new Blob([content], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function downloadExcel(data, filename) {
            // Check if SheetJS is available
            if (typeof XLSX === 'undefined') {
                console.warn('SheetJS library not loaded. Falling back to CSV format.');
                // Fallback to CSV with proper escaping
                const csvContent = convertToCSV(data);
                const csvFilename = filename.replace(/\.(xlsx|xls)$/i, '') + '.csv';
                downloadCSV(csvContent, csvFilename);
                return;
            }

            try {
                // Create workbook and worksheet
                const ws = XLSX.utils.aoa_to_sheet(data);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, 'Sheet1');

                // Ensure filename has .xlsx extension
                if (!filename.toLowerCase().endsWith('.xlsx')) {
                    filename = filename.replace(/\.(csv|xls)$/i, '') + '.xlsx';
                }

                // Generate Excel file and download
                XLSX.writeFile(wb, filename);
                console.log('Excel file downloaded:', filename);
            } catch (error) {
                console.error('Error generating Excel file:', error);
                // Fallback to CSV on error
                const csvContent = convertToCSV(data);
                const csvFilename = filename.replace(/\.(xlsx|xls)$/i, '') + '.csv';
                downloadCSV(csvContent, csvFilename);
            }
        }

        // Helper function to convert data array to properly escaped CSV
        function convertToCSV(data) {
            if (!data || data.length === 0) return '';
            
            return data.map(row => {
                return row.map(cell => {
                    // Convert cell to string
                    const cellValue = cell === null || cell === undefined ? '' : String(cell);
                    
                    // If cell contains comma, quote, or newline, wrap in quotes and escape quotes
                    if (cellValue.includes(',') || cellValue.includes('"') || cellValue.includes('\n') || cellValue.includes('\r')) {
                        // Escape quotes by doubling them and wrap in quotes
                        return '"' + cellValue.replace(/"/g, '""') + '"';
                    }
                    
                    return cellValue;
                }).join(',');
            }).join('\n');
        }

        // Users Management Functions
        let users = []; // Global users array

        async function loadUsers() {
            const tbody = document.getElementById('users-table-body');
            if (tbody) {
                tbody.innerHTML = '<tr><td colspan="7" class="loading">Loading users...</td></tr>';
            }
            
            try {
                console.log(' Loading authorized users from /api/authorized-users');
                const response = await fetch('/api/authorized-users');
                const result = await response.json();
                
                if (result.success) {
                    users = result.data;
                    console.log(` Loaded ${users.length} authorized users:`, users.map(u => `ID:${u.id} - ${u.name} (${u.email})`));
                    displayUsers(users);
                } else {
                    console.error('Error loading authorized users:', result.error);
                    if (tbody) {
                        tbody.innerHTML = '<tr><td colspan="7" class="error">Failed to load users</td></tr>';
                    }
                    showError('Failed to load authorized users: ' + result.error);
                }
            } catch (error) {
                console.error('Error loading authorized users:', error);
                if (tbody) {
                    tbody.innerHTML = '<tr><td colspan="7" class="error">Error loading users</td></tr>';
                }
                showError('Failed to load authorized users');
            }
        }
        function displayUsers(usersData = users, groupBy = '') {
            const tbody = document.getElementById('users-table-body');
            if (!tbody) return;

            if (!usersData || usersData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" class="no-data">No users found</td></tr>';
                return;
            }

            // Inline search + advanced filters + sort
            const term = document.getElementById('users-inline-search')?.value || '';
            let list = applyInlineSearch(usersData, term, ['name','email','role','status']);
            list = applyAdvancedFiltersUsers(list);
            list = applyInlineSort(list, 'users');

            // Check if no results after filtering
            if (list.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" class="empty-state">No matches found for your search or filter criteria</td></tr>';
                // Remove pagination controls and info
                const container = document.querySelector('#users .table-container');
                if (container) {
                    const existingPagination = container.querySelector('.pagination-controls');
                    if (existingPagination) existingPagination.remove();
                    const existingInfo = container.querySelector('.pagination-info');
                    if (existingInfo) existingInfo.remove();
                }
                return;
            }

            // Update pagination
            updateTotalPages(list, 'users');
            const paginatedData = getPaginatedData(list, 'users');

            let html = '';
            
            if (groupBy) {
                // Group users by the specified field
                const grouped = groupUsers(usersData, groupBy);
                Object.keys(grouped).forEach(groupKey => {
                    html += `<tr class="group-header"><td colspan="9"><strong>${groupKey}</strong></td></tr>`;
                    grouped[groupKey].forEach(user => { html += generateUserRow(user); });
                });
            } else {
                // Display users without grouping (use paginated data)
                paginatedData.forEach(user => { html += generateUserRow(user); });
            }

            tbody.innerHTML = html;

            // Update sort indicators
            updateSortIndicators('users');
            
            // Update the Select All checkbox state
            updateSelectAllCheckbox();
            
            // Add pagination controls
            const container = document.querySelector('#users .table-container');
            if (container) {
                const existingPagination = container.querySelector('.pagination-controls');
                if (existingPagination) {
                    existingPagination.remove();
                }
                
                const paginationHTML = createPaginationControls('users');
                if (paginationHTML) {
                    container.insertAdjacentHTML('beforeend', paginationHTML);
                }
                
                // Add pagination info
                const existingInfo = container.querySelector('.pagination-info');
                if (existingInfo) {
                    existingInfo.remove();
                }
                
                const startIndex = (currentPage['users'] - 1) * ITEMS_PER_PAGE + 1;
                const endIndex = Math.min(currentPage['users'] * ITEMS_PER_PAGE, list.length);
                const infoHTML = `
                    <div class="pagination-info">
                        <span>Showing ${startIndex}-${endIndex} of ${list.length} users</span>
                        <span>Page ${currentPage['users']} of ${totalPages['users']}</span>
                    </div>
                `;
                container.insertAdjacentHTML('beforeend', infoHTML);
            }
        }

        function generateUserRow(user) {
            // Debug: Log user role to console
            console.log('User role for', user.name, ':', user.role, 'Type:', typeof user.role);
            
            // For authorized_users table, status is determined by is_superadmin and role
            const status = user.is_superadmin ? 'superadmin' : (user.role || 'interviewer');
            const statusClass = 'status-active'; // All authorized users are active
            const roleClass = status === 'superadmin' ? 'role-superadmin' :
                             status === 'admin' ? 'role-admin' : 'role-interviewer';
            
            // Debug: Check menu conditions
            const isInterviewer = user.role && (user.role.toLowerCase() === 'interviewer' || user.role === 'interviewer');
            const isAdmin = user.role && (user.role.toLowerCase() === 'admin' || user.role === 'admin');
            console.log('Menu conditions for', user.name, '- isInterviewer:', isInterviewer, 'isAdmin:', isAdmin);

            return `
                <tr data-row-id="${user.id}">
                    <td><input type="checkbox" class="row-checkbox" data-row-id="${user.id}" ${selectedRows.has(String(user.id)) ? 'checked' : ''} onchange="toggleRowSelection(${user.id})"></td>
                    <td class="editable" data-field="name">${user.name || 'N/A'}</td>
                    <td class="editable" data-field="email">${user.email}</td>
                    <td><span class="role-badge ${roleClass}">${status}</span></td>
                    <td><span class="status-badge ${statusClass}">Active</span></td>
                    <td>${formatDate(user.created_at)}</td>
                    <td>
                        <div class="action-menu-container">
                            <button class="icon-btn menu-btn" onclick="toggleUserMenu(${user.id})" title="More Actions"></button>
                            <div id="user-menu-${user.id}" class="user-action-menu hidden">
                                ${isInterviewer ? `<button onclick="promoteToAdmin(${user.id})" class="menu-item">Make as Admin</button>` : ''}
                                ${isAdmin ? `<button onclick="promoteToSuperAdmin(${user.id})" class="menu-item">Make as Super Admin</button>` : ''}
                                <button onclick="deactivateUser(${user.id})" class="menu-item">Deactivate User</button>
                            </div>
                        </div>
                        <button class="icon-btn edit-btn" onclick="startEdit(${user.id})" title="Edit"><img src="/edit.png" alt="Edit" style="width:16px;height:16px;vertical-align:middle"></button>
                        <button class="icon-btn view-btn" onclick="viewUser(${user.id})" title="View Details"><img src="/view.png" alt="View" style="width:16px;height:16px;vertical-align:middle"></button>
                        <button class="icon-btn delete-btn" onclick="deleteUser(${user.id})" title="Delete"><img src="/delete.png" alt="Delete" style="width:16px;height:16px;vertical-align:middle"></button>
                    </td>
                </tr>
            `;
        }

        function groupUsers(usersData, groupBy) {
            const grouped = {};
            
            usersData.forEach(user => {
                let groupKey;
                
                switch(groupBy) {
                    case 'role':
                        groupKey = user.role || 'Unknown';
                        break;
                    case 'status':
                        groupKey = user.status || 'Unknown';
                        break;
                    case 'date':
                        groupKey = new Date(user.created_at).toLocaleDateString();
                        break;
                    default:
                        groupKey = 'All Users';
                }
                
                if (!grouped[groupKey]) {
                    grouped[groupKey] = [];
                }
                grouped[groupKey].push(user);
            });
            
            return grouped;
        }

        async function refreshUsers() {
            clearSelection();
            showLoadingSpinner('users');
            try {
                await loadUsers();
            } finally {
                hideLoadingSpinner('users');
            }
        }

        async function viewUser(userId) {
            try {
                const response = await fetch(`/api/authorized-users/${userId}`);
                const result = await response.json();
                
                if (result.success) {
                    showUserDetailModal(result.data);
                } else {
                    showError('Failed to load authorized user details: ' + result.error);
                }
            } catch (error) {
                console.error('Error loading authorized user details:', error);
                showError('Failed to load authorized user details');
            }
        }

        function showUserDetailModal(user) {
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.display = 'flex';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 600px;">
                    <div class="modal-header">
                        <h3>User Details</h3>
                        <button class="close-btn" onclick="this.closest('.modal').remove()"></button>
                    </div>
                    <div class="modal-body">
                        <div class="detail-grid">
                            <div class="detail-item">
                                <label>ID:</label>
                                <span>${user.id}</span>
                            </div>
                            <div class="detail-item">
                                <label>Name:</label>
                                <span>${user.name || 'N/A'}</span>
                            </div>
                            <div class="detail-item">
                                <label>Email:</label>
                                <span>${user.email}</span>
                            </div>
                            <div class="detail-item">
                                <label>Role:</label>
                                <span class="role-badge ${user.role === 'superadmin' ? 'role-superadmin' : user.role === 'admin' ? 'role-admin' : 'role-interviewer'}">${user.role}</span>
                            </div>
                            <div class="detail-item">
                                <label>Status:</label>
                                <span class="status-badge ${user.status === 'active' ? 'status-active' : user.status === 'inactive' ? 'status-inactive' : 'status-suspended'}">${user.status}</span>
                            </div>
                            <div class="detail-item">
                                <label>Created At:</label>
                            <span>${formatDate(user.created_at)}</span>
                            </div>
                            
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        async function deleteUser(userId) {
            if (!confirm('Are you sure you want to delete this authorized user?')) {
                return;
            }

            try {
                const response = await fetch(`/api/authorized-users/${userId}`, {
                    method: 'DELETE'
                });
                const result = await response.json();
                
                if (result.success) {
                    showSuccess('Authorized user deleted successfully');
                    await loadUsers();
                } else {
                    showError('Failed to delete authorized user: ' + result.error);
                }
            } catch (error) {
                console.error('Error deleting authorized user:', error);
                showError('Failed to delete authorized user');
            }
        }

        // Student Detail View
        async function viewStudent(studentId) {
            console.log(' viewStudent called with ID:', studentId);
            try {
                // Get student details
                const studentResponse = await fetch(`/api/students/${studentId}`);
                const studentData = await studentResponse.json();
                
                console.log(' Student data response:', studentData);
                
                if (!studentData.success) {
                    showError('Student not found');
                    return;
                }

                const student = studentData.data;

                // Get student's interviews
                const interviewsResponse = await fetch(`/api/interviews/student/${studentId}/history`);
                const interviewsData = await interviewsResponse.json();
                
                console.log(' Interviews data response:', interviewsData);
                
                const interviews = interviewsData.success ? interviewsData.data : [];
                
                console.log('Student interviews loaded:', interviews.length);

                const content = `
                    <div class="detail-section">
                        <h4 class="detail-section-title">Student Information</h4>
                        <div class="detail-item">
                            <div class="detail-label">Name</div>
                            <div class="detail-value">${student.first_name} ${student.last_name}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Email</div>
                            <div class="detail-value">${student.email}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Zeta ID</div>
                            <div class="detail-value">${student.zeta_id}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Phone</div>
                            <div class="detail-value">${student.phone || 'N/A'}</div>
                        </div>
                    </div>

                    <div class="detail-section">
                        <h4 class="detail-section-title">Interview History (${interviews.length})</h4>
                        ${interviews.length > 0 ? `
                            <ul class="interview-list">
                                ${interviews.map(interview => `
                                    <li class="interview-item">
                                        <div class="interview-header" onclick="toggleInterview(${interview.id})">
                                            <div>
                                                <div class="interview-title">Interview #${interview.id}</div>
                                                <div class="interview-meta">
                                                    ${formatDate(interview.interview_date)}  
                                                    ${interview.duration_seconds ? formatDuration(interview.duration_seconds) : 'N/A'}  
                                                    ${interview.verdict || 'No Verdict'}
                                                </div>
                                            </div>
                                            <span class="interview-expand" id="expand-${interview.id}"></span>
                                        </div>
                                        <div class="interview-details" id="details-${interview.id}">
                                            <div class="detail-item">
                                                <div class="detail-label">Status</div>
                                                <div class="detail-value">${interview.status}</div>
                                            </div>
                                            <div class="detail-item">
                                                <div class="detail-label">Overall Notes</div>
                                                <div class="detail-value">${interview.overall_notes || 'No notes available'}</div>
                                            </div>
                                            <div class="detail-item">
                                                <div class="detail-label">Questions & Answers</div>
                                                <div class="detail-value">
                                                    <div id="questions-${interview.id}">Loading questions...</div>
                                                </div>
                                            </div>
                                        </div>
                                    </li>
                                `).join('')}
                            </ul>
                        ` : '<p>No interviews found for this student.</p>'}
                    </div>
                `;

                console.log(' Opening detail panel for student:', student.first_name, student.last_name);
                openDetailPanel(`Student: ${student.first_name} ${student.last_name}`, content);

                // Load questions for each interview
                for (const interview of interviews) {
                    await loadInterviewQuestions(interview.id);
                }

            } catch (error) {
                console.error('Error loading student details:', error);
                showError('Error loading student details');
            }
        }

        // Load interview questions
        async function loadInterviewQuestions(interviewId) {
            try {
                const response = await fetch(`/api/interviews/${interviewId}/questions`);
                const data = await response.json();
                
                const questionsContainer = document.getElementById(`questions-${interviewId}`);
                if (!questionsContainer) return;

                if (data.success && data.data.length > 0) {
                    const questions = data.data;
                    questionsContainer.innerHTML = `
                        <ul class="question-list">
                            ${questions.map(question => `
                                <li class="question-item">
                                    <div class="question-header" onclick="toggleQuestion(${question.id})">
                                        <div class="question-text">${question.question_text}</div>
                                        <span class="question-expand" id="q-expand-${question.id}"></span>
                                    </div>
                                    <div class="question-details" id="q-details-${question.id}">
                                        <div class="answer-section">
                                            <div class="answer-label">Student Answer:</div>
                                            <div class="answer-text">${question.student_answer || 'No answer provided'}</div>
                                            ${question.answer_photo_url ? `
                                                <div class="photo-gallery">
                                                    ${(() => {
                                                        try {
                                                            console.log('Raw answer_photo_url:', question.answer_photo_url);
                                                            let photoUrls;
                                                            
                                                            if (typeof question.answer_photo_url === 'string') {
                                                                try {
                                                                    photoUrls = JSON.parse(question.answer_photo_url);
                                                                } catch (parseError) {
                                                                    photoUrls = question.answer_photo_url;
                                                                }
                                                            } else {
                                                                photoUrls = question.answer_photo_url;
                                                            }
                                                            
                                                            if (Array.isArray(photoUrls)) {
                                                                return photoUrls.map((url, index) => {
                                                                    const cleanUrl = url.replace(/^\[|\]$/g, '').replace(/^"|"$/g, '');
                                                                    return `
                                                                        <div class="photo-item">
                                                                            <img src="${cleanUrl}" alt="Answer Image" class="answer-image" onclick="openImageModal('${cleanUrl.replace(/'/g, "\\'")}')" style="cursor: pointer;">
                                                                        </div>
                                                                    `;
                                                                }).join('');
                                                            } else if (typeof photoUrls === 'string' && photoUrls.trim()) {
                                                                const cleanUrl = photoUrls.replace(/^\[|\]$/g, '').replace(/^"|"$/g, '');
                                                                return `
                                                                    <div class="photo-item">
                                                                        <img src="${cleanUrl}" alt="Answer Image" class="answer-image" onclick="openImageModal('${cleanUrl.replace(/'/g, "\\'")}')" style="cursor: pointer;">
                                                                    </div>
                                                                `;
                                                            } else {
                                                                return '<p>No valid images found</p>';
                                                            }
                                                        } catch (e) {
                                                            console.error('Error processing photo URLs:', e);
                                                            return '<p>Error loading images</p>';
                                                        }
                                                    })()}
                                                </div>
                                            ` : ''}
                                        </div>
                                    </div>
                                </li>
                            `).join('')}
                        </ul>
                    `;
                } else {
                    questionsContainer.innerHTML = '<p>No questions found for this interview.</p>';
                }
            } catch (error) {
                console.error('Error loading interview questions:', error);
                const questionsContainer = document.getElementById(`questions-${interviewId}`);
                if (questionsContainer) {
                    questionsContainer.innerHTML = '<p>Error loading questions.</p>';
                }
            }
        }

        // Toggle interview expansion
        function toggleInterview(interviewId) {
            const details = document.getElementById(`details-${interviewId}`);
            const expand = document.getElementById(`expand-${interviewId}`);
            const header = expand.parentElement;

            if (details.classList.contains('active')) {
                details.classList.remove('active');
                expand.classList.remove('expanded');
                header.classList.remove('active');
            } else {
                details.classList.add('active');
                expand.classList.add('expanded');
                header.classList.add('active');
            }
        }

        // Toggle question expansion
        function toggleQuestion(questionId) {
            const details = document.getElementById(`q-details-${questionId}`);
            const expand = document.getElementById(`q-expand-${questionId}`);

            if (details.classList.contains('active')) {
                details.classList.remove('active');
                expand.classList.remove('expanded');
            } else {
                details.classList.add('active');
                expand.classList.add('expanded');
            }
        }

        // Interview Detail View
        async function viewInterview(interviewId) {
            try {
                console.log(' Loading interview details for ID:', interviewId);
                
                // Get interview details
                console.log(' Making fetch request to:', `/api/interviews/${interviewId}`);
                const interviewResponse = await fetch(`/api/interviews/${interviewId}`);
                console.log(' Fetch response status:', interviewResponse.status);
                console.log(' Fetch response ok:', interviewResponse.ok);
                
                if (!interviewResponse.ok) {
                    console.error(' HTTP Error:', interviewResponse.status, interviewResponse.statusText);
                    showError(`HTTP Error: ${interviewResponse.status} ${interviewResponse.statusText}`);
                    return;
                }

        
                
                const interviewData = await interviewResponse.json();
                console.log(' Interview API response:', interviewData);
                console.log(' Interview API response type:', typeof interviewData);
                console.log(' Interview API response keys:', Object.keys(interviewData || {}));
                
                if (!interviewData) {
                    console.error(' Interview response is null/undefined');
                    showError('No response from server');
                    return;
                }
                
                if (!interviewData.success) {
                    console.error(' Interview API failed:', interviewData.error);
                    showError(`Interview API failed: ${interviewData.error || 'Unknown error'}`);
                    return;
                }

                const interview = interviewData.data;
                console.log(' Interview data:', interview);
                console.log(' Interview data type:', typeof interview);
                console.log(' Interview data keys:', Object.keys(interview || {}));
                
                if (!interview) {
                    console.error(' Interview data is null/undefined');
                    console.error(' Full API response was:', JSON.stringify(interviewData, null, 2));
                    showError('Interview data not available in API response');
                    return;
                }

                // Get student details
                let studentInfo = 'Unknown Student';
                if (interview.student_id) {
                    try {
                        const studentResponse = await fetch(`/api/students/${interview.student_id}`);
                        const studentData = await studentResponse.json();
                        if (studentData.success) {
                            const student = studentData.data;
                            studentInfo = `${student.first_name} ${student.last_name} (${student.zeta_id})`;
                        }
                    } catch (error) {
                        console.error('Error loading student details:', error);
                    }
                }

                // Get interview questions
                let questionsHtml = '<p>No questions found</p>';
                try {
                    const questionsResponse = await fetch(`/api/interviews/${interviewId}/questions`);
                    const questionsData = await questionsResponse.json();
                    if (questionsData.success && questionsData.data.length > 0) {
                        questionsHtml = questionsData.data.map((q, index) => `
                            <div class="question-answer-item" id="question-${q.id}">
                                <div class="question-header">
                                    <p><strong>Q${index + 1}:</strong> 
                                        ${q.question_rich_content ? 
                                            `<div class="question-text-display rich-content-wrapper">${q.question_rich_content}</div>` : 
                                            `<span class="question-text-display">${q.question_text}</span>`
                                        }
                                    </p>
                                    <button class="icon-btn edit-btn edit-question-btn" data-question-id="${q.id}" data-question-text="${(q.question_text || '').replace(/"/g, '&quot;')}" title="Edit Question"><img src="/edit.png" alt="Edit" style="width:16px;height:16px;vertical-align:middle"></button>
                                </div>
                                <div class="answer-section">
                                    <p><strong>Answer:</strong> <span class="answer-text-display">${q.student_answer || 'No answer provided'}</span></p>
                                    <button class="icon-btn edit-btn edit-answer-btn" data-question-id="${q.id}" data-answer-text="${(q.student_answer || '').replace(/"/g, '&quot;')}" data-answer-photo-url="${encodeURIComponent(q.answer_photo_url || '')}" title="Edit Answer"><img src="/edit.png" alt="Edit" style="width:16px;height:16px;vertical-align:middle"></button>
                                </div>
                                ${q.answer_photo_url ? `
                                    <div class="photo-gallery">
                                        ${(() => {
                                            try {
                                                console.log('Raw answer_photo_url:', q.answer_photo_url);
                                                let photoUrls;
                                                
                                                if (typeof q.answer_photo_url === 'string') {
                                                    try {
                                                        photoUrls = JSON.parse(q.answer_photo_url);
                                                    } catch (parseError) {
                                                        photoUrls = q.answer_photo_url;
                                                    }
                                                } else {
                                                    photoUrls = q.answer_photo_url;
                                                }
                                                
                                                if (Array.isArray(photoUrls)) {
                                                    return photoUrls.map((url, index) => {
                                                        const cleanUrl = url.replace(/^\[|\]$/g, '').replace(/^"|"$/g, '');
                                                        return `
                                                            <div class="photo-item">
                                                                <img src="${cleanUrl}" alt="Answer photo" class="answer-image" onclick="openImageModal('${cleanUrl.replace(/'/g, "\\'")}')">
                                                            </div>
                                                        `;
                                                    }).join('');
                                                } else if (typeof photoUrls === 'string' && photoUrls.trim()) {
                                                    const cleanUrl = photoUrls.replace(/^\[|\]$/g, '').replace(/^"|"$/g, '');
                                                    return `
                                                        <div class="photo-item">
                                                            <img src="${cleanUrl}" alt="Answer photo" class="answer-image" onclick="openImageModal('${cleanUrl.replace(/'/g, "\\'")}')">
                                                        </div>
                                                    `;
                                                } else {
                                                    return '<p>No valid images found</p>';
                                                }
                                            } catch (e) {
                                                console.error('Error processing photo URLs:', e);
                                                return '<p>Error loading images</p>';
                                            }
                                        })()}
                                    </div>
                                ` : ''}
                            </div>
                        `).join('');
                    }
                } catch (error) {
                    console.error('Error loading interview questions:', error);
                }

                console.log(' Building content HTML...');
                
                const content = `
                    <div class="detail-section">
                        <h4 class="detail-section-title">Interview Information</h4>
                        <div class="detail-item">
                            <div class="detail-label">Interview ID</div>
                            <div class="detail-value">#${interview.id}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Student</div>
                            <div class="detail-value">${studentInfo}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Date</div>
                            <div class="detail-value">${formatDate(interview.interview_date)}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Status</div>
                            <div class="detail-value"><span class="status-badge status-${interview.status}">${interview.status}</span></div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Duration</div>
                            <div class="detail-value">${interview.duration_seconds ? formatDuration(interview.duration_seconds) : 'N/A'}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Verdict</div>
                            <div class="detail-value">${interview.verdict || 'No Verdict'}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Overall Notes</div>
                            <div class="detail-value">${interview.overall_notes || 'No notes available'}</div>
                        </div>
                    </div>
                    
                    <div class="detail-section">
                        <h4 class="detail-section-title">Questions & Answers</h4>
                        <div class="detail-section-content">
                            ${questionsHtml}
                        </div>
                    </div>
                `;

                console.log(' Content HTML built successfully');
                console.log(' Opening detail panel...');
                
                openDetailPanel(`Interview #${interview.id}`, content);
                
                console.log(' viewInterview completed successfully');

            } catch (error) {
                console.error(' Error loading interview details:', error);
                console.error(' Error stack:', error.stack);
                console.error(' Error message:', error.message);
                showError(`Error loading interview details: ${error.message}`);
            }
        }
        // Global resume function (not nested) so onclick can access it
        function resumeInterviewAdmin(interviewId) {
            try {
                const item = (interviews || []).find(i => i.id === interviewId) || (myInterviews || []).find(i => i.id === interviewId);
                if (!item) {
                    showError('Interview not found');
                    return;
                }
                const zeta = item.zeta_id || '';
                const sessionId = item.session_id || item.session || '';
                if (!zeta || !sessionId) {
                    showError('Missing Zeta ID or Session');
                    return;
                }
                const url = `/interview-session.html?zeta_id=${encodeURIComponent(zeta)}&session_id=${encodeURIComponent(sessionId)}&resume=1`;
                window.location.href = url;
            } catch (e) {
                console.error('Error resuming interview', e);
                showError('Unable to resume interview');
            }
        }

        // Edit question text in interview details
        async function editQuestionText(questionId, currentText) {
            const questionElement = document.getElementById(`question-${questionId}`);
            const questionDisplay = questionElement.querySelector('.question-text-display');
            const editButton = questionElement.querySelector('.question-header .edit-btn');
            
            // Check if content contains HTML (like images)
            const hasHTML = /<[^>]*>/g.test(currentText);
            
            let input;
            if (hasHTML) {
                // Create rich text editor for HTML content
                const editorContainer = document.createElement('div');
                editorContainer.className = 'rich-text-editor-container';
                editorContainer.innerHTML = '<div id="question-editor-' + questionId + '"></div>';
                
                input = editorContainer;
                
                // Initialize Quill editor after adding to DOM
                setTimeout(() => {
                    const quill = new Quill('#question-editor-' + questionId, {
                        theme: 'snow',
                        modules: {
                            toolbar: [
                                ['bold', 'italic', 'underline'],
                                ['link', 'image'],
                                [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                                ['clean']
                            ]
                        }
                    });
                    
                    // Set content
                    quill.root.innerHTML = currentText;
                    
                    // Store quill instance for saving
                    editorContainer.quillInstance = quill;
                }, 100);
            } else {
                // Create textarea for plain text
                input = document.createElement('textarea');
                input.className = 'question-edit-input';
                input.value = currentText;
                input.rows = 3;
            }
            
            // Create action buttons
            const actions = document.createElement('div');
            actions.className = 'edit-actions';
            actions.innerHTML = `
                <button class="btn btn-success" onclick="saveQuestionText(${questionId})">Save</button>
                <button class="btn btn-secondary" onclick="cancelQuestionTextEdit(${questionId}, '${currentText.replace(/'/g, "\\'")}')">Cancel</button>
            `;
            
            // Replace display with input
            questionDisplay.style.display = 'none';
            editButton.style.display = 'none';
            questionDisplay.parentNode.insertBefore(input, questionDisplay);
            questionDisplay.parentNode.insertBefore(actions, questionDisplay);
            
            // Focus and select text
            input.focus();
            input.select();
        }
        
        // Save question text
        async function saveQuestionText(questionId) {
            const questionElement = document.getElementById(`question-${questionId}`);
            
            // Check if it's a rich text editor or textarea
            const richEditor = questionElement.querySelector('.rich-text-editor-container');
            const textarea = questionElement.querySelector('.question-edit-input');
            
            let newText;
            if (richEditor && richEditor.quillInstance) {
                // Get content from Quill editor
                newText = richEditor.quillInstance.root.innerHTML.trim();
            } else if (textarea) {
                // Get content from textarea
                newText = textarea.value.trim();
            } else {
                showError('No input found');
                return;
            }
            
            if (!newText) {
                showError('Question text cannot be empty');
                return;
            }
            
            try {
                const response = await fetch(`/api/interview-questions/${questionId}/text`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        question_text: newText
                    })
                });
                
                const result = await response.json();
                
                if (response.ok && result.success) {
                    // Update display
                    const questionDisplay = questionElement.querySelector('.question-text-display');
                    
                    // Check if content is HTML and update accordingly
                    if (/<[^>]*>/g.test(newText)) {
                        // Rich content - use innerHTML and wrap in div
                        questionDisplay.outerHTML = `<div class="question-text-display rich-content-wrapper">${newText}</div>`;
                    } else {
                        // Plain text - use textContent
                        questionDisplay.textContent = newText;
                        questionDisplay.style.display = 'inline';
                    }
                    
                    // Show edit button
                    const editButton = questionElement.querySelector('.question-header .edit-btn');
                    editButton.style.display = 'inline-block';
                    
                    // Remove input and actions (handle both textarea and rich editor)
                    const richEditor = questionElement.querySelector('.rich-text-editor-container');
                    const textarea = questionElement.querySelector('.question-edit-input');
                    if (richEditor) richEditor.remove();
                    if (textarea) textarea.remove();
                    questionElement.querySelector('.edit-actions').remove();
                    
                    showSuccess('Question updated successfully');
                } else {
                    showError(result.error || 'Error updating question');
                }
            } catch (error) {
                console.error('Error updating question:', error);
                showError('Error updating question');
            }
        }
        
        // Cancel question text edit
        function cancelQuestionTextEdit(questionId, originalText) {
            const questionElement = document.getElementById(`question-${questionId}`);
            const questionDisplay = questionElement.querySelector('.question-text-display');
            const editButton = questionElement.querySelector('.question-header .edit-btn');
            
            // Restore display
            questionDisplay.style.display = 'inline';
            editButton.style.display = 'inline-block';
            
            // Remove input and actions (handle both textarea and rich editor)
            const richEditor = questionElement.querySelector('.rich-text-editor-container');
            const textarea = questionElement.querySelector('.question-edit-input');
            if (richEditor) richEditor.remove();
            if (textarea) textarea.remove();
            const editActions = questionElement.querySelector('.edit-actions');
            if (editActions) editActions.remove();
        }
        // Edit question answer in interview details
        async function editQuestionAnswer(questionId, currentAnswer, answerPhotoUrl) {
            console.log(' Editing answer with photo URL:', answerPhotoUrl);
            const questionElement = document.getElementById(`question-${questionId}`);
            const answerDisplay = questionElement.querySelector('.answer-text-display');
            const editButton = questionElement.querySelector('.answer-section .edit-btn');
            
            // Create input field
            const input = document.createElement('textarea');
            input.className = 'answer-edit-input';
            input.value = currentAnswer;
            input.rows = 3;
            // Store the photo URL as a data attribute to preserve it
            input.setAttribute('data-answer-photo-url', answerPhotoUrl || '');
            console.log(' Stored photo URL in textarea:', input.getAttribute('data-answer-photo-url'));
            
            // Create action buttons
            const actions = document.createElement('div');
            actions.className = 'edit-actions';
            actions.innerHTML = `
                <button class="btn btn-success" onclick="saveQuestionAnswer(${questionId})">Save</button>
                <button class="btn btn-secondary" onclick="cancelQuestionAnswerEdit(${questionId}, '${currentAnswer.replace(/'/g, "\\'")}')">Cancel</button>
            `;
            
            // Replace display with input
            answerDisplay.style.display = 'none';
            editButton.style.display = 'none';
            answerDisplay.parentNode.insertBefore(input, answerDisplay);
            answerDisplay.parentNode.insertBefore(actions, answerDisplay);
            
            // Focus and select text
            input.focus();
            input.select();
        }
        
        // Save question answer
        async function saveQuestionAnswer(questionId) {
            const questionElement = document.getElementById(`question-${questionId}`);
            const input = questionElement.querySelector('.answer-edit-input');
            const newAnswer = input.value.trim();
            // Get the preserved photo URL from the input's data attribute
            let answerPhotoUrl = input.getAttribute('data-answer-photo-url') || null;
            
            // If answerPhotoUrl is a non-empty string, keep it as is (it could be JSON string or plain string)
            // The backend will handle parsing if needed
            console.log(' Saving answer with photo URL:', answerPhotoUrl);
            
            try {
                const response = await fetch(`/api/interview-questions/${questionId}/answer`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        student_answer: newAnswer,
                        answer_photo_url: answerPhotoUrl // Include the photo URL to preserve it
                    })
                });
                
                const result = await response.json();
                
                if (response.ok && result.success) {
                    // Update display
                    const answerDisplay = questionElement.querySelector('.answer-text-display');
                    answerDisplay.textContent = newAnswer || 'No answer provided';
                    answerDisplay.style.display = 'inline';
                    
                    // Show edit button and update its data attribute with the photo URL
                    const editButton = questionElement.querySelector('.answer-section .edit-btn');
                    editButton.setAttribute('data-answer-photo-url', answerPhotoUrl || '');
                    editButton.style.display = 'inline-block';
                    
                    // Remove input and actions
                    input.remove();
                    questionElement.querySelector('.edit-actions').remove();
                    
                    showSuccess('Answer updated successfully');
                } else {
                    showError(result.error || 'Error updating answer');
                }
            } catch (error) {
                console.error('Error updating answer:', error);
                showError('Error updating answer');
            }
        }
        
        // Cancel question answer edit
        function cancelQuestionAnswerEdit(questionId, originalAnswer) {
            const questionElement = document.getElementById(`question-${questionId}`);
            const answerDisplay = questionElement.querySelector('.answer-text-display');
            const editButton = questionElement.querySelector('.answer-section .edit-btn');
            
            // Restore display
            answerDisplay.style.display = 'inline';
            editButton.style.display = 'inline-block';
            
            // Remove input and actions
            questionElement.querySelector('.answer-edit-input').remove();
            questionElement.querySelector('.edit-actions').remove();
        }

        // Question Detail View
        async function viewQuestion(questionId) {
            try {
                const response = await fetch(`/api/admin/questions/${questionId}/details`);
                const data = await response.json();
                
                if (!data.success) {
                    showError('Question not found');
                    return;
                }

                const question = data.data;

                const content = `
                    <div class="detail-section">
                        <h4 class="detail-section-title">Question Information</h4>
                        <div class="detail-item">
                            <div class="detail-label">Question</div>
                            <div class="detail-value">${question.question}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Category</div>
                            <div class="detail-value">${question.category}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Times Asked</div>
                            <div class="detail-value">${question.times_asked}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Total Answers</div>
                            <div class="detail-value">${question.total_answers}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Average Score</div>
                            <div class="detail-value">
                                ${Number(question.average_score || 0) > 0 ? `
                                    <div style="display:flex;align-items:center;gap:0.5rem">
                                        <span>${(Number(question.average_score || 0)).toFixed(2)}</span>
                                        <span style="display:inline-block;background:${Number(question.average_score || 0) > 8 ? '#10b981' : Number(question.average_score || 0) >= 6 ? '#f59e0b' : '#ef4444'};color:#fff;padding:2px 6px;border-radius:8px;font-size:9px;font-weight:600">${Number(question.average_score || 0) > 8 ? '#easy' : Number(question.average_score || 0) >= 6 ? '#medium' : '#hard'}</span>
                                    </div>
                                ` : '-'}
                            </div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Total Score</div>
                            <div class="detail-value">${question.total_score || 0}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Success Rate</div>
                            <div class="detail-value">${Number(question.success_rate || 0)}%</div>
                        </div>
                    </div>
                `;

                openDetailPanel(`Question: ${question.question.substring(0, 50)}...`, content);

            } catch (error) {
                console.error('Error loading question details:', error);
                showError('Error loading question details');
            }
        }

        // Image Modal Functions
        function openImageModal(imageUrl) {
            document.getElementById('modal-image').src = imageUrl;
            document.getElementById('image-modal').classList.add('active');
        }

        function closeImageModal() {
            document.getElementById('image-modal').classList.remove('active');
        }

        // Refresh functions
        // Loading spinner functions
        function showLoadingSpinner(sectionId) {
            const section = document.getElementById(sectionId);
            if (section) {
                const tableContainer = section.querySelector('.table-container');
                if (tableContainer) {
                    section.classList.add('loading-overlay');
                    const spinner = document.createElement('div');
                    spinner.className = 'loading-spinner';
                    spinner.id = `${sectionId}-spinner`;
                    section.appendChild(spinner);
                }
            }
        }
        
        function hideLoadingSpinner(sectionId) {
            const section = document.getElementById(sectionId);
            if (section) {
                section.classList.remove('loading-overlay');
                const spinner = document.getElementById(`${sectionId}-spinner`);
                if (spinner) {
                    spinner.remove();
                }
            }
        }

        async function refreshInterviews() {
            clearSelection();
            showLoadingSpinner('interviews');
            try {
                await loadInterviews();
            } finally {
                hideLoadingSpinner('interviews');
            }
        }

        async function refreshQuestions() {
            clearSelection();
            showLoadingSpinner('questions');
            try {
                await loadQuestions();
            } finally {
                hideLoadingSpinner('questions');
            }
        }

        async function refreshStudents() {
            clearSelection();
            showLoadingSpinner('students');
            try {
                await loadStudents();
            } finally {
                hideLoadingSpinner('students');
            }
        }

        // Student Sessions functions
        async function loadStudentSessions() {
            try {
                const response = await fetch('/api/admin/student-sessions');
                const data = await response.json();
                
                if (data.success) {
                    studentSessions = data.data || [];
                    displayStudentSessions();
                } else {
                    console.error('Error loading student sessions:', data.error);
                    const tbody = document.getElementById('student-sessions-table-body');
                    if (tbody) {
                        tbody.innerHTML = '<tr><td colspan="9" class="error">Error loading student sessions</td></tr>';
                    }
                }
            } catch (error) {
                console.error('Error loading student sessions:', error);
                const tbody = document.getElementById('student-sessions-table-body');
                if (tbody) {
                    tbody.innerHTML = '<tr><td colspan="9" class="error">Error loading student sessions</td></tr>';
                }
            }
        }

        function displayStudentSessions() {
            const tbody = document.getElementById('student-sessions-table-body');
            if (!tbody) return;

            if (!studentSessions || studentSessions.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" class="empty-state">No student sessions found</td></tr>';
                const container = document.querySelector('#student-sessions .table-container');
                if (container) {
                    const existingPagination = container.querySelector('.pagination-controls');
                    if (existingPagination) existingPagination.remove();
                    const existingInfo = container.querySelector('.pagination-info');
                    if (existingInfo) existingInfo.remove();
                }
                return;
            }

            // Inline search + advanced filters + sort
            const term = document.getElementById('student-sessions-inline-search')?.value || '';
            let list = applyInlineSearch(studentSessions, term, ['student_name', 'session_name', 'session_status', 'phone', 'email', 'zeta_id']);
            list = applyAdvancedFiltersStudentSessions(list);
            list = applyInlineSort(list, 'student-sessions');

            // Check if no results after filtering
            if (list.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" class="empty-state">No matches found for your search or filter criteria</td></tr>';
                const container = document.querySelector('#student-sessions .table-container');
                if (container) {
                    const existingPagination = container.querySelector('.pagination-controls');
                    if (existingPagination) existingPagination.remove();
                    const existingInfo = container.querySelector('.pagination-info');
                    if (existingInfo) existingInfo.remove();
                }
                return;
            }

            // Update pagination
            updateTotalPages(list, 'student-sessions');
            const paginatedData = getPaginatedData(list, 'student-sessions');

            // Format status with colors
            const formatStatus = (status) => {
                if (!status) return '<span style="color: #6b7280;"></span>';
                const statusLower = status.toLowerCase();
                let color = '#6b7280'; // default gray
                let bgColor = '#f3f4f6';
                
                if (statusLower.includes('started')) {
                    color = '#3b82f6'; // blue
                    bgColor = '#dbeafe';
                } else if (statusLower.includes('ended')) {
                    color = '#10b981'; // green
                    bgColor = '#d1fae5';
                } else if (statusLower.includes('selected')) {
                    color = '#10b981'; // green
                    bgColor = '#d1fae5';
                } else if (statusLower.includes('rejected')) {
                    color = '#ef4444'; // red
                    bgColor = '#fee2e2';
                } else if (statusLower.includes('waitlisted')) {
                    color = '#f59e0b'; // orange
                    bgColor = '#fef3c7';
                }
                
                return `<span style="display:inline-block;background:${bgColor};color:${color};padding:4px 10px;border-radius:6px;font-size:12px;font-weight:500;">${status}</span>`;
            };

            // Format scores per interviewer (matching interviewer_names order)
            const formatScore = (item) => {
                const interviewerNames = Array.isArray(item.interviewer_names) ? item.interviewer_names : [];
                const interviewScores = Array.isArray(item.interview_scores) ? item.interview_scores : [];
                const interviewQuestionCounts = Array.isArray(item.interview_question_counts) ? item.interview_question_counts : [];
                if (interviewerNames.length === 0) return '';
                return interviewerNames.map((name, idx) => {
                    const score = interviewScores[idx] !== undefined && interviewScores[idx] !== null ? interviewScores[idx] : 0;
                    const questionCount = interviewQuestionCounts[idx] !== undefined && interviewQuestionCounts[idx] !== null ? interviewQuestionCounts[idx] : 0;
                    if (questionCount > 0) {
                        return `${score}/${questionCount}`;
                    }
                    return '-';
                }).join('<br>');
            };

            tbody.innerHTML = paginatedData.map(item => `
                <tr data-row-id="${item.id}">
                    <td><input type="checkbox" class="row-checkbox" data-row-id="${item.id}" ${selectedRows.has(String(item.id)) ? 'checked' : ''} onchange="toggleRowSelection('${item.id}')"></td>
                    <td data-field="student_name">${item.student_name || ''}</td>
                    <td data-field="phone">${item.phone || ''}</td>
                    <td data-field="email">${item.email || ''}</td>
                    <td data-field="zeta_id">${item.zeta_id || ''}</td>
                    <td data-field="session_name">${item.session_name || ''}</td>
                    <td data-field="session_status">${formatStatus(item.session_status)}</td>
                    <td data-field="total_score">${formatScore(item)}</td>
                    <td>
                        <button class="icon-btn edit-btn" onclick="startEdit('${item.id}', ${JSON.stringify(item).replace(/"/g, '&quot;')})" title="Edit"><img src="/edit.png" alt="Edit" style="width:16px;height:16px;vertical-align:middle"></button>
                    </td>
                </tr>
            `).join('');

            // Update Select All checkbox state
            updateSelectAllCheckbox();

            // Add pagination controls
            const container = document.querySelector('#student-sessions .table-container');
            if (container) {
                const existingPagination = container.querySelector('.pagination-controls');
                if (existingPagination) existingPagination.remove();
                const existingInfo = container.querySelector('.pagination-info');
                if (existingInfo) existingInfo.remove();

                const paginationHTML = createPaginationControls('student-sessions');
                if (paginationHTML) {
                    container.insertAdjacentHTML('beforeend', paginationHTML);
                }

                const startIndex = (currentPage['student-sessions'] - 1) * ITEMS_PER_PAGE + 1;
                const endIndex = Math.min(currentPage['student-sessions'] * ITEMS_PER_PAGE, list.length);
                const infoHTML = `
                    <div class="pagination-info">
                        <span>Showing ${startIndex}-${endIndex} of ${list.length} records</span>
                        <span>Page ${currentPage['student-sessions']} of ${totalPages['student-sessions']}</span>
                    </div>
                `;
                container.insertAdjacentHTML('beforeend', infoHTML);
            }
        }

        async function refreshStudentSessions() {
            showLoadingSpinner('student-sessions');
            try {
                await loadStudentSessions();
            } finally {
                hideLoadingSpinner('student-sessions');
            }
        }

        async function refreshSessions() {
            clearSelection();
            showLoadingSpinner('sessions');
            try {
                await loadSessions();
            } finally {
                hideLoadingSpinner('sessions');
            }
        }

        async function refreshConsolidation() {
            showLoadingSpinner('consolidation');
            try {
                await loadConsolidation(true); // Force refresh
            } finally {
                hideLoadingSpinner('consolidation');
            }
        }

        // Action functions - viewInterview is already implemented above

        async function viewSession(sessionId) {
            console.log(' viewSession called with ID:', sessionId);
            try {
                // Get session details
                const sessionResponse = await fetch(`/api/admin/sessions`);
                const sessionsData = await sessionResponse.json();
                
                console.log(' Sessions data response:', sessionsData);
                
                if (!sessionsData.success) {
                    showError('Failed to load sessions');
                    return;
                }

                const session = sessionsData.data.find(s => s.id === parseInt(sessionId));
                if (!session) {
                    showError('Session not found');
                    return;
                }

                // Get interviews for this session
                const interviewsResponse = await fetch(`/api/admin/interviews`);
                const interviewsData = await interviewsResponse.json();
                
                console.log(' Interviews data response:', interviewsData);
                
                const sessionInterviews = interviewsData.success ? 
                    interviewsData.data.filter(interview => interview.session_id === parseInt(sessionId)) : [];
                
                console.log('Session interviews loaded:', sessionInterviews.length);

                const content = `
                    <div class="detail-section">
                        <h4 class="detail-section-title">Session Information</h4>
                        <div class="detail-item">
                            <div class="detail-label">Session Name</div>
                            <div class="detail-value">${session.name}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Description</div>
                            <div class="detail-value">${session.description || 'No description available'}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Status</div>
                            <div class="detail-value"><span class="status-badge status-${session.status}">${session.status}</span></div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Created By</div>
                            <div class="detail-value">${session.created_by_name || 'Unknown'}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Created At</div>
                            <div class="detail-value">${formatDate(session.created_at)}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Total Interviews</div>
                            <div class="detail-value">${sessionInterviews.length}</div>
                        </div>
                    </div>

                    <div class="detail-section">
                        <h4 class="detail-section-title">Session Interviews (${sessionInterviews.length})</h4>
                        ${sessionInterviews.length > 0 ? `
                            <ul class="interview-list">
                                ${sessionInterviews.map(interview => `
                                    <li class="interview-item">
                                        <div class="interview-header" onclick="toggleInterview(${interview.id})">
                                            <div>
                                                <div class="interview-title">Interview #${interview.id}</div>
                                                <div class="interview-meta">
                                                    ${interview.student_name || 'Unknown Student'}  
                                                    ${formatDate(interview.interview_date)}  
                                                    ${interview.duration_seconds ? formatDuration(interview.duration_seconds) : 'N/A'}  
                                                    ${interview.verdict || 'No Verdict'}
                                                </div>
                                            </div>
                                            <span class="interview-expand" id="expand-${interview.id}"></span>
                                        </div>
                                        <div class="interview-details" id="details-${interview.id}">
                                            <div class="detail-item">
                                                <div class="detail-label">Student</div>
                                                <div class="detail-value">${interview.student_name || 'Unknown'} (${interview.zeta_id || 'N/A'})</div>
                                            </div>
                                            <div class="detail-item">
                                                <div class="detail-label">Interviewer</div>
                                                <div class="detail-value">${interview.interviewer_name || 'Unknown'}</div>
                                            </div>
                                            <div class="detail-item">
                                                <div class="detail-label">Status</div>
                                                <div class="detail-value"><span class="status-badge status-${interview.status}">${interview.status}</span></div>
                                            </div>
                                            <div class="detail-item">
                                                <div class="detail-label">Overall Notes</div>
                                                <div class="detail-value">${interview.overall_notes || 'No notes available'}</div>
                                            </div>
                                            <div class="detail-item">
                                                <div class="detail-label">Questions & Answers</div>
                                                <div class="detail-value">
                                                    <div id="questions-${interview.id}">Loading questions...</div>
                                                </div>
                                            </div>
                                        </div>
                                    </li>
                                `).join('')}
                            </ul>
                        ` : '<p>No interviews found for this session.</p>'}
                    </div>
                `;

                console.log(' Opening detail panel for session:', session.name);
                openDetailPanel(`Session: ${session.name}`, content);

                // Load questions for each interview
                for (const interview of sessionInterviews) {
                    await loadInterviewQuestions(interview.id);
                }

            } catch (error) {
                console.error('Error loading session details:', error);
                showError('Error loading session details');
            }
        }

        // viewStudent is already implemented above

        async function deleteSession(sessionId) {
            const proceed = await new Promise(resolve => {
                const overlay = document.createElement('div');
                overlay.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.35);display:flex;align-items:center;justify-content:center;z-index:2000;';
                overlay.innerHTML = `
                  <div style="background:#fff;border:1px solid #e5e7eb;border-radius:8px;min-width:300px;max-width:90%;padding:16px;box-shadow:0 10px 20px rgba(0,0,0,0.15)">
                    <div style="font-weight:600;margin-bottom:8px;color:#111827">Delete Session?</div>
                    <div style="font-size:14px;color:#374151;margin-bottom:12px">Are you sure you want to delete this session?</div>
                    <div style="display:flex;gap:8px;justify-content:flex-end">
                      <button id="ds-cancel" style="border:1px solid #e5e7eb;background:#fff;padding:6px 10px;border-radius:6px;cursor:pointer">Cancel</button>
                      <button id="ds-ok" style="background:#dc2626;color:#fff;border:none;padding:6px 10px;border-radius:6px;cursor:pointer">Delete</button>
                    </div>
                  </div>`;
                document.body.appendChild(overlay);
                overlay.querySelector('#ds-cancel').onclick = ()=> { overlay.remove(); resolve(false); };
                overlay.querySelector('#ds-ok').onclick = ()=> { overlay.remove(); resolve(true); };
            });
            if (!proceed) return;

            try {
                const response = await fetch(`/api/admin/sessions/${sessionId}`, {
                    method: 'DELETE'
                });

                const data = await response.json();
                
                if (data.success) {
                    loadSessions();
                    showSuccess('Session deleted successfully!');
                } else {
                    showError('Error deleting session: ' + data.error);
                }
            } catch (error) {
                console.error('Error deleting session:', error);
                showError('Error deleting session');
            }
        }

        // Edit functionality
        let selectedRows = new Set();
        let currentEditRow = null;
        let currentEditData = null;

        function toggleRowSelection(rowId) {
            const id = String(rowId);
            if (selectedRows.has(id)) {
                selectedRows.delete(id);
            } else {
                selectedRows.add(id);
            }
            updateBulkEditControls();
        }

        function selectAllRows() {
            const section = (typeof currentSection !== 'undefined' && currentSection) ? currentSection : (document.querySelector('.nav-link.active') ? document.querySelector('.nav-link.active').dataset.section : '');
            const scope = section ? document.getElementById(section) : document;
            const checkboxes = scope.querySelectorAll('.row-checkbox');
            checkboxes.forEach(checkbox => {
                checkbox.checked = true;
                const rowId = checkbox.dataset.rowId;
                if (rowId) {
                    selectedRows.add(String(rowId));
                }
            });
            updateBulkEditControls();
        }

        function toggleAllRows(checked) {
            const section = (typeof currentSection !== 'undefined' && currentSection) ? currentSection : (document.querySelector('.nav-link.active') ? document.querySelector('.nav-link.active').dataset.section : '');
            const scope = section ? document.getElementById(section) : document;
            const checkboxes = scope.querySelectorAll('.row-checkbox');
            if (checked) {
                checkboxes.forEach(cb => { 
                    cb.checked = true; 
                    const rowId = cb.dataset.rowId;
                    if (rowId) {
                        selectedRows.add(String(rowId));
                    }
                });
            } else {
                checkboxes.forEach(cb => { 
                    cb.checked = false; 
                    const rowId = cb.dataset.rowId;
                    if (rowId) {
                        selectedRows.delete(String(rowId));
                    }
                });
            }
            updateBulkEditControls();
        }

        function clearSelection() {
            selectedRows.clear();
            const section = (typeof currentSection !== 'undefined' && currentSection) ? currentSection : (document.querySelector('.nav-link.active') ? document.querySelector('.nav-link.active').dataset.section : '');
            const scope = section ? document.getElementById(section) : document;
            const checkboxes = scope.querySelectorAll('.row-checkbox');
            checkboxes.forEach(checkbox => {
                checkbox.checked = false;
            });
            // Also uncheck the "Select All" checkbox
            const selectAllCheckbox = scope.querySelector('th input[type="checkbox"]');
            if (selectAllCheckbox) {
                selectAllCheckbox.checked = false;
            }
            updateBulkEditControls();
        }

        function updateSelectAllCheckbox() {
            const section = (typeof currentSection !== 'undefined' && currentSection) ? currentSection : (document.querySelector('.nav-link.active') ? document.querySelector('.nav-link.active').dataset.section : '');
            const scope = section ? document.getElementById(section) : document;
            const selectAllCheckbox = scope.querySelector('th input[type="checkbox"]');
            const visibleCheckboxes = scope.querySelectorAll('.row-checkbox');
            
            if (selectAllCheckbox && visibleCheckboxes.length > 0) {
                // Check if all visible row IDs are in selectedRows
                const allChecked = Array.from(visibleCheckboxes).every(cb => {
                    const rowId = cb.dataset.rowId;
                    return rowId && selectedRows.has(rowId);
                });
                selectAllCheckbox.checked = allChecked;
            }
        }

        function updateBulkEditControls() {
            const controlsList = document.querySelectorAll('.bulk-edit-controls');
            const label = selectedRows.size > 0 ? `${selectedRows.size} records selected` : '0 records selected';
            controlsList.forEach(ctrl => {
                const count = ctrl.querySelector('#bulk-edit-selected-count');
                if (count) count.textContent = label;
            });

            // Update the Select All checkbox state
            updateSelectAllCheckbox();

            // Toggle per-section bars
            const perBars = document.querySelectorAll('.bulk-edit-controls');
            perBars.forEach(bar => {
                if (selectedRows.size > 0) bar.classList.add('active'); else bar.classList.remove('active');
            });
        }

        function openBulkEditModal() {
            if (selectedRows.size === 0) {
                showError('Please select records to edit');
                return;
            }
            
            const modal = document.getElementById('bulk-edit-modal');
            const fieldSelect = document.getElementById('bulk-edit-field');
            
            // Populate field options based on current tab
            fieldSelect.innerHTML = '<option value="">Select field...</option>';
            
            const section = (typeof currentSection !== 'undefined' && currentSection) ? currentSection : (document.querySelector('.nav-link.active') ? document.querySelector('.nav-link.active').dataset.section : '');
            let fields = [];
            
            if (section === 'students') {
                fields = [
                    { value: 'first_name', text: 'First Name' },
                    { value: 'last_name', text: 'Last Name' },
                    { value: 'email', text: 'Email' },
                    { value: 'phone', text: 'Phone' },
                    { value: 'address', text: 'Address' },
                    { value: 'zeta_id', text: 'Zeta ID' }
                ];
            } else if (section === 'sessions') {
                fields = [
                    { value: 'name', text: 'Name' },
                    { value: 'description', text: 'Description' },
                    { value: 'status', text: 'Status' }
                ];
            } else if (section === 'interviews' || section === 'my-interviews') {
                fields = [
                    { value: 'verdict', text: 'Verdict' },
                    { value: 'status', text: 'Status' },
                    { value: 'overall_notes', text: 'Notes' }
                ];
            } else if (section === 'questions') {
                fields = [
                    { value: 'question', text: 'Question Text' },
                    { value: 'category', text: 'Category' }
                ];
            } else if (section === 'users') {
                fields = [
                    { value: 'name', text: 'Name' },
                    { value: 'email', text: 'Email' },
                    { value: 'role', text: 'Role' },
                    { value: 'status', text: 'Status' }
                ];
            } else if (section === 'student-sessions') {
                fields = [
                    { value: 'session_status', text: 'Interview Status' }
                ];
            }
            
            fields.forEach(field => {
                const option = document.createElement('option');
                option.value = field.value;
                option.textContent = field.text;
                fieldSelect.appendChild(option);
            });
            
            // Reflect selected count inside modal
            const modalCount = modal.querySelector('#bulk-edit-selected-count');
            if (modalCount) {
                modalCount.textContent = `${selectedRows.size} records selected`;
            }

            modal.classList.add('active');
        }

        async function bulkDelete() {
            if (selectedRows.size === 0) {
                showError('Please select records to delete');
                return;
            }
            const proceed = await new Promise(resolve => {
                const overlay = document.createElement('div');
                overlay.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.35);display:flex;align-items:center;justify-content:center;z-index:2000;';
                overlay.innerHTML = `
                  <div style="background:#fff;border:1px solid #e5e7eb;border-radius:8px;min-width:300px;max-width:90%;padding:16px;box-shadow:0 10px 20px rgba(0,0,0,0.15)">
                    <div style="font-weight:600;margin-bottom:8px;color:#111827">Delete ${selectedRows.size} records?</div>
                    <div style="font-size:14px;color:#374151;margin-bottom:12px">Are you sure you want to delete the selected records? This cannot be undone.</div>
                    <div style="display:flex;gap:8px;justify-content:flex-end">
                      <button id="bd-cancel" style="border:1px solid #e5e7eb;background:#fff;padding:6px 10px;border-radius:6px;cursor:pointer">Cancel</button>
                      <button id="bd-ok" style="background:#dc2626;color:#fff;border:none;padding:6px 10px;border-radius:6px;cursor:pointer">Delete</button>
                    </div>
                  </div>`;
                document.body.appendChild(overlay);
                overlay.querySelector('#bd-cancel').onclick = ()=> { overlay.remove(); resolve(false); };
                overlay.querySelector('#bd-ok').onclick = ()=> { overlay.remove(); resolve(true); };
            });
            if (!proceed) return;

            const section = (typeof currentSection !== 'undefined' && currentSection) ? currentSection : (document.querySelector('.nav-link.active') ? document.querySelector('.nav-link.active').dataset.section : '');
            const prefixBySection = {
                'students': '/api/students/',
                'sessions': '/api/sessions/',
                'interviews': '/api/interviews/',
                'my-interviews': '/api/interviews/',
                'questions': '/api/question-bank/',
                'users': '/api/authorized-users/'
            };
            const prefix = prefixBySection[section];
            if (!prefix) { showError('Cannot resolve delete endpoint'); return; }

            let successCount = 0;
            for (const id of Array.from(selectedRows)) {
                try {
                    const res = await fetch(`${prefix}${id}`, { method: 'DELETE' });
                    const json = await res.json().catch(()=>({success:res.ok}));
                    if (res.ok && json.success !== false) successCount++;
                } catch {}
            }
            showSuccess(`Deleted ${successCount} of ${selectedRows.size} records`);
            clearSelection();
            reloadCurrentTab();
        }

        function closeBulkEditModal() {
            const modal = document.getElementById('bulk-edit-modal');
            if (modal) {
                modal.classList.remove('active');
            }
            const valueInput = document.getElementById('bulk-edit-value');
            if (valueInput) {
                valueInput.value = '';
            }
            const valueGroup = document.getElementById('bulk-edit-value-group');
            if (valueGroup) {
                valueGroup.style.display = 'none';
            }
        }

        function updateBulkEditFields() {
            const fieldSelect = document.getElementById('bulk-edit-field');
            const valueGroup = document.getElementById('bulk-edit-value-group');
            const valueInput = document.getElementById('bulk-edit-value');
            const section = (typeof currentSection !== 'undefined' && currentSection) ? currentSection : (document.querySelector('.nav-link.active') ? document.querySelector('.nav-link.active').dataset.section : '');
            
            if (fieldSelect.value) {
                valueGroup.style.display = 'block';
                
                // If verdict field is selected, replace input with dropdown
                if (fieldSelect.value === 'verdict') {
                    const currentValue = valueInput.value;
                    const select = document.createElement('select');
                    select.id = 'bulk-edit-value';
                    select.className = valueInput.className || 'form-input';
                    select.innerHTML = `
                        <option value="">Select Verdict...</option>
                        <option value="Tiger" ${currentValue === 'Tiger' ? 'selected' : ''}>Tiger</option>
                        <option value="Cow" ${currentValue === 'Cow' ? 'selected' : ''}>Cow</option>
                        <option value="Sheep" ${currentValue === 'Sheep' ? 'selected' : ''}>Sheep</option>
                    `;
                    valueInput.replaceWith(select);
                } else if (fieldSelect.value === 'status' && section === 'sessions') {
                    // If status field is selected in sessions, replace input with Active/Inactive dropdown
                    const currentValue = valueInput.value;
                    const select = document.createElement('select');
                    select.id = 'bulk-edit-value';
                    select.className = valueInput.className || 'form-input';
                    select.innerHTML = `
                        <option value="">Select Status...</option>
                        <option value="active" ${currentValue === 'active' ? 'selected' : ''}>Active</option>
                        <option value="inactive" ${currentValue === 'inactive' ? 'selected' : ''}>Inactive</option>
                    `;
                    valueInput.replaceWith(select);
                } else if (fieldSelect.value === 'role' && section === 'users') {
                    // If role field is selected in users, replace input with role dropdown
                    const currentValue = valueInput.value;
                    const select = document.createElement('select');
                    select.id = 'bulk-edit-value';
                    select.className = valueInput.className || 'form-input';
                    select.innerHTML = `
                        <option value="">Select Role...</option>
                        <option value="interviewer" ${currentValue === 'interviewer' ? 'selected' : ''}>Interviewer</option>
                        <option value="admin" ${currentValue === 'admin' ? 'selected' : ''}>Admin</option>
                        <option value="superadmin" ${currentValue === 'superadmin' ? 'selected' : ''}>Super Admin</option>
                    `;
                    valueInput.replaceWith(select);
                } else if (fieldSelect.value === 'status' && section === 'users') {
                    // If status field is selected in users, replace input with Active/Inactive dropdown
                    const currentValue = valueInput.value;
                    const select = document.createElement('select');
                    select.id = 'bulk-edit-value';
                    select.className = valueInput.className || 'form-input';
                    select.innerHTML = `
                        <option value="">Select Status...</option>
                        <option value="active" ${currentValue === 'active' ? 'selected' : ''}>Active</option>
                        <option value="inactive" ${currentValue === 'inactive' ? 'selected' : ''}>Inactive</option>
                    `;
                    valueInput.replaceWith(select);
                } else if (fieldSelect.value === 'session_status' && section === 'student-sessions') {
                    // If session_status field is selected in student-sessions, replace input with status dropdown
                    const currentValue = valueInput.value;
                    const select = document.createElement('select');
                    select.id = 'bulk-edit-value';
                    select.className = valueInput.className || 'form-input';
                    select.innerHTML = `
                        <option value="">Select Status...</option>
                        <option value="No show" ${currentValue === 'No show' ? 'selected' : ''}>No show</option>
                        <option value="Disqualified" ${currentValue === 'Disqualified' ? 'selected' : ''}>Disqualified</option>
                        <option value="Age Mismatch" ${currentValue === 'Age Mismatch' ? 'selected' : ''}>Age Mismatch</option>
                        <option value="Degree holder" ${currentValue === 'Degree holder' ? 'selected' : ''}>Degree holder</option>
                        <option value="Interviewer unavailable" ${currentValue === 'Interviewer unavailable' ? 'selected' : ''}>Interviewer unavailable</option>
                    `;
                    valueInput.replaceWith(select);
                } else {
                    // If it's not verdict or session status but current element is a select, replace with input
                    if (valueInput && valueInput.tagName === 'SELECT') {
                        const input = document.createElement('input');
                        input.type = 'text';
                        input.id = 'bulk-edit-value';
                        input.className = valueInput.className || 'form-input';
                        input.placeholder = 'Enter value...';
                        valueInput.replaceWith(input);
                    }
                }
            } else {
                valueGroup.style.display = 'none';
            }
        }
        async function applyBulkEdit() {
            if (selectedRows.size === 0) {
                showError('No records selected');
                return;
            }
            const field = document.getElementById('bulk-edit-field').value;
            const value = document.getElementById('bulk-edit-value').value;
            
            if (!field || !value) {
                showError('Please select a field and enter a value');
                return;
            }
            
            // Get the current section
            const section = (typeof currentSection !== 'undefined' && currentSection) ? currentSection : (document.querySelector('.nav-link.active') ? document.querySelector('.nav-link.active').dataset.section : '');
            
            // Map display field names to actual database field names
            const fieldMapping = {
                'first_name': 'first_name',
                'last_name': 'last_name',
                'email': 'email',
                'phone': 'phone',
                'address': 'address',
                'zeta_id': 'zeta_id',
                'name': 'name',
                'description': 'description',
                'verdict': 'verdict',
                'status': 'status',
                'overall_notes': 'overall_notes',
                'question': 'question',
                'category': 'category',
                'session_status': 'session_status'
            };
            
            // Validate that the field exists in the mapping
            if (!fieldMapping[field]) {
                showError(`Field "${field}" is not editable`);
                return;
            }
            
            // Show spinner
            if (section) {
                showLoadingSpinner(section);
            }
            
            try {
                
                const dbField = fieldMapping[field] || field;
                const updates = Array.from(selectedRows).map(rowId => ({
                    id: parseInt(rowId), // Ensure ID is an integer
                    data: { [dbField]: value }
                }));
                
                let endpoint = '';
                if (section === 'students') {
                    endpoint = '/api/students/bulk';
                } else if (section === 'sessions') {
                    endpoint = '/api/sessions/bulk';
                } else if (section === 'interviews' || section === 'my-interviews') {
                    endpoint = '/api/interviews/bulk';
            } else if (section === 'questions') {
                endpoint = '/api/question-bank/bulk';
            } else if (section === 'users') {
                endpoint = '/api/authorized-users/bulk';
            } else if (section === 'student-sessions') {
                endpoint = '/api/admin/student-sessions/bulk';
            }
                
                console.log('Bulk edit request:', { endpoint, updates });

                let usedBulk = false;
                if (endpoint) {
                    try {
                        const response = await fetch(endpoint, {
                            method: 'PUT',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({ updates })
                        });
                        const result = await response.json();
                        console.log('Bulk edit response:', result);
                        if (response.ok && result.success) {
                            usedBulk = true;
                            showSuccess(`Successfully updated ${updates.length} records`);
                        } else {
                            console.warn('Bulk edit failed, falling back to individual updates:', result.error);
                        }
                    } catch (e) {
                        console.warn('Bulk request error, falling back to individual updates:', e);
                    }
                }

                if (!usedBulk) {
                    // Fallback: perform individual updates using single-record endpoints
                    const ids = Array.from(selectedRows).map(id => parseInt(id));
                    const prefixBySection = {
                        'students': '/api/students/',
                        'sessions': '/api/sessions/',
                        'interviews': '/api/interviews/',
                        'my-interviews': '/api/interviews/',
                        'questions': '/api/question-bank/',
                        'student-sessions': '/api/admin/student-sessions/'
                    };
                    const prefix = prefixBySection[section] || '';
                    if (!prefix) {
                        showError('Error: Cannot resolve endpoint for section');
                        return;
                    }

                    let successCount = 0;
                    for (const id of ids) {
                        try {
                            const res = await fetch(`${prefix}${id}`, {
                                method: 'PUT',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ [dbField]: value })
                            });
                            const json = await res.json();
                            if (res.ok && json.success) successCount++;
                        } catch (e) {
                            console.warn('Individual update failed for id', id, e);
                        }
                    }

                    if (successCount > 0) {
                        showSuccess(`Successfully updated ${successCount} of ${ids.length} records`);
                    } else {
                        showError('Error updating records: No valid fields to update');
                    }
                }

                // Common post-update refresh
                closeBulkEditModal();
                clearSelection();
                reloadCurrentTab();
            } catch (error) {
                console.error('Error applying bulk edit:', error);
                showError('Error applying bulk edit');
            } finally {
                // Hide spinner
                if (section) {
                    hideLoadingSpinner(section);
                }
            }
        }
        async function startEdit(rowId, data) {
            if (currentEditRow) {
                cancelEdit();
            }
            
            // Derive row data if not provided to avoid inline JSON issues
            let resolvedData = data;
            if (!resolvedData) {
                // Prefer currentSection for robustness across tabs
                const active = document.querySelector('.nav-link.active');
                const section = (typeof currentSection !== 'undefined' && currentSection) ? currentSection : (active ? active.dataset.section : '');
                if (section === 'sessions') {
                    resolvedData = (sessions || []).find(s => String(s.id) === String(rowId));
                } else if (section === 'students') {
                    resolvedData = (students || []).find(s => String(s.id) === String(rowId));
                } else if (section === 'interviews') {
                    resolvedData = (interviews || []).find(i => String(i.id) === String(rowId));
                } else if (section === 'questions') {
                    resolvedData = (questions || []).find(q => String(q.id) === String(rowId));
                } else if (section === 'my-interviews') {
                    // my interviews reuse interviews data loaded for admin
                    resolvedData = (interviews || []).find(i => String(i.id) === String(rowId));
                } else if (section === 'users') {
                    resolvedData = (users || []).find(u => String(u.id) === String(rowId));
                } else if (section === 'student-sessions') {
                    resolvedData = (studentSessions || []).find(s => String(s.id) === String(rowId));
                }
            }

            if (!resolvedData) {
                console.warn('startEdit: could not resolve row data for id', rowId);
            }

            currentEditRow = rowId;
            currentEditData = resolvedData ? { ...resolvedData } : null;
            
            const activeSection = (typeof currentSection !== 'undefined' && currentSection) ? currentSection : (document.querySelector('.nav-link.active') ? document.querySelector('.nav-link.active').dataset.section : '');
            const sectionEl = activeSection ? document.getElementById(activeSection) : null;
            const row = sectionEl ? sectionEl.querySelector(`[data-row-id="${rowId}"]`) : document.querySelector(`#${activeSection} [data-row-id="${rowId}"]`);
            if (!row) {
                console.warn('startEdit: no table row found for id', rowId);
                return;
            }
            row.classList.add('editing');
            
            // Replace content with edit form
            const cells = row.querySelectorAll('td:not(:last-child)');
            for (const cell of cells) {
                const field = cell.dataset.field;
                if (!field) continue;

                // Skip non-editable/computed fields
                const nonEditable = ['id', 'interview_count', 'created_by_name', 'created_at', 'student_name', 'zeta_id', 'session_name', 'duration_seconds', 'interviewer_name', 'interview_date'];
                // For interviews sections, also make status non-editable
                // For questions section, make times_asked, average_score, and success_rate non-editable
                const questionsNonEditable = ['times_asked', 'average_score', 'success_rate'];
                if (nonEditable.includes(field) ||
                    ((activeSection === 'interviews' || activeSection === 'my-interviews') && field === 'status') ||
                    (activeSection === 'questions' && questionsNonEditable.includes(field))) continue;

                // Special handling for Students: split name into first_name and last_name
                if ((typeof currentSection !== 'undefined' && currentSection === 'students') && field === 'name') {
                    // Handle both cases: if name field exists or if first_name/last_name exist separately
                    let first = '';
                    let last = '';
                    
                    if (currentEditData) {
                        if (currentEditData.name) {
                            // If name field exists, split it
                            const nameParts = currentEditData.name.split(' ');
                            first = nameParts[0] || '';
                            last = nameParts.slice(1).join(' ') || '';
                        } else {
                            // If separate first_name/last_name fields exist
                            first = currentEditData.first_name || '';
                            last = currentEditData.last_name || '';
                        }
                    }
                    
                    cell.innerHTML = `
                        <input type="text" id="edit-${rowId}-first_name" name="first_name" class="edit-input" value="${first}" data-field="first_name" placeholder="First name" style="margin-right:6px;">
                        <input type="text" id="edit-${rowId}-last_name" name="last_name" class="edit-input" value="${last}" data-field="last_name" placeholder="Last name">
                    `;
                    continue;
                }

                // Special handling for Sessions: panelists multi-select and status dropdown
                if ((typeof currentSection !== 'undefined' && currentSection === 'sessions')) {
                    if (field === 'panelists') {
                    if (!allInterviewers || allInterviewers.length === 0) {
                        try { await loadAllInterviewers(); } catch {}
                    }
                    const selectedIds = Array.isArray(currentEditData?.panelist_ids) ? currentEditData.panelist_ids.map(String) : [];
                    const selectId = `panelist-select-${rowId}`;
                    const options = (allInterviewers || []).map(interv => `<option value="${interv.id}" ${selectedIds.includes(String(interv.id)) ? 'selected' : ''}>${interv.name} (${interv.email})</option>`).join('');
                    cell.innerHTML = `
                        <div>
                            <select id="${selectId}" class="edit-select" multiple size="4" data-field="panelists" style="min-width:260px">
                                ${options}
                            </select>
                            <div style="margin-top:6px;display:flex;gap:6px;align-items:center">
                                <input type="email" id="new-panelist-email-${rowId}" class="edit-input" placeholder="new.panelist@example.com" style="flex:1">
                                <button class="btn btn-secondary" type="button" onclick="addNewInterviewerFromEdit('${rowId}')">Add New</button>
                            </div>
                        </div>
                    `;
                    continue;
                    } else if (field === 'status') {
                        const currentStatus = currentEditData ? currentEditData.status : '';
                        cell.innerHTML = `
                            <select class="edit-input" data-field="status">
                                <option value="active" ${currentStatus === 'active' ? 'selected' : ''}>Active</option>
                                <option value="inactive" ${currentStatus === 'inactive' ? 'selected' : ''}>Inactive</option>
                            </select>
                    `;
                    continue;
                    }
                }

                // Special handling for Users: role and status dropdowns
                if ((typeof currentSection !== 'undefined' && currentSection === 'users')) {
                    if (field === 'role') {
                        const currentRole = currentEditData ? currentEditData.role : '';
                        cell.innerHTML = `
                            <select class="edit-input" data-field="role">
                                <option value="superadmin" ${currentRole === 'superadmin' ? 'selected' : ''}>Super Admin</option>
                                <option value="admin" ${currentRole === 'admin' ? 'selected' : ''}>Admin</option>
                                <option value="interviewer" ${currentRole === 'interviewer' ? 'selected' : ''}>Interviewer</option>
                            </select>
                        `;
                        continue;
                    } else if (field === 'is_superadmin') {
                        const currentSuperAdmin = currentEditData ? currentEditData.is_superadmin : false;
                        cell.innerHTML = `
                            <select class="edit-input" data-field="is_superadmin">
                                <option value="false" ${!currentSuperAdmin ? 'selected' : ''}>Regular User</option>
                                <option value="true" ${currentSuperAdmin ? 'selected' : ''}>Super Admin</option>
                            </select>
                        `;
                        continue;
                    }
                }

                // Special handling for Interviews: allow editing verdict and meeting_url
                if ((typeof currentSection !== 'undefined' && (currentSection === 'interviews' || currentSection === 'my-interviews'))) {
                    // Skip status field entirely - don't allow editing
                    if (field === 'status') {
                        continue;
                    } else if (field === 'verdict') {
                        const currentVerdict = currentEditData ? currentEditData.verdict : '';
                        cell.innerHTML = `
                            <select class="edit-input" data-field="verdict">
                                <option value="" ${!currentVerdict ? 'selected' : ''}>Select Verdict...</option>
                                <option value="Tiger" ${currentVerdict === 'Tiger' ? 'selected' : ''}>Tiger</option>
                                <option value="Cow" ${currentVerdict === 'Cow' ? 'selected' : ''}>Cow</option>
                                <option value="Sheep" ${currentVerdict === 'Sheep' ? 'selected' : ''}>Sheep</option>
                            </select>
                        `;
                        continue;
                    } else if (field === 'meeting_url') {
                        const currentUrl = currentEditData ? (currentEditData.meeting_url || '') : '';
                        cell.innerHTML = `
                            <input type="url" class="edit-input" data-field="meeting_url" value="${currentUrl}" placeholder="https://..." style="width: 100%;">
                        `;
                        continue;
                    } else {
                        // Skip other fields for interviews - only verdict and meeting_url are editable
                        continue;
                    }
                }

                // Special handling for Student Sessions: only allow editing session_status with dropdown
                if ((typeof currentSection !== 'undefined' && currentSection === 'student-sessions')) {
                    if (field === 'session_status') {
                        const statusOptions = ['No show', 'Disqualified', 'Age Mismatch', 'Degree holder', 'Interviewer unavailable'];
                        const currentStatus = currentEditData ? currentEditData.session_status : '';
                        const statusOptionsHTML = statusOptions.map(opt => 
                            `<option value="${opt}" ${currentStatus === opt ? 'selected' : ''}>${opt}</option>`
                        ).join('');
                        cell.innerHTML = `
                            <select class="edit-input" data-field="session_status" style="min-width:200px">
                                <option value="">Select Status...</option>
                                ${statusOptionsHTML}
                            </select>
                        `;
                        continue;
                    } else {
                        // Skip other fields for student-sessions - only session_status is editable
                        continue;
                    }
                }

                // Special handling for Questions: use textarea for question field and input for tags
                if ((typeof currentSection !== 'undefined' && currentSection === 'questions')) {
                    if (field === 'question') {
                        const currentValue = currentEditData ? currentEditData.question_text || currentEditData.question : cell.textContent.trim();
                        cell.innerHTML = `
                            <textarea id="edit-${rowId}-question" name="question" class="edit-input" data-field="question"
                                      rows="4" style="width: 100%; resize: vertical; min-height: 80px;">${currentValue}</textarea>
                        `;
                        continue;
                    } else if (field === 'tags') {
                        const currentTags = currentEditData && currentEditData.tags && Array.isArray(currentEditData.tags) ?
                            currentEditData.tags.join(', ') : '';
                        cell.innerHTML = `
                            <input type="text" id="edit-${rowId}-tags" name="tags" class="edit-input" data-field="tags"
                                   value="${currentTags}" placeholder="tag1, tag2, tag3" style="width: 100%;">
                        `;
                        continue;
                    }
                }

                // Default text input for other editable fields
                const currentValue = cell.textContent.trim();
                const inputId = `edit-${rowId}-${field}`;
                cell.innerHTML = `<input type="text" id="${inputId}" name="${field}" class="edit-input" value="${currentValue}" data-field="${field}">`;
            }
            
            // Replace action buttons
            const actionCell = row.querySelector('td:last-child');
            actionCell.innerHTML = `
                <button class="icon-btn save-btn" onclick="saveEdit('${rowId}')" title="Save"></button>
                <button class="icon-btn cancel-btn" onclick="cancelEdit('${rowId}')" title="Cancel"></button>
            `;
        }

        function cancelEdit(rowId) {
            if (!rowId && !currentEditRow) return;
            
            const targetRowId = rowId || currentEditRow;
            const activeSection = (typeof currentSection !== 'undefined' && currentSection) ? currentSection : (document.querySelector('.nav-link.active') ? document.querySelector('.nav-link.active').dataset.section : '');
            const sectionEl = activeSection ? document.getElementById(activeSection) : null;
            const row = sectionEl ? sectionEl.querySelector(`[data-row-id="${targetRowId}"]`) : document.querySelector(`#${activeSection} [data-row-id="${targetRowId}"]`);
            
            if (row) {
                row.classList.remove('editing');
                
                // Restore original content for this specific row
                if (currentEditData) {
                    restoreRowContent(row, currentEditData);
                } else {
                    // If no original data, refresh the entire tab
                    const activeTab = document.querySelector('.nav-link.active');
                    if (activeTab) {
                        activeTab.click();
                    }
                }
            }
            
            // Clear edit state
            currentEditRow = null;
            currentEditData = null;
        }

        function restoreRowContent(row, originalData) {
            const section = (typeof currentSection !== 'undefined' && currentSection) ? currentSection : (document.querySelector('.nav-link.active') ? document.querySelector('.nav-link.active').dataset.section : '');
            
            // Restore cells based on current tab
            const cells = row.querySelectorAll('td:not(:last-child)');
            cells.forEach((cell, index) => {
                const field = cell.dataset.field;
                // Special handling for panelists field which maps to panelist_names in data
                const isSpecialField = (field === 'panelists' && section === 'sessions');
                if (field && (originalData[field] !== undefined || isSpecialField)) {
                    let displayValue = originalData[field] || 'N/A';
                    
                    // Handle special field formatting
                    if (field === 'status') {
                        const statusClass = displayValue === 'active' ? 'status-active' : 
                                           displayValue === 'inactive' ? 'status-inactive' : 'status-suspended';
                        cell.innerHTML = `<span class="status-badge ${statusClass}">${displayValue}</span>`;
                    } else if (field === 'is_superadmin') {
                        // For authorized_users, show "Active" status since all authorized users are active
                        cell.innerHTML = `<span class="status-badge status-active">Active</span>`;
                    } else if (field === 'role') {
                        const roleClass = displayValue === 'superadmin' ? 'role-superadmin' :
                                         displayValue === 'admin' ? 'role-admin' : 'role-interviewer';
                        cell.innerHTML = `<span class="role-badge ${roleClass}">${displayValue}</span>`;
                    } else if (field === 'created_at' || field === 'interview_date') {
                        displayValue = formatDate(originalData[field]);
                        cell.textContent = displayValue;
                    } else if (field === 'duration_seconds') {
                        displayValue = formatDuration(originalData[field]);
                        cell.textContent = displayValue;
                    } else if (field === 'name' && section === 'students') {
                        // For students, name is computed from first_name + last_name
                        displayValue = `${originalData.first_name || ''} ${originalData.last_name || ''}`.trim();
                        cell.textContent = displayValue;
                    } else if (field === 'question' && section === 'questions') {
                        // For questions, handle favorite button
                        const favoriteBtn = favoriteQuestionIds && favoriteQuestionIds.has(originalData.id) ? '' : '';
                        const favoriteClass = favoriteQuestionIds && favoriteQuestionIds.has(originalData.id) ? 'favorited' : '';
                        cell.innerHTML = `
                            <span>${displayValue}</span>
                            <button 
                                class="favorite-btn ${favoriteClass}"
                                onclick="toggleFavorite(${originalData.id})"
                                title="${favoriteQuestionIds && favoriteQuestionIds.has(originalData.id) ? 'Remove from favorites' : 'Add to favorites'}"
                                style="margin-left:8px"
                            >${favoriteBtn}</button>
                        `;
                    } else if (field === 'panelists' && section === 'sessions') {
                        // For sessions, restore panelists as simple text (panelist_names)
                        displayValue = originalData.panelist_names || '';
                        // Clear any child elements (like select dropdown) and set text
                        cell.innerHTML = '';
                        cell.textContent = displayValue;
                    } else {
                        cell.textContent = displayValue;
                    }
                }
            });
            
            // Restore action buttons based on current tab
            const actionCell = row.querySelector('td:last-child');
            if (section === 'students') {
                actionCell.innerHTML = `
                    <button class="icon-btn edit-btn" onclick="startEdit('${originalData.id}')" title="Edit"><img src="/edit.png" alt="Edit" style="width:16px;height:16px;vertical-align:middle"></button>
                    <button class="icon-btn delete-btn" onclick="deleteRecord('${originalData.id}', 'student')" title="Delete"><img src="/delete.png" alt="Delete" style="width:16px;height:16px;vertical-align:middle"></button>
                    <button class="icon-btn" onclick="viewStudent(${originalData.id})" title="View"><img src="/view.png" alt="View" style="width:16px;height:16px;vertical-align:middle"></button>
                `;
            } else if (section === 'sessions') {
                actionCell.innerHTML = `
                    <button class="icon-btn edit-btn" onclick="startEdit('${originalData.id}')" title="Edit"><img src="/edit.png" alt="Edit" style="width:16px;height:16px;vertical-align:middle"></button>
                    <button class="icon-btn delete-btn" onclick="deleteSession('${originalData.id}')" title="Delete"><img src="/delete.png" alt="Delete" style="width:16px;height:16px;vertical-align:middle"></button>
                    <button class="icon-btn" onclick="viewSession(${originalData.id})" title="View"><img src="/view.png" alt="View" style="width:16px;height:16px;vertical-align:middle"></button>
                `;
            } else if (section === 'interviews' || section === 'my-interviews') {
                actionCell.innerHTML = `
                    <button class="icon-btn edit-btn" onclick="startEdit('${originalData.id}')" title="Edit"><img src="/edit.png" alt="Edit" style="width:16px;height:16px;vertical-align:middle"></button>
                    <button class="icon-btn delete-btn" onclick="deleteInterview('${originalData.id}')" title="Delete"><img src="/delete.png" alt="Delete" style="width:16px;height:16px;vertical-align:middle"></button>
                    <button class="icon-btn" onclick="viewInterview(${originalData.id})" title="View"><img src="/view.png" alt="View" style="width:16px;height:16px;vertical-align:middle"></button>
                `;
            } else if (section === 'questions') {
                actionCell.innerHTML = `
                    <button class="icon-btn edit-btn" onclick="startEdit('${originalData.id}')" title="Edit"><img src="/edit.png" alt="Edit" style="width:16px;height:16px;vertical-align:middle"></button>
                    <button class="icon-btn delete-btn" onclick="deleteQuestion('${originalData.id}')" title="Delete"><img src="/delete.png" alt="Delete" style="width:16px;height:16px;vertical-align:middle"></button>
                    <button class="icon-btn" onclick="viewQuestion(${originalData.id})" title="View"><img src="/view.png" alt="View" style="width:16px;height:16px;vertical-align:middle"></button>
                `;
            } else if (section === 'users') {
                // For users section, restore the original action buttons with menu
                const user = originalData;
                const status = user.is_superadmin ? 'superadmin' : (user.role || 'interviewer');
                const isInterviewer = user.role && (user.role.toLowerCase() === 'interviewer' || user.role === 'interviewer');
                const isAdmin = user.role && (user.role.toLowerCase() === 'admin' || user.role === 'admin');

                actionCell.innerHTML = `
                    <div class="action-menu-container">
                        <button class="icon-btn menu-btn" onclick="toggleUserMenu(${user.id})" title="More Actions"></button>
                        <div id="user-menu-${user.id}" class="user-action-menu hidden">
                            ${isInterviewer ? `<button onclick="promoteToAdmin(${user.id})" class="menu-item">Make as Admin</button>` : ''}
                            ${isAdmin ? `<button onclick="promoteToSuperAdmin(${user.id})" class="menu-item">Make as Super Admin</button>` : ''}
                            <button onclick="deactivateUser(${user.id})" class="menu-item">Deactivate User</button>
                        </div>
                    </div>
                    <button class="icon-btn edit-btn" onclick="startEdit(${user.id})" title="Edit"><img src="/edit.png" alt="Edit" style="width:16px;height:16px;vertical-align:middle"></button>
                    <button class="icon-btn view-btn" onclick="viewUser(${user.id})" title="View Details"><img src="/view.png" alt="View" style="width:16px;height:16px;vertical-align:middle"></button>
                    <button class="icon-btn delete-btn" onclick="deleteUser(${user.id})" title="Delete"><img src="/delete.png" alt="Delete" style="width:16px;height:16px;vertical-align:middle"></button>
                `;
            } else if (section === 'student-sessions') {
                actionCell.innerHTML = `
                    <button class="icon-btn edit-btn" onclick="startEdit('${originalData.id}', ${JSON.stringify(originalData).replace(/"/g, '&quot;')})" title="Edit"><img src="/edit.png" alt="Edit" style="width:16px;height:16px;vertical-align:middle"></button>
                `;
            }
        }

        async function saveEdit(rowId) {
            try {
                const activeSection = (typeof currentSection !== 'undefined' && currentSection) ? currentSection : (document.querySelector('.nav-link.active') ? document.querySelector('.nav-link.active').dataset.section : '');
                const sectionEl = activeSection ? document.getElementById(activeSection) : null;
                const row = sectionEl ? sectionEl.querySelector(`[data-row-id="${rowId}"]`) : document.querySelector(`#${activeSection} [data-row-id="${rowId}"]`);
                const inputs = row.querySelectorAll('.edit-input');
                const updateData = {};

                // Define valid database fields for each tab
                const validFieldsBySection = {
                    'students': ['first_name', 'last_name', 'email', 'phone', 'address', 'zeta_id'],
                    'sessions': ['name', 'description', 'status'],
                    'interviews': ['verdict', 'status', 'overall_notes', 'meeting_url'],
                    'my-interviews': ['verdict', 'status', 'overall_notes', 'meeting_url'],
                    'questions': ['question', 'category', 'tags'],
                    'users': ['name', 'email', 'role', 'is_superadmin'],
                    'student-sessions': ['session_status']
                };

                const section = (typeof currentSection !== 'undefined' && currentSection) ? currentSection : (document.querySelector('.nav-link.active') ? document.querySelector('.nav-link.active').dataset.section : '');
                const allowedFields = validFieldsBySection[section] || [];

                inputs.forEach(input => {
                    const field = input.dataset.field;
                    if (allowedFields.includes(field)) {
                        updateData[field] = input.value;
                    } else {
                        // panelists is handled separately for sessions
                        if (!(section === 'sessions' && field === 'panelists')) {
                            console.warn(`Field "${field}" is not editable in section: ${section}`);
                        }
                    }
                });

                // Special handling for tags field in questions - convert comma-separated string to array
                if (section === 'questions' && updateData.tags) {
                    updateData.tags = updateData.tags.split(',')
                        .map(tag => tag.trim())
                        .filter(tag => tag.length > 0);
                }

                // Always capture panelists selection for sessions, even if not in allowedFields
                if (section === 'sessions') {
                    const select = document.querySelector(`#panelist-select-${rowId}`);
                    const ids = Array.from(select ? select.selectedOptions : []).map(o => parseInt(o.value)).filter(n => !Number.isNaN(n));
                    updateData['panelist_ids'] = ids;
                }

                if (Object.keys(updateData).length === 0) {
                    showError('No valid fields to update');
                    return;
                }
                
                let endpoint = '';
                
                if (section === 'students') {
                    endpoint = `/api/students/${rowId}`;
                } else if (section === 'sessions') {
                    endpoint = `/api/sessions/${rowId}`;
                } else if (section === 'interviews' || section === 'my-interviews') {
                    endpoint = `/api/interviews/${rowId}`;
                } else if (section === 'questions') {
                    endpoint = `/api/question-bank/${rowId}`;
                } else if (section === 'users') {
                    endpoint = `/api/authorized-users/${rowId}`;
                } else if (section === 'student-sessions') {
                    endpoint = `/api/admin/student-sessions/${rowId}`;
                }
                
                const response = await fetch(endpoint, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(updateData)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    // Update panelists if provided
                    if (section === 'sessions') {
                        try {
                            await fetch(`/api/sessions/${rowId}/panelists`, {
                                method: 'PUT',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ panelist_ids: Array.isArray(updateData.panelist_ids) ? updateData.panelist_ids : [] })
                            });
                        } catch (e) { console.warn('Panelists update failed:', e); }
                    }
                    showSuccess('Record updated successfully');
                    // Exit edit mode (remove editing class for the row, clear state)
                    const activeSection = (typeof currentSection !== 'undefined' && currentSection) ? currentSection : (document.querySelector('.nav-link.active') ? document.querySelector('.nav-link.active').dataset.section : '');
                    const sectionEl = activeSection ? document.getElementById(activeSection) : null;
                    const editedRow = sectionEl ? sectionEl.querySelector(`[data-row-id="${rowId}"]`) : document.querySelector(`#${activeSection} [data-row-id="${rowId}"]`);
                    if (editedRow) editedRow.classList.remove('editing');
                    currentEditRow = null;
                    currentEditData = null;
                    // Reload the active tab's data to reflect latest DB values
                    reloadCurrentTab();
                } else {
                    showError('Error updating record: ' + result.error);
                }
            } catch (error) {
                console.error('Error saving edit:', error);
                showError('Error saving edit');
            }
        }

        async function deleteRecord(rowId, type) {
            // Confirm delete popup
            const proceed = await new Promise(resolve => {
                const overlay = document.createElement('div');
                overlay.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.35);display:flex;align-items:center;justify-content:center;z-index:2000;';
                overlay.innerHTML = `
                  <div style="background:#fff;border:1px solid #e5e7eb;border-radius:8px;min-width:300px;max-width:90%;padding:16px;box-shadow:0 10px 20px rgba(0,0,0,0.15)">
                    <div style="font-weight:600;margin-bottom:8px;color:#111827">Delete ${type}?</div>
                    <div style="font-size:14px;color:#374151;margin-bottom:12px">Are you sure you want to delete this ${type}?</div>
                    <div style="display:flex;gap:8px;justify-content:flex-end">
                      <button id="del-cancel" style="border:1px solid #e5e7eb;background:#fff;padding:6px 10px;border-radius:6px;cursor:pointer">Cancel</button>
                      <button id="del-ok" style="background:#dc2626;color:#fff;border:none;padding:6px 10px;border-radius:6px;cursor:pointer">Delete</button>
                    </div>
                  </div>`;
                document.body.appendChild(overlay);
                overlay.querySelector('#del-cancel').onclick = ()=> { overlay.remove(); resolve(false); };
                overlay.querySelector('#del-ok').onclick = ()=> { overlay.remove(); resolve(true); };
            });
            if (!proceed) return;

            try {
                const section = (typeof currentSection !== 'undefined' && currentSection) ? currentSection : (document.querySelector('.nav-link.active') ? document.querySelector('.nav-link.active').dataset.section : '');
                let endpoint = '';

                if (section === 'students') {
                    endpoint = `/api/students/${rowId}`;
                } else if (section === 'sessions') {
                    endpoint = `/api/sessions/${rowId}`;
                } else if (section === 'interviews' || section === 'my-interviews') {
                    endpoint = `/api/interviews/${rowId}`;
                } else if (section === 'questions') {
                    endpoint = `/api/question-bank/${rowId}`;
                } else if (section === 'users') {
                    endpoint = `/api/authorized-users/${rowId}`;
                }

                const response = await fetch(endpoint, {
                    method: 'DELETE'
                });

                const result = await response.json();

                if (result.success) {
                    showSuccess(`${type} deleted successfully`);
                    reloadCurrentTab();
                } else {
                    showError(`Error deleting ${type}: ${result.error}`);
                }
            } catch (error) {
                console.error(`Error deleting ${type}:`, error);
                showError(`Error deleting ${type}`);
            }
        }

        // Specific delete functions for better UX
        async function deleteSession(sessionId) {
            await deleteRecord(sessionId, 'session');
        }

        async function deleteInterview(interviewId) {
            await deleteRecord(interviewId, 'interview');
        }

        async function deleteQuestion(questionId) {
            await deleteRecord(questionId, 'question');
        }

        // Bulk Import Functions
        let selectedFile = null;
        let parsedData = [];

        function openBulkImportModal() {
            const modal = document.getElementById('bulk-import-modal');
            modal.classList.add('active');
            resetImportModal();
            
            // Tab switching
            document.getElementById('text-import-tab').onclick = () => {
                document.getElementById('text-import-section').style.display = 'block';
                document.getElementById('file-import-section').style.display = 'none';
                document.getElementById('text-import-tab').style.background = '#3b82f6';
                document.getElementById('text-import-tab').style.color = '#fff';
                document.getElementById('file-import-tab').style.background = '#f9fafb';
                document.getElementById('file-import-tab').style.color = '#000';
            };
            
            document.getElementById('file-import-tab').onclick = () => {
                document.getElementById('text-import-section').style.display = 'none';
                document.getElementById('file-import-section').style.display = 'block';
                document.getElementById('file-import-tab').style.background = '#3b82f6';
                document.getElementById('file-import-tab').style.color = '#fff';
                document.getElementById('text-import-tab').style.background = '#f9fafb';
                document.getElementById('text-import-tab').style.color = '#000';
            };
            
            // File selection
            document.getElementById('file-select-btn').onclick = () => {
                document.getElementById('bulk-import-file').click();
            };
            
            document.getElementById('bulk-import-file').onchange = async (e) => {
                const file = e.target.files[0];
                if (file) {
                    document.getElementById('selected-file-name').textContent = file.name;
                    document.getElementById('selected-file-info').style.display = 'block';
                    
                    // Parse the file
                    try {
                        selectedFile = file;
                        parsedData = await parseFile(file);
                        console.log('Parsed data:', parsedData);
                        
                        // Show preview
                        if (parsedData.length > 0) {
                            showImportPreview(parsedData);
                        }
                    } catch (error) {
                        console.error('Error parsing file:', error);
                        showError('Error parsing file: ' + error.message);
                        selectedFile = null;
                        parsedData = [];
                    }
                }
                updateImportButtonState();
            };
            
            document.getElementById('remove-file-btn').onclick = () => {
                document.getElementById('bulk-import-file').value = '';
                document.getElementById('selected-file-info').style.display = 'none';
                updateImportButtonState();
            };
            
            // Add event listeners to enable/disable import button
            document.getElementById('bulk-questions-text').addEventListener('input', updateImportButtonState);
            document.getElementById('bulk-import-file').addEventListener('change', updateImportButtonState);
        }
        
        function updateImportButtonState() {
            const textInput = document.getElementById('bulk-questions-text').value.trim();
            const fileInput = document.getElementById('bulk-import-file').files.length > 0;
            const importBtn = document.getElementById('import-btn');
            
            importBtn.disabled = !(textInput || fileInput);
        }

        function closeBulkImportModal() {
            const modal = document.getElementById('bulk-import-modal');
            modal.classList.remove('active');
            resetImportModal();
        }

        function resetImportModal() {
            selectedFile = null;
            parsedData = [];
            document.getElementById('bulk-import-file').value = '';
            document.getElementById('bulk-questions-text').value = '';
            document.getElementById('selected-file-info').style.display = 'none';
            document.getElementById('import-preview').style.display = 'none';
            document.getElementById('import-progress').style.display = 'none';
            document.getElementById('import-results').style.display = 'none';
            updateImportButtonState();
        }

        // Parse uploaded file
        async function parseFile(file) {
            const questions = [];
            const fileExtension = file.name.split('.').pop().toLowerCase();
            
            if (fileExtension === 'csv') {
                const text = await file.text();
                const lines = text.split('\n').filter(line => line.trim());
                
                // Skip header row if it exists
                for (let i = 0; i < lines.length; i++) {
                    const line = lines[i].trim();
                    if (!line) continue;
                    
                    // Skip header row if it contains 'question' or 'tag'
                    if (i === 0 && (line.toLowerCase().includes('question') || line.toLowerCase().includes('tag') || line.toLowerCase().includes('category'))) {
                        continue;
                    }
                    
                    // Use proper CSV parsing that handles quoted fields
                    const parsed = parseCSVLine(line);
                    if (parsed.length >= 2) {
                        // Parse tags from second column
                        const tagsString = parsed[1].trim();
                        let tags = [];
                        if (tagsString) {
                            // Extract hashtags (words starting with #)
                            tags = tagsString.match(/#\w+/g) || [];
                            tags = tags.map(tag => tag.substring(1)); // Remove # prefix
                        }
                        
                        questions.push({
                            question: parsed[0].trim(),
                            tags: tags.length > 0 ? tags : ['general']
                        });
                    } else if (parsed.length === 1) {
                        // If only one column, treat it as question with default tag
                        questions.push({
                            question: parsed[0].trim(),
                            tags: ['general']
                        });
                    }
                }
            } else if (fileExtension === 'xlsx' || fileExtension === 'xls') {
                // For Excel files, we'll need to use a library like SheetJS
                // For now, show an error message
                throw new Error('Excel file support requires additional setup. Please use CSV format for now.');
            } else {
                throw new Error('Unsupported file format. Please use CSV, XLSX, or XLS files.');
            }
            
            return questions;
        }

        async function handleFileSelect() {
            const fileInput = document.getElementById('bulk-import-file');
            const file = fileInput.files[0];
            
            if (!file) {
                resetImportModal();
                return;
            }

            selectedFile = file;
            document.getElementById('import-btn').disabled = false;

            try {
                // Parse the file using the new parseFile function
                parsedData = await parseFile(file);

                // Show preview
                showImportPreview(parsedData);
            } catch (error) {
                console.error('Error parsing file:', error);
                showError('Error parsing file: ' + error.message);
            }
        }

        async function parseCSV(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const text = e.target.result;
                        const lines = text.split('\n').filter(line => line.trim());
                        const data = [];
                        
                        for (let i = 0; i < lines.length; i++) {
                            const line = lines[i].trim();
                            if (!line) continue;
                            
                            // Skip header row if it exists
                            if (i === 0 && (line.toLowerCase().includes('question') || line.toLowerCase().includes('category'))) {
                                continue;
                            }
                            
                            // Proper CSV parsing that handles quoted fields
                            const parsed = parseCSVLine(line);
                            if (parsed.length >= 2) {
                                data.push({
                                    question: parsed[0].trim(),
                                    category: parsed[1].trim() || 'General'
                                });
                            } else if (parsed.length === 1) {
                                // If only one column, treat it as question with default category
                                data.push({
                                    question: parsed[0].trim(),
                                    category: 'General'
                                });
                            }
                        }
                        
                        console.log(` Parsed ${data.length} questions from CSV`);
                        resolve(data);
                    } catch (error) {
                        reject(error);
                    }
                };
                reader.onerror = () => reject(new Error('Failed to read file'));
                reader.readAsText(file);
            });
        }

        // Proper CSV line parser that handles quoted fields
        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            let i = 0;
            
            while (i < line.length) {
                const char = line[i];
                const nextChar = line[i + 1];
                
                if (char === '"') {
                    if (inQuotes && nextChar === '"') {
                        // Escaped quote
                        current += '"';
                        i += 2;
                    } else {
                        // Toggle quote state
                        inQuotes = !inQuotes;
                        i++;
                    }
                } else if (char === ',' && !inQuotes) {
                    // Field separator
                    result.push(current);
                    current = '';
                    i++;
                } else {
                    current += char;
                    i++;
                }
            }
            
            // Add the last field
            result.push(current);
            
            return result;
        }
        async function parseExcel(file) {
            // For Excel files, we'll use a simple approach
            // In a real implementation, you'd use a library like SheetJS
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        // This is a simplified Excel parser
                        // For production, use a proper Excel parsing library
                        const data = e.target.result;
                        
                        // For now, we'll show an error and suggest CSV
                        reject(new Error('Excel parsing not fully implemented. Please use CSV format for now.'));
                    } catch (error) {
                        reject(error);
                    }
                };
                reader.onerror = () => reject(new Error('Failed to read file'));
                reader.readAsArrayBuffer(file);
            });
        }

        function showImportPreview(data) {
            const previewDiv = document.getElementById('import-preview');
            const contentDiv = document.getElementById('preview-content');
            
            if (data.length === 0) {
                contentDiv.innerHTML = '<p>No data found in file.</p>';
                previewDiv.style.display = 'block';
                return;
            }

            const previewData = data.slice(0, 5); // Show first 5 rows
            const tableHTML = `
                <table class="preview-table">
                    <thead>
                        <tr>
                            <th>Question</th>
                            <th>Tags</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${previewData.map(row => {
                            const tagsDisplay = row.tags && Array.isArray(row.tags) ? row.tags.map(t => '#' + t).join(' ') : (row.category || 'N/A');
                            return `
                            <tr>
                                <td>${row.question}</td>
                                <td>${tagsDisplay}</td>
                            </tr>
                        `}).join('')}
                    </tbody>
                </table>
                ${data.length > 5 ? `<p><em>... and ${data.length - 5} more rows</em></p>` : ''}
            `;
            
            contentDiv.innerHTML = tableHTML;
            previewDiv.style.display = 'block';
        }
        async function startBulkImport() {
            const importBtn = document.getElementById('import-btn');
            
            // Prevent multiple simultaneous imports
            if (importBtn.disabled) {
                console.log(' Import already in progress, ignoring duplicate request');
                return;
            }
            
            const textSection = document.getElementById('text-import-section');
            const fileSection = document.getElementById('file-import-section');
            let questions = [];
            
            if (textSection.style.display !== 'none') {
                // Text import
                const questionsText = document.getElementById('bulk-questions-text').value.trim();
                
                if (!questionsText) {
                    showError('Please enter questions to import');
                    return;
                }
                
                // Parse questions (format: "Question text | #tag1 #tag2 #tag3")
                const lines = questionsText.split('\n').filter(line => line.trim());
                questions = lines.map((line, index) => {
                    const parts = line.split('|').map(part => part.trim());
                    if (parts.length === 0 || !parts[0]) {
                        throw new Error(`Line ${index + 1}: Empty question text`);
                    }
                    
                    // Parse tags from the second part
                    let tags = [];
                    if (parts[1]) {
                        // Extract hashtags (words starting with #)
                        tags = parts[1].match(/#\w+/g) || [];
                        tags = tags.map(tag => tag.substring(1)); // Remove # prefix
                    }
                    
                    return {
                        question: parts[0],
                        tags: tags.length > 0 ? tags : ['general']
                    };
                });
            } else {
                // File import
                if (!selectedFile || parsedData.length === 0) {
                    showError('No file selected or no data to import');
                    return;
                }
                questions = parsedData;
            }
            
            if (questions.length === 0) {
                showError('No valid questions found');
                return;
            }

            const progressDiv = document.getElementById('import-progress');
            const resultsDiv = document.getElementById('import-results');
            
            // Show progress and disable button
            importBtn.disabled = true;
            importBtn.textContent = 'Importing...';
            progressDiv.style.display = 'block';
            resultsDiv.style.display = 'none';
            
            console.log(` Starting bulk import of ${questions.length} questions at ${new Date().toISOString()}`);

            try {
                // Validate data first
                const validationResult = validateImportData(questions);
                if (!validationResult.isValid) {
                    showImportResults({
                        success: false,
                        message: 'Validation failed',
                        errors: validationResult.errors,
                        warnings: validationResult.warnings
                    });
                    return;
                }
                
                // Show warnings if any
                if (validationResult.warnings && validationResult.warnings.length > 0) {
                    console.log(' Validation warnings:', validationResult.warnings);
                }

                // Use the new bulk import API
                const response = await fetch('/api/question-bank/bulk', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ questions })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showImportResults({
                        success: true,
                        message: `Successfully imported ${result.imported || questions.length} questions!`,
                        imported: result.imported || questions.length,
                        total: questions.length
                    });
                    // Refresh the questions list
                    loadQuestions();
                } else {
                    showImportResults({
                        success: false,
                        message: 'Import failed',
                        errors: [result.error || 'Unknown error']
                    });
                }

            } catch (error) {
                console.error('Import error:', error);
                showImportResults({
                    success: false,
                    message: 'Import failed: ' + error.message
                });
            } finally {
                importBtn.disabled = false;
                importBtn.textContent = 'Import Questions';
                console.log(` Bulk import completed at ${new Date().toISOString()}`);
            }
        }

        function validateImportData(data) {
            const errors = [];
            const warnings = [];
            
            console.log(` Validating ${data.length} questions`);
            
            for (let i = 0; i < data.length; i++) {
                const row = data[i];
                const rowNum = i + 1;
                
                // Check if row exists and has required properties
                if (!row) {
                    errors.push(`Row ${rowNum}: Empty row`);
                    continue;
                }
                
                // Validate question
                if (!row.question || row.question.trim() === '') {
                    errors.push(`Row ${rowNum}: Question is required`);
                } else if (row.question.trim().length < 5) {
                    warnings.push(`Row ${rowNum}: Question is very short (${row.question.trim().length} characters)`);
                } else if (row.question.length > 1000) {
                    errors.push(`Row ${rowNum}: Question is too long (${row.question.length} characters, max 1000)`);
                }
                
                // Validate category
                if (!row.category || row.category.trim() === '') {
                    errors.push(`Row ${rowNum}: Category is required`);
                } else if (row.category.trim().length > 100) {
                    errors.push(`Row ${rowNum}: Category is too long (${row.category.length} characters, max 100)`);
                }
                
                // Check for potential issues
                if (row.question && row.question.includes('  ')) {
                    warnings.push(`Row ${rowNum}: Question contains multiple spaces`);
                }
            }
            
            console.log(` Validation complete: ${errors.length} errors, ${warnings.length} warnings`);
            
            return {
                isValid: errors.length === 0,
                errors,
                warnings
            };
        }

        function updateProgress(percentage, text) {
            const progressFill = document.getElementById('progress-fill');
            const progressText = document.getElementById('progress-text');
            
            progressFill.style.width = percentage + '%';
            progressText.textContent = text;
        }

        function showImportResults(result) {
            const resultsDiv = document.getElementById('import-results');
            const contentDiv = document.getElementById('results-content');
            const progressDiv = document.getElementById('import-progress');
            
            // Hide progress
            progressDiv.style.display = 'none';
            
            // Set result styling
            resultsDiv.className = 'import-results';
            if (result.success) {
                resultsDiv.classList.add('results-success');
            } else if (result.errorCount > 0 && result.successCount > 0) {
                resultsDiv.classList.add('results-warning');
            } else {
                resultsDiv.classList.add('results-error');
            }
            
            // Build results content
            let content = `<p><strong>${result.message}</strong></p>`;
            
            if (result.successCount !== undefined) {
                content += `<p> Successfully imported: ${result.successCount} questions</p>`;
            }
            
            if (result.errorCount > 0) {
                content += `<p> Failed to import: ${result.errorCount} questions</p>`;
            }
            
            if (result.errors && result.errors.length > 0) {
                content += '<h5>Errors:</h5><ul>';
                result.errors.forEach(error => {
                    content += `<li>${error}</li>`;
                });
                content += '</ul>';
            }
            
            if (result.warnings && result.warnings.length > 0) {
                content += '<h5>Warnings:</h5><ul>';
                result.warnings.forEach(warning => {
                    content += `<li>${warning}</li>`;
                });
                content += '</ul>';
            }
            
            contentDiv.innerHTML = content;
            resultsDiv.style.display = 'block';
        }
    </script>

    <!-- Bulk Edit Modal -->
    <div id="bulk-edit-modal" class="bulk-edit-modal" onclick="closeBulkEditModal()">
        <div class="bulk-edit-content" onclick="event.stopPropagation()">
            <div class="bulk-edit-header">
                <h3 class="bulk-edit-title">Bulk Edit Records</h3>
                <button class="close-modal" onclick="closeBulkEditModal()">&times;</button>
            </div>
            <form id="bulk-edit-form" class="bulk-edit-form">
                <div class="form-group">
                    <label class="form-label">Field to Update:</label>
                    <select id="bulk-edit-field" class="form-select" onchange="updateBulkEditFields()">
                        <option value="">Select field...</option>
                    </select>
                </div>
                <div id="bulk-edit-value-group" class="form-group" style="display: none;">
                    <label class="form-label">New Value:</label>
                    <input type="text" id="bulk-edit-value" class="form-input" placeholder="Enter new value...">
                </div>
                <div class="form-group">
                    <label class="form-label">Selected Records:</label>
                    <div id="bulk-edit-selected-count" class="bulk-edit-info">0 records selected</div>
                </div>
            </form>
            <div class="bulk-edit-footer">
                <button class="btn btn-secondary" onclick="closeBulkEditModal()">Cancel</button>
                <button class="btn btn-primary" onclick="applyBulkEdit()">Apply Changes</button>
            </div>
        </div>
    </div>

    <!-- Bulk Import Modal -->
    <div id="bulk-import-modal" class="bulk-edit-modal" onclick="closeBulkImportModal()">
        <div class="bulk-edit-content" onclick="event.stopPropagation()">
            <div class="bulk-edit-header">
                <h3 class="bulk-edit-title">Bulk Import Questions</h3>
                <button class="close-modal" onclick="closeBulkImportModal()">&times;</button>
            </div>
            <!-- Import Method Tabs -->
            <div style="margin-bottom:16px">
                <div style="display:flex;gap:8px;margin-bottom:16px">
                    <button id="text-import-tab" class="import-tab active" style="padding:8px 16px;border:1px solid #d1d5db;background:#3b82f6;color:#fff;border-radius:6px;cursor:pointer">Text Input</button>
                    <button id="file-import-tab" class="import-tab" style="padding:8px 16px;border:1px solid #d1d5db;background:#f9fafb;border-radius:6px;cursor:pointer">File Upload</button>
                </div>
            </div>
            
            <!-- Text Input Section -->
            <div id="text-import-section">
                <div style="margin-bottom:16px;padding:12px;background:#f3f4f6;border-radius:6px;font-size:14px;color:#374151">
                    <strong>Instructions:</strong><br>
                     Enter one question per line<br>
                     Use format: "Question text | #tag1 #tag2 #tag3"<br>
                     Example: "What is JavaScript? | #technical #javascript #frontend"<br>
                     Tags can be separated by spaces and should start with #<br>
                     Multiple tags are supported per question
                </div>
                <div style="margin-bottom:16px">
                    <label style="display:block;margin-bottom:8px;font-weight:500;color:#374151">Questions *</label>
                    <textarea id="bulk-questions-text" style="width:100%;padding:12px;border:1px solid #d1d5db;border-radius:6px;font-size:14px;min-height:200px;resize:vertical;font-family:monospace" placeholder="Enter questions here, one per line..."></textarea>
                </div>
            </div>
            
            <!-- File Upload Section -->
            <div id="file-import-section" style="display:none">
                <div style="margin-bottom:16px;padding:12px;background:#f3f4f6;border-radius:6px;font-size:14px;color:#374151">
                    <strong>CSV Format Instructions:</strong><br>
                     First row can be a header (will be skipped)<br>
                     Format: "Question,Tags" where Tags is like "#tag1 #tag2 #tag3"<br>
                     <strong>Important:</strong> Use quotes around questions that contain commas<br>
                     Example: "What is JavaScript, and how does it work?","#technical #javascript"<br>
                     Example: "Tell me about yourself","#behavioral #interview"<br>
                     Multiple tags should be separated by spaces and start with #
                </div>
                <div style="margin-bottom:16px">
                    <label style="display:block;margin-bottom:8px;font-weight:500;color:#374151">Upload File *</label>
                    <div style="border:2px dashed #d1d5db;border-radius:8px;padding:24px;text-align:center;background:#f9fafb">
                        <input type="file" id="bulk-import-file" accept=".csv,.xlsx,.xls" style="display:none">
                        <div style="margin-bottom:8px">
                            <span style="font-size:24px"></span>
                        </div>
                        <div style="margin-bottom:8px;font-weight:500">Click to select file or drag and drop</div>
                        <div style="font-size:12px;color:#6b7280">CSV, XLSX, XLS files only</div>
                        <button id="file-select-btn" style="margin-top:12px;background:#3b82f6;color:#fff;border:none;padding:8px 16px;border-radius:6px;cursor:pointer">Select File</button>
                    </div>
                    <div id="selected-file-info" style="margin-top:8px;padding:8px;background:#e0f2fe;border-radius:4px;display:none">
                        <span id="selected-file-name"></span>
                        <button id="remove-file-btn" style="margin-left:8px;background:#ef4444;color:#fff;border:none;padding:4px 8px;border-radius:4px;cursor:pointer;font-size:12px">Remove</button>
                    </div>
                </div>
            </div>
            
            <div id="import-preview" class="import-preview" style="display: none;">
                <h4>Preview (First 5 rows):</h4>
                <div id="preview-content"></div>
            </div>
            <div id="import-progress" class="import-progress" style="display: none;">
                <div class="progress-bar">
                    <div class="progress-fill" id="progress-fill"></div>
                </div>
                <div class="progress-text" id="progress-text">Importing...</div>
            </div>
            <div id="import-results" class="import-results" style="display: none;">
                <h4>Import Results:</h4>
                <div id="results-content"></div>
            </div>
            <div class="bulk-edit-footer">
                <button class="btn btn-secondary" onclick="closeBulkImportModal()">Cancel</button>
                <button class="btn btn-primary" id="import-btn" onclick="startBulkImport()" disabled>Import Questions</button>
            </div>
        </div>
    </div>
    
    <!-- Load Chart.js and set a flag when ready -->
    <script>
        window.chartJsLoaded = false;
        console.log(' Loading Chart.js...');
        
        // Settings Page Functions
        function openSettings() {
            switchSection('settings');
            showSettingsTab('templates');
            showTemplateType('email');
            loadEmailTemplates();
        }
        
        function showSettingsTab(tab) {
            // Hide all content tabs
            document.querySelectorAll('.settings-content').forEach(el => el.style.display = 'none');
            // Remove active class from all nav buttons
            document.querySelectorAll('.settings-nav-btn').forEach(el => {
                el.style.background = '#f3f4f6';
                el.style.color = '#6b7280';
            });
            // Show selected tab
            document.getElementById(`settings-content-${tab}`).style.display = 'block';
            document.getElementById(`settings-tab-${tab}`).style.background = '#3b82f6';
            document.getElementById(`settings-tab-${tab}`).style.color = '#fff';
            
            // Load email logs if email-logs tab is selected
            if (tab === 'email-logs') {
                showEmailLogTab('sent');
            }
            // Load SMS logs if sms-logs tab is selected
            if (tab === 'sms-logs') {
                showSMSLogTab('sent');
            }
        }
        
        // SMS Logs Functions
        let currentSMSLogTab = 'sent';
        
        async function showSMSLogTab(status) {
            currentSMSLogTab = status;
            
            // Update tab buttons
            document.querySelectorAll('.sms-log-tab-btn').forEach(btn => {
                btn.style.background = 'transparent';
                btn.style.color = '#6b7280';
            });
            document.getElementById(`sms-log-tab-${status}`).style.background = '#3b82f6';
            document.getElementById(`sms-log-tab-${status}`).style.color = '#fff';
            
            // Load SMS logs
            await loadSMSLogs(status);
        }
        
        async function loadSMSLogs(status) {
            const logsList = document.getElementById('sms-logs-list');
            logsList.innerHTML = '<div style="text-align:center;padding:40px;color:#6b7280"><p>Loading SMS logs...</p></div>';
            
            try {
                const response = await fetch(`/api/admin/sms-logs?status=${status}`);
                const result = await response.json();
                
                if (!response.ok || !result.success) {
                    throw new Error(result.error || 'Failed to load SMS logs');
                }
                
                const logs = result.data || [];
                
                if (logs.length === 0) {
                    logsList.innerHTML = `
                        <div style="text-align:center;padding:40px;color:#6b7280">
                            <p>No ${status} SMS messages found.</p>
                        </div>
                    `;
                    return;
                }
                
                logsList.innerHTML = logs.map(log => {
                    const sentAt = log.sent_at ? new Date(log.sent_at).toLocaleString() : (log.created_at ? new Date(log.created_at).toLocaleString() : 'N/A');
                    const sentBy = log.sent_by_name || log.sent_by_email || null;
                    const messageType = log.message_type || 'sms';
                    
                    return `
                        <div style="background:#fff;border:1px solid #e5e7eb;border-radius:8px;padding:20px;display:flex;flex-direction:column;gap:12px">
                            <div style="display:flex;justify-content:space-between;align-items:start">
                                <div style="flex:1">
                                    <div style="display:flex;align-items:center;gap:12px;margin-bottom:8px">
                                        <h4 style="margin:0;font-size:16px;color:#111827;font-weight:600">${escapeHtml(messageType.toUpperCase())} Message</h4>
                                        <span style="padding:4px 12px;border-radius:4px;font-size:12px;font-weight:500;background:${
                                            status === 'sent' ? '#d1fae5' : status === 'failed' ? '#fee2e2' : '#e0e7ff'
                                        };color:${
                                            status === 'sent' ? '#065f46' : status === 'failed' ? '#991b1b' : '#3730a3'
                                        }">${status.toUpperCase()}</span>
                                    </div>
                                    <div style="display:flex;flex-wrap:wrap;gap:16px;font-size:14px;color:#6b7280">
                                        <div><strong>From:</strong> ${escapeHtml(log.from_number)}</div>
                                        <div><strong>To:</strong> ${escapeHtml(log.to_numbers)}</div>
                                        <div><strong>Type:</strong> ${escapeHtml(messageType.toUpperCase())}</div>
                                    </div>
                                </div>
                                <div style="text-align:right;font-size:12px;color:#9ca3af">
                                    <div>${sentAt}</div>
                                    ${sentBy ? `<div style="margin-top:4px">By: ${escapeHtml(sentBy)}</div>` : ''}
                                </div>
                            </div>
                            ${log.student_name ? `
                                <div style="padding:8px;background:#f9fafb;border-radius:4px;font-size:14px">
                                    <strong>Student:</strong> ${escapeHtml(log.student_name)} 
                                    ${log.student_email ? `(${escapeHtml(log.student_email)})` : ''}
                                    ${log.zeta_id ? ` | Zeta ID: ${escapeHtml(log.zeta_id)}` : ''}
                                </div>
                            ` : ''}
                            ${log.error_message ? `
                                <div style="padding:8px;background:#fee2e2;border-radius:4px;font-size:14px;color:#991b1b">
                                    <strong>Error:</strong> ${escapeHtml(log.error_message)}
                                </div>
                            ` : ''}
                            <div style="padding:12px;background:#f9fafb;border-radius:4px;max-height:200px;overflow-y:auto">
                                <div style="font-size:14px;color:#374151;line-height:1.6;white-space:pre-wrap">${escapeHtml(log.message || '')}</div>
                            </div>
                            ${status === 'drafted' ? `
                                <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:8px">
                                    <button onclick="openSendSMSFromDraft(${log.id})" class="btn btn-primary" style="padding:8px 16px;font-size:14px">
                                        Send SMS
                                    </button>
                                </div>
                            ` : ''}
                            ${status === 'failed' ? `
                                <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:8px">
                                    <button onclick="openSendSMSFromFailed(${log.id})" class="btn btn-primary" style="padding:8px 16px;font-size:14px">
                                        Edit & Resend
                                    </button>
                                </div>
                            ` : ''}
                        </div>
                    `;
                }).join('');
            } catch (error) {
                console.error('Error loading SMS logs:', error);
                logsList.innerHTML = `
                    <div style="text-align:center;padding:40px;color:#ef4444">
                        <p>Error loading SMS logs: ${escapeHtml(error.message || 'Unknown error')}</p>
                    </div>
                `;
            }
        }
        
        // Open SMS popup from draft
        async function openSendSMSFromDraft(draftId) {
            showSingleEmailLoading('Loading SMS...', 'Preparing SMS for sending');
            try {
                if (!draftId) {
                    throw new Error('Draft ID is required');
                }
                
                const response = await fetch(`/api/admin/sms-logs/${draftId}`);
                
                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    const text = await response.text();
                    throw new Error(`Server error (${response.status}): ${text.substring(0, 100)}`);
                }
                
                const result = await response.json();
                
                if (!response.ok || !result.success) {
                    throw new Error(result.error || 'Failed to load draft');
                }
                
                const log = result.data;
                currentSMSDraftId = log.id;
                currentSMSConsolidationId = log.consolidation_id;
                
                // Prefill form
                const fromEl = document.getElementById('send-sms-from');
                const toEl = document.getElementById('send-sms-to');
                const messageEl = document.getElementById('send-sms-message');
                const typeEl = document.getElementById('send-sms-type');
                const overlayEl = document.getElementById('send-sms-overlay');
                
                if (!fromEl || !toEl || !messageEl || !overlayEl) {
                    throw new Error('SMS form elements not found');
                }
                
                fromEl.value = log.from_number || '';
                messageEl.value = log.message || '';
                if (typeEl) typeEl.value = log.message_type || 'sms';
                
                // Clear and populate phone tags
                clearPhoneTags('to');
                if (log.to_numbers) {
                    const phones = log.to_numbers.split(',').map(p => p.trim()).filter(p => p);
                    phones.forEach(phone => addPhoneTag('to', phone));
                }
                
                // Load templates
                await loadSMSTemplatesForSend();
                
                // Show popup
                overlayEl.style.display = 'block';
                updateSMSCharCount();
            } catch (e) {
                console.error('Error loading SMS draft:', e);
                showError('Failed to load draft: ' + (e.message || e.toString()));
            } finally {
                hideSingleEmailLoading();
            }
        }
        
        // Open SMS popup from failed
        async function openSendSMSFromFailed(failedId) {
            showSingleEmailLoading('Loading SMS...', 'Preparing SMS for editing');
            try {
                await openSendSMSFromDraft(failedId);
            } finally {
                hideSingleEmailLoading();
            }
        }
        
        // Email Logs Functions
        let currentEmailLogTab = 'sent';
        
        async function showEmailLogTab(status) {
            currentEmailLogTab = status;
            
            // Update tab buttons
            document.querySelectorAll('.email-log-tab-btn').forEach(btn => {
                btn.style.background = 'transparent';
                btn.style.color = '#6b7280';
            });
            document.getElementById(`email-log-tab-${status}`).style.background = '#3b82f6';
            document.getElementById(`email-log-tab-${status}`).style.color = '#fff';
            
            // Load email logs
            await loadEmailLogs(status);
        }
        
        async function loadEmailLogs(status) {
            const logsList = document.getElementById('email-logs-list');
            logsList.innerHTML = '<div style="text-align:center;padding:40px;color:#6b7280"><p>Loading email logs...</p></div>';
            
            try {
                const response = await fetch(`/api/admin/email-logs?status=${status}`);
                const result = await response.json();
                
                if (!response.ok || !result.success) {
                    throw new Error(result.error || 'Failed to load email logs');
                }
                
                const logs = result.data || [];
                
                if (logs.length === 0) {
                    logsList.innerHTML = `
                        <div style="text-align:center;padding:40px;color:#6b7280">
                            <p>No ${status} emails found.</p>
                        </div>
                    `;
                    return;
                }
                
                logsList.innerHTML = logs.map(log => {
                    const sentAt = log.sent_at ? new Date(log.sent_at).toLocaleString() : (log.created_at ? new Date(log.created_at).toLocaleString() : 'N/A');
                    // Display sent_by info - hide if no user info available
                    const sentBy = log.sent_by_name || log.sent_by_email || null;
                    const studentInfo = log.student_name ? `${log.student_name} (${log.student_email || 'N/A'})` : log.to_emails;
                    
                    return `
                        <div style="background:#fff;border:1px solid #e5e7eb;border-radius:8px;padding:20px;display:flex;flex-direction:column;gap:12px">
                            <div style="display:flex;justify-content:space-between;align-items:start">
                                <div style="flex:1">
                                    <div style="display:flex;align-items:center;gap:12px;margin-bottom:8px">
                                        <h4 style="margin:0;font-size:16px;color:#111827;font-weight:600">${escapeHtml(log.subject || 'No Subject')}</h4>
                                        <span style="padding:4px 12px;border-radius:4px;font-size:12px;font-weight:500;background:${
                                            status === 'sent' ? '#d1fae5' : status === 'failed' ? '#fee2e2' : '#e0e7ff'
                                        };color:${
                                            status === 'sent' ? '#065f46' : status === 'failed' ? '#991b1b' : '#3730a3'
                                        }">${status.toUpperCase()}</span>
                                    </div>
                                    <div style="display:flex;flex-wrap:wrap;gap:16px;font-size:14px;color:#6b7280">
                                        <div><strong>From:</strong> ${escapeHtml(log.from_email)}</div>
                                        <div><strong>To:</strong> ${escapeHtml(log.to_emails)}</div>
                                        ${log.cc_emails ? `<div><strong>CC:</strong> ${escapeHtml(log.cc_emails)}</div>` : ''}
                                        ${log.bcc_emails ? `<div><strong>BCC:</strong> ${escapeHtml(log.bcc_emails)}</div>` : ''}
                                    </div>
                                </div>
                                <div style="text-align:right;font-size:12px;color:#9ca3af">
                                    <div>${sentAt}</div>
                                    ${sentBy ? `<div style="margin-top:4px">By: ${escapeHtml(sentBy)}</div>` : ''}
                                </div>
                            </div>
                            ${log.student_name ? `
                                <div style="padding:8px;background:#f9fafb;border-radius:4px;font-size:14px">
                                    <strong>Student:</strong> ${escapeHtml(log.student_name)} 
                                    ${log.student_email ? `(${escapeHtml(log.student_email)})` : ''}
                                    ${log.zeta_id ? ` | Zeta ID: ${escapeHtml(log.zeta_id)}` : ''}
                                </div>
                            ` : ''}
                            ${log.error_message ? `
                                <div style="padding:8px;background:#fee2e2;border-radius:4px;font-size:14px;color:#991b1b">
                                    <strong>Error:</strong> ${escapeHtml(log.error_message)}
                                </div>
                            ` : ''}
                            <div style="padding:12px;background:#f9fafb;border-radius:4px;max-height:200px;overflow-y:auto">
                                <div style="font-size:14px;color:#374151;line-height:1.6">${log.message || ''}</div>
                            </div>
                            ${status === 'drafted' ? `
                                <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:8px">
                                    <button onclick="openSendMailFromDraft(${log.id})" class="btn btn-primary" style="padding:8px 16px;font-size:14px">
                                        Send Mail
                                    </button>
                                </div>
                            ` : ''}
                            ${status === 'failed' ? `
                                <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:8px">
                                    <button onclick="openSendMailFromFailed(${log.id})" class="btn btn-primary" style="padding:8px 16px;font-size:14px">
                                        Edit & Resend
                                    </button>
                                </div>
                            ` : ''}
                        </div>
                    `;
                }).join('');
            } catch (error) {
                console.error('Error loading email logs:', error);
                logsList.innerHTML = `
                    <div style="text-align:center;padding:40px;color:#ef4444">
                        <p>Error loading email logs: ${escapeHtml(error.message)}</p>
                    </div>
                `;
            }
        }
        
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // Template Type Switching (Email/SMS)
        function showTemplateType(type) {
            // Hide all template type contents
            document.querySelectorAll('.template-type-content').forEach(el => el.style.display = 'none');
            // Update tab buttons
            document.querySelectorAll('.template-type-btn').forEach(btn => {
                btn.style.background = 'transparent';
                btn.style.color = '#6b7280';
            });
            // Show selected type
            document.getElementById(`template-content-${type}`).style.display = 'block';
            document.getElementById(`template-type-${type}`).style.background = '#3b82f6';
            document.getElementById(`template-type-${type}`).style.color = '#fff';
            
            // Show list view by default
            if (type === 'email') {
                showEmailTemplateList();
                loadEmailTemplates();
            } else if (type === 'sms') {
                showSMSTemplateList();
                loadSMSTemplates();
            }
        }
        
        // Email Template View Functions
        function showEmailTemplateList() {
            document.getElementById('email-template-list-view').style.display = 'block';
            document.getElementById('email-template-form-view').style.display = 'none';
        }
        
        function showEmailTemplateForm(skipReset = false) {
            document.getElementById('email-template-list-view').style.display = 'none';
            document.getElementById('email-template-form-view').style.display = 'block';
            
            // Initialize Quill editor if not already initialized
            setTimeout(() => {
                const editorContainer = document.getElementById('email-template-body-editor');
                if (editorContainer && !emailTemplateQuill) {
                    try {
                        if (typeof Quill !== 'undefined') {
                            emailTemplateQuill = new Quill('#email-template-body-editor', {
                                theme: 'snow',
                                modules: {
                                    toolbar: [
                                        [{ 'header': [1, 2, 3, false] }],
                                        ['bold', 'italic', 'underline', 'strike'],
                                        [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                                        [{ 'align': [] }],
                                        ['link', 'image'],
                                        [{ 'color': [] }, { 'background': [] }],
                                        ['clean']
                                    ]
                                },
                                placeholder: 'Email body content. You can use placeholders like ${student_name}, ${session_name}, etc.'
                            });
                            
                            // Configure link handler to ensure proper URL format
                            const linkHandler = emailTemplateQuill.getModule('toolbar').handlers.link;
                            emailTemplateQuill.getModule('toolbar').handlers.link = function(value) {
                                if (value) {
                                    // Ensure URL has protocol
                                    if (!/^https?:\/\//i.test(value)) {
                                        value = 'https://' + value;
                                    }
                                }
                                linkHandler.call(this, value);
                            };
                            
                            // Intercept link clicks to open in new tab with correct URL
                            emailTemplateQuill.root.addEventListener('click', function(e) {
                                const link = e.target.closest('a');
                                if (link && link.href) {
                                    e.preventDefault();
                                    e.stopPropagation();
                                    let url = link.getAttribute('href');
                                    // Ensure URL has protocol
                                    if (url && !/^https?:\/\//i.test(url)) {
                                        url = 'https://' + url;
                                    }
                                    window.open(url, '_blank', 'noopener,noreferrer');
                                }
                            });
                        } else {
                            console.warn('Quill.js not loaded, using fallback textarea');
                            editorContainer.innerHTML = '<textarea id="email-template-body-fallback" class="form-input" rows="15" style="width:100%;resize:vertical" placeholder="Email body content. You can use placeholders like ${student_name}, ${session_name}, etc."></textarea>';
                        }
                    } catch (quillError) {
                        console.error('Error initializing Quill editor:', quillError);
                        if (editorContainer && !emailTemplateQuill) {
                            editorContainer.innerHTML = '<textarea id="email-template-body-fallback" class="form-input" rows="15" style="width:100%;resize:vertical" placeholder="Email body content. You can use placeholders like ${student_name}, ${session_name}, etc."></textarea>';
                        }
                    }
                } else if (emailTemplateQuill && !skipReset) {
                    // Clear editor content
                    emailTemplateQuill.setContents([]);
                }
            }, 100);
            
            if (!skipReset) {
                resetEmailTemplateForm();
            }
        }
        
        // SMS Template View Functions
        function showSMSTemplateList() {
            document.getElementById('sms-template-list-view').style.display = 'block';
            document.getElementById('sms-template-form-view').style.display = 'none';
        }
        
        function showSMSTemplateForm(skipReset = false) {
            document.getElementById('sms-template-list-view').style.display = 'none';
            document.getElementById('sms-template-form-view').style.display = 'block';
            if (!skipReset) {
                resetSMSTemplateForm();
            }
        }
        
        // Email Template Functions
        async function loadEmailTemplates() {
            try {
                const res = await fetch('/api/admin/email-templates');
                const json = await res.json();
                if (!res.ok || !json.success) throw new Error(json.error || 'Failed to load templates');
                
                const listEl = document.getElementById('email-templates-list');
                if (json.data && json.data.length > 0) {
                    listEl.innerHTML = json.data.map(template => `
                        <div id="email-template-${template.id}" style="border:1px solid #e5e7eb;border-radius:8px;padding:16px;background:#fff">
                            <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:8px">
                                <div style="flex:1">
                                    <h5 style="margin:0 0 4px 0;font-size:16px;color:#111827">${template.name || 'Unnamed Template'}</h5>
                                    <p style="margin:0;font-size:14px;color:#6b7280">${template.subject || 'No subject'}</p>
                                </div>
                                <div style="display:flex;gap:8px;align-items:center">
                                    <button onclick="viewEmailTemplate(${template.id})" style="background:none;border:none;padding:4px;cursor:pointer;display:flex;align-items:center;justify-content:center" title="View">
                                        <img src="/view.png" alt="View" style="width:20px;height:20px">
                                    </button>
                                    <button onclick="editEmailTemplate(${template.id})" style="background:none;border:none;padding:4px;cursor:pointer;display:flex;align-items:center;justify-content:center" title="Edit">
                                        <img src="/edit.png" alt="Edit" style="width:20px;height:20px">
                                    </button>
                                    <button onclick="deleteEmailTemplate(${template.id})" style="background:none;border:none;padding:4px;cursor:pointer;display:flex;align-items:center;justify-content:center" title="Delete">
                                        <img src="/delete.png" alt="Delete" style="width:20px;height:20px">
                                    </button>
                                </div>
                            </div>
                            <div id="email-template-preview-${template.id}" style="display:none;margin-top:12px;padding:16px;background:#f9fafb;border-radius:6px;border:1px solid #e5e7eb">
                                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
                                    <h6 style="margin:0;font-size:14px;font-weight:600;color:#111827">Preview</h6>
                                    <button onclick="closeEmailTemplatePreview(${template.id})" style="background:none;border:none;color:#6b7280;cursor:pointer;font-size:18px;padding:0;width:24px;height:24px;display:flex;align-items:center;justify-content:center">&times;</button>
                                </div>
                                <div style="margin-bottom:8px">
                                    <strong style="font-size:12px;color:#6b7280">Subject:</strong>
                                    <p style="margin:4px 0 0 0;font-size:14px;color:#111827">${template.subject || 'No subject'}</p>
                                </div>
                                <div>
                                    <strong style="font-size:12px;color:#6b7280">Body:</strong>
                                    <div style="margin-top:8px;padding:12px;background:#fff;border-radius:4px;max-height:300px;overflow-y:auto">
                                        <pre style="margin:0;font-size:13px;color:#374151;white-space:pre-wrap;word-wrap:break-word;font-family:inherit">${template.body || ''}</pre>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `).join('');
                } else {
                    listEl.innerHTML = '<p style="color:#6b7280;text-align:center;padding:20px">No templates saved yet</p>';
                }
            } catch (e) {
                console.error('Error loading templates:', e);
                showError('Failed to load email templates');
            }
        }
        
        document.getElementById('email-template-form')?.addEventListener('submit', async function(e) {
            e.preventDefault();
            try {
                const templateId = document.getElementById('email-template-id').value;
                const name = document.getElementById('template-name').value.trim();
                const subject = document.getElementById('template-subject').value.trim();
                
                // Get body from Quill editor or fallback textarea
                let body = '';
                if (emailTemplateQuill) {
                    // Get HTML content from Quill editor
                    body = emailTemplateQuill.root.innerHTML.trim();
                } else {
                    // Fallback to textarea if Quill is not available
                    const fallback = document.getElementById('email-template-body-fallback');
                    if (fallback) {
                        body = fallback.value.trim();
                    } else {
                        const bodyDiv = document.getElementById('template-body');
                        body = bodyDiv ? (bodyDiv.innerHTML || bodyDiv.innerText || bodyDiv.textContent || '').trim() : '';
                    }
                }
                
                if (!name || !body) {
                    showError('Template name and body are required');
                    return;
                }
                
                const url = templateId ? `/api/admin/email-templates/${templateId}` : '/api/admin/email-templates';
                const method = templateId ? 'PUT' : 'POST';
                
                const res = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, subject, body })
                });
                
                const json = await res.json();
                if (!res.ok || !json.success) throw new Error(json.error || 'Failed to save template');
                
                showSuccess(templateId ? 'Template updated successfully' : 'Template saved successfully');
                resetEmailTemplateForm();
                loadEmailTemplates();
                showEmailTemplateList(); // Go back to list view after saving
            } catch (e) {
                console.error('Error saving template:', e);
                showError(e.message || 'Failed to save template');
            }
        });
        
        // Email Template View/Edit Functions
        function viewEmailTemplate(id) {
            const previewEl = document.getElementById(`email-template-preview-${id}`);
            if (previewEl) {
                previewEl.style.display = 'block';
            }
        }
        
        function closeEmailTemplatePreview(id) {
            const previewEl = document.getElementById(`email-template-preview-${id}`);
            if (previewEl) {
                previewEl.style.display = 'none';
            }
        }
        
        async function editEmailTemplate(id) {
            try {
                const res = await fetch(`/api/admin/email-templates/${id}`);
                const json = await res.json();
                if (!res.ok || !json.success) throw new Error(json.error || 'Failed to load template');
                
                const template = json.data;
                
                // Show form first without resetting
                showEmailTemplateForm(true);
                
                // Wait for Quill to initialize, then populate the form fields
                setTimeout(() => {
                    document.getElementById('email-template-id').value = template.id;
                    document.getElementById('template-name').value = template.name || '';
                    document.getElementById('template-subject').value = template.subject || '';
                    
                    // Set content in Quill editor or fallback textarea
                    if (emailTemplateQuill) {
                        // Set HTML content in Quill editor
                        emailTemplateQuill.root.innerHTML = template.body || '';
                    } else {
                        const fallback = document.getElementById('email-template-body-fallback');
                        if (fallback) {
                            fallback.value = template.body || '';
                        } else {
                            const bodyDiv = document.getElementById('template-body');
                            if (bodyDiv) {
                                bodyDiv.innerHTML = template.body || '';
                            }
                        }
                    }
                    document.getElementById('email-template-form-title').textContent = 'Edit Email Template';
                }, 200);
            } catch (e) {
                console.error('Error loading template:', e);
                showError(e.message || 'Failed to load template');
            }
        }
        
        async function deleteEmailTemplate(id) {
            if (!confirm('Are you sure you want to delete this template?')) return;
            try {
                const res = await fetch(`/api/admin/email-templates/${id}`, { method: 'DELETE' });
                const json = await res.json();
                if (!res.ok || !json.success) throw new Error(json.error || 'Failed to delete template');
                showSuccess('Template deleted successfully');
                loadEmailTemplates();
            } catch (e) {
                console.error('Error deleting template:', e);
                showError(e.message || 'Failed to delete template');
            }
        }
        
        function resetEmailTemplateForm() {
            document.getElementById('email-template-id').value = '';
            document.getElementById('template-name').value = '';
            document.getElementById('template-subject').value = '';
            
            // Clear Quill editor or fallback textarea
            if (emailTemplateQuill) {
                emailTemplateQuill.setContents([]);
            } else {
                const fallback = document.getElementById('email-template-body-fallback');
                if (fallback) {
                    fallback.value = '';
                } else {
                    const bodyDiv = document.getElementById('template-body');
                    if (bodyDiv) {
                        bodyDiv.innerHTML = '';
                    }
                }
            }
            document.getElementById('email-template-form-title').textContent = 'Create Email Template';
        }
        
        // SMS Template Functions
        async function loadSMSTemplates() {
            try {
                const res = await fetch('/api/admin/sms-templates');
                const json = await res.json();
                if (!res.ok || !json.success) {
                    // If endpoint doesn't exist yet, show empty state
                    const listEl = document.getElementById('sms-templates-list');
                    listEl.innerHTML = '<p style="color:#6b7280;text-align:center;padding:20px">No templates saved yet</p>';
                    return;
                }
                
                const listEl = document.getElementById('sms-templates-list');
                if (json.data && json.data.length > 0) {
                    listEl.innerHTML = json.data.map(template => `
                        <div id="sms-template-${template.id}" style="border:1px solid #e5e7eb;border-radius:8px;padding:16px;background:#fff">
                            <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:8px">
                                <div style="flex:1">
                                    <h5 style="margin:0 0 4px 0;font-size:16px;color:#111827">${template.name || 'Unnamed Template'}</h5>
                                </div>
                                <div style="display:flex;gap:8px;align-items:center">
                                    <button onclick="viewSMSTemplate(${template.id})" style="background:none;border:none;padding:4px;cursor:pointer;display:flex;align-items:center;justify-content:center" title="View">
                                        <img src="/view.png" alt="View" style="width:20px;height:20px">
                                    </button>
                                    <button onclick="editSMSTemplate(${template.id})" style="background:none;border:none;padding:4px;cursor:pointer;display:flex;align-items:center;justify-content:center" title="Edit">
                                        <img src="/edit.png" alt="Edit" style="width:20px;height:20px">
                                    </button>
                                    <button onclick="deleteSMSTemplate(${template.id})" style="background:none;border:none;padding:4px;cursor:pointer;display:flex;align-items:center;justify-content:center" title="Delete">
                                        <img src="/delete.png" alt="Delete" style="width:20px;height:20px">
                                    </button>
                                </div>
                            </div>
                            <div id="sms-template-preview-${template.id}" style="display:none;margin-top:12px;padding:16px;background:#f9fafb;border-radius:6px;border:1px solid #e5e7eb">
                                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
                                    <h6 style="margin:0;font-size:14px;font-weight:600;color:#111827">Preview</h6>
                                    <button onclick="closeSMSTemplatePreview(${template.id})" style="background:none;border:none;color:#6b7280;cursor:pointer;font-size:18px;padding:0;width:24px;height:24px;display:flex;align-items:center;justify-content:center">&times;</button>
                                </div>
                                <div>
                                    <strong style="font-size:12px;color:#6b7280">Message:</strong>
                                    <div style="margin-top:8px;padding:12px;background:#fff;border-radius:4px;max-height:300px;overflow-y:auto">
                                        <pre style="margin:0;font-size:13px;color:#374151;white-space:pre-wrap;word-wrap:break-word;font-family:inherit">${template.message || ''}</pre>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `).join('');
                } else {
                    listEl.innerHTML = '<p style="color:#6b7280;text-align:center;padding:20px">No templates saved yet</p>';
                }
            } catch (e) {
                console.error('Error loading SMS templates:', e);
                const listEl = document.getElementById('sms-templates-list');
                listEl.innerHTML = '<p style="color:#6b7280;text-align:center;padding:20px">No templates saved yet</p>';
            }
        }
        
        document.getElementById('sms-template-form')?.addEventListener('submit', async function(e) {
            e.preventDefault();
            try {
                const templateId = document.getElementById('sms-template-id').value;
                const name = document.getElementById('sms-template-name').value.trim();
                const message = document.getElementById('sms-template-message').value.trim();
                
                if (!name || !message) {
                    showError('Template name and message are required');
                    return;
                }
                
                const url = templateId ? `/api/admin/sms-templates/${templateId}` : '/api/admin/sms-templates';
                const method = templateId ? 'PUT' : 'POST';
                
                const res = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, message })
                });
                
                const json = await res.json();
                if (!res.ok || !json.success) throw new Error(json.error || 'Failed to save template');
                
                showSuccess(templateId ? 'Template updated successfully' : 'Template saved successfully');
                resetSMSTemplateForm();
                loadSMSTemplates();
                showSMSTemplateList();
            } catch (e) {
                console.error('Error saving SMS template:', e);
                showError(e.message || 'Failed to save template');
            }
        });
        
        // SMS Template View/Edit Functions
        function viewSMSTemplate(id) {
            const previewEl = document.getElementById(`sms-template-preview-${id}`);
            if (previewEl) {
                previewEl.style.display = 'block';
            }
        }
        
        function closeSMSTemplatePreview(id) {
            const previewEl = document.getElementById(`sms-template-preview-${id}`);
            if (previewEl) {
                previewEl.style.display = 'none';
            }
        }
        
        async function editSMSTemplate(id) {
            try {
                const res = await fetch(`/api/admin/sms-templates/${id}`);
                const json = await res.json();
                if (!res.ok || !json.success) throw new Error(json.error || 'Failed to load template');
                
                const template = json.data;
                
                // Show form first without resetting
                showSMSTemplateForm(true);
                
                // Then populate the form fields
                document.getElementById('sms-template-id').value = template.id;
                document.getElementById('sms-template-name').value = template.name || '';
                document.getElementById('sms-template-message').value = template.message || '';
                document.getElementById('sms-template-form-title').textContent = 'Edit SMS Template';
            } catch (e) {
                console.error('Error loading SMS template:', e);
                showError(e.message || 'Failed to load template');
            }
        }
        
        async function deleteSMSTemplate(id) {
            if (!confirm('Are you sure you want to delete this template?')) return;
            try {
                const res = await fetch(`/api/admin/sms-templates/${id}`, { method: 'DELETE' });
                const json = await res.json();
                if (!res.ok || !json.success) throw new Error(json.error || 'Failed to delete template');
                showSuccess('Template deleted successfully');
                loadSMSTemplates();
            } catch (e) {
                console.error('Error deleting SMS template:', e);
                showError(e.message || 'Failed to delete template');
            }
        }
        
        function resetSMSTemplateForm() {
            document.getElementById('sms-template-id').value = '';
            document.getElementById('sms-template-name').value = '';
            document.getElementById('sms-template-message').value = '';
            document.getElementById('sms-template-form-title').textContent = 'Create SMS Template';
        }
        
        // Send Mail Functions
        let currentConsolidationId = null;
        let sendMailQuill = null;
        
        // Store pending consolidation ID for communication type selection
        let pendingConsolidationId = null;
        let pendingBulkEmailIds = null;
        
        function showCommTypeModal(consolidationId = null, bulkEmailIds = null) {
            pendingConsolidationId = consolidationId;
            pendingBulkEmailIds = bulkEmailIds;
            document.getElementById('comm-type-overlay').style.display = 'flex';
        }
        
        function closeCommTypeModal() {
            document.getElementById('comm-type-overlay').style.display = 'none';
            pendingConsolidationId = null;
            pendingBulkEmailIds = null;
        }
        
        function proceedWithCommType() {
            const selectedType = document.querySelector('input[name="comm-type"]:checked').value;
            
            // Store values before closing modal (which clears them)
            const consolidationId = pendingConsolidationId;
            const bulkEmailIds = pendingBulkEmailIds;
            
            // Close modal (this clears pendingConsolidationId and pendingBulkEmailIds)
            closeCommTypeModal();
            
            if (selectedType === 'email') {
                if (bulkEmailIds && bulkEmailIds.length > 0) {
                    // Bulk email mode
                    openBulkEmailPopupDirect(bulkEmailIds);
                } else if (consolidationId) {
                    // Single email mode
                    openSendMailPopupDirect(consolidationId);
                } else {
                    showError('No records selected');
                }
            } else if (selectedType === 'sms') {
                if (bulkEmailIds && bulkEmailIds.length > 0) {
                    // Bulk SMS mode
                    openBulkSMSPopupDirect(bulkEmailIds);
                } else if (consolidationId) {
                    // Single SMS mode
                    openSendSMSPopupDirect(consolidationId);
                } else {
                    showError('No records selected');
                }
            }
        }
        let emailTemplateQuill = null;
        
        async function openSendMailPopup(consolidationId) {
            showCommTypeModal(consolidationId);
        }
        
        async function openSendMailPopupDirect(consolidationId) {
            currentConsolidationId = consolidationId;
            try {
                // Get consolidation data
                const res = await fetch('/api/admin/consolidation');
                const json = await res.json();
                if (!res.ok || !json.success) throw new Error('Failed to load consolidation data');
                
                const item = json.data.find(x => String(x.id) === String(consolidationId));
                if (!item) {
                    showError('Record not found');
                    return;
                }
                
                // Get session creator email
                let senderEmail = '';
                try {
                    if (item.session_id) {
                        const sessionRes = await fetch(`/api/admin/sessions/${item.session_id}`);
                        const sessionJson = await sessionRes.json();
                        if (sessionJson.success && sessionJson.data && sessionJson.data.created_by_email) {
                            senderEmail = sessionJson.data.created_by_email;
                        }
                    }
                } catch (e) {
                    console.warn('Could not fetch session creator email:', e);
                }
                
                // Prefill form - check if elements exist
                const fromEl = document.getElementById('send-mail-from');
                const toEl = document.getElementById('send-mail-to');
                const ccEl = document.getElementById('send-mail-cc');
                const bccEl = document.getElementById('send-mail-bcc');
                const subjectEl = document.getElementById('send-mail-subject');
                const overlayEl = document.getElementById('send-mail-overlay');
                
                if (!fromEl || !toEl || !subjectEl || !overlayEl) {
                    throw new Error('Send mail form elements not found. Please refresh the page.');
                }
                
                fromEl.value = 'admissions@zohoschools.in';
                
                // Clear and populate email tags
                clearEmailTags('to');
                clearEmailTags('cc');
                clearEmailTags('bcc');
                
                if (item.student_email) {
                    addEmailTag('to', item.student_email);
                }
                
                // Show student name next to receiver label
                
                subjectEl.value = '';
                
                // Load templates dropdown
                await loadEmailTemplatesForSend();
                
                // Show popup first so the editor container exists
                overlayEl.style.display = 'block';
                
                // Initialize Quill editor if not already initialized (after popup is shown)
                setTimeout(() => {
                    const editorContainer = document.getElementById('send-mail-message-editor');
                    if (editorContainer && !sendMailQuill) {
                        try {
                            if (typeof Quill !== 'undefined') {
                                sendMailQuill = new Quill('#send-mail-message-editor', {
                                    theme: 'snow',
                                    modules: {
                                        toolbar: [
                                            [{ 'header': [1, 2, 3, false] }],
                                            ['bold', 'italic', 'underline', 'strike'],
                                            [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                                            [{ 'align': [] }],
                                            ['link', 'image'],
                                            ['clean']
                                        ]
                                    },
                                    placeholder: 'Compose your message...'
                                });
                                
                                // Configure link handler to ensure proper URL format
                                const linkHandler = sendMailQuill.getModule('toolbar').handlers.link;
                                sendMailQuill.getModule('toolbar').handlers.link = function(value) {
                                    if (value) {
                                        // Ensure URL has protocol
                                        if (!/^https?:\/\//i.test(value)) {
                                            value = 'https://' + value;
                                        }
                                    }
                                    linkHandler.call(this, value);
                                };
                                
                                // Intercept link clicks to open in new tab with correct URL
                                sendMailQuill.root.addEventListener('click', function(e) {
                                    const link = e.target.closest('a');
                                    if (link && link.href) {
                                        e.preventDefault();
                                        e.stopPropagation();
                                        let url = link.getAttribute('href');
                                        // Ensure URL has protocol
                                        if (url && !/^https?:\/\//i.test(url)) {
                                            url = 'https://' + url;
                                        }
                                        window.open(url, '_blank', 'noopener,noreferrer');
                                    }
                                });
                            } else {
                                console.error('Quill.js is not loaded');
                                throw new Error('Quill.js library not found');
                            }
                        } catch (quillError) {
                            console.error('Error initializing Quill editor:', quillError);
                            // Fallback: create a simple textarea if Quill fails
                            if (editorContainer && !sendMailQuill) {
                                editorContainer.innerHTML = '<textarea id="send-mail-message-fallback" style="width:100%;min-height:300px;padding:8px;border:1px solid #d1d5db;border-radius:4px;font-size:14px;font-family:inherit" placeholder="Compose your message..."></textarea>';
                            }
                        }
                    } else if (sendMailQuill) {
                        // Clear editor content
                        sendMailQuill.setContents([]);
                    }
                }, 100);
            } catch (e) {
                console.error('Error opening send mail popup:', e);
                showError('Failed to open send mail popup: ' + (e.message || e.toString()));
            }
        }
        
        function closeSendMailPopup() {
            document.getElementById('send-mail-overlay').style.display = 'none';
            currentConsolidationId = null;
            window.currentDraftId = null; // Clear draft ID when closing
        }
        
        // SMS Functions
        let currentSMSConsolidationId = null;
        let currentSMSDraftId = null;
        
        async function openSendSMSPopupDirect(consolidationId) {
            currentSMSConsolidationId = consolidationId;
            try {
                // Get consolidation data
                const res = await fetch('/api/admin/consolidation');
                const json = await res.json();
                if (!res.ok || !json.success) throw new Error('Failed to load consolidation data');
                
                const item = json.data.find(x => String(x.id) === String(consolidationId));
                if (!item) {
                    showError('Record not found');
                    return;
                }
                
                // Prefill form
                const fromEl = document.getElementById('send-sms-from');
                const toEl = document.getElementById('send-sms-to');
                const overlayEl = document.getElementById('send-sms-overlay');
                
                if (!fromEl || !toEl || !overlayEl) {
                    throw new Error('Send SMS form elements not found. Please refresh the page.');
                }
                
                // Set from number - fetch from API
                fromEl.value = 'Loading...';
                try {
                    const configRes = await fetch('/api/admin/twilio-config');
                    const configJson = await configRes.json();
                    if (configRes.ok && configJson.success && configJson.data.from_number) {
                        fromEl.value = configJson.data.from_number;
                    } else {
                        fromEl.value = 'Not configured';
                        fromEl.style.color = '#ef4444';
                    }
                } catch (e) {
                    console.warn('Could not fetch Twilio config:', e);
                    fromEl.value = 'Not configured';
                    fromEl.style.color = '#ef4444';
                }
                
                // Clear and populate phone tags
                clearPhoneTags('to');
                
                // Get phone number from consolidation data
                if (item.phone) {
                    addPhoneTag('to', item.phone);
                } else {
                    // Try to fetch from students table if not in consolidation
                    try {
                        const studentRes = await fetch(`/api/students?zeta_id=${item.zeta_id || ''}`);
                        const studentJson = await studentRes.json();
                        if (studentRes.ok && studentJson.success && studentJson.data && studentJson.data.length > 0) {
                            const student = studentJson.data[0];
                            if (student.phone) {
                                addPhoneTag('to', student.phone);
                            }
                        }
                    } catch (e) {
                        console.warn('Could not fetch student phone:', e);
                    }
                }
                
                // Load SMS templates dropdown
                await loadSMSTemplatesForSend();
                
                // Show popup
                overlayEl.style.display = 'block';
                
                // Update character counter
                updateSMSCharCount();
            } catch (e) {
                console.error('Error opening send SMS popup:', e);
                showError('Failed to open send SMS popup: ' + (e.message || e.toString()));
            }
        }
        
        async function openBulkSMSPopupDirect(bulkIds) {
            if (!bulkIds || bulkIds.length === 0) {
                showError('No records selected');
                return;
            }
            
            window.bulkSMSMode = true;
            window.bulkSMSIds = bulkIds;
            
            try {
                // Get consolidation data for all selected records
                const res = await fetch('/api/admin/consolidation');
                const json = await res.json();
                if (!res.ok || !json.success) throw new Error('Failed to load consolidation data');
                
                const selectedRecords = json.data.filter(c => bulkIds.includes(String(c.id)));
                
                if (selectedRecords.length === 0) {
                    showError('No valid records found');
                    return;
                }
                
                // Validate that all selected records have phone numbers
                const recordsWithoutPhone = selectedRecords.filter(record => 
                    !record.phone || record.phone.trim() === ''
                );
                
                if (recordsWithoutPhone.length > 0) {
                    showError('Some applicants don\'t have a phone number. Please select only those applicants who have a valid phone number.');
                    return;
                }
                
                // Prefill form
                const fromEl = document.getElementById('send-sms-from');
                const toEl = document.getElementById('send-sms-to');
                const overlayEl = document.getElementById('send-sms-overlay');
                
                if (!fromEl || !toEl || !overlayEl) {
                    throw new Error('Send SMS form elements not found. Please refresh the page.');
                }
                
                // Set from number - fetch from API
                fromEl.value = 'Loading...';
                try {
                    const configRes = await fetch('/api/admin/twilio-config');
                    const configJson = await configRes.json();
                    if (configRes.ok && configJson.success && configJson.data.from_number) {
                        fromEl.value = configJson.data.from_number;
                    } else {
                        fromEl.value = 'Not configured';
                        fromEl.style.color = '#ef4444';
                    }
                } catch (e) {
                    console.warn('Could not fetch Twilio config:', e);
                    fromEl.value = 'Not configured';
                    fromEl.style.color = '#ef4444';
                }
                
                // Clear and populate phone tags
                clearPhoneTags('to');
                
                // Add all phone numbers to To field
                selectedRecords.forEach(record => {
                    if (record.phone) {
                        addPhoneTag('to', record.phone);
                    }
                });
                
                // Load SMS templates dropdown
                await loadSMSTemplatesForSend();
                
                // Show popup
                overlayEl.style.display = 'block';
                
                // Update character counter
                updateSMSCharCount();
            } catch (e) {
                console.error('Error opening bulk SMS popup:', e);
                showError('Failed to open bulk SMS popup: ' + (e.message || e.toString()));
            }
        }
        
        function closeSendSMSPopup() {
            document.getElementById('send-sms-overlay').style.display = 'none';
            currentSMSConsolidationId = null;
            currentSMSDraftId = null;
            window.bulkSMSMode = false;
            window.bulkSMSIds = null;
        }
        
        // Phone number tag management functions
        function handlePhoneInput(event, field) {
            if (event.key === 'Enter' || event.key === ',') {
                event.preventDefault();
                addPhoneFromInput(field);
            } else if (event.key === 'Backspace' && event.target.value === '') {
                const tagsContainer = document.getElementById(`send-sms-${field}-tags`);
                if (tagsContainer) {
                    const tags = tagsContainer.querySelectorAll('.phone-tag');
                    if (tags.length > 0) {
                        removePhoneTag(field, tags[tags.length - 1].dataset.phone);
                    }
                }
            }
        }
        
        function addPhoneFromInput(field) {
            const input = document.getElementById(`send-sms-${field}`);
            if (!input) return;
            
            const value = input.value.trim();
            
            if (value) {
                const phones = value.split(',').map(p => p.trim()).filter(p => p);
                phones.forEach(phone => {
                    if (phone && isValidPhoneNumber(phone)) {
                        addPhoneTag(field, phone);
                    }
                });
                input.value = '';
                updatePhoneFieldPlaceholder(field);
                updateSMSCharCount();
            }
        }
        
        function isValidPhoneNumber(phone) {
            // Basic validation - accepts digits, +, spaces, hyphens
            const cleaned = phone.replace(/\D/g, '');
            return cleaned.length >= 10 && cleaned.length <= 15;
        }
        
        function addPhoneTag(field, phone) {
            const tagsContainer = document.getElementById(`send-sms-${field}-tags`);
            if (!tagsContainer) return;
            
            // Check for duplicates
            const existingTags = Array.from(tagsContainer.querySelectorAll('.phone-tag'));
            if (existingTags.some(tag => tag.dataset.phone === phone)) {
                return;
            }
            
            const tag = document.createElement('span');
            tag.className = 'phone-tag';
            tag.dataset.phone = phone;
            tag.style.cssText = 'display:inline-flex;align-items:center;gap:4px;background:#e0e7ff;color:#3730a3;padding:4px 8px;border-radius:4px;font-size:12px';
            tag.innerHTML = `
                <span>${phone}</span>
                <button type="button" onclick="removePhoneTag('${field}', '${phone}')" style="background:transparent;border:none;color:#3730a3;cursor:pointer;padding:0;margin-left:4px;font-size:14px;line-height:1">&times;</button>
            `;
            tagsContainer.appendChild(tag);
            updatePhoneFieldPlaceholder(field);
        }
        
        function removePhoneTag(field, phone) {
            const tagsContainer = document.getElementById(`send-sms-${field}-tags`);
            if (tagsContainer) {
                const tag = tagsContainer.querySelector(`.phone-tag[data-phone="${phone}"]`);
                if (tag) {
                    tag.remove();
                    updatePhoneFieldPlaceholder(field);
                    updateSMSCharCount();
                }
            }
        }
        
        function clearPhoneTags(field) {
            const tagsContainer = document.getElementById(`send-sms-${field}-tags`);
            if (tagsContainer) {
                tagsContainer.innerHTML = '';
                updatePhoneFieldPlaceholder(field);
            }
        }
        
        function getPhonesFromTags(field) {
            const tagsContainer = document.getElementById(`send-sms-${field}-tags`);
            if (!tagsContainer) return [];
            const tags = tagsContainer.querySelectorAll('.phone-tag');
            return Array.from(tags).map(tag => tag.dataset.phone);
        }
        
        function updatePhoneFieldPlaceholder(field) {
            const input = document.getElementById(`send-sms-${field}`);
            const tagsContainer = document.getElementById(`send-sms-${field}-tags`);
            if (!input || !tagsContainer) return;
            
            const hasTags = tagsContainer.querySelectorAll('.phone-tag').length > 0;
            const hasText = input.value.trim().length > 0;
            
            if (hasTags || hasText) {
                input.placeholder = '';
            } else {
                input.placeholder = field === 'to' ? 'Enter phone numbers (comma-separated or press Enter)' : 'Enter phone numbers';
            }
        }
        
        function updateSMSCharCount() {
            const messageEl = document.getElementById('send-sms-message');
            const charCountEl = document.getElementById('sms-char-count');
            const smsCountEl = document.getElementById('sms-count');
            
            if (!messageEl || !charCountEl || !smsCountEl) return;
            
            const text = messageEl.value;
            const charCount = text.length;
            const smsCount = Math.ceil(charCount / 160);
            
            charCountEl.textContent = `${charCount} characters`;
            smsCountEl.textContent = `${smsCount} SMS`;
            
            // Change color if over 160 characters
            if (charCount > 160) {
                charCountEl.style.color = '#dc2626';
            } else {
                charCountEl.style.color = '#6b7280';
            }
        }
        
        async function loadSMSTemplatesForSend() {
            try {
                const res = await fetch('/api/admin/sms-templates');
                const json = await res.json();
                const select = document.getElementById('send-sms-template');
                if (!select) return;
                
                select.innerHTML = '<option value="">Select a template...</option>';
                
                if (json.success && json.data) {
                    json.data.forEach(template => {
                        const option = document.createElement('option');
                        option.value = template.id;
                        option.textContent = template.name;
                        select.appendChild(option);
                    });
                }
            } catch (e) {
                console.error('Error loading SMS templates:', e);
            }
        }
        
        async function loadSMSTemplate() {
            const select = document.getElementById('send-sms-template');
            const messageEl = document.getElementById('send-sms-message');
            
            if (!select || !select.value || !messageEl) return;
            
            try {
                const res = await fetch(`/api/admin/sms-templates/${select.value}`);
                const json = await res.json();
                
                if (res.ok && json.success && json.data) {
                    messageEl.value = json.data.message || '';
                    updateSMSCharCount();
                }
            } catch (e) {
                console.error('Error loading SMS template:', e);
                showError('Failed to load template');
            }
        }
        
        async function saveSMSAsDraft() {
            showSingleEmailLoading('Saving Draft...', 'Please wait while we save your draft');
            try {
                const from = document.getElementById('send-sms-from').value.trim();
                
                // Process any remaining input values into tags first
                addPhoneFromInput('to');
                
                // Get phones from tags
                let toPhones = getPhonesFromTags('to');
                
                // Also check input field
                const toInput = document.getElementById('send-sms-to').value.trim();
                if (toInput) {
                    const phones = toInput.split(',').map(p => p.trim()).filter(p => p && isValidPhoneNumber(p));
                    phones.forEach(phone => {
                        if (!toPhones.includes(phone)) {
                            toPhones.push(phone);
                        }
                    });
                }
                
                const message = document.getElementById('send-sms-message').value.trim();
                const messageType = document.getElementById('send-sms-type').value || 'sms';
                
                // For drafts, at least one field (To or Message) should be filled
                const hasTo = toPhones.length > 0;
                const hasMessage = message && message.length > 0;
                
                if (!hasTo && !hasMessage) {
                    showError('Please fill in at least one field (To or Message) to save as draft');
                    return;
                }
                
                const draftData = {
                    from,
                    to: toPhones.join(', '),
                    message,
                    message_type: messageType,
                    status: 'drafted',
                    consolidation_id: currentSMSConsolidationId || null
                };
                
                if (currentSMSDraftId) {
                    draftData.draft_id = currentSMSDraftId;
                }
                
                const res = await fetch('/api/admin/send-sms', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(draftData)
                });
                
                const json = await res.json();
                
                if (res.ok && json.success) {
                    showSuccess('Draft saved successfully');
                    currentSMSDraftId = json.logId;
                    // Don't close popup - keep it open
                } else {
                    throw new Error(json.error || 'Failed to save draft');
                }
            } catch (e) {
                console.error('Error saving SMS draft:', e);
                showError(e.message || 'Failed to save draft');
            } finally {
                hideSingleEmailLoading();
            }
        }
        
        // Show single email loading overlay
        function showSingleEmailLoading(title = 'Sending Email...', message = 'Please wait while we send your email') {
            const overlay = document.getElementById('single-email-loading-overlay');
            const titleEl = document.getElementById('single-email-loading-title');
            const messageEl = document.getElementById('single-email-loading-message');
            if (overlay) {
                if (titleEl) titleEl.textContent = title;
                if (messageEl) messageEl.textContent = message;
                overlay.style.display = 'flex';
            }
        }
        
        // Hide single email loading overlay
        function hideSingleEmailLoading() {
            const overlay = document.getElementById('single-email-loading-overlay');
            if (overlay) {
                overlay.style.display = 'none';
            }
        }
        
        // Open send mail popup from failed email (same as draft, but will resend)
        async function openSendMailFromFailed(failedId) {
            showSingleEmailLoading('Loading Email...', 'Preparing email for editing');
            try {
                await openSendMailFromDraft(failedId);
            } finally {
                hideSingleEmailLoading();
            }
        }
        
        // Open send mail popup from draft
        async function openSendMailFromDraft(draftId) {
            try {
                if (!draftId) {
                    throw new Error('Draft ID is required');
                }
                
                const response = await fetch(`/api/admin/email-logs/${draftId}`);
                
                // Check if response is JSON
                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    const text = await response.text();
                    console.error('Non-JSON response from server:', text.substring(0, 500));
                    throw new Error(`Server error (${response.status}): ${text.substring(0, 100)}`);
                }
                
                const result = await response.json();
                
                if (!response.ok || !result.success) {
                    throw new Error(result.error || 'Failed to load draft');
                }
                
                const draft = result.data;
                
                // Set draft ID so we can update it when sending
                window.currentDraftId = draftId;
                
                // Prefill form fields
                const fromEl = document.getElementById('send-mail-from');
                const subjectEl = document.getElementById('send-mail-subject');
                
                if (fromEl) fromEl.value = 'admissions@zohoschools.in';
                if (subjectEl) subjectEl.value = draft.subject || '';
                
                // Clear and populate email tags
                clearEmailTags('to');
                clearEmailTags('cc');
                clearEmailTags('bcc');
                
                if (draft.to_emails) {
                    draft.to_emails.split(',').forEach(email => {
                        const trimmed = email.trim();
                        if (trimmed && isValidEmail(trimmed)) {
                            addEmailTag('to', trimmed);
                        }
                    });
                }
                
                if (draft.cc_emails) {
                    draft.cc_emails.split(',').forEach(email => {
                        const trimmed = email.trim();
                        if (trimmed && isValidEmail(trimmed)) {
                            addEmailTag('cc', trimmed);
                        }
                    });
                }
                
                if (draft.bcc_emails) {
                    draft.bcc_emails.split(',').forEach(email => {
                        const trimmed = email.trim();
                        if (trimmed && isValidEmail(trimmed)) {
                            addEmailTag('bcc', trimmed);
                        }
                    });
                }
                
                // Set message in Quill editor
                if (sendMailQuill) {
                    sendMailQuill.root.innerHTML = draft.message || '';
                } else {
                    // Initialize Quill if not already initialized
                    setTimeout(() => {
                        const editorContainer = document.getElementById('send-mail-message-editor');
                        if (editorContainer && typeof Quill !== 'undefined') {
                            if (!sendMailQuill) {
                                sendMailQuill = new Quill('#send-mail-message-editor', {
                                    theme: 'snow',
                                    modules: {
                                        toolbar: [
                                            [{ 'header': [1, 2, 3, false] }],
                                            ['bold', 'italic', 'underline', 'strike'],
                                            [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                                            [{ 'align': [] }],
                                            ['link', 'image'],
                                            [{ 'color': [] }, { 'background': [] }],
                                            ['clean']
                                        ]
                                    }
                                });
                                
                                // Configure link handler to ensure proper URL format
                                const linkHandler = sendMailQuill.getModule('toolbar').handlers.link;
                                sendMailQuill.getModule('toolbar').handlers.link = function(value) {
                                    if (value) {
                                        // Ensure URL has protocol
                                        if (!/^https?:\/\//i.test(value)) {
                                            value = 'https://' + value;
                                        }
                                    }
                                    linkHandler.call(this, value);
                                };
                                
                                // Intercept link clicks to open in new tab with correct URL
                                sendMailQuill.root.addEventListener('click', function(e) {
                                    const link = e.target.closest('a');
                                    if (link && link.href) {
                                        e.preventDefault();
                                        e.stopPropagation();
                                        let url = link.getAttribute('href');
                                        // Ensure URL has protocol
                                        if (url && !/^https?:\/\//i.test(url)) {
                                            url = 'https://' + url;
                                        }
                                        window.open(url, '_blank', 'noopener,noreferrer');
                                    }
                                });
                            }
                            sendMailQuill.root.innerHTML = draft.message || '';
                        }
                    }, 100);
                }
                
                // Set consolidation ID if available
                if (draft.consolidation_id) {
                    currentConsolidationId = draft.consolidation_id;
                }
                
                // Show popup
                document.getElementById('send-mail-overlay').style.display = 'block';
                
            } catch (error) {
                console.error('Error loading draft:', error);
                showError(error.message || 'Failed to load draft');
            }
        }
        
        // Save email as draft
        async function saveEmailAsDraft() {
            showSingleEmailLoading('Saving Draft...', 'Please wait while we save your draft');
            try {
                const from = document.getElementById('send-mail-from').value.trim();
                
                // Process any remaining input values into tags first
                addEmailFromInput('to');
                addEmailFromInput('cc');
                addEmailFromInput('bcc');
                
                // Get emails from tags
                let toEmails = getEmailsFromTags('to');
                let ccEmails = getEmailsFromTags('cc');
                let bccEmails = getEmailsFromTags('bcc');
                
                // Also check input fields
                const toInput = document.getElementById('send-mail-to').value.trim();
                const ccInput = document.getElementById('send-mail-cc').value.trim();
                const bccInput = document.getElementById('send-mail-bcc').value.trim();
                
                if (toInput) {
                    const emails = toInput.split(',').map(e => e.trim()).filter(e => e && isValidEmail(e));
                    emails.forEach(email => {
                        if (!toEmails.includes(email)) {
                            toEmails.push(email);
                        }
                    });
                }
                if (ccInput) {
                    const emails = ccInput.split(',').map(e => e.trim()).filter(e => e && isValidEmail(e));
                    emails.forEach(email => {
                        if (!ccEmails.includes(email)) {
                            ccEmails.push(email);
                        }
                    });
                }
                if (bccInput) {
                    const emails = bccInput.split(',').map(e => e.trim()).filter(e => e && isValidEmail(e));
                    emails.forEach(email => {
                        if (!bccEmails.includes(email)) {
                            bccEmails.push(email);
                        }
                    });
                }
                
                const subject = document.getElementById('send-mail-subject').value.trim();
                
                // Get message from Quill editor
                let message = '';
                if (sendMailQuill) {
                    message = sendMailQuill.root.innerHTML.trim();
                } else {
                    const fallback = document.getElementById('send-mail-message-fallback');
                    if (fallback) {
                        message = fallback.value || '';
                    }
                }
                
                // For drafts, at least one field (To, Subject, or Message) should be filled
                const hasTo = toEmails.length > 0;
                const hasSubject = subject && subject.trim().length > 0;
                const hasMessage = message && message.trim().length > 0;
                
                if (!hasTo && !hasSubject && !hasMessage) {
                    showError('Please fill in at least one field (To, Subject, or Message) to save as draft');
                    return;
                }
                
                const draftData = {
                    from,
                    to: toEmails.join(', '),
                    cc: ccEmails.length > 0 ? ccEmails.join(', ') : undefined,
                    bcc: bccEmails.length > 0 ? bccEmails.join(', ') : undefined,
                    subject,
                    message,
                    status: 'drafted',
                    consolidation_id: currentConsolidationId || undefined
                };
                
                // If updating existing draft
                if (window.currentDraftId) {
                    const response = await fetch(`/api/admin/email-logs/${window.currentDraftId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            status: 'drafted',
                            subject: draftData.subject,
                            message: draftData.message,
                            to: draftData.to,
                            cc: draftData.cc,
                            bcc: draftData.bcc
                        })
                    });
                    
                    const result = await response.json();
                    if (!response.ok || !result.success) {
                        throw new Error(result.error || 'Failed to update draft');
                    }
                } else {
                    // Create new draft
                    const response = await fetch('/api/admin/send-email', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(draftData)
                    });
                    
                    const result = await response.json();
                    if (!response.ok || !result.success) {
                        throw new Error(result.error || 'Failed to save draft');
                    }
                }
                
                showSuccess('Draft saved successfully');
                // Don't close popup when saving draft - keep it open for editing
                
                // Reload drafts if on drafted tab
                if (currentEmailLogTab === 'drafted') {
                    await loadEmailLogs('drafted');
                }
                
            } catch (error) {
                console.error('Error saving draft:', error);
                showError(error.message || 'Failed to save draft');
            } finally {
                hideSingleEmailLoading();
            }
        }
        
        async function loadEmailTemplatesForSend() {
            try {
                const res = await fetch('/api/admin/email-templates');
                const json = await res.json();
                const selectEl = document.getElementById('send-mail-template');
                selectEl.innerHTML = '<option value="">Select a template...</option>';
                
                if (json.success && json.data && json.data.length > 0) {
                    json.data.forEach(template => {
                        const option = document.createElement('option');
                        option.value = template.id;
                        option.textContent = template.name;
                        option.dataset.subject = template.subject || '';
                        option.dataset.body = template.body || '';
                        selectEl.appendChild(option);
                    });
                }
            } catch (e) {
                console.error('Error loading templates for send:', e);
            }
        }
        
        function loadEmailTemplate() {
            const selectEl = document.getElementById('send-mail-template');
            const selectedOption = selectEl.options[selectEl.selectedIndex];
            if (selectedOption && selectedOption.value) {
                document.getElementById('send-mail-subject').value = selectedOption.dataset.subject || '';
                if (sendMailQuill) {
                    sendMailQuill.root.innerHTML = selectedOption.dataset.body || '';
                } else {
                    // Fallback for textarea
                    const fallback = document.getElementById('send-mail-message-fallback');
                    if (fallback) {
                        fallback.value = selectedOption.dataset.body || '';
                    }
                }
            }
        }
        
        // Formatting functions for email template
        function formatTemplateText(command) {
            const templateBodyDiv = document.getElementById('template-body');
            if (!templateBodyDiv) return;
            templateBodyDiv.focus();
            document.execCommand(command, false, null);
        }
        
        document.getElementById('send-mail-form')?.addEventListener('submit', async function(e) {
            e.preventDefault();
            try {
                const from = document.getElementById('send-mail-from').value.trim();
                
                // Process any remaining input values into tags first
                addEmailFromInput('to');
                addEmailFromInput('cc');
                addEmailFromInput('bcc');
                
                // Get emails from tags (multiple emails)
                let toEmails = getEmailsFromTags('to');
                let ccEmails = getEmailsFromTags('cc');
                let bccEmails = getEmailsFromTags('bcc');
                
                // Also check input field for any remaining email (in case blur didn't fire)
                const toInput = document.getElementById('send-mail-to').value.trim();
                const ccInput = document.getElementById('send-mail-cc').value.trim();
                const bccInput = document.getElementById('send-mail-bcc').value.trim();
                
                if (toInput) {
                    const emails = toInput.split(',').map(e => e.trim()).filter(e => e && isValidEmail(e));
                    emails.forEach(email => {
                        if (!toEmails.includes(email)) {
                            toEmails.push(email);
                        }
                    });
                }
                if (ccInput) {
                    const emails = ccInput.split(',').map(e => e.trim()).filter(e => e && isValidEmail(e));
                    emails.forEach(email => {
                        if (!ccEmails.includes(email)) {
                            ccEmails.push(email);
                        }
                    });
                }
                if (bccInput) {
                    const emails = bccInput.split(',').map(e => e.trim()).filter(e => e && isValidEmail(e));
                    emails.forEach(email => {
                        if (!bccEmails.includes(email)) {
                            bccEmails.push(email);
                        }
                    });
                }
                
                // Ensure we have collected all emails from input fields
                if (toInput) {
                    const emails = toInput.split(',').map(e => e.trim()).filter(e => e && isValidEmail(e));
                    emails.forEach(email => {
                        if (!toEmails.includes(email)) {
                            toEmails.push(email);
                        }
                    });
                }
                if (ccInput) {
                    const emails = ccInput.split(',').map(e => e.trim()).filter(e => e && isValidEmail(e));
                    emails.forEach(email => {
                        if (!ccEmails.includes(email)) {
                            ccEmails.push(email);
                        }
                    });
                }
                if (bccInput) {
                    const emails = bccInput.split(',').map(e => e.trim()).filter(e => e && isValidEmail(e));
                    emails.forEach(email => {
                        if (!bccEmails.includes(email)) {
                            bccEmails.push(email);
                        }
                    });
                }
                
                // Debug: Log collected emails
                console.log('Collected emails:', { toEmails, ccEmails, bccEmails, toInput, ccInput, bccInput });
                
                const subject = document.getElementById('send-mail-subject').value.trim();
                
                // Get message from Quill editor or fallback textarea
                let message = '';
                if (sendMailQuill) {
                    const htmlContent = sendMailQuill.root.innerHTML;
                    // Convert HTML to plain text for email body
                    const tempDiv = document.createElement('div');
                    tempDiv.innerHTML = htmlContent;
                    message = tempDiv.textContent || tempDiv.innerText || '';
                } else {
                    // Fallback for textarea
                    const fallback = document.getElementById('send-mail-message-fallback');
                    if (fallback) {
                        message = fallback.value || '';
                    }
                }
                
                // Validation with specific error messages
                if (!from) {
                    showError('Please fill in the From field');
                    return;
                }
                
                if (toEmails.length === 0) {
                    showError('Please add at least one valid email address in the To field');
                    return;
                }
                
                if (!subject) {
                    showError('Please fill in the Subject field');
                    return;
                }
                
                if (!message.trim()) {
                    showError('Please fill in the Message field');
                    return;
                }
                
                // Build final email strings
                const to = toEmails.join(', ');
                const cc = ccEmails.length > 0 ? ccEmails.join(', ') : '';
                const bcc = bccEmails.length > 0 ? bccEmails.join(', ') : '';
                
                // Handle bulk email or single email
                if (window.bulkEmailMode && window.bulkEmailIds && window.bulkEmailIds.length > 0) {
                    // Bulk email mode
                    const loadingOverlay = document.getElementById('bulk-email-loading-overlay');
                    const progressText = document.getElementById('bulk-email-progress');
                    const sentCountEl = document.getElementById('bulk-email-sent-count');
                    const failedCountEl = document.getElementById('bulk-email-failed-count');
                    const totalCountEl = document.getElementById('bulk-email-total-count');
                    
                    // Show loading overlay
                    loadingOverlay.style.display = 'flex';
                    const totalEmails = window.bulkEmailIds.length;
                    totalCountEl.textContent = totalEmails;
                    sentCountEl.textContent = '0';
                    failedCountEl.textContent = '0';
                    
                    const consolidationRes = await fetch('/api/admin/consolidation');
                    const consolidationJson = await consolidationRes.json();
                    
                    if (!consolidationRes.ok || !consolidationJson.success) {
                        loadingOverlay.style.display = 'none';
                        throw new Error('Failed to load consolidation data');
                    }
                    
                    let successCount = 0;
                    let errorCount = 0;
                    let processedCount = 0;
                    
                    for (const id of window.bulkEmailIds) {
                        try {
                            const consolidation = consolidationJson.data.find(c => c.id === parseInt(id));
                            if (!consolidation) {
                                errorCount++;
                                processedCount++;
                                failedCountEl.textContent = errorCount;
                                progressText.textContent = `Processing ${processedCount} of ${totalEmails} emails...`;
                                continue;
                            }
                            
                            // Update progress
                            progressText.textContent = `Sending email ${processedCount + 1} of ${totalEmails} to ${consolidation.student_email || 'recipient'}...`;
                            
                            // Replace variables in message and subject
                            const replacedMessage = replaceVariables(message, consolidation);
                            const replacedSubject = replaceVariables(subject, consolidation);
                            const emailTo = consolidation.student_email || to;
                            
                            const res = await fetch('/api/admin/send-email', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({
                                    from,
                                    to: emailTo,
                                    cc: cc || undefined,
                                    bcc: bcc || undefined,
                                    subject: replacedSubject,
                                    message: replacedMessage,
                                    consolidation_id: id
                                })
                            });
                            
                            const json = await res.json();
                            if (res.ok && json.success) {
                                successCount++;
                                sentCountEl.textContent = successCount;
                            } else {
                                errorCount++;
                                failedCountEl.textContent = errorCount;
                                // Log the error for debugging
                                console.error(`Failed to send email to ${emailTo}:`, json.error || 'Unknown error');
                            }
                            processedCount++;
                            progressText.textContent = `Processed ${processedCount} of ${totalEmails} emails...`;
                            
                            // Small delay to ensure database updates complete
                            await new Promise(resolve => setTimeout(resolve, 100));
                        } catch (e) {
                            console.error(`Error sending email to ${id}:`, e);
                            errorCount++;
                            processedCount++;
                            failedCountEl.textContent = errorCount;
                            progressText.textContent = `Processed ${processedCount} of ${totalEmails} emails...`;
                        }
                    }
                    
                    // Hide loading overlay
                    loadingOverlay.style.display = 'none';
                    
                    showSuccess(`Bulk email sent: ${successCount} successful, ${errorCount} failed`);
                    closeSendMailPopup();
                    window.bulkEmailMode = false;
                    window.bulkEmailIds = [];
                    selectedConsolidationIds.clear();
                    document.querySelectorAll('.consolidation-checkbox').forEach(cb => cb.checked = false);
                    updateBulkEmailButton();
                    
                    // Refresh email logs if on email logs tab
                    if (currentEmailLogTab) {
                        await loadEmailLogs(currentEmailLogTab);
                    }
                } else {
                    // Single email mode - show loading
                    const isResend = !!window.currentDraftId;
                    showSingleEmailLoading(
                        isResend ? 'Resending Email...' : 'Sending Email...',
                        isResend ? 'Please wait while we resend your email' : 'Please wait while we send your email'
                    );
                    
                    try {
                        // Get consolidation data for variable replacement
                        let consolidationData = null;
                        if (currentConsolidationId) {
                            try {
                                const consolidationRes = await fetch('/api/admin/consolidation');
                                const consolidationJson = await consolidationRes.json();
                                if (consolidationRes.ok && consolidationJson.success) {
                                    consolidationData = consolidationJson.data.find(c => c.id === currentConsolidationId);
                                }
                            } catch (e) {
                                console.warn('Could not load consolidation data for variable replacement:', e);
                            }
                        }
                        
                        // Replace variables
                        const replacedMessage = consolidationData ? replaceVariables(message, consolidationData) : message;
                        const replacedSubject = consolidationData ? replaceVariables(subject, consolidationData) : subject;
                        
                        const emailPayload = {
                            from,
                            to,
                            cc: cc || undefined,
                            bcc: bcc || undefined,
                            subject: replacedSubject,
                            message: replacedMessage,
                            consolidation_id: currentConsolidationId || undefined
                        };
                        
                        // If sending from a draft, include draft_id to update it
                        if (window.currentDraftId) {
                            emailPayload.draft_id = window.currentDraftId;
                        }
                        
                        const res = await fetch('/api/admin/send-email', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(emailPayload)
                        });
                        
                        const json = await res.json();
                        if (!res.ok || !json.success) throw new Error(json.error || 'Failed to send email');
                        
                        showSuccess('Email sent successfully');
                        closeSendMailPopup();
                        
                        // Always reload email logs if on email logs tab
                        if (currentEmailLogTab) {
                            await loadEmailLogs(currentEmailLogTab);
                        }
                        
                        window.currentDraftId = null; // Clear draft ID
                    } catch (sendError) {
                        console.error('Error sending email:', sendError);
                        showError(sendError.message || 'Failed to send email');
                        throw sendError; // Re-throw to be caught by outer catch
                    } finally {
                        hideSingleEmailLoading();
                    }
                }
            } catch (e) {
                console.error('Error sending email:', e);
                showError(e.message || 'Failed to send email');
            }
        });
        
        // SMS Form Submit Handler
        document.getElementById('send-sms-form')?.addEventListener('submit', async function(e) {
            e.preventDefault();
            try {
                const from = document.getElementById('send-sms-from').value.trim();
                
                // Process any remaining input values into tags first
                addPhoneFromInput('to');
                
                // Get phones from tags
                let toPhones = getPhonesFromTags('to');
                
                // Also check input field
                const toInput = document.getElementById('send-sms-to').value.trim();
                if (toInput) {
                    const phones = toInput.split(',').map(p => p.trim()).filter(p => p && isValidPhoneNumber(p));
                    phones.forEach(phone => {
                        if (!toPhones.includes(phone)) {
                            toPhones.push(phone);
                        }
                    });
                }
                
                const message = document.getElementById('send-sms-message').value.trim();
                const messageType = document.getElementById('send-sms-type').value || 'sms';
                
                // Validation
                if (!from) {
                    showError('Please fill in the From field');
                    return;
                }
                
                if (toPhones.length === 0) {
                    showError('Please add at least one valid phone number in the To field');
                    return;
                }
                
                if (!message.trim()) {
                    showError('Please fill in the Message field');
                    return;
                }
                
                // Handle bulk SMS or single SMS
                if (window.bulkSMSMode && window.bulkSMSIds && window.bulkSMSIds.length > 0) {
                    // Bulk SMS mode
                    showSingleEmailLoading('Sending SMS...', 'Please wait while we send your SMS messages');
                    
                    try {
                        const consolidationRes = await fetch('/api/admin/consolidation');
                        const consolidationJson = await consolidationRes.json();
                        
                        if (!consolidationRes.ok || !consolidationJson.success) {
                            throw new Error('Failed to load consolidation data');
                        }
                        
                        let successCount = 0;
                        let errorCount = 0;
                        
                        for (const id of window.bulkSMSIds) {
                            try {
                                const consolidation = consolidationJson.data.find(c => c.id === parseInt(id));
                                if (!consolidation || !consolidation.phone) {
                                    errorCount++;
                                    continue;
                                }
                                
                                // Replace variables
                                const replacedMessage = replaceVariables(message, consolidation);
                                const phoneTo = consolidation.phone;
                                
                                const res = await fetch('/api/admin/send-sms', {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify({
                                        from,
                                        to: phoneTo,
                                        message: replacedMessage,
                                        message_type: messageType,
                                        consolidation_id: id
                                    })
                                });
                                
                                const json = await res.json();
                                if (res.ok && json.success) {
                                    successCount++;
                                } else {
                                    errorCount++;
                                }
                                
                                // Small delay to avoid rate limiting
                                await new Promise(resolve => setTimeout(resolve, 200));
                            } catch (e) {
                                console.error(`Error sending SMS to ${id}:`, e);
                                errorCount++;
                            }
                        }
                        
                        hideSingleEmailLoading();
                        showSuccess(`Bulk SMS sent: ${successCount} successful, ${errorCount} failed`);
                        closeSendSMSPopup();
                        window.bulkSMSMode = false;
                        window.bulkSMSIds = null;
                        
                        // Refresh SMS logs if on SMS logs tab
                        if (currentSMSLogTab) {
                            await loadSMSLogs(currentSMSLogTab);
                        }
                    } catch (e) {
                        hideSingleEmailLoading();
                        throw e;
                    }
                } else {
                    // Single SMS mode
                    showSingleEmailLoading('Sending SMS...', 'Please wait while we send your SMS');
                    
                    try {
                        // Get consolidation data for variable replacement
                        let consolidationData = null;
                        if (currentSMSConsolidationId) {
                            try {
                                const consolidationRes = await fetch('/api/admin/consolidation');
                                const consolidationJson = await consolidationRes.json();
                                if (consolidationRes.ok && consolidationJson.success) {
                                    consolidationData = consolidationJson.data.find(c => c.id === currentSMSConsolidationId);
                                }
                            } catch (e) {
                                console.warn('Could not load consolidation data for variable replacement:', e);
                            }
                        }
                        
                        // Replace variables
                        const replacedMessage = consolidationData ? replaceVariables(message, consolidationData) : message;
                        
                        const smsPayload = {
                            from,
                            to: toPhones.join(', '),
                            message: replacedMessage,
                            message_type: messageType,
                            consolidation_id: currentSMSConsolidationId || undefined
                        };
                        
                        // If sending from a draft, include draft_id to update it
                        if (currentSMSDraftId) {
                            smsPayload.draft_id = currentSMSDraftId;
                        }
                        
                        const res = await fetch('/api/admin/send-sms', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(smsPayload)
                        });
                        
                        const json = await res.json();
                        
                        if (res.ok && json.success) {
                            showSuccess(`${messageType.toUpperCase()} sent successfully`);
                            closeSendSMSPopup();
                            
                            // Refresh SMS logs if on SMS logs tab
                            if (currentSMSLogTab) {
                                await loadSMSLogs(currentSMSLogTab);
                            }
                        } else {
                            throw new Error(json.error || 'Failed to send SMS');
                        }
                    } finally {
                        hideSingleEmailLoading();
                    }
                }
            } catch (e) {
                console.error('Error sending SMS:', e);
                showError(e.message || 'Failed to send SMS');
            }
        });
        
        // Add character counter for SMS message
        document.getElementById('send-sms-message')?.addEventListener('input', updateSMSCharCount);
        
        // Close overlays on outside click handlers
        setTimeout(() => {
            document.getElementById('send-mail-overlay')?.addEventListener('click', function(e) {
                if (e.target === this) closeSendMailPopup();
            });
            document.getElementById('send-sms-overlay')?.addEventListener('click', function(e) {
                if (e.target === this) closeSendSMSPopup();
            });
            document.getElementById('reference-fields-overlay')?.addEventListener('click', function(e) {
                if (e.target === this) closeReferenceFields();
            });
        }, 100);
        
        // Bulk email functions
        let selectedConsolidationIds = new Set();
        
        function toggleConsolidationSelectAll(checked) {
            const checkboxes = document.querySelectorAll('.consolidation-checkbox');
            checkboxes.forEach(cb => {
                cb.checked = checked;
                if (checked) {
                    selectedConsolidationIds.add(cb.value);
                } else {
                    selectedConsolidationIds.delete(cb.value);
                }
            });
            updateBulkEmailButton();
        }
        
        function updateBulkEmailButton() {
            const checkboxes = document.querySelectorAll('.consolidation-checkbox:checked');
            const count = checkboxes.length;
            const btn = document.getElementById('bulk-email-btn');
            const countSpan = document.getElementById('bulk-email-count');
            
            selectedConsolidationIds.clear();
            checkboxes.forEach(cb => selectedConsolidationIds.add(cb.value));
            
            if (count > 0) {
                btn.style.display = 'inline-flex';
                countSpan.textContent = count;
            } else {
                btn.style.display = 'none';
            }
            
            // Update select all checkbox
            const selectAll = document.getElementById('consolidation-select-all');
            if (selectAll) {
                const totalCheckboxes = document.querySelectorAll('.consolidation-checkbox').length;
                selectAll.checked = count > 0 && count === totalCheckboxes;
                selectAll.indeterminate = count > 0 && count < totalCheckboxes;
            }
        }
        
        async function openBulkEmailPopup() {
            if (selectedConsolidationIds.size === 0) {
                showError('Please select at least one record');
                return;
            }
            
            showCommTypeModal(null, Array.from(selectedConsolidationIds));
        }
        
        async function openBulkEmailPopupDirect(bulkEmailIds) {
            if (!bulkEmailIds || bulkEmailIds.length === 0) {
                showError('No records selected');
                return;
            }
            
            // Store bulk mode
            window.bulkEmailMode = true;
            window.bulkEmailIds = bulkEmailIds;
            
            try {
                // Get consolidation data for all selected records
                const res = await fetch('/api/admin/consolidation');
                const json = await res.json();
                if (!res.ok || !json.success) throw new Error('Failed to load consolidation data');
                
                // Get all selected consolidation records
                const selectedRecords = json.data.filter(c => window.bulkEmailIds.includes(String(c.id)));
                
                if (selectedRecords.length === 0) {
                    showError('No valid records found');
                    return;
                }
                
                // Validate that all selected records have email addresses
                const recordsWithoutEmail = selectedRecords.filter(record => 
                    !record.student_email || !isValidEmail(record.student_email)
                );
                
                if (recordsWithoutEmail.length > 0) {
                    showError('Some applicants don\'t have an email ID. Please select only those applicants who have a valid email ID.');
                    return;
                }
                
                // Get session creator email from first record
                let senderEmail = '';
                try {
                    if (selectedRecords[0].session_id) {
                        const sessionRes = await fetch(`/api/admin/sessions/${selectedRecords[0].session_id}`);
                        const sessionJson = await sessionRes.json();
                        if (sessionJson.success && sessionJson.data && sessionJson.data.created_by_email) {
                            senderEmail = sessionJson.data.created_by_email;
                        }
                    }
                } catch (e) {
                    console.warn('Could not fetch session creator email:', e);
                }
                
                // Prefill form - check if elements exist
                const fromEl = document.getElementById('send-mail-from');
                const overlayEl = document.getElementById('send-mail-overlay');
                
                if (!fromEl || !overlayEl) {
                    throw new Error('Send mail form elements not found. Please refresh the page.');
                }
                
                fromEl.value = 'admissions@zohoschools.in';
                
                // Clear and populate email tags with ALL selected emails
                clearEmailTags('to');
                clearEmailTags('cc');
                clearEmailTags('bcc');
                
                // Add all student emails to To field
                selectedRecords.forEach(record => {
                    if (record.student_email && isValidEmail(record.student_email)) {
                        addEmailTag('to', record.student_email);
                    }
                });
                
                // Show popup
                overlayEl.style.display = 'block';
                
                // Load email templates
                await loadEmailTemplatesForSend();
                
                // Initialize Quill editor if not already initialized
                setTimeout(() => {
                    const editorContainer = document.getElementById('send-mail-message-editor');
                    if (editorContainer && !sendMailQuill) {
                        try {
                            if (typeof Quill !== 'undefined') {
                                sendMailQuill = new Quill('#send-mail-message-editor', {
                                    theme: 'snow',
                                    modules: {
                                        toolbar: [
                                            [{ 'header': [1, 2, 3, false] }],
                                            ['bold', 'italic', 'underline', 'strike'],
                                            [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                                            [{ 'align': [] }],
                                            ['link', 'image'],
                                            [{ 'color': [] }, { 'background': [] }],
                                            ['clean']
                                        ]
                                    }
                                });
                                
                                // Configure link handler to ensure proper URL format
                                const linkHandler = sendMailQuill.getModule('toolbar').handlers.link;
                                sendMailQuill.getModule('toolbar').handlers.link = function(value) {
                                    if (value) {
                                        // Ensure URL has protocol
                                        if (!/^https?:\/\//i.test(value)) {
                                            value = 'https://' + value;
                                        }
                                    }
                                    linkHandler.call(this, value);
                                };
                                
                                // Intercept link clicks to open in new tab with correct URL
                                sendMailQuill.root.addEventListener('click', function(e) {
                                    const link = e.target.closest('a');
                                    if (link && link.href) {
                                        e.preventDefault();
                                        e.stopPropagation();
                                        let url = link.getAttribute('href');
                                        // Ensure URL has protocol
                                        if (url && !/^https?:\/\//i.test(url)) {
                                            url = 'https://' + url;
                                        }
                                        window.open(url, '_blank', 'noopener,noreferrer');
                                    }
                                });
                            } else {
                                console.warn('Quill.js not loaded, using fallback textarea');
                                editorContainer.innerHTML = '<textarea id="send-mail-message-fallback" style="width:100%;min-height:300px;padding:8px;border:1px solid #d1d5db;border-radius:4px;font-size:14px;font-family:inherit" placeholder="Compose your message..."></textarea>';
                            }
                        } catch (quillError) {
                            console.error('Error initializing Quill editor:', quillError);
                            if (editorContainer && !sendMailQuill) {
                                editorContainer.innerHTML = '<textarea id="send-mail-message-fallback" style="width:100%;min-height:300px;padding:8px;border:1px solid #d1d5db;border-radius:4px;font-size:14px;font-family:inherit" placeholder="Compose your message..."></textarea>';
                            }
                        }
                    } else if (sendMailQuill) {
                        // Clear editor content
                        sendMailQuill.setContents([]);
                    }
                }, 100);
            } catch (e) {
                console.error('Error opening bulk email popup:', e);
                showError('Failed to open send mail popup: ' + (e.message || e.toString()));
                window.bulkEmailMode = false;
                window.bulkEmailIds = [];
            }
        }
        
        // Reference fields functions
        const referenceFields = [
            { code: '${student_name}', label: 'Student Name', description: 'Full name of the student' },
            { code: '${student_email}', label: 'Student Email', description: 'Email address of the student' },
            { code: '${zeta_id}', label: 'Zeta ID', description: 'Unique Zeta ID of the student' },
            { code: '${session_name}', label: 'Session Name', description: 'Name of the interview session' },
            { code: '${status}', label: 'Status', description: 'Current status (selected/rejected/waitlisted)' },
            { code: '${last_interview_at}', label: 'Last Interview Date', description: 'Date of the last interview' }
        ];
        
        function showReferenceFields() {
            const overlay = document.getElementById('reference-fields-overlay');
            const list = document.getElementById('reference-fields-list');
            
            // Determine which insert function to use based on context
            const context = window.currentReferenceFieldContext || 'send-mail';
            let insertFunction = 'insertReferenceField';
            if (context === 'email-template') {
                insertFunction = 'insertReferenceFieldIntoEmailTemplate';
            } else if (context === 'sms-template') {
                insertFunction = 'insertReferenceFieldIntoSMSTemplate';
            } else if (context === 'send-sms') {
                insertFunction = 'insertReferenceFieldIntoSMSMessage';
            }
            
            list.innerHTML = referenceFields.map(field => `
                <div onclick="${insertFunction}('${field.code}')" style="border:1px solid #e5e7eb;border-radius:6px;padding:12px;cursor:pointer;transition:all 0.2s;background:#fff" onmouseover="this.style.borderColor='#3b82f6';this.style.background='#f0f9ff'" onmouseout="this.style.borderColor='#e5e7eb';this.style.background='#fff'">
                    <div style="font-weight:600;color:#111827;margin-bottom:4px;font-size:14px">${field.label}</div>
                    <div style="font-family:monospace;color:#3b82f6;font-size:13px;margin-bottom:4px;background:#f0f9ff;padding:4px 8px;border-radius:4px;display:inline-block">${field.code}</div>
                    <div style="color:#6b7280;font-size:12px">${field.description}</div>
                </div>
            `).join('');
            
            overlay.style.display = 'flex';
        }
        
        function closeReferenceFields() {
            document.getElementById('reference-fields-overlay').style.display = 'none';
            window.currentReferenceFieldContext = null;
        }
        
        function insertReferenceField(code) {
            if (sendMailQuill) {
                const range = sendMailQuill.getSelection(true);
                sendMailQuill.insertText(range.index, code, 'user');
                sendMailQuill.setSelection(range.index + code.length, 'user');
            } else {
                // Fallback for textarea
                const fallback = document.getElementById('send-mail-message-fallback');
                if (fallback) {
                    const start = fallback.selectionStart;
                    const end = fallback.selectionEnd;
                    const text = fallback.value;
                    fallback.value = text.substring(0, start) + code + text.substring(end);
                    fallback.selectionStart = fallback.selectionEnd = start + code.length;
                    fallback.focus();
                }
            }
            closeReferenceFields();
        }
        
        // Show reference fields for email template
        function showReferenceFieldsForEmailTemplate() {
            window.currentReferenceFieldContext = 'email-template';
            showReferenceFields();
        }
        
        // Show reference fields for SMS template
        function showReferenceFieldsForSMSTemplate() {
            window.currentReferenceFieldContext = 'sms-template';
            showReferenceFields();
        }
        
        // Show reference fields for SMS message
        function showReferenceFieldsForSMS() {
            window.currentReferenceFieldContext = 'send-sms';
            showReferenceFields();
        }
        
        // Insert reference field into email template editor
        function insertReferenceFieldIntoEmailTemplate(code) {
            if (emailTemplateQuill) {
                const range = emailTemplateQuill.getSelection(true);
                emailTemplateQuill.insertText(range.index, code, 'user');
                emailTemplateQuill.setSelection(range.index + code.length, 'user');
            } else {
                const fallback = document.getElementById('email-template-body-fallback');
                if (fallback) {
                    const start = fallback.selectionStart;
                    const end = fallback.selectionEnd;
                    const text = fallback.value;
                    fallback.value = text.substring(0, start) + code + text.substring(end);
                    fallback.selectionStart = fallback.selectionEnd = start + code.length;
                    fallback.focus();
                }
            }
            closeReferenceFields();
        }
        
        // Insert reference field into SMS template textarea
        function insertReferenceFieldIntoSMSTemplate(code) {
            const textarea = document.getElementById('sms-template-message');
            if (textarea) {
                const start = textarea.selectionStart;
                const end = textarea.selectionEnd;
                const text = textarea.value;
                textarea.value = text.substring(0, start) + code + text.substring(end);
                textarea.selectionStart = textarea.selectionEnd = start + code.length;
                textarea.focus();
            }
            closeReferenceFields();
        }
        
        // Insert reference field into SMS message textarea
        function insertReferenceFieldIntoSMSMessage(code) {
            const textarea = document.getElementById('send-sms-message');
            if (textarea) {
                const start = textarea.selectionStart;
                const end = textarea.selectionEnd;
                const text = textarea.value;
                textarea.value = text.substring(0, start) + code + text.substring(end);
                textarea.selectionStart = textarea.selectionEnd = start + code.length;
                textarea.focus();
                updateSMSCharCount();
            }
            closeReferenceFields();
        }
        
        // Variable replacement function
        function replaceVariables(message, consolidationData) {
            if (!consolidationData) return message;
            
            let replaced = message;
            
            // Replace fields
            replaced = replaced.replace(/\$\{student_name\}/g, consolidationData.student_name || '');
            replaced = replaced.replace(/\$\{student_email\}/g, consolidationData.student_email || '');
            replaced = replaced.replace(/\$\{zeta_id\}/g, consolidationData.zeta_id || '');
            replaced = replaced.replace(/\$\{session_name\}/g, consolidationData.session_name || '');
            replaced = replaced.replace(/\$\{status\}/g, consolidationData.status || '');
            replaced = replaced.replace(/\$\{last_interview_at\}/g, consolidationData.last_interview_at ? formatDate(consolidationData.last_interview_at) : '');
            
            return replaced;
        }
        
        // Email tag management functions
        function handleEmailInput(event, field) {
            if (event.key === 'Enter' || event.key === ',') {
                event.preventDefault();
                addEmailFromInput(field);
            } else if (event.key === 'Backspace' && event.target.value === '') {
                // Remove last tag if input is empty and backspace is pressed
                const tagsContainer = document.getElementById(`send-mail-${field}-tags`);
                if (tagsContainer) {
                    const tags = tagsContainer.querySelectorAll('.email-tag');
                    if (tags.length > 0) {
                        removeEmailTag(field, tags[tags.length - 1].dataset.email);
                    }
                }
            }
        }
        
        function addEmailFromInput(field) {
            const input = document.getElementById(`send-mail-${field}`);
            if (!input) return;
            
            const value = input.value.trim();
            
            if (value) {
                // Split by comma and add each email
                const emails = value.split(',').map(e => e.trim()).filter(e => e);
                emails.forEach(email => {
                    if (isValidEmail(email)) {
                        addEmailTag(field, email);
                    }
                });
                input.value = '';
            }
            updateEmailFieldPlaceholder(field);
        }
        
        function isValidEmail(email) {
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return emailRegex.test(email);
        }
        
        function addEmailTag(field, email) {
            const tagsContainer = document.getElementById(`send-mail-${field}-tags`);
            if (!tagsContainer) return;
            
            // Check if email already exists
            const existingTags = tagsContainer.querySelectorAll('.email-tag');
            for (let tag of existingTags) {
                if (tag.dataset.email === email) {
                    return; // Already exists
                }
            }
            
            const tag = document.createElement('div');
            tag.className = 'email-tag';
            tag.dataset.email = email;
            tag.style.cssText = 'display:inline-flex;align-items:center;gap:4px;background:#e0e7ff;color:#3730a3;padding:4px 8px;border-radius:12px;font-size:12px;font-weight:500';
            tag.innerHTML = `
                <span>${email}</span>
                <button type="button" onclick="removeEmailTag('${field}', '${email}')" style="background:transparent;border:none;color:#3730a3;cursor:pointer;padding:0;margin-left:4px;font-size:16px;line-height:1;font-weight:bold;width:16px;height:16px;display:flex;align-items:center;justify-content:center" title="Remove"></button>
            `;
            tagsContainer.appendChild(tag);
            updateEmailFieldPlaceholder(field);
        }
        
        function removeEmailTag(field, email) {
            const tagsContainer = document.getElementById(`send-mail-${field}-tags`);
            if (!tagsContainer) return;
            
            const tag = tagsContainer.querySelector(`.email-tag[data-email="${email}"]`);
            if (tag) {
                tag.remove();
            }
            updateEmailFieldPlaceholder(field);
        }
        
        function clearEmailTags(field) {
            const tagsContainer = document.getElementById(`send-mail-${field}-tags`);
            if (tagsContainer) {
                tagsContainer.innerHTML = '';
            }
            const input = document.getElementById(`send-mail-${field}`);
            if (input) {
                input.value = '';
                updateEmailFieldPlaceholder(field);
            }
        }
        
        // Update placeholder based on field content
        function updateEmailFieldPlaceholder(field) {
            const input = document.getElementById(`send-mail-${field}`);
            const tagsContainer = document.getElementById(`send-mail-${field}-tags`);
            if (!input) return;
            
            const hasTags = tagsContainer && tagsContainer.querySelectorAll('.email-tag').length > 0;
            const hasInputValue = input.value.trim().length > 0;
            
            if (hasTags || hasInputValue) {
                input.placeholder = '';
            } else {
                // Restore original placeholder
                if (field === 'to') {
                    input.placeholder = 'Enter email addresses (comma-separated or press Enter)';
                } else {
                    input.placeholder = 'Enter email addresses';
                }
            }
        }
        
        function getEmailsFromTags(field) {
            const tagsContainer = document.getElementById(`send-mail-${field}-tags`);
            if (!tagsContainer) {
                console.warn(`Tags container not found for field: ${field}`);
                return [];
            }
            
            const tags = tagsContainer.querySelectorAll('.email-tag');
            const emails = Array.from(tags).map(tag => {
                const email = tag.dataset.email;
                if (!email) {
                    console.warn('Tag found but no data-email attribute:', tag);
                }
                return email;
            }).filter(email => email); // Filter out any undefined/null emails
            
            console.log(`getEmailsFromTags(${field}):`, { tagsCount: tags.length, emails });
            return emails;
        }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.js" onload="window.chartJsLoaded = true; console.log(' Chart.js loaded and ready'); window.dispatchEvent(new Event('chartJsReady'));"></script>
    <!-- SheetJS for Excel export - using jsdelivr CDN to comply with CSP -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js" onload="window.XLSXLoaded = true; console.log(' SheetJS (XLSX) loaded and ready'); if (typeof XLSX !== 'undefined') { console.log(' XLSX object available:', typeof XLSX); } else { console.error(' XLSX object not available after load'); }" onerror="console.error(' Failed to load SheetJS library from jsdelivr');"></script>
</body>
</html>